(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const n of r.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function e(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerpolicy&&(r.referrerPolicy=s.referrerpolicy),s.crossorigin==="use-credentials"?r.credentials="include":s.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(s){if(s.ep)return;s.ep=!0;const r=e(s);fetch(s.href,r)}})();class l{static DEG_TO_RAD_RATIO=Math.PI/180;static EPSILON=1e-7;static BIG_EPSILON=1e-4;static VEC2_SIZE=8;static VEC2_ZERO=[0,0];static VEC2_LEFT=[-1,0];static VEC2_RIGHT=[1,0];static VEC2_UP=[0,1];static VEC2_DOWN=[0,-1];static VEC3_SIZE=12;static VEC3_ZERO=[0,0,0];static VEC3_BACKWARD=[0,0,1];static VEC3_FORWARD=[0,0,-1];static VEC3_LEFT=[-1,0,0];static VEC3_RIGHT=[1,0,0];static VEC3_UP=[0,1,0];static VEC3_DOWN=[0,-1,0];static VEC4_SIZE=16;static VEC5_SIZE=20;static VEC6_SIZE=24;static MAT3_SIZE=36;static MAT4_SIZE=64;static F01_SIZE=4;static F02_SIZE=8;static F03_SIZE=12;static F04_SIZE=16;static F05_SIZE=20;static F06_SIZE=24;static F07_SIZE=28;static F08_SIZE=32;static F09_SIZE=36;static F10_SIZE=40;static F11_SIZE=44;static F12_SIZE=48;static F13_SIZE=52;static F14_SIZE=56;static F15_SIZE=60;static F16_SIZE=64;static FAIL(t){const e=document.querySelector("#APP_FAIL");e.classList.add("SHOW"),e.textContent=t}static WAIT(t){return new Promise(e=>{window.setTimeout(()=>e(),t)})}static SHUFFLE(t){const e=t.slice();let i,s,r=e.length;if(r)for(;--r;)s=Math.floor(Math.random()*(r+1)),i=e[s],e[s]=e[r],e[r]=i;return e}static RANGE_ARRAY(t,e,i=0){return Array.from({length:(e-t)/i+1},(s,r)=>t+r*i)}static RANDARRAY(t,e){const i=[];for(let s=t;s<=e;s++)i.push(s);return l.SHUFFLE(i)}static GET_RANDOM_INT(t,e){return t=Math.ceil(t),e=Math.floor(e),Math.floor(Math.random()*(e-t))+t}static GET_RANDOM_FLOAT(t,e){return Math.random()*(e-t)+t}static CLAMP(t,e,i){return Math.max(e,Math.min(i,t))}static DEG_TO_RAD(t){return t*(Math.PI/180)}static LERP(t,e,i){return t+(e-t)*i}static TO_FIXED_NUMBER(t,e,i=10){const s=Math.pow(i,e);return Math.round(t*s)/s}static VEC2_CREATE(t=0,e=0){const i=new Float32Array(2);return i[0]=t,i[1]=e,i}static VEC2_PARSE(t,e=" ",i=[0,0]){const s=t.split(e);return i[0]=parseFloat(s[0]),i[1]=parseFloat(s[1]),i}static VEC2_SET(t,e,i){t[0]=e,t[1]=i}static VEC2_OPPOSITE(t,e=[0,0]){return e[0]=-t[0],e[1]=-t[1],e}static VEC2_DISTANCE(t,e){const i=e[0]-t[0],s=e[1]-t[1];return Math.sqrt(i*i+s*s)}static VEC2_LENGTH(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1])}static VEC2_NORMALIZE(t,e=[0,0]){const i=l.VEC2_LENGTH(t);return i>0&&(e[0]=t[0]/i,e[1]=t[1]/i),e}static VEC2_DOT(t,e){return t[0]*e[0]+t[1]*e[1]}static VEC2_CROSS(t,e){return t[0]*e[1]-t[1]*e[0]}static VEC2_ADD(t,e,i=[0,0]){return i[0]=t[0]+e[0],i[1]=t[1]+e[1],i}static VEC2_SUBSTRACT(t,e,i=[0,0]){return i[0]=t[0]-e[0],i[1]=t[1]-e[1],i}static VEC2_MULTIPLY(t,e,i=[0,0]){return i[0]=t[0]*e[0],i[1]=t[1]*e[1],i}static VEC2_SCALE(t,e,i=[0,0]){return i[0]=t[0]*e,i[1]=t[1]*e,i}static VEC2_ANGLE_BETWEEN(t,e){return Math.acos(l.VEC2_DOT(t,e)/(l.VEC2_LENGTH(t)*l.VEC2_LENGTH(e)))}static VEC2_ANGLE(t){const e=Math.atan2(t[1],t[0]);return e>0?e:e+Math.PI*2}static VEC2_ISEQUAL(t,e){return t[0]==e[0]&&t[1]==e[1]}static VEC2_PROJECTION_COS(t,e,i=[0,0]){const s=Math.sqrt(e[0]*e[0]+e[1]*e[1]),r=(t[0]*e[0]+t[1]*e[1])/(s*s);return i[0]=e[0]*r,i[1]=e[1]*r,i}static VEC2_QUADRATIC_BEZIER(t,e,i,s,r=[0,0]){const n=t[0]+(e[0]-t[0])*s,o=t[1]+(e[1]-t[1])*s,h=e[0]+(i[0]-e[0])*s,c=e[1]+(i[1]-e[1])*s;return r[0]=n+(h-n)*s,r[1]=o+(c-o)*s,r}static VEC3_CREATE(t=0,e=0,i=0){const s=new Float32Array(3);return s[0]=t,s[1]=e,s[2]=i,s}static VEC3_PARSE(t,e=" ",i=[0,0,0]){const s=t.split(e);return i[0]=parseFloat(s[0]),i[1]=parseFloat(s[1]),i[2]=parseFloat(s[2]),i}static VEC3_SET(t,e,i,s){t[0]=e,t[1]=i,t[2]=s}static VEC3_OPPOSITE(t,e=[0,0,0]){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e}static VEC3_DISTANCE(t,e){const i=e[0]-t[0],s=e[1]-t[1],r=e[2]-t[2];return Math.sqrt(i*i+s*s+r*r)}static VEC3_LENGTH(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2])}static VEC3_NORMALIZE(t,e=[0,0,0]){const i=l.VEC3_LENGTH(t);return i>0&&(e[0]=t[0]/i,e[1]=t[1]/i,e[2]=t[2]/i),e}static VEC3_DOT(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}static VEC3_CROSS(t,e,i=[0,0,0]){return i[0]=t[1]*e[2]-t[2]*e[1],i[1]=t[2]*e[0]-t[0]*e[2],i[2]=t[0]*e[1]-t[1]*e[0],i}static VEC3_ADD(t,e,i=[0,0,0]){return i[0]=t[0]+e[0],i[1]=t[1]+e[1],i[2]=t[2]+e[2],i}static VEC3_SUBSTRACT(t,e,i=[0,0,0]){return i[0]=t[0]-e[0],i[1]=t[1]-e[1],i[2]=t[2]-e[2],i}static VEC3_MULTIPLY(t,e,i=[0,0,0]){return i[0]=t[0]*e[0],i[1]=t[1]*e[1],i[2]=t[2]*e[2],i}static VEC3_SCALE(t,e,i=[0,0,0]){return i[0]=t[0]*e,i[1]=t[1]*e,i[2]=t[2]*e,i}static VEC3_ISEQUAL(t,e){return t[0]==e[0]&&t[1]==e[1]&&t[2]==e[2]}static VEC3_QUADRATIC_BEZIER(t,e,i,s,r=[0,0,0]){const n=t[0]+(e[0]-t[0])*s,o=t[1]+(e[1]-t[1])*s,h=t[2]+(e[2]-t[2])*s,c=e[0]+(i[0]-e[0])*s,d=e[1]+(i[1]-e[1])*s,f=e[2]+(i[2]-e[2])*s;return r[0]=n+(c-n)*s,r[1]=o+(d-o)*s,r[2]=h+(f-h)*s,r}static VEC4_CREATE(t=0,e=0,i=0,s=0){const r=new Float32Array(4);return r[0]=t,r[1]=e,r[2]=i,r[3]=s,r}static VEC4_PARSE(t,e=" ",i=[0,0,0,0]){const s=t.split(e);return i[0]=parseFloat(s[0]),i[1]=parseFloat(s[1]),i[2]=parseFloat(s[2]),i[3]=1,i}static VEC4_SET(t,e,i,s,r){t[0]=e,t[1]=i,t[2]=s,t[3]=r}static EULER_FROM_QUATERNION(t,e=[0,0,0]){const i=t[0],s=t[1],r=t[2],n=t[3],o=i+i,h=s+s,c=r+r,d=i*o,f=i*h,g=i*c,E=s*h,I=s*c,S=r*c,y=n*o,A=n*h,T=n*c;e[0]=(1-(E+S))*1,e[1]=(f+T)*1,e[2]=(g-A)*1,e[3]=(f-T)*1,e[4]=(1-(d+S))*1,e[5]=(I+y)*1,e[6]=(g+A)*1,e[7]=(I-y)*1,e[8]=(1-(d+E))*1;const w=(1-(E+S))*1,M=(g+A)*1,v=(f+T)*1,P=(1-(d+S))*1,L=(I-y)*1,B=(g-A)*1,q=(1-(d+E))*1;return e[0]=Math.asin(-l.CLAMP(L,-1,1)),Math.abs(L)<.9999999?(e[1]=Math.atan2(M,q),e[2]=Math.atan2(v,P)):(e[1]=Math.atan2(-B,w),e[2]=0),e}static EULER_FROM_MAT3(t,e=[0,0,0]){const i=t,s=i[0],r=i[6],n=i[1],o=i[4],h=i[7],c=i[2],d=i[8];return e[0]=Math.asin(-l.CLAMP(h,-1,1)),Math.abs(h)<.9999999?(e[1]=Math.atan2(r,d),e[2]=Math.atan2(n,o)):(e[1]=Math.atan2(-c,s),e[2]=0),e}static QUATERNION_CREATE(t=0,e=0,i=0,s=1){const r=new Float32Array(4);return r[0]=t,r[1]=e,r[2]=i,r[3]=s,r}static QUATERNION_FROM_EULER(t,e,i=[0,0,0,1]){const s=t[0],r=t[1],n=t[2],o=Math.cos(s/2),h=Math.cos(r/2),c=Math.cos(n/2),d=Math.sin(s/2),f=Math.sin(r/2),g=Math.sin(n/2);switch(e){case"XYZ":i[0]=d*h*c+o*f*g,i[1]=o*f*c-d*h*g,i[2]=o*h*g+d*f*c,i[3]=o*h*c-d*f*g;break;case"YXZ":i[0]=d*h*c+o*f*g,i[1]=o*f*c-d*h*g,i[2]=o*h*g-d*f*c,i[3]=o*h*c+d*f*g;break;case"ZXY":i[0]=d*h*c-o*f*g,i[1]=o*f*c+d*h*g,i[2]=o*h*g+d*f*c,i[3]=o*h*c-d*f*g;break;case"ZYX":i[0]=d*h*c-o*f*g,i[1]=o*f*c+d*h*g,i[2]=o*h*g-d*f*c,i[3]=o*h*c+d*f*g;break;case"YZX":i[0]=d*h*c+o*f*g,i[1]=o*f*c+d*h*g,i[2]=o*h*g-d*f*c,i[3]=o*h*c-d*f*g;break;case"XZY":i[0]=d*h*c-o*f*g,i[1]=o*f*c-d*h*g,i[2]=o*h*g+d*f*c,i[3]=o*h*c+d*f*g;break;default:throw new Error("UT.QUATERNION_FROM_EULER(): unknown euler order "+e)}return i}static MAT3_CREATE(){const t=new Float32Array(9);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t}static MAT3_FROM_ROTATION_QUATERNION(t,e=this.MAT3_CREATE()){const i=t[0],s=t[1],r=t[2],n=t[3],o=i+i,h=s+s,c=r+r,d=i*o,f=i*h,g=i*c,E=s*h,I=s*c,S=r*c,y=n*o,A=n*h,T=n*c;return e[0]=(1-(E+S))*1,e[1]=(f+T)*1,e[2]=(g-A)*1,e[3]=(f-T)*1,e[4]=(1-(d+S))*1,e[5]=(I+y)*1,e[6]=(g+A)*1,e[7]=(I-y)*1,e[8]=(1-(d+E))*1,this}static MAT3_MULTIPLY_BY_VEC3(t,e,i=[0,0,0]){const s=t[0],r=t[1],n=t[2],o=t[3],h=t[4],c=t[5],d=t[6],f=t[7],g=t[8],E=e[0],I=e[1],S=e[2];return i[0]=E*s+I*o+S*d,i[1]=E*r+I*h+S*f,i[2]=E*n+I*c+S*g,i}static MAT3_MULTIPLY(t,e,i=[0,0,0,0,0,0,0,0,0]){const s=t[0],r=t[1],n=t[2],o=t[3],h=t[4],c=t[5],d=t[6],f=t[7],g=t[8],E=e[0],I=e[1],S=e[2],y=e[3],A=e[4],T=e[5],w=e[6],M=e[7],v=e[8],P=E*s+I*o+S*d,L=E*r+I*h+S*f,B=E*n+I*c+S*g,q=y*s+A*o+T*d,Y=y*r+A*h+T*f,X=y*n+A*c+T*g,W=w*s+M*o+v*d,Z=w*r+M*h+v*f,N=w*n+M*c+v*g;return i[0]=P,i[1]=L,i[2]=B,i[3]=q,i[4]=Y,i[5]=X,i[6]=W,i[7]=Z,i[8]=N,i}static MAT3_INVERT(t,e=[0,0,0,0,0,0,0,0,0]){const i=t[0],s=t[1],r=t[2],n=t[3],o=t[4],h=t[5],c=t[6],d=t[7],f=t[8],g=f*o-h*d,E=-f*n+h*c,I=d*n-o*c;let S=i*g+s*E+r*I;if(!S)throw new Error("UT::MAT4_INVERT(): det is invalid !");S=1/S;const y=g*S,A=(-f*s+r*d)*S,T=(h*s-r*o)*S,w=E*S,M=(f*i-r*c)*S,v=(-h*i+r*n)*S,P=I*S,L=(-d*i+s*c)*S,B=(o*i-s*n)*S;return e[0]=y,e[1]=A,e[2]=T,e[3]=w,e[4]=M,e[5]=v,e[6]=P,e[7]=L,e[8]=B,e}static MAT3_IDENTITY(t=[0,0,0,0,0,0,0,0,0]){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t}static MAT3_SCALE(t,e,i=[0,0,0,0,0,0,0,0,0]){return i[0]=t,i[1]=0,i[2]=0,i[3]=0,i[4]=e,i[5]=0,i[6]=0,i[7]=0,i[8]=1,i}static MAT3_ROTATE(t,e=[0,0,0,0,0,0,0,0,0]){const i=Math.cos(t),s=Math.sin(t);return e[0]=i,e[1]=s,e[2]=0,e[3]=-s,e[4]=i,e[5]=1,e[6]=0,e[7]=0,e[8]=1,e}static MAT3_TRANSLATE(t,e,i=[0,0,0,0,0,0,0,0,0]){return i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=1,i[5]=0,i[6]=t,i[7]=e,i[8]=1,i}static MAT3_PROJECTION(t,e,i=[0,0,0,0,0,0,0,0,0]){return i[0]=2/t,i[1]=0,i[2]=0,i[3]=0,i[4]=2/e,i[5]=0,i[6]=-1,i[7]=-1,i[8]=1,i}static MAT4_CREATE(){const t=new Float32Array(16);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}static MAT4_MULTIPLY_BY_VEC4(t,e,i=[0,0,0,0]){const s=t[0],r=t[1],n=t[2],o=t[3],h=t[4],c=t[5],d=t[6],f=t[7],g=t[8],E=t[9],I=t[10],S=t[11],y=t[12],A=t[13],T=t[14],w=t[15],M=e[0],v=e[1],P=e[2],L=e[3];return i[0]=M*s+v*h+P*g+L*y,i[1]=M*r+v*c+P*E+L*A,i[2]=M*n+v*d+P*I+L*T,i[3]=M*o+v*f+P*S+L*w,i}static MAT4_MULTIPLY(t,e,i=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){const s=t[0],r=t[1],n=t[2],o=t[3],h=t[4],c=t[5],d=t[6],f=t[7],g=t[8],E=t[9],I=t[10],S=t[11],y=t[12],A=t[13],T=t[14],w=t[15],M=e[0],v=e[1],P=e[2],L=e[3],B=e[4],q=e[5],Y=e[6],X=e[7],W=e[8],Z=e[9],N=e[10],O=e[11],K=e[12],nt=e[13],tt=e[14],At=e[15];return i[0]=M*s+v*h+P*g+L*y,i[1]=M*r+v*c+P*E+L*A,i[2]=M*n+v*d+P*I+L*T,i[3]=M*o+v*f+P*S+L*w,i[4]=B*s+q*h+Y*g+X*y,i[5]=B*r+q*c+Y*E+X*A,i[6]=B*n+q*d+Y*I+X*T,i[7]=B*o+q*f+Y*S+X*w,i[8]=W*s+Z*h+N*g+O*y,i[9]=W*r+Z*c+N*E+O*A,i[10]=W*n+Z*d+N*I+O*T,i[11]=W*o+Z*f+N*S+O*w,i[12]=K*s+nt*h+tt*g+At*y,i[13]=K*r+nt*c+tt*E+At*A,i[14]=K*n+nt*d+tt*I+At*T,i[15]=K*o+nt*f+tt*S+At*w,i}static MAT4_COMPUTE(...t){for(let e=0;e<t.length-1;e++)t[e+1]=l.MAT4_MULTIPLY(t[e],t[e+1]);return t[t.length-1]}static MAT4_INVERT(t,e=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){const i=t[0],s=t[1],r=t[2],n=t[3],o=t[4],h=t[5],c=t[6],d=t[7],f=t[8],g=t[9],E=t[10],I=t[11],S=t[12],y=t[13],A=t[14],T=t[15],w=i*h-s*o,M=i*c-r*o,v=i*d-n*o,P=s*c-r*h,L=s*d-n*h,B=r*d-n*c,q=f*y-g*S,Y=f*A-E*S,X=f*T-I*S,W=g*A-E*y,Z=g*T-I*y,N=E*T-I*A;let O=w*N-M*Z+v*W+P*X-L*Y+B*q;if(!O)throw new Error("UT::MAT4_INVERT(): det is invalid !");O=1/O;const K=(h*N-c*Z+d*W)*O,nt=(r*Z-s*N-n*W)*O,tt=(y*B-A*L+T*P)*O,At=(E*L-g*B-I*P)*O,Ut=(c*X-o*N-d*Y)*O,re=(i*N-r*X+n*Y)*O,Ht=(A*v-S*B-T*M)*O,gt=(f*B-E*v+I*M)*O,jt=(o*Z-h*X+d*q)*O,Wt=(s*X-i*Z-n*q)*O,kt=(S*L-y*v+T*w)*O,Gt=(g*v-f*L-I*w)*O,qt=(h*Y-o*W-c*q)*O,ne=(i*W-s*Y+r*q)*O,ni=(y*M-S*P-A*w)*O,oe=(f*P-g*M+E*w)*O;return e[0]=K,e[1]=nt,e[2]=tt,e[3]=At,e[4]=Ut,e[5]=re,e[6]=Ht,e[7]=gt,e[8]=jt,e[9]=Wt,e[10]=kt,e[11]=Gt,e[12]=qt,e[13]=ne,e[14]=ni,e[15]=oe,e}static MAT4_IDENTITY(t=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}static MAT4_SCALE(t,e,i,s=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){return s[0]=t,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=e,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=i,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,s}static MAT4_ROTATE_X(t,e=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){const i=Math.cos(t),s=Math.sin(t);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=i,e[6]=-s,e[7]=0,e[8]=0,e[9]=s,e[10]=i,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}static MAT4_ROTATE_Y(t,e=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){const i=Math.cos(t),s=Math.sin(t);return e[0]=i,e[1]=0,e[2]=s,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=-s,e[9]=0,e[10]=i,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}static MAT4_ROTATE_Z(t,e=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){const i=Math.cos(t),s=Math.sin(t);return e[0]=i,e[1]=s,e[2]=0,e[3]=0,e[4]=-s,e[5]=i,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}static MAT4_TRANSLATE(t,e,i,s=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){return s[0]=1,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=1,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=t,s[13]=e,s[14]=i,s[15]=1,s}static MAT4_TRANSFORM(t,e,i,s=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){return l.MAT4_TRANSLATE(t[0],t[1],t[2],s),l.MAT4_MULTIPLY(s,l.MAT4_ROTATE_Y(e[1]),s),l.MAT4_MULTIPLY(s,l.MAT4_ROTATE_X(e[0]),s),l.MAT4_MULTIPLY(s,l.MAT4_ROTATE_Z(e[2]),s),l.MAT4_MULTIPLY(s,l.MAT4_SCALE(i[0],i[1],i[2]),s),s}static MAT4_ORTHOGRAPHIC(t,e,i=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){return i[0]=2/t,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=2/t,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=-2/e,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i}static MAT4_PERSPECTIVE(t,e,i,s,r=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){return r[0]=1/(Math.tan(t/2)*e),r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1/Math.tan(t/2),r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=(i+s)/(i-s),r[11]=-1,r[12]=0,r[13]=0,r[14]=2*s*i/(i-s),r[15]=0,r}static MAT4_LOOKAT(t,e,i=l.VEC3_UP,s=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){const r=l.VEC3_NORMALIZE(l.VEC3_SUBSTRACT(t,e)),n=l.VEC3_CROSS(i,r),o=l.VEC3_CROSS(r,n);return s[0]=n[0],s[1]=n[1],s[2]=n[2],s[3]=0,s[4]=o[0],s[5]=o[1],s[6]=o[2],s[7]=0,s[8]=r[0],s[9]=r[1],s[10]=r[2],s[11]=0,s[12]=t[0],s[13]=t[1],s[14]=t[2],s[15]=1,s}static MAT4_TRANSPOSE(t,e=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){const i=t[0],s=t[1],r=t[2],n=t[3],o=t[4],h=t[5],c=t[6],d=t[7],f=t[8],g=t[9],E=t[10],I=t[11],S=t[12],y=t[13],A=t[14],T=t[15];return e[0]=i,e[1]=o,e[2]=f,e[3]=S,e[4]=s,e[5]=h,e[6]=g,e[7]=y,e[8]=r,e[9]=c,e[10]=E,e[11]=A,e[12]=n,e[13]=d,e[14]=I,e[15]=T,e}static COLLIDE_CIRCLE(t,e,i,s,r=[0,0]){const n=l.VEC2_SUBSTRACT(t,i),o=l.VEC2_LENGTH(n),h=e+s;if(o>h)return!1;const c=Math.PI*2-(Math.PI*2-Math.atan2(n[1],n[0]));return r[0]=Math.cos(c)*(h-o),r[1]=Math.sin(c)*(h-o),!0}static COLLIDE_CYLINDER(t,e,i,s,r,n,o=[0,0]){if(!l.COLLIDE_CIRCLE([t[0],t[2]],e,[s[0],s[2]],r,o))return!1;let c=t[1],d=t[1]+i,f=s[1],g=s[1]+n;return c<=g&&d>=f}static COLLIDE_POINT_TO_RECT(t,e,i){return t[0]>=e[0]&&t[0]<=i[0]&&t[1]>=e[1]&&t[1]<=i[1]}static COLLIDE_RECT_TO_RECT(t,e,i,s){return t[0]<=s[0]&&e[0]>=i[0]&&t[1]<=s[1]&&e[1]>=i[1]}static COLLIDE_POINT_TO_BOX(t,e,i){return t[0]>=e[0]&&t[0]<=i[0]&&t[1]>=e[1]&&t[1]<=i[1]&&t[2]>=e[2]&&t[2]<=i[2]}static COLLIDE_BOX_TO_BOX(t,e,i,s){return t[0]<=s[0]&&e[0]>=i[0]&&t[1]<=s[1]&&e[1]>=i[1]&&t[2]<=s[2]&&e[2]>=i[2]}static TRI2_POINT_INSIDE(t,e,i,s){const r=l.VEC2_SUBSTRACT(i,e),n=l.VEC2_SUBSTRACT(s,i),o=l.VEC2_SUBSTRACT(e,s),h=l.VEC2_SUBSTRACT(t,e),c=l.VEC2_SUBSTRACT(t,i),d=l.VEC2_SUBSTRACT(t,s);return l.VEC2_CROSS(h,r)<l.EPSILON?-1:l.VEC2_CROSS(c,n)<l.EPSILON?-2:l.VEC2_CROSS(d,o)<l.EPSILON?-3:1}static TRI3_NORMAL(t,e,i,s=[0,0,0]){const r=l.VEC3_SUBSTRACT(e,t),n=l.VEC3_SUBSTRACT(i,t);return l.VEC3_CROSS(r,n,s)}static TRI3_POINT_INSIDE(t,e,i,s,r){r||(r=l.TRI3_NORMAL(e,i,s));const n=l.VEC3_SUBSTRACT(i,e),o=l.VEC3_SUBSTRACT(s,i),h=l.VEC3_SUBSTRACT(e,s),c=l.VEC3_SUBSTRACT(t,e),d=l.VEC3_SUBSTRACT(t,i),f=l.VEC3_SUBSTRACT(t,s),g=l.VEC3_CROSS(n,c);if(l.VEC3_DOT(g,r)<l.EPSILON)return!1;const E=l.VEC3_CROSS(o,d);if(l.VEC3_DOT(E,r)<l.EPSILON)return!1;const I=l.VEC3_CROSS(h,f);return!(l.VEC3_DOT(I,r)<l.EPSILON)}static TRI3_POINT_ELEVATION(t,e,i,s){const r=l.VEC3_CREATE(i[0]-e[0],0,i[2]-e[2]),n=l.VEC3_CREATE(e[0]-s[0],0,e[2]-s[2]),o=l.VEC3_CREATE(t[0]-e[0],0,t[1]-e[2]),h=l.VEC3_CREATE(t[0]-i[0],0,t[1]-i[2]),c=l.VEC3_CREATE(t[0]-s[0],0,t[1]-s[2]),d=l.VEC3_LENGTH(l.VEC3_CROSS(r,n)),f=l.VEC3_LENGTH(l.VEC3_CROSS(h,c))/d,g=l.VEC3_LENGTH(l.VEC3_CROSS(o,c))/d,E=l.VEC3_LENGTH(l.VEC3_CROSS(o,h))/d;if(f+g+E>1+l.BIG_EPSILON)return 1/0;const I=e[1]+(i[1]-e[1])*(g/(f+g));return I+(s[1]-I)*(E/(f+g+E))}static RAY_TRIANGLE(t,e,i,s,r,n=!1,o=[0,0,0]){const h=l.TRI3_NORMAL(i,s,r);return l.RAY_PLAN(t,e,i,h,n,o)?l.TRI3_POINT_INSIDE(o,i,s,r,h):!1}static RAY_PLAN(t,e,i,s,r,n=[0,0,0]){const o=l.VEC3_DOT(e,s);if(r&&o>=0||o>-l.EPSILON&&o<l.EPSILON)return!1;const h=l.VEC3_DOT(s,i)*-1,d=(l.VEC3_DOT(s,t)*-1-h)/o;return n[0]=t[0]+e[0]*d,n[1]=t[1]+e[1]*d,n[2]=t[2]+e[2]*d,!0}static RAY_BOX(t,e,i,s,r=[0,0,0]){for(let n=0;n<3;n++)if(t[n]<i[n]){const o=(i[n]-t[n])/e[n],h=t[0]+e[0]*o,c=t[1]+e[1]*o,d=t[2]+e[2]*o;if(h>=i[0]&&h<=s[0]&&c>=i[1]&&c<=s[1]&&d>=i[2]&&d<=s[2])return r[0]=h,r[1]=c,r[2]=d,!0}else if(t[n]>s[n]){const o=(s[n]-t[n])/e[n],h=t[0]+e[0]*o,c=t[1]+e[1]*o,d=t[2]+e[2]*o;if(h>=i[0]&&h<=s[0]&&c>=i[1]&&c<=s[1]&&d>=i[2]&&d<=s[2])return r[0]=h,r[1]=c,r[2]=d,!0}return!1}static LINEAR(t,e,i,s){return e+(i-e)*t/s}static EASE_IN_QUAD(t,e,i,s){return(i-e)*(t/=s)*t+e}static EASE_OUT_QUAD(t,e,i,s){return-(i-e)*(t/=s)*(t-2)+e}static EASE_IN_OUT_QUAD(t,e,i,s){const r=i-e;return(t/=s/2)<1?r/2*t*t+e:-r/2*(--t*(t-2)-1)+e}static LINEAR_VEC2(t,e,i,s){const r=l.VEC2_SUBSTRACT(i,e),n=t/s;return[e[0]+r[0]*n,e[1]+r[1]*n]}static LINEAR_VEC3(t,e,i,s){const r=l.VEC3_SUBSTRACT(i,e),n=t/s;return[e[0]+r[0]*n,e[1]+r[1]*n,e[2]+r[2]*n]}}var Ze=(a=>(a.PERSPECTIVE="PERSPECTIVE",a.ORTHOGRAPHIC="ORTHOGRAPHIC",a))(Ze||{});class ai{cacheProjectionMatrix;cacheProjectionMatrixChanged;cacheCameraViewMatrix;cacheCameraViewMatrixChanged;cacheClipMatrix;cacheClipMatrixChanged;cameraMatrix;clipOffset;viewport;projectionMode;perspectiveFovy;perspectiveNear;perspectiveFar;orthographicSize;orthographicDepth;bgColor;screenSize;constructor(){this.cacheProjectionMatrix=l.MAT4_CREATE(),this.cacheProjectionMatrixChanged=!0,this.cacheCameraViewMatrix=l.MAT4_CREATE(),this.cacheCameraViewMatrixChanged=!0,this.cacheClipMatrix=l.MAT4_CREATE(),this.cacheClipMatrixChanged=!0,this.cameraMatrix=l.MAT4_IDENTITY(),this.clipOffset=[0,0],this.viewport={xFactor:0,yFactor:0,widthFactor:1,heightFactor:1},this.projectionMode="PERSPECTIVE",this.perspectiveFovy=Math.PI/4,this.perspectiveNear=.1,this.perspectiveFar=2e3,this.orthographicSize=1,this.orthographicDepth=700,this.bgColor=[0,0,0,0],this.screenSize=[0,0]}getProjectionMatrix(){if(!this.cacheProjectionMatrixChanged)return this.cacheProjectionMatrix;if(this.projectionMode=="PERSPECTIVE"){const t=this.screenSize[0]*this.viewport.widthFactor,e=this.screenSize[1]*this.viewport.heightFactor;l.MAT4_PERSPECTIVE(this.perspectiveFovy,t/e,this.perspectiveNear,this.perspectiveFar,this.cacheProjectionMatrix)}else this.projectionMode=="ORTHOGRAPHIC"&&l.MAT4_ORTHOGRAPHIC(this.orthographicSize,this.orthographicDepth,this.cacheProjectionMatrix);return this.cacheProjectionMatrixChanged=!1,this.cacheProjectionMatrix}getClipMatrix(){return this.cacheClipMatrixChanged?(l.MAT4_INVERT(l.MAT4_TRANSLATE(this.clipOffset[0],this.clipOffset[1],0),this.cacheClipMatrix),this.cacheClipMatrixChanged=!1,this.cacheClipMatrix):this.cacheClipMatrix}getCameraViewMatrix(){return this.cacheCameraViewMatrixChanged?(l.MAT4_INVERT(this.cameraMatrix,this.cacheCameraViewMatrix),this.cacheCameraViewMatrixChanged=!1,this.cacheCameraViewMatrix):this.cacheCameraViewMatrix}getCameraPosition(){return[this.cameraMatrix[12],this.cameraMatrix[13],this.cameraMatrix[14]]}getClipOffset(){return this.clipOffset}getClipOffsetX(){return this.clipOffset[0]}getClipOffsetY(){return this.clipOffset[1]}setClipOffset(t,e){this.clipOffset[0]=t,this.clipOffset[1]=e,this.cacheClipMatrixChanged=!0}getCameraMatrix(){return this.cameraMatrix}setCameraMatrix(t){this.cameraMatrix=t,this.cacheCameraViewMatrixChanged=!0}getViewport(){return this.viewport}setViewport(t){this.viewport=t,this.cacheProjectionMatrixChanged=!0}getProjectionMode(){return this.projectionMode}setProjectionMode(t){this.projectionMode=t,this.cacheProjectionMatrixChanged=!0}getPerspectiveFovy(){return this.perspectiveFovy}setPerspectiveFovy(t){this.perspectiveFovy=t,this.cacheProjectionMatrixChanged=!0}getPerspectiveNear(){return this.perspectiveNear}setPerspectiveNear(t){this.perspectiveNear=t,this.cacheProjectionMatrixChanged=!0}getPerspectiveFar(){return this.perspectiveFar}setPerspectiveFar(t){this.perspectiveFar=t,this.cacheProjectionMatrixChanged=!0}getOrthographicSize(){return this.orthographicSize}setOrthographicSize(t){this.orthographicSize=t,this.cacheProjectionMatrixChanged=!0}getOrthographicDepth(){return this.orthographicDepth}setOrthographicDepth(t){this.orthographicDepth=t,this.cacheProjectionMatrixChanged=!0}getBgColor(){return this.bgColor}setBgColor(t,e,i,s){this.bgColor[0]=t,this.bgColor[1]=e,this.bgColor[2]=i,this.bgColor[3]=s}getScreenSize(){return this.screenSize}setScreenSize(t,e){this.screenSize[0]=t,this.screenSize[1]=e,this.cacheProjectionMatrixChanged=!0}getProjectionClipMatrix(){const t=l.MAT4_CREATE();return l.MAT4_MULTIPLY(t,this.getClipMatrix(),t),l.MAT4_MULTIPLY(t,this.getProjectionMatrix(),t),t}getViewProjectionClipMatrix(){const t=l.MAT4_CREATE();return l.MAT4_MULTIPLY(t,this.getClipMatrix(),t),l.MAT4_MULTIPLY(t,this.getProjectionMatrix(),t),l.MAT4_MULTIPLY(t,this.getCameraViewMatrix(),t),t}getScreenPosition(t,e,i){const s=l.MAT4_IDENTITY();l.MAT4_MULTIPLY(s,this.getClipMatrix(),s),l.MAT4_MULTIPLY(s,this.getProjectionMatrix(),s),l.MAT4_MULTIPLY(s,this.getCameraViewMatrix(),s);const r=l.MAT4_MULTIPLY_BY_VEC4(s,[t,e,i,1]),n=this.screenSize[0]*this.viewport.widthFactor/window.devicePixelRatio,o=this.screenSize[1]*this.viewport.heightFactor/window.devicePixelRatio;return r[0]=r[0]/r[3],r[1]=r[1]/r[3],r[0]=(r[0]+1)*n/2,r[1]=o-(r[1]+1)*o/2,[r[0],r[1]]}getScreenNormalizedPosition(t,e,i){const s=l.MAT4_IDENTITY();l.MAT4_MULTIPLY(s,this.getClipMatrix(),s),l.MAT4_MULTIPLY(s,this.getProjectionMatrix(),s),l.MAT4_MULTIPLY(s,this.getCameraViewMatrix(),s);const r=l.MAT4_MULTIPLY_BY_VEC4(s,[t,e,i,1]);return[r[0]/r[3],r[1]/r[3]]}}const Ne=256;class Bs{device;pipeline;groupIndex;inputs;bindGroup;constructor(t,e,i){this.device=t,this.pipeline=e,this.groupIndex=i,this.inputs=[],this.bindGroup=null}addSamplerInput(t,e){this.inputs[t]={binding:t,resource:e}}addTextureInput(t,e,i={}){this.inputs[t]={binding:t,resource:e.createView(i)}}setSamplerInput(t,e){this.inputs[t]={binding:t,resource:e}}setTextureInput(t,e,i={}){this.inputs[t]={binding:t,resource:e.createView(i)}}allocate(){this.bindGroup=this.device.createBindGroup({layout:this.pipeline.getBindGroupLayout(this.groupIndex),entries:this.inputs})}getBindGroup(){return this.bindGroup}}class Vs{device;pipeline;groupIndex;buffer;bufferWriteOffset;inputs;storeBindGroups;size;constructor(t,e,i){this.device=t,this.pipeline=e,this.groupIndex=i,this.buffer=t.createBuffer({size:16*4,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.bufferWriteOffset=0,this.inputs=[],this.storeBindGroups=[],this.size=0}destroy(){this.buffer.destroy(),this.storeBindGroups=[]}addInput(t,e,i){this.inputs[t]={index:t,size:e}}allocate(t=1){let e=0;this.storeBindGroups=[],this.buffer.destroy(),this.buffer=this.device.createBuffer({size:t*this.inputs.length*Ne,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});for(let i=0;i<t;i++){const s=[];for(const r of this.inputs)s[r.index]={binding:r.index,resource:{buffer:this.buffer,offset:e,size:r.size}},e+=Ne;this.storeBindGroups.push(this.device.createBindGroup({layout:this.pipeline.getBindGroupLayout(this.groupIndex),entries:s}))}this.size=t}beginWrite(){this.bufferWriteOffset=0}write(t,e){this.device.queue.writeBuffer(this.buffer,this.bufferWriteOffset,e),this.bufferWriteOffset+=Ne}endWrite(){this.bufferWriteOffset=0}getBindGroup(t=0){return this.storeBindGroups[t]}getSize(){return this.size}}class Us{adapter;device;canvas;ctx;depthTexture;depthView;commandEncoder;passEncoder;pipelines;vertexBuffer;vertexSubBuffers;vertexSubBuffersSize;views;currentView;lastRenderStart;lastRenderTime;constructor(){this.adapter={},this.device={},this.canvas={},this.ctx={},this.depthTexture={},this.depthView={},this.commandEncoder={},this.passEncoder={},this.pipelines=new Map,this.vertexBuffer={},this.vertexSubBuffers=[],this.vertexSubBuffersSize=0,this.views=[],this.currentView=new ai,this.lastRenderStart=0,this.lastRenderTime=0}async initialize(){if(!navigator.gpu)throw l.FAIL("This browser does not support webgpu"),new Error("Gfx3Manager::Gfx3Manager: WebGPU cannot be initialized - navigator.gpu not found");if(this.adapter=await navigator.gpu.requestAdapter(),!this.adapter)throw l.FAIL("This browser appears to support WebGPU but it's disabled"),new Error("Gfx3Manager::Gfx3Manager: WebGPU cannot be initialized - Adapter not found");if(this.device=await this.adapter.requestDevice(),this.device.lost.then(()=>{throw new Error("Gfx3Manager::Gfx3Manager: WebGPU cannot be initialized - Device has been lost")}),this.canvas=document.getElementById("CANVAS_3D"),!this.canvas)throw new Error("Gfx3Manager::Gfx3Manager: CANVAS_3D not found");if(this.ctx=this.canvas.getContext("webgpu"),!this.ctx)throw new Error("Gfx3Manager::Gfx3Manager: WebGPU cannot be initialized - Canvas does not support WebGPU");this.ctx.configure({device:this.device,format:navigator.gpu.getPreferredCanvasFormat(),alphaMode:"opaque"});const t=window.devicePixelRatio||1;this.canvas.width=this.canvas.clientWidth*t,this.canvas.height=this.canvas.clientHeight*t,this.currentView=this.createView(),this.depthTexture=this.device.createTexture({size:[this.canvas.width,this.canvas.height],format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT}),this.depthView=this.depthTexture.createView(),this.vertexBuffer=this.device.createBuffer({size:0,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),window.addEventListener("resize",this.handleWindowResize.bind(this))}beginDrawing(t){const e=this.views[t],i=e.getViewport(),s=this.canvas.width*i.xFactor,r=this.canvas.height*i.yFactor,n=this.canvas.width*i.widthFactor,o=this.canvas.height*i.heightFactor,h=e.getBgColor(),c=this.device.createCommandEncoder(),d=c.beginRenderPass({colorAttachments:[{view:this.ctx.getCurrentTexture().createView(),clearValue:{r:h[0],g:h[1],b:h[2],a:h[3]},loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{view:this.depthView,depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"}});d.setViewport(s,r,n,o,0,1),d.setScissorRect(s,r,n,o),this.currentView=e,this.commandEncoder=c,this.passEncoder=d}endDrawing(){if(this.vertexSubBuffersSize>0&&this.vertexSubBuffersSize!=this.vertexBuffer.size){this.vertexBuffer.destroy(),this.vertexBuffer=this.device.createBuffer({size:this.vertexSubBuffersSize,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST});for(const t of this.vertexSubBuffers)this.device.queue.writeBuffer(this.vertexBuffer,t.offset,t.vertices),t.changed=!1;return}for(const t of this.vertexSubBuffers)t.changed&&(this.device.queue.writeBuffer(this.vertexBuffer,t.offset,t.vertices),t.changed=!1)}beginRender(){this.lastRenderStart=Date.now()}endRender(){this.passEncoder.end(),this.device.queue.submit([this.commandEncoder.finish()]),this.lastRenderTime=Date.now()-this.lastRenderStart}loadPipeline(t,e,i,s){if(this.pipelines.has(t))return this.pipelines.get(t);s.vertex&&(s.vertex.module=this.device.createShaderModule({code:e})),s.fragment&&(s.fragment.module=this.device.createShaderModule({code:i}));const r=this.device.createRenderPipeline(s);return this.pipelines.set(t,r),r}getPipeline(t){if(!this.pipelines.has(t))throw new Error("Gfx3Manager::getPipeline(): pipeline not found !");return this.pipelines.get(t)}createVertexBuffer(t){const e={vertices:new Float32Array(t),offset:this.vertexSubBuffersSize,changed:!1};return this.vertexSubBuffers.push(e),this.vertexSubBuffersSize+=t,e}destroyVertexBuffer(t){const e=this.vertexSubBuffers.indexOf(t);this.vertexSubBuffers.splice(e,1);for(const i of this.vertexSubBuffers)i.offset>t.offset&&(i.offset-=t.vertices.byteLength);this.vertexSubBuffersSize-=t.vertices.byteLength}writeVertexBuffer(t,e){t.vertices=new Float32Array(e),t.changed=!0}createUniformGroupDataset(t,e){return new Vs(this.device,this.getPipeline(t),e)}createUniformGroupBitmaps(t,e){return new Bs(this.device,this.getPipeline(t),e)}createTextureFromBitmap(t,e=!1){if(!t){const r=document.createElement("canvas");r.getContext("2d"),r.width=1,r.height=1,t=r}const i=this.device.createTexture({size:[t.width,t.height],format:e?"r8unorm":"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT});this.device.queue.copyExternalImageToTexture({source:t},{texture:i},[t.width,t.height]);const s=this.device.createSampler({magFilter:"linear",minFilter:"linear",addressModeU:"repeat",addressModeV:"repeat"});return{gpuTexture:i,gpuSampler:s}}createCubeMapFromBitmap(t){if(!t||t.length==0){const s=document.createElement("canvas");s.getContext("2d"),s.width=1,s.height=1,t=[];for(let r=0;r<6;r++)t.push(s)}const e=this.device.createTexture({dimension:"2d",size:[t[0].width,t[0].height,6],format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT});for(let s=0;s<t.length;s++){const r=t[s];this.device.queue.copyExternalImageToTexture({source:r},{texture:e,origin:[0,0,s]},[r.width,r.height])}const i=this.device.createSampler({magFilter:"linear",minFilter:"linear"});return{gpuTexture:e,gpuSampler:i}}getWidth(){return this.canvas.width}getHeight(){return this.canvas.height}getContext(){return this.ctx}getDevice(){return this.device}getPassEncoder(){return this.passEncoder}getView(t){return this.views[t]}getNumViews(){return this.views.length}createView(){const t=new ai;return t.setScreenSize(this.canvas.width,this.canvas.height),this.views.push(t),t}changeView(t,e){this.views[t]=e}removeView(t){this.views.splice(this.views.indexOf(t),1)}releaseViews(){this.views=[]}getCurrentView(){return this.currentView}getVertexBuffer(){return this.vertexBuffer}getLastRenderTime(){return this.lastRenderTime}handleWindowResize(){const t=window.devicePixelRatio||1;this.canvas.width=this.canvas.clientWidth*t,this.canvas.height=this.canvas.clientHeight*t,this.depthTexture.destroy(),this.depthTexture=this.device.createTexture({size:[this.canvas.width,this.canvas.height],format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT}),this.depthView=this.depthTexture.createView();for(const e of this.views)e.setScreenSize(this.canvas.width,this.canvas.height)}}const x=new Us;await x.initialize();const zi=6,Hs={label:"Debug pipeline",layout:"auto",vertex:{entryPoint:"main",buffers:[{arrayStride:zi*4,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:3*4,format:"float32x3"}]}]},fragment:{entryPoint:"main",targets:[{format:navigator.gpu.getPreferredCanvasFormat()}]},primitive:{topology:"line-list",cullMode:"back",frontFace:"ccw"},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth24plus"}},js=`
@binding(0) @group(0) var<uniform> MVPC_MATRIX: mat4x4<f32>;

struct VertexOutput {
  @builtin(position) Position: vec4<f32>,
  @location(0) Color: vec3<f32>
};

@vertex
fn main(
  @location(0) Position: vec4<f32>,
  @location(1) Color: vec3<f32>
) -> VertexOutput {
  var output: VertexOutput;
  output.Position = MVPC_MATRIX * Position;
  output.Color = Color;
  return output;
}`,Ws=`
@fragment
fn main(
  @location(0) Color: vec3<f32>
) -> @location(0) vec4<f32> {
  return vec4(Color, 1);
}`;class ks{pipeline;device;vertexBuffer;vertexCount;commands;showDebug;cmdBuffer;constructor(){this.pipeline=x.loadPipeline("DEBUG_PIPELINE",js,Ws,Hs),this.device=x.getDevice(),this.vertexBuffer=this.device.createBuffer({size:0,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC}),this.vertexCount=0,this.commands=[],this.showDebug=!1,this.cmdBuffer=x.createUniformGroupDataset("DEBUG_PIPELINE",0),this.cmdBuffer.addInput(0,l.MAT4_SIZE,"MVPC_MATRIX"),this.cmdBuffer.allocate()}render(){if(!this.showDebug)return;const t=x.getCurrentView(),e=x.getPassEncoder();e.setPipeline(this.pipeline);let i=0;this.vertexBuffer.destroy(),this.vertexBuffer=this.device.createBuffer({size:this.vertexCount*zi*4,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC}),this.cmdBuffer.getSize()<this.commands.length&&this.cmdBuffer.allocate(this.commands.length);const s=t.getViewProjectionClipMatrix(),r=l.MAT4_CREATE();this.cmdBuffer.beginWrite();for(let n=0;n<this.commands.length;n++){const o=this.commands[n];l.MAT4_MULTIPLY(s,o.matrix,r),this.cmdBuffer.write(0,r),e.setBindGroup(0,this.cmdBuffer.getBindGroup(n)),this.device.queue.writeBuffer(this.vertexBuffer,i,o.vertices),e.setVertexBuffer(0,this.vertexBuffer,i,o.vertices.byteLength),e.draw(o.vertexCount),i+=o.vertices.byteLength}this.cmdBuffer.endWrite(),this.commands=[],this.vertexCount=0}drawVertices(t,e,i){this.commands.push({vertices:new Float32Array(t),vertexCount:e,matrix:i}),this.vertexCount+=e}drawGrid(t,e=3,i=1){let s=0;const r=[],n=e*2,o=n*i,h=-o*.5,c=-o*.5;for(let d=0;d<=n;d++){const f=h+d*i,g=c,E=0,I=h+d*i,S=c+o,y=0,A=h,T=c+d*i,w=0,M=h+o,v=c+d*i,P=0;r.push(f,g,E,1,1,1),r.push(I,S,y,1,1,1),r.push(A,T,w,1,1,1),r.push(M,v,P,1,1,1),s+=4}this.commands.push({vertices:new Float32Array(r),vertexCount:s,matrix:t}),this.vertexCount+=s}drawGizmo(t,e=1){let i=0;const s=[],r=[[1*e,0,0],[0,1*e,0],[0,0,1*e]],n=[[1,0,0],[0,1,0],[0,0,1]];for(let o=0;o<r.length;o++)s.push(0,0,0,n[o][0],n[o][1],n[o][2]),s.push(r[o][0],r[o][1],r[o][2],n[o][0],n[o][1],n[o][2]),i+=2;this.commands.push({vertices:new Float32Array(s),vertexCount:i,matrix:t}),this.vertexCount+=i}drawCircle(t,e=1,i=4){let s=0;const r=[],n=Math.PI*2/i;for(let o=0;o<i;o++){const h=Math.cos(o*n)*e,c=Math.sin(o*n)*e,d=0,f=Math.cos((o+1)*n)*e,g=Math.sin((o+1)*n)*e,E=0;r.push(h,c,d,1,1,1),r.push(f,g,E,1,1,1),s+=2}this.commands.push({vertices:new Float32Array(r),vertexCount:s,matrix:t}),this.vertexCount+=s}drawBoundingRect(t,e,i){let s=0;const r=[],n=[e[0],e[1],0],o=[e[0],i[1],0],h=[i[0],e[1],0],c=[i[0],i[1],0];r.push(n[0],n[1],n[2],1,1,1),r.push(o[0],o[1],o[2],1,1,1),s+=2,r.push(o[0],o[1],o[2],1,1,1),r.push(c[0],c[1],c[2],1,1,1),s+=2,r.push(c[0],c[1],c[2],1,1,1),r.push(h[0],h[1],h[2],1,1,1),s+=2,r.push(h[0],h[1],h[2],1,1,1),r.push(n[0],n[1],n[2],1,1,1),s+=2,this.commands.push({vertices:new Float32Array(r),vertexCount:s,matrix:t}),this.vertexCount+=s}drawSphere(t,e=1,i=4){let s=0;const r=[],n=[],o=Math.PI*.5/i;for(let h=-i;h<=i;h++){const c=Math.cos(h*o)*e,d=Math.sin(h*o)*e;for(let f=0;f<=i*4;f++){const g=Math.sin(f*o)*c,E=Math.cos(f*o)*Math.cos(h*o)*e;n.push([E,d,g])}}for(let h=-i;h<=i;h++)for(let c=0;c<=i*4;c++){const d=Math.cos(c*o)*e*Math.cos(h*o),f=Math.sin(c*o)*e,g=Math.cos(c*o)*e*Math.sin(h*o);n.push([d,f,g])}for(let h=0;h<n.length-1;h++)r.push(n[h][0],n[h][1],n[h][2],1,1,1),r.push(n[h+1][0],n[h+1][1],n[h+1][2],1,1,1),s+=2;this.commands.push({vertices:new Float32Array(r),vertexCount:s,matrix:t}),this.vertexCount+=s}drawBoundingBox(t,e,i){let s=0;const r=[],n=[e[0],e[1],e[2]],o=[i[0],e[1],e[2]],h=[i[0],i[1],e[2]],c=[e[0],i[1],e[2]],d=[e[0],i[1],i[2]],f=[i[0],i[1],i[2]],g=[i[0],e[1],i[2]],E=[e[0],e[1],i[2]];r.push(n[0],n[1],n[2],1,1,1),r.push(o[0],o[1],o[2],1,1,1),r.push(E[0],E[1],E[2],1,1,1),r.push(g[0],g[1],g[2],1,1,1),s+=4,r.push(c[0],c[1],c[2],1,1,1),r.push(h[0],h[1],h[2],1,1,1),r.push(d[0],d[1],d[2],1,1,1),r.push(f[0],f[1],f[2],1,1,1),s+=4,r.push(n[0],n[1],n[2],1,1,1),r.push(c[0],c[1],c[2],1,1,1),r.push(E[0],E[1],E[2],1,1,1),r.push(d[0],d[1],d[2],1,1,1),s+=4,r.push(o[0],o[1],o[2],1,1,1),r.push(h[0],h[1],h[2],1,1,1),r.push(g[0],g[1],g[2],1,1,1),r.push(f[0],f[1],f[2],1,1,1),s+=4,r.push(c[0],c[1],c[2],1,1,1),r.push(d[0],d[1],d[2],1,1,1),r.push(h[0],h[1],h[2],1,1,1),r.push(f[0],f[1],f[2],1,1,1),s+=4,r.push(n[0],n[1],n[2],1,1,1),r.push(E[0],E[1],E[2],1,1,1),r.push(o[0],o[1],o[2],1,1,1),r.push(g[0],g[1],g[2],1,1,1),s+=4,this.commands.push({vertices:new Float32Array(r),vertexCount:s,matrix:t}),this.vertexCount+=s}isShowDebug(){return this.showDebug}setShowDebug(t){this.showDebug=t}}const Mt=new ks;class Zi{pipeline;constructor(t,e,i,s){this.pipeline=x.loadPipeline(t,e,i,s)}}const st=14,Gs={label:"Mesh pipeline",layout:"auto",vertex:{entryPoint:"main",buffers:[{arrayStride:st*4,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:3*4,format:"float32x2"},{shaderLocation:2,offset:5*4,format:"float32x3"},{shaderLocation:3,offset:8*4,format:"float32x3"},{shaderLocation:4,offset:11*4,format:"float32x3"}]}]},fragment:{entryPoint:"main",targets:[{format:navigator.gpu.getPreferredCanvasFormat(),blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha",operation:"add"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"}}}]},primitive:{topology:"triangle-list",cullMode:"back",frontFace:"ccw"},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth24plus"}},qs=`
struct MeshMatrices {
  MVPC_MATRIX: mat4x4<f32>,
  M_MATRIX: mat4x4<f32>,
  NORM_MATRIX: mat3x3<f32>,
};

struct VertexOutput {
  @builtin(position) Position: vec4<f32>,
  @location(0) FragPos: vec3<f32>,
  @location(1) FragUV: vec2<f32>,
  @location(2) FragNormal: vec3<f32>,
  @location(3) FragTangent: vec3<f32>,
  @location(4) FragBinormal: vec3<f32>
};

@group(1) @binding(0) var<uniform> MESH_MATRICES: MeshMatrices;

@vertex
fn main(
  @location(0) Position: vec4<f32>,
  @location(1) TexUV: vec2<f32>,
  @location(2) Normal: vec3<f32>,
  @location(3) Tangent: vec3<f32>,
  @location(4) Binormal: vec3<f32>
) -> VertexOutput {
  var output: VertexOutput;
  output.Position = MESH_MATRICES.MVPC_MATRIX * Position;
  output.FragPos = vec4(MESH_MATRICES.M_MATRIX * Position).xyz;
  output.FragUV = TexUV;
  output.FragNormal = MESH_MATRICES.NORM_MATRIX * Normal;
  output.FragTangent = MESH_MATRICES.NORM_MATRIX * Tangent;
  output.FragBinormal = MESH_MATRICES.NORM_MATRIX * Binormal;
  return output;
}`,Ys=`
struct MaterialParams {
  OPACITY: f32,
  NORMAL_INTENSITY: f32,
  HAS_LIGHTNING: f32,
  HAS_TEXTURE: f32,
  HAS_DISPLACEMENT_MAP: f32,
  DISPLACEMENT_MAP_FACTOR: f32,
  HAS_SPECULARITY_MAP: f32,
  HAS_NORMAL_MAP: f32,
  HAS_ENV_MAP: f32,
}

struct MaterialColors {
  EMISSIVE: vec3<f32>,
  AMBIANT: vec3<f32>,
  DIFFUSE: vec3<f32>,
  SPECULAR: vec4<f32>
}

struct PointLight {
  INTENSITY: f32,
  POSITION: vec3<f32>,
  COLOR: vec3<f32>,
  ATTEN: vec3<f32>
}

struct DirectionnalLight {
  INTENSITY: f32,
  DIR: vec3<f32>,
  COLOR: vec3<f32>
}

struct FogInfo {
  HAS_FOG: f32,
  FOG_NEAR: f32,
  FOG_FAR: f32,
  FOG_COLOR: vec3<f32>
}

@group(0) @binding(0) var<uniform> CAMERA_POS: vec3<f32>;
@group(0) @binding(1) var<uniform> POINT_LIGHT0: PointLight;
@group(0) @binding(2) var<uniform> POINT_LIGHT1: PointLight;
@group(0) @binding(3) var<uniform> DIR_LIGHT: DirectionnalLight;
@group(0) @binding(4) var<uniform> FOG_INFO: FogInfo;

@group(2) @binding(0) var<uniform> MAT_COLORS: MaterialColors;
@group(2) @binding(1) var<uniform> MAT_PARAMS: MaterialParams;
@group(2) @binding(2) var<uniform> MAT_TEXTURE_SCROLL: vec2<f32>;
@group(2) @binding(3) var<uniform> MAT_DISPLACEMENT_SCROLL: vec2<f32>;

@group(3) @binding(0) var SAMPLER: sampler;
@group(3) @binding(1) var TEXTURE: texture_2d<f32>;
@group(3) @binding(2) var DISPLACEMENT_SAMPLER: sampler;
@group(3) @binding(3) var DISPLACEMENT_TEXTURE: texture_2d<f32>;
@group(3) @binding(4) var SPECULARITY_SAMPLER: sampler;
@group(3) @binding(5) var SPECULARITY_TEXTURE: texture_2d<f32>;
@group(3) @binding(6) var NORM_SAMPLER: sampler;
@group(3) @binding(7) var NORM_TEXTURE: texture_2d<f32>;
@group(3) @binding(8) var ENV_MAP_SAMPLER: sampler;
@group(3) @binding(9) var ENV_MAP_TEXTURE: texture_cube<f32>;

@fragment
fn main(
  @builtin(position) Position: vec4<f32>,
  @location(0) FragPos: vec3<f32>,
  @location(1) FragUV: vec2<f32>,
  @location(2) FragNormal: vec3<f32>,
  @location(3) FragTangent: vec3<f32>,
  @location(4) FragBinormal: vec3<f32>
) -> @location(0) vec4<f32> {
  var pos = FragPos;
  var normal = normalize(FragNormal);
  var outputColor = vec4(0.0, 0.0, 0.0, 1.0);
  var textureUV = MAT_TEXTURE_SCROLL + FragUV;
  var texel = vec4(1.0, 1.0, 1.0, 1.0);

  if (MAT_PARAMS.HAS_DISPLACEMENT_MAP == 1.0)
  {
    textureUV += CalcDisplacementMap(FragUV);
  }

  if (MAT_PARAMS.HAS_TEXTURE == 1.0)
  {
    texel = textureSample(TEXTURE, SAMPLER, textureUV);
  }

  if (MAT_PARAMS.HAS_NORMAL_MAP == 1.0)
  {
    normal = CalcNormalMap(normal, FragTangent, FragBinormal, textureUV);
  }

  if (MAT_PARAMS.HAS_LIGHTNING == 1.0)
  {
    if (DIR_LIGHT.INTENSITY > 0.0)
    {
      outputColor += CalcDirLight(DIR_LIGHT.DIR, DIR_LIGHT.INTENSITY, DIR_LIGHT.COLOR, normal, pos, textureUV) * texel;
    }

    if (POINT_LIGHT0.INTENSITY > 0.0)
    {
      outputColor += CalcPointLight(POINT_LIGHT0.POSITION, POINT_LIGHT0.INTENSITY, POINT_LIGHT0.COLOR, POINT_LIGHT0.ATTEN, normal, pos, textureUV) * texel;
    }

    if (POINT_LIGHT1.INTENSITY > 0.0)
    {
      outputColor += CalcPointLight(POINT_LIGHT1.POSITION, POINT_LIGHT1.INTENSITY, POINT_LIGHT1.COLOR, POINT_LIGHT1.ATTEN, normal, pos, textureUV) * texel;
    }

    outputColor += vec4(MAT_COLORS.EMISSIVE, 1.0);
  }
  else
  {
    outputColor = texel;
  }

  if (MAT_PARAMS.HAS_ENV_MAP == 1.0)
  {
    outputColor += CalcEnvMap(normal, pos);
  }

  if (FOG_INFO.HAS_FOG == 1.0)
  {
    var fogColor = FOG_INFO.FOG_COLOR;
    var fogStart = FOG_INFO.FOG_NEAR;
    var fogEnd = FOG_INFO.FOG_FAR;
    var fogDist = length(CAMERA_POS - FragPos);
    var fogFactor = clamp((fogEnd - fogDist) / (fogEnd - fogStart), 0.0, 1.0);
    var finalColor = (fogColor * (1.0 - fogFactor)) + (outputColor.rgb * fogFactor);
    var finalAlpha = mix(texel.a * MAT_PARAMS.OPACITY, 1.0, fogFactor);
    return vec4<f32>(finalColor, finalAlpha);
  }
  else
  {
    return vec4(outputColor.rgb, texel.a * MAT_PARAMS.OPACITY);
  }
}

// *****************************************************************************************************************
// CALC NORMAL MAP
// *****************************************************************************************************************

fn CalcNormalMap(normal: vec3<f32>, fragTangent: vec3<f32>, fragBinormal: vec3<f32>, textureUV: vec2<f32>) -> vec3<f32>
{
  var normalIntensity = vec4<f32>(MAT_PARAMS.NORMAL_INTENSITY, MAT_PARAMS.NORMAL_INTENSITY, 1, 1);
  var normalPixel = textureSample(NORM_TEXTURE, NORM_SAMPLER, textureUV) * normalIntensity;
  return normalize(normalize(fragTangent) * normalPixel.x + normalize(fragBinormal) * normalPixel.y + normal * normalPixel.z);
}

// *****************************************************************************************************************
// CALC ENV MAP
// *****************************************************************************************************************

fn CalcEnvMap(normal: vec3<f32>, fragPos: vec3<f32>) -> vec4<f32>
{
  var viewDir = normalize(CAMERA_POS - fragPos);
  var rvec = normalize(reflect(viewDir, normal));
  return textureSample(ENV_MAP_TEXTURE, ENV_MAP_SAMPLER, vec3<f32>(rvec.x, rvec.y, rvec.z));
}

// *****************************************************************************************************************
// CALC DISPLACEMENT MAP
// *****************************************************************************************************************

fn CalcDisplacementMap(fragUV: vec2<f32>) -> vec2<f32>
{
  var uv = vec2<f32>(0.0, 0.0);
  var greyScale = textureSample(DISPLACEMENT_TEXTURE, DISPLACEMENT_SAMPLER, MAT_DISPLACEMENT_SCROLL + fragUV);
  uv.x = clamp(MAT_PARAMS.DISPLACEMENT_MAP_FACTOR * ((greyScale.r * 2) - 1), 0.0, 1.0);
  uv.y = clamp(MAT_PARAMS.DISPLACEMENT_MAP_FACTOR * ((greyScale.r * 2) - 1), 0.0, 1.0);
  return uv;
}

// *****************************************************************************************************************
// CALC LIGHT INTERNAL
// *****************************************************************************************************************

fn CalcLightInternal(lightDir: vec3<f32>, lightColor: vec3<f32>, lightIntensity: f32, normal: vec3<f32>, fragPos: vec3<f32>, textureUV: vec2<f32>) -> vec4<f32>
{
  var ambientColor = lightColor * lightIntensity * MAT_COLORS.AMBIANT;
  var diffuseColor: vec3<f32> = vec3(0.0, 0.0, 0.0);
  var specularColor: vec3<f32> = vec3(0.0, 0.0, 0.0);
  var specularExponent = MAT_COLORS.SPECULAR.a;
  var diffuseFactor = max(dot(normal, -lightDir), 0.0);

  if (MAT_PARAMS.HAS_SPECULARITY_MAP == 1.0)
  {
    specularExponent = MAT_COLORS.SPECULAR.a * textureSample(SPECULARITY_TEXTURE, SPECULARITY_SAMPLER, textureUV).r;
  }

  if (diffuseFactor > 0.0)
  {
    diffuseColor = lightColor * lightIntensity * MAT_COLORS.DIFFUSE * diffuseFactor;
    if (specularExponent > 0.0)
    {
      var reflectDir = reflect(lightDir, normal);
      var viewDir = normalize(CAMERA_POS - fragPos);
      var specularFactor = max(dot(viewDir, reflectDir), 0.0);
      if (specularFactor > 0.0)
      {
        specularFactor = pow(specularFactor, specularExponent);
        specularColor = lightColor * lightIntensity * MAT_COLORS.SPECULAR.rgb * specularFactor;
      }
    }
  }

  return vec4(ambientColor + diffuseColor + specularColor, 1.0);
}

// *****************************************************************************************************************
// CALC DIR LIGHT
// *****************************************************************************************************************

fn CalcDirLight(lightDir: vec3<f32>, lightIntensity: f32, lightColor: vec3<f32>, normal: vec3<f32>, fragPos: vec3<f32>, textureUV: vec2<f32>) -> vec4<f32>
{
  return CalcLightInternal(normalize(lightDir), lightColor, lightIntensity, normal, fragPos, textureUV);
}

// *****************************************************************************************************************
// CALC POINT LIGHT
// *****************************************************************************************************************

fn CalcPointLight(lightPos: vec3<f32>, lightIntensity: f32, lightColor: vec3<f32>, lightAttenuation: vec3<f32>, normal: vec3<f32>, fragPos: vec3<f32>, textureUV: vec2<f32>) -> vec4<f32>
{
  var lightDir = fragPos - lightPos;
  var distance = length(lightDir);
  lightDir = normalize(lightDir);

  var color = CalcLightInternal(lightDir, lightColor, lightIntensity, normal, fragPos, textureUV);
  var attenuation = lightAttenuation[0] + lightAttenuation[1] * distance + lightAttenuation[2] * distance * distance;
  return color / attenuation;
}
`;class Xs extends Zi{worldBuffer;cmdBuffer;pointLight0;pointLight1;dirLight;fog;meshCommands;constructor(){super("MESH_PIPELINE",qs,Ys,Gs),this.worldBuffer=x.createUniformGroupDataset("MESH_PIPELINE",0),this.worldBuffer.addInput(0,l.F03_SIZE,"CAM_POS"),this.worldBuffer.addInput(1,l.F16_SIZE,"POINT_LIGHT0"),this.worldBuffer.addInput(2,l.F16_SIZE,"POINT_LIGHT1"),this.worldBuffer.addInput(3,l.F12_SIZE,"DIR_LIGHT"),this.worldBuffer.addInput(4,l.F12_SIZE,"FOG"),this.worldBuffer.allocate(),this.cmdBuffer=x.createUniformGroupDataset("MESH_PIPELINE",1),this.cmdBuffer.addInput(0,l.F16_SIZE*3,"MESH_MATRICES"),this.cmdBuffer.allocate(),this.pointLight0=new Float32Array(16),this.enablePointLight(0,0,[0,0,0]),this.setPointLightAttenuation(0,1,0,0),this.pointLight1=new Float32Array(16),this.enablePointLight(1,0,[0,0,0]),this.setPointLightAttenuation(1,1,0,0),this.dirLight=new Float32Array(12),this.enableDirLight(0,[0,-1,0]),this.fog=new Float32Array(12),this.enableFog(!1,[.5,.5,.5]),this.meshCommands=[]}render(){const t=x.getCurrentView(),e=x.getPassEncoder();e.setPipeline(this.pipeline),this.worldBuffer.beginWrite(),this.worldBuffer.write(0,new Float32Array(t.getCameraPosition())),this.worldBuffer.write(1,this.pointLight0),this.worldBuffer.write(2,this.pointLight1),this.worldBuffer.write(3,this.dirLight),this.worldBuffer.write(4,this.fog),this.worldBuffer.endWrite(),e.setBindGroup(0,this.worldBuffer.getBindGroup()),this.cmdBuffer.getSize()<this.meshCommands.length&&this.cmdBuffer.allocate(this.meshCommands.length);const i=t.getViewProjectionClipMatrix(),s=new Float32Array(16*3);this.cmdBuffer.beginWrite();for(let r=0;r<this.meshCommands.length;r++){const n=this.meshCommands[r],o=n.matrix?n.matrix:n.mesh.getTransformMatrix();l.MAT4_MULTIPLY(i,o,s),s[16+0]=o[0],s[16+1]=o[1],s[16+2]=o[2],s[16+3]=o[3],s[16+4]=o[4],s[16+5]=o[5],s[16+6]=o[6],s[16+7]=o[7],s[16+8]=o[8],s[16+9]=o[9],s[16+10]=o[10],s[16+11]=o[11],s[16+12]=o[12],s[16+13]=o[13],s[16+14]=o[14],s[16+15]=o[15],s[32+0]=o[0],s[32+1]=o[1],s[32+2]=o[2],s[32+4]=o[4],s[32+5]=o[5],s[32+6]=o[6],s[32+8]=o[8],s[32+9]=o[9],s[32+10]=o[10],this.cmdBuffer.write(0,s),e.setBindGroup(1,this.cmdBuffer.getBindGroup(r));const h=n.mesh.getMaterial(),c=h.getDataBuffer();e.setBindGroup(2,c.getBindGroup());const d=h.getTexturesBuffer();e.setBindGroup(3,d.getBindGroup()),e.setVertexBuffer(0,x.getVertexBuffer(),n.mesh.getVertexSubBufferOffset(),n.mesh.getVertexSubBufferSize()),e.draw(n.mesh.getVertexCount())}this.cmdBuffer.endWrite(),this.meshCommands=[]}drawMesh(t,e=null){this.meshCommands.push({mesh:t,matrix:e})}enablePointLight(t,e,i){t==0?(this.pointLight0[0]=e,this.pointLight0[1*4+0]=i[0],this.pointLight0[1*4+1]=i[1],this.pointLight0[1*4+2]=i[2]):t==1&&(this.pointLight1[0]=e,this.pointLight1[1*4+0]=i[0],this.pointLight1[1*4+1]=i[1],this.pointLight1[1*4+2]=i[2])}setPointLightColor(t,e){t==0?(this.pointLight0[2*4+0]=e[0],this.pointLight0[2*4+1]=e[1],this.pointLight0[2*4+2]=e[2]):t==1&&(this.pointLight1[2*4+0]=e[0],this.pointLight1[2*4+1]=e[1],this.pointLight1[2*4+2]=e[2])}setPointLightAttenuation(t,e,i,s){t==0?(this.pointLight0[3*4+0]=e,this.pointLight0[3*4+1]=i,this.pointLight0[3*4+2]=s):t==1&&(this.pointLight1[3*4+0]=e,this.pointLight1[3*4+1]=i,this.pointLight1[3*4+2]=s)}enableDirLight(t,e){this.dirLight[0]=t,this.dirLight[1*4+0]=e[0],this.dirLight[1*4+1]=e[1],this.dirLight[1*4+2]=e[2]}setDirLightColor(t){this.dirLight[2*4+0]=t[0],this.dirLight[2*4+1]=t[1],this.dirLight[2*4+2]=t[2]}enableFog(t,e=[.5,.5,.5],i=3,s=15){this.fog[0]=t?1:0,this.fog[1]=i,this.fog[2]=s,this.fog[1*4+0]=e[0],this.fog[1*4+1]=e[1],this.fog[1*4+2]=e[2]}}const ot=new Xs,Ki=5,zs={label:"Sprite pipeline",layout:"auto",vertex:{entryPoint:"main",buffers:[{arrayStride:Ki*4,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:3*4,format:"float32x2"}]}]},fragment:{entryPoint:"main",targets:[{format:navigator.gpu.getPreferredCanvasFormat(),blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha",operation:"add"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"}}}]},primitive:{topology:"triangle-list",cullMode:"back",frontFace:"ccw"},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth24plus"}},Zs=`
@group(0) @binding(0) var<uniform> MVPC_MATRIX: mat4x4<f32>;

struct VertexOutput {
  @builtin(position) Position: vec4<f32>,
  @location(0) FragUV: vec2<f32>
};

@vertex
fn main(
  @location(0) Position : vec4<f32>,
  @location(1) TexUV : vec2<f32>
) -> VertexOutput {
  var output : VertexOutput;
  output.Position = MVPC_MATRIX * Position;
  output.FragUV = TexUV;
  return output;
}`,Ks=`
@group(1) @binding(0) var SAMPLER: sampler;
@group(1) @binding(1) var TEXTURE: texture_2d<f32>;

@fragment
fn main(
  @location(0) FragUV: vec2<f32>
) -> @location(0) vec4<f32> {
  var textureColor:vec4<f32> = (textureSample(TEXTURE, SAMPLER, FragUV));
  if (textureColor.a == 0)
  {
    discard;
  }

  return textureColor;
}`;class Qs extends Zi{spritesBuffer;sprites;constructor(){super("SPRITE_PIPELINE",Zs,Ks,zs),this.spritesBuffer=x.createUniformGroupDataset("SPRITE_PIPELINE",0),this.spritesBuffer.addInput(0,l.MAT4_SIZE,"MVPC_MATRIX"),this.spritesBuffer.allocate(),this.sprites=[]}render(){const t=x.getCurrentView(),e=x.getPassEncoder();e.setPipeline(this.pipeline),this.spritesBuffer.getSize()<this.sprites.length&&this.spritesBuffer.allocate(this.sprites.length);const i=t.getCameraMatrix(),s=t.getCameraViewMatrix(),r=t.getProjectionClipMatrix(),n=t.getViewProjectionClipMatrix(),o=l.MAT4_CREATE();this.spritesBuffer.beginWrite();for(let h=0;h<this.sprites.length;h++){const c=this.sprites[h];if(c.getBillboardMode()){const f=l.MAT4_MULTIPLY(s,c.getTransformMatrix());l.MAT4_MULTIPLY(f,i,f),l.MAT4_MULTIPLY(f,l.MAT4_TRANSLATE(s[12],s[13],s[14]),f),l.MAT4_MULTIPLY(r,f,o)}else l.MAT4_MULTIPLY(n,c.getTransformMatrix(),o);this.spritesBuffer.write(0,o),e.setBindGroup(0,this.spritesBuffer.getBindGroup(h));const d=c.getTextureBuffer();e.setBindGroup(1,d.getBindGroup()),e.setVertexBuffer(0,x.getVertexBuffer(),c.getVertexSubBufferOffset(),c.getVertexSubBufferSize()),e.draw(c.getVertexCount())}this.spritesBuffer.endWrite(),this.sprites=[]}drawSprite(t){this.sprites.push(t)}}const Qi=new Qs,$i=6,$s={label:"Skybox pipeline",layout:"auto",vertex:{entryPoint:"main",buffers:[{arrayStride:$i*4,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:3*4,format:"float32x3"}]}]},fragment:{entryPoint:"main",targets:[{format:navigator.gpu.getPreferredCanvasFormat(),blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha",operation:"add"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"}}}]},primitive:{topology:"triangle-list",cullMode:"back",frontFace:"ccw"},depthStencil:{depthWriteEnabled:!1,depthCompare:"always",format:"depth24plus"}},Js=`
struct VertexOutput {
  @builtin(position) Position: vec4<f32>,
  @location(0) ClipPos: vec4<f32>
};

@vertex
fn main(
  @location(0) Position: vec4<f32>,
) -> VertexOutput {
  var output : VertexOutput;
  output.Position = Position;
  output.Position.z = 1;
  output.ClipPos = Position;
  return output;
}`,tr=`
@group(0) @binding(0) var<uniform> VPC_INVERSE_MATRIX: mat4x4<f32>;
@group(1) @binding(0) var CUBEMAP_SAMPLER: sampler;
@group(1) @binding(1) var CUBEMAP_TEXTURE: texture_cube<f32>;

@fragment
fn main(
  @builtin(position) Position: vec4<f32>,
  @location(0) ClipPos: vec4<f32>
) -> @location(0) vec4<f32> {
  var t = VPC_INVERSE_MATRIX * ClipPos;
  return textureSample(CUBEMAP_TEXTURE, CUBEMAP_SAMPLER, normalize(t.xyz / t.w));
}`;class er{pipeline;dataBuffer;skybox;constructor(){this.pipeline=x.loadPipeline("SKYBOX_PIPELINE",Js,tr,$s),this.dataBuffer=x.createUniformGroupDataset("SKYBOX_PIPELINE",0),this.dataBuffer.addInput(0,l.MAT4_SIZE,"VPC_INVERSE_MATRIX"),this.dataBuffer.allocate(),this.skybox=null}render(){if(!this.skybox)return;const t=x.getCurrentView(),e=x.getPassEncoder();e.setPipeline(this.pipeline);const i=new Float32Array(t.getCameraViewMatrix());i[12]=i[13]=i[14]=0;const s=l.MAT4_MULTIPLY(t.getProjectionClipMatrix(),i),r=l.MAT4_CREATE();l.MAT4_INVERT(s,r),this.dataBuffer.beginWrite(),this.dataBuffer.write(0,r),this.dataBuffer.endWrite(),e.setBindGroup(0,this.dataBuffer.getBindGroup());const n=this.skybox.getCubemapBuffer();e.setBindGroup(1,n.getBindGroup()),e.setVertexBuffer(0,x.getVertexBuffer(),this.skybox.getVertexSubBufferOffset(),this.skybox.getVertexSubBufferSize()),e.draw(this.skybox.getVertexCount())}draw(t){this.skybox=t}}const Ji=new er,ts=15,ir={label:"Particles pipeline",layout:"auto",vertex:{entryPoint:"main",buffers:[{arrayStride:ts*4,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:3*4,format:"float32x3"},{shaderLocation:2,offset:6*4,format:"float32x2"},{shaderLocation:3,offset:8*4,format:"float32x3"},{shaderLocation:4,offset:11*4,format:"float32"},{shaderLocation:5,offset:12*4,format:"float32"},{shaderLocation:6,offset:13*4,format:"float32"},{shaderLocation:7,offset:14*4,format:"float32"}]}]},fragment:{entryPoint:"main",targets:[{format:navigator.gpu.getPreferredCanvasFormat(),blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha",operation:"add"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"}}}]},primitive:{topology:"triangle-list",cullMode:"none",frontFace:"ccw"},depthStencil:{depthWriteEnabled:!1,depthCompare:"less",format:"depth24plus"}},sr=`
struct VertexOutput {
  @builtin(position) Position: vec4<f32>,
  @location(0) FragUV: vec2<f32>,
  @location(1) Color: vec4<f32>,
  @location(2) Angle: f32
};

@group(0) @binding(0) var<uniform> V_MATRIX: mat4x4<f32>;
@group(0) @binding(1) var<uniform> MVPC_MATRIX: mat4x4<f32>;

@vertex
fn main(
  @location(0) Pos: vec3<f32>,
  @location(1) Center: vec3<f32>,
  @location(2) TexUV: vec2<f32>,
  @location(3) Color: vec3<f32>,
  @location(4) Size: f32,
  @location(5) Opacity: f32,
  @location(6) Angle: f32,
  @location(7) Visible: f32
) -> VertexOutput {
  var output : VertexOutput;

  if(Visible == 1)
  {
    output.Color = vec4(Color, Opacity);
  }
  else
  {
    output.Color = vec4(0.0, 0.0, 0.0, 0.0);
  }

  var right = vec3<f32>(V_MATRIX[0][0], V_MATRIX[1][0], V_MATRIX[2][0]);
  var up = vec3<f32>(V_MATRIX[0][1], V_MATRIX[1][1], V_MATRIX[2][1]);

  output.Position = MVPC_MATRIX * vec4<f32>(Center + (right * Pos.x * Size) + (up * Pos.y * Size), 1.0);
  output.FragUV = TexUV;
  output.Angle = Angle;
  return output;
}`,rr=`
@group(1) @binding(0) var SAMPLER: sampler;
@group(1) @binding(1) var TEXTURE: texture_2d<f32>;

@fragment
fn main(
  @builtin(position) Position: vec4<f32>,
  @location(0) FragUV: vec2<f32>,
  @location(1) Color: vec4<f32>,
  @location(2) Angle: f32
) -> @location(0) vec4<f32> {
  var c = cos(Angle);
  var s = sin(Angle);

  var rotatedUV = vec2(
    c * (FragUV.x - 0.5) + s * (FragUV.y - 0.5) + 0.5,
    c * (FragUV.y - 0.5) - s * (FragUV.x - 0.5) + 0.5
  );

  return textureSample(TEXTURE, SAMPLER, rotatedUV) * Color;
}`;class nr{pipeline;particlesBuffer;particlesList;constructor(){this.pipeline=x.loadPipeline("PARTICLES_PIPELINE",sr,rr,ir),this.particlesBuffer=x.createUniformGroupDataset("PARTICLES_PIPELINE",0),this.particlesBuffer.addInput(0,l.F16_SIZE,"VC_MATRIX"),this.particlesBuffer.addInput(1,l.F16_SIZE,"MVPC_MATRIX"),this.particlesBuffer.allocate(),this.particlesList=[]}render(){const t=x.getCurrentView(),e=x.getPassEncoder();e.setPipeline(this.pipeline),this.particlesBuffer.getSize()<this.particlesList.length&&this.particlesBuffer.allocate(this.particlesList.length);const i=t.getCameraViewMatrix(),s=t.getViewProjectionClipMatrix(),r=l.MAT4_CREATE();this.particlesBuffer.beginWrite();for(let n=0;n<this.particlesList.length;n++){const o=this.particlesList[n],h=o.getTransformMatrix();l.MAT4_MULTIPLY(s,h,r),this.particlesBuffer.write(0,i),this.particlesBuffer.write(1,r),e.setBindGroup(0,this.particlesBuffer.getBindGroup(n));const c=o.getTextureBuffer();e.setBindGroup(1,c.getBindGroup()),e.setVertexBuffer(0,x.getVertexBuffer(),o.getVertexSubBufferOffset(),o.getVertexSubBufferSize()),e.draw(o.getVertexCount())}this.particlesBuffer.endWrite(),this.particlesList=[]}drawParticles(t){this.particlesList.push(t)}}const es=new nr;class or{canvas;ctx;cameraTransform;cameraScale;cameraRotation;cameraPosition;bgColor;constructor(){if(this.canvas=document.getElementById("CANVAS_2D"),this.ctx=this.canvas.getContext("2d"),this.cameraTransform=l.MAT3_IDENTITY(),this.cameraScale=[1,1],this.cameraRotation=0,this.cameraPosition=[0,0],this.bgColor=[0,0,0,0],!this.ctx)throw l.FAIL("This browser does not support canvas"),new Error("Gfx2Manager::Gfx2Manager: Your browser not support 2D")}update(t){(this.canvas.width!=this.canvas.clientWidth||this.canvas.height!=this.canvas.clientHeight)&&(this.canvas.width=this.canvas.clientWidth,this.canvas.height=this.canvas.clientHeight)}beginDrawing(){this.ctx.restore(),this.ctx.save(),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle=`rgba(${this.bgColor[0]}, ${this.bgColor[1]}, ${this.bgColor[2]}, ${this.bgColor[3]})`,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.transform(this.cameraTransform[0],this.cameraTransform[1],this.cameraTransform[3],this.cameraTransform[4],this.cameraTransform[6],this.cameraTransform[7]),this.ctx.translate(this.canvas.width*.5,this.canvas.height*.5),this.ctx.scale(this.cameraScale[0],this.cameraScale[1]),this.ctx.rotate(this.cameraRotation),this.ctx.translate(-this.cameraPosition[0],-this.cameraPosition[1])}endDrawing(){}moveCamera(t,e){this.cameraPosition[0]+=t,this.cameraPosition[1]+=e}findCanvasPosFromClientPos(t,e){const i=this.canvas.getBoundingClientRect(),s=t-i.x,r=e-i.y;return[s,r]}findWorldPosFromClientPos(t,e){const i=this.canvas.getBoundingClientRect(),s=t-i.x+this.cameraPosition[0]-this.canvas.width*.5,r=e-i.y+this.cameraPosition[1]-this.canvas.height*.5;return[s,r]}getWidth(){return this.canvas.clientWidth}getHeight(){return this.canvas.clientHeight}getContext(){return this.ctx}setCameraTransform(t){this.cameraTransform=t}getCameraTransform(){return this.cameraTransform}setCameraPosition(t,e){this.cameraPosition[0]=t,this.cameraPosition[1]=e}getCameraPosition(){return this.cameraPosition}getCameraPositionX(){return this.cameraPosition[0]}getCameraPositionY(){return this.cameraPosition[1]}setCameraScale(t,e){this.cameraScale[0]=t,this.cameraScale[1]=e}getCameraScale(){return this.cameraScale}getCameraScaleX(){return this.cameraScale[0]}getCameraScaleY(){return this.cameraScale[1]}setCameraRotation(t){this.cameraRotation=t}getCameraRotation(){return this.cameraRotation}setBgColor(t,e,i,s){this.bgColor[0]=t,this.bgColor[1]=e,this.bgColor[2]=i,this.bgColor[3]=s}getBgColor(){return this.bgColor}getDefaultTexture(){const t=new Image;return t.src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",t}}const V=new or;class ar{requests;screens;constructor(){this.requests=[],this.screens=[]}update(t){for(;this.requests.length>0;)this.requests.pop()();for(let e=this.screens.length-1;e>=0;e--)if(this.screens[e].update(t),this.screens[e].isBlocking())return}draw(){for(let t=this.screens.length-1;t>=0;t--)if(this.screens[t].draw(),this.screens[t].isBlocking())return}requestPushScreen(t,e={}){this.requests.push(()=>{if(this.screens.indexOf(t)!=-1)throw new Error("ScreenManager::requestPushScreen(): You try to push an existing screen to the stack !");this.screens[this.screens.length-1].onBringToBack(t),t.onEnter(e).then(()=>this.screens.push(t))})}requestSetScreen(t,e={}){this.requests.push(()=>{this.screens.forEach(s=>s.onExit()),this.screens=[],t.onEnter(e).then(()=>this.screens.push(t))})}requestPopScreen(){this.requests.push(()=>{if(this.screens.length==0)throw new Error("ScreenManager::requestPopScreen: You try to pop an empty state stack !");let t=this.screens[this.screens.length-1];t.onExit(),this.screens.pop(),this.screens.length>0&&this.screens[this.screens.length-1].onBringToFront(t)})}}const _=new ar;class hr{subscribers;constructor(){this.subscribers=[]}wait(t,e){return new Promise(i=>{this.subscribeOnce(t,e,this,s=>{i(s)})})}subscribe(t,e,i,s){this.subscribers.push({emitter:t,type:e,listener:i,once:!1,cb:s})}subscribeOnce(t,e,i,s){this.subscribers.push({emitter:t,type:e,listener:i,once:!0,cb:s})}unsubscribe(t,e,i){for(let s of this.subscribers)if(s.emitter==t&&s.type==e&&s.listener==i){this.subscribers.splice(this.subscribers.indexOf(s),1);return}}unsubscribeAll(){this.subscribers=[]}async emit(t,e,i={}){const s=[];for(const r of this.subscribers.slice())if(r.emitter==t&&r.type==e){const n=r.cb.call(r.listener,i);n instanceof Promise&&s.push(n),r.once&&this.subscribers.splice(this.subscribers.indexOf(r),1)}return Promise.all(s)}}const u=new hr;class lr{root;fadeLayer;overLayer;focusedWidget;widgets;constructor(){this.root=document.getElementById("UI_ROOT"),this.fadeLayer=document.getElementById("UI_FADELAYER"),this.overLayer=document.getElementById("UI_OVERLAYER"),this.focusedWidget=null,this.widgets=[]}update(t){for(let e of this.widgets)e.update(t)}getWidgets(){return this.widgets}focus(t){this.focusedWidget&&this.focusedWidget.unfocus(),t.focus(),this.focusedWidget=t,u.emit(this,"E_FOCUSED",{widget:t})}unfocus(){!this.focusedWidget||(this.focusedWidget.unfocus(),this.focusedWidget=null,u.emit(this,"E_UNFOCUSED"))}addNode(t,e=""){t.style.cssText+=e,this.root.appendChild(t)}removeNode(t){this.root.removeChild(t)}addWidget(t,e=""){return t.appendStyles(e),this.root.appendChild(t.getNode()),this.widgets.push(t),t}removeWidget(t){const e=this.widgets.indexOf(t);if(e==-1)throw new Error("UIManager::removeWidget: fail to remove widget !");return t==this.focusedWidget&&this.unfocus(),t.delete(),this.widgets.splice(e,1),!0}clear(){for(this.root.innerHTML="",this.focusedWidget=null;this.widgets.length>0;)this.widgets.pop().delete()}fadeIn(t,e,i="linear",s=()=>{}){this.fadeLayer.style.transitionDuration=e+"ms",this.fadeLayer.style.transitionDelay=t+"ms",this.fadeLayer.style.transitionTimingFunction=i,this.fadeLayer.style.opacity="1",setTimeout(()=>{s()},t+e)}fadeOut(t,e,i="linear",s=()=>{}){this.fadeLayer.style.transitionDuration=e+"ms",this.fadeLayer.style.transitionDelay=t+"ms",this.fadeLayer.style.transitionTimingFunction=i,this.fadeLayer.style.opacity="0",setTimeout(()=>{s()},t+e)}enableOverlayer(t){this.overLayer.style.opacity=t?"1":"0"}}const p=new lr;class k{blocking;constructor(){this.blocking=!0}setBlocking(t){this.blocking=t}isBlocking(){return this.blocking}update(t){}draw(){}async onEnter(t){}onExit(){}onBringToFront(t){}onBringToBack(t){}}const Pt=new Map;Pt.set("0","0");Pt.set("1","1");Pt.set("BtnSelect","8");Pt.set("PadTop","12");Pt.set("PadBottom","13");Pt.set("PadLeft","14");Pt.set("PadRight","15");class cr{keymap;actionmap;actionRegister;pads;padsInterval;constructor(){this.keymap=new Map,this.actionmap=new Map,this.actionRegister=[],this.pads=[],this.padsInterval,document.addEventListener("keydown",t=>this.handleKeyDown(t)),document.addEventListener("keyup",t=>this.handleKeyUp(t)),window.addEventListener("gamepadconnected",t=>this.handleGamePadConnected(t)),window.addEventListener("gamepaddisconnected",t=>this.handleGamePadDisconnected(t)),this.registerAction("keyboard","Enter","OK"),this.registerAction("keyboard","Escape","BACK"),this.registerAction("keyboard"," ","SELECT"),this.registerAction("keyboard","ArrowLeft","LEFT"),this.registerAction("keyboard","ArrowRight","RIGHT"),this.registerAction("keyboard","ArrowUp","UP"),this.registerAction("keyboard","ArrowDown","DOWN"),this.registerAction("gamepad0","0","OK"),this.registerAction("gamepad0","1","BACK"),this.registerAction("gamepad0","BtnSelect","SELECT"),this.registerAction("gamepad0","PadLeft","LEFT"),this.registerAction("gamepad0","PadRight","RIGHT"),this.registerAction("gamepad0","PadTop","UP"),this.registerAction("gamepad0","PadBottom","DOWN")}getPad(t){return this.pads.find(e=>e.index==t)}addPad(t){this.pads.push(t),this.padsInterval===null&&(this.padsInterval=setInterval(()=>this.$updatePadsStatus(),50))}removePad(t){this.pads=this.pads.filter(e=>e.id!=t),this.pads.length<=0&&(clearInterval(this.padsInterval),this.padsInterval=void 0)}registerAction(t,e,i){this.actionRegister.find(r=>r.inputSource==t&&r.eventKey==e&&r.id==i)||this.actionRegister.push({id:i,inputSource:t,eventKey:t.startsWith("gamepad")?Pt.get(e):e})}unregisterAction(t,e,i){const s=this.actionRegister.findIndex(r=>r.inputSource==t&&r.eventKey==e&&r.id==i);if(s==-1)throw new Error("InputManager::unregisterAction(): action not found !");this.actionRegister.splice(s,1)}findActionIds(t,e){const i=[];for(const s of this.actionRegister)s.inputSource==t&&s.eventKey==e&&i.push(s.id);return i}isActiveAction(t){return this.actionmap.get(t)}handleGamePadDisconnected(t){this.removePad(t.gamepad.id)}handleGamePadConnected(t){const e={index:t.gamepad.index,id:t.gamepad.id,nButtons:t.gamepad.buttons.length,nAxes:t.gamepad.axes.length,pressed:[]};for(let i=0;i<t.gamepad.buttons.length;i++)e.pressed[i]=t.gamepad.buttons[i].pressed;this.addPad(e)}handleKeyDown(t){if(!this.keymap.get(t.key))for(const e of this.findActionIds("keyboard",t.key))u.emit(this,"E_ACTION_ONCE",{actionId:e}),this.actionmap.set(e,!0);for(const e of this.findActionIds("keyboard",t.key))u.emit(this,"E_ACTION",{actionId:e}),this.actionmap.set(e,!0);return this.keymap.set(t.key,!0),t.preventDefault(),t.stopPropagation(),!1}handleKeyUp(t){for(const e of this.findActionIds("keyboard",t.key))u.emit(this,"E_ACTION_RELEASED",{actionId:e}),this.actionmap.set(e,!1);this.keymap.set(t.key,!1)}$updatePadsStatus(){const t=window.navigator,e=t.getGamepads?t.getGamepads():t.webkitGetGamepads?t.webkitGetGamepads():[];for(const i of e){if(!i)continue;const s=this.getPad(i.index);if(s!=null){for(let r=0;r<i.buttons.length;r++)if(i.buttons[r].pressed!=s.pressed[r]){for(const n of this.findActionIds("gamepad"+i.index,r.toString()))this.actionmap.set(n,i.buttons[r].pressed),i.buttons[r].pressed&&u.emit(this,"E_ACTION",{actionId:n});this.keymap.set("gamepad"+i.index+"-"+r,i.buttons[r].pressed),s.pressed[r]=i.buttons[r].pressed}}}}}const R=new cr;class H{id;className;template;node;constructor(t={}){this.id=t.id??"",this.className=t.className??"",this.template=t.template??"",this.node=document.createElement("div"),this.node.className=this.className,this.node.innerHTML=this.template,this.node.addEventListener("animationend",()=>u.emit(this,"E_ANIMATION_FINISHED"))}update(t){}delete(){this.node.remove(),u.unsubscribe(R,"E_ACTION",this)}getId(){return this.id}setId(t){this.id=t,this.node.id=t}getNode(){return this.node}appendStyles(t){this.node.style.cssText+=t}focus(){this.node.classList.add("u-focused"),u.emit(this,"E_FOCUSED"),u.subscribe(R,"E_ACTION",this,t=>this.onAction(t.actionId))}unfocus(){this.node.classList.remove("u-focused"),u.emit(this,"E_UNFOCUSED"),u.unsubscribe(R,"E_ACTION",this)}isFocused(){return this.node.classList.contains("u-focused")}setVisible(t){t?this.node.classList.remove("u-hidden"):this.node.classList.add("u-hidden")}isVisible(){return!this.node.classList.contains("u-hidden")}setEnabled(t){t?this.node.classList.remove("u-disabled"):this.node.classList.add("u-disabled")}isEnabled(){return!this.node.classList.contains("u-disabled")}setSelected(t){t?this.node.classList.add("u-selected"):this.node.classList.remove("u-selected")}isSelected(){return this.node.classList.contains("u-selected")}animate(t){this.node.style.animation=t}onAction(t){}}var xe=(a=>(a[a.X=0]="X",a[a.Y=1]="Y",a[a.XY=2]="XY",a))(xe||{});class is extends H{axis;rows;columns;multiple;selectable;widgets;focusedWidget;selectedWidgets;constructor(t={}){super({className:t.className??"UIMenu"}),this.axis=t.axis??1,this.rows=t.rows??0,this.columns=t.columns??0,this.multiple=t.multiple??!1,this.selectable=t.selectable??!0,this.widgets=[],this.selectedWidgets=[],this.axis==0?(this.rows=1,this.columns=1/0,this.node.style.display="flex",this.node.style.flexDirection="row"):this.axis==1?(this.rows=1/0,this.columns=1,this.node.style.display="flex",this.node.style.flexDirection="column"):(this.node.style.display="grid",this.node.style.grid="repeat("+this.rows+", auto) / repeat("+this.columns+", auto)")}delete(){for(const t of this.widgets)t.delete();super.delete()}update(t){for(const e of this.widgets)e.update(t)}focus(t=0){if(this.widgets.length>0&&t==0){const e=this.focusedWidget?this.widgets.indexOf(this.focusedWidget):0;this.focusWidget(e,!0)}super.focus()}addWidget(t,e=-1){const i=t.getNode();e==-1?(this.widgets.push(t),this.node.appendChild(i)):(this.widgets.splice(e+1,0,t),this.node.insertBefore(i,this.node.children[e])),i.addEventListener("click",()=>this.handleWidgetClicked(t)),i.addEventListener("mousemove",()=>this.handleWidgetHover(t))}removeWidget(t){const e=this.widgets[t];if(!e)throw new Error("UIMenu::removeWidget(): widget not found !");this.selectedWidgets.indexOf(e)!=-1&&this.selectedWidgets.splice(this.selectedWidgets.indexOf(e),1),this.focusedWidget==e&&(this.focusedWidget=void 0),this.widgets.splice(this.widgets.indexOf(e),1),e.delete()}focusWidget(t,e=!1,i=!0){const s=this.widgets[t];if(!s)throw new Error("UIMenu::focusWidget(): widget not found !");if(!e){const r=this.getViewRectWidget(t);r.top<0&&(this.node.scrollTop+=r.top),r.bottom>this.node.clientHeight&&(this.node.scrollTop+=r.bottom-this.node.clientHeight)}this.widgets.forEach(r=>r.unfocus()),s.focus(),this.focusedWidget=s,i&&u.emit(this,"E_ITEM_FOCUSED",{id:s.getId(),index:t})}unfocusWidget(t=!0){this.widgets.forEach(e=>e.unfocus()),this.focusedWidget=void 0,t&&u.emit(this,"E_ITEM_UNFOCUSED")}selectWidget(t,e=!0){const i=this.widgets[t];if(!i)throw new Error("UIMenu::selectWidget(): widget not found !");if(!!i.isEnabled()){if(this.multiple&&i.isSelected()){i.setSelected(!1),this.selectedWidgets.splice(this.selectedWidgets.indexOf(i),1);return}this.multiple||(this.widgets.forEach(s=>s.setSelected(!1)),this.selectedWidgets=[]),i.setSelected(!0),this.selectedWidgets.push(i),e&&u.emit(this,"E_ITEM_SELECTED",{id:i.getId(),index:t})}}unselectWidget(t,e=!0){const i=this.widgets[t];if(!i)throw new Error("UIMenu::unselectWidget(): widget not found !");!i.isSelected()||(i.setSelected(!1),this.selectedWidgets.splice(this.selectedWidgets.indexOf(i),1),e&&u.emit(this,"E_ITEM_UNSELECTED",{id:i.getId(),index:t}))}unselectWidgets(t=!0){this.widgets.forEach(e=>e.setSelected(!1)),this.selectedWidgets=[],t&&u.emit(this,"E_UNSELECTED")}setEnabledWidget(t,e){const i=this.widgets[t];if(!i)throw new Error("UIMenu::setEnabledWidget(): widget not found !");i.setEnabled(e)}setEnabledWidgets(t){this.widgets.forEach(e=>e.setEnabled(t))}clear(){this.widgets.forEach(t=>t.delete()),this.widgets=[],this.focusedWidget=void 0,this.selectedWidgets=[],this.node.innerHTML=""}getViewRectWidget(t){const e=this.node.children[t],i=e.offsetTop-this.node.scrollTop,s=i+e.offsetHeight;return{top:i,bottom:s}}getFocusedWidgetId(){return this.focusedWidget?this.focusedWidget.getId():null}getFocusedWidgetIndex(){return this.focusedWidget?this.widgets.indexOf(this.focusedWidget):-1}getSelectedWidgetId(){return this.selectedWidgets[0]?this.selectedWidgets[0].getId():null}getSelectedWidgetIndex(){return this.selectedWidgets[0]?this.widgets.indexOf(this.selectedWidgets[0]):-1}getSelectedWidgetIds(){return this.selectedWidgets.map(t=>t.getId())}getSelectedWidgetIndexes(){return this.selectedWidgets.map(t=>this.widgets.indexOf(t))}getWidgets(){return this.widgets}onAction(t){if(t=="BACK")u.emit(this,"E_CLOSED");else if(t=="OK"){const e=this.getFocusedWidgetIndex();this.selectWidget(e)}else if(t=="LEFT"){const e=this.getFocusedWidgetIndex(),i=e-1<0?this.widgets.length-1:e-1;this.focusWidget(i)}else if(t=="RIGHT"){const e=this.getFocusedWidgetIndex(),i=e+1>this.widgets.length-1?0:e+1;this.focusWidget(i)}else if(t=="UP"){const e=this.getFocusedWidgetIndex(),i=e-this.columns<0?this.widgets.length-1:e-this.columns;this.focusWidget(i)}else if(t=="DOWN"){const e=this.getFocusedWidgetIndex(),i=e+this.columns>this.widgets.length-1?0:e+this.columns;this.focusWidget(i)}}handleWidgetClicked(t){!this.isFocused()||this.selectWidget(this.widgets.indexOf(t),!0)}handleWidgetHover(t){!this.isFocused()||this.focusWidget(this.widgets.indexOf(t),!1,!0)}}class ur extends H{constructor(){super({className:"UIMenuTextItem"})}setText(t){this.node.textContent=t}}class it extends is{constructor(t={}){super(Object.assign(t,{className:t.className??"UIMenuText"}))}add(t,e){const i=new ur;i.setId(t),i.setText(e),this.addWidget(i)}set(t,e){const i=this.widgets.find(s=>s.getId()==t);if(!i)throw new Error("UIMenuText::set(): item not found !");i.setText(e)}remove(t){const e=this.widgets.findIndex(i=>i.getId()==t);if(e==-1)throw new Error("UIMenuText::remove(): item not found !");this.removeWidget(e)}getSelectedId(){return this.getSelectedWidgetId()}}class dr{textures;constructor(){this.textures=new Map}async loadTexture(t){if(this.textures.has(t))return this.textures.get(t);const i=await(await fetch(t)).blob(),s=await createImageBitmap(i),r=x.createTextureFromBitmap(s);return this.textures.set(t,r),r}async loadTexture8bit(t){if(this.textures.has(t))return this.textures.get(t);const i=await(await fetch(t)).blob(),s=await createImageBitmap(i),r=x.createTextureFromBitmap(s,!0);return this.textures.set(t,r),r}async loadCubemapTexture(t,e){if(this.textures.has(t))return this.textures.get(t);const i=["right","left","top","bottom","front","back"],s=[];for(const n of i){const h=await(await fetch(t+n+"."+e)).blob(),c=await createImageBitmap(h);s.push(c)}const r=x.createCubeMapFromBitmap(s);return this.textures.set(t,r),r}deleteTexture(t){if(!this.textures.has(t))throw new Error("Gfx3TextureManager::deleteTexture(): The texture file doesn't exist, cannot delete !");this.textures.get(t).gpuTexture.destroy(),this.textures.delete(t)}getTexture(t){if(!this.textures.has(t))throw new Error("Gfx2TextureManager::getTexture(): The texture file doesn't exist, cannot get !");return this.textures.get(t)}hasTexture(t){return this.textures.has(t)}releaseTextures(){for(const t of this.textures.keys())this.textures.get(t).gpuTexture.destroy(),this.textures.delete(t)}}const b=new dr;class It{position;rotation;scale;cacheMatrix;cacheMatrixChanged;constructor(){this.position=[0,0,0],this.rotation=[0,0,0],this.scale=[1,1,1],this.cacheMatrix=l.MAT4_CREATE(),this.cacheMatrixChanged=!0}getPosition(){return this.position}getPositionX(){return this.position[0]}getPositionY(){return this.position[1]}getPositionZ(){return this.position[2]}setPosition(t,e,i){this.position[0]=t,this.position[1]=e,this.position[2]=i,this.cacheMatrixChanged=!0}translate(t,e,i){this.position[0]+=t,this.position[1]+=e,this.position[2]+=i,this.cacheMatrixChanged=!0}getRotation(){return this.rotation}getRotationX(){return this.rotation[0]}getRotationY(){return this.rotation[1]}getRotationZ(){return this.rotation[2]}setRotationQuaternion(t){this.rotation=l.EULER_FROM_QUATERNION(t)}getRotationQuaternion(){return l.QUATERNION_FROM_EULER(this.rotation,"YXZ")}setRotation(t,e,i){this.rotation[0]=t,this.rotation[1]=e,this.rotation[2]=i,this.cacheMatrixChanged=!0}rotate(t,e,i){this.rotation[0]+=t,this.rotation[1]+=e,this.rotation[2]+=i,this.cacheMatrixChanged=!0}getScale(){return this.scale}getScaleX(){return this.scale[0]}getScaleY(){return this.scale[1]}getScaleZ(){return this.scale[2]}setScale(t,e,i){this.scale[0]=t,this.scale[1]=e,this.scale[2]=i,this.cacheMatrixChanged=!0}zoom(t,e,i){this.scale[0]+=t,this.scale[1]+=e,this.scale[2]+=i,this.cacheMatrixChanged=!0}getTransformMatrix(){return this.cacheMatrixChanged?(l.MAT4_IDENTITY(this.cacheMatrix),l.MAT4_TRANSFORM(this.position,this.rotation,this.scale,this.cacheMatrix),this.cacheMatrixChanged=!1,this.cacheMatrix):this.cacheMatrix}getLocalAxies(){const t=this.getTransformMatrix();return[[t[0],t[1],t[2]],[t[4],t[5],t[6]],[t[8],t[9],t[10]]]}}class ee extends It{view;constructor(t){super(),this.view=x.getView(t)}setPosition(t,e,i){super.setPosition(t,e,i),this.view.setCameraMatrix(this.getTransformMatrix())}translate(t,e,i){super.translate(t,e,i),this.view.setCameraMatrix(this.getTransformMatrix())}setRotation(t,e,i){super.setRotation(t,e,i),this.view.setCameraMatrix(this.getTransformMatrix())}rotate(t,e,i){super.rotate(t,e,i),this.view.setCameraMatrix(this.getTransformMatrix())}setScale(t,e,i){super.setScale(t,e,i),this.view.setCameraMatrix(this.getTransformMatrix())}zoom(t,e,i){super.zoom(t,e,i),this.view.setCameraMatrix(this.getTransformMatrix())}changeView(t){this.view=x.getView(t)}lookAt(t,e,i){const s=this.view.getCameraMatrix();l.MAT4_LOOKAT(this.position,l.VEC3_CREATE(t,e,i),l.VEC3_CREATE(0,1,0),s),l.MAT4_MULTIPLY(s,l.MAT4_SCALE(this.scale[0],this.scale[1],this.scale[2]),s),this.view.setCameraMatrix(s)}getCameraMatrix(){return this.view.getCameraMatrix()}getLocalAxies(){const t=this.view.getCameraMatrix();return[l.VEC3_CREATE(t[0],t[1],t[2]),l.VEC3_CREATE(t[4],t[5],t[6]),l.VEC3_CREATE(t[8],t[9],t[10])]}}class z{min;max;constructor(t=[0,0,0],e=[0,0,0]){this.min=t,this.max=e}static createFromCoord(t,e,i,s,r,n){const o=new z;return o.min[0]=t,o.min[1]=e,o.min[2]=i,o.max[0]=t+s,o.max[1]=e+r,o.max[2]=i+n,o}static createFromCenter(t,e,i,s,r,n){const o=new z;return o.min[0]=t-s*.5,o.min[1]=e-r*.5,o.min[2]=i-n*.5,o.max[0]=t+s*.5,o.max[1]=e+r*.5,o.max[2]=i+n*.5,o}static merge(t){const e=[t[0].min[0],t[0].min[1],t[0].min[2]],i=[t[0].max[0],t[0].max[1],t[0].max[2]];for(const s of t)for(let r=0;r<3;r++)e[r]=Math.min(s.min[r],e[r]),i[r]=Math.max(s.max[r],i[r]);return new z(e,i)}fromVertices(t,e){const i=[t[0],t[1],t[2]],s=[t[0],t[1],t[2]];for(let r=0;r<t.length;r+=e)for(let n=0;n<3;n++){const o=t[r+n];i[n]=Math.min(o,i[n]),s[n]=Math.max(o,s[n])}this.min=i,this.max=s}merge(t){const e=[this.min[0],this.min[1],this.min[2]],i=[this.max[0],this.max[1],this.max[2]];for(let s=0;s<3;s++)e[s]=Math.min(t.min[s],e[s]),i[s]=Math.max(t.max[s],i[s]);return new z(e,i)}getCenter(){const t=this.max[0]-this.min[0],e=this.max[1]-this.min[1],i=this.max[2]-this.min[2],s=this.min[0]+t*.5,r=this.min[1]+e*.5,n=this.min[2]+i*.5;return[s,r,n]}getSize(){const t=this.max[0]-this.min[0],e=this.max[1]-this.min[1],i=this.max[2]-this.min[2];return[t,e,i]}getRadius(){return l.VEC3_DISTANCE(this.min,this.max)*.5}getPerimeter(){const t=this.max[0]-this.min[0],e=this.max[2]-this.min[2];return t+t+e+e}getVolume(){const t=this.max[0]-this.min[0],e=this.max[1]-this.min[1],i=this.max[2]-this.min[2];return t*e*i}transform(t){const e=[];e.push([this.min[0],this.min[1],this.min[2]]),e.push([this.max[0],this.min[1],this.min[2]]),e.push([this.max[0],this.max[1],this.min[2]]),e.push([this.min[0],this.max[1],this.min[2]]),e.push([this.min[0],this.max[1],this.max[2]]),e.push([this.max[0],this.max[1],this.max[2]]),e.push([this.max[0],this.min[1],this.max[2]]),e.push([this.min[0],this.min[1],this.max[2]]);const i=e.map(n=>l.MAT4_MULTIPLY_BY_VEC4(t,[n[0],n[1],n[2],1])),s=[i[0][0],i[0][1],i[0][2]],r=[i[0][0],i[0][1],i[0][2]];for(let n=0;n<i.length;n++)for(let o=0;o<3;o++){const h=i[n][o];s[o]=Math.min(h,s[o]),r[o]=Math.max(h,r[o])}return new z(s,r)}isPointInside(t,e,i){return l.COLLIDE_POINT_TO_BOX([t,e,i],this.min,this.max)}intersectBoundingBox(t){return l.COLLIDE_BOX_TO_BOX(this.min,this.max,t.min,t.max)}reset(){this.min=[0,0,0],this.max=[0,0,0]}setMin(t){this.min=t}setMax(t){this.max=t}}class Me extends It{vertexSubBuffer;vertices;vertexCount;vertexStride;boundingBox;constructor(t){super(),this.vertexSubBuffer=x.createVertexBuffer(0),this.vertices=[],this.vertexCount=0,this.vertexStride=t,this.boundingBox=new z}update(t){}delete(){x.destroyVertexBuffer(this.vertexSubBuffer)}beginVertices(t){x.destroyVertexBuffer(this.vertexSubBuffer),this.vertexSubBuffer=x.createVertexBuffer(t*this.vertexStride*4),this.vertices=[],this.vertexCount=t,this.boundingBox.reset()}defineVertex(...t){this.vertices.push(...t)}setVertices(t){this.vertices=t}endVertices(){x.writeVertexBuffer(this.vertexSubBuffer,this.vertices),this.boundingBox.fromVertices(this.vertices,this.vertexStride)}getVertexSubBufferOffset(){return this.vertexSubBuffer.offset}getVertexSubBufferSize(){return this.vertexSubBuffer.vertices.byteLength}getVertices(){return this.vertices}getVertexCount(){return this.vertexCount}getBoundingBox(){return this.boundingBox}getWorldBoundingBox(){return this.boundingBox.transform(this.getTransformMatrix())}}class Q{animations;currentAnimation;currentAnimationTextureIndex;looped;frameProgress;params;colors;texture;textureScrollAngle;textureScrollRate;textureScroll;displacementMap;displacementMapScrollAngle;displacementMapScrollRate;displacementMapScroll;specularityMap;normalMap;envMap;dataBuffer;dataChanged;texturesBuffer;texturesChanged;constructor(t){this.animations=t.animations??[],this.currentAnimation=null,this.currentAnimationTextureIndex=0,this.looped=!1,this.frameProgress=0,this.params=new Float32Array(9),this.params[0]=t.opacity??1,this.params[1]=t.normalIntensity??1,this.params[2]=t.lightning?1:0,this.params[3]=t.texture?1:0,this.params[4]=t.displacementMap?1:0,this.params[5]=t.displacementMapFactor??0,this.params[6]=t.specularityMap?1:0,this.params[7]=t.normalMap?1:0,this.params[8]=t.envMap?1:0,this.colors=new Float32Array(16),this.colors[0]=t.emissive?t.emissive[0]:0,this.colors[1]=t.emissive?t.emissive[1]:0,this.colors[2]=t.emissive?t.emissive[2]:0,this.colors[3]=0,this.colors[4]=t.ambiant?t.ambiant[0]:.5,this.colors[5]=t.ambiant?t.ambiant[1]:.5,this.colors[6]=t.ambiant?t.ambiant[2]:.5,this.colors[7]=0,this.colors[8]=t.diffuse?t.diffuse[0]:1,this.colors[9]=t.diffuse?t.diffuse[1]:1,this.colors[10]=t.diffuse?t.diffuse[2]:1,this.colors[11]=0,this.colors[12]=t.specular?t.specular[0]:0,this.colors[13]=t.specular?t.specular[1]:0,this.colors[14]=t.specular?t.specular[2]:0,this.colors[15]=t.specular?t.specular[3]:0,this.texture=t.texture??x.createTextureFromBitmap(),this.textureScrollAngle=t.textureScrollAngle??0,this.textureScrollRate=t.textureScrollRate??0,this.textureScroll=new Float32Array(2),this.displacementMap=t.displacementMap??x.createTextureFromBitmap(),this.displacementMapScrollAngle=t.displacementMapScrollAngle??0,this.displacementMapScrollRate=t.displacementMapScrollRate??0,this.displacementMapScroll=new Float32Array(2),this.specularityMap=t.specularityMap??x.createTextureFromBitmap(),this.normalMap=t.normalMap??x.createTextureFromBitmap(),this.envMap=t.envMap??x.createCubeMapFromBitmap(),this.dataBuffer=x.createUniformGroupDataset("MESH_PIPELINE",2),this.dataBuffer.addInput(0,l.F16_SIZE,"MAT_COLORS"),this.dataBuffer.addInput(1,l.F09_SIZE,"MAT_PARAMS"),this.dataBuffer.addInput(2,l.F02_SIZE,"MAT_TEXTURE_SCROLL"),this.dataBuffer.addInput(3,l.F02_SIZE,"MAT_DISPLACEMENT_MAP_SCROLL"),this.dataBuffer.allocate(),this.dataChanged=!0,this.texturesBuffer=x.createUniformGroupBitmaps("MESH_PIPELINE",3),this.texturesBuffer.addSamplerInput(0,this.texture.gpuSampler),this.texturesBuffer.addTextureInput(1,this.texture.gpuTexture),this.texturesBuffer.addSamplerInput(2,this.displacementMap.gpuSampler),this.texturesBuffer.addTextureInput(3,this.displacementMap.gpuTexture),this.texturesBuffer.addSamplerInput(4,this.specularityMap.gpuSampler),this.texturesBuffer.addTextureInput(5,this.specularityMap.gpuTexture),this.texturesBuffer.addSamplerInput(6,this.normalMap.gpuSampler),this.texturesBuffer.addTextureInput(7,this.normalMap.gpuTexture),this.texturesBuffer.addSamplerInput(8,this.envMap.gpuSampler),this.texturesBuffer.addTextureInput(9,this.envMap.gpuTexture,{dimension:"cube"}),this.texturesBuffer.allocate(),this.texturesChanged=!1}static async createFromFile(t){const i=await(await fetch(t)).json();if(!i.hasOwnProperty("Ident")||i.Ident!="MAT")throw new Error("Gfx3Material::loadFromFile(): File not valid !");const s=new Array;for(const r of i.Animations){const n={name:r.Name,textures:[],frameDuration:parseInt(r.FrameDuration)};for(const o of r.Textures)n.textures.push(await b.loadTexture(o));s.push(n)}return new Q({animations:s,opacity:i.Opacity,normalIntensity:i.NormalIntensity,lightning:i.Lightning,emissive:i.Emissive,ambiant:i.Ambiant,diffuse:i.Diffuse,specular:i.Specular,texture:i.Texture??await b.loadTexture(i.Texture),textureScrollAngle:i.TextureScrollAngle,textureScrollRate:i.TextureScrollRate,displacementMap:i.DisplacementMap??await b.loadTexture(i.DisplacementMap),displacementMapScrollAngle:i.DisplacementMapScrollAngle,displacementMapScrollRate:i.DisplacementMapScrollRate,displacementMapFactor:i.DisplacementMapFactor,specularityMap:i.SpecularityMap??await b.loadTexture(i.SpecularityMap),normalMap:i.NormalMap??await b.loadTexture(i.NormalMap),envMap:i.EnvMap??await b.loadTexture(i.EnvMap)})}delete(){this.dataBuffer.destroy()}update(t){this.textureScrollRate!=0&&(this.textureScroll[0]+=Math.cos(this.textureScrollAngle)*this.textureScrollRate*(t/1e3),this.textureScroll[1]+=Math.sin(this.textureScrollAngle)*this.textureScrollRate*(t/1e3),this.dataChanged=!0),this.displacementMapScrollRate!=0&&(this.displacementMapScroll[0]+=Math.cos(this.displacementMapScrollAngle)*this.displacementMapScrollRate*(t/1e3),this.displacementMapScroll[1]+=Math.sin(this.displacementMapScrollAngle)*this.displacementMapScrollRate*(t/1e3),this.dataChanged=!0),this.currentAnimation&&(this.frameProgress>=this.currentAnimation.frameDuration?(this.currentAnimationTextureIndex==this.currentAnimation.textures.length-1?(u.emit(this,"E_FINISHED"),this.currentAnimationTextureIndex=this.looped?0:this.currentAnimation.textures.length-1,this.frameProgress=0):(this.currentAnimationTextureIndex=this.currentAnimationTextureIndex+1,this.frameProgress=0),this.texture=this.currentAnimation.textures[this.currentAnimationTextureIndex],this.params[3]=1,this.texturesChanged=!0,this.dataChanged=!0):this.frameProgress+=t)}play(t,e=!1,i=!1){if(i&&this.currentAnimation&&t==this.currentAnimation.name)return;const s=this.animations.find(r=>r.name==t);if(!s)throw new Error("Gfx3Material::play: animation not found.");this.currentAnimation=s,this.currentAnimationTextureIndex=0,this.looped=e,this.frameProgress=0}setOpacity(t){this.params[0]=t,this.dataChanged=!0}setNormalIntensity(t){this.params[1]=t,this.dataChanged=!0}setLightning(t){this.params[2]=t?1:0,this.dataChanged=!0}setEmissive(t,e,i){this.colors[0]=t,this.colors[1]=e,this.colors[2]=i,this.dataChanged=!0}setAmbiant(t,e,i){this.colors[4]=t,this.colors[5]=e,this.colors[6]=i,this.dataChanged=!0}setDiffuse(t,e,i){this.colors[8]=t,this.colors[9]=e,this.colors[10]=i,this.dataChanged=!0}setSpecular(t,e,i){this.colors[12]=t,this.colors[13]=e,this.colors[14]=i,this.dataChanged=!0}setSpecularity(t){this.colors[15]=t,this.dataChanged=!0}setTexture(t,e=0,i=0){this.texture=t,this.textureScrollAngle=e,this.textureScrollRate=i,this.params[3]=1,this.texturesChanged=!0,this.dataChanged=!0}setDisplacementMap(t,e=0,i=0,s=0){this.displacementMap=t,this.displacementMapScrollAngle=e,this.displacementMapScrollRate=i,this.params[4]=1,this.params[5]=s,this.texturesChanged=!0,this.dataChanged=!0}setSpecularityMap(t){this.specularityMap=t,this.params[6]=1,this.texturesChanged=!0,this.dataChanged=!0}setNormalMap(t){this.normalMap=t,this.params[7]=1,this.texturesChanged=!0,this.dataChanged=!0}setEnvMap(t){this.envMap=t,this.params[8]=1,this.texturesChanged=!0,this.dataChanged=!0}getDataBuffer(){return this.dataChanged&&(this.dataBuffer.beginWrite(),this.dataBuffer.write(0,this.colors),this.dataBuffer.write(1,this.params),this.dataBuffer.write(2,this.textureScroll),this.dataBuffer.write(3,this.displacementMapScroll),this.dataBuffer.endWrite(),this.dataChanged=!1),this.dataBuffer}getTexturesBuffer(){return this.texturesChanged&&(this.texturesBuffer.setSamplerInput(0,this.texture.gpuSampler),this.texturesBuffer.setTextureInput(1,this.texture.gpuTexture),this.texturesBuffer.setSamplerInput(2,this.displacementMap.gpuSampler),this.texturesBuffer.setTextureInput(3,this.displacementMap.gpuTexture),this.texturesBuffer.setSamplerInput(4,this.specularityMap.gpuSampler),this.texturesBuffer.setTextureInput(5,this.specularityMap.gpuTexture),this.texturesBuffer.setSamplerInput(6,this.normalMap.gpuSampler),this.texturesBuffer.setTextureInput(7,this.normalMap.gpuTexture),this.texturesBuffer.setSamplerInput(8,this.envMap.gpuSampler),this.texturesBuffer.setTextureInput(9,this.envMap.gpuTexture,{dimension:"cube"}),this.texturesBuffer.allocate(),this.texturesChanged=!1),this.texturesBuffer}getTexture(){return this.texture}getDisplacementMap(){return this.displacementMap}getSpecularityMap(){return this.specularityMap}getNormalMap(){return this.normalMap}getEnvMap(){return this.envMap}}class Et extends Me{material;constructor(){super(st),this.material=new Q({})}static build(t,e,i,s,r){const n=new Array,o=new Array,h=new Array,c=new Array,d=new Array,f=new Array,g=new Array,E=new Array,I=new Array,S=s?3:2;if(!r){const y=[];for(let A=0;A<t;A++)s?y.push(A,A,A):y.push(A,A);r=[{id:0,indices:y,vertexCount:t,smooth:!1}]}for(let y=0,A=0;y<r.length;y++){const T=r[y];E[T.id]=[],I[T.id]=[];for(let w=0;w<T.vertexCount;w+=3,A+=3){const M=T.indices[(w+0)*S+0],v=T.indices[(w+1)*S+0],P=T.indices[(w+2)*S+0],L=T.indices[(w+0)*S+1],B=T.indices[(w+1)*S+1],q=T.indices[(w+2)*S+1];o[A+0]=[e[M*3+0],e[M*3+1],e[M*3+2]],o[A+1]=[e[v*3+0],e[v*3+1],e[v*3+2]],o[A+2]=[e[P*3+0],e[P*3+1],e[P*3+2]],h[A+0]=[i[L*2+0],i[L*2+1]],h[A+1]=[i[B*2+0],i[B*2+1]],h[A+2]=[i[q*2+0],i[q*2+1]];const Y=l.VEC3_SUBSTRACT(o[A+1],o[A+0]),X=l.VEC3_SUBSTRACT(o[A+2],o[A+0]),W=l.VEC2_SUBSTRACT(h[A+1],h[A+0]),Z=l.VEC2_SUBSTRACT(h[A+2],h[A+0]);if(s){const K=T.indices[(w+0)*S+2],nt=T.indices[(w+1)*S+2],tt=T.indices[(w+2)*S+2];c[A+0]=[s[K*3+0],s[K*3+1],s[K*3+2]],c[A+1]=[s[nt*3+0],s[nt*3+1],s[nt*3+2]],c[A+2]=[s[tt*3+0],s[tt*3+1],s[tt*3+2]]}else{const K=l.VEC3_NORMALIZE(l.VEC3_CROSS(Y,X));c[A+0]=K,c[A+1]=K,c[A+2]=K}T.smooth&&(E[T.id][M]=E[T.id][M]?l.VEC3_ADD(E[T.id][M],c[A+0]):c[A+0],E[T.id][v]=E[T.id][v]?l.VEC3_ADD(E[T.id][v],c[A+1]):c[A+1],E[T.id][P]=E[T.id][P]?l.VEC3_ADD(E[T.id][P],c[A+2]):c[A+2]);const N=[0,0,0],O=pr(Y,X,W,Z,N);f[A+0]=O,f[A+1]=O,f[A+2]=O,d[A+0]=N,d[A+1]=N,d[A+2]=N,T.smooth&&(I[T.id][M]=I[T.id][M]?l.VEC3_ADD(I[T.id][M],N):N,I[T.id][v]=I[T.id][v]?l.VEC3_ADD(I[T.id][v],N):N,I[T.id][P]=I[T.id][P]?l.VEC3_ADD(I[T.id][P],N):N)}}for(let y=0,A=0;y<r.length;y++){const T=r[y];for(let w=0;w<T.vertexCount;w++,A++){const M=T.indices[w*S+0];T.smooth&&(c[A]=l.VEC3_NORMALIZE(E[T.id][M]),d[A]=l.VEC3_NORMALIZE(I[T.id][M])),g[A]=l.VEC3_SCALE(l.VEC3_CROSS(c[A],d[A]),f[A]),n.push(o[A][0],o[A][1],o[A][2],h[A][0],h[A][1],c[A][0],c[A][1],c[A][2],d[A][0],d[A][1],d[A][2],g[A][0],g[A][1],g[A][2])}}return n}delete(t=!1){t||this.material.delete(),super.delete()}update(t){this.material.update(t)}draw(){ot.drawMesh(this)}setMaterial(t,e=!1){e||this.material.delete(),this.material=t}getMaterial(){return this.material}clone(t=l.MAT4_IDENTITY()){const e=new Et;e.beginVertices(this.vertexCount);for(let i=0;i<this.vertices.length;i+=this.vertexStride){const s=l.MAT4_MULTIPLY_BY_VEC4(t,l.VEC4_CREATE(this.vertices[i+0],this.vertices[i+1],this.vertices[i+2],1));e.defineVertex(s[0],s[1],s[2],this.vertices[i+3],this.vertices[i+4],this.vertices[i+5],this.vertices[i+6],this.vertices[i+7],this.vertices[i+8],this.vertices[i+9],this.vertices[i+10],this.vertices[i+11],this.vertices[i+12],this.vertices[i+13])}return e.endVertices(),e.setMaterial(this.material),e}get mat(){return this.material}}function pr(a,t,e,i,s){const r=e[0]*i[1]-e[1]*i[0];if(Math.abs(r)>l.EPSILON){const n=1/r,o=r>0?1:-1,h=(a[0]*i[1]-t[0]*e[1])*n,c=(a[1]*i[1]-t[1]*e[1])*n,d=(a[2]*i[1]-t[2]*e[1])*n,f=l.VEC3_NORMALIZE([h,c,d]);return s[0]=f[0],s[1]=f[1],s[2]=f[2],o}return-1}class J extends Et{constructor(){super()}async loadFromFile(t){const i=await(await fetch(t)).json();if(!i.hasOwnProperty("Ident")||i.Ident!="JSM")throw new Error("Gfx3MeshJSM::loadFromFile(): File not valid !");const s=Et.build(i.NumVertices,i.Vertices,i.TextureCoords,i.Normals);this.beginVertices(i.NumVertices),this.setVertices(s),this.endVertices()}}class hi{name;coords;texcoords;normals;groups;materialName;vertexCount;constructor(){this.name="",this.coords=new Array,this.texcoords=new Array,this.normals=new Array,this.groups=new Array,this.materialName="",this.vertexCount=0}}class fr extends Et{materials;meshes;constructor(){super(),this.materials=new Map,this.meshes=new Map}delete(){for(const t of this.meshes.values())t.delete(!0);for(const t of this.materials.values())t.delete()}update(t){for(const e of this.meshes.values())e.setPosition(this.position[0],this.position[1],this.position[2]),e.setRotation(this.rotation[0],this.rotation[1],this.rotation[2]),e.setScale(this.scale[0],this.scale[1],this.scale[2]),e.update(t)}draw(){for(const t of this.meshes.values())t.draw()}getBoundingBox(){const t=new Array;for(const e of this.meshes.values())t.push(e.getBoundingBox());return z.merge(t)}async loadMaterials(t){const s=(await(await fetch(t)).text()).split(`
`);this.materials.clear();let r=null,n=null;t=t.split("/").slice(0,-1).join("/")+"/";for(const o of s)if(o.startsWith("newmtl ")&&(n=o.substring(7),r=new Q({lightning:!0}),this.materials.set(n,r)),!!r){if(o.startsWith("Kd ")){const h=l.VEC3_PARSE(o.substring(3));r.setDiffuse(h[0],h[1],h[2])}if(o.startsWith("Ks ")){const h=l.VEC3_PARSE(o.substring(3));r.setSpecular(h[0],h[1],h[2])}if(o.startsWith("Ns")){const h=parseFloat(o.substring(3));r.setSpecularity(h)}if(o.startsWith("Ke ")){const h=l.VEC3_PARSE(o.substring(3));r.setEmissive(h[0],h[1],h[2])}if(o.startsWith("map_Kd ")){const h=o.substring(7);r.setTexture(await b.loadTexture(t+h))}if(o.startsWith("map_Ns ")){const h=o.substring(7);r.setSpecularityMap(await b.loadTexture8bit(t+h))}if(o.startsWith("map_Bump ")){const h=o.split(" ");let c=0;for(;h[c][0]=="-";)h[c].substring(1)=="bm"&&r.setNormalIntensity(parseFloat(h[c+1])),c++;const d=h.join(" ");r.setNormalMap(await b.loadTexture(t+d))}}}async loadObjects(t){const s=(await(await fetch(t)).text()).split(`
`),r=new Array;let n=new hi,o={id:0,indices:[],vertexCount:0,smooth:!1};for(const h of s){if(h.startsWith("o ")){const c=new hi;c.name=h.substring(2),n=c,r.push(c)}if(h.startsWith("usemtl ")&&(n.materialName=h.substring(7)),h.startsWith("v ")){const c=l.VEC3_PARSE(h.substring(2));n.coords.push(c[0],c[1],c[2])}if(h.startsWith("vt ")){const c=l.VEC2_PARSE(h.substring(3));n.texcoords.push(c[0],c[1])}if(h.startsWith("vn ")){const c=l.VEC3_PARSE(h.substring(3));n.normals.push(c[0],c[1],c[2])}if(h.startsWith("s ")){const c=parseInt(h.substring(2)),d=n.groups.find(f=>f.id==c);if(d)o=d;else{const f={id:c,indices:[],vertexCount:0,smooth:c!=0};n.groups.push(f),o=f}}if(h.startsWith("f ")){const c=h.substring(2).split(" ");if(c.length>3)throw new Error("Gfx3MeshOBJ::loadObjects(): Not support quad faces !");for(let d=0;d<3;d++)c[d].split("/").forEach(g=>o.indices.push(parseInt(g)-1)),o.vertexCount++,n.vertexCount++}}for(const h of r){const c=new Et,d=this.materials.get(h.materialName);d&&c.setMaterial(d);const f=h.normals.length>0?h.normals:void 0,g=Et.build(h.vertexCount,h.coords,h.texcoords,f,h.groups);c.beginVertices(h.vertexCount),c.setVertices(g),c.endVertices(),this.meshes.set(h.name,c)}}async loadFromFile(t,e){await this.loadMaterials(e),await this.loadObjects(t)}}class mr extends Me{cubemap;cubemapBuffer;cubemapChanged;constructor(){super($i),this.cubemap=x.createCubeMapFromBitmap(),this.cubemapBuffer=x.createUniformGroupBitmaps("SKYBOX_PIPELINE",1),this.cubemapBuffer.addSamplerInput(0,this.cubemap.gpuSampler),this.cubemapBuffer.addTextureInput(1,this.cubemap.gpuTexture,{dimension:"cube"}),this.cubemapBuffer.allocate(),this.cubemapChanged=!1,this.beginVertices(6),this.defineVertex(-1,-1,-1,-1,-1,-1),this.defineVertex(1,-1,-1,-1,-1,1),this.defineVertex(-1,1,-1,1,-1,1),this.defineVertex(-1,1,-1,-1,-1,-1),this.defineVertex(1,-1,-1,1,-1,1),this.defineVertex(1,1,-1,1,-1,-1),this.endVertices()}draw(){Ji.draw(this)}setCubemap(t){this.cubemap=t,this.cubemapChanged=!0}getCubemap(){return this.cubemap}getCubemapBuffer(){return this.cubemapChanged&&(this.cubemapBuffer.addSamplerInput(0,this.cubemap.gpuSampler),this.cubemapBuffer.addTextureInput(1,this.cubemap.gpuTexture,{dimension:"cube"}),this.cubemapBuffer.allocate(),this.cubemapChanged=!1),this.cubemapBuffer}}const ae=.1;class gr extends k{constructor(){super(),this.camera=new ee(0),this.mesh=new J,this.skybox=new mr,this.isDragging=!1,this.dragStartPosition=[0,0],this.dragStartRotation=[0,0],this.handleKeyDownCb=this.handleKeyDown.bind(this),this.handleMouseDownCb=this.handleMouseDown.bind(this),this.handleMouseUpCb=this.handleMouseUp.bind(this),this.handleMouseMoveCb=this.handleMouseMove.bind(this)}async onEnter(){ot.enablePointLight(0,1,[10,30,0]),ot.setPointLightColor(0,[1,1,1]),this.camera.setPosition(0,0,10),this.mesh=await li(),this.skybox.setCubemap(await b.loadCubemapTexture("./samples/viewer/sky_","png")),document.addEventListener("keydown",this.handleKeyDownCb),document.addEventListener("mousedown",this.handleMouseDownCb),document.addEventListener("mouseup",this.handleMouseUpCb),document.addEventListener("mousemove",this.handleMouseMoveCb)}onExit(){document.removeEventListener("keydown",this.handleKeyDownCb),document.removeEventListener("mousedown",this.handleMouseDownCb),document.removeEventListener("mouseup",this.handleMouseUpCb),document.removeEventListener("mousemove",this.handleMouseMoveCb)}update(t){const e=this.camera.getLocalAxies();let i=l.VEC3_CREATE(0,0,0);R.isActiveAction("LEFT")&&(i=l.VEC3_ADD(i,l.VEC3_SCALE(e[0],-ae))),R.isActiveAction("RIGHT")&&(i=l.VEC3_ADD(i,l.VEC3_SCALE(e[0],+ae))),R.isActiveAction("UP")&&(i=l.VEC3_ADD(i,l.VEC3_SCALE(e[2],-ae))),R.isActiveAction("DOWN")&&(i=l.VEC3_ADD(i,l.VEC3_SCALE(e[2],+ae))),this.camera.translate(i[0],i[1],i[2]);const s=Date.now()/1e4;this.mesh.setRotation(Math.sin(s),Math.cos(s),0),this.mesh.update(t)}draw(){this.mesh.draw(),this.skybox.draw(),Mt.drawGrid(l.MAT4_ROTATE_X(Math.PI*.5),20,1)}async handleKeyDown(t){t.repeat||(t.key=="o"||t.key=="O"?this.mesh=await Er():t.key=="l"||t.key=="L"?this.mesh=await Cr():t.key=="c"||t.key=="C"?this.mesh=await li():(t.key=="d"||t.key=="D")&&(this.mesh=await Ir()))}handleMouseDown(t){this.isDragging=!0,this.dragStartPosition[0]=t.clientX,this.dragStartPosition[1]=t.clientY,this.dragStartRotation[0]=this.camera.getRotationX(),this.dragStartRotation[1]=this.camera.getRotationY()}handleMouseUp(){this.isDragging=!1}handleMouseMove(t){if(!this.isDragging)return;let e=this.dragStartRotation[0]+(t.clientY-this.dragStartPosition[1])*.001,i=this.dragStartRotation[1]+(t.clientX-this.dragStartPosition[0])*.001;this.camera.setRotation(e,i,0)}}async function Er(){const a=new fr;return await a.loadFromFile("./samples/viewer/wavefront.obj","./samples/viewer/wavefront.mtl"),a}async function Cr(){const a=new J;return await a.loadFromFile("./samples/viewer/lantern.jsm"),a.setMaterial(new Q({texture:await b.loadTexture("./samples/viewer/lantern.png"),normalMap:await b.loadTexture("./samples/viewer/lantern-normal.png"),lightning:!0})),a}async function li(){const a=new J;return await a.loadFromFile("./samples/viewer/cube.jsm"),a.setMaterial(new Q({texture:await b.loadTexture("./samples/viewer/cube.png"),lightning:!0})),a}async function Ir(){const a=new J;return await a.loadFromFile("./samples/viewer/duck.jsm"),a.setMaterial(new Q({texture:await b.loadTexture("./samples/viewer/duck.png"),lightning:!0})),a}class ft extends H{constructor(t=""){super({className:"UIText",template:'<span class="UIText-text js-text" style="'+t+'"></span>'})}setText(t){this.node.querySelector(".js-text").textContent=t}}class Ar extends k{constructor(){super(),this.uiTitle=new ft,this.uiMenu1=new it,this.uiMenu2=new it}async onEnter(){this.uiTitle.setText("Menu"),p.addWidget(this.uiTitle,"position:absolute; top:0; left:0; right:0; height:50px"),this.uiMenu1.add("1","Menu 1 Text 1"),this.uiMenu1.add("2","Menu 1 Text 2"),this.uiMenu1.add("3","Menu 1 Text 3"),p.addWidget(this.uiMenu1,"position:absolute; top:50px; left:0; bottom:0; width:40%"),this.uiMenu2.add("1","Menu 2 Text 1"),this.uiMenu2.add("2","Menu 2 Text 2"),this.uiMenu2.add("3","Menu 2 Test 3"),p.addWidget(this.uiMenu2,"position:absolute; top:50px; left:40%; bottom:0; width:60%"),u.subscribe(this.uiMenu1,"E_ITEM_SELECTED",this,this.handleMenu1ItemSelected),u.subscribe(this.uiMenu2,"E_CLOSED",this,this.handleMenu2Closed),u.subscribe(this.uiMenu2,"E_ITEM_SELECTED",this,this.handleMenu2ItemSelected),p.focus(this.uiMenu1)}onExit(){p.removeWidget(this.uiTitle),p.removeWidget(this.uiMenu1),p.removeWidget(this.uiMenu2)}handleMenu1ItemSelected(t){p.focus(this.uiMenu2)}handleMenu2Closed(){this.uiMenu1.unselectWidgets(),p.focus(this.uiMenu1)}handleMenu2ItemSelected(t){this.uiTitle.setText("You have selected menu item at index : "+t.index),this.uiMenu1.unselectWidgets(),this.uiMenu2.unselectWidgets(),p.focus(this.uiMenu1)}}const Tr=5,Sr=.8;class Ee extends It{sectors;neighborPool;walkers;debugVertices;debugVertexCount;constructor(){super(),this.sectors=[],this.neighborPool=[],this.walkers=[],this.debugVertices=[],this.debugVertexCount=0}async loadFromFile(t){const i=await(await fetch(t)).json();if(!i.hasOwnProperty("Ident")||i.Ident!="JWM")throw new Error("GfxJWM::loadFromFile(): File not valid !");this.sectors=[];for(const s of i.Sectors)this.sectors.push({v1:s[0],v2:s[1],v3:s[2]});this.neighborPool=[];for(const s of i.NeighborPool)this.neighborPool.push({s1:s[0],s2:s[1],s3:s[2]})}update(){this.debugVertices=[],this.debugVertexCount=0;for(const t of this.sectors)this.debugVertices.push(t.v1[0],t.v1[1],t.v1[2],1,1,1),this.debugVertices.push(t.v2[0],t.v2[1],t.v2[2],1,1,1),this.debugVertices.push(t.v1[0],t.v1[1],t.v1[2],1,1,1),this.debugVertices.push(t.v3[0],t.v3[1],t.v3[2],1,1,1),this.debugVertices.push(t.v2[0],t.v2[1],t.v2[2],1,1,1),this.debugVertices.push(t.v3[0],t.v3[1],t.v3[2],1,1,1),this.debugVertexCount+=6;for(const t of this.walkers)this.debugVertices.push(t.points[1].x,t.points[1].y,t.points[1].z,1,1,1),this.debugVertices.push(t.points[2].x,t.points[2].y,t.points[2].z,1,1,1),this.debugVertices.push(t.points[2].x,t.points[2].y,t.points[2].z,1,1,1),this.debugVertices.push(t.points[3].x,t.points[3].y,t.points[3].z,1,1,1),this.debugVertices.push(t.points[3].x,t.points[3].y,t.points[3].z,1,1,1),this.debugVertices.push(t.points[4].x,t.points[4].y,t.points[4].z,1,1,1),this.debugVertices.push(t.points[4].x,t.points[4].y,t.points[4].z,1,1,1),this.debugVertices.push(t.points[1].x,t.points[1].y,t.points[1].z,1,1,1),this.debugVertexCount+=8}draw(){Mt.drawVertices(this.debugVertices,this.debugVertexCount,this.getTransformMatrix())}addWalker(t,e,i,s){if(this.walkers.find(n=>n.id==t))throw new Error("Gfx3JWM::moveWalker: walker with id "+t+" already exist.");const r={id:t,points:[this.$utilsCreatePoint(e,i),this.$utilsCreatePoint(e+s,i+s),this.$utilsCreatePoint(e+s,i-s),this.$utilsCreatePoint(e-s,i-s),this.$utilsCreatePoint(e-s,i+s)]};return this.walkers.push(r),r}moveWalker(t,e,i){const s=this.walkers.find(E=>E.id==t);if(!s)throw new Error("Gfx3JWM::moveWalker: walker with id "+t+" cannot be found.");const r=s.points.slice(),n=[],o=[],h=[];o[0]=s.points[0].sectorIndex,o[1]=s.points[1].sectorIndex,o[2]=s.points[2].sectorIndex,o[3]=s.points[3].sectorIndex,o[4]=s.points[4].sectorIndex,h[0]=s.points[0].y,h[1]=s.points[1].y,h[2]=s.points[2].y,h[3]=s.points[3].y,h[4]=s.points[4].y;let c=0,d=!1,f=0;for(;f<r.length;){let E=!1;if(!n[f]){const I=this.$utilsMove(r[f].sectorIndex,r[f].x,r[f].z,e,i,Sr);if(I.mx==0&&I.mz==0){e=0,i=0,d=!1;break}(I.mx!=e||I.mz!=i)&&(c++,e=I.mx,i=I.mz,E=!0,n[f]=r[f]),d=!0,o[f]=I.sectorIndex,h[f]=I.elevation}if(c>=2){e=0,i=0,d=!1;break}f=E?0:f+1}const g=h[0]-s.points[0].y;return d&&(s.points[0].sectorIndex=o[0],s.points[1].sectorIndex=o[1],s.points[2].sectorIndex=o[2],s.points[3].sectorIndex=o[3],s.points[4].sectorIndex=o[4],s.points[0].x+=e,s.points[1].x+=e,s.points[2].x+=e,s.points[3].x+=e,s.points[4].x+=e,s.points[0].y=h[0],s.points[1].y=h[1],s.points[2].y=h[2],s.points[3].y=h[3],s.points[4].y=h[4],s.points[0].z+=i,s.points[1].z+=i,s.points[2].z+=i,s.points[3].z+=i,s.points[4].z+=i),[e,g,i]}clearWalkers(){this.walkers=[]}$utilsFindLocationInfo(t,e){for(let i=0;i<this.sectors.length;i++){const s=this.sectors[i].v1,r=this.sectors[i].v2,n=this.sectors[i].v3;if(l.TRI2_POINT_INSIDE([t,e],[s[0],s[2]],[r[0],r[2]],[n[0],n[2]])==1)return{sectorIndex:i,elev:l.TRI3_POINT_ELEVATION([t,e],s,r,n)}}return{sectorIndex:-1,elev:1/0}}$utilsMove(t,e,i,s,r,n,o=0){const h=this.sectors[t].v1,c=this.sectors[t].v2,d=this.sectors[t].v3;if(o==Tr)return{sectorIndex:t,mx:0,mz:0,elevation:1/0};if(s>-l.BIG_EPSILON&&s<+l.BIG_EPSILON&&r>-l.BIG_EPSILON&&r<+l.BIG_EPSILON)return{sectorIndex:t,mx:0,mz:0,elevation:1/0};const f=s+s*n,g=r+r*n,E=l.TRI3_POINT_ELEVATION([e+f,i+g],h,c,d);if(E!=1/0)return{sectorIndex:t,mx:s,mz:r,elevation:E};const I=l.TRI2_POINT_INSIDE([e+f,i+g],[h[0],h[2]],[c[0],c[2]],[d[0],d[2]]),S=[c[0]-h[0],c[2]-h[2]],y=[d[0]-c[0],d[2]-c[2]],A=[h[0]-d[0],h[2]-d[2]];if(this.neighborPool[t].s1==-1&&I==-1){const[T,w]=l.VEC2_PROJECTION_COS([s,r],S);return this.$utilsMove(t,e,i,T,w,n,o+1)}else if(this.neighborPool[t].s2==-1&&I==-2){const[T,w]=l.VEC2_PROJECTION_COS([s,r],y);return this.$utilsMove(t,e,i,T,w,n,o+1)}else if(this.neighborPool[t].s3==-1&&I==-3){const[T,w]=l.VEC2_PROJECTION_COS([s,r],A);return this.$utilsMove(t,e,i,T,w,n,o+1)}else if(this.neighborPool[t].s1!=-1&&I==-1){const T=this.neighborPool[t].s1;return this.$utilsMove(T,e,i,s,r,n,o+1)}else if(this.neighborPool[t].s2!=-1&&I==-2){const T=this.neighborPool[t].s2;return this.$utilsMove(T,e,i,s,r,n,o+1)}else if(this.neighborPool[t].s3!=-1&&I==-3){const T=this.neighborPool[t].s3;return this.$utilsMove(T,e,i,s,r,n,o+1)}else return{sectorIndex:t,mx:s,mz:r,elevation:E}}$utilsCreatePoint(t,e){const i=this.$utilsFindLocationInfo(t,e);return{sectorIndex:i.sectorIndex,x:t,y:i.elev,z:e}}}class Ke{blocks;commandRegister;enabled;currentBlockId;currentCallIndex;onBeforeBlockExec;onAfterBlockExec;onBeforeCommandExec;onAfterCommandExec;constructor(){this.blocks=[],this.commandRegister=new Map,this.enabled=!0,this.currentBlockId="",this.currentCallIndex=0,this.onBeforeBlockExec=()=>{},this.onAfterBlockExec=()=>{},this.onBeforeCommandExec=()=>{},this.onAfterCommandExec=()=>{}}update(t){if(!this.enabled)return;const e=this.blocks.find(r=>r.id==this.currentBlockId);if(!e)return;if(this.currentCallIndex==e.calls.length){this.onAfterBlockExec(e),this.currentBlockId="",this.currentCallIndex=0;return}this.currentCallIndex==0&&this.onBeforeBlockExec(e);const i=e.calls[this.currentCallIndex],s=this.runCommand(i.commandName,i.commandArgs);if(typeof s=="string"){this.currentBlockId=s,this.currentCallIndex=0;return}this.currentCallIndex<e.calls.length&&this.currentCallIndex++}async loadFromFile(t){const i=await(await fetch(t)).json();this.blocks=[];for(const s of i){const r={id:s.Id,description:s.Description,calls:[]};for(const n of s.Calls)r.calls.push({commandName:n.Name,commandArgs:n.Args});this.blocks.push(r)}}registerCommand(t,e){if(this.commandRegister.has(t))throw new Error("ScriptMachine::registerCommand: key already exist !");this.commandRegister.set(t,e)}runCommand(t,e=[]){const i=this.commandRegister.get(t);if(!i)throw new Error("ScriptMachine::runCommand: try to call an not existant command "+t+" !");this.onBeforeCommandExec(i);const s=i.call(this,...e);return this.onAfterCommandExec(i),s}clearCommandRegister(){this.commandRegister.clear()}isEnabled(){return this.enabled}setEnabled(t){this.enabled=t}jump(t){this.currentBlockId=t,this.currentCallIndex=0}}class Ge extends H{text;stepDuration;currentTextOffset;timeElapsed;finished;constructor(){super({className:"UIDialog",template:`
      <div class="UIDialog-author js-author"></div>
      <div class="UIDialog-textbox">
        <div class="UIDialog-textbox-text js-text"></div>
        <div class="UIDialog-textbox-next js-next"></div>
      </div>`}),this.text="",this.stepDuration=0,this.currentTextOffset=0,this.timeElapsed=0,this.finished=!1,this.node.addEventListener("click",()=>this.handleClick())}update(t){if(!this.finished){if(this.currentTextOffset==this.text.length){this.finished=!0,this.node.querySelector(".js-next").style.display="block",u.emit(this,"E_PRINT_FINISHED");return}this.timeElapsed>=this.stepDuration?(this.currentTextOffset<this.text.length&&(this.node.querySelector(".js-text").textContent=this.text.substring(0,this.currentTextOffset+1),this.currentTextOffset++),this.timeElapsed=0):this.timeElapsed+=t}}setAuthor(t){this.node.querySelector(".UIDialog-author").textContent=t}setText(t){this.text=t,this.currentTextOffset=0,this.finished=!1,this.node.querySelector(".js-next").style.display="none"}setStepDuration(t){this.stepDuration=t}onAction(t){t=="OK"&&this.finished&&u.emit(this,"E_OK")}handleClick(){this.isFocused()&&this.finished&&u.emit(this,"E_OK")}}class yr extends It{constructor(){super(),this.name="",this.direction=[0,0],this.radius=.2}async loadFromData(t){this.name=t.Name,this.position[0]=t.PositionX,this.position[1]=t.PositionY,this.position[2]=t.PositionZ,this.direction[0]=t.DirectionX,this.direction[1]=t.DirectionZ}draw(){Mt.drawSphere(this.getTransformMatrix(),this.radius,2)}getName(){return this.name}getDirection(){return this.direction}getRadius(){return this.radius}}class qe extends Et{numVertices;frames;animations;textureCoords;looped;currentAnimation;currentFrameIndex;frameProgress;constructor(){super(),this.numVertices=0,this.frames=[],this.animations=[],this.textureCoords=[],this.looped=!0,this.currentAnimation=null,this.currentFrameIndex=0,this.frameProgress=0}async loadFromFile(t){const i=await(await fetch(t)).json();if(!i.hasOwnProperty("Ident")||i.Ident!="JAM")throw new Error("Gfx3MeshJAM::loadFromFile(): File not valid !");this.frames=[];for(const s of i.Frames){const r={vertices:[]};r.vertices=Et.build(i.NumVertices,s.Vertices,i.TextureCoords,i.Normals),this.frames.push(r)}this.animations=[];for(const s of i.Animations)this.animations.push({name:s.Name,startFrame:parseInt(s.StartFrame),endFrame:parseInt(s.EndFrame),frameDuration:parseInt(s.FrameDuration)});this.textureCoords=[];for(const s of i.TextureCoords)this.textureCoords.push(s);this.numVertices=i.NumVertices,this.currentAnimation=null,this.looped=!0,this.currentFrameIndex=0,this.frameProgress=0}update(t){if(!this.currentAnimation)return;const e=this.frameProgress/this.currentAnimation.frameDuration;let i=0;this.currentFrameIndex==this.currentAnimation.endFrame?(u.emit(this,"E_FINISHED"),i=this.looped?this.currentAnimation.startFrame:this.currentAnimation.endFrame):i=this.currentFrameIndex+1,this.beginVertices(this.numVertices);const s=this.frames[this.currentFrameIndex],r=this.frames[i];for(let n=0;n<this.numVertices;n++){const o=s.vertices[n*14+0],h=s.vertices[n*14+1],c=s.vertices[n*14+2],d=r.vertices[n*14+0],f=r.vertices[n*14+1],g=r.vertices[n*14+2],E=o+(d-o)*e,I=h+(f-h)*e,S=c+(g-c)*e,y=this.textureCoords[n*2+0],A=this.textureCoords[n*2+1],T=s.vertices[n*14+5],w=s.vertices[n*14+6],M=s.vertices[n*14+7],v=r.vertices[n*14+5],P=r.vertices[n*14+6],L=r.vertices[n*14+7],B=T+(v-T)*e,q=w+(P-w)*e,Y=M+(L-M)*e,X=s.vertices[n*14+8],W=s.vertices[n*14+9],Z=s.vertices[n*14+10],N=r.vertices[n*14+8],O=r.vertices[n*14+9],K=r.vertices[n*14+10],nt=X+(N-X)*e,tt=W+(O-W)*e,At=Z+(K-Z)*e,Ut=s.vertices[n*14+11],re=s.vertices[n*14+12],Ht=s.vertices[n*14+13],gt=r.vertices[n*14+11],jt=r.vertices[n*14+12],Wt=r.vertices[n*14+13],kt=X+(gt-Ut)*e,Gt=W+(jt-re)*e,qt=Z+(Wt-Ht)*e;this.defineVertex(E,I,S,y,A,B,q,Y,nt,tt,At,kt,Gt,qt)}this.endVertices(),e>=1?(this.currentFrameIndex=i,this.frameProgress=0):this.frameProgress+=t,super.update(t)}play(t,e=!1,i=!1){if(i&&this.currentAnimation&&this.currentAnimation.name==t)return;const s=this.animations.find(r=>r.name==t);if(!s)throw new Error("Gfx3MeshJAM::play: animation not found !");this.currentAnimation=s,this.looped=e,this.currentFrameIndex=s.startFrame,this.frameProgress=0}}class ci extends It{constructor(){super(),this.jam=new qe,this.radius=0,this.height=1,this.onActionBlockId=""}async loadFromData(t){await this.jam.loadFromFile(t.JAMFile),this.jam.setMaterial(new Q({texture:await b.loadTexture(t.TextureFile)})),this.jam.play("IDLE",!0),this.position[0]=t.PositionX,this.position[1]=t.PositionY,this.position[2]=t.PositionZ,this.rotation[0]=t.RotationX,this.rotation[1]=t.RotationY,this.rotation[2]=t.RotationZ,this.radius=t.Radius,this.height=t.Height,this.onActionBlockId=t.OnActionBlockId}delete(){this.jam.delete()}update(t){this.jam.setPosition(this.position[0],this.position[1],this.position[2]),this.jam.setRotation(this.rotation[0],this.rotation[1],this.rotation[2]),this.jam.update(t)}draw(){this.jam.draw()}move(t,e){const i=this.position.slice();this.position[0]+=t,this.position[2]+=e,this.rotation[1]=l.VEC2_ANGLE([t,e]),u.emit(this,"E_MOVED",{old:i,moveX:t,moveZ:e})}play(t){this.jam.play(t,!0,!0)}getRadius(){return this.radius}getHeight(){return this.height}getHandPosition(){return[this.position[0]+Math.cos(this.rotation[1])*this.radius*1.5,this.position[1],this.position[2]+Math.sin(this.rotation[1])*this.radius*1.5]}getOnActionBlockId(){return this.onActionBlockId}isCollide(t,e){return l.COLLIDE_CYLINDER(this.position,this.radius,this.height,t.getPosition(),t.getRadius(),t.getHeight(),e)}isHandCollide(t){return l.COLLIDE_CYLINDER(this.getHandPosition(),0,this.height,t.getPosition(),t.getRadius(),t.getHeight())}}class xr extends It{constructor(){super(),this.radius=0,this.height=1,this.hovered=!1,this.onEnterBlockId="",this.onLeaveBlockId="",this.onActionBlockId=""}async loadFromData(t){this.position[0]=t.PositionX,this.position[1]=t.PositionY,this.position[2]=t.PositionZ,this.radius=t.Radius,this.onEnterBlockId=t.OnEnterBlockId,this.onLeaveBlockId=t.OnLeaveBlockId,this.onActionBlockId=t.OnActionBlockId}draw(){Mt.drawSphere(this.getTransformMatrix(),this.radius,2)}getRadius(){return this.radius}getHeight(){return this.height}isHovered(){return this.hovered}setHovered(t){this.hovered=t}getOnEnterBlockId(){return this.onEnterBlockId}getOnLeaveBlockId(){return this.onLeaveBlockId}getOnActionBlockId(){return this.onActionBlockId}}class ui{constructor(t){this.target=null,this.minClipOffset=[0,0],this.maxClipOffset=[0,0],this.view=x.getView(t),this.view.setProjectionMode(Ze.PERSPECTIVE)}async loadFromData(t){this.minClipOffset[0]=t.MinClipOffsetX,this.minClipOffset[1]=t.MinClipOffsetY,this.maxClipOffset[0]=t.MaxClipOffsetX,this.maxClipOffset[1]=t.MaxClipOffsetY,this.view.setCameraMatrix(t.Matrix),this.view.setPerspectiveFovy(l.DEG_TO_RAD(parseInt(t.Fovy)))}update(t){if(!this.target)return;let e=this.view.getClipOffset(),i=this.target.getPosition(),s=this.view.getScreenNormalizedPosition(i[0],i[1],i[2]);this.view.setClipOffset(l.CLAMP(s[0]+e[0],this.minClipOffset[0],this.maxClipOffset[0]),l.CLAMP(s[1]+e[1],this.minClipOffset[1],this.maxClipOffset[1]))}setTarget(t){this.target=t}}const di=3;class Mr{constructor(){this.name="",this.description="",this.map=new J,this.walkmesh=new Ee,this.controller=new ci,this.camera=new ui(0),this.scriptMachine=new Ke,this.spawns=[],this.models=[],this.triggers=[],this.pause=!1,this.scriptMachine.registerCommand("LOAD_ROOM",this.$loadRoom.bind(this)),this.scriptMachine.registerCommand("CONTINUE",this.$continue.bind(this)),this.scriptMachine.registerCommand("STOP",this.$stop.bind(this)),this.scriptMachine.registerCommand("UI_CREATE_DIALOG",this.$uiCreateDialog.bind(this)),this.scriptMachine.registerCommand("MODEL_PLAY_ANIMATION",this.$modelPlayAnimation.bind(this)),u.subscribe(R,"E_ACTION_ONCE",this,this.handleActionOnce),u.subscribe(this.controller,"E_MOVED",this,this.handleControllerMoved)}async loadFromFile(t,e){let s=await(await fetch(t)).json();this.name=s.Name,this.description=s.Description,this.map=new J,await this.map.loadFromFile(s.MapFile),this.map.setMaterial(new Q({texture:await b.loadTexture(s.MapTextureFile)})),this.walkmesh=new Ee,await this.walkmesh.loadFromFile(s.WalkmeshFile),await this.controller.loadFromData(s.Controller),this.camera=new ui(0),await this.camera.loadFromData(s.Camera),this.camera.setTarget(this.controller),this.spawns=[];for(let n of s.Spawns){let o=new yr;await o.loadFromData(n),this.spawns.push(o)}this.models=[];for(let n of s.Models){let o=new ci;await o.loadFromData(n),this.models.push(o)}this.triggers=[];for(let n of s.Triggers){let o=new xr;await o.loadFromData(n),this.triggers.push(o)}let r=this.spawns.find(n=>n.getName()==e);this.controller.setPosition(r.getPositionX(),r.getPositionY(),r.getPositionZ()),this.controller.setRotation(0,l.VEC2_ANGLE(r.getDirection()),0),this.walkmesh.addWalker("CONTROLLER",this.controller.getPositionX(),this.controller.getPositionZ(),this.controller.getRadius()),await this.scriptMachine.loadFromFile(s.ScriptFile),this.scriptMachine.jump("ON_INIT"),this.scriptMachine.setEnabled(!0)}delete(){for(const t of this.models)t.delete();u.unsubscribe(R,"E_ACTION_ONCE",this),u.unsubscribe(this.controller,"E_MOVED",this)}update(t){let e=!1,i=l.VEC3_ZERO;if(R.isActiveAction("LEFT")?(i=l.VEC3_LEFT,e=!0):R.isActiveAction("RIGHT")?(i=l.VEC3_RIGHT,e=!0):R.isActiveAction("UP")?(i=l.VEC3_FORWARD,e=!0):R.isActiveAction("DOWN")&&(i=l.VEC3_BACKWARD,e=!0),e&&!this.pause){const s=i[0]*di*(t/1e3),r=i[2]*di*(t/1e3);this.controller.move(s,r,!0),this.controller.play("RUN")}else this.controller.play("IDLE");this.map.update(t),this.walkmesh.update(t),this.controller.update(t),this.camera.update(t),this.scriptMachine.update(t);for(let s of this.models)s.update(t)}draw(){this.map.draw(),this.walkmesh.draw(),this.controller.draw();for(let t of this.spawns)t.draw();for(let t of this.models)t.draw();for(let t of this.triggers)t.draw()}handleActionOnce(t){if(!(t.actionId!="OK"||this.pause)){for(let e of this.triggers)if(this.controller.isCollide(e)&&e.getOnActionBlockId()){this.scriptMachine.jump(e.getOnActionBlockId());return}for(let e of this.models)if(this.controller.isHandCollide(e)&&e.getOnActionBlockId()){this.scriptMachine.jump(e.getOnActionBlockId());return}}}handleControllerMoved({old:t,moveX:e,moveZ:i}){for(let n of this.models){let o=[];if(this.controller.isCollide(n,o)){e+=o[0],i+=o[1];break}}let s=this.walkmesh.moveWalker("CONTROLLER",e,i),r=l.VEC3_ADD(t,s);this.controller.setPosition(r[0],r[1],r[2]);for(let n of this.triggers){let o=this.controller.isCollide(n);n.getOnEnterBlockId()&&!n.isHovered()&&o?(this.scriptMachine.jump(n.getOnEnterBlockId()),n.setHovered(!0)):n.getOnLeaveBlockId()&&n.isHovered()&&!o&&(this.scriptMachine.jump(n.getOnLeaveBlockId()),n.setHovered(!1))}}async $loadRoom(t,e){this.pause=!0,await this.loadFromFile(t,e),this.pause=!1}$continue(){this.pause=!1}$stop(){this.pause=!0}async $uiCreateDialog(t,e){this.scriptMachine.setEnabled(!1);let i=new Ge;i.setAuthor(t),i.setText(e),p.addWidget(i),p.focus(i),await u.wait(i,"E_OK"),p.removeWidget(i),this.scriptMachine.setEnabled(!0)}$modelPlayAnimation(t,e,i){this.models[t].play(e,i)}}class wr extends k{constructor(){super(),this.room=new Mr}async onEnter(){await this.room.loadFromFile("./samples/prerendered/scene.room","Spawn0000")}update(t){this.room.update(t)}draw(){this.room.draw()}}class vr extends H{uiMenu;text;actions;stepDuration;currentTextOffset;currentActionTextOffset;currentActionIndex;timeElapsed;finished;constructor(){super({className:"UIBubble",template:`
      <img class="UIBubble-picture js-picture" src=""/>
      <div class="UIBubble-content">
        <div class="UIBubble-author js-author"></div>
        <div class="UIBubble-text js-text"></div>
        <div class="UIBubble-menu js-menu"></div>
      </div>`}),this.uiMenu=new it,this.text="",this.actions=[],this.stepDuration=0,this.currentTextOffset=0,this.currentActionTextOffset=0,this.currentActionIndex=0,this.timeElapsed=0,this.finished=!1,this.node.querySelector(".js-menu").replaceWith(this.uiMenu.getNode()),u.subscribe(this.uiMenu,"E_ITEM_SELECTED",this,this.handleMenuItemSelected)}update(t){if(this.uiMenu.update(t),this.currentTextOffset==this.text.length&&this.currentActionIndex==this.actions.length){this.finished=!0,u.emit(this,"E_PRINT_FINISHED");return}this.timeElapsed>=this.stepDuration?(this.currentTextOffset<this.text.length?(this.node.querySelector(".js-text").textContent=this.text.substring(0,this.currentTextOffset+1),this.currentTextOffset++):this.currentActionIndex<this.actions.length&&(this.currentActionTextOffset==0&&this.uiMenu.add(this.currentActionIndex.toString(),""),this.currentActionTextOffset<this.actions[this.currentActionIndex].length?(this.uiMenu.set(this.currentActionIndex.toString(),this.actions[this.currentActionIndex].substring(0,this.currentActionTextOffset+1)),this.currentActionTextOffset++):(this.currentActionIndex++,this.currentActionTextOffset=0)),this.timeElapsed=0):this.timeElapsed+=t}delete(){u.unsubscribe(this.uiMenu,"E_ITEM_SELECTED",this),this.uiMenu.delete(),super.delete()}focus(){this.actions.length>0&&this.uiMenu.focus(),super.focus()}unfocus(){this.actions.length>0&&this.uiMenu.unfocus(),super.unfocus()}setPicture(t){this.node.querySelector(".js-picture").src=t}setAuthor(t){this.node.querySelector(".js-author").textContent=t}setWidth(t){this.node.style.width=t+"px"}setText(t){this.text=t,this.currentTextOffset=0,this.finished=!1}setActions(t){this.actions=t,this.currentActionIndex=0,this.currentActionTextOffset=0,this.finished=!1,this.uiMenu.clear()}setStepDuration(t){this.stepDuration=t}onAction(t){t=="OK"&&this.finished&&u.emit(this,"E_OK")}handleMenuItemSelected(t){u.emit(this,"E_MENU_ITEM_SELECTED",t)}}const _t={LEFT:"LEFT",RIGHT:"RIGHT",FORWARD:"FORWARD",BACKWARD:"BACKWARD"},Ce={LEFT:l.VEC3_LEFT,RIGHT:l.VEC3_RIGHT,FORWARD:l.VEC3_FORWARD,BACKWARD:l.VEC3_BACKWARD},pi=48,br=8.4,Pr=100,Rr=[.7071,0,.7071,0,.3546,.8652,-.3546,0,-.6118,.5015,.6118,0,-7.3046,4.9583,5.6356,1];class Dr extends It{constructor(){super(),this.name="",this.direction=_t.FORWARD,this.radius=.2}async loadFromData(t){this.name=t.Name,this.position[0]=t.PositionX,this.position[1]=t.PositionY,this.position[2]=t.PositionZ,this.direction=t.Direction}draw(){Mt.drawSphere(this.getTransformMatrix(),this.radius,2)}getName(){return this.name}getDirection(){return this.direction}getRadius(){return this.radius}}class Or extends Me{offset;flip;pixelsPerUnit;billboardMode;texture;textureBuffer;textureChanged;constructor(){super(Ki),this.offset=[0,0],this.flip=[!1,!1],this.pixelsPerUnit=100,this.billboardMode=!1,this.texture=x.createTextureFromBitmap(),this.textureBuffer=x.createUniformGroupBitmaps("SPRITE_PIPELINE",1),this.textureBuffer.addSamplerInput(0,this.texture.gpuSampler),this.textureBuffer.addTextureInput(1,this.texture.gpuTexture),this.textureBuffer.allocate(),this.textureChanged=!1}draw(){Qi.drawSprite(this)}getTransformMatrix(){const t=l.MAT4_CREATE();return l.MAT4_MULTIPLY(t,l.MAT4_TRANSLATE(this.position[0],this.position[1],this.position[2]),t),l.MAT4_MULTIPLY(t,l.MAT4_ROTATE_Y(this.rotation[1]),t),l.MAT4_MULTIPLY(t,l.MAT4_ROTATE_X(this.rotation[0]),t),l.MAT4_MULTIPLY(t,l.MAT4_ROTATE_Z(this.rotation[2]),t),l.MAT4_MULTIPLY(t,l.MAT4_SCALE(this.scale[0],this.scale[1],this.scale[2]),t),l.MAT4_MULTIPLY(t,l.MAT4_SCALE(1/this.pixelsPerUnit,1/this.pixelsPerUnit,1/this.pixelsPerUnit),t),l.MAT4_MULTIPLY(t,l.MAT4_TRANSLATE(-this.offset[0],-this.offset[1],0),t),t}getOffset(){return this.offset}getOffsetX(){return this.offset[0]}getOffsetY(){return this.offset[1]}setOffset(t,e){this.offset=[t,e]}getFlip(){return this.flip}setFlipX(t){this.flip[0]=t}setFlipY(t){this.flip[1]=t}getPixelsPerUnit(){return this.pixelsPerUnit}setPixelsPerUnit(t){this.pixelsPerUnit=t}getBillboardMode(){return this.billboardMode}setBillboardMode(t){this.billboardMode=t}setTexture(t){this.texture=t,this.textureChanged=!0}getTexture(){return this.texture}getTextureBuffer(){return this.textureChanged&&(this.textureBuffer.setSamplerInput(0,this.texture.gpuSampler),this.textureBuffer.setTextureInput(1,this.texture.gpuTexture),this.textureBuffer.allocate(),this.textureChanged=!1),this.textureBuffer}}class Ye extends Or{animations;currentAnimation;currentAnimationFrameIndex;looped;frameProgress;constructor(){super(),this.animations=[],this.currentAnimation=null,this.currentAnimationFrameIndex=0,this.looped=!1,this.frameProgress=0}async loadFromFile(t){const i=await(await fetch(t)).json();if(!i.hasOwnProperty("Ident")||i.Ident!="JAS")throw new Error("Gfx3SpriteJAS::loadFromFile(): File not valid !");this.animations=[];for(const s of i.Animations){const r={name:s.Name,frames:[],frameDuration:parseInt(s.FrameDuration)};for(const n of s.Frames)r.frames.push({x:n.X,y:n.Y,width:n.Width,height:n.Height});this.animations.push(r)}this.currentAnimation=null,this.currentAnimationFrameIndex=0,this.frameProgress=0}update(t){if(!this.currentAnimation||!this.texture)return;const e=this.currentAnimation.frames[this.currentAnimationFrameIndex],i=0,s=0,r=e.width,n=e.height,o=e.x/this.texture.gpuTexture.width,h=e.y/this.texture.gpuTexture.height,c=(e.x+e.width)/this.texture.gpuTexture.width,d=(e.y+e.height)/this.texture.gpuTexture.height,f=this.flip[0]?1-o:o,g=this.flip[1]?1-h:h,E=this.flip[0]?1-c:c,I=this.flip[1]?1-d:d;this.beginVertices(6),this.defineVertex(i,n,0,f,g),this.defineVertex(i,s,0,f,I),this.defineVertex(r,s,0,E,I),this.defineVertex(r,s,0,E,I),this.defineVertex(r,n,0,E,g),this.defineVertex(i,n,0,f,g),this.endVertices(),this.frameProgress>=this.currentAnimation.frameDuration?this.currentAnimationFrameIndex==this.currentAnimation.frames.length-1?(u.emit(this,"E_FINISHED"),this.currentAnimationFrameIndex=this.looped?0:this.currentAnimation.frames.length-1,this.frameProgress=0):(this.currentAnimationFrameIndex=this.currentAnimationFrameIndex+1,this.frameProgress=0):this.frameProgress+=t}play(t,e=!1,i=!1){if(i&&this.currentAnimation&&t==this.currentAnimation.name)return;const s=this.animations.find(r=>r.name==t);if(!s)throw new Error("Gfx3SpriteJAS::play: animation not found.");this.currentAnimation=s,this.currentAnimationFrameIndex=0,this.looped=e,this.frameProgress=0}getAnimations(){return this.animations}setAnimations(t){this.animations=t}getCurrentAnimation(){return this.currentAnimation}getCurrentAnimationFrameIndex(){return this.currentAnimationFrameIndex}setOffsetNormalized(t,e){if(!this.currentAnimation)return;const i=this.currentAnimation.frames[this.currentAnimationFrameIndex];!i||(this.offset[0]=i.width*t,this.offset[1]=i.height*e)}}class fi extends It{constructor(){super(),this.jas=new Ye,this.radius=0,this.height=1,this.direction=_t.FORWARD,this.onActionBlockId="",this.jas.setPixelsPerUnit(pi),this.jas.setBillboardMode(!0)}async loadFromData(t){await this.jas.loadFromFile(t.JASFile),this.jas.setTexture(await b.loadTexture(t.TextureFile)),this.jas.setOffset(t.OffsetX,t.OffsetY),this.position[0]=t.PositionX,this.position[1]=t.PositionY,this.position[2]=t.PositionZ,this.radius=t.Radius,this.height=t.Height,this.onActionBlockId=t.OnActionBlockId}delete(){this.jas.delete()}update(t){let e=this.jas.getOffsetY()/pi;this.jas.setPosition(this.position[0],this.position[1]+e,this.position[2]),this.jas.update(t)}draw(){this.jas.draw()}move(t,e,i=null){const s=this.position.slice();this.position[0]+=t,this.position[2]+=e,this.direction=i,u.emit(this,"E_MOVED",{old:s,moveX:t,moveZ:e})}play(t,e=!1){this.jas.play(t,e,!0)}getDirection(){return this.direction}setDirection(t){this.direction=t}getRadius(){return this.radius}getHeight(){return this.height}getOnActionBlockId(){return this.onActionBlockId}getHandPosition(){return[this.position[0]+Ce[this.direction][0]*this.radius*1.2,this.position[1],this.position[2]+Ce[this.direction][2]*this.radius*1.2]}isCollide(t){return l.COLLIDE_CYLINDER(this.position,this.radius,this.height,t.getPosition(),t.getRadius(),t.getHeight())}isHandCollide(t){return l.COLLIDE_CYLINDER(this.getHandPosition(),0,this.height,t.getPosition(),t.getRadius(),t.getHeight())}}class _r extends It{constructor(){super(),this.radius=0,this.height=1,this.hovered=!1,this.onEnterBlockId="",this.onLeaveBlockId="",this.onActionBlockId=""}async loadFromData(t){this.position[0]=t.PositionX,this.position[1]=t.PositionY,this.position[2]=t.PositionZ,this.radius=t.Radius,this.onEnterBlockId=t.OnEnterBlockId,this.onLeaveBlockId=t.OnLeaveBlockId,this.onActionBlockId=t.OnActionBlockId}draw(){Mt.drawSphere(this.getTransformMatrix(),this.radius,2)}getRadius(){return this.radius}getHeight(){return this.height}isHovered(){return this.hovered}setHovered(t){this.hovered=t}getOnEnterBlockId(){return this.onEnterBlockId}getOnLeaveBlockId(){return this.onLeaveBlockId}getOnActionBlockId(){return this.onActionBlockId}}class mi{constructor(t){this.target=null,this.minClipOffset=[0,0],this.maxClipOffset=[0,0],this.view=x.getView(t),this.view.setProjectionMode(Ze.ORTHOGRAPHIC),this.view.setOrthographicSize(br),this.view.setOrthographicDepth(Pr),this.view.setCameraMatrix(Rr)}async loadFromData(t){this.minClipOffset[0]=t.MinClipOffsetX,this.minClipOffset[1]=t.MinClipOffsetY,this.maxClipOffset[0]=t.MaxClipOffsetX,this.maxClipOffset[1]=t.MaxClipOffsetY}update(t){if(!this.target)return;let e=this.view.getClipOffset(),i=this.target.getPosition(),s=this.view.getScreenNormalizedPosition(0,i[0],i[1],i[2]);this.view.setClipOffset(l.CLAMP(s[0]+e[0],this.minClipOffset[0],this.maxClipOffset[0]),l.CLAMP(s[1]+e[1],this.minClipOffset[1],this.maxClipOffset[1]))}setTarget(t){this.target=t}}const gi=1;class Lr{constructor(){this.name="",this.description="",this.map=new J,this.walkmesh=new Ee,this.controller=new fi,this.camera=new mi(0),this.scriptMachine=new Ke,this.spawns=[],this.models=[],this.triggers=[],this.pause=!1,this.scriptMachine.registerCommand("LOAD_ROOM",this.$loadRoom.bind(this)),this.scriptMachine.registerCommand("CONTINUE",this.$continue.bind(this)),this.scriptMachine.registerCommand("STOP",this.$stop.bind(this)),this.scriptMachine.registerCommand("UI_CREATE_DIALOG",this.$uiCreateDialog.bind(this)),this.scriptMachine.registerCommand("MODEL_PLAY_ANIMATION",this.$modelPlayAnimation.bind(this)),u.subscribe(R,"E_ACTION_ONCE",this,this.handleActionOnce),u.subscribe(this.controller,"E_MOVED",this,this.handleControllerMoved)}async loadFromFile(t,e){let s=await(await fetch(t)).json();this.map=new J,await this.map.loadFromFile(s.MapFile),this.map.setMaterial(new Q({texture:await b.loadTexture(s.MapTextureFile)})),this.walkmesh=new Ee,await this.walkmesh.loadFromFile(s.WalkmeshFile),await this.controller.loadFromData(s.Controller),this.camera=new mi(0),await this.camera.loadFromData(s.Camera),this.camera.setTarget(this.controller),this.spawns=[];for(let n of s.Spawns){let o=new Dr;await o.loadFromData(n),this.spawns.push(o)}this.models=[];for(let n of s.Models){let o=new fi;await o.loadFromData(n),this.models.push(o)}this.triggers=[];for(let n of s.Triggers){let o=new _r;await o.loadFromData(n),this.triggers.push(o)}let r=this.spawns.find(n=>n.getName()==e);this.controller.setPosition(r.getPositionX(),r.getPositionY(),r.getPositionZ()),this.controller.setDirection(r.getDirection()),this.controller.play("IDLE_"+r.getDirection(),!0,!0),this.walkmesh.addWalker("CONTROLLER",this.controller.getPositionX(),this.controller.getPositionZ(),this.controller.getRadius()),await this.scriptMachine.loadFromFile(s.ScriptFile),this.scriptMachine.jump("ON_INIT"),this.scriptMachine.setEnabled(!0)}delete(){for(const t of this.models)t.delete();u.unsubscribe(R,"E_ACTION_ONCE",this),u.unsubscribe(this.controller,"E_MOVED",this)}update(t){let e=_t.FORWARD,i=!1;if(R.isActiveAction("LEFT")?(i=!0,e=_t.LEFT):R.isActiveAction("RIGHT")?(i=!0,e=_t.RIGHT):R.isActiveAction("UP")?(i=!0,e=_t.FORWARD):R.isActiveAction("DOWN")&&(i=!0,e=_t.BACKWARD),i&&!this.pause){const s=Ce[e][0]*gi*(t/1e3),r=Ce[e][2]*gi*(t/1e3);this.controller.move(s,r,e),this.controller.play("RUN_"+e,!0)}else this.controller.play("IDLE_"+this.controller.getDirection(),!0);this.map.update(t),this.walkmesh.update(t),this.controller.update(t),this.camera.update(t),this.scriptMachine.update(t);for(let s of this.models)s.update(t)}draw(){this.map.draw(),this.walkmesh.draw(),this.controller.draw();for(let t of this.spawns)t.draw();for(let t of this.models)t.draw();for(let t of this.triggers)t.draw()}handleActionOnce(t){if(!(t.actionId!="OK"||this.pause)){for(let e of this.triggers)if(this.controller.isCollide(e)&&e.getOnActionBlockId()){this.scriptMachine.jump(e.getOnActionBlockId());return}for(let e of this.models)if(this.controller.isHandCollide(e)&&e.getOnActionBlockId()){this.scriptMachine.jump(e.getOnActionBlockId());return}}}handleControllerMoved({old:t,moveX:e,moveZ:i}){for(let n of this.models)if(this.controller.isCollide(n)){this.controller.setPosition(t[0],t[1],t[2]);return}let s=this.walkmesh.moveWalker("CONTROLLER",e,i),r=l.VEC3_ADD(t,s);this.controller.setPosition(r[0],r[1],r[2]);for(let n of this.triggers){let o=this.controller.isCollide(n);n.getOnEnterBlockId()&&!n.isHovered()&&o?(this.scriptMachine.jump(n.getOnEnterBlockId()),n.setHovered(!0)):n.getOnLeaveBlockId()&&n.isHovered()&&!o&&(this.scriptMachine.jump(n.getOnLeaveBlockId()),n.setHovered(!1))}}async $loadRoom(t,e){this.controller.setControllable(!1),await this.loadFromFile(t,e),this.controller.setControllable(!0)}$continue(){this.pause=!1}$stop(){this.pause=!0}async $uiCreateDialog(t,e,i,s,r,n){this.scriptMachine.setEnabled(!1);let o=new vr;o.setAuthor(t),o.setPicture(e),o.setText(i),o.setWidth(s),p.addWidget(o,`position:absolute; top:${n}; left:${r}`),p.focus(o),await u.wait(o,"E_OK"),p.removeWidget(o),this.scriptMachine.setEnabled(!0)}$modelPlayAnimation(t,e,i){this.models[t].play(e,i)}}class Nr extends k{constructor(){super(),this.room=new Lr}async onEnter(){await this.room.loadFromFile("./samples/prerendered-isometric/scene.room","Spawn0000")}update(t){this.room.update(t)}draw(){this.room.draw()}}class Fr{textures;constructor(){this.textures=new Map}async loadTexture(t){if(this.textures.has(t))return this.textures.get(t);const i=await(await fetch(t)).blob(),s=await createImageBitmap(i);return this.textures.set(t,s),s}deleteTexture(t){if(!this.textures.has(t))throw new Error("Gfx2TextureManager::deleteTexture(): The texture file doesn't exist, cannot delete !");this.textures.delete(t)}getTexture(t){if(!this.textures.has(t))throw new Error("Gfx2TextureManager::getTexture(): The texture file doesn't exist, cannot get !");return this.textures.get(t)}releaseTextures(){for(const t of this.textures.keys())this.textures.delete(t)}}const St=new Fr;class Ie{rows;columns;tileHeight;tileWidth;tileLayers;tileset;constructor(){this.rows=0,this.columns=0,this.tileHeight=0,this.tileWidth=0,this.tileLayers=[],this.tileset=new Ei}async loadFromFile(t){let i=await(await fetch(t)).json();this.rows=i.Rows,this.columns=i.Columns,this.tileHeight=i.TileHeight,this.tileWidth=i.TileWidth,this.tileLayers=[];for(let s of i.Layers){let r=new Br;await r.loadFromData(s),this.tileLayers.push(r)}this.tileset=new Ei,i.Tileset&&await this.tileset.loadFromData(i.Tileset)}getHeight(){return this.rows*this.tileHeight}getWidth(){return this.columns*this.tileWidth}getRows(){return this.rows}getColumns(){return this.columns}getTileHeight(){return this.tileHeight}getTileWidth(){return this.tileWidth}getTileLayer(t){return this.tileLayers[t]}findTileLayer(t){return this.tileLayers.find(e=>e.getName()==t)}getTileset(){return this.tileset}getPositionX(t){return t*this.tileWidth}getPositionY(t){return t*this.tileHeight}getLocationCol(t){return Math.floor(t/this.tileWidth)}getLocationRow(t){return Math.floor(t/this.tileHeight)}}class Br{name;rows;columns;visible;frameDuration;grid;constructor(){this.name="",this.rows=0,this.columns=0,this.visible=!0,this.frameDuration=0,this.grid=[]}async loadFromData(t){this.name=t.Name,this.rows=t.Rows,this.columns=t.Columns,this.visible=t.Visible,this.frameDuration=t.FrameDuration,this.grid=t.Grid}getTile(t,e){return this.grid[t+e*this.columns]}getName(){return this.name}getRows(){return this.rows}getColumns(){return this.columns}isVisible(){return this.visible}getFrameDuration(){return this.frameDuration}getGrid(){return this.grid}}class Ei{columns;tileWidth;tileHeight;texture;animations;constructor(){this.columns=0,this.tileWidth=0,this.tileHeight=0,this.texture=V.getDefaultTexture(),this.animations=new Map}async loadFromData(t){this.columns=parseInt(t.Columns),this.tileWidth=parseInt(t.TileWidth),this.tileHeight=parseInt(t.TileHeight),this.texture=await St.loadTexture(t.TextureFile),this.animations.clear();for(const e in t.Animations)this.animations.set(parseInt(e),t.Animations[e]??[])}getTilePositionX(t){return(t-1)%this.columns*this.tileWidth}getTilePositionY(t){return Math.floor((t-1)/this.columns)*this.tileHeight}getTileHeight(){return this.tileHeight}getTileWidth(){return this.tileWidth}getColumns(){return this.columns}getTexture(){return this.texture}getAnimation(t){return this.animations.get(t)}}class ie{position;rotation;scale;offset;visible;constructor(){this.position=[0,0],this.rotation=0,this.scale=[1,1],this.offset=[0,0],this.visible=!0}draw(){if(!this.visible)return;const t=V.getContext();t.save(),t.translate(-this.offset[0],-this.offset[1]),t.translate(this.position[0],this.position[1]),t.rotate(this.rotation),t.scale(this.scale[0],this.scale[1]),this.paint(),t.restore()}update(t){}paint(){}getPosition(){return this.position}getPositionX(){return this.position[0]}getPositionY(){return this.position[1]}setPosition(t,e){this.position[0]=t,this.position[1]=e}getRotation(){return this.rotation}setRotation(t){this.rotation=t}getScale(){return this.scale}getScaleX(){return this.scale[0]}getScaleY(){return this.scale[1]}setScale(t,e){this.scale[0]=t,this.scale[1]=e}getOffset(){return this.offset}getOffsetX(){return this.offset[0]}getOffsetY(){return this.offset[1]}setOffset(t,e){this.offset[0]=t,this.offset[1]=e}isVisible(){return this.visible}setVisible(t){this.visible=t}}class Yt extends ie{map;layerIndex;frameIndex;frameProgress;constructor(t,e){super(),this.map=t,this.layerIndex=e,this.frameIndex=0,this.frameProgress=0}update(t){const e=this.map.getTileLayer(this.layerIndex);!e||(this.frameProgress>e.getFrameDuration()&&(this.frameIndex=this.frameIndex+1,this.frameProgress=0),this.frameProgress+=t)}paint(){const t=this.map.getTileLayer(this.layerIndex);if(!t||!t.isVisible())return;const e=V.getContext(),i=this.map.getTileset();for(let s=0;s<t.getColumns();s++)for(let r=0;r<t.getRows();r++){let n=t.getTile(s,r);const o=i.getAnimation(n);o&&(n=o[this.frameIndex%o.length]),e.drawImage(i.getTexture(),i.getTilePositionX(n),i.getTilePositionY(n),i.getTileWidth(),i.getTileHeight(),Math.round(s*this.map.getTileWidth()),Math.round(r*this.map.getTileHeight()),this.map.getTileWidth(),this.map.getTileHeight())}}}class wt extends ie{flip;animations;texture;currentAnimation;currentAnimationFrameIndex;isLooped;frameProgress;constructor(){super(),this.flip=[!1,!1],this.animations=[],this.texture=V.getDefaultTexture(),this.currentAnimation=null,this.currentAnimationFrameIndex=0,this.isLooped=!1,this.frameProgress=0}update(t){!this.currentAnimation||(this.frameProgress>=this.currentAnimation.frameDuration?this.currentAnimationFrameIndex==this.currentAnimation.frames.length-1?(u.emit(this,"E_FINISHED"),this.currentAnimationFrameIndex=this.isLooped?0:this.currentAnimation.frames.length-1,this.frameProgress=0):(this.currentAnimationFrameIndex=this.currentAnimationFrameIndex+1,this.frameProgress=0):this.frameProgress+=t)}paint(){if(!this.currentAnimation)return;const t=V.getContext(),e=this.currentAnimation.frames[this.currentAnimationFrameIndex];t.scale(this.flip[0]?-1:1,this.flip[1]?-1:1),t.drawImage(this.texture,e.x,e.y,e.width,e.height,this.flip[0]?e.width*-1:0,this.flip[1]?e.height*-1:0,e.width,e.height)}play(t,e=!1,i=!1){if(i&&this.currentAnimation&&t==this.currentAnimation.name)return;const s=this.animations.find(r=>r.name==t);if(!s)throw new Error("Gfx2SpriteJAS::play: animation not found.");this.currentAnimation=s,this.currentAnimationFrameIndex=0,this.isLooped=e,this.frameProgress=0}async loadFromFile(t){const i=await(await fetch(t)).json();this.animations=[];for(const s of i.Animations){const r={name:s.Name,frames:[],frameDuration:parseInt(s.FrameDuration)};for(const n of s.Frames)r.frames.push({x:n.X,y:n.Y,width:n.Width,height:n.Height});this.animations.push(r)}this.currentAnimation=null,this.currentAnimationFrameIndex=0,this.frameProgress=0}getFlip(){return this.flip}setFlipX(t){this.flip[0]=t}setFlipY(t){this.flip[1]=t}getAnimations(){return this.animations}setAnimations(t){this.animations=t}getCurrentAnimation(){return this.currentAnimation}getCurrentAnimationFrameIndex(){return this.currentAnimationFrameIndex}getTexture(){return this.texture}setTexture(t){this.texture=t}}class Vr extends ie{constructor(){super(),this.jas=new wt,this.direction="FORWARD",this.speed=.05,this.width=0,this.height=0,this.collider1=[0,0],this.collider2=[0,0]}async loadFromFile(t){let i=await(await fetch(t)).json();await this.jas.loadFromFile(i.JASFile),this.jas.setTexture(await St.loadTexture(i.TextureFile)),this.jas.setOffset(i.OffsetX,i.OffsetY),this.width=i.Width,this.height=i.Height,this.collider1[0]=i.Collider1X,this.collider1[1]=i.Collider1Y,this.collider2[0]=i.Collider2X,this.collider2[1]=i.Collider2Y}update(t){this.jas.setPosition(this.position[0],this.position[1]),this.jas.update(t)}draw(){this.jas.draw()}move(t,e,i=null){const s=this.position.slice();this.position[0]+=t,this.position[1]+=e,this.direction=i,u.emit(this,"E_MOVED",{old:s,moveX:t,moveY:e})}play(t,e){this.jas.play(t,e,!0)}getDirection(){return this.direction}getSpeed(){return this.speed}getWidth(){return this.width}getHeight(){return this.height}getCollider1X(){return this.collider1[0]}getCollider1Y(){return this.collider1[1]}getCollider2X(){return this.collider2[0]}getCollider2Y(){return this.collider2[1]}}const Fe={BACKGROUND:0,MIDDLE:1,FOREGROUND:2},Ci={LEFT:[-1,0],RIGHT:[1,0],FORWARD:[0,-1],BACKWARD:[0,1]};class Ur extends k{constructor(){super(),this.map=new Ie,this.collisionMap=new Ie,this.layerBackground=new Yt(this.map,Fe.BACKGROUND),this.layerMiddle=new Yt(this.map,Fe.MIDDLE),this.layerForeground=new Yt(this.map,Fe.FOREGROUND),this.controller=new Vr}async onEnter(){await this.map.loadFromFile("./samples/tilemap/map.json"),await this.collisionMap.loadFromFile("./samples/tilemap/collision.json"),await this.controller.loadFromFile("./samples/tilemap/bernard.json"),this.controller.setPosition(this.collisionMap.getPositionX(12),this.collisionMap.getPositionY(16)),u.subscribe(this.controller,"E_MOVED",this,this.handleControllerMoved)}update(t){let e=!1,i="FORWARD";if(R.isActiveAction("LEFT")?(e=!0,i="LEFT"):R.isActiveAction("RIGHT")?(e=!0,i="RIGHT"):R.isActiveAction("UP")?(e=!0,i="FORWARD"):R.isActiveAction("DOWN")&&(e=!0,i="BACKWARD"),e){let h=Ci[i][0]*this.controller.getSpeed()*t,c=Ci[i][1]*this.controller.getSpeed()*t;this.controller.move(h,c,i),this.controller.play("RUN_"+i,!0)}else this.controller.play("IDLE_"+this.controller.getDirection(),!0);let s=V.getWidth()*.5,r=this.map.getWidth()-V.getWidth()*.5,n=V.getHeight()*.5,o=this.map.getHeight()-V.getHeight()*.5;V.setCameraPosition(l.CLAMP(this.controller.getPositionX(),s,r),l.CLAMP(this.controller.getPositionY(),n,o)),this.layerBackground.update(t),this.layerMiddle.update(t),this.controller.update(t),this.layerForeground.update(t)}draw(){this.layerBackground.draw(),this.layerMiddle.draw(),this.controller.draw(),this.layerForeground.draw()}handleControllerMoved({old:t,moveX:e,moveY:i}){let s=this.controller.getPosition(),r=this.collisionMap.getTileLayer(0);if(!r)return;let n=this.collisionMap.getLocationCol(s[0]+this.controller.getCollider1X()),o=this.collisionMap.getLocationCol(s[1]+this.controller.getCollider1Y()),h=this.collisionMap.getLocationCol(s[0]+this.controller.getCollider2X()),c=this.collisionMap.getLocationCol(s[1]+this.controller.getCollider2Y());(r.getTile(n,o)==1||r.getTile(h,c)==1)&&this.controller.setPosition(t[0],t[1])}}class Hr{static solve(t,e,i,s){const r=new Map,n=[];let o=!1;for(n.push(i),r.set(i[0]+";"+i[1],{x:i[0],y:i[1],originX:-1,originY:-1});!o;){const d=n.shift();if(!d)return null;const f=jr(d,s);for(const g of f){const E=d[0]+g[0],I=d[1]+g[1];t.length<e*(I+1)||t[e*I+E]==1||r.get(E+";"+I)||(E==s[0]&&I==s[1]&&(o=!0),n.push([E,I]),r.set(E+";"+I,{x:E,y:I,originX:d[0],originY:d[1]}))}}const h=[];let c=r.get(s[0]+";"+s[1]);for(;c;)h.unshift([c.x,c.y]),c=r.get(c.originX+";"+c.originY);return h}}function jr(a,t){const e=[[0,-1],[1,0],[0,1],[-1,0]],i=t[0]-a[0],s=t[1]-a[1];return e.sort((r,n)=>{const o=Math.sqrt((i+r[0])*(i+r[0])+(s+r[1])*(s+r[1])),h=Math.sqrt((i+n[0])*(i+n[0])+(s+n[1])*(s+n[1]));return o-h})}class Wr{constructor(t,e){this.path=t,this.speed=e,this.position=this.path[0],this.duration=this.path.length/this.speed,this.timeElapsed=0}update(t){if(this.timeElapsed+=t/1e3,this.timeElapsed>=this.duration){this.position=this.path[this.path.length-1];return}let e=this.timeElapsed/this.duration*(this.path.length-1),i=Math.floor(e),s=this.path[i],r=this.path[i+1];this.position=[s[0]+(r[0]-s[0])*(e-i),s[1]+(r[1]-s[1])*(e-i)]}getPosition(){return this.position}isOngoing(){return this.timeElapsed<this.duration}}class kr extends ie{constructor(){super(),this.jas=new wt,this.direction="FORWARD",this.speed=3,this.width=0,this.height=0,this.motion=null}async loadFromFile(t){let i=await(await fetch(t)).json();await this.jas.loadFromFile(i.JASFile),this.jas.setTexture(await St.loadTexture(i.TextureFile)),this.jas.setOffset(i.OffsetX,i.OffsetY),this.width=i.Width,this.height=i.Height}update(t){let e=this.position;this.motion?.isOngoing()&&(this.position=this.motion.getPosition(t)),e[0]>this.position[0]?this.direction="LEFT":e[0]<this.position[0]?this.direction="RIGHT":e[1]>this.position[1]?this.direction="FORWARD":e[1]<this.position[1]&&(this.direction="BACKWARD"),this.jas.setPosition(this.position[0],this.position[1]),this.jas.play(this.motion?.isOngoing()?"RUN_"+this.direction:"IDLE_"+this.direction,!0,!0),this.jas.update(t),this.motion?.update(t)}draw(){this.jas.draw()}moveAlong(t){this.motion=new Wr(t,this.speed)}}const Be={BACKGROUND:0,MIDDLE:1,FOREGROUND:2};class Gr extends k{constructor(){super(),this.map=new Ie,this.collisionMap=new Ie,this.layerBackground=new Yt(this.map,Be.BACKGROUND),this.layerMiddle=new Yt(this.map,Be.MIDDLE),this.layerForeground=new Yt(this.map,Be.FOREGROUND),this.controller=new kr,this.selectionRect=new qr}async onEnter(){await this.map.loadFromFile("./samples/tilemap/map.json"),await this.collisionMap.loadFromFile("./samples/tilemap/collision.json"),await this.controller.loadFromFile("./samples/tilemap/bernard.json"),this.controller.setPosition(this.map.getPositionX(6),this.map.getPositionY(16)),this.movePlayer(10,16),document.addEventListener("mousemove",t=>this.handleMouseMove(t)),document.addEventListener("click",()=>this.handleMouseClick())}update(t){let e=V.getWidth()*.5,i=this.map.getWidth()-V.getWidth()*.5,s=V.getHeight()*.5,r=this.map.getHeight()-V.getHeight()*.5;V.setCameraPosition(l.CLAMP(this.controller.getPositionX(),e,i),l.CLAMP(this.controller.getPositionY(),s,r)),this.layerBackground.update(t),this.layerMiddle.update(t),this.controller.update(t),this.layerForeground.update(t),this.selectionRect.update(t)}draw(){this.layerBackground.draw(),this.layerMiddle.draw(),this.controller.draw(),this.layerForeground.draw(),this.selectionRect.draw()}movePlayer(t,e){let i=this.collisionMap.getLocationCol(this.controller.getPositionX()),s=this.collisionMap.getLocationRow(this.controller.getPositionY()),r=this.collisionMap.getTileLayer(0),n=Hr.solve(r.getGrid(),r.getColumns(),[i,s],[t,e]);n&&this.controller.moveAlong(n.map(([o,h])=>[this.collisionMap.getPositionX(o+.5),this.collisionMap.getPositionY(h+.5)]))}handleMouseMove(t){let e=V.findWorldPosFromClientPos(t.clientX,t.clientY),i=this.collisionMap.getPositionX(this.collisionMap.getLocationCol(e[0])),s=this.collisionMap.getPositionY(this.collisionMap.getLocationRow(e[1]));this.selectionRect.setPosition(i,s)}handleMouseClick(){let t=this.collisionMap.getLocationCol(this.selectionRect.getPositionX()),e=this.collisionMap.getLocationRow(this.selectionRect.getPositionY());this.collisionMap.getTileLayer(0).getTile(t,e)!=1&&this.movePlayer(t,e)}}class qr extends ie{constructor(){super()}paint(){const t=V.getContext();t.fillStyle="rgba(225,225,225,0.5)",t.fillRect(0,0,16,16)}}class Yr{constructor(){this.variants={}}async loadFromData(t){for(const e in t.Variants)this.addVariant(e,t.Variants[e])}async loadFromFile(t){const e=await fetch(t);await this.loadFromData(await e.json())}addVariant(t,e){if(this.variants.hasOwnProperty(t))throw new Error("Player::addVariant: varloc already exist in variants dictionnary");this.variants[t]=e}removeVariant(t){if(!this.variants.hasOwnProperty(t))throw new Error("Player::removeVariant: varloc not exist in variants dictionnary");delete this.variants[t]}setVariant(t,e){if(!this.variants.hasOwnProperty(t))throw new Error("Player::setVariant: varloc not exist in variants dictionnary");this.variants[t]=e}hasVariant(t){return this.variants.hasOwnProperty(t)}getVariant(t){if(!this.variants.hasOwnProperty(t))throw new Error("Player::getVariant: varloc not exist in variants dictionnary");return this.variants[t]}}class ss extends H{animations;currentAnimation;currentAnimationFrameIndex;isLooped;timeElapsed;constructor(t={}){super({className:t.className??"UISprite"}),this.animations=[],this.currentAnimation=null,this.currentAnimationFrameIndex=0,this.isLooped=!1,this.timeElapsed=0}update(t){if(!this.currentAnimation)return;const e=this.currentAnimation.frames[this.currentAnimationFrameIndex];this.node.style.backgroundPositionX=-e.x+"px",this.node.style.backgroundPositionY=-e.y+"px",this.node.style.width=e.width+"px",this.node.style.height=e.height+"px",this.timeElapsed>=this.currentAnimation.frameDuration?this.currentAnimationFrameIndex==this.currentAnimation.frames.length-1?(u.emit(this,"E_FINISHED"),this.currentAnimationFrameIndex=this.isLooped?0:this.currentAnimation.frames.length-1,this.timeElapsed=0):(this.currentAnimationFrameIndex=this.currentAnimationFrameIndex+1,this.timeElapsed=0):this.timeElapsed+=t}async loadTexture(t){return new Promise(e=>{const i=new Image;i.src=t,i.onload=()=>{this.node.style.backgroundImage='url("'+i.src+'")',e()}})}async loadFromFile(t){const i=await(await fetch(t)).json();this.animations=[];for(const s of i.Animations){const r={name:s.Name,frames:[],frameDuration:parseInt(s.FrameDuration)};for(const n of s.Frames)r.frames.push({x:n.X,y:n.Y,width:n.Width,height:n.Height});this.animations.push(r)}this.currentAnimation=null,this.currentAnimationFrameIndex=0,this.timeElapsed=0}play(t,e=!1,i=!1){if(i&&this.currentAnimation&&t==this.currentAnimation.name)return;const s=this.animations.find(r=>r.name==t);if(!s)throw new Error("UISprite::play: animation not found.");this.currentAnimation=s,this.currentAnimationFrameIndex=0,this.isLooped=e,this.timeElapsed=0}getAnimations(){return this.animations}setAnimations(t){this.animations=t}getCurrentAnimation(){return this.currentAnimation}getCurrentAnimationFrameIndex(){return this.currentAnimationFrameIndex}}const he={LEFT:"LEFT",RIGHT:"RIGHT",CENTER:"CENTER",MIDDLE:"MIDDLE"};class Ve extends ss{constructor(){super({className:"UIAvatar"})}changeLocation(t){t==he.MIDDLE?this.node.classList.add("u-middle"):t==he.LEFT?this.node.classList.add("u-left"):t==he.CENTER?this.node.classList.add("u-center"):t==he.RIGHT&&this.node.classList.add("u-right")}}class Ue extends ss{constructor(){super({className:"UIBackground"})}}class Xr extends k{constructor(){super(),this.player=new Yr,this.scriptMachine=new Ke}async onEnter(){this.scriptMachine.registerCommand("LOAD_SCRIPT",this.$loadScript.bind(this)),this.scriptMachine.registerCommand("WAITPAD",this.$waitPad.bind(this)),this.scriptMachine.registerCommand("GOTO",this.$goto.bind(this)),this.scriptMachine.registerCommand("GOTO_IF",this.$gotoIf.bind(this)),this.scriptMachine.registerCommand("EXEC_IF",this.$execIf.bind(this)),this.scriptMachine.registerCommand("VAR_SET",this.$varSet.bind(this)),this.scriptMachine.registerCommand("VAR_ADD",this.$varAdd.bind(this)),this.scriptMachine.registerCommand("VAR_SUB",this.$varSub.bind(this)),this.scriptMachine.registerCommand("DELAY",this.$delay.bind(this)),this.scriptMachine.registerCommand("UI_CREATE_DIALOG",this.$uiCreateDialog.bind(this)),this.scriptMachine.registerCommand("UI_CREATE_CHOICES",this.$uiCreateChoices.bind(this)),this.scriptMachine.registerCommand("UI_CREATE_AVATAR",this.$uiCreateAvatar.bind(this)),this.scriptMachine.registerCommand("UI_CREATE_BACKGROUND",this.$uiCreateBackground.bind(this)),this.scriptMachine.registerCommand("UI_PLAY_AVATAR",this.$uiPlayAvatar.bind(this)),this.scriptMachine.registerCommand("UI_PLAY_BACKGROUND",this.$uiPlayBackground.bind(this)),this.scriptMachine.registerCommand("UI_DESTROY_AVATAR",this.$uiDestroyAvatar.bind(this)),this.scriptMachine.registerCommand("UI_DESTROY_BACKGROUND",this.$uiDestroyBackground.bind(this)),this.scriptMachine.registerCommand("UI_FADE_IN",this.$uiFadeIn.bind(this)),this.scriptMachine.registerCommand("UI_FADE_OUT",this.$uiFadeOut.bind(this)),await this.player.loadFromFile("./samples/visual-novel/player.json"),await this.$loadScript("./samples/visual-novel/scene00.jsc")}update(t){this.scriptMachine.update(t)}async $loadScript(t){await this.scriptMachine.loadFromFile(t),this.scriptMachine.jump("ON_INIT"),this.scriptMachine.setEnabled(!0)}$waitPad(){this.scriptMachine.setEnabled(!1),document.addEventListener("keydown",t=>t.key=="Enter"?this.scriptMachine.setEnabled(!0):"",{once:!0})}$goto(t){return t}$gotoIf(t,e,i,s){if(Ii(this.player.getVariant(t),e,i))return s}$execIf(t,e,i,s={CommandName,CommandArgs}){Ii(this.player.getVariant(t),e,i)&&this.scriptMachine.runCommand(s.CommandName,s.CommandArgs)}$varSet(t,e){this.player.setVariant(t,e)}$varAdd(t,e){let i=this.player.getVariant(t);player.setVariant(t,i+e)}$varSub(t,e){let i=this.player.getVariant(t);player.setVariant(t,i-e)}$delay(t){this.scriptMachine.setEnabled(!1),window.setTimeout(()=>this.scriptMachine.setEnabled(!0),t)}async $uiCreateDialog(t,e){this.scriptMachine.setEnabled(!1);let i=new Ge;i.setAuthor(t),i.setText(e),p.addWidget(i),p.focus(i),await u.wait(i,"E_OK"),p.removeWidget(i),this.scriptMachine.setEnabled(!0)}async $uiCreateChoices(t,e,i=[]){this.scriptMachine.setEnabled(!1);let s=new Ge;s.setAuthor(t),s.setText(e),p.addWidget(s),await u.wait(s,"E_PRINT_FINISHED");let r=new it;p.addWidget(r,"position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); z-index:12");for(let o of i)r.add(0,o.Text);p.focus(r);let n=await u.wait(r,"E_ITEM_SELECTED");p.removeWidget(s),p.removeWidget(r),this.scriptMachine.jump(i[n.index].Jumpto),this.scriptMachine.setEnabled(!0)}async $uiCreateAvatar(t,e,i,s,r,n){this.scriptMachine.setEnabled(!1);let o=new Ve;o.changeLocation(r),await o.loadTexture(t),await o.loadFromFile(e),o.animate(n),o.play(i,s),p.addWidget(o),await u.wait(o,"E_ANIMATION_FINISHED"),this.scriptMachine.setEnabled(!0)}async $uiCreateBackground(t,e,i,s,r){this.scriptMachine.setEnabled(!1);let n=new Ue;await n.loadTexture(t),await n.loadFromFile(e),n.animate(r),n.play(i,s),p.addWidget(n),await u.wait(n,"E_ANIMATION_FINISHED"),this.scriptMachine.setEnabled(!0)}async $uiDestroyAvatar(t,e){this.scriptMachine.setEnabled(!1);let s=p.getWidgets().filter(r=>r instanceof Ve).at(t);s.animate(e),await u.wait(s,"E_ANIMATION_FINISHED"),p.removeWidget(s),this.scriptMachine.setEnabled(!0)}async $uiDestroyBackground(t,e){this.scriptMachine.setEnabled(!1);let s=p.getWidgets().filter(r=>r instanceof Ue).at(t);s.animate(e),await u.wait(s,"E_ANIMATION_FINISHED"),p.removeWidget(s),this.scriptMachine.setEnabled(!0)}$uiPlayAvatar(t,e,i){p.getWidgets().filter(n=>n instanceof Ve)[t].play(e,i)}$uiPlayBackground(t,e,i){p.getWidgets().filter(n=>n instanceof Ue)[t].play(e,i)}async $uiFadeIn(t,e,i){this.scriptMachine.setEnabled(!1),p.fadeIn(t,e,i,()=>this.scriptMachine.setEnabled(!0))}async $uiFadeOut(t,e,i){this.scriptMachine.setEnabled(!1),p.fadeOut(t,e,i,()=>this.scriptMachine.setEnabled(!0))}}function Ii(a,t,e){return t=="not equal"&&a!=e||t=="equal"&&a==e||t=="is less than"&&a<e||t=="is greater than"&&a>e}let dt={BLACK:"BLACK",WHITE:"WHITE"},we={PAWN:"PAWN",QUEEN:"QUEEN"},Qe={DARK:"DARK",LIGHT:"LIGHT",WATER:"WATER",FIRE:"FIRE"},Xt={DOUBLE_MOVE:"DOUBLE_MOVE",KILL:"KILL"};class rt{constructor(t={}){this.path=t.path??[[1,0]],this.numCapture=t.numCapture??0,this.mustCapture=t.mustCapture??!0,this.chainable=t.chainable??!0,this.collateCapturable=t.collateCapturable??!1}getPath(){return this.path}hasVector(t){return this.path.find(e=>t[0]==e[0]&&t[1]==e[1])}getVector(t){return this.path[t]}getPathLength(){return this.path.length}getNumCapture(){return this.numCapture}isForceCapture(){return this.mustCapture}isChainable(){return this.chainable}isCollateCapturable(){return this.collateCapturable}}let zr=[[1,1]],Zr=[[-1,1]],Kr=[[1,-1]],Qr=[[-1,-1]],$r=[[1,1],[2,2]],Jr=[[-1,1],[-2,2]],tn=[[1,-1],[2,-2]],en=[[-1,-1],[-2,-2]],Ai=[[1,1],[2,2],[3,3],[4,4],[5,5],[6,6],[7,7],[8,8],[9,9]],Ti=[[-1,1],[-2,2],[-3,3],[-4,4],[-5,5],[-6,6],[-7,7],[-8,8],[-9,9]],Si=[[1,-1],[2,-2],[3,-3],[4,-4],[5,-5],[6,-6],[7,-7],[8,-8],[9,-9]],yi=[[-1,-1],[-2,-2],[-3,-3],[-4,-4],[-5,-5],[-6,-6],[-7,-7],[-8,-8],[-9,-9]];class rs{constructor(t={}){this.color=t.color??dt.BLACK,this.type=t.type??we.PAWN,this.element=t.element??Qe.WATER,this.powerupId=t.powerupId??"",this.moves=t.moves??[]}getColor(){return this.color}setColor(t){this.color=t}getType(){return this.type}setType(t){this.type=t}getElement(){return this.element}setElement(t){this.element=t}getPowerupId(){return this.powerupId}setPowerupId(t){this.powerupId=t}getMoves(){return this.moves}}class xi extends rs{constructor(t){super({color:t,type:we.PAWN,element:Qe.DARK,powerupId:Xt.KILL,moves:[new rt({path:t==dt.BLACK?zr:Kr,numCapture:0,mustCapture:!1,chainable:!1}),new rt({path:t==dt.BLACK?Zr:Qr,numCapture:0,mustCapture:!1,chainable:!1}),new rt({path:$r,numCapture:1,mustCapture:!0,chainable:!0}),new rt({path:Jr,numCapture:1,mustCapture:!0,chainable:!0}),new rt({path:tn,numCapture:1,mustCapture:!0,chainable:!0}),new rt({path:en,numCapture:1,mustCapture:!0,chainable:!0})]})}}class sn extends rs{constructor(t){super({color:t,type:we.QUEEN,element:Qe.DARK,powerupId:Xt.DOUBLE_MOVE,moves:[new rt({path:Ai,numCapture:0,mustCapture:!1,chainable:!1}),new rt({path:Ti,numCapture:0,mustCapture:!1,chainable:!1}),new rt({path:Si,numCapture:0,mustCapture:!1,chainable:!1}),new rt({path:yi,numCapture:0,mustCapture:!1,chainable:!1}),new rt({path:Ai,numCapture:1,mustCapture:!0,chainable:!0}),new rt({path:Ti,numCapture:1,mustCapture:!0,chainable:!0}),new rt({path:Si,numCapture:1,mustCapture:!0,chainable:!0}),new rt({path:yi,numCapture:1,mustCapture:!0,chainable:!0})]})}}class He{constructor(t=null,e=null){this.piece=t,this.element=e}getPiece(){return this.piece}setPiece(t){this.piece=t}getElement(){return this.element}setElement(t){this.element=t}}class rn{constructor(){this.rows=10,this.cols=10,this.tiles=[],this.mustCapture=!0;for(let t=0;t<this.rows;t++){this.tiles[t]=[];for(let e=0;e<this.cols;e++)t<4&&(e+t)%2?this.tiles[t][e]=new He(new xi(dt.BLACK)):t>5&&(e+t)%2?this.tiles[t][e]=new He(new xi(dt.WHITE)):this.tiles[t][e]=new He}}getRows(){return this.rows}getCols(){return this.cols}getTile(t){return this.tiles[t[1]][t[0]]}getPiece(t){return this.tiles[t[1]][t[0]].getPiece()}isValidCoord(t){return t[0]<this.cols&&t[0]>=0&&t[1]<this.rows&&t[1]>=0}findPossiblePoints(t,e=!1){let i=[],s=this.tiles[t[1]][t[0]].getPiece();for(let n of s.getMoves()){if(e&&!n.isChainable())continue;let o=0,h=null;for(let c of n.getPath()){let d=t[0]+c[0],f=t[1]+c[1];if(!this.isValidCoord([d,f]))break;let g=this.tiles[f][d].getPiece(),E=this.tiles[f][d].getElement(),I=E&&E!=s.getElement(),S=g&&g.getColor()!=s.getColor()&&h&&h.getColor()!=s.getColor()&&!n.isCollateCapturable(),y=g&&g.getColor()==s.getColor();if(I||S||y)break;g&&g.getColor()!=s.getColor()&&o++,!g&&n.getNumCapture()==o&&i.push({x:d,y:f,mustCapture:n.isForceCapture()}),h=g}}let r=!!i.find(n=>n.mustCapture);return i.filter(n=>r==n.mustCapture)}findMovableCoords(t){let e=[],i=[];for(let s=0;s<this.rows;s++)for(let r=0;r<this.cols;r++){let n=this.tiles[s][r].getPiece();if(!n||n.getColor()!=t)continue;let o=this.findPossiblePoints([r,s]);o.length!=0&&(o.find(h=>h.mustCapture)?e.push([r,s]):i.push([r,s]))}return this.mustCapture&&e.length>0?e:[...i,...e]}}class ns{constructor(t,e=""){this.game=t,this.id=e}getId(){return this.id}async onActive(){}}class nn extends ns{constructor(t){super(t,Xt.DOUBLE_MOVE),this.board=this.game.getBoard()}async onActive(){let t=await this.game.operationRequestTileLocation(!0,(s,r)=>{let n=this.board.getPiece([s,r]);return n&&n.getColor()==this.game.getCurrentPlayer()}),e=this.board.findPossiblePoints([t.x,t.y]),i=await this.game.operationRequestTileLocation(!1,(s,r)=>e.find(n=>n.x==s&&n.y==r));await this.game.operationMove([t.x,t.y],[i.x,i.y]),this.game.operationRequestTileAction()}}class on extends ns{constructor(t){super(t,Xt.KILL),this.board=this.game.getBoard()}async onActive(){let t=await this.game.operationRequestTileLocation(!0,(e,i)=>{let s=this.board.getPiece([e,i]);return s&&s.getColor()!=this.game.getCurrentPlayer()});await this.game.operationKill([t.x,t.y]),this.game.operationNewTurn()}}class an{static create(t,e){if(e==Xt.DOUBLE_MOVE)return new nn(t);if(e==Xt.KILL)return new on(t)}}class hn{constructor(){this.board=new rn,this.currentPlayer=dt.BLACK}getBoard(){return this.board}getCurrentPlayer(){return this.currentPlayer}startup(){this.operationNewTurn()}async operationNewTurn(){let t=this.currentPlayer==dt.BLACK?this.board.getRows()-1:0;for(let e=0;e<this.board.getCols();e++){let i=this.board.getTile([e,t]),s=i.getPiece();s&&s.getColor()==this.currentPlayer&&s.getType()==we.PAWN&&i.setPiece(new sn(s.getColor()))}this.currentPlayer=this.currentPlayer==dt.BLACK?dt.WHITE:dt.BLACK,await this.operationRequestTileAction()}async operationRequestTileAction(){let t={};return t.x=0,t.y=0,t.action="",await u.emit(this,"E_REQUEST_TILE_ACTION",{response:t}),t}async operationRequestTileLocation(t=!1,e=()=>!0){let i={};return i.x=0,i.y=0,i.canceled=!1,await u.emit(this,"E_REQUEST_TILE_LOCATION",{required:t,predicateTile:e,response:i}),i}operationKill(t){this.board.getTile(t).setPiece(null)}async operationPowerup(t){let e=this.board.getPiece(t);await an.create(this,e.getPowerupId()).onActive(),e.setPowerupId("")}async operationMove(t,e){let i=this.board.getTile(t),s=this.board.getTile(e),r=i.getPiece(),n=r.getMoves();i.setPiece(null),s.setPiece(r);let o=n.find(c=>c.hasVector(l.VEC2_SUBSTRACT(e,t)));for(let c of o.getPath()){let d=l.VEC2_ADD(t,c);if(l.VEC2_ISEQUAL(d,e))break;let f=this.board.getTile(d),g=f.getPiece();g&&g.getColor()!=r.getColor()&&f.setPiece(null)}let h=this.board.findPossiblePoints(e,!0);if(o.isChainable()&&h.length>0){let c=await this.operationRequestTileLocation(!0,(d,f)=>h.find(g=>g.x==d&&g.y==f));await this.operationMove(e,[c.x,c.y]);return}}}class os{constructor(t,e){this.game=t,this.coordFrom=e}async exec(){return!0}isConditionCheck(){return!0}}class ln extends os{constructor(t,e){super(t,e),this.board=this.game.getBoard()}async exec(){let t=this.board.findPossiblePoints(this.coordFrom),e=await this.game.operationRequestTileLocation(!1,(i,s)=>t.find(r=>r.x==i&&r.y==s));if(e.canceled)return await this.game.operationRequestTileAction(),!1;await this.game.operationMove(this.coordFrom,[e.x,e.y]),this.game.operationNewTurn()}isConditionCheck(){return this.board.findMovableCoords(this.game.getCurrentPlayer()).find(e=>e[0]==this.coordFrom[0]&&e[1]==this.coordFrom[1])}}class cn extends os{constructor(t,e){super(t,e),this.board=this.game.getBoard()}async exec(){await this.game.operationPowerup(this.coordFrom)}isConditionCheck(){let t=this.board.getPiece(this.coordFrom);return!(!t||t.getColor()!=this.game.getCurrentPlayer()||!t.getPowerupId())}}class je{static create(t,e,i){if(t=="MOVE")return new ln(e,i);if(t=="POWERUP")return new cn(e,i)}}let un={BLACK_PAWN:"./samples/checker/black_pawn.png",BLACK_QUEEN:"./samples/checker/black_queen.png",WHITE_PAWN:"./samples/checker/white_pawn.png",WHITE_QUEEN:"./samples/checker/white_queen.png"};class dn extends H{constructor(){super({className:"UIPiece",template:`
      <div class="UIPiece-bg js-bg"></div>`}),this.piece=null}update(){this.piece?this.node.querySelector(".js-bg").style.backgroundImage=`url(${un[this.piece.getColor()+"_"+this.piece.getType()]})`:this.node.querySelector(".js-bg").style.backgroundImage=""}setPiece(t){this.piece=t||null}}let pn={DARK:"./assets/textures/tile_dark.png",LIGHT:"./assets/textures/tile_light.png",FIRE:"./assets/textures/tile_fire.png",WATER:"./assets/textures/tile_water.png"};class fn extends H{constructor(t={}){super({className:"UITile",template:`
      <div class="UITile-bg js-bg"></div>
      <div class="UITile-piece js-piece"></div>
      <div class="UITile-actions js-actions"></div>`}),this.tile=null,this.selectable=!1,this.uiPiece=new dn,this.node.classList.add(t.color=="white"?"UITile--white":"UITile--black"),this.node.querySelector(".js-piece").replaceWith(this.uiPiece.node),this.node.addEventListener("click",e=>{e.stopPropagation(),this.handleClicked()})}update(t){this.tile?(this.node.querySelector(".js-bg").style.backgroundImage=`url(${pn[this.tile.getElement()]??""})`,this.uiPiece.setPiece(this.tile.getPiece())):this.node.querySelector(".js-bg").style.backgroundImage="",this.uiPiece.update(t)}delete(){this.uiPiece.delete(),super.delete()}setTile(t){this.tile=t||null}isSelectable(){return this.selectable}setSelectable(t){this.node.classList.toggle("u-selectable",t),this.selectable=t}addAction(t){let e=document.createElement("div");e.className="UITile-actions-item",e.textContent=t,e.id=t,this.node.querySelector(".js-actions").appendChild(e),e.addEventListener("click",i=>{i.stopPropagation(),this.handleActionClicked(t)})}clearActions(){let t=this.node.querySelector(".js-actions");for(;t.firstChild;)t.removeChild(t.firstChild)}handleClicked(){u.emit(this,"E_CLICKED")}handleActionClicked(t){u.emit(this,"E_ACTION",{action:t})}}class mn extends H{constructor(){super({className:"UICheckerBoard"}),this.board=null,this.uiTiles=[]}update(t){for(let e of this.uiTiles)e.update(t)}delete(){for(let t of this.uiTiles)u.unsubscribe(t,"E_CLICKED",this),u.unsubscribe(t,"E_ACTION",this),t.delete();super.delete()}setBoard(t){for(let e of this.uiTiles)u.unsubscribe(e,"E_CLICKED",this),u.unsubscribe(e,"E_ACTION",this),e.delete();if(this.uiTiles=[],t){for(let e=0;e<t.getRows();e++)for(let i=0;i<t.getCols();i++){let s=new fn({color:(i+e)%2==0?"white":"black"});u.subscribe(s,"E_CLICKED",this,r=>this.handleTileClicked(i,e)),u.subscribe(s,"E_ACTION",this,r=>this.handleTileAction(i,e,r.action)),s.setTile(t.getTile([i,e])),this.node.appendChild(s.node),this.uiTiles.push(s)}this.board=t}else this.board=null}getUITiles(){return this.uiTiles}getUITile(t){return this.uiTiles[t[0]+t[1]*this.board.getCols()]}clearActions(){for(let t of this.uiTiles)t.setSelectable(!1),t.clearActions()}clearSelectable(){for(let t of this.uiTiles)t.setSelectable(!1)}handleTileClicked(t,e){u.emit(this,"E_TILE_CLICKED",{coord:[t,e]})}handleTileAction(t,e,i){u.emit(this,"E_TILE_ACTION",{coord:[t,e],action:i})}onKeyDownOnce(t){t.key==GWE.InputKeyEnum.CANCEL&&u.emit(this,"E_ECHAP_PRESSED")}}class gn extends k{constructor(){super(),this.game=null,this.board=null,this.uiTitle=null,this.uiBoard=null}update(){this.uiTitle.textContent=`AU TOUR DES ${this.game.getCurrentPlayer()==dt.BLACK?"NOIRS":"BLANCS"} DE JOUER`}async onEnter(){this.game=new hn,this.board=this.game.getBoard(),this.uiTitle=document.createElement("div"),p.addNode(this.uiTitle,"position:absolute; top: 10%; left: 50%; transform: translateX(-50%)"),this.uiBoard=new mn,this.uiBoard.setBoard(this.board),p.addWidget(this.uiBoard,"position: absolute;inset: 0px;top: 50%;left: 50%;width: 400px;height: 400px;transform: translate(-50%, -50%)"),p.focus(this.uiBoard),u.subscribe(this.game,"E_REQUEST_TILE_ACTION",this,this.handleGameRequestTileAction),u.subscribe(this.game,"E_REQUEST_TILE_LOCATION",this,this.handleGameRequestTileLocation),this.game.startup()}handleGameRequestTileAction(t){return new Promise(e=>{u.subscribe(this.uiBoard,"E_TILE_CLICKED",this,i=>{this.uiBoard.clearActions();let s=this.uiBoard.getUITile(i.coord);je.create("MOVE",this.game,i.coord).isConditionCheck()&&s.addAction("MOVE"),je.create("POWERUP",this.game,i.coord).isConditionCheck()&&s.addAction("POWERUP")}),u.subscribe(this.uiBoard,"E_TILE_ACTION",this,async i=>{u.unsubscribe(this.uiBoard,"E_TILE_CLICKED",this),u.unsubscribe(this.uiBoard,"E_TILE_ACTION",this),this.uiBoard.getUITile(i.coord).clearActions(),je.create(i.action,this.game,i.coord).exec().then(()=>e())})})}handleGameRequestTileLocation({required:t,predicateTile:e,response:i}){return new Promise(s=>{for(let r=0;r<this.board.getRows();r++)for(let n=0;n<this.board.getCols();n++)e(n,r)&&this.uiBoard.getUITile([n,r]).setSelectable(!0);t||u.subscribe(this.uiBoard,"E_ECHAP_PRESSED",this,()=>{u.unsubscribe(this.uiBoard,"E_ECHAP_PRESSED",this),u.unsubscribe(this.uiBoard,"E_TILE_CLICKED",this),this.uiBoard.clearSelectable(),i.canceled=!0,s()}),u.subscribe(this.uiBoard,"E_TILE_CLICKED",this,r=>{this.uiBoard.getUITile(r.coord).isSelectable()&&(u.unsubscribe(this.uiBoard,"E_ECHAP_PRESSED",this),u.unsubscribe(this.uiBoard,"E_TILE_CLICKED",this),this.uiBoard.clearSelectable(),i.canceled=!1,i.x=r.coord[0],i.y=r.coord[1],s())})})}}const Mi=6;let ut={DRAW:"DRAW",MAIN:"MAIN",BATTLE:"BATTLE",END:"END"},C={ONFIELD:"ONFIELD",FZONE:"FZONE",MZONE:"MZONE",SZONE:"SZONE",GRAVEYARD:"GRAVEYARD",BANNISHED:"BANNISHED",DECK:"DECK",HAND:"HAND"},D={MONSTER:"MONSTER",SPELL:"SPELL"},et={ATTACK:"ATTACK",DEFENSE:"DEFENSE",FACEUP:"FACEUP",FACEDOWN:"FACEDOWN"},Rt={DARK:"DARK",LIGHT:"LIGHT",EARTH:"EARTH",WIND:"WIND",FIRE:"FIRE",WATER:"WATER",DIVINE:"DIVINE"},U={AQUA:"AQUA",BEAST:"BEAST",BEAST_WARRIOR:"BEAST_WARRIOR",DINOSAUR:"DINOSAUR",FAIRY:"FAIRY",FIEND:"FIEND",FISH:"FISH",INSECT:"INSECT",MACHINE:"MACHINE",PLANT:"PLANT",PSYCHIC:"PSYCHIC",PYRO:"PYRO",REPTILE:"REPTILE",SEASERPENT:"SEASERPENT",SPELLCASTER:"SPELLCASTER",THUNDER:"THUNDER",WARRIOR:"WARRIOR",WINGEDBEAST:"WINGEDBEAST",ZOMBIE:"ZOMBIE",WYRM:"WYRM",DRAGON:"DRAGON",DIVINEBEAST:"DIVINEBEAST",CREATORGOD:"CREATORGOD",CYBERSE:"CYBERSE"},Ae={ACTIVATE:"ACTIVATE",TRIGGER:"TRIGGER"},Qt={NORMAL:"NORMAL",CONTINUOUS:"CONTINUOUS"},Kt={SINGLE:"SINGLE",FIELD:"FIELD",NONE:"NONE"};class as{constructor(t){this.map=t,this.modifiers=[]}get(t){if(!this.map.hasOwnProperty(t))return;let e=this.map[t];for(let i of this.modifiers)i.getAttributeKey()==t&&i.getType()=="MUL"&&(e*=i.getValue());for(let i of this.modifiers)i.getAttributeKey()==t&&i.getType()=="ADD"&&(e+=i.getValue());for(let i of this.modifiers)i.getAttributeKey()==t&&i.getType()=="SUB"&&(e-=i.getValue());for(let i of this.modifiers)i.getAttributeKey()==t&&i.getType()=="SET"&&(e=i.getValue());for(let i of this.modifiers)i.getAttributeKey()==t&&i.getType()=="FIN"&&(e=i.getValue());return e<0&&(e=0),this.map.hasOwnProperty(t+"_MIN")&&(e=Math.max(e,this.map[t+"_MIN"])),this.map.hasOwnProperty(t+"_MAX")&&(e=Math.min(e,this.map[t+"_MAX"])),e}getBase(t){if(!!this.map.hasOwnProperty(t))return this.map[t]}set(t,e){!this.map.hasOwnProperty(t)||(e<0&&(e=0),this.map.hasOwnProperty(t+"_MIN")&&(e=Math.max(e,this.map[t+"_MIN"])),this.map.hasOwnProperty(t+"_MAX")&&(e=Math.min(e,this.map[t+"_MAX"])),this.map[t]=e)}add(t,e){this.set(t,this.getBase(t)+e)}has(t){return this.map.hasOwnProperty(t)}addModifier(t){if(!t.isStackable()&&this.modifiers.find(e=>e.getId()==t.getId()))return!1;this.modifiers.push(t)}removeModifier(t){this.modifiers.splice(this.modifiers.indexOf(t),1)}removeModifierIf(t){for(let e of this.modifiers)t(e)&&this.modifiers.splice(this.modifiers.indexOf(e),1)}clearModifiers(){for(;this.modifiers.length;)this.modifiers.pop()}}class hs{constructor(){this.id="",this.type="",this.name="",this.text="",this.coverFile="",this.attributes,this.owner=0,this.controler=0,this.position="",this.location=C.DECK,this.turnCounter=0}async loadFromData(t){this.id=t.Id,this.type=t.Type,this.name=t.Name,this.text=t.Text,this.coverFile=t.CoverFile,this.attributes=new as(t.Attributes)}getId(){return this.id}getType(){return this.type}getName(){return this.name}getText(){return this.text}getCoverFile(){return this.coverFile}getAttributes(){return this.attributes}getAttribute(t){return this.attributes.get(t)}getOwner(){return this.owner}setOwner(t){this.owner=t}getControler(){return this.controler}setControler(t){this.controler=t}getPosition(){return this.position}setPosition(t){this.position=t}getLocation(){return this.location}setLocation(t){this.location=t}getTurnCounter(){return this.turnCounter}incTurnCounter(){this.turnCounter++}setAttribute(t,e){this.attributes.set(t,e)}incAttribute(t){this.attributes.set(t,this.attributes.get(t)+1)}isSummonable(t){return!1}isSetable(t){return!1}isCapableAttack(t){return!1}isCapableChangePosition(t){return!1}isActiveatable(t){return!1}isTriggerable(t,e){return!1}}class En extends hs{constructor(){super()}async loadFromFile(t){let e=await fetch(t);await this.loadFromData(await e.json())}isSummonable(){return this.location==C.HAND}isCapableAttack(){return!(this.location!=C.MZONE||this.position!=et.ATTACK||this.attributes.get("ATK_COUNT")>=this.attributes.get("ATK_COUNT_LIMIT"))}isCapableChangePosition(){return this.attributes.get("STATE_FREEZE")!=1}}let ve={};ve.IS_ENDLESS=function(a,t={}){return!1};ve.HAS_CARD_ID=function(a,t={targetRange,cardId}){let e=a.utilsQuery(a.getCurrentDuelistIndex(),t.targetRange,i=>i);for(let i of e)if(i.getId()==t.cardId)return!0;return!1};ve.HAS_CARD_TYPE=function(a,t={targetRange,cardType}){let e=a.utilsQuery(a.getCurrentDuelistIndex(),t.targetRange,i=>i);for(let i of e)if(i.getType()==t.cardType)return!0;return!1};function Xe(a,t,e={}){return a==""?!0:ve[a](t,e)}let ls={};ls.IS_EFFECT_CARD_MODIFIER_SET_STATE_FREEZE=function(a,t,e,i={}){return e instanceof ActivateEffectInternalAction&&e.effect.mechanicId=="ADD_CARD_MODIFIER"&&e.effect.mechanicOpts.modifierData.Type=="SET"&&e.effect.mechanicOpts.modifierData.AttributeKey=="STATE_FREEZE"&&e.effect.mechanicOpts.modifierData.Value==1};function Cn(a,t,e,i,s={}){return a==""?!0:ls[a](t,e,i,s)}class cs{constructor(){this.id="",this.type="",this.attributeKey="",this.value=0,this.stackable=!1,this.linked=!1,this.linkedEffect=null}async loadFromData(t){this.id=t.Type+"_"+t.AttributeKey,this.type=t.Type,this.attributeKey=t.AttributeKey,this.value=t.Value,this.stackable=t.Stackable,this.linked=t.Linked}getId(){return this.id}getType(){return this.type}getAttributeKey(){return this.attributeKey}getValue(){return this.value}isStackable(){return this.stackable}isLinked(){return this.linked}getLinkedEffect(){return this.linkedEffect}setLinkedEffect(t){this.linkedEffect=t}}let mt={};mt.NEW_TURN=async function(a,t,e,i,s={}){await a.operationNewTurn()};mt.DRAW=async function(a,t,e,i,s={numCards}){await a.operationDraw(t.getControler(),s.numCards)};mt.CHANGE_PHASE=async function(a,t,e,i,s={phaseId}){await a.operationChangePhase(s.phaseId)};mt.DAMAGE_SELF=async function(a,t,e,i,s={amount}){await a.operationDamage(t.getControler(),s.amount)};mt.DAMAGE_OPPONENT=async function(a,t,e,i,s={amount}){await a.operationDamage(us(t.getControler()),s.amount)};mt.RESTORE_SELF=async function(a,t,e,i,s={amount}){await a.operationRestore(t.getControler(),s.amount)};mt.RESTORE_OPPONENT=async function(a,t,e,i,s={amount}){await a.operationRestore(us(t.getControler()),s.amount)};mt.DESTROY=async function(a,t,e,i,s={}){await a.operationDestroy(i)};mt.ADD_MODIFIER_TO_SELF=async function(a,t,e,i,s={modifierData}){let r=new cs;await r.loadFromData(s.modifierData),r.setLinkedEffect(r.isLinked()?e:null),await a.operationAddDuelistModifier(t.getControler(),r)};mt.ADD_CARD_MODIFIER=async function(a,t,e,i,s={modifierData}){let r=new cs;await r.loadFromData(s.modifierData),r.setLinkedEffect(r.isLinked()?e:null),await a.operationAddCardModifier(i,r)};const us=a=>a==0?1:0;let be={};be.IS_RACE=function(a,t={race}){return a.getAttribute("RACE")==t.race};be.IS_TYPE=function(a,t={type}){return a.getType()==t.type};be.IS_ID=function(a,t={id}){return a.getId()==t.id};function vt(a,t,e={}){return a==""?!0:be[a](t,e)}class In{constructor(t){this.card=t,this.targetType="",this.targetRange="",this.targetCardConditionId="",this.targetCardConditionOpts={},this.mechanicId="",this.mechanicOpts={},this.targetCards=[]}async loadFromData(t){this.targetType=t.TargetType,this.targetRange=t.TargetRange,this.targetCardConditionId=t.TargetCardConditionId,this.targetCardConditionOpts=t.TargetCardConditionOpts,this.mechanicId=t.MechanicId,this.mechanicOpts=t.MechanicOpts}getTargetType(){return this.targetType}getTargetRange(){return this.targetRange}getTargetCards(){return this.targetCards}isPresentTarget(t){return t.utilsQuery(this.card.getControler(),this.targetRange,i=>i&&vt(this.targetCardConditionId,i,this.targetCardConditionOpts)).length!=0}isTarget(t,e){let i=t.utilsQuery(this.card.getControler(),this.targetRange,s=>s&&vt(this.targetCardConditionId,s,this.targetCardConditionOpts));return i.length==0?!1:i.includes(e)}hasTargetCard(t){return this.targetCards.indexOf(t)!=-1}addTargetCard(t){this.targetCards.push(t)}removeTargetCard(t){this.targetCards.splice(this.targetCards.indexOf(t),1)}apply(t,e,i){let s=mt[this.mechanicId];s(t,e,this,i,this.mechanicOpts)}}class An extends hs{constructor(){super(),this.mode="",this.nature="",this.activateConditionId="",this.activateConditionOpts={},this.triggerConditionId="",this.triggerConditionOpts={},this.releaseConditionId="",this.releaseConditionOpts={},this.effects=[]}async loadFromData(t){this.mode=t.Mode,this.nature=t.Nature,t.hasOwnProperty("ActivateConditionId")&&(this.activateConditionId=t.ActivateConditionId,this.activateConditionOpts=t.ActivateConditionOpts),t.hasOwnProperty("TriggerConditionId")&&(this.triggerConditionId=t.TriggerConditionId,this.triggerConditionOpts=t.TriggerConditionOpts),t.hasOwnProperty("ReleaseConditionId")&&(this.releaseConditionId=t.ReleaseConditionId,this.releaseConditionOpts=t.ReleaseConditionOpts);for(let e of t.Effects){let i=new In(this);await i.loadFromData(e),this.effects.push(i)}super.loadFromData(t)}async loadFromFile(t){let e=await fetch(t);await this.loadFromData(await e.json())}getMode(){return this.mode}getNature(){return this.nature}getEffects(){return this.effects}isSetable(){return this.location==C.HAND}isActiveatable(t){if(this.mode!=Ae.ACTIVATE||this.location!=C.SZONE||this.position!=et.FACEDOWN)return!1;for(let e of this.effects)if(!e.isPresentTarget(t))return!1;return Xe(this.activateConditionId,t,this.activateConditionOpts)}isTriggerable(t,e){if(this.mode!=Ae.TRIGGER||this.location!=C.SZONE||this.position!=et.FACEDOWN)return!1;for(let i of this.effects)if(!i.isPresentTarget(t))return!1;return Cn(this.triggerConditionId,t,this,e,this.triggerConditionOpts)}isReleasable(t){return this.nature!=Qt.CONTINUOUS||this.location!=C.SZONE||this.position!=et.FACEUP?!1:Xe(this.releaseConditionId,t,this.releaseConditionOpts)}}class Tn{constructor(){this.cards=[]}async loadFromData(t){for(let e of t)if(e.startsWith("monster")){let i=new En;await i.loadFromFile("samples/ccg/data/cards/"+e+"/data.json"),this.cards.push(i)}else if(e.startsWith("spell")){let i=new An;await i.loadFromFile("samples/ccg/data/cards/"+e+"/data.json"),this.cards.push(i)}}getCards(){return this.cards}}class Dt extends Array{constructor(t){super(),this.location=t}getLocation(){return this.location}}class ds{constructor(){this.name="",this.pictureFile="",this.deck,this.attributes,this.zones=[];let t=new Dt(C.MZONE);t.push(null,null,null),this.zones.push(t);let e=new Dt(C.SZONE);e.push(null,null,null),this.zones.push(e);let i=new Dt(C.FZONE);i.push(null),this.zones.push(i),this.zones.push(new Dt(C.DECK)),this.zones.push(new Dt(C.GRAVEYARD)),this.zones.push(new Dt(C.BANNISHED)),this.zones.push(new Dt(C.HAND))}async loadFromData(t){this.name=t.Name,this.pictureFile=t.PictureFile,this.deck=new Tn,await this.deck.loadFromData(t.Deck),this.attributes=new as(t.Attributes)}getName(){return this.name}getPictureFile(){return this.pictureFile}getDeck(){return this.deck}getAttributes(){return this.attributes}getAttribute(t){return this.attributes.get(t)}setAttribute(t,e){this.attributes.set(t,e)}incAttribute(t){this.attributes.set(t,this.attributes.get(t)+1)}getZone(t){return this.zones.find(e=>e.getLocation()==t)}getCard(t,e){return this.zones.find(s=>s.getLocation()==t)[e]}insertCard(t,e,i){let s=this.zones.find(r=>r.getLocation()==t);s[e]=i}removeCard(t,e){let i=this.zones.find(s=>s.getLocation()==t);i.splice(i.indexOf(e),1)}pushCard(t,e){this.zones.find(s=>s.getLocation()==t).push(e)}popCard(t){return this.zones.find(i=>i.getLocation()==t).pop()}isCapableDraw(t){return!(t.getCurrentTurn().getCurrentPhase().getId()!=ut.DRAW||this.attributes.get("DRAW_COUNT")>=this.attributes.get("DRAW_COUNT_LIMIT"))}isCapableSummon(t){let i=t.getCurrentTurn().getCurrentPhase(),r=t.getDuelists().indexOf(this);return!(i.getId()!=ut.MAIN||this.attributes.get("STATE_CANNOT_SUMMON")==1||this.attributes.get("SUMMON_COUNT")>=this.attributes.get("SUMMON_COUNT_LIMIT")||t.utilsQuery(r,[[C.HAND],0],h=>h&&h.isSummonable()).length==0||t.utilsQuery(r,[[C.MZONE],0],h=>h==null).length==0)}isCapableSet(t){let i=t.getCurrentTurn().getCurrentPhase(),r=t.getDuelists().indexOf(this);return!(i.getId()!=ut.MAIN||this.attributes.get("STATE_CANNOT_SET")==1||t.utilsQuery(r,[[C.HAND],0],h=>h&&h.isSetable()).length==0||t.utilsQuery(r,[[C.SZONE],0],h=>h==null).length==0)}isCapableChangePosition(t){let i=t.getCurrentTurn().getCurrentPhase(),r=t.getDuelists().indexOf(this);return!(i.getId()!=ut.MAIN||t.utilsQuery(r,[[C.MZONE],[C.MZONE]],o=>o&&o.getControler()==r&&o.isCapableChangePosition()).length==0)}isCapableBattle(t){let i=t.getCurrentTurn().getCurrentPhase(),r=t.getDuelists().indexOf(this);return!(i.getId()!=ut.BATTLE||t.utilsQuery(r,[[C.MZONE],[C.MZONE]],o=>o&&o.getControler()==r&&o.isCapableAttack()).length==0)}isCapableActivate(t){let i=t.getCurrentTurn().getCurrentPhase(),r=t.getDuelists().indexOf(this);return!(i.getId()!=ut.MAIN||t.utilsQuery(r,[[C.SZONE],[C.SZONE]],o=>o&&o.getControler()==r&&o.isActiveatable(t)).length==0)}async selectLocation(t,e=()=>!0){}async selectRequiredLocation(t,e=()=>!0){}}class yt{constructor(t){this.duel=t,this.negate=!1}isNegate(){return this.negate}setNegate(t){this.negate=t}async exec(){return!0}}class $e extends yt{constructor(t,e){super(t),this.attackerCard=e}async exec(){await this.duel.operationDamage(this.duel.getOpponentDuelistIndex(),this.attackerCard.getAttribute("ATK")),await this.duel.operationIncCardAttribute(this.attackerCard,"ATK_COUNT")}}class ps extends yt{constructor(t){super(t)}async exec(){await this.duel.operationDraw(this.duel.getCurrentDuelistIndex(),1),await this.duel.operationIncDuelistAttribute(this.duel.getCurrentDuelistIndex(),"DRAW_COUNT")}}class fs extends yt{constructor(t,e,i){super(t),this.monsterCard=e,this.index=i}async exec(){await this.duel.operationSummon(this.monsterCard,this.index),await this.duel.operationIncDuelistAttribute(this.duel.getCurrentDuelistIndex(),"SUMMON_COUNT")}}class ms extends yt{constructor(t,e,i){super(t),this.spellCard=e,this.index=i}async exec(){await this.duel.operationSet(this.spellCard,this.index)}}class gs extends yt{constructor(t,e){super(t),this.monsterCard=e}async exec(){let t=this.monsterCard.getPosition()==et.ATTACK?et.DEFENSE:et.ATTACK;this.duel.operationChangePosition(this.monsterCard,t)}}class Es extends yt{constructor(t,e,i){super(t),this.attackerCard=e,this.targetCard=i}async exec(){this.targetCard?(await this.duel.operationBattle(this.attackerCard,this.targetCard),await this.duel.operationIncCardAttribute(this.attackerCard,"ATK_COUNT")):await this.duel.runAction(new $e(this.duel,this.attackerCard))}}class Cs extends yt{constructor(t){super(t)}async exec(){await this.duel.operationNextPhase()}}class Je extends yt{constructor(t,e){super(t),this.spellCard=e}async exec(){await this.duel.operationChangePosition(this.spellCard,et.FACEUP);for(let t=0;t<this.spellCard.getEffects().length;t++)await this.duel.runAction(new Sn(this.duel,this.spellCard,t));this.spellCard.getNature()==Qt.NORMAL&&await this.duel.operationDestroy(this.spellCard)}}class Sn extends yt{constructor(t,e,i){super(t),this.spellCard=e,this.effectIndex=i}async exec(){await this.duel.operationActivateCardEffect(this.spellCard,this.effectIndex)}}class Is extends ds{constructor(){super()}async loadFromFile(t){let e=await fetch(t);await this.loadFromData(await e.json())}async selectLocation(t,e=()=>!0){let i={};return i.state=!1,i.location="",i.index=0,i.card=null,await u.emit(this,"E_SELECT_LOCATION",{range:t,predicateCard:e,response:i,required:!1}),i.state?i:null}async selectRequiredLocation(t,e=()=>!0){let i={};return i.state=!1,i.location="",i.index=0,i.card=null,await u.emit(this,"E_SELECT_LOCATION",{range:t,predicateCard:e,response:i,required:!0}),i.state?i:null}}class Nt{async exec(t){}}class yn extends Nt{constructor(){super()}async exec(t){await t.runAction(new ps(t))}}class xn extends Nt{constructor(){super()}async exec(t){let e=t.getCurrentDuelist(),i=await e.selectLocation([[C.HAND],0],r=>r&&r.isSummonable());if(i==null)return!1;let s=await e.selectLocation([[C.MZONE],0],r=>r==null);if(s==null)return!1;await t.runAction(new fs(t,i.card,s.index))}}class Mn extends Nt{constructor(){super()}async exec(t){let e=t.getCurrentDuelist(),i=await e.selectLocation([[C.HAND],0],r=>r&&r.isSetable());if(i==null)return!1;let s=await e.selectLocation([[C.SZONE],0],r=>r==null);if(s==null)return!1;await t.runAction(new ms(t,i.card,s.index))}}class wn extends Nt{constructor(){super()}async exec(t){let i=await t.getCurrentDuelist().selectLocation([[C.MZONE],[C.MZONE]],s=>s&&s.getControler()==t.getCurrentDuelistIndex()&&s.isCapableChangePosition());if(i==null)return!1;await t.runAction(new gs(t,i.card))}}class vn extends Nt{constructor(){super()}async exec(t){let e=t.getCurrentDuelist(),i=await e.selectLocation([[C.MZONE],[C.MZONE]],n=>n&&n.getControler()==t.getCurrentDuelistIndex()&&n.isCapableAttack());if(i==null)return!1;if(t.utilsQuery(t.getCurrentDuelistIndex(),[[C.MZONE],[C.MZONE]],n=>n&&n.getControler()==t.getOpponentDuelistIndex()).length==0)return await t.runAction(new $e(t,i.card)),!0;let r=await e.selectLocation([[C.MZONE],[C.MZONE]],n=>n&&n.getControler()==t.getOpponentDuelistIndex());if(r==null)return!1;await t.runAction(new Es(t,i.card,r.card))}}class bn extends Nt{constructor(){super()}async exec(t){await t.runAction(new Cs(t))}}class Pn extends Nt{constructor(){super()}async exec(t){let i=await t.getCurrentDuelist().selectLocation([[C.SZONE],[C.SZONE]],s=>s&&s.getControler()==t.getCurrentDuelistIndex()&&s.isActiveatable(t));if(i==null)return!1;await t.runAction(new Je(t,i.card))}}function Rn(a){if(a=="DRAW")return new yn;if(a=="SUMMON")return new xn;if(a=="SET")return new Mn;if(a=="BATTLE")return new vn;if(a=="ACTIVATE")return new Pn;if(a=="CHANGE_POSITION")return new wn;if(a=="NEXT_PHASE")return new bn;throw new Error("CREATE_COMMAND: Command name unknown !")}let ti={};ti.LOWEST_ATK=function(a,t){return a.getAttribute("ATK")-t.getAttribute("ATK")};ti.HIGHEST_ATK=function(a,t){return t.getAttribute("ATK")-a.getAttribute("ATK")};function Lt(a,t){return a==""?t.sort((e,i)=>e.getId()-i.getId()):t.sort((e,i)=>ti[a](e,i))}class wi extends ds{constructor(){super(),this.behaviors=[]}async loadFromData(t){for(let e of t.OverBehaviors){let i=vi(e.Id);await i.loadFromData(e),this.behaviors.push(i)}for(let e of t.Behaviors){let i=vi(e.Id);await i.loadFromData(e),this.behaviors.push(i)}await super.loadFromData(t)}async loadFromFile(t){let e=await fetch(t);await this.loadFromData(await e.json())}async selectLocation(t,e,i=()=>!0){let r=t.getDuelists().indexOf(this),n=t.utilsQuery(r,e,h=>i(h));if(n.length==0)return!1;let o={};return o.state=!0,o.location="",o.index=-1,o.card=n[0],o}async selectRequiredLocation(t,e,i=()=>!0){let r=t.getDuelists().indexOf(this),n=t.utilsQuery(r,e,h=>i(h));if(n.length==0)return!1;let o={};return o.state=!0,o.location="",o.index=-1,o.card=n[0],o}async handleNewTurn(t){for(;t.getCurrentDuelist()==this;){for(let e of this.behaviors)await e.process(t);await t.runAction(new Cs(t)),await l.WAIT(2e3)}}}class zt{constructor(){this.id="",this.opts={},this.repeat=1,this.probability=1,this.conditionId="",this.conditionOpts={},this.cardConditionId="",this.cardConditionOpts={},this.cardSortId="",this.targetCardConditionId="",this.targetCardConditionOpts={},this.targetCardSortId=""}async loadFromData(t){this.id=t.Id,t.hasOwnProperty("Opts")&&(this.opts=t.Opts),t.hasOwnProperty("Repeat")&&(this.repeat=t.Repeat=="X"?99:t.Repeat),t.hasOwnProperty("Probability")&&(this.probability=t.Probability),t.hasOwnProperty("ConditionId")&&(this.conditionId=t.ConditionId,this.conditionOpts=t.ConditionOpts),t.hasOwnProperty("CardConditionId")&&(this.cardConditionId=t.CardConditionId,this.cardConditionOpts=t.CardConditionOpts),t.hasOwnProperty("CardSortId")&&(this.cardSortId=t.CardSortId),t.hasOwnProperty("TargetCardConditionId")&&(this.targetCardConditionId=t.TargetCardConditionId,this.targetCardConditionOpts=t.TargetCardConditionOpts),t.hasOwnProperty("TargetCardSortId")&&(this.targetCardSortId=t.TargetCardSortId)}async process(t){if(!!Xe(this.conditionId,t,this.conditionOpts)&&!(Math.random()>this.probability))for(let e=0;e<this.repeat;e++)await this.onProcess(t)}async onProcess(t){}}class Dn extends zt{constructor(){super()}async onProcess(t){let e=t.getCurrentDuelist();for(;e.isCapableDraw(t);)await t.runAction(new ps(t))}}class On extends zt{constructor(){super()}async onProcess(t){let e=t.getCurrentDuelist(),i=t.getCurrentDuelistIndex();if(!e.isCapableSummon(t))return;let s=t.utilsQuery(i,[[C.HAND],0],n=>n&&n.isSummonable()&&vt(this.cardConditionId,n,this.cardConditionOpts));if(s.length==0)return;s=Lt(this.cardSortId,s);let r=e.getZone(C.MZONE).findIndex(n=>n==null);await t.runAction(new fs(t,s[0],r))}}class _n extends zt{constructor(){super()}async onProcess(t){let e=t.getCurrentDuelist(),i=t.getCurrentDuelistIndex();if(!e.isCapableSet(t))return;let s=t.utilsQuery(i,[[C.HAND],0],n=>n&&n.isSetable()&&vt(this.cardConditionId,n,this.cardConditionOpts));if(s.length==0)return;s=Lt(this.cardSortId,s);let r=e.getZone(C.SZONE).findIndex(n=>n==null);await t.runAction(new ms(t,s[0],r))}}class Ln extends zt{constructor(){super()}async onProcess(t){let e=t.getCurrentDuelist(),i=t.getCurrentDuelistIndex();if(!e.isCapableChangePosition(t))return;let s=t.utilsQuery(i,[[C.MZONE],[C.MZONE]],r=>r&&r.getControler()==i&&r.isCapableChangePosition()&&vt(this.cardConditionId,r,this.cardConditionOpts));s.length!=0&&(s=Lt(this.cardSortId,s),await t.runAction(new gs(t,s[0])))}}class Nn extends zt{constructor(){super()}async onProcess(t){let e=t.getCurrentDuelist(),i=t.getCurrentDuelistIndex();if(!e.isCapableBattle(t))return;let s=t.utilsQuery(i,[[C.MZONE],[C.MZONE]],n=>n&&n.getControler()==i&&n.isCapableAttack()&&vt(this.cardConditionId,n,this.cardConditionOpts));if(s.length==0)return;let r=t.utilsQuery(i,[[C.MZONE],[C.MZONE]],n=>n&&n.getControler()!=i&&vt(this.targetCardConditionId,n,this.targetCardConditionOpts));r.length==0?(s=Lt(this.cardSortId,s),await t.runAction(new $e(t,s[0]))):(s=Lt(this.cardSortId,s),r=Lt(this.targetCardSortId,r),await t.runAction(new Es(t,s[0],r[0])))}}class Fn extends zt{constructor(){super()}async onProcess(t){let e=t.getCurrentDuelist(),i=t.getCurrentDuelistIndex();if(!e.isCapableActivate(t))return;let s=t.utilsQuery(i,[[C.MZONE],[C.MZONE]],r=>r&&r.getControler()==i&&r.isActiveatable(t)&&vt(this.cardConditionId,r,this.cardConditionOpts));s.length!=0&&(s=Lt(this.cardSortId,s),await t.runAction(new Je(t,s[0])))}}function vi(a){if(a=="DRAW")return new Dn;if(a=="SUMMON")return new On;if(a=="SET")return new _n;if(a=="CHANGE_POSITION")return new Ln;if(a=="BATTLE")return new Nn;if(a=="ACTIVATE_CARD")return new Fn;throw new Error("AIDuelist::CREATE_BEHAVIOR(): Behavior name unknown !")}class bi{constructor(){this.phases=[],this.currentPhase=null}getPhases(){return this.phases}getPhase(t){return this.phases.find(e=>e.id==t)}addPhase(t){this.phases.push(t)}getCurrentPhase(){return this.currentPhase}setCurrentPhase(t){this.currentPhase=t}}class Pe{constructor(t,e,i=!1){this.id=t,this.name=e,this.disabled=i}getId(){return this.id}getName(){return this.name}isDisabled(){return this.disabled}setDisabled(t){this.disabled=t}}class Bn{constructor(){this.duelists=[],this.turns=[],this.currentTurn=null,this.currentDuelistIndex=-1,this.opponentDuelistIndex=-1}async loadFromData(t){for(let e=0;e<2;e++){let i=t.DuelistIds[e],s=i.TypeName=="AIDuelist"?new wi:new Is;await s.loadFromFile("samples/ccg/data/duelist_"+i.Id+"/data.json");let r=s.getDeck();for(let n of r.getCards())n.setOwner(e),n.setControler(e),s.pushCard(C.DECK,n);this.duelists.push(s)}}async loadFromFile(t){let e=await fetch(t);await this.loadFromData(await e.json())}startup(){this.operationDraw(0,4),this.operationDraw(1,4),this.operationNewTurn()}async runAction(t){let e=this.utilsQuery(this.currentDuelistIndex,[[C.SZONE],[C.SZONE]],r=>r),i=this.utilsQuery(this.currentDuelistIndex,[[C.MZONE,C.SZONE,C.FZONE],[C.MZONE,C.SZONE,C.FZONE]],r=>r);for(let r of e)r.isTriggerable(this,t)&&await this.runAction(new Je(this,r));if(!t.isNegate())await t.exec();else return;for(let r of e)r.isReleasable(this)&&await this.operationDestroy(r);for(let r of e)if(r.getPosition()==et.FACEUP&&r.getNature()==Qt.CONTINUOUS){for(let n of i)for(let o of r.getEffects())o.getTargetType()==Kt.FIELD&&(o.hasTargetCard(n)&&!o.isTarget(this,n)?(o.removeTargetCard(n),n.getAttributes().removeModifierIf(c=>c.isLinked()&&c.getLinkedEffect()==o)):!o.hasTargetCard(n)&&o.isTarget(this,n)&&(o.addTargetCard(n),o.apply(this,r,n)));for(let n of r.getEffects())if(n.getTargetType()==Kt.SINGLE)for(let o of n.getTargetCards())(o==null||!n.isTargetConditionCheck(o))&&await this.operationDestroy(r)}if(this.duelists[0].getAttribute("LIFEPOINTS")==0)return"WIN";if(this.duelists[1].getAttribute("LIFEPOINTS")==0)return"LOST";if(this.currentTurn.getCurrentPhase().getId()==ut.END)return this.operationNewTurn()}getDuelists(){return this.duelists}getDuelist(t){return this.duelists[t]}getCurrentDuelist(){return this.duelists[this.currentDuelistIndex]}getOpponentDuelist(){return this.duelists[this.opponentDuelistIndex]}getCurrentTurn(){return this.currentTurn}getCurrentDuelistIndex(){return this.currentDuelistIndex}getOpponentDuelistIndex(){return this.opponentDuelistIndex}async operationNewTurn(){if(this.currentDuelistIndex==-1?(this.currentDuelistIndex=1,this.opponentDuelistIndex=0):this.currentDuelistIndex==0?(this.currentDuelistIndex=1,this.opponentDuelistIndex=0):(this.currentDuelistIndex=0,this.opponentDuelistIndex=1),this.turns.length<2){let t=new bi,e=t.getPhases();t.addPhase(Pi()),t.addPhase(Ri()),t.addPhase(Di()),t.setCurrentPhase(e[0]),this.turns.push(t),this.currentTurn=t}else{let t=new bi,e=t.getPhases();t.addPhase(Pi()),t.addPhase(Ri()),t.addPhase(Vn()),t.addPhase(Di()),t.setCurrentPhase(e[0]),this.turns.push(t),this.currentTurn=t}for(let t of this.duelists)t.setAttribute("DRAW_COUNT",0),t.setAttribute("SUMMON_COUNT",0);for(let t of this.utilsQuery(this.currentDuelistIndex,[[C.SZONE,C.MZONE,C.FZONE],[C.SZONE,C.MZONE,C.FZONE]],e=>e))t.getType()==D.MONSTER?(t.setAttribute("ATK_COUNT",0),t.incTurnCounter()):t.getType()==D.SPELL&&t.getPosition()==et.FACEUP&&t.incTurnCounter();this.duelists[this.currentDuelistIndex]instanceof wi&&this.duelists[this.currentDuelistIndex].handleNewTurn(this),u.emit(this,"E_NEW_TURN")}async operationDraw(t,e){let i=this.duelists[t].getZone(C.HAND);if(i.length+e>Mi)for(let s=0;s<i.length+e-Mi;s++){let r=await this.operationSelectLocation([[C.HAND],0],n=>n);this.duelists[t].removeCard(C.HAND,r.card)}for(;e-- >0;){let s=this.duelists[t].popCard(C.DECK);this.duelists[t].pushCard(C.HAND,s),s.setLocation(C.HAND)}}async operationRestore(t,e){this.duelists[t].getAttributes().add("LIFEPOINTS",+e),u.emit(this.duelists[t],"E_RESTORE",{amount:e})}async operationDamage(t,e){this.duelists[t].getAttributes().add("LIFEPOINTS",-e),u.emit(this.duelists[t],"E_DAMAGE",{amount:e})}async operationSummon(t,e){this.duelists[t.getControler()].removeCard(C.HAND,t),this.duelists[t.getControler()].insertCard(C.MZONE,e,t),t.setPosition(et.ATTACK),t.setLocation(C.MZONE)}async operationSet(t,e){this.duelists[t.getControler()].removeCard(C.HAND,t),this.duelists[t.getControler()].insertCard(C.SZONE,e,t),t.setPosition(et.FACEDOWN),t.setLocation(C.SZONE)}async operationChangePosition(t,e){t.setPosition(e)}async operationBattle(t,e){let i=e.getPosition()==et.ATTACK?e.getAttribute("ATK"):e.getAttribute("DEF"),s=t.getAttribute("ATK")-i;s>0?(this.operationDestroy(e),this.operationDamage(e.getControler(),Math.abs(s))):s<0?(this.operationDestroy(t),this.operationDamage(t.getControler(),Math.abs(s))):(this.operationDestroy(e),this.operationDestroy(t))}async operationNextPhase(){let t=this.currentTurn.getPhases(),e=t.indexOf(this.currentTurn.getCurrentPhase())+1;for(;t[e].isDisabled()&&e<t.length;)e++;this.currentTurn.setCurrentPhase(t[e])}async operationChangePhase(t){let e=this.currentTurn.getPhase(t);if(!e)throw new Error("Duel::operationChangePhase : phase not found !");if(e.isDisabled())throw new Error("Duel::operationChangePhase : phase is disabled !");this.currentTurn.setCurrentPhase(e)}async operationIncDuelistAttribute(t,e){this.duelists[t].incAttribute(e)}async operationAddDuelistModifier(t,e){this.duelists[t].getAttributes().addModifier(e)}async operationIncCardAttribute(t,e){t.incAttribute(e)}async operationAddCardModifier(t,e){t.getAttributes().addModifier(e)}async operationDestroy(t){if(t.getType()==D.SPELL)for(let e of t.getEffects()){for(let i of e.getTargetCards())i.getAttributes().removeModifierIf(r=>r.isLinked()&&r.getLinkedEffect()==e);for(let i of this.duelists)i.getAttributes().removeModifierIf(r=>r.isLinked()&&r.getLinkedEffect()==e)}this.utilsRemoveCard(t),this.duelists[t.getControler()].pushCard(C.GRAVEYARD,t),t.setPosition(et.FACEDOWN),t.setLocation(C.GRAVEYARD)}async operationActivateCardEffect(t,e){let i=[],r=t.getEffects()[e],n=t.getControler();if(r.getTargetType()==Kt.SINGLE){let o=await this.duelists[n].selectRequiredLocation(r.getTargetRange(),h=>h&&r.isTarget(this,h));i.push(o.card)}else r.getTargetType()==Kt.FIELD?i=this.utilsQuery(n,r.getTargetRange(),o=>o&&r.isTarget(this,o)):r.getTargetType()==Kt.NONE&&(i=[null]);for(let o of i)r.apply(this,t,o),r.addTargetCard(o)}utilsRemoveCard(t){let e=this.duelists[t.getOwner()];if(t.getLocation()==C.MZONE||t.getLocation()==C.SZONE||t.getLocation()==C.FZONE){let s=e.getZone(t.getLocation()).indexOf(t);e.insertCard(t.getLocation(),s,null)}else e.removeCard(t.getLocation(),t)}utilsQuery(t,e,i=s=>!0){let s=[],r=t,n=t==0?1:0;for(let o=0;o<2;o++){if(e[o]==0)continue;let h=o==0?r:n;for(let c=0;c<e[o].length;c++){let d=this.duelists[h].getZone(e[o][c]);s=s.concat(d.filter(i))}}return s}}function Pi(){return new Pe(ut.DRAW,"Draw Phase",!1)}function Ri(){return new Pe(ut.MAIN,"Main Phase",!1)}function Vn(){return new Pe(ut.BATTLE,"Battle Phase",!1)}function Di(){return new Pe(ut.END,"End Phase",!1)}class Un extends H{constructor(){super({className:"UITurn"}),this.duel=null}update(){if(this.node.innerHTML="",this.duel&&this.duel.getCurrentTurn()){let t=this.duel.getCurrentTurn();for(let e of t.getPhases())this.node.innerHTML+=`<div class="UITurn-phase ${t.getCurrentPhase()==e?"u-active":""}">${e.getName()}</div>`}}setDuel(t){this.duel=t||null}}class Oi extends H{constructor(){super({className:"UIDuelist",template:`
      <div class="UIDuelist-picture js-picture"></div>
      <div class="UIDuelist-infos">
        <div class="UIDuelist-infos-name js-name"></div>
        <div class="UIDuelist-infos-lifepoints js-lifepoints"></div>
      </div>`}),this.duelist=null}update(){this.duelist?(this.node.querySelector(".js-picture").style.backgroundImage=`url(${this.duelist.getPictureFile()})`,this.node.querySelector(".js-name").textContent=this.duelist.getName(),this.node.querySelector(".js-lifepoints").textContent=this.duelist.getAttribute("LIFEPOINTS")):(this.node.querySelector(".js-picture").style.backgroundImage="url()",this.node.querySelector(".js-name").textContent="--",this.node.querySelector(".js-lifepoints").textContent="0")}setDuelist(t){u.unsubscribe(this.duelist,"E_DAMAGE",this),u.unsubscribe(this.duelist,"E_RESTORE",this),t?(u.subscribe(t,"E_DAMAGE",this,this.handleDuelistDamage),u.subscribe(t,"E_RESTORE",this,this.handleDuelistRestore),this.duelist=t):this.duelist=null}showSelection(){this.node.classList.add("u-showSelection")}hideSelection(){this.node.classList.remove("u-showSelection")}handleDuelistDamage(t){_i(this.node,"-"+t.amount,"#fff",1e3),Hn(this.node,300)}handleDuelistRestore(t){_i(this.node,"+"+t.amount,"#fff",1e3)}}function Hn(a,t){return new Promise(e=>{setTimeout(()=>{a.classList.add("u-shake")},0),setTimeout(()=>{a.classList.remove("u-shake"),e()},t)})}function _i(a,t,e,i){return new Promise(s=>{let r=document.createElement("div");r.className="UIDuelist-toast",r.textContent=t,r.style.color=e,a.appendChild(r),setTimeout(()=>{r.remove(),s()},i)})}class jn extends H{constructor(){super({className:"UICardDetail",template:`
      <div class="UICardDetail-title js-title"></div>
      <div class="UICardDetail-body">
        <img class="UICardDetail-body-coverImg js-cover-img">
        <div class="UICardDetail-body-infos js-infos"></div>
      </div>`}),this.card=null}update(){this.card?(this.node.querySelector(".js-title").textContent=this.card.getName(),this.node.querySelector(".js-cover-img").src=this.card.getCoverFile(),this.node.querySelector(".js-infos").textContent="",this.card.getType()==D.MONSTER?this.node.querySelector(".js-infos").textContent+=`Type: MONSTRE
`:this.card.getType()==D.SPELL&&(this.node.querySelector(".js-infos").textContent+=`Type: MAGIE
`),this.card.getAttribute("ELEMENT")==Rt.DARK?this.node.querySelector(".js-infos").textContent+=`Element: TENEBRE
`:this.card.getAttribute("ELEMENT")==Rt.LIGHT?this.node.querySelector(".js-infos").textContent+=`Element: LUMIERE
`:this.card.getAttribute("ELEMENT")==Rt.EARTH?this.node.querySelector(".js-infos").textContent+=`Element: TERRE
`:this.card.getAttribute("ELEMENT")==Rt.WIND?this.node.querySelector(".js-infos").textContent+=`Element: VENT
`:this.card.getAttribute("ELEMENT")==Rt.FIRE?this.node.querySelector(".js-infos").textContent+=`Element: FEU
`:this.card.getAttribute("ELEMENT")==Rt.WATER?this.node.querySelector(".js-infos").textContent+=`Element: EAU
`:this.card.getAttribute("ELEMENT")==Rt.DIVINE&&(this.node.querySelector(".js-infos").textContent+=`Element: DIVIN
`),this.card.getType()==D.SPELL&&this.card.getNature()==Qt.NORMAL?this.node.querySelector(".js-infos").textContent+=`Nature: NORMAL
`:this.card.getType()==D.SPELL&&this.card.getNature()==Qt.CONTINUOUS&&(this.node.querySelector(".js-infos").textContent+=`Nature: CONTINUE
`),this.card.getType()==D.SPELL&&this.card.getMode()==Ae.ACTIVATE?this.node.querySelector(".js-infos").textContent+=`Mode: ACTIVATION
`:this.card.getType()==D.SPELL&&this.card.getMode()==Ae.TRIGGER&&(this.node.querySelector(".js-infos").textContent+=`Mode: PIEGE
`),this.card.getType()==D.MONSTER&&this.card.getAttribute("RACE")==U.AQUA?this.node.querySelector(".js-infos").textContent+=`Race: AQUA
`:this.card.getType()==D.MONSTER&&this.card.getAttribute("RACE")==U.BEAST?this.node.querySelector(".js-infos").textContent+=`Race: BETE
`:this.card.getType()==D.MONSTER&&this.card.getAttribute("RACE")==U.BEAST_WARRIOR?this.node.querySelector(".js-infos").textContent+=`Race: BETE GUERRIERE
`:this.card.getType()==D.MONSTER&&this.card.getAttribute("RACE")==U.DINOSAUR?this.node.querySelector(".js-infos").textContent+=`Race: DINOSAURE
`:this.card.getType()==D.MONSTER&&this.card.getAttribute("RACE")==U.FAIRY?this.node.querySelector(".js-infos").textContent+=`Race: FEE
`:this.card.getType()==D.MONSTER&&this.card.getAttribute("RACE")==U.FIEND?this.node.querySelector(".js-infos").textContent+=`Race: DEMON
`:this.card.getType()==D.MONSTER&&this.card.getAttribute("RACE")==U.FISH?this.node.querySelector(".js-infos").textContent+=`Race: POISSON
`:this.card.getType()==D.MONSTER&&this.card.getAttribute("RACE")==U.INSECT?this.node.querySelector(".js-infos").textContent+=`Race: INSECTE
`:this.card.getType()==D.MONSTER&&this.card.getAttribute("RACE")==U.MACHINE?this.node.querySelector(".js-infos").textContent+=`Race: MACHINE
`:this.card.getType()==D.MONSTER&&this.card.getAttribute("RACE")==U.PLANT?this.node.querySelector(".js-infos").textContent+=`Race: PLANTE
`:this.card.getType()==D.MONSTER&&this.card.getAttribute("RACE")==U.PSYCHIC?this.node.querySelector(".js-infos").textContent+=`Race: PSYCHIQUE
`:this.card.getType()==D.MONSTER&&this.card.getAttribute("RACE")==U.PYRO?this.node.querySelector(".js-infos").textContent+=`Race: PYRO
`:this.card.getType()==D.MONSTER&&this.card.getAttribute("RACE")==U.REPTILE?this.node.querySelector(".js-infos").textContent+=`Race: REPTILE
`:this.card.getType()==D.MONSTER&&this.card.getAttribute("RACE")==U.SEASERPENT?this.node.querySelector(".js-infos").textContent+=`Race: SERPENT DE MER
`:this.card.getType()==D.MONSTER&&this.card.getAttribute("RACE")==U.SPELLCASTER?this.node.querySelector(".js-infos").textContent+=`Race: MAGICIEN
`:this.card.getType()==D.MONSTER&&this.card.getAttribute("RACE")==U.THUNDER?this.node.querySelector(".js-infos").textContent+=`Race: ECLAIR
`:this.card.getType()==D.MONSTER&&this.card.getAttribute("RACE")==U.WARRIOR?this.node.querySelector(".js-infos").textContent+=`Race: GUERRIER
`:this.card.getType()==D.MONSTER&&this.card.getAttribute("RACE")==U.WINGEDBEAST?this.node.querySelector(".js-infos").textContent+=`Race: BETE AILEE
`:this.card.getType()==D.MONSTER&&this.card.getAttribute("RACE")==U.ZOMBIE?this.node.querySelector(".js-infos").textContent+=`Race: ZOMBIE
`:this.card.getType()==D.MONSTER&&this.card.getAttribute("RACE")==U.WYRM?this.node.querySelector(".js-infos").textContent+=`Race: WYRM
`:this.card.getType()==D.MONSTER&&this.card.getAttribute("RACE")==U.DRAGON?this.node.querySelector(".js-infos").textContent+=`Race: DRAGON
`:this.card.getType()==D.MONSTER&&this.card.getAttribute("RACE")==U.DIVINEBEAST?this.node.querySelector(".js-infos").textContent+=`Race: DIVINITE
`:this.card.getType()==D.MONSTER&&this.card.getAttribute("RACE")==U.CREATORGOD?this.node.querySelector(".js-infos").textContent+=`Race: DIEU CREATEUR
`:this.card.getType()==D.MONSTER&&this.card.getAttribute("RACE")==U.CYBERSE&&(this.node.querySelector(".js-infos").textContent+=`Race: CYBORG
`),this.node.querySelector(".js-infos").textContent+="Description: "+this.card.getText()+`
`,this.card.getType()==D.MONSTER&&(this.node.querySelector(".js-infos").innerHTML+=`
        <div class="UICardDetail-body-infos-stats">
          <div class="UICardDetail-body-infos-stats-item">ATK ${this.card.getAttribute("ATK")}</div>
          <div class="UICardDetail-body-infos-stats-item">DEF ${this.card.getAttribute("DEF")}</div>
        </div>`)):(this.node.querySelector(".js-title").textContent="--",this.node.querySelector(".js-cover-img").src="",this.node.querySelector(".js-infos").textContent="")}setCard(t){this.card=t||null}}class Te extends H{constructor(){super({className:"UICardSlot",template:`
      <div class="UICardSlot-bg js-bg"></div>`}),this.card=null,this.duelistIndex=0,this.location="",this.index=0,this.hidden=!1,this.selectable=!1}update(){this.card?(this.node.style.transform=`rotate(${this.card.getPosition()==et.DEFENSE?"90deg":"0deg"})`,this.node.querySelector(".js-bg").style.backgroundImage=this.hidden?"url(samples/ccg/card_back.png)":"url("+this.card.getCoverFile()+")"):(this.node.style.transform="rotate(0deg)",this.node.querySelector(".js-bg").style.backgroundImage="url()")}getCard(){return this.card}setCard(t){this.card=t||null}getDuelistIndex(){return this.duelistIndex}setDuelistIndex(t){this.duelistIndex=t}getLocation(){return this.location}setLocation(t){this.location=t}getIndex(){return this.index}setIndex(t){this.index=t}isHidden(){return this.hidden}setHidden(t){this.hidden=t}isSelectable(){return this.node.classList.contains("u-selectable")}setSelectable(t){this.node.classList.toggle("u-selectable",t)}}class As extends H{constructor(){super({className:"UIStackSlot",template:`
        <div class="UIStackSlot-bg js-bg"></div>
        <div class="UIStackSlot-numCards js-num-cards"></div>`}),this.cards=[],this.duelistIndex=0,this.location="",this.hidden=!1,this.selectable=!1}update(){if(this.cards.length>0){let t=this.cards[this.cards.length-1];this.node.querySelector(".js-bg").style.backgroundImage=this.hidden?"url(samples/ccg/card_back.png)":"url("+t.getCoverFile()+")",this.node.querySelector(".js-num-cards").textContent=this.cards.length}else this.node.querySelector(".js-bg").style.backgroundImage="url()",this.node.querySelector(".js-num-cards").textContent=0}setCards(t){this.cards=t||[]}getDuelistIndex(){return this.duelistIndex}setDuelistIndex(t){this.duelistIndex=t}getLocation(){return this.location}setLocation(t){this.location=t}isHidden(){return this.hidden}setHidden(t){this.hidden=t}isSelectable(){return this.node.classList.contains("u-selectable")}setSelectable(t){this.node.classList.toggle("u-selectable",t)}}class Wn extends H{constructor(){super({className:"UIBoard",template:`
      <div class="UIBoard-fields">
        <div class="UIBoard-field" data-duelist-index="0">
          <div class="UIBoard-field-zone js-zone" data-duelist-index="0" data-location="MZONE" style="top:80px; left:127px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="0" data-location="MZONE" style="top:80px; left:177px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="0" data-location="MZONE" style="top:80px; left:227px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="0" data-location="SZONE" style="top:10px; left:127px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="0" data-location="SZONE" style="top:10px; left:177px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="0" data-location="SZONE" style="top:10px; left:227px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="0" data-location="FZONE" style="top:150px; left:10px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="0" data-location="GRAVEYARD" style="top:80px; left:10px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="0" data-location="DECK" style="top:10px; left:10px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="0" data-location="HAND" style="top:10px; right:10px;"></div>
        </div>
        <div class="UIBoard-field" data-duelist-index="1">
          <div class="UIBoard-field-zone js-zone" data-duelist-index="1" data-location="MZONE" style="bottom:80px; right:127px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="1" data-location="MZONE" style="bottom:80px; right:177px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="1" data-location="MZONE" style="bottom:80px; right:227px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="1" data-location="SZONE" style="bottom:10px; right:127px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="1" data-location="SZONE" style="bottom:10px; right:177px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="1" data-location="SZONE" style="bottom:10px; right:227px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="1" data-location="FZONE" style="bottom:150px; right:10px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="1" data-location="GRAVEYARD" style="bottom:80px; right:10px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="1" data-location="DECK" style="bottom:10px; right:10px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="1" data-location="HAND" style="bottom:10px; left:10px;"></div>
        </div>
      </div>`}),this.duel=null,this.slots=[],this.focusedSlot=null;let t=F(0,C.SZONE,0,!1);this.node.querySelectorAll('.js-zone[data-duelist-index="0"][data-location="SZONE"]')[0].appendChild(t.getNode()),this.slots.push(t);let i=F(0,C.SZONE,1,!1);this.node.querySelectorAll('.js-zone[data-duelist-index="0"][data-location="SZONE"]')[1].appendChild(i.getNode()),this.slots.push(i);let r=F(0,C.SZONE,2,!1);this.node.querySelectorAll('.js-zone[data-duelist-index="0"][data-location="SZONE"]')[2].appendChild(r.getNode()),this.slots.push(r);let o=F(0,C.MZONE,0,!1);this.node.querySelectorAll('.js-zone[data-duelist-index="0"][data-location="MZONE"]')[0].appendChild(o.getNode()),this.slots.push(o);let c=F(0,C.MZONE,1,!1);this.node.querySelectorAll('.js-zone[data-duelist-index="0"][data-location="MZONE"]')[1].appendChild(c.getNode()),this.slots.push(c);let f=F(0,C.MZONE,2,!1);this.node.querySelectorAll('.js-zone[data-duelist-index="0"][data-location="MZONE"]')[2].appendChild(f.getNode()),this.slots.push(f);let E=F(0,C.HAND,0,!0),I=this.node.querySelectorAll('.js-zone[data-duelist-index="0"][data-location="HAND"]')[0];I.appendChild(E.getNode()),this.slots.push(E);let S=F(0,C.HAND,1,!0);I.appendChild(S.getNode()),this.slots.push(S);let y=F(0,C.HAND,2,!0);I.appendChild(y.getNode()),this.slots.push(y);let A=F(0,C.HAND,3,!0);I.appendChild(A.getNode()),this.slots.push(A);let T=F(0,C.HAND,4,!0);I.appendChild(T.getNode()),this.slots.push(T);let w=F(0,C.HAND,5,!0);I.appendChild(w.getNode()),this.slots.push(w);let M=F(0,C.FZONE,0,!1);this.node.querySelectorAll('.js-zone[data-duelist-index="0"][data-location="FZONE"]')[0].appendChild(M.getNode()),this.slots.push(M);let P=le(0,C.GRAVEYARD,!1);this.node.querySelectorAll('.js-zone[data-duelist-index="0"][data-location="GRAVEYARD"]')[0].appendChild(P.getNode()),this.slots.push(P);let B=le(0,C.DECK,!0);this.node.querySelectorAll('.js-zone[data-duelist-index="0"][data-location="DECK"]')[0].appendChild(B.getNode()),this.slots.push(B);let Y=F(1,C.SZONE,0,!1);this.node.querySelectorAll('.js-zone[data-duelist-index="1"][data-location="SZONE"]')[0].appendChild(Y.getNode()),this.slots.push(Y);let W=F(1,C.SZONE,1,!1);this.node.querySelectorAll('.js-zone[data-duelist-index="1"][data-location="SZONE"]')[1].appendChild(W.getNode()),this.slots.push(W);let N=F(1,C.SZONE,2,!1);this.node.querySelectorAll('.js-zone[data-duelist-index="1"][data-location="SZONE"]')[2].appendChild(N.getNode()),this.slots.push(N);let K=F(1,C.MZONE,0,!1);this.node.querySelectorAll('.js-zone[data-duelist-index="1"][data-location="MZONE"]')[0].appendChild(K.getNode()),this.slots.push(K);let tt=F(1,C.MZONE,1,!1);this.node.querySelectorAll('.js-zone[data-duelist-index="1"][data-location="MZONE"]')[1].appendChild(tt.getNode()),this.slots.push(tt);let Ut=F(1,C.MZONE,2,!1);this.node.querySelectorAll('.js-zone[data-duelist-index="1"][data-location="MZONE"]')[2].appendChild(Ut.getNode()),this.slots.push(Ut);let Ht=F(1,C.HAND,0,!1),gt=this.node.querySelectorAll('.js-zone[data-duelist-index="1"][data-location="HAND"]')[0];gt.appendChild(Ht.getNode()),this.slots.push(Ht);let jt=F(1,C.HAND,1,!1);gt.appendChild(jt.getNode()),this.slots.push(jt);let Wt=F(1,C.HAND,2,!1);gt.appendChild(Wt.getNode()),this.slots.push(Wt);let kt=F(1,C.HAND,3,!1);gt.appendChild(kt.getNode()),this.slots.push(kt);let Gt=F(1,C.HAND,4,!1);gt.appendChild(Gt.getNode()),this.slots.push(Gt);let qt=F(1,C.HAND,5,!1);gt.appendChild(qt.getNode()),this.slots.push(qt);let ne=F(1,C.FZONE,0,!1);this.node.querySelectorAll('.js-zone[data-duelist-index="1"][data-location="FZONE"]')[0].appendChild(ne.getNode()),this.slots.push(ne);let oe=le(1,C.GRAVEYARD,!1);this.node.querySelectorAll('.js-zone[data-duelist-index="1"][data-location="GRAVEYARD"]')[0].appendChild(oe.getNode()),this.slots.push(oe);let oi=le(1,C.DECK,!1);this.node.querySelectorAll('.js-zone[data-duelist-index="1"][data-location="DECK"]')[0].appendChild(oi.getNode()),this.slots.push(oi),this.focusedSlot=B}update(){if(this.duel){for(let t of this.slots){let e=this.duel.getDuelist(t.getDuelistIndex());t instanceof Te?t.setCard(e.getCard(t.getLocation(),t.getIndex())):t.setCards(e.getZone(t.getLocation()))}for(let t of this.slots)t.update()}}delete(){for(let t of this.slots)t.delete();super.delete()}focus(){this.focusedSlot&&(this.focusedSlot.focus(),u.emit(this,"E_SLOT_FOCUSED",{slot:this.focusedSlot})),super.focus()}unfocus(){this.focusedSlot&&(this.focusedSlot.unfocus(),u.emit(this,"E_SLOT_UNFOCUSED")),super.unfocus()}getSlots(){return this.slots}setDuel(t){for(let e of this.slots)e instanceof Te?e.setCard(null):e instanceof As&&e.setCards(null);this.duel=t||null}onAction(t){t=="BACK"?u.emit(this,"E_ECHAP_PRESSED"):t=="OK"?(u.emit(this,"E_SLOT_SELECTED",{slot:this.focusedSlot}),u.emit(this,"E_OK_PRESSED")):t=="UP"?this.$moveFocus(0,-1,!0):t=="DOWN"?this.$moveFocus(0,1,!0):t=="LEFT"?this.$moveFocus(-1,0,!0):t=="RIGHT"&&this.$moveFocus(1,0,!0)}$moveFocus(t,e,i=!1){let s=this.focusedSlot.getNode(),r=We(s),n=r.left+s.offsetWidth*.5,o=r.top+s.offsetHeight*.5,h=this.slots.slice();h.splice(h.indexOf(this.focusedSlot),1);let c=h.sort((d,f)=>{let g=d.getNode(),E=f.getNode(),I=We(g),S=We(E),y=I.left+g.offsetWidth*.5,A=I.top+g.offsetHeight*.5,T=S.left+E.offsetWidth*.5,w=S.top+E.offsetHeight*.5,M=[y-n,A-o],v=[T-n,w-o];return M[0]=Math.sign(M[0])==Math.sign(t)||t==0?Math.abs(M[0]):this.node.offsetWidth-Math.abs(M[0]),M[1]=Math.sign(M[1])==Math.sign(e)||e==0?Math.abs(M[1]):this.node.offsetHeight-Math.abs(M[1]),v[0]=Math.sign(v[0])==Math.sign(t)||t==0?Math.abs(v[0]):this.node.offsetWidth-Math.abs(v[0]),v[1]=Math.sign(v[1])==Math.sign(e)||e==0?Math.abs(v[1]):this.node.offsetHeight-Math.abs(v[1]),l.VEC2_LENGTH(M)-l.VEC2_LENGTH(v)});this.focusedSlot&&this.focusedSlot.unfocus(),c[0].focus(),this.focusedSlot=c[0],i&&u.emit(this,"E_SLOT_FOCUSED",{slot:c[0]})}}function F(a,t,e,i){let s=new Te;return s.setDuelistIndex(a),s.setLocation(t),s.setIndex(e),s.setHidden(i),s}function le(a,t,e){let i=new As;return i.setDuelistIndex(a),i.setLocation(t),i.setHidden(e),i}function We(a){for(var t=0,e=0;a&&!isNaN(a.offsetLeft)&&!isNaN(a.offsetTop);)t+=a.offsetLeft-a.scrollLeft,e+=a.offsetTop-a.scrollTop,a=a.offsetParent;return{top:e,left:t}}class kn extends k{constructor(){super(),this.duel=new Bn,this.uiBgNode=document.createElement("img"),this.uiTurn=new Un,this.uiDuelists=[],this.uiCardDetail=new jn,this.uiBoard=new Wn,this.uiActionMenu=new it,this.menuEnabled=!1}async onEnter(t={duelId}){await this.duel.loadFromFile("samples/ccg/data/duel_"+t.duelId+"/data.json"),this.uiBgNode.src="samples/ccg/bg.gif",p.addNode(this.uiBgNode,"position:absolute; top:0; right:0; bottom:0; left:0; width:100%"),this.uiTurn.setDuel(this.duel),p.addWidget(this.uiTurn,"position: absolute; top:0; left:0; right:0; line-height:30px; z-index:100"),this.uiDuelists.push(new Oi),this.uiDuelists[0].setDuelist(this.duel.getDuelist(0)),p.addWidget(this.uiDuelists[0],"position:absolute; top:30px; left:0; width:20%"),this.uiDuelists.push(new Oi),this.uiDuelists[1].setDuelist(this.duel.getDuelist(1)),p.addWidget(this.uiDuelists[1],"position:absolute; top:30px; right:0; width:20%"),p.addWidget(this.uiCardDetail,"position: absolute; top:30px; left:20%; width:60%"),this.uiBoard.setDuel(this.duel),p.addWidget(this.uiBoard,"position:absolute; top:50%; left:0; right:0; width:100%; height:50%"),this.uiActionMenu.setVisible(!1),p.addWidget(this.uiActionMenu,"position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); z-index:20;"),u.subscribe(this.duel,"E_NEW_TURN",this,this.handleNewTurn),u.subscribe(this.duel.getDuelist(1),"E_SELECT_LOCATION",this,this.handleSelectLocation),u.subscribe(this.uiBoard,"E_SLOT_UNFOCUSED",this,this.handleBoardSlotUnfocused),u.subscribe(this.uiBoard,"E_SLOT_FOCUSED",this,this.handleBoardSlotFocused),u.subscribe(this.uiBoard,"E_OK_PRESSED",this,this.handleBoardSelectPressed),u.subscribe(this.uiActionMenu,"E_CLOSED",this,this.handleActionMenuClosed),u.subscribe(this.uiActionMenu,"E_ITEM_SELECTED",this,this.handleActionMenuItemSelected),p.focus(this.uiBoard),this.duel.startup()}async onExit(){p.removeNode(this.uiBgNode),p.removeWidget(this.uiTurn),p.removeWidget(this.uiDuelists[0]),p.removeWidget(this.uiDuelists[1]),p.removeWidget(this.uiCardDetail),p.removeWidget(this.uiBoard),p.removeWidget(this.uiActionMenu)}handleNewTurn(){this.uiDuelists[this.duel.getOpponentDuelistIndex()].hideSelection(),this.uiDuelists[this.duel.getCurrentDuelistIndex()].showSelection(),this.duel.getCurrentDuelist()instanceof Is?this.menuEnabled=!0:this.menuEnabled=!1}handleSelectLocation({range:t,predicateCard:e,required:i,response:s}){return new Promise(r=>{p.focus(this.uiBoard);for(let n of this.uiBoard.getSlots())for(let o=0;o<2;o++){let h=o==0?this.duel.getCurrentDuelistIndex():this.duel.getOpponentDuelistIndex();t[o]!=0&&n.getDuelistIndex()==h&&t[o].includes(n.getLocation())&&e(n.getCard())&&n.setSelectable(!0)}i||u.subscribe(this.uiBoard,"E_ECHAP_PRESSED",this,()=>{u.unsubscribe(this.uiBoard,"E_ECHAP_PRESSED",this),u.unsubscribe(this.uiBoard,"E_SLOT_SELECTED",this);for(let n of this.uiBoard.getSlots())n.setSelectable(!1);s.state=!1,r()}),u.subscribe(this.uiBoard,"E_SLOT_SELECTED",this,n=>{if(n.slot.isSelectable()){u.unsubscribe(this.uiBoard,"E_ECHAP_PRESSED",this),u.unsubscribe(this.uiBoard,"E_SLOT_SELECTED",this);for(let o of this.uiBoard.getSlots())o.setSelectable(!1);s.state=!0,s.location=n.slot.getLocation(),s.index=n.slot.getIndex(),s.card=n.slot.getCard(),r()}})})}handleBoardSlotUnfocused(){this.uiCardDetail.setCard(null)}handleBoardSlotFocused(t){t.slot instanceof Te&&t.slot.getCard()&&!t.slot.isHidden()?this.uiCardDetail.setCard(t.slot.getCard()):this.uiCardDetail.setCard(null)}handleBoardSelectPressed(){if(!this.menuEnabled)return!1;this.uiActionMenu.clear();let t=this.duel.getCurrentDuelist();t.isCapableDraw(this.duel)&&this.uiActionMenu.add("DRAW","Piocher"),t.isCapableSummon(this.duel)&&this.uiActionMenu.add("SUMMON","Invoquer"),t.isCapableSet(this.duel)&&this.uiActionMenu.add("SET","Poser"),t.isCapableBattle(this.duel)&&this.uiActionMenu.add("BATTLE","Attaquer"),t.isCapableActivate(this.duel)&&this.uiActionMenu.add("ACTIVATE","Activer"),t.isCapableChangePosition(this.duel)&&this.uiActionMenu.add("CHANGE_POSITION","Changer de position"),this.uiActionMenu.add("NEXT_PHASE","Phase suivante"),this.uiActionMenu.setVisible(!0),p.focus(this.uiActionMenu)}handleActionMenuClosed(){this.uiActionMenu.setVisible(!1),p.focus(this.uiBoard)}async handleActionMenuItemSelected(t){this.uiActionMenu.setVisible(!1),this.menuEnabled=!1,await Rn(t.id).exec(this.duel),p.focus(this.uiBoard),this.menuEnabled=!0}}class $t{maxChildren;depth;maxDepth;partitionMethod;parent=null;left=null;right=null;children=[];constructor(t,e,i,s){this.reset(),this.maxChildren=t,this.depth=e,this.maxDepth=i,this.partitionMethod=s}search(...t){return this.partitionMethod.search(this,...t)}reset(){this.children=[],this.left=null,this.right=null}createSubNodes(){const t=this.partitionMethod.split(this.children);this.left=new $t(this.maxChildren,this.depth+1,this.maxDepth,t.leftFunction),this.right=new $t(this.maxChildren,this.depth+1,this.maxDepth,t.rightFunction),t.left.forEach(this.left.addChild.bind(this.left)),t.right.forEach(this.right.addChild.bind(this.right)),this.left.parent=this,this.right.parent=this,this.children=[]}getChildren(){return this.children}addChild(t){if(this.children.length>=this.maxChildren&&this.depth<this.maxDepth&&this.createSubNodes(),this.left===null&&this.right===null)this.children.push(t);else{const e=this.partitionMethod.split([t]);this.left&&e.left.length>0&&this.left.addChild(e.left[0]),this.right&&e.right.length>0&&this.right.addChild(e.right[0])}}getPartitionMethod(){return this.partitionMethod}getLeft(){return this.left}getRight(){return this.right}getDepth(){return this.depth}setDepth(t){this.depth=t}}class Jt{box;axis;constructor(t,e){this.box=t,this.axis=e}search(t,e,i=[]){if(!t.getPartitionMethod().box.intersectBoundingBox(e))return[];const n=t.getLeft(),o=t.getRight();if(n&&o)n.search(e,i),o.search(e,i);else{const h=t.getChildren(),c=h.length;for(let d=0;d<c;d++)h[d].intersectBoundingBox(e)&&i.push(h[d])}return i}split(t){const e=[],i=[],s=this.box.getCenter();for(const c of t)this.axis==="x"?c.min[0]>=s[0]?i.push(c):e.push(c):this.axis==="y"?c.min[1]>=s[1]?i.push(c):e.push(c):c.min[2]>=s[2]?i.push(c):e.push(c);let r=[],n="x";this.axis==="x"?(r=Gn(this.box),n="y"):this.axis==="y"?(r=qn(this.box),n="z"):(r=Yn(this.box),n="x");const o=new Jt(r[0],n),h=new Jt(r[1],n);return{left:e,right:i,leftFunction:o,rightFunction:h}}}function Gn(a){const t=a.getSize(),e=a.getCenter();return[z.createFromCoord(a.min[0],a.min[1],a.min[2],t[0]*.5,t[1],t[2]),z.createFromCoord(e[0],a.min[1],a.min[2],t[0]*.5,t[1],t[2])]}function qn(a){const t=a.getSize(),e=a.getCenter();return[z.createFromCoord(a.min[0],a.min[1],a.min[2],t[0],t[1]*.5,t[2]),z.createFromCoord(a.min[0],e[1],a.min[2],t[0],t[1]*.5,t[2])]}function Yn(a){const t=a.getSize(),e=a.getCenter();return[z.createFromCoord(a.min[0],a.min[1],a.min[2],t[0],t[1],t[2]*.5),z.createFromCoord(a.min[0],a.min[1],e[2],t[0],t[1],t[2]*.5)]}const Xn=2;class zn extends z{a;b;c;n;t;constructor(t){super(),this.a=[0,0,0],this.b=[0,0,0],this.c=[0,0,0],this.n=[0,0,0],this.t=[0,0,0],this.a[0]=t[0*st+0],this.a[1]=t[0*st+1],this.a[2]=t[0*st+2],this.b[0]=t[1*st+0],this.b[1]=t[1*st+1],this.b[2]=t[1*st+2],this.c[0]=t[2*st+0],this.c[1]=t[2*st+1],this.c[2]=t[2*st+2],this.n=l.TRI3_NORMAL(this.a,this.b,this.c),this.t=l.VEC3_CROSS([0,1,0],this.n),super.fromVertices([...this.a,...this.b,...this.c],3)}}class Zn{btree;frags;lift;constructor(){this.btree=new $t(20,0,10,new Jt(new z([0,0,0],[0,0,0]),"x")),this.frags=[],this.lift=.2}loadFromJSM(t){this.btree=new $t(20,0,10,new Jt(t.getBoundingBox(),"x")),this.frags=[];for(let e=0;e<t.getVertexCount();e+=3){const i=t.getVertices(),s=new zn(i.slice((e+0)*st,(e+3)*st));this.btree.addChild(s),this.frags.push(s)}}move(t,e,i){const s=z.createFromCenter(t[0],t[1],t[2],e[0],e[1],e[2]),r={move:[i[0],i[1],i[2]],collideFloor:!1,collideWall:!1};s.min[1]+=this.lift;const n=this.frags.filter(E=>E.intersectBoundingBox(new z([s.min[0]+i[0],s.min[1]+i[1],s.min[2]+i[2]],[s.max[0]+i[0],s.max[1]+i[1],s.max[2]+i[2]]))),o=[[s.min[0],s.min[1]+this.lift,s.max[2]],[s.min[0],s.min[1]+this.lift,s.min[2]],[s.max[0],s.min[1]+this.lift,s.min[2]],[s.max[0],s.min[1]+this.lift,s.max[2]]];let h=[],c=0;for(;c<o.length;){if(h[c]){c++;continue}const E=Ts(n,o[c],[r.move[0],r.move[2]]);if(E[0]==0&&E[1]==0){r.move[0]=0,r.move[2]=0,r.collideWall=!0;break}else if(E[0]!=r.move[0]||E[1]!=r.move[2]){r.move[0]=E[0],r.move[2]=E[1],r.collideWall=!0,h[c]=!0,c=0;continue}c++}s.min[1]-=this.lift;const d=this.frags.filter(E=>E.intersectBoundingBox(new z([t[0],s.min[1]+r.move[1],t[2]],[t[0],s.max[1]+r.move[1],t[2]]))),f=s.min[1],g=Qn(d,[t[0]+r.move[0],t[1],t[2]+r.move[2]]);return console.log(g),g!=1/0&&(r.collideFloor=!0,r.move[1]=g-f),r}setLift(t){this.lift=t}getLift(){return this.lift}}function Ts(a,t,e,i=0){let s=null,r=999999;if(i>Xn)return[0,0];for(const n of a){const o=[0,0,0];if(l.RAY_PLAN(t,[e[0],0,e[1]],n.a,n.n,!0,o)){const h=l.VEC3_SUBSTRACT(o,t),c=l.VEC3_LENGTH(h);c<=l.VEC2_LENGTH(e)+.001&&c<r&&(r=c,s=n)}}if(s){const n=Kn(s,e);return Ts(a,t,n,i+1)}return e}function Kn(a,t){return l.VEC2_PROJECTION_COS([t[0],t[1]],[a.t[0],a.t[2]])}function Qn(a,t){for(const e of a){const i=[0,0,0];if(l.RAY_TRIANGLE(t,[0,-1,0],e.a,e.b,e.c,!0,i))return i[1]}return 1/0}const ce=.001,Li=.5,Ni=.003;class $n extends ee{constructor(t){super(t),this.velocity=[0,0,0],this.aabb=new z,this.view.setPerspectiveNear(.1),this.crosshair=document.createElement("img"),this.crosshair.src="samples/fps/crosshair.png",p.addNode(this.crosshair,"position:absolute; left:50%; top:50%; transform: translate(-50%,-50%);"),this.handleClickedCb=this.handleClicked.bind(this),this.handlePointerLockChangeCb=this.handlePointerLockChange.bind(this),this.handleMouseMoveCb=this.handleMouseMove.bind(this),document.addEventListener("click",this.handleClickedCb),document.addEventListener("pointerlockchange",this.handlePointerLockChangeCb,!1)}delete(){p.removeNode(this.crosshair),document.removeEventListener("click",this.handleClickedCb),document.removeEventListener("pointerlockchange",this.handlePointerLockChangeCb,!1),document.removeEventListener("mousemove",this.handleMouseMoveCb)}update(t){this.translate(this.velocity[0],this.velocity[1],this.velocity[2])}move(t,e,i){t!=0||e!=0||i!=0?(this.velocity[0]=t,this.velocity[1]=e,this.velocity[2]=i):(this.velocity[0]!=0||this.velocity[2]!=0)&&(this.velocity[0]=this.velocity[0]>-ce&&this.velocity[0]<ce?0:this.velocity[0]*Li,this.velocity[2]=this.velocity[2]>-ce&&this.velocity[2]<ce?0:this.velocity[2]*Li),u.emit(this,"E_MOVED",{moveX:this.velocity[0],moveY:this.velocity[1],moveZ:this.velocity[2]})}setVelocity(t,e,i){this.velocity[0]=t,this.velocity[1]=e,this.velocity[2]=i}getVelocity(){return this.velocity}async handleClicked(t){document.pointerLockElement||await document.body.requestPointerLock({unadjustedMovement:!0})}handlePointerLockChange(t){document.pointerLockElement==document.body?document.addEventListener("mousemove",this.handleMouseMoveCb,!1):document.removeEventListener("mousemove",this.handleMouseMoveCb,!1)}handleMouseMove(t){const e=t.movementX*Ni,i=t.movementY*Ni;this.rotate(i,e,0)}}const Fi=1,Jn=1.3,to=[Fi,Jn,Fi],Bi=3,eo=1,io=1,Vi=10;class so extends k{constructor(){super(),this.map=new J,this.nav=new Zn,this.camera=new $n(0),this.cameraSpeed=0,this.cameraGravitySpeed=0}async onEnter(){this.camera.setPosition(-1.5,1,2.7),this.camera.setRotation(0,-Math.PI/2,0),await this.map.loadFromFile("./samples/fps/map.jsm"),this.map.setMaterial(new Q({texture:await b.loadTexture("./samples/fps/map.png")})),this.nav.loadFromJSM(this.map),u.subscribe(this.camera,"E_MOVED",this,this.handleCameraMoved)}async onExit(){u.unsubscribe(this.camera,"E_MOVED",this)}update(t){const e=this.camera.getLocalAxies();let i=!1,s=[0,0];R.isActiveAction("LEFT")&&(s[0]+=e[0][0]*-1,s[1]+=e[0][2]*-1,i=!0),R.isActiveAction("RIGHT")&&(s[0]+=e[0][0],s[1]+=e[0][2],i=!0),R.isActiveAction("UP")&&(s[0]+=e[2][0]*-1,s[1]+=e[2][2]*-1,i=!0),R.isActiveAction("DOWN")&&(s[0]+=e[2][0],s[1]+=e[2][2],i=!0);const r=this.cameraGravitySpeed*-1*(t/1e3);if(i){this.cameraSpeed=this.cameraSpeed<Bi?this.cameraSpeed+eo:Bi;const n=l.VEC2_NORMALIZE(s),o=n[0]*this.cameraSpeed*(t/1e3),h=n[1]*this.cameraSpeed*(t/1e3);this.camera.move(o,r,h)}else this.cameraSpeed=0,this.camera.move(0,r,0);this.camera.update(t),this.map.update(t)}draw(){this.map.draw()}handleCameraMoved({moveX:t,moveY:e,moveZ:i}){const s=this.nav.move(this.camera.getPosition(),to,[t,e,i]);s.collideFloor?this.cameraGravitySpeed=0:this.cameraGravitySpeed=this.cameraGravitySpeed<Vi?this.cameraGravitySpeed+io:Vi,this.camera.setVelocity(s.move[0],s.move[1],s.move[2])}}class ro{constructor(t){this.map=t,this.modifiers=[]}get(t){if(!this.map.hasOwnProperty(t))return;let e=this.map[t];for(let i of this.modifiers)i.getAttributeKey()==t&&i.getType()=="MUL"&&(e*=i.getValue());for(let i of this.modifiers)i.getAttributeKey()==t&&i.getType()=="ADD"&&(e+=i.getValue());for(let i of this.modifiers)i.getAttributeKey()==t&&i.getType()=="SUB"&&(e-=i.getValue());for(let i of this.modifiers)i.getAttributeKey()==t&&i.getType()=="SET"&&(e=i.getValue());for(let i of this.modifiers)i.getAttributeKey()==t&&i.getType()=="FIN"&&(e=i.getValue());return e<0&&(e=0),this.map.hasOwnProperty(t+"_MIN")&&(e=Math.max(e,this.map[t+"_MIN"])),this.map.hasOwnProperty(t+"_MAX")&&(e=Math.min(e,this.map[t+"_MAX"])),e}getBase(t){if(!!this.map.hasOwnProperty(t))return this.map[t]}set(t,e){!this.map.hasOwnProperty(t)||(e<0&&(e=0),this.map.hasOwnProperty(t+"_MIN")&&(e=Math.max(e,this.map[t+"_MIN"])),this.map.hasOwnProperty(t+"_MAX")&&(e=Math.min(e,this.map[t+"_MAX"])),this.map[t]=e)}add(t,e){this.set(t,this.getBase(t)+e)}has(t){return this.map.hasOwnProperty(t)}addModifier(t){this.modifiers.push(t)}removeModifier(t){this.modifiers.splice(this.modifiers.indexOf(t),1)}addModifiers(t){for(let e of t)this.modifiers.push(e)}removeModifiers(t){for(let e of t)this.modifiers.splice(this.modifiers.indexOf(e),1)}clearModifiers(){for(;this.modifiers.length;)this.modifiers.pop()}}let Ft={};Ft.IS_ALL=function(a,t,e){return!0};Ft.IS_SELF=function(a,t,e){return a==t};Ft.IS_ALLY=function(a,t,e){return a.constructor.name==t.constructor.name};Ft.IS_ALIVE_ALLY=function(a,t,e){return t.getAttribute("HP")>0&&a.constructor.name==t.constructor.name};Ft.IS_OPPONENT=function(a,t,e){return a.constructor.name!=t.constructor.name};Ft.IS_ALIVE_OPPONENT=function(a,t,e){return t.getAttribute("HP")>0&&a.constructor.name!=t.constructor.name};function no(a,t,e,i={}){return a==""?!0:Ft[a](t,e,i)}class Ss{constructor(t){this.type="",this.attributeKey="",this.value=0,!!t.hasOwnProperty("Type")&&(t.Type=="MUL"||t.Type=="ADD"||t.Type=="SUB"||t.Type=="SET"||t.Type=="FIN")&&(!t.hasOwnProperty("AttributeKey")||!t.hasOwnProperty("Value")||(this.type=t.Type,this.attributeKey=t.AttributeKey,this.value=t.Value))}getType(){return this.type}getAttributeKey(){return this.attributeKey}getValue(){return this.value}}class oo{constructor(){this.id="",this.name="",this.description="",this.iconFile="",this.stackable=!1,this.numTurns=0,this.onTurnEffect=null,this.modifiers=[],this.turnCount=0,this.fromChar=null}async loadFromData(t){this.id=t.Id,this.name=t.Name,this.description=t.Description,this.iconFile=t.IconFile,this.stackable=t.Stackable,this.numTurns=t.NumTurns,t.OnTurnEffect&&(this.onTurnEffect=new te,this.onTurnEffect.loadFromData(t.OnTurnEffect));for(let e of t.Modifiers)this.modifiers.push(new Ss(e))}async loadFromFile(t){let e=await fetch(t);await this.loadFromData(await e.json())}getId(){return this.id}getName(){return this.name}getDescription(){return this.description}getIconFile(){return this.iconFile}getStackable(){return this.stackable}getNumTurns(){return this.numTurns}getOnTurnEffect(){return this.onTurnEffect}getModifiers(){return this.modifiers}getTurnCount(){return this.turnCount}incTurnCount(){this.turnCount++}getFromChar(){return this.fromChar}}let Bt={};Bt.RESTORE=async function(a,t,e={amount,element}){await t.increaseHP(e.amount,e.element)};Bt.DAMAGE=async function(a,t,e={amount,element}){await t.decreaseHP(e.amount,e.element)};Bt.INCREASE_MANA=async function(a,t,e={amount}){await t.increaseHP(e.amount)};Bt.DECREASE_MANA=async function(a,t,e={amount}){await t.decreaseHP(e.amount)};Bt.ADD_SEAL=async function(a,t,e={sealId}){let i=oo.createFromFile("samples/rpg/data/"+e.sealId+"/data.json");i.fromChar=a,await t.addSeal(i)};Bt.REMOVE_SEAL=async function(a,t,e={sealId}){for(let i of t.getActiveSeals())i.getId()==sealId&&await t.removeSeal(i)};function ao(a,t,e,i={}){return a==""?!0:Bt[a](t,e,i)}let ue={ALL:"ALL",MENU:"MENU",BATTLE:"BATTLE"},pt={POTION:"POTION",FOOD:"FOOD",WEAPON:"WEAPON",HELMET:"HELMET",ARMOR:"ARMOR",RELIC:"RELIC",OTHER:"OTHER"},xt={RED:"RED",BLUE:"BLUE",BLACK:"BLACK",WHITE:"WHITE"};class te{constructor(){this.id="",this.name="",this.description="",this.cost=0,this.spriteAnimationName="",this.availabilityType="",this.mechanicId="",this.mechanicOpts={},this.targetCharConditionId="",this.targetCharConditionOpts={}}async loadFromData(t){this.id=t.Id,this.name=t.Name,this.description=t.Description,this.cost=t.Cost,this.spriteAnimationName=t.SpriteAnimationName,this.availabilityType=t.AvailabilityType,this.mechanicId=t.MechanicId,this.mechanicOpts=t.MechanicOpts,this.targetCharConditionId=t.TargetCharConditionId,this.targetCharConditionOpts=t.TargetCharConditionOpts}async loadFromFile(t){let e=await fetch(t);await this.loadFromData(await e.json())}isMenuAvailable(){return this.availabilityType==ue.ALL||this.availabilityType==ue.MENU}isBattleAvailable(){return this.availabilityType==ue.ALL||this.availabilityType==ue.BATTLE}isUsable(t){return this.cost<=t.getAttribute("MP")}isTargetCharConditionCheck(t,e){return no(this.targetCharConditionId,t,e,this.targetCharConditionOpts)}async apply(t,e){await u.emit(e,"E_EFFECT_INFLICT",{effect:this}),await ao(this.mechanicId,t,e,this.mechanicOpts)}getId(){return this.id}getName(){return this.name}getDescription(){return this.description}getCost(){return this.cost}getSpriteAnimationName(){return this.spriteAnimationName}getAvailabilityType(){return this.availabilityType}getMechanicId(){return this.mechanicId}getMechanicOpts(){return this.mechanicOpts}getTargetCharConditionId(){return this.targetCharConditionId}getTargetCharConditionOpts(){return this.targetCharConditionOpts}}class ys{constructor(){this.id="",this.type="",this.name="",this.description="",this.pictureFile="",this.jasFile="",this.jasImageFile="",this.attributes,this.attackEffects=[],this.magicEffects=[],this.activeSeals=[],this.ready=!1}async loadFromData(t){this.id=t.Id,this.type=t.Type,this.name=t.Name,this.description=t.Description,this.pictureFile=t.PictureFile,this.jamFile=t.JAMFile,this.jamTextureFile=t.JAMTextureFile,this.attributes=new ro(t.Attributes);for(let e of t.AttackEffectIds){let i=new te;await i.loadFromFile("samples/rpg/data/effect_"+e+"/data.json"),this.attackEffects.push(i)}for(let e of t.MagicEffectIds){let i=new te;await i.loadFromFile("samples/rpg/data/effect_"+e+"/data.json"),this.magicEffects.push(i)}}async addSeal(t){if(!t.stackable&&this.activeSeals.find(e=>e.id==t.id))return u.emit(this,"E_SEAL_ADD_FAILED");this.attributes.addModifiers(t.modifiers),this.activeSeals.push(t),await u.emit(this,"E_SEAL_ADDED")}async removeSeal(t){if(!this.activeSeals.find(e=>e==t))return u.emit(this,"E_SEAL_REMOVE_FAILED");this.attributes.removeModifiers(t.modifiers),this.activeSeals.splice(this.activeSeals.indexOf(t),1),await u.emit(this,"E_SEAL_REMOVED")}async increaseHP(t,e=null){let i=Ui(e,this.attributes.get("ELEMENT"));t=e?t*i:t,this.attributes.add("HP",+t),await u.emit(this,"E_INCREASE_HP",{amount:t})}async decreaseHP(t,e=null){let i=Ui(e,this.attributes.get("ELEMENT"));t=e?t*i:t,this.attributes.add("HP",-t),await u.emit(this,"E_DECREASE_HP",{amount:t})}async increaseMP(t){this.attributes.add("MP",+t),await u.emit(this,"E_INCREASE_MP",{amount:t})}async decreaseMP(t){this.attributes.add("MP",-t),await u.emit(this,"E_DECREASE_MP",{amount:t})}getId(){return this.id}getType(){return this.type}getName(){return this.name}getDescription(){return this.description}getPictureFile(){return this.pictureFile}getJAMFile(){return this.jamFile}getJAMTextureFile(){return this.jamTextureFile}getAttributes(){return this.attributes}getAttribute(t){return this.attributes.get(t)}getAttackEffects(){return this.attackEffects}getMagicEffects(){return this.magicEffects}getActiveSeals(){return this.activeSeals}setReady(t){this.ready=t}isReady(){return this.ready}}function Ui(a,t){return a==xt.RED&&t==xt.BLUE||a==xt.BLUE&&t==xt.RED||a==xt.BLACK&&t==xt.WHITE||a==xt.WHITE&&t==xt.BLACK?2:1}class ho{constructor(){this.level=1,this.attributeMap={}}}class lo{constructor(){this.id="",this.name="",this.promotions=[]}async loadFromData(t){t.hasOwnProperty("Effect")&&(this.effect=new Effect,await this.effect.loadFromData(t.Effect)),this.id=t.Id,this.name=t.Name,this.promotions=[];for(let e of t.Promotions){let i=new ho;i.level=e.Level,i.attributeMap=e.AttributeMap,this.promotions.push(i)}}async loadFromFile(t){let e=await fetch(t);await this.loadFromData(await e.json())}applyPromotion(t,e){let i=this.promotions.find(r=>r.level==e);if(!i)throw new Error("Cast::applyPromotion(): Level not exist !");let s=t.getAttributes();for(let r in i.attributeMap)s.add(r,i.attributeMap[r])}}class xs{constructor(){this.id="",this.type="",this.name="",this.description="",this.pictureFile="",this.soldable=!0,this.price=0,this.quantity=1}async loadFromData(t){this.id=t.Id,this.type=t.Type,this.name=t.Name,this.description=t.Description,this.pictureFile=t.PictureFile,this.soldable=t.Soldable,this.price=t.Price}getId(){return this.id}getType(){return this.type}getName(){return this.name}getDescription(){return this.description}getPictureFile(){return this.pictureFile}getSoldable(){return this.soldable}getPrice(){return this.price}getQuantity(){return this.quantity}setQuantity(t){this.quantity=t}}class at extends xs{constructor(){super(),this.subType="",this.modifiers=[]}async loadFromData(t){this.subType=t.SubType;for(let e of t.Modifiers)this.modifiers.push(new Ss(e));super.loadFromData(t)}async loadFromFile(t){let e=await fetch(t);await this.loadFromData(await e.json())}getSubType(){return this.subType}getModifiers(){return this.modifiers}}class ze extends ys{constructor(){super(),this.weapon=null,this.helmet=null,this.armor=null,this.relic=null,this.allowedEquipmentItemSubTypes=[],this.cast=new lo}async loadFromData(t){if(t.WeaponId){let e=new at;await e.loadFromFile("samples/rpg/data/"+t.WeaponId+"/data.json"),this.setEquipment(e)}if(t.HelmetId){let e=new at;await e.loadFromFile("samples/rpg/data/"+t.HelmetId+"/data.json"),this.setEquipment(e)}if(t.ArmorId){let e=new at;await e.loadFromFile("samples/rpg/data/"+t.ArmorId+"/data.json"),this.setEquipment(e)}if(t.RelicId){let e=new at;await e.loadFromFile("samples/rpg/data/"+t.RelicId+"/data.json"),this.setEquipment(e)}for(let e of t.AllowedEquipmentItemSubTypes)this.allowedEquipmentItemSubTypes.push(e);this.cast.loadFromFile("samples/rpg/data/cast_"+t.CastId+"/data.json"),super.loadFromData(t)}async loadFromFile(t){let e=await fetch(t);await this.loadFromData(await e.json())}getWeapon(){return this.weapon}getHelmet(){return this.helmet}getArmor(){return this.armor}getRelic(){return this.relic}getAllowedEquipmentItemSubTypes(){return this.allowedEquipmentItemSubTypes}getCast(){return this.cast}isEquipableItem(t){return t instanceof at&&this.allowedEquipmentItemSubTypes.includes(t.getSubType())}getAttributesWith(t){let e={},i=this.setEquipment(t);for(let s in this.attributes.map)e[s]=this.attributes.get(s);return i?this.setEquipment(i):this.removeEquipment(t),e}setEquipment(t){let e=null;return t.type==pt.WEAPON?(e=this.weapon,this.weapon=t):t.type==pt.HELMET?(e=this.helmet,this.helmet=t):t.type==pt.ARMOR?(e=this.armor,this.armor=t):t.type==pt.RELIC&&(e=this.relic,this.relic=t),e&&this.attributes.removeModifiers(e.getModifiers()),this.attributes.addModifiers(t.getModifiers()),e}removeEquipment(t){return t==this.weapon?(this.attributes.removeModifiers(this.weapon.getModifiers()),this.weapon=null,!0):t==this.helmet?(this.attributes.removeModifiers(this.helmet.getModifiers()),this.helmet=null,!0):t==this.armor?(this.attributes.removeModifiers(this.armor.getModifiers()),this.armor=null,!0):t==this.relic?(this.attributes.removeModifiers(this.relic.getModifiers()),this.relic=null,!0):!1}}class Ct{items;constructor(t=[]){this.items=t}getItems(){return this.items}push(t,e=!1){const i=this.items.push(t);return e&&u.emit(this,"E_ITEM_ADDED",{item:t,index:this.items.indexOf(t)}),i}pop(t=!1){const e=this.items.pop();return t&&u.emit(this,"E_ITEM_REMOVED",{item:e,index:this.items.length}),e}remove(t,e=!1){const i=this.items.indexOf(t);return this.items.splice(i,1),e&&u.emit(this,"E_ITEM_REMOVED",{item:t,index:i}),i}removeAt(t,e=!1){const i=this.items.splice(t,1);return e&&u.emit(this,"E_ITEM_REMOVED",{item:i,index:t}),i}has(t){return this.items.indexOf(t)!=-1}clear(){for(;this.items.length;)this.items.pop()}}class Tt extends xs{constructor(){super(),this.effect=null}async loadFromData(t){t.hasOwnProperty("Effect")&&(this.effect=new te,await this.effect.loadFromData(t.Effect)),super.loadFromData(t)}async loadFromFile(t){let e=await fetch(t);await this.loadFromData(await e.json())}apply(t,e){this.effect.apply(t,e)}isMenuAvailable(){return this.effect&&this.effect.isMenuAvailable()}isTarget(t,e){return this.effect&&this.effect.isTargetCharConditionCheck(t,e)}hasEffect(){return!!this.effect}getEffect(){return this.effect}}const co=99;class Ms extends Ct{constructor(){super()}async loadFromData(t){for(let e of t)if(e.ItemTypeName=="CommonItem"){let i=new Tt;await i.loadFromFile("samples/rpg/data/"+e.ItemId+"/data.json"),i.setQuantity(e.Quantity),this.items.push(i)}else if(e.ItemTypeName=="EquipmentItem"){let i=new at;await i.loadFromFile("samples/rpg/data/"+e.ItemId+"/data.json"),i.setQuantity(e.Quantity),this.items.push(i)}}async loadFromFile(t){let e=await fetch(t);await this.loadFromData(await e.json())}getItemById(t){return this.items.find(e=>e.getId()==t)}findItemById(t){return this.items.findIndex(e=>e.getId()==t)}addItem(t){let e=this.items.findIndex(i=>i.getId()==t.getId());if(e!=-1){let i=this.items[e];if(i.getQuantity()+t.getQuantity()>co)return;i.setQuantity(i.getQuantity()+t.getQuantity())}else this.items.push(t),u.emit(this,"E_ITEM_ADDED",{item:t,index:this.items.indexOf(t)})}removeItemById(t,e=1){let i=this.items.findIndex(n=>n.getId()==t);if(i==-1)return;let s=this.items[i],r=s.getQuantity()-e;if(r==0)this.items.splice(this.items.indexOf(s),1),u.emit(this,"E_ITEM_REMOVED",{item:s,index:i});else if(r>0)s.setQuantity(r);else return;return r}hasMenuAvailableItems(){return this.items.filter(e=>e instanceof Tt&&e.isMenuAvailable()).length>0}hasCommonItems(){return this.items.filter(e=>e instanceof Tt).length>0}hasEquipmentItems(){return this.items.filter(e=>e instanceof at).length>0}isEmpty(){return this.items.length==0}}class uo{constructor(){this.gils=0,this.inventory=null,this.heroes=[],this.variants={}}async loadFromData(t){this.gils=t.Gils,this.inventory=new Ms,this.inventory.loadFromData(t.Inventory);for(let e of t.Heroes){let i=new ze;i.loadFromData(e),this.heroes.push(i)}for(let e in t.Variants)this.addVariant(e,t.Variants[e])}async loadFromFile(t){let e=await fetch(t);await this.loadFromData(await e.json())}increaseGils(t){this.gils+=t,u.emit(this,"E_GILS_CHANGED",{gils:this.gils})}decreaseGils(t){if(this.gils-t<0)throw new Error("Player::decreaseGils(): gils cannot be negative !");this.gils-=t,u.emit(this,"E_GILS_CHANGED",{gils:this.gils})}addVariant(t,e){if(this.variants.hasOwnProperty(t))throw new Error("Player::addVariant: varloc already exist in variants dictionnary");this.variants[t]=e}removeVariant(t){if(!this.variants.hasOwnProperty(t))throw new Error("Player::removeVariant: varloc not exist in variants dictionnary");delete this.variants[t]}setVariant(t,e){if(!this.variants.hasOwnProperty(t))throw new Error("Player::setVariant: varloc not exist in variants dictionnary");this.variants[t]=e}hasVariant(t){return this.variants.hasOwnProperty(t)}getVariant(t){if(!this.variants.hasOwnProperty(t))throw new Error("Player::getVariant: varloc not exist in variants dictionnary");return this.variants[t]}getGils(){return this.gils}getInventory(){return this.inventory}getHeroes(){return this.heroes}}class po{constructor(){this.then=0,this.player=new uo}async init(){await this.player.loadFromFile("samples/rpg/data/player.json")}getPlayer(){return this.player}}const Vt=new po;let ei={};ei.SELF_HAS_LOWER_HP=function(a,t,e){return t.getAttribute("HP")/t.getAttribute("HP_MAX")*100<e.number};ei.ALLY_HAS_LOWER_HP=function(a,t,e){for(let i of a.getEnemies()){let s=i.getAttribute("HP")/i.getAttribute("HP_MAX")*100;if(i!=t&&s!=0&&s<e.number)return!0}return!1};function fo(a,t,e,i={}){return a==""?!0:ei[a](t,e,i)}let ii={};ii.LOWEST_HP=function(a,t){return a.getAttribute("HP")-t.getAttribute("HP")};ii.HIGHEST_HP=function(a,t){return t.getAttribute("HP")-a.getAttribute("HP")};function mo(a,t){return a==""?t.sort((e,i)=>e.getId()-i.getId()):t.sort((e,i)=>ii[a](e,i))}class Hi extends ys{constructor(){super(),this.gils=0,this.patterns=[],this.position=[0,0,0]}async loadFromData(t){this.gils=t.Gils;for(let e of t.Patterns){let i=new go;await i.loadFromData(e),this.patterns.push(i)}await super.loadFromData(t)}async loadFromFile(t){let e=await fetch(t);await this.loadFromData(await e.json())}getGils(){return this.gils}getPatterns(){return this.patterns}getPosition(){return this.position}setPosition(t){this.position=t}}class go{constructor(){this.name="",this.effect=null,this.priority=0,this.conditionId="",this.conditionOpts={},this.targetCharSortId=""}async loadFromData(t){this.name=t.Name,this.effect=new te,await this.effect.loadFromFile("samples/rpg/data/effect_"+t.EffectId+"/data.json"),this.priority=t.Priority,this.conditionId=t.ConditionId,this.conditionOpts=t.ConditionOpts,this.targetCharSortId=t.TargetCharSortId}isConditionCheck(t,e){return fo(this.conditionId,t,e,this.conditionOpts)}targetCharSort(t){return mo(this.targetCharSortId,t)}}class Re{constructor(t){this.battle=t}async exec(){}}class ws extends Re{constructor(t,e){super(t),this.fromChar=e}async exec(){await this.battle.operationLet(this.fromChar)}}class vs extends Re{constructor(t,e,i,s){super(t),this.effect=e,this.fromChar=i,this.toChar=s}async exec(){await this.battle.operationApplyEffect(this.effect,this.fromChar,this.toChar)}}class Eo extends Re{constructor(t,e,i,s){super(t),this.item=e,this.fromChar=i,this.toChar=s}async exec(){await this.battle.operationApplyItem(this.item,this.fromChar,this.toChar)}}class Se extends Re{constructor(t){super(t)}async exec(){await this.battle.operationNewTurn()}}let Co={NORMAL:"N",A_FIRST:"A",E_FIRST:"E",E_TRAP:"T"};class Io{constructor(){this.backgroundImage="",this.jsmFile="",this.jsmTextureFile="",this.cameraPosition=[0,0,0],this.cameraLookAt=[0,0,0],this.enemies=[],this.player=Vt.getPlayer(),this.heroes=this.player.getHeroes(),this.formationType=Co.NORMAL,this.numTurns=0,this.characterQueue=[]}async loadFromData(t){this.backgroundImage=t.BackgroundImage,this.jsmFile=t.JSMFile,this.jsmTextureFile=t.JSMTextureFile,this.cameraPosition=t.CameraPosition,this.cameraLookAt=t.CameraLookAt;for(let e of t.Enemies){let i=new Hi;await i.loadFromFile("samples/rpg/data/enemy_"+e.EnemyId+"/data.json"),i.setPosition(e.Position),this.enemies.push(i)}}async loadFromFile(t){let e=await fetch(t);await this.loadFromData(await e.json())}startup(){this.runAction(new Se(this))}async runAction(t){await u.emit(this,"E_ACTION_BEFORE",{action:t}),await t.exec(),await u.emit(this,"E_ACTION_AFTER",{action:t});for(let r of this.characterQueue)r.getAttribute("HP")==0&&this.characterQueue.splice(this.characterQueue.indexOf(r),1);if(this.heroes.reduce((r,n)=>r+n.getAttribute("HP"),0)==0)return u.emit(this,"E_LOST");if(this.enemies.reduce((r,n)=>r+n.getAttribute("HP"),0)==0)return u.emit(this,"E_WIN");if(this.characterQueue.length==0)return this.runAction(new Se(this));let s=this.characterQueue.filter(r=>r.isReady());if(s.length==0){let r=0;for(;r<this.characterQueue.length&&this.characterQueue[0].getType()==this.characterQueue[r].getType();)s.push(this.characterQueue[r]),this.characterQueue[r].setReady(!0),r++}await u.emit(this,"E_CHAR_READY",{char:s[0]}),s[0]instanceof Hi&&this.handleAI()}async operationNewTurn(){let t=[...this.heroes,...this.enemies];t=t.sort((e,i)=>i.getAttribute("AGILITY")-e.getAttribute("AGILITY")),t=t.filter(e=>e.getAttribute("HP")>0);for(let e of t){for(let i of e.getActiveSeals())i.incTurnCount(),i.getOnTurnEffect()&&await i.getOnTurnEffect().apply(i.getFromChar(),e),i.getTurnCount()==i.getNumTurns()&&e.removeSeal(i);e.setReady(!1)}this.numTurns++,this.characterQueue=t,u.emit(this,"E_NEW_TURN")}async operationLet(t){t.setReady(!1),this.characterQueue.splice(this.characterQueue.indexOf(t),1)}async operationApplyEffect(t,e,i){await t.apply(e,i),e.getAttributes().add("MP",-t.getCost()),e.setReady(!1),this.characterQueue.splice(this.characterQueue.indexOf(e),1)}async operationApplyItem(t,e,i){let s=this.player.getInventory();await t.getEffect().apply(e,i),s.removeItemById(t.getId()),e.setReady(!1),this.characterQueue.splice(this.characterQueue.indexOf(e),1)}handleAI(){let t=this.characterQueue[0],e=[...this.heroes,...this.enemies],s=t.patterns.sort((o,h)=>o.priority-h.priority).filter(o=>o.isConditionCheck(this,t)),r=null,n=null;s.length==0&&(s=t.patterns);for(let o of s){let h=e.filter(c=>o.effect.isTargetCharConditionCheck(t,c));if(h.length>0){r=o.effect,n=o.targetCharSort(h)[0];break}}r&&n?this.runAction(new vs(this,r,t,n)):this.runAction(new ws(this,t))}getBackgroundImage(){return this.backgroundImage}getJSMFile(){return this.jsmFile}getJSMTextureFile(){return this.jsmTextureFile}getCameraPosition(){return this.cameraPosition}getCameraLookAt(){return this.cameraLookAt}getEnemies(){return this.enemies}getHeroes(){return this.heroes}getFormationType(){return this.formationType}getNumTurns(){return this.numTurns}getCharacterQueue(){return this.characterQueue}}class se extends is{collection;views;sortPredicate;filterPredicate;enablePredicate;constructor(t={}){super(t),this.collection=new Ct,this.views=[],this.sortPredicate=()=>1,this.filterPredicate=()=>!0,this.enablePredicate=()=>!0}delete(){u.unsubscribe(this.collection,"E_ITEM_ADDED",this),u.unsubscribe(this.collection,"E_ITEM_REMOVED",this),super.delete()}setCollection(t){if(u.unsubscribe(this.collection,"E_ITEM_ADDED",this),u.unsubscribe(this.collection,"E_ITEM_REMOVED",this),this.clear(),t){const i=t.getItems().sort(this.sortPredicate).filter(this.filterPredicate);i.forEach(s=>this.addItem(s,this.enablePredicate(s))),u.subscribe(t,"E_ITEM_ADDED",this,this.handleItemAdded),u.subscribe(t,"E_ITEM_REMOVED",this,this.handleItemRemoved),this.collection=t,this.views=i}else this.collection=new Ct,this.views=[]}addItem(t,e=!0,i=-1){}getFocusedItem(){return this.views[this.getFocusedWidgetIndex()]}getSelectedItem(){return this.views[this.getSelectedWidgetIndex()]}setSortPredicate(t){if(this.collection){const e=this.collection.getItems();this.views=e.sort(t).filter(this.filterPredicate),this.clear(),this.views.forEach(i=>this.addItem(i,this.enablePredicate(i)))}this.sortPredicate=t}setFilterPredicate(t){if(this.collection){const e=this.collection.getItems();this.views=e.sort(this.sortPredicate).filter(t),this.clear(),this.views.forEach(i=>this.addItem(i,this.enablePredicate(i)))}this.filterPredicate=t}setEnablePredicate(t){if(this.collection){const e=this.collection.getItems();this.views=e.sort(this.sortPredicate).filter(this.filterPredicate),this.clear(),this.views.forEach(i=>this.addItem(i,t(i)))}this.enablePredicate=t}getViews(){return this.views}handleItemAdded(t){const e=this.collection.getItems();this.views=e.sort(this.sortPredicate).filter(this.filterPredicate);const i=this.views.indexOf(t.item);this.addItem(t.item,this.enablePredicate(t.item),i)}handleItemRemoved(t){const e=this.views.indexOf(t.item);this.removeWidget(e);const i=this.collection.getItems();this.views=i.sort(this.sortPredicate).filter(this.filterPredicate)}}class De extends se{constructor(t={}){super(),this.showPrice=t.showPrice??!0,this.showQuantity=t.showQuantity??!0}addItem(t,e=!0,i=-1){let s=new Ao;s.setShowPrice(this.showPrice),s.setShowQuantity(this.showQuantity),s.setItem(t),this.addWidget(s,e,i)}}class Ao extends H{constructor(){super({className:"UIInventoryItem",template:`
      <span class="UIInventoryItem-name js-name"></span>
      <span class="UIInventoryItem-quantity js-quantity"></span>
      <span class="UIInventoryItem-price js-price"></span>`}),this.item=null,this.showPrice=!0,this.showQuantity=!0}update(t){this.item?(this.node.querySelector(".js-name").textContent=this.item.getName(),this.node.querySelector(".js-price").style.display=this.showPrice?"block":"none",this.node.querySelector(".js-price").textContent=this.item.price,this.node.querySelector(".js-quantity").style.display=this.showQuantity?"block":"none",this.node.querySelector(".js-quantity").textContent=this.item.quantity):(this.node.querySelector(".js-name").textContent="--",this.node.querySelector(".js-price").textContent="--",this.node.querySelector(".js-quantity").textContent="--")}getItem(){return this.item}setItem(t){this.item=t||null}setShowPrice(t){this.showPrice=t}setShowQuantity(t){this.showQuantity=t}}class To extends se{constructor(){super()}addItem(t,e=!0,i=-1){let s=new So;s.setEffect(t),this.addWidget(s,e,i)}}class So extends H{constructor(){super({className:"UIEffectsItem",template:`
      <span class="UIEffectsItem-name js-name"></span>`}),this.effect=null}update(t){this.effect?this.node.querySelector(".js-name").textContent=this.effect.getName():this.node.querySelector(".js-name").textContent="--"}getEffect(){return this.effect}setEffect(t){this.effect=t||null}}class yo extends se{constructor(){super({axis:xe.X})}addItem(t,e=!0,i=-1){let s=new xo;s.setHero(t),this.addWidget(s,e,i)}}class xo extends H{constructor(){super({className:"UIBattleHeroesItem",template:`
      <div class="UIBattleHeroesItem-body">
        <div class="UIBattleHeroesItem-body-name js-name"></div>
        <div class="UIBattleHeroesItem-body-stats">
          <div class="UIBattleHeroesItem-body-stats-item">
            <span class="UIBattleHeroesItem-body-stats-item-name">HP</span>
            <span class="UIBattleHeroesItem-body-stats-item-bar">
              <span class="UIBattleHeroesItem-body-stats-item-bar-value js-hp-value"></span>
              <span class="UIBattleHeroesItem-body-stats-item-bar-progress js-hp-bar"></span>
            </span>
          </div>
          <div class="UIBattleHeroesItem-body-stats-item">
            <span class="UIBattleHeroesItem-body-stats-item-name">MP</span>
            <span class="UIBattleHeroesItem-body-stats-item-bar">
              <span class="UIBattleHeroesItem-body-stats-item-bar-value js-mp-value"></span>
              <span class="UIBattleHeroesItem-body-stats-item-bar-progress js-mp-bar"></span>
            </span>
          </div>
        </div>
      </div>`}),this.hero=null}update(t){this.hero?(this.setEnabled(this.hero.isReady()),this.node.querySelector(".js-name").textContent=this.hero.getName(),this.node.querySelector(".js-hp-value").textContent=this.hero.getAttribute("HP")+"/"+this.hero.getAttribute("HP_MAX"),this.node.querySelector(".js-hp-bar").style.width=parseInt(this.hero.getAttribute("HP")/this.hero.getAttribute("HP_MAX")*100)+"%",this.node.querySelector(".js-mp-value").textContent=this.hero.getAttribute("MP")+"/"+this.hero.getAttribute("MP_MAX"),this.node.querySelector(".js-mp-bar").style.width=parseInt(this.hero.getAttribute("MP")/this.hero.getAttribute("MP_MAX")*100)+"%"):(this.disable(),this.node.querySelector(".js-name").textContent="--",this.node.querySelector(".js-hp-value").textContent="--/--",this.node.querySelector(".js-hp-bar").style.width="0%",this.node.querySelector(".js-mp-value").textContent="--/--",this.node.querySelector(".js-mp-bar").style.width="0%")}getHero(){return this.hero}setHero(t){this.hero=t||null}}class Mo extends H{constructor(){super({className:"UIBattleStatus",template:`
      <div class="UIBattleStatus-numTurns">
        <div class="UIBattleStatus-numTurns-label">Turn: </div>
        <div class="UIBattleStatus-numTurns-value js-num-turns-value"></div>
      </div>
      <div class="UIBattleStatus-pictures js-pictures"></div>`}),this.battle=null}update(t){if(this.battle){this.node.querySelector(".js-num-turns-value").textContent=this.battle.getNumTurns(),this.node.querySelector(".js-pictures").innerHTML="";for(let e of this.battle.getCharacterQueue())this.node.querySelector(".js-pictures").innerHTML+=`<img class="UIBattleStatus-pictures-item" src="${e.getPictureFile()}"></img>`}else this.node.querySelector(".js-num-turns-value").textContent="0",this.node.querySelector(".js-pictures").innerHTML=""}setBattle(t){this.battle=t||null}}class ji extends It{constructor(){super(),this.character=null,this.effectSprite=new Ye,this.effectVisible=!1,this.mesh=new qe}delete(){this.effectSprite.delete(),this.mesh.delete()}update(t){const i=this.mesh.getBoundingBox().getSize();this.effectSprite.setPosition(this.position[0],this.position[1]+i[1]*.5,this.position[2]),this.effectSprite.update(t),this.mesh.setPosition(this.position[0],this.position[1],this.position[2]),this.mesh.setRotation(this.rotation[0],this.rotation[1],this.rotation[2]),this.mesh.update(t)}draw(){this.effectVisible&&this.effectSprite.draw(),this.mesh.draw()}async loadFromCharacter(t){u.unsubscribe(this.character,"E_EFFECT_INFLICT",this),u.unsubscribe(this.character,"E_INCREASE_HP",this),u.unsubscribe(this.character,"E_DECREASE_HP",this),u.unsubscribe(this.character,"E_INCREASE_MP",this),u.unsubscribe(this.character,"E_DECREASE_MP",this),u.unsubscribe(this.character,"E_SEAL_ADD_FAILED",this),u.unsubscribe(this.character,"E_SEAL_ADDED",this),u.unsubscribe(this.character,"E_SEAL_REMOVE_FAILED",this),u.unsubscribe(this.character,"E_SEAL_REMOVED",this),t?(u.subscribe(t,"E_EFFECT_INFLICT",this,this.handleEffectInflict),u.subscribe(t,"E_INCREASE_HP",this,this.handleCharacterIncreaseHP),u.subscribe(t,"E_DECREASE_HP",this,this.handleCharacterDecreaseHP),u.subscribe(t,"E_INCREASE_MP",this,this.handleCharacterIncreaseMP),u.subscribe(t,"E_DECREASE_MP",this,this.handleCharacterDecreaseMP),u.subscribe(t,"E_SEAL_ADD_FAILED",this,this.handleCharacterSealAddFailed),u.subscribe(t,"E_SEAL_ADDED",this,this.handleCharacterSealAdded),u.subscribe(t,"E_SEAL_REMOVE_FAILED",this,this.handleCharacterSealRemoveFailed),u.subscribe(t,"E_SEAL_REMOVED",this,this.handleCharacterSealRemoved),this.effectSprite=new Ye,this.effectSprite.loadFromFile("samples/rpg/sprites/effects.jas"),this.effectSprite.setTexture(await b.loadTexture("samples/rpg/sprites/effects.png")),this.mesh=new qe,await this.mesh.loadFromFile(t.getJAMFile()),this.mesh.setMaterial(new Q({texture:await b.loadTexture(t.getJAMTextureFile())})),this.mesh.play("IDLE",!0,!0),this.character=t):this.character=null}getCharacter(){return this.character}getSize(){return this.mesh.getBoundingBox().getSize()}async handleEffectInflict(t){this.effectVisible=!0,this.effectSprite.play(t.effect.getSpriteAnimationName()),this.effectSprite.setOffsetNormalized(.5,.5),await u.wait(this.effectSprite,"E_FINISHED"),this.effectVisible=!1}async handleCharacterIncreaseHP(t){await this.DRAW_TOAST(t.amount,"#5ef500",300)}async handleCharacterDecreaseHP(t){await this.DRAW_TOAST(t.amount,"#f50000",1e3)}async handleCharacterIncreaseMP(t){await this.DRAW_TOAST("MP + "+t.amount,"#fff",300)}async handleCharacterDecreaseMP(t){await this.DRAW_TOAST("MP - "+t.amount,"#fff",300)}async handleCharacterSealAddFailed(t){await this.DRAW_TOAST("Seal add failed !","#fff",300)}async handleCharacterSealAdded(t){await this.DRAW_TOAST("Seal added !","#fff",300)}async handleCharacterSealRemoveFailed(t){await this.DRAW_TOAST("Seal remove failed !","#fff",300)}async handleCharacterSealRemoved(t){await this.DRAW_TOAST("Seal removed !","#fff",300)}DRAW_TOAST(t,e,i){return new Promise(s=>{const r=document.createElement("div");r.className="BattleAreaFighter-toast",r.textContent=t,r.style.color=e;const n=this.mesh.getPosition(),h=x.getCurrentView().getScreenPosition(n[0],n[1]+.8,n[2]);r.style.top=h[1]+"px",r.style.left=h[0]+"px",p.addNode(r),setTimeout(()=>{r.remove(),s()},i)})}}class wo extends ee{constructor(){super(0),this.timeElapsed=0,this.originPos=[0,0,0],this.originLookAt=[0,0,0],this.animationFromPos=[0,0,0],this.animationFromLookAt=[0,0,0],this.animationDestPos=[0,0,0],this.animationDestLookAt=[0,0,0],this.animationDuration=1,this.playing=!1}update(t){if(!!this.playing&&!l.VEC3_ISEQUAL(this.animationDestPos,this.animationFromPos))if(this.timeElapsed<this.animationDuration){const e=this.timeElapsed/this.animationDuration,i=l.VEC3_SUBSTRACT(this.animationDestPos,this.animationFromPos),s=l.VEC3_SCALE(i,.5),r=l.VEC3_ADD(this.animationFromPos,s),n=l.VEC3_CREATE(-s[2],s[1],s[0]),o=l.VEC3_ADD(r,n),h=l.VEC3_QUADRATIC_BEZIER(this.animationFromPos,o,this.animationDestPos,e),c=l.VEC3_SUBSTRACT(this.animationDestLookAt,this.animationFromLookAt),d=l.VEC3_ADD(this.animationFromLookAt,l.VEC3_SCALE(c,e));super.setPosition(h[0],h[1],h[2]),super.lookAt(d[0],d[1],d[2]),this.timeElapsed+=t}else u.emit(this,"E_FINISHED"),this.playing=!1,this.timeElapsed=0}play(t,e,i){l.VEC3_ISEQUAL(t,this.originPos)||(this.animationFromPos=this.originPos,this.animationFromLookAt=this.originLookAt,this.animationDestPos=t,this.animationDestLookAt=e,this.animationDuration=i,this.playing=!0)}playBack(t=this.animationDuration){if(l.VEC3_ISEQUAL(this.animationFromPos,this.animationDestPos))return;const e=this.animationFromPos,i=this.animationFromLookAt;this.animationFromPos=this.animationDestPos,this.animationFromLookAt=this.animationDestLookAt,this.animationDestPos=e,this.animationDestLookAt=i,this.animationDuration=t,this.playing=!0}setPosition(t,e,i){this.originPos=[t,e,i],super.setPosition(t,e,i)}setLookAt(t,e,i){this.originLookAt=[t,e,i],super.lookAt(t,e,i)}}const vo={"1N":[[-3,0,0,0]],"2N":[[-3,0,1,0],[-3,0,-1,0]],"3N":[[-3,0,2,0],[-3,0,0,0],[-3,0,-2,0]],"4N":[[-3,0,3,0],[-3,0,1,0],[-3,0,-1,0],[-3,0,-3,0]]},bo={"1N":[[3,0,0,Math.PI]],"2N":[[3,0,1,Math.PI],[-3,0,-1,Math.PI]],"3N":[[3,0,2,Math.PI],[-3,0,0,Math.PI],[-3,0,-2,Math.PI]],"4N":[[3,0,3,Math.PI],[-3,0,1,Math.PI],[-3,0,-1,Math.PI],[-3,0,-3,Math.PI]]},Po=[-5,5,9],Ro=[-3,0,0],Do=[5,5,9],Oo=[3,0,0];class _o{constructor(){this.battle=null,this.fighters=[],this.focusableFighterPredicate=()=>!0,this.focusedFighter=null,this.camera=new wo,this.map=new J,this.focusIcon=new J,this.handleKeyDownCb=t=>this.handleKeyDown(t)}async loadFromBattle(t){for(let e of this.fighters)e.delete();if(this.focusIcon=new J,await this.focusIcon.loadFromFile("samples/rpg/jsms/focus.jsm"),this.focusIcon.setMaterial(new Q({texture:await b.loadTexture("samples/rpg/jsms/focus.png")})),t){const e=t.getCameraPosition();this.camera.setPosition(e[0],e[1],e[2]);const i=t.getCameraLookAt();this.camera.setLookAt(i[0],i[1],i[2]),this.map=new J,await this.map.loadFromFile(t.getJSMFile()),this.map.setMaterial(new Q({texture:await b.loadTexture(t.getJSMTextureFile())}));let s=t.getHeroes();for(let n=0;n<s.length;n++){let o=new ji,h=vo[s.length+t.getFormationType()][n];await o.loadFromCharacter(s[n]),o.setPosition(h[0],h[1],h[2]),o.setRotation(0,h[3],0),this.fighters.push(o)}let r=t.getEnemies();for(let n=0;n<r.length;n++){let o=new ji,h=bo[r.length+t.getFormationType()][n];await o.loadFromCharacter(r[n]),o.setPosition(h[0],h[1],h[2]),o.setRotation(0,h[3],0),this.fighters.push(o)}this.battle=t}else this.battle=null}delete(){for(let t of this.fighters)t.delete();this.map.delete(),this.focusIcon.delete()}update(t){for(let e of this.fighters)e.update(t);if(this.focusedFighter){let e=this.focusedFighter.getPosition(),i=this.focusedFighter.getSize();this.focusIcon.setPosition(e[0],e[1]+i[1]+.5,e[2]),this.focusIcon.rotate(0,.05,0),this.focusIcon.update(t)}this.camera.update(t),this.map.update(t)}draw(){for(let t of this.getFighters())t.draw();this.focusedFighter&&this.focusIcon.draw(),this.map.draw()}setFocusableFighterPredicate(t){for(let e=0;e<this.fighters.length;e++){let i=this.fighters[e];if(t(i)){this.focusFighter(e,!0);break}}this.focusableFighterPredicate=t}focusFighter(t,e=!1){let i=this.fighters[t];if(!i)throw new Error("UIBattleArea::focusFighter(): fighter not found !");this.focusedFighter=i,e&&u.emit(this,"E_FIGHTER_FOCUSED",{fighter:i,index:t})}unfocusFighter(t=!1){!this.focusedFighter||(this.focusedFighter=null,t&&u.emit(this,"E_FIGHTER_UNFOCUSED"))}prevFocus(){let t=this.fighters.indexOf(this.focusedFighter),e=0;for(;e<this.fighters.length;){if(t=t-1<0?this.fighters.length-1:t-1,this.focusableFighterPredicate(this.fighters[t])){this.focusFighter(t,!0);break}e++}}nextFocus(){let t=this.fighters.indexOf(this.focusedFighter),e=0;for(;e<this.fighters.length;){if(t=t+1>this.fighters.length-1?0:t+1,this.focusableFighterPredicate(this.fighters[t])){this.focusFighter(t,!0);break}e++}}async cameraOnAlly(){this.camera.play(Po,Ro,1500),await u.wait(this.camera,"E_FINISHED")}async cameraOnEnemy(){this.camera.play(Do,Oo,1500),await u.wait(this.camera,"E_FINISHED")}async cameraOnDefault(){this.camera.playBack(1500),await u.wait(this.camera,"E_FINISHED")}requestSelection(){document.addEventListener("keydown",this.handleKeyDownCb)}getFighters(){return this.fighters}getFocusedFighter(){return this.focusedFighter}handleKeyDown(t){t.key=="Escape"?(document.removeEventListener("keydown",this.handleKeyDownCb),u.emit(this,"E_CLOSED")):t.key=="Enter"?(document.removeEventListener("keydown",this.handleKeyDownCb),u.emit(this,"E_ENTER_PRESSED")):t.key=="ArrowLeft"?this.prevFocus():t.key=="ArrowRight"&&this.nextFocus()}}class Lo extends k{constructor(){super(),this.player=Vt.getPlayer(),this.inventory=this.player.getInventory(),this.battle=new Io,this.uiTitle=new ft,this.uiActionMenu=new it,this.uiEffects=new To,this.uiInventory=new De({showPrice:!1,showQuantity:!0}),this.uiHeroes=new yo,this.uiStatus=new Mo,this.area=new _o}async onEnter(t={battleId}){await this.battle.loadFromFile("samples/rpg/data/battle_"+t.battleId+"/data.json"),this.uiTitle.setVisible(!1),p.addWidget(this.uiTitle,"position:absolute; top:0; left:0; right:0; height:50px; z-index:2;"),this.uiActionMenu.add("ATTACK","Attaques"),this.uiActionMenu.add("MAGIC","Magies"),this.uiActionMenu.add("ITEMS","Objets"),this.uiActionMenu.add("LET","Passer"),p.addWidget(this.uiActionMenu,"position:absolute; bottom:0; left:0; width:20%; height:150px; z-index:1;"),this.uiEffects.setVisible(!1),p.addWidget(this.uiEffects,"position:absolute; top:50px; bottom:150px; left:0; right:0; z-index:2;"),this.uiInventory.setVisible(!1),this.uiInventory.setFilterPredicate(e=>e instanceof Tt),p.addWidget(this.uiInventory,"position:absolute; top:50px; bottom:150px; left:0; right:0; z-index:2;"),this.uiHeroes.setCollection(new Ct(this.player.getHeroes())),p.addWidget(this.uiHeroes,"position:absolute; bottom:0; left:20%; right:0; height:150px; z-index:1;"),this.uiStatus.setBattle(this.battle),p.addWidget(this.uiStatus,"position:absolute; top:0; left:0; right:0; height:50px; z-index:1;"),await this.area.loadFromBattle(this.battle),u.subscribe(this.battle,"E_CHAR_READY",this,this.handleBattleCharReady),u.subscribe(this.battle,"E_ACTION_BEFORE",this,this.handleBattleActionBefore),u.subscribe(this.battle,"E_ACTION_AFTER",this,this.handleBattleActionAfter),u.subscribe(this.battle,"E_WIN",this,this.handleBattleWin),u.subscribe(this.battle,"E_LOST",this,this.handleBattleLost),u.subscribe(this.uiHeroes,"E_ITEM_FOCUSED",this,this.handleHeroesItemFocused),u.subscribe(this.uiHeroes,"E_ITEM_SELECTED",this,this.handleHeroesItemSelected),u.subscribe(this.uiActionMenu,"E_CLOSED",this,this.handleActionMenuClosed),u.subscribe(this.uiActionMenu,"E_ITEM_SELECTED",this,this.handleActionMenuItemSelected),u.subscribe(this.uiEffects,"E_CLOSED",this,this.handleEffectsClosed),u.subscribe(this.uiEffects,"E_ITEM_SELECTED",this,this.handleEffectsItemSelected),u.subscribe(this.uiInventory,"E_CLOSED",this,this.handleItemsMenuClosed),u.subscribe(this.uiInventory,"E_ITEM_SELECTED",this,this.handleItemsMenuItemSelected),u.subscribe(this.area,"E_CLOSED",this,this.handleAreaClosed),u.subscribe(this.area,"E_ENTER_PRESSED",this,this.handleAreaEnterPressed),this.battle.startup()}async onExit(){p.removeWidget(this.uiTitle),p.removeWidget(this.uiActionMenu),p.removeWidget(this.uiEffects),p.removeWidget(this.uiInventory),p.removeWidget(this.uiHeroes),p.removeWidget(this.uiStatus),this.area.delete()}update(t){this.area.update(t)}draw(){this.area.draw()}handleBattleCharReady(t){t.char instanceof ze&&p.focus(this.uiHeroes)}async handleBattleActionBefore(t){t.action instanceof Se||(t.action.toChar instanceof ze?await this.area.cameraOnAlly():await this.area.cameraOnEnemy())}async handleBattleActionAfter(t){t.action instanceof Se||await this.area.cameraOnDefault()}handleBattleWin(){_.requestPopScreen()}handleBattleLost(){_.requestPopScreen()}handleHeroesItemFocused(t){let i=this.area.getFighters().findIndex(s=>s.getCharacter()==this.uiHeroes.getFocusedItem());this.area.focusFighter(i)}handleHeroesItemSelected(){p.focus(this.uiActionMenu)}handleActionMenuClosed(){this.uiHeroes.unselectWidgets(),p.focus(this.uiHeroes)}handleActionMenuItemSelected(t){let e=this.uiHeroes.getSelectedItem();t.id=="ATTACK"?(this.uiTitle.setText("Attaques"),this.uiEffects.setCollection(new Ct(e.getAttackEffects())),this.uiEffects.setEnablePredicate(i=>i.isUsable(e)),this.uiTitle.setVisible(!0),this.uiEffects.setVisible(!0),p.focus(this.uiEffects)):t.id=="MAGIC"?(this.uiTitle.setText("Magies"),this.uiEffects.setCollection(new Ct(e.getMagicEffects())),this.uiEffects.setEnablePredicate(i=>i.isUsable(e)),this.uiTitle.setVisible(!0),this.uiEffects.setVisible(!0),p.focus(this.uiEffects)):t.id=="ITEMS"?(this.uiTitle.setText("Objets"),this.uiInventory.setCollection(this.inventory),this.uiTitle.setVisible(!0),this.uiInventory.setVisible(!0),p.focus(this.uiInventory)):t.id=="LET"&&(this.battle.runAction(new ws(this.battle,e)),this.uiActionMenu.unselectWidgets(),this.uiHeroes.unselectWidgets())}handleEffectsClosed(){this.uiTitle.setVisible(!1),this.uiEffects.setVisible(!1),this.uiActionMenu.unselectWidgets(),p.focus(this.uiActionMenu)}handleEffectsItemSelected(){let t=this.uiHeroes.getSelectedItem(),e=this.uiEffects.getSelectedItem();this.uiTitle.setVisible(!1),this.uiEffects.setVisible(!1),this.area.setFocusableFighterPredicate(i=>e.isTargetCharConditionCheck(t,i.getCharacter())),this.area.requestSelection(),p.unfocus()}handleItemsMenuClosed(){this.uiTitle.setVisible(!1),this.uiInventory.setVisible(!1),this.uiActionMenu.unselectWidgets(),p.focus(this.uiActionMenu)}handleItemsMenuItemSelected(){let t=this.uiHeroes.getSelectedItem(),e=this.uiInventory.getSelectedItem();this.uiTitle.setVisible(!1),this.uiInventory.setVisible(!1),this.area.setFocusableFighterPredicate(i=>e.isTarget(t,i.getCharacter())),this.area.requestSelection(),p.unfocus()}handleAreaClosed(){let t=this.uiActionMenu.getSelectedId();t=="ATTACK"||t=="MAGIC"?(this.uiTitle.setVisible(!0),this.uiEffects.setVisible(!0),this.uiEffects.unselectWidgets(),p.focus(this.uiEffects)):t=="ITEMS"&&(this.uiTitle.setVisible(!0),this.uiInventory.setVisible(!0),this.uiInventory.unselectWidgets(),p.focus(this.uiInventory))}async handleAreaEnterPressed(){let t=this.uiActionMenu.getSelectedId(),e=this.uiHeroes.getSelectedItem(),i=this.area.getFocusedFighter().getCharacter();if(t=="ATTACK"||t=="MAGIC"){let s=this.uiEffects.getSelectedItem();await this.battle.runAction(new vs(this.battle,s,e,i))}else if(t=="ITEMS"){let s=this.uiInventory.getSelectedItem();await this.battle.runAction(new Eo(this.battle,s,e,i))}this.uiActionMenu.unselectWidgets(),this.uiHeroes.unselectWidgets()}}class si extends se{constructor(){super()}addItem(t,e=!0,i=-1){let s=new No;s.setHero(t),this.addWidget(s,e,i)}}class No extends H{constructor(){super({className:"UIHeroesItem",template:`
      <img class="UIHeroesItem-picture js-picture" src="#">
      <div class="UIHeroesItem-body">
        <div class="UIHeroesItem-body-name js-name"></div>
        <div class="UIHeroesItem-body-stats">
          <div class="UIHeroesItem-body-stats-item">
            <span class="UIHeroesItem-body-stats-item-name">HP</span>
            <span class="UIHeroesItem-body-stats-item-separator"></span>
            <span class="UIHeroesItem-body-stats-item-value js-hp-value"></span>
          </div>
          <div class="UIHeroesItem-body-stats-item">
            <span class="UIHeroesItem-body-stats-item-name">MP</span>
            <span class="UIHeroesItem-body-stats-item-separator"></span>
            <span class="UIHeroesItem-body-stats-item-value js-mp-value"></span>
          </div>
        </div>
      </div>`}),this.hero=null}update(t){this.hero?(this.node.querySelector(".js-picture").src=this.hero.getPictureFile(),this.node.querySelector(".js-name").textContent=this.hero.getName(),this.node.querySelector(".js-hp-value").textContent=this.hero.getAttribute("HP")+"/"+this.hero.getAttribute("HP_MAX"),this.node.querySelector(".js-mp-value").textContent=this.hero.getAttribute("MP")+"/"+this.hero.getAttribute("HP_MAX")):(this.node.querySelector(".js-picture").src="#",this.node.querySelector(".js-name").textContent="--",this.node.querySelector(".js-hp-value").textContent="--/--",this.node.querySelector(".js-mp-value").textContent="--/--")}getHero(){return this.hero}setHero(t){this.hero=t||null}}class bs extends se{constructor(){super()}addItem(t,e=!0,i=-1){let s=new Fo;s.setHero(t),this.addWidget(s,e,i)}}class Fo extends H{constructor(){super({className:"UIHeroesEquipmentItem",template:`
      <img class="UIHeroesEquipmentItem-picture js-picture" src="#">
      <div class="UIHeroesEquipmentItem-body">
        <div class="UIHeroesEquipmentItem-body-name js-name"></div>
        <div class="UIHeroesEquipmentItem-body-stats">
          <div class="UIHeroesEquipmentItem-body-stats-item">
            <span class="UIHeroesEquipmentItem-body-stats-item-name">HP MAX</span>
            <span class="UIHeroesEquipmentItem-body-stats-item-separator"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-value1 js-hp-max-value1"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-arrow"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-value2 js-hp-max-value2"></span>
          </div>
          <div class="UIHeroesEquipmentItem-body-stats-item">
            <span class="UIHeroesEquipmentItem-body-stats-item-name">MP MAX</span>
            <span class="UIHeroesEquipmentItem-body-stats-item-separator"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-value1 js-mp-max-value1"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-arrow"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-value2 js-mp-max-value2"></span>
          </div>
          <div class="UIHeroesEquipmentItem-body-stats-item">
            <span class="UIHeroesEquipmentItem-body-stats-item-name">ATK</span>
            <span class="UIHeroesEquipmentItem-body-stats-item-separator"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-value1 js-atk-value1"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-arrow"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-value2 js-atk-value2"></span>
          </div>
          <div class="UIHeroesEquipmentItem-body-stats-item">
            <span class="UIHeroesEquipmentItem-body-stats-item-name">DEF</span>
            <span class="UIHeroesEquipmentItem-body-stats-item-separator"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-value1 js-def-value1"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-arrow"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-value2 js-def-value2"></span>
          </div>
          <div class="UIHeroesEquipmentItem-body-stats-item">
            <span class="UIHeroesEquipmentItem-body-stats-item-name">M-ATK</span>
            <span class="UIHeroesEquipmentItem-body-stats-item-separator"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-value1 js-magic-atk-value1"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-arrow"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-value2 js-magic-atk-value2"></span>
          </div>
          <div class="UIHeroesEquipmentItem-body-stats-item">
            <span class="UIHeroesEquipmentItem-body-stats-item-name">M-DEF</span>
            <span class="UIHeroesEquipmentItem-body-stats-item-separator"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-value1 js-magic-def-value1"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-arrow"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-value2 js-magic-def-value2"></span>
          </div>
          <div class="UIHeroesEquipmentItem-body-stats-item">
            <span class="UIHeroesEquipmentItem-body-stats-item-name">AGI</span>
            <span class="UIHeroesEquipmentItem-body-stats-item-separator"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-value1 js-agility-value1"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-arrow"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-value2 js-agility-value2"></span>
          </div>
        </div>
      </div>`}),this.hero=null,this.equipmentItem=null}update(t){if(this.hero){let e=this.hero.getAttributes(),i=this.hero.isEquipableItem(this.equipmentItem)?this.hero.getAttributesWith(this.equipmentItem):{};this.node.querySelector(".js-picture").src=this.hero.getPictureFile(),this.node.querySelector(".js-name").textContent=this.hero.getName(),this.displayStat("hp-max",e.get("HP_MAX"),i.HP_MAX),this.displayStat("mp-max",e.get("MP_MAX"),i.MP_MAX),this.displayStat("atk",e.get("ATK"),i.ATK),this.displayStat("def",e.get("DEF"),i.DEF),this.displayStat("magic-atk",e.get("MAGIC_ATK"),i.MAGIC_ATK),this.displayStat("magic-def",e.get("MAGIC_DEF"),i.MAGIC_DEF),this.displayStat("agility",e.get("AGILITY"),i.AGILITY)}else this.node.querySelector(".js-picture").src="#",this.node.querySelector(".js-name").textContent="--",this.displayStat("hp-max","--"),this.displayStat("mp-max","--"),this.displayStat("atk","--"),this.displayStat("def","--"),this.displayStat("magic-atk","--"),this.displayStat("magic-def","--"),this.displayStat("agility","--")}getHero(){return this.hero}setHero(t){this.hero=t||null}setEquipmentItem(t){this.equipmentItem=t||null}displayStat(t,e,i){this.node.querySelector(".js-"+t+"-value1").textContent=e||"",this.node.querySelector(".js-"+t+"-value2").textContent=i||"",this.node.querySelector(".js-"+t+"-value2").style.display=i?"block":"none",this.node.querySelector(".js-"+t+"-value2").style.color=i>e?"#00d600":i<e?"#ff2929":"#fff"}}class Bo extends k{constructor(){super(),this.player=Vt.getPlayer(),this.inventory=this.player.getInventory(),this.uiTopMenu=new it({axis:xe.X}),this.uiTitle=new ft,this.uiDescription=new ft,this.uiInventory=new De({showPrice:!1,showQuantity:!0}),this.uiHeroes=new bs,this.uiSortMenu=new it,this.uiFilterMenu=new it}async onEnter(){this.uiTopMenu.add("APPLY","Equiper"),this.uiTopMenu.add("DELETE","Supprimer"),this.uiTopMenu.add("SORT","Trier"),this.uiTopMenu.add("FILTER","Filtrer"),p.addWidget(this.uiTopMenu,"position:absolute; top:0; left:0; width:70%; height:50px;"),this.uiTitle.setText("Objets"),p.addWidget(this.uiTitle,"position:absolute; top:0; left:70%; width:30%; height:50px;"),this.uiDescription.setText("Description..."),p.addWidget(this.uiDescription,"position:absolute; top:50px; left:0; width:100%; height:50px;"),this.uiInventory.setFilterPredicate(t=>t instanceof at),this.uiInventory.setCollection(this.player.getInventory()),p.addWidget(this.uiInventory,"position:absolute; top:100px; left:0; bottom:0; width:40%;"),this.uiHeroes.setCollection(new Ct(this.player.getHeroes())),p.addWidget(this.uiHeroes,"position:absolute; top:100px; left:40%; bottom:0; width:60%;"),this.uiSortMenu.setVisible(!1),this.uiSortMenu.add("NONE","Aucun"),this.uiSortMenu.add("ALPHA","Alphab\xE9tique"),this.uiSortMenu.add("QUANTITY","Quantit\xE9"),p.addWidget(this.uiSortMenu,"position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);"),this.uiFilterMenu.setVisible(!1),this.uiFilterMenu.add("NONE","Aucun"),this.uiFilterMenu.add("WEAPON","Arme"),this.uiFilterMenu.add("HELMET","Haume"),this.uiFilterMenu.add("ARMOR","Armure"),this.uiFilterMenu.add("RELIC","Relique"),p.addWidget(this.uiFilterMenu,"position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);"),u.subscribe(this.uiTopMenu,"E_CLOSED",this,this.handleTopMenuClosed),u.subscribe(this.uiTopMenu,"E_FOCUSED",this,this.handleTopMenuFocused),u.subscribe(this.uiTopMenu,"E_ITEM_SELECTED",this,this.handleTopMenuItemSelected),u.subscribe(this.uiInventory,"E_CLOSED",this,this.handleInventoryClosed),u.subscribe(this.uiInventory,"E_ITEM_FOCUSED",this,this.handleInventoryItemFocused),u.subscribe(this.uiInventory,"E_ITEM_SELECTED",this,this.handleInventoryItemSelected),u.subscribe(this.uiHeroes,"E_CLOSED",this,this.handleHeroesClosed),u.subscribe(this.uiHeroes,"E_ITEM_SELECTED",this,this.handleHeroesItemSelected),u.subscribe(this.uiSortMenu,"E_ITEM_SELECTED",this,this.handleSortMenuItemSelected),u.subscribe(this.uiFilterMenu,"E_ITEM_SELECTED",this,this.handleFilterMenuItemSelected),p.focus(this.uiTopMenu)}async onExit(){p.removeWidget(this.uiTopMenu),p.removeWidget(this.uiTitle),p.removeWidget(this.uiDescription),p.removeWidget(this.uiInventory),p.removeWidget(this.uiHeroes),p.removeWidget(this.uiSortMenu),p.removeWidget(this.uiFilterMenu)}handleTopMenuClosed(){_.requestPopScreen()}handleTopMenuFocused(){this.uiTopMenu.setEnabledWidget(0,this.inventory.hasEquipmentItems()),this.uiTopMenu.setEnabledWidget(1,this.inventory.hasEquipmentItems()),this.uiDescription.setText("Description...");for(let t of this.uiHeroes.getWidgets())t.setEquipmentItem(null),t.setEnabled(!0)}handleTopMenuItemSelected(t){t.id=="APPLY"?p.focus(this.uiInventory):t.id=="DELETE"?p.focus(this.uiInventory):t.id=="SORT"?(this.uiSortMenu.setVisible(!0),p.focus(this.uiSortMenu)):t.id=="FILTER"&&(this.uiFilterMenu.setVisible(!0),p.focus(this.uiFilterMenu))}handleInventoryClosed(){this.uiInventory.unselectWidgets(),this.uiTopMenu.unselectWidgets(),p.focus(this.uiTopMenu)}handleInventoryItemFocused(t){let e=this.uiInventory.getFocusedItem();this.uiDescription.setText(e.getDescription());for(let i of this.uiHeroes.getWidgets()){let s=i.getHero();i.setEquipmentItem(e),i.setEnabled(s.isEquipableItem(e))}}handleInventoryItemSelected(t){let e=this.uiTopMenu.getSelectedId();if(e=="APPLY")p.focus(this.uiHeroes);else if(e=="DELETE"){let i=this.uiInventory.getSelectedItem();this.inventory.removeItemById(i.getId()),this.uiInventory.unselectWidgets(),this.uiTopMenu.unselectWidgets(),p.focus(this.uiTopMenu)}}handleHeroesClosed(){this.uiHeroes.unselectWidgets(),this.uiInventory.unselectWidgets(),p.focus(this.uiInventory)}handleHeroesItemSelected(){let t=this.uiInventory.getSelectedItem(),i=this.uiHeroes.getSelectedItem().setEquipment(t);i&&this.inventory.addItem(i),this.inventory.removeItemById(t.getId()),this.uiHeroes.unselectWidgets(),this.uiInventory.unselectWidgets(),this.uiTopMenu.unselectWidgets(),p.focus(this.uiTopMenu)}handleSortMenuItemSelected(t){t.id=="NONE"?this.uiInventory.setSortPredicate(()=>!0):t.id=="ALPHA"?this.uiInventory.setSortPredicate((e,i)=>e.getName().localeCompare(i.getName())):t.id=="QUANTITY"&&this.uiInventory.setSortPredicate((e,i)=>e.getQuantity()-i.getQuantity()),this.uiSortMenu.setVisible(!1),this.uiTopMenu.unselectWidgets(),p.focus(this.uiTopMenu)}handleFilterMenuItemSelected(t){t.id=="NONE"?this.uiInventory.setFilterPredicate(e=>e instanceof at):t.id=="WEAPON"?this.uiInventory.setFilterPredicate(e=>e instanceof at&&e.getType()==pt.WEAPON):t.id=="HELMET"?this.uiInventory.setFilterPredicate(e=>e instanceof at&&e.getType()==pt.HELMET):t.id=="ARMOR"?this.uiInventory.setFilterPredicate(e=>e instanceof at&&e.getType()==pt.ARMOR):t.id=="RELIC"&&this.uiInventory.setFilterPredicate(e=>e instanceof at&&e.getType()==pt.RELIC),this.uiFilterMenu.setVisible(!1),this.uiTopMenu.unselectWidgets(),p.focus(this.uiTopMenu)}}class Vo extends k{constructor(){super(),this.player=Vt.getPlayer(),this.inventory=this.player.getInventory(),this.uiTopMenu=new it({axis:xe.X}),this.uiTitle=new ft,this.uiDescription=new ft,this.uiInventory=new De({showPrice:!1,showQuantity:!0}),this.uiHeroes=new si,this.uiSortMenu=new it,this.uiFilterMenu=new it}async onEnter(){this.uiTopMenu.add("APPLY","Utiliser"),this.uiTopMenu.add("DELETE","Supprimer"),this.uiTopMenu.add("SORT","Trier"),this.uiTopMenu.add("FILTER","Filtrer"),p.addWidget(this.uiTopMenu,"position:absolute; top:0; left:0; width:70%; height:50px;"),this.uiTitle.setText("Objets"),p.addWidget(this.uiTitle,"position:absolute; top:0; left:70%; width:30%; height:50px;"),this.uiDescription.setText("Description..."),p.addWidget(this.uiDescription,"position:absolute; top:50px; left:0; width:100%; height:50px;"),this.uiInventory.setFilterPredicate(t=>t instanceof Tt),this.uiInventory.setCollection(this.inventory),p.addWidget(this.uiInventory,"position:absolute; top:100px; left:0; bottom:0; width:40%;"),this.uiHeroes.setCollection(new Ct(this.player.getHeroes())),p.addWidget(this.uiHeroes,"position:absolute; top:100px; left:40%; bottom:0; width:60%;"),this.uiSortMenu.setVisible(!1),this.uiSortMenu.add("NONE","Aucun"),this.uiSortMenu.add("ALPHA","Alphab\xE9tique"),this.uiSortMenu.add("QUANTITY","Quantit\xE9"),p.addWidget(this.uiSortMenu,"position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);"),this.uiFilterMenu.setVisible(!1),this.uiFilterMenu.add("NONE","Aucun"),this.uiFilterMenu.add("POTION","Potion"),this.uiFilterMenu.add("FOOD","Nourriture"),this.uiFilterMenu.add("OTHER","Autre"),p.addWidget(this.uiFilterMenu,"position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);"),u.subscribe(this.uiTopMenu,"E_CLOSED",this,this.handleTopMenuClosed),u.subscribe(this.uiTopMenu,"E_FOCUSED",this,this.handleTopMenuFocused),u.subscribe(this.uiTopMenu,"E_ITEM_SELECTED",this,this.handleTopMenuItemSelected),u.subscribe(this.uiInventory,"E_CLOSED",this,this.handleInventoryClosed),u.subscribe(this.uiInventory,"E_ITEM_FOCUSED",this,this.handleInventoryItemFocused),u.subscribe(this.uiInventory,"E_ITEM_SELECTED",this,this.handleInventoryItemSelected),u.subscribe(this.uiHeroes,"E_CLOSED",this,this.handleHeroesClosed),u.subscribe(this.uiHeroes,"E_ITEM_SELECTED",this,this.handleHeroesItemSelected),u.subscribe(this.uiSortMenu,"E_ITEM_SELECTED",this,this.handleSortMenuItemSelected),u.subscribe(this.uiFilterMenu,"E_ITEM_SELECTED",this,this.handleFilterMenuItemSelected),p.focus(this.uiTopMenu)}async onExit(){p.removeWidget(this.uiTopMenu),p.removeWidget(this.uiTitle),p.removeWidget(this.uiDescription),p.removeWidget(this.uiInventory),p.removeWidget(this.uiHeroes),p.removeWidget(this.uiSortMenu),p.removeWidget(this.uiFilterMenu)}handleTopMenuClosed(){_.requestPopScreen()}handleTopMenuFocused(){this.uiTopMenu.setEnabledWidget(0,this.inventory.hasMenuAvailableItems()),this.uiTopMenu.setEnabledWidget(1,this.inventory.hasCommonItems()),this.uiDescription.setText("Description...");for(let t of this.uiHeroes.getWidgets())t.setEnabled(!0)}handleTopMenuItemSelected(t){t.id=="APPLY"?(this.uiInventory.setEnablePredicate(e=>e.isMenuAvailable()),p.focus(this.uiInventory)):t.id=="DELETE"?(this.uiInventory.setEnablePredicate(e=>!0),p.focus(this.uiInventory)):t.id=="SORT"?(this.uiSortMenu.setVisible(!0),p.focus(this.uiSortMenu)):t.id=="FILTER"&&(this.uiFilterMenu.setVisible(!0),p.focus(this.uiFilterMenu))}handleInventoryClosed(){this.uiInventory.unselectWidgets(),this.uiTopMenu.unselectWidgets(),p.focus(this.uiTopMenu)}handleInventoryItemFocused(t){let e=this.uiInventory.getFocusedItem();this.uiDescription.setText(e.description);for(let i of this.uiHeroes.getWidgets()){let s=i.getHero();i.setEnabled(e.isTarget(s,s))}}handleInventoryItemSelected(t){let e=this.uiTopMenu.getSelectedId();if(e=="APPLY")p.focus(this.uiHeroes);else if(e=="DELETE"){let i=this.uiInventory.getSelectedItem();this.inventory.removeItemById(i.getId()),this.uiInventory.unselectWidgets(),this.uiTopMenu.unselectWidgets(),p.focus(this.uiTopMenu)}}handleHeroesClosed(){this.uiHeroes.unselectWidgets(),this.uiInventory.unselectWidgets(),p.focus(this.uiInventory)}handleHeroesItemSelected(){let t=this.uiInventory.getSelectedItem(),e=this.uiHeroes.getSelectedItem();t.getEffect().apply(e,e),this.inventory.removeItemById(t.getId()),this.uiHeroes.unselectWidgets(),this.uiInventory.unselectWidgets(),this.uiTopMenu.unselectWidgets(),p.focus(this.uiTopMenu)}handleSortMenuItemSelected(t){t.id=="NONE"?this.uiInventory.setSortPredicate(()=>!0):t.id=="ALPHA"?this.uiInventory.setSortPredicate((e,i)=>e.getName().localeCompare(i.getName())):t.id=="QUANTITY"&&this.uiInventory.setSortPredicate((e,i)=>e.getQuantity()-i.getQuantity()),this.uiSortMenu.setVisible(!1),this.uiTopMenu.unselectWidgets(),p.focus(this.uiTopMenu)}handleFilterMenuItemSelected(t){t.id=="NONE"?this.uiInventory.setFilterPredicate(e=>e instanceof Tt):t.id=="POTION"?this.uiInventory.setFilterPredicate(e=>e instanceof Tt&&e.getType()==pt.POTION):t.id=="FOOD"?this.uiInventory.setFilterPredicate(e=>e instanceof Tt&&e.getType()==pt.FOOD):t.id=="OTHER"&&this.uiInventory.setFilterPredicate(e=>e instanceof Tt&&e.getType()==pt.OTHER),this.uiFilterMenu.setVisible(!1),this.uiTopMenu.unselectWidgets(),p.focus(this.uiTopMenu)}}class Uo extends H{constructor(){super({className:"UIStatus",template:`
      <div class="UIStatus-avatar">
        <img class="UIStatus-avatar-picture js-picture" src="#">
        <div class="UIStatus-avatar-name js-name"></div>
      </div>
      <div class="UIStatus-title">STATS</div>
      <div class="UIStatus-section">
        <div class="UIStatus-stats">
          <div class="UIStatus-stats-item">
            <span class="UIStatus-stats-item-name">LV</span>
            <span class="UIStatus-stats-item-separator"></span>
            <span class="UIStatus-stats-item-value js-lv-value"></span>
          </div>
          <div class="UIStatus-stats-item">
            <span class="UIStatus-stats-item-name">XP</span>
            <span class="UIStatus-stats-item-separator"></span>
            <span class="UIStatus-stats-item-value js-xp-value"></span>
          </div>
          <div class="UIStatus-stats-item">
            <span class="UIStatus-stats-item-name">HP</span>
            <span class="UIStatus-stats-item-separator"></span>
            <span class="UIStatus-stats-item-value js-hp-value"></span>
          </div>
          <div class="UIStatus-stats-item">
            <span class="UIStatus-stats-item-name">MP</span>
            <span class="UIStatus-stats-item-separator"></span>
            <span class="UIStatus-stats-item-value js-mp-value"></span>
          </div>
          <div class="UIStatus-stats-item">
            <span class="UIStatus-stats-item-name">ATK</span>
            <span class="UIStatus-stats-item-separator"></span>
            <span class="UIStatus-stats-item-value js-atk-value"></span>
          </div>
          <div class="UIStatus-stats-item">
            <span class="UIStatus-stats-item-name">DEF</span>
            <span class="UIStatus-stats-item-separator"></span>
            <span class="UIStatus-stats-item-value js-def-value"></span>
          </div>
          <div class="UIStatus-stats-item">
            <span class="UIStatus-stats-item-name">M-ATK</span>
            <span class="UIStatus-stats-item-separator"></span>
            <span class="UIStatus-stats-item-value js-matk-value"></span>
          </div>
          <div class="UIStatus-stats-item">
            <span class="UIStatus-stats-item-name">M-DEF</span>
            <span class="UIStatus-stats-item-separator"></span>
            <span class="UIStatus-stats-item-value js-mdef-value"></span>
          </div>
          <div class="UIStatus-stats-item">
            <span class="UIStatus-stats-item-name">AGILITE</span>
            <span class="UIStatus-stats-item-separator"></span>
            <span class="UIStatus-stats-item-value js-agility-value"></span>
          </div>
          <div class="UIStatus-stats-item">
            <span class="UIStatus-stats-item-name">ELEMENT</span>
            <span class="UIStatus-stats-item-separator"></span>
            <span class="UIStatus-stats-item-value js-element-value"></span>
          </div>
        </div>
      </div>
      <div class="UIStatus-title">EQUIPEMENTS</div>
      <div class="UIStatus-section">
        <div class="UIStatus-stuffs">
          <div class="UIStatus-stuffs-item">
            <span class="UIStatus-stuffs-item-name">ARME</span>
            <span class="UIStatus-stuffs-item-separator"></span>
            <span class="UIStatus-stuffs-item-value js-weapon-value"></span>
          </div>
          <div class="UIStatus-stuffs-item">
            <span class="UIStatus-stuffs-item-name">CASQUE</span>
            <span class="UIStatus-stuffs-item-separator"></span>
            <span class="UIStatus-stuffs-item-value js-helmet-value"></span>
          </div>
          <div class="UIStatus-stuffs-item">
            <span class="UIStatus-stuffs-item-name">ARMURE</span>
            <span class="UIStatus-stuffs-item-separator"></span>
            <span class="UIStatus-stuffs-item-value js-armor-value"></span>
          </div>
          <div class="UIStatus-stuffs-item">
            <span class="UIStatus-stuffs-item-name">RELIQUE</span>
            <span class="UIStatus-stuffs-item-separator"></span>
            <span class="UIStatus-stuffs-item-value js-relic-value"></span>
          </div>
        </div>
      </div>
      <div class="UIStatus-title">DESCRIPTION</div>
      <div class="UIStatus-section">
        <div class="UIStatus-description js-description"></div>
      </div>`}),this.hero=null}update(){if(this.hero){let t=this.hero.getWeapon(),e=this.hero.getHelmet(),i=this.hero.getArmor(),s=this.hero.getRelic();this.node.querySelector(".js-picture").src=this.hero.getPictureFile(),this.node.querySelector(".js-name").textContent=this.hero.getName(),this.node.querySelector(".js-lv-value").textContent=this.hero.getAttribute("LV")+"/"+this.hero.getAttribute("LV_MAX"),this.node.querySelector(".js-xp-value").textContent=this.hero.getAttribute("XP")+"/"+this.hero.getAttribute("XP_MAX"),this.node.querySelector(".js-hp-value").textContent=this.hero.getAttribute("HP")+"/"+this.hero.getAttribute("HP_MAX"),this.node.querySelector(".js-mp-value").textContent=this.hero.getAttribute("MP")+"/"+this.hero.getAttribute("MP_MAX"),this.node.querySelector(".js-atk-value").textContent=this.hero.getAttribute("ATK"),this.node.querySelector(".js-def-value").textContent=this.hero.getAttribute("DEF"),this.node.querySelector(".js-matk-value").textContent=this.hero.getAttribute("MAGIC_ATK"),this.node.querySelector(".js-mdef-value").textContent=this.hero.getAttribute("MAGIC_DEF"),this.node.querySelector(".js-agility-value").textContent=this.hero.getAttribute("AGILITY"),this.node.querySelector(".js-element-value").textContent=this.hero.getAttribute("ELEMENT"),this.node.querySelector(".js-weapon-value").textContent=t?t.getName():"Vide",this.node.querySelector(".js-helmet-value").textContent=e?e.getName():"Vide",this.node.querySelector(".js-armor-value").textContent=i?i.getName():"Vide",this.node.querySelector(".js-relic-value").textContent=s?s.getName():"Vide"}else this.node.querySelector(".js-picture").src="#",this.node.querySelector(".js-name").textContent="",this.node.querySelector(".js-lv-value").textContent="--/--",this.node.querySelector(".js-xp-value").textContent="--/--",this.node.querySelector(".js-hp-value").textContent="--/--",this.node.querySelector(".js-mp-value").textContent="--/--",this.node.querySelector(".js-atk-value").textContent="--",this.node.querySelector(".js-def-value").textContent="--",this.node.querySelector(".js-matk-value").textContent="--",this.node.querySelector(".js-mdef-value").textContent="--",this.node.querySelector(".js-agility-value").textContent="--",this.node.querySelector(".js-element-value").textContent="--",this.node.querySelector(".js-weapon-value").textContent="Vide",this.node.querySelector(".js-helmet-value").textContent="Vide",this.node.querySelector(".js-armor-value").textContent="Vide",this.node.querySelector(".js-relic-value").textContent="Vide"}setHero(t){this.hero=t||null}}class Wi extends k{constructor(t){super(),this.hero=t,this.uiTitle=new ft,this.uiStatus=new Uo,this.handleKeyDownCb=e=>this.handleKeyDown(e)}async onEnter(){this.uiTitle.setText("Status"),p.addWidget(this.uiTitle,"position:absolute; top:0; left:0; width:100%; height:50px"),this.uiStatus.setHero(this.hero),p.addWidget(this.uiStatus,"position:absolute; top:50px; left:0; bottom:0; width:100%"),document.addEventListener("keydown",this.handleKeyDownCb)}onExit(){document.removeEventListener("keydown",this.handleKeyDownCb),p.removeWidget(this.uiTitle),p.removeWidget(this.uiStatus)}handleKeyDown(t){t.key=="Escape"&&_.requestPopScreen()}}class Ho extends k{constructor(){super(),this.player=Vt.getPlayer(),this.uiTitle=new ft,this.uiMainMenu=new it,this.uiHeroes=new si}async onEnter(){this.uiTitle.setText("Menu"),p.addWidget(this.uiTitle,"position:absolute; top:0; left:0; right:0; height:50px"),this.uiMainMenu.add("ITEMS","Objets"),this.uiMainMenu.add("STUFFS","Equipements"),this.uiMainMenu.add("STATUS","Status"),p.addWidget(this.uiMainMenu,"position:absolute; top:50px; left:0; bottom:0; width:40%"),this.uiHeroes.setCollection(new Ct(this.player.getHeroes())),p.addWidget(this.uiHeroes,"position:absolute; top:50px; left:40%; bottom:0; width:60%"),u.subscribe(this.uiMainMenu,"E_CLOSED",this,this.handleMainMenuClosed),u.subscribe(this.uiMainMenu,"E_ITEM_SELECTED",this,this.handleMainMenuItemSelected),u.subscribe(this.uiHeroes,"E_CLOSED",this,this.handleHeroesClosed),u.subscribe(this.uiHeroes,"E_ITEM_SELECTED",this,this.handleHeroesItemSelected),p.focus(this.uiMainMenu)}async onExit(){p.removeWidget(this.uiTitle),p.removeWidget(this.uiMainMenu),p.removeWidget(this.uiHeroes)}onBringToFront(t){p.focus(t instanceof Wi?this.uiHeroes:this.uiMainMenu)}onBringToBack(){p.unfocus(),this.uiMainMenu.unselectWidgets(),this.uiHeroes.unselectWidgets()}handleMainMenuClosed(){_.requestPopScreen()}handleMainMenuItemSelected(t){t.id=="ITEMS"?_.requestPushScreen(new Vo):t.id=="STUFFS"?_.requestPushScreen(new Bo):t.id=="STATUS"&&p.focus(this.uiHeroes)}handleHeroesClosed(){this.uiMainMenu.unselectWidgets(),p.focus(this.uiMainMenu)}handleHeroesItemSelected(t){let e=this.uiHeroes.getSelectedItem();_.requestPushScreen(new Wi(e))}}class ki extends H{constructor(){super({className:"UIDescriptionList"})}addItem(t,e,i){const s=document.createElement("template");s.innerHTML=`
    <span class="UIDescriptionList-item js-${t}">
      <span class="UIDescriptionList-item-label js-label">${e}</span>
      <span class="UIDescriptionList-item-value js-value">${i}</span>
    </span>`,this.node.appendChild(s.content)}removeItem(t){const e=this.node.querySelector(".js-"+t);if(!e)throw new Error("UIDescriptionList::removeItem(): item not found !");this.node.removeChild(e)}setItem(t,e){const i=this.node.querySelector(".js-"+t);if(!i)throw new Error("UIDescriptionList::setItem(): item not found !");i.querySelector(".js-value").textContent=e}getItemValue(t){const e=this.node.querySelector(".js-"+t);if(!e)throw new Error("UIDescriptionList::getItemValue(): item not found !");const i=e.querySelector(".js-value").textContent;return i||""}isItemVisible(t){const e=this.node.querySelector(".js-"+t);if(!e)throw new Error("UIDescriptionList::getItemVisible(): item not found !");return!e.classList.contains("u-hidden")}setItemVisible(t,e){const i=this.node.querySelector(".js-"+t);if(!i)throw new Error("UIDescriptionList::setItemVisible(): item not found !");e?i.classList.remove("u-hidden"):i.classList.add("u-hidden")}clear(){this.node.innerHTML=""}}let ye={COMMON_STORE:"COMMON_STORE",EQUIPMENT_STORE:"EQUIPMENT_STORE"},ct={QUANTITY:0,TOTAL:1},de={GILS:0,INVENTORY:1};class Gi extends k{constructor(t){super(),this.mode=t,this.player=Vt.getPlayer(),this.inventory=this.player.getInventory(),this.shopInventory=new Ms,this.uiText=new ft,this.uiTitle=new ft,this.uiDescription=new ft,this.uiInventory=new De({showPrice:!0,showQuantity:!1}),this.uiPlayerDesc=new ki,this.uiCheckoutDesc=new ki,this.uiHeroes=t==ye.COMMON_STORE?new si:new bs,this.handleKeyDownCb=e=>this.handleKeyDown(e)}async onEnter(t={inventoryId}){await this.shopInventory.loadFromFile("samples/rpg/data/inventory_"+t.inventoryId+"/data.json"),this.uiText.setText("Que voulez-vous acheter ?"),p.addWidget(this.uiText,"position:absolute; top:0px; left:0; width:70%; height:50px;"),this.uiTitle.setText("Magasin"),p.addWidget(this.uiTitle,"position:absolute; top:0; left:70%; width:30%; height:50px;"),this.uiDescription.setText("Description..."),p.addWidget(this.uiDescription,"position:absolute; top:50px; left:0; width:100%; height:50px;"),this.uiInventory.setCollection(this.shopInventory),p.addWidget(this.uiInventory,"position:absolute; top:100px; left:0; bottom:0; width:50%;"),this.uiPlayerDesc.addItem(de.GILS,"Gils",this.player.getGils()),this.uiPlayerDesc.addItem(de.INVENTORY,"Inventaire",0),p.addWidget(this.uiPlayerDesc,"position:absolute; top:100px; left:50%; width:50%; height:84px"),this.uiCheckoutDesc.setVisible(!1),this.uiCheckoutDesc.addItem(ct.QUANTITY,"Quantite",0),this.uiCheckoutDesc.addItem(ct.TOTAL,"Total",0),p.addWidget(this.uiCheckoutDesc,"position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); z-index:10;"),this.uiHeroes.setCollection(new Ct(this.player.getHeroes())),p.addWidget(this.uiHeroes,"position:absolute; top:184px; left:50%; bottom:0; width:50%;"),u.subscribe(this.uiInventory,"E_CLOSED",this,this.handleInventoryClosed),u.subscribe(this.uiInventory,"E_ITEM_FOCUSED",this,this.handleInventoryItemFocused),u.subscribe(this.uiInventory,"E_ITEM_SELECTED",this,this.handleInventoryItemSelected),p.focus(this.uiInventory)}async onExit(){document.removeEventListener("keydown",this.handleKeyDownCb),p.removeWidget(this.uiText),p.removeWidget(this.uiTitle),p.removeWidget(this.uiDescription),p.removeWidget(this.uiInventory),p.removeWidget(this.uiPlayerDesc),p.removeWidget(this.uiCheckoutDesc),p.removeWidget(this.uiHeroes)}handleInventoryClosed(){_.requestPopScreen()}handleInventoryItemFocused(t){let e=this.uiInventory.getFocusedItem(),s=this.inventory.getItems().find(r=>r.getId()==e.getId());if(this.uiDescription.setText(e.description),this.uiPlayerDesc.setItem(de.INVENTORY,s?s.quantity:"0"),this.mode==ye.COMMON_STORE)for(let r of this.uiHeroes.getWidgets()){let n=r.getHero();r.setEnabled(e.isTarget(n,n))}else for(let r of this.uiHeroes.getWidgets()){let n=r.getHero();r.setEquipmentItem(e),r.setEnabled(n.isEquipableItem(e))}}handleInventoryItemSelected(){this.uiCheckoutDesc.setVisible(!0),p.focus(this.uiCheckoutDesc),document.addEventListener("keydown",this.handleKeyDownCb)}handleKeyDown(t){let e=this.uiInventory.getSelectedItem(),i=parseInt(this.uiCheckoutDesc.getItemValue(ct.QUANTITY));if(t.key=="ArrowUp"){let s=i+1;this.uiCheckoutDesc.setItem(ct.QUANTITY,s),this.uiCheckoutDesc.setItem(ct.TOTAL,s*e.getPrice())}else if(t.key=="ArrowDown"&&i>0){let s=i-1;this.uiCheckoutDesc.setItem(ct.QUANTITY,s),this.uiCheckoutDesc.setItem(ct.TOTAL,s*e.getPrice())}else if(t.key=="Enter"){let s=i*e.getPrice();if(this.player.getGils()-s<0)return;e.setQuantity(i),this.player.decreaseGils(s),this.inventory.addItem(e),this.uiPlayerDesc.setItem(de.GILS,this.player.getGils()),this.uiCheckoutDesc.setItem(ct.QUANTITY,0),this.uiCheckoutDesc.setItem(ct.TOTAL,0),this.uiCheckoutDesc.setVisible(!1),this.uiInventory.unselectWidgets(),p.focus(this.uiInventory),document.removeEventListener("keydown",this.handleKeyDownCb)}else t.key=="Escape"&&(this.uiCheckoutDesc.setItem(ct.QUANTITY,0),this.uiCheckoutDesc.setItem(ct.TOTAL,0),this.uiCheckoutDesc.setVisible(!1),this.uiInventory.unselectWidgets(),p.focus(this.uiInventory),document.removeEventListener("keydown",this.handleKeyDownCb))}}class jo extends k{constructor(){super(),this.uiMenu=new it}async onEnter(){await Vt.init(),this.uiMenu.add("0","Battle"),this.uiMenu.add("1","Menu"),this.uiMenu.add("2","Shop items"),this.uiMenu.add("3","Shop stuff"),p.addWidget(this.uiMenu,"position:absolute; top:50%; left:50%; width:60%; transform:translate(-50%,-50%);"),u.subscribe(this.uiMenu,"E_ITEM_SELECTED",this,this.handleMenuItemSelected),p.focus(this.uiMenu)}onExit(){p.removeWidget(this.uiMenu)}onBringToFront(){this.uiMenu.setVisible(!0),p.focus(this.uiMenu)}onBringToBack(){this.uiMenu.setVisible(!1),this.uiMenu.unselectWidgets()}handleMenuItemSelected(t){t.id==0?_.requestPushScreen(new Lo,{battleId:"0000"}):t.id==1?_.requestPushScreen(new Ho):t.id==2?_.requestPushScreen(new Gi(ye.COMMON_STORE),{inventoryId:"0000"}):t.id==3&&_.requestPushScreen(new Gi(ye.EQUIPMENT_STORE),{inventoryId:"0001"})}}const ke=100,Wo=100,qi=5;class ko{constructor(t=[0,0,0],e=[0,0,0],i=[0,0,0]){this.p=t,this.a=e,this.s=i,this.m=l.MAT4_CREATE()}}class Go extends k{constructor(){super(),this.camera=new ee(0),this.isDragging=!1,this.dragStartPosition=[0,0],this.dragStartRotation=[0,0],this.mode=1,this.colFac=0,this.obj=null,this.bigMesh=null,this.skySphere=null,this.transformations=[],this.handleMouseDownCb=this.handleMouseDown.bind(this),this.handleMouseUpCb=this.handleMouseUp.bind(this),this.handleMouseMoveCb=this.handleMouseMove.bind(this),this.handleKeyUpCb=this.handleKeyUp.bind(this)}async onEnter(){const t=x.getView(0);t.setPerspectiveFar(700),t.setPerspectiveNear(.1),ot.enableDirLight(1,[0,-1,.2]),ot.setDirLightColor([.8,.6,.4]),this.camera.setPosition(0,10,0),this.skySphere=new J,await this.skySphere.loadFromFile("./samples/perf/sky_sphere.jsm"),this.skySphere.setMaterial(new Q({texture:await b.loadTexture("./samples/perf/sky_sphere.jpg")})),this.obj=new J,await this.obj.loadFromFile("./samples/perf/cube.jsm"),this.obj.setMaterial(new Q({texture:await b.loadTexture("./samples/perf/cube.png"),lightning:!0}));for(let i=0;i<Wo;i++)for(let s=0;s<ke;s++){const r=(s-ke/2)*qi,n=(i-ke/2)*qi,o=[r,0,n,1],h=[s,0,i],c=[1,1,1];this.transformations.push(new ko(o,h,c))}const e=this.transformations.map(i=>l.MAT4_TRANSFORM(i.p,i.a,i.s));this.bigMesh=qo(this.obj,e),document.addEventListener("mousedown",this.handleMouseDownCb),document.addEventListener("mouseup",this.handleMouseUpCb),document.addEventListener("mousemove",this.handleMouseMoveCb),document.addEventListener("keyup",this.handleKeyUpCb)}onExit(){document.removeEventListener("mousedown",this.handleMouseDownCb),document.removeEventListener("mouseup",this.handleMouseUpCb),document.removeEventListener("mousemove",this.handleMouseMoveCb)}update(t){const e=(Math.sin(this.colFac)+1)*.5,i=(Math.cos(this.colFac)+1)*.5;this.obj.mat.setSpecular(e,i,0),this.obj.mat.setDiffuse(0,e,i);const s=Math.PI*2*4/this.transformations.length;let r=0;for(const n of this.transformations)n.a[0]+=t/500,n.a[2]+=t/1e3,n.p[1]=Math.sin(r+this.colFac)*3,l.MAT4_TRANSFORM(n.p,n.a,n.s,n.m),r+=s;this.colFac+=t*.003}draw(){if(this.skySphere.draw(),this.mode==0)this.bigMesh.draw();else for(const t of this.transformations)ot.drawMesh(this.obj,t.m)}handleKeyUp(t){t.code==="KeyR"&&(this.mode=this.mode==1?0:1)}handleMouseDown(t){this.isDragging=!0,this.dragStartPosition[0]=t.clientX,this.dragStartPosition[1]=t.clientY,this.dragStartRotation[0]=this.camera.getRotationX(),this.dragStartRotation[1]=this.camera.getRotationY()}handleMouseUp(){this.isDragging=!1}handleMouseMove(t){if(!this.isDragging)return;let e=this.dragStartRotation[0]+(t.clientY-this.dragStartPosition[1])*.001,i=this.dragStartRotation[1]+(t.clientX-this.dragStartPosition[0])*.001;this.camera.setRotation(e,i,0)}}function qo(a,t){const e=new Et,i=a.getVertices();e.beginVertices(a.getVertexCount()*t.length);for(const s of t)for(let r=0;r<i.length;r+=st){const n=l.MAT4_MULTIPLY_BY_VEC4(s,l.VEC4_CREATE(i[r+0],i[r+1],i[r+2],1));e.defineVertex(n[0],n[1],n[2],i[r+3],i[r+4],i[r+5],i[r+6],i[r+7],i[r+8],i[r+9],i[r+10],i[r+11],i[r+12],i[r+13])}return e.endVertices(),e.setMaterial(a.getMaterial()),e}class Ps{times;values;fns;defaultFn;constructor(t,e,i,s=[]){this.times=t,this.values=e,this.fns=s,this.defaultFn=i}interpolate(t){let e=0,i=this.times.length;for(;e<i&&t>this.times[e];)e++;if(e==0)return this.values[0];if(e==i)return this.values[i-1];const s=this.values[e-1],r=this.values[e],n=t-this.times[e-1],o=this.times[e]-this.times[e-1];return this.fns[e]?this.fns[e](n,s,r,o):this.defaultFn(n,s,r,o)}isEmpty(){return this.times.length==0||this.values.length==0}}class $ extends Ps{constructor(t=[],e=[]){super(t,e,l.LINEAR)}}class bt extends Ps{constructor(t=[],e=[]){super(t,e,l.LINEAR_VEC3)}}const Yo=[[0,0],[0,1],[1,0],[1,1]],Yi=[0,1,2,2,1,3],Xo=[[-1,-1,0],[-1,1,0],[1,-1,0],[1,1,0]];var ht=(a=>(a.CLASSIC="CLASSIC",a.EXPLODE="EXPLODE",a))(ht||{}),lt=(a=>(a.CUBE="CUBE",a.SPHERE="SPHERE",a))(lt||{});class zo{position;velocity;acceleration;accelerationTween;angle;angleVelocity;angleAcceleration;size;sizeTween;color;colorTween;opacity;opacityTween;age;alive;constructor(){this.position=[0,0,0],this.velocity=[0,0,0],this.acceleration=[0,0,0],this.accelerationTween=new bt,this.angle=0,this.angleVelocity=0,this.angleAcceleration=0,this.size=16,this.sizeTween=new $,this.color=[0,0,0],this.colorTween=new bt,this.opacity=1,this.opacityTween=new $,this.age=0,this.alive=0}update(t){this.position=l.VEC3_ADD(this.position,l.VEC3_SCALE(this.velocity,t/1e3)),this.velocity=l.VEC3_ADD(this.velocity,l.VEC3_SCALE(this.acceleration,t/1e3)),this.angle+=this.angleVelocity*l.DEG_TO_RAD_RATIO*(t/1e3),this.angleVelocity+=this.angleAcceleration*l.DEG_TO_RAD_RATIO*(t/1e3),this.age+=t/1e3,this.sizeTween.isEmpty()||(this.size=this.sizeTween.interpolate(this.age)),this.colorTween.isEmpty()||(this.color=this.colorTween.interpolate(this.age)),this.opacityTween.isEmpty()||(this.opacity=this.opacityTween.interpolate(this.age)),this.accelerationTween.isEmpty()||(this.acceleration=this.accelerationTween.interpolate(this.age))}}class Xi extends Me{texture;textureBuffer;textureChanged;positionStyle;positionBase;positionSpread;positionSphereRadiusBase;positionRadiusSpread;velocityStyle;velocityBase;velocitySpread;velocityExplodeSpeedBase;velocityExplodeSpeedSpread;colorBase;colorSpread;colorTween;sizeBase;sizeSpread;sizeTween;opacityBase;opacitySpread;opacityTween;accelerationBase;accelerationSpread;accelerationTween;angleBase;angleSpread;angleVelocityBase;angleVelocitySpread;angleAccelerationBase;angleAccelerationSpread;particleDeathAge;particlesPerSecond;particleQuantity;particleAlivedCount;particleArray;emitterDeathAge;emitterAge;emitterAlive;constructor(t){super(ts),this.texture=t.texture??x.createTextureFromBitmap(),this.textureBuffer=x.createUniformGroupBitmaps("PARTICLES_PIPELINE",1),this.textureBuffer.addSamplerInput(0,this.texture.gpuSampler),this.textureBuffer.addTextureInput(1,this.texture.gpuTexture),this.textureBuffer.allocate(),this.textureChanged=!1,this.positionStyle=t.positionStyle??"CUBE",this.positionBase=t.positionBase??[0,0,0],this.positionSpread=t.positionSpread??[0,0,0],this.positionSphereRadiusBase=t.positionSphereRadiusBase??0,this.positionRadiusSpread=t.positionRadiusSpread??0,this.velocityStyle=t.velocityStyle??"CLASSIC",this.velocityBase=t.velocityBase??[0,0,0],this.velocitySpread=t.velocitySpread??[0,0,0],this.velocityExplodeSpeedBase=t.velocityExplodeSpeedBase??0,this.velocityExplodeSpeedSpread=t.velocityExplodeSpeedSpread??0,this.colorBase=t.colorBase??[0,1,.5],this.colorSpread=t.colorSpread??[0,0,0],this.colorTween=t.colorTween??new bt,this.sizeBase=t.sizeBase??1,this.sizeSpread=t.sizeSpread??0,this.sizeTween=t.sizeTween??new $,this.opacityBase=t.opacityBase??1,this.opacitySpread=t.opacitySpread??0,this.opacityTween=t.opacityTween??new $,this.accelerationBase=t.accelerationBase??[0,0,0],this.accelerationSpread=t.accelerationSpread??[0,0,0],this.accelerationTween=t.accelerationTween??new bt,this.angleBase=t.angleBase??0,this.angleSpread=t.angleSpread??0,this.angleVelocityBase=t.angleVelocityBase??0,this.angleVelocitySpread=t.angleVelocitySpread??0,this.angleAccelerationBase=t.angleAccelerationBase??0,this.angleAccelerationSpread=t.angleAccelerationSpread??0,this.particleDeathAge=t.particleDeathAge??1,this.particlesPerSecond=t.particlesPerSecond??30,this.particleQuantity=t.particleQuantity??100,this.particleAlivedCount=0,this.particleArray=[],this.emitterDeathAge=t.emitterDeathAge??60,this.emitterAge=0,this.emitterAlive=!0;for(let e=0;e<this.particleQuantity;e++)this.particleArray[e]=this.createParticle()}update(t){this.updateLifeCycle(t),this.updateGeometry(t)}updateLifeCycle(t){const e=[];for(let i=0;i<this.particleQuantity;i++)this.particleArray[i].alive&&(this.particleArray[i].update(t),this.particleArray[i].age>this.particleDeathAge&&(this.particleArray[i].alive=0,this.particleAlivedCount--,e.push(i)));if(!!this.emitterAlive){if(this.emitterAge<this.particleDeathAge){let i=Math.round(this.particlesPerSecond*(this.emitterAge+0)),s=Math.round(this.particlesPerSecond*(this.emitterAge+t/1e3));s>this.particleQuantity&&(s=this.particleQuantity);for(let r=i;r<s;r++)this.particleArray[r].alive=1,this.particleAlivedCount++}for(let i=0;i<e.length;i++){const s=e[i];this.particleArray[s]=this.createParticle(),this.particleArray[s].alive=1,this.particleAlivedCount++}this.emitterAge+=t/1e3,this.emitterAge>this.emitterDeathAge&&(this.emitterAlive=!1)}}updateGeometry(t){this.beginVertices(this.particleAlivedCount*6);for(let e=0;e<this.particleQuantity;e++)if(this.particleArray[e].alive){const i=this.particleArray[e].position,s=this.particleArray[e].color,r=this.particleArray[e].size,n=this.particleArray[e].opacity,o=this.particleArray[e].angle,h=this.particleArray[e].alive;for(let c=0;c<6;c++){const d=Xo[Yi[c]],f=Yo[Yi[c]];this.defineVertex(d[0],d[1],d[2],i[0],i[1],i[2],f[0],f[1],s[0],s[1],s[2],r,n,o,h)}}this.endVertices()}draw(){es.drawParticles(this)}createParticle(){const t=new zo;if(this.positionStyle=="CUBE")t.position=pe(this.positionBase,this.positionSpread);else if(this.positionStyle=="SPHERE"){const e=Ot(this.positionSphereRadiusBase,this.positionRadiusSpread),i=Math.PI*2*Math.random(),s=Math.PI*2*Math.random(),r=e*Math.cos(i);t.position=l.VEC3_ADD(this.positionBase,[r*Math.cos(s),e*Math.sin(i),r*Math.sin(s)])}if(this.velocityStyle=="CLASSIC")t.velocity=pe(this.velocityBase,this.velocitySpread);else if(this.velocityStyle=="EXPLODE"){const e=l.VEC3_SUBSTRACT(t.position,this.positionBase),i=Ot(this.velocityExplodeSpeedBase,this.velocityExplodeSpeedSpread);t.velocity=l.VEC3_SCALE(l.VEC3_NORMALIZE(e),i)}return t.color=pe(this.colorBase,this.colorSpread),t.colorTween=this.colorTween,t.size=Ot(this.sizeBase,this.sizeSpread),t.sizeTween=this.sizeTween,t.opacity=Ot(this.opacityBase,this.opacitySpread),t.opacityTween=this.opacityTween,t.acceleration=pe(this.accelerationBase,this.accelerationSpread),t.accelerationTween=this.accelerationTween,t.angle=Ot(this.angleBase,this.angleSpread),t.angleVelocity=Ot(this.angleVelocityBase,this.angleVelocitySpread),t.angleAcceleration=Ot(this.angleAccelerationBase,this.angleAccelerationSpread),t.age=0,t.alive=0,t}setTexture(t){this.texture=t,this.textureChanged=!0}getTexture(){return this.texture}getTextureBuffer(){return this.textureChanged&&(this.textureBuffer.setSamplerInput(0,this.texture.gpuSampler),this.textureBuffer.setTextureInput(1,this.texture.gpuTexture),this.textureBuffer.allocate(),this.textureChanged=!1),this.textureBuffer}}function Ot(a,t){return a+t*(Math.random()-.5)}function pe(a,t){const e=l.VEC3_CREATE(Math.random()-.5,Math.random()-.5,Math.random()-.5);return l.VEC3_ADD(a,l.VEC3_MULTIPLY(t,e))}await b.loadTexture("./textures/star.png"),lt.CUBE,ht.CLASSIC,new bt([.5,2],[[0,1,.5],[.8,1,.5]]),new $([0,1],[1,20]),new $([2,3],[1,0]),360*4;await b.loadTexture("./textures/smokeparticle.png"),lt.SPHERE,ht.EXPLODE,new $([0,.1],[1,150]),new $([.7,1],[1,0]);await b.loadTexture("./textures/smokeparticle.png"),lt.CUBE,ht.CLASSIC,new bt([.4,1],[[0,0,.2],[0,0,.5]]),new $([0,1],[32,128]),new $([.8,2],[.5,0]);await b.loadTexture("./textures/smokeparticle.png"),lt.CUBE,ht.CLASSIC,new $([0,1,4,5],[0,1,1,0]);await b.loadTexture("./textures/snowflake.png"),lt.CUBE,ht.CLASSIC,new $([0,.25],[1,10]),new $([2,3],[.8,0]);await b.loadTexture("./textures/raindrop2flip.png"),lt.CUBE,ht.CLASSIC;await b.loadTexture("./textures/spikey.png"),lt.CUBE,ht.CLASSIC;await b.loadTexture("./textures/spark.png"),lt.CUBE,ht.CLASSIC,new $([0,1,1.1,2,2.1,3,3.1,4,4.1,5,5.1,6,6.1],[.2,.2,1,1,.2,.2,1,1,.2,.2,1,1,.2]);await b.loadTexture("./textures/spikey.png"),lt.CUBE,ht.CLASSIC;const Zo={texture:await b.loadTexture("./textures/spark.png"),positionStyle:lt.SPHERE,positionBase:[0,100,0],positionSphereRadiusBase:2,velocityStyle:ht.EXPLODE,velocityExplodeSpeedBase:10,velocityExplodeSpeedSpread:10,colorTween:new bt([.4,.8,1],[[0,1,1],[0,1,.6],[.8,1,.6]]),sizeTween:new $([.5,.7,1.3],[2,3,1]),opacityTween:new $([.2,.7,2.5],[.75,1,0]),accelerationBase:[0,-80,0],particlesPerSecond:3e3,particleDeathAge:2.5,emitterDeathAge:600},Ko={texture:await b.loadTexture("./textures/smokeparticle.png"),positionStyle:lt.SPHERE,positionBase:[0,5,0],positionSphereRadiusBase:1,velocityStyle:ht.CLASSIC,velocityBase:[0,30,0],velocitySpread:[20,0,20],colorTween:new bt([.5,1],[[1,0,0],[0,1,0]]),sizeTween:new $([0,.3,1.2],[2,6,2]),opacityTween:new $([.9,1.5],[1,0]),particleDeathAge:1.5,emitterDeathAge:600},fe=1;class Qo extends k{constructor(){super(),this.camera=new ee(0),this.skySphere=null,this.floor=null,this.particles0=null,this.particles1=null,this.isDragging=!1,this.dragStartPosition=[0,0],this.dragStartRotation=[0,0],this.colFac=0,this.handleMouseDownCb=this.handleMouseDown.bind(this),this.handleMouseUpCb=this.handleMouseUp.bind(this),this.handleMouseMoveCb=this.handleMouseMove.bind(this)}async onEnter(){this.camera.setPosition(0,40,0),this.camera.setRotation(.15,0,0),this.skySphere=new J,await this.skySphere.loadFromFile("./samples/particles/sky_sphere.jsm"),this.skySphere.setMaterial(new Q({texture:await b.loadTexture("./samples/particles/sky_sphere.jpg")})),this.floor=new J,this.floor.setPosition(0,0,-100),await this.floor.loadFromFile("./samples/particles/floor.jsm"),this.floor.setMaterial(new Q({lightning:!0,texture:await b.loadTexture("./samples/particles/floor.jpg"),normalMap:await b.loadTexture("./samples/particles/floor_normal_map.jpg"),specularityMap:await b.loadTexture("./samples/particles/floor_specularity_map.jpg")})),this.particles0=new Xi(Object.assign(Ko,{positionBase:[0,0,-100],particleQuantity:100})),this.particles1=new Xi(Object.assign(Zo,{positionBase:[0,10,-100],particleQuantity:100})),document.addEventListener("mousedown",this.handleMouseDownCb),document.addEventListener("mouseup",this.handleMouseUpCb),document.addEventListener("mousemove",this.handleMouseMoveCb)}onExit(){document.removeEventListener("mousedown",this.handleMouseDownCb),document.removeEventListener("mouseup",this.handleMouseUpCb),document.removeEventListener("mousemove",this.handleMouseMoveCb)}update(t){const e=this.camera.getLocalAxies();let i=l.VEC3_CREATE(0,0,0);R.isActiveAction("LEFT")&&(i=l.VEC3_ADD(i,l.VEC3_SCALE(e[0],-fe))),R.isActiveAction("RIGHT")&&(i=l.VEC3_ADD(i,l.VEC3_SCALE(e[0],+fe))),R.isActiveAction("UP")&&(i=l.VEC3_ADD(i,l.VEC3_SCALE(e[2],-fe))),R.isActiveAction("DOWN")&&(i=l.VEC3_ADD(i,l.VEC3_SCALE(e[2],+fe))),this.camera.translate(i[0],i[1],i[2]),this.floor.rotate(0,t*.001,0),this.floor.update(t),this.skySphere.update(t),this.particles0.update(t),this.particles1.update(t),ot.enableDirLight(1,[0,-1,.2]),ot.setDirLightColor([.8,.8,.8]),ot.enablePointLight(0,1,[Math.cos(this.colFac*.2)*45,18,Math.cos(this.colFac*.2)*45]),ot.setPointLightColor(0,[.8,.8,.4]),ot.enablePointLight(1,1,[Math.sin(this.colFac*.2)*45,18,Math.sin(this.colFac*.2)*45]),ot.setPointLightColor(1,[.8,1,.8]),this.colFac+=t*.003}draw(){this.skySphere.draw(),this.floor.draw(),this.particles0.draw(),this.particles1.draw()}handleMouseDown(t){this.isDragging=!0,this.dragStartPosition[0]=t.clientX,this.dragStartPosition[1]=t.clientY,this.dragStartRotation[0]=this.camera.getRotationX(),this.dragStartRotation[1]=this.camera.getRotationY()}handleMouseUp(){this.isDragging=!1}handleMouseMove(t){if(!this.isDragging)return;const e=this.dragStartRotation[0]+(t.clientY-this.dragStartPosition[1])*.001,i=this.dragStartRotation[1]+(t.clientX-this.dragStartPosition[0])*.001;this.camera.setRotation(e,i,0)}}class $o{entityIndex;entities;systems;constructor(){this.entityIndex=0,this.entities=new Map,this.systems=[],u.subscribe(R,"E_ACTION",this,t=>{for(let e of this.systems)e.action(t.actionId)}),u.subscribe(R,"E_ACTION_ONCE",this,t=>{for(let e of this.systems)e.actionOnce(t.actionId)})}update(t){for(const e of this.systems)e.update(t)}draw(){for(const t of this.systems)t.draw()}setup(t){this.entities.clear(),this.systems=t}createEntity(){return this.entities.set(this.entityIndex,new Map),this.entityIndex++}getEntity(t){const e=this.entities.get(t);if(!e)throw new Error("DNAManager::getEntity(): Entity not found");return e}removeEntity(t){if(!this.entities.get(t))throw new Error("DNAManager::removeEntity(): Entity not found");this.entities.delete(t);for(const i of this.systems)i.hasEntity(t)&&i.unbindEntity(t)}hasEntity(t){return this.entities.has(t)}findEntities(t){const e=Array();for(let[i,s]of this.entities)s.has(t)&&e.push(i);return e}findEntity(t){for(let[e,i]of this.entities)if(i.has(t))return e;return-1}addComponent(t,e){const i=this.entities.get(t);if(!i)throw new Error("DNAManager::addComponent(): Entity not found");if(i.has(e.getTypename()))throw new Error("ECSEntity::addComponent(): Entity already has "+e.getTypename());i.set(e.getTypename(),e);for(const r of this.systems)r.isMatchingComponentRequirements(i.values())&&!r.hasEntity(t)&&r.bindEntity(t)}removeComponent(t,e){const i=this.entities.get(t);if(!i)throw new Error("DNAManager::removeComponent(): Entity not found");if(!i.has(e))throw new Error("DNAManager::removeComponent(): Entity has not "+e);i.delete(e);for(const r of this.systems)!r.isMatchingComponentRequirements(i.values())&&r.hasEntity(t)&&r.unbindEntity(t)}removeComponentIfExist(t,e){return this.hasComponent(t,e)?(this.removeComponent(t,e),!0):!1}getComponent(t,e){const i=this.entities.get(t);if(!i)throw new Error("DNAManager::getComponent(): Entity not found");const s=i.get(e);if(!s)throw new Error("DNAManager::getComponent(): Entity has not "+e);return s}hasComponent(t,e){const i=this.entities.get(t);if(!i)throw new Error("DNAManager::hasComponent(): Entity not found");return i.has(e)}}const m=new $o;class G{entities;requiredComponentTypenames;constructor(){this.entities=new Set,this.requiredComponentTypenames=new Set}update(t){this.onBeforeUpdate(t);for(const e of this.entities)this.onEntityUpdate(t,e);this.onAfterUpdate(t)}draw(){for(const t of this.entities)this.onEntityDraw(t)}action(t){for(const e of this.entities)this.onAction(t,e)}actionOnce(t){for(const e of this.entities)this.onActionOnce(t,e)}bindEntity(t){if(this.entities.has(t))throw new Error("DNASystem::bindEntity(): Entity already exist in this system");this.onEntityBind(t),this.entities.add(t)}unbindEntity(t){if(!this.entities.has(t))throw new Error("DNASystem::unbindEntity(): Entity not exist in this system");this.onEntityUnbind(t),this.entities.delete(t)}hasEntity(t){return this.entities.has(t)}addRequiredComponentTypename(t){if(this.requiredComponentTypenames.has(t))throw new Error("DNASystem::addRequiredComponentTypename(): Required typename already set in this system");this.requiredComponentTypenames.add(t)}isMatchingComponentRequirements(t){let e=this.requiredComponentTypenames.size,i=0;for(const s of t)this.requiredComponentTypenames.has(s.getTypename())&&i++;return i==e}onAction(t,e){}onActionOnce(t,e){}onBeforeUpdate(t){}onEntityUpdate(t,e){}onAfterUpdate(t){}onEntityDraw(t){}onEntityBind(t){}onEntityUnbind(t){}}class j{typename;constructor(t){this.typename=t}getTypename(){return this.typename}}class Jo extends j{constructor(t){super("Background"),this.texture=t}}class Rs extends j{constructor(t=0,e=0){super("Body"),this.w=t,this.h=e}}class ta extends j{constructor(t,e){super("Camera"),this.x=t,this.y=e}}class ea extends j{constructor(){super("CMBControls")}}class ia extends j{constructor(t,e,i=[]){super("CMB"),this.animations=t,this.texture=e,this.comboComponents=i,this.currentAction=[],this.currentActionAge=0}}class sa extends j{constructor(t="",e="",i="",s=[]){super("Combo"),this.requiredComponent=t,this.actions=e,this.animationName=i,this.hits=s,this.currentAttack=null}}class Ds extends j{constructor(t=1,e=0){super("Gravity"),this.gravityFactor=t,this.collider=e,this.onFloor=!0}}class ra extends j{constructor(t={}){super("Hit"),this.w=t.w,this.h=t.h,this.frameIndex=t.frameIndex,this.maxAge=t.maxAge,this.relativeX=t.relativeX,this.relativeY=t.relativeY,this.velocityTween=t.velocityTween??null,this.isCollide=t.isCollide??!0,this.damageHP=t.damageHP??1,this.damageMaxAge=t.damageMaxAge??1,this.damageSpriteAnimation=t.damageSpriteAnimation??null,this.damageSpriteOffset=t.damageSpriteOffset??[0,0],this.spriteAnimationOnLaunch=t.spriteAnimationOnLaunch??null,this.spriteAnimationOnImpact=t.spriteAnimationOnImpact??null,this.spriteOffsetX=t.spriteOffsetX??0,this.spriteOffsetY=t.spriteOffsetY??0,this.owner=t.owner??-1,this.direction=t.direction??0,this.velocityImpact=t.velocityImpact??null,this.marked=!1,this.age=0}}class na extends j{constructor(){super("Fallof")}}class Os extends j{constructor(t,e){super("Fighter"),this.health=t,this.dmgSprite=e}}class oa extends j{constructor(t){super("Floor"),this.elevation=t}}class Oe extends j{constructor(){super("IdleControls")}}class Zt extends j{constructor(){super("Idle")}}class _s extends j{constructor(){super("JumpControls")}}class ri extends j{constructor(t,e=10,i=1){super("Jump"),this.doubleJumpGapTime=e,this.numJump=i,this.accelerationY=t,this.createdAt=Date.now()}}class Ls extends j{constructor(t){super("Move"),this.velocityX=0,this.velocityY=0,this.direction=t}}class aa extends j{constructor(t,e,i){super("Platform"),this.elevation=t,this.w=e,this.h=i}}class _e extends j{constructor(t,e){super("Position"),this.x=t,this.y=e}}class ha extends j{constructor(){super("RunControls")}}class la extends j{constructor(t){super("Run"),this.speed=t}}class Le extends j{constructor(t){super("Sprite"),this.jas=t,this.lastAnimationFrameIndex=-1}}class ca extends j{constructor(t=null,e=1,i=1,s=null,r=[0,0]){super("Damage"),this.velocityImpact=t,this.damageHP=e,this.maxAge=i,this.spriteAnimation=s,this.spriteOffset=r,this.airDropped=!1,this.age=0}}const ua=.01,Ns=600,Fs=600,me=Ns/2,ge=Fs/2;class da extends G{constructor(){super(),this.context=V.getContext(),super.addRequiredComponentTypename("Background")}onEntityDraw(t){const e=m.getComponent(t,"Background");this.context.drawImage(e.texture,0,0)}}class pa extends G{constructor(){super(),super.addRequiredComponentTypename("Camera")}onEntityUpdate(t,e){const i=m.findEntity("Background"),s=m.getComponent(i,"Background"),r=m.findEntities("Fighter");let n=1/0,o=1/0,h=0,c=0;for(let A of r){const T=m.getComponent(A,"Position");n>T.x&&(n=T.x),h<T.x&&(h=T.x),o>T.y&&(o=T.y),c<T.y&&(c=T.y)}let d=h-n+88*2,f=c-o+88*2;const g=l.CLAMP(Ns/d,1,1.3),E=l.CLAMP(Fs/f,1,1.3),I=Math.min(g,E);let S=n+(h-n)/2,y=o+(c-o)/2;S<me/I?S=me/I:S>s.texture.width-me/I&&(S=s.texture.width-me/I),y<ge/I?y=ge/I:y>s.texture.height-ge/I&&(y=s.texture.height-ge/I),V.setCameraScale(I,I),V.setCameraPosition(S,y)}}class fa extends G{constructor(){super(),super.addRequiredComponentTypename("Position"),super.addRequiredComponentTypename("Sprite")}onEntityUpdate(t,e){const i=m.getComponent(e,"Position"),s=m.getComponent(e,"Sprite");s.jas.setPosition(i.x,i.y),s.jas.update(t)}onEntityDraw(t){m.getComponent(t,"Sprite").jas.draw()}}class ma extends G{constructor(){super(),super.addRequiredComponentTypename("Move"),super.addRequiredComponentTypename("Position")}onEntityUpdate(t,e){const i=m.getComponent(e,"Move"),s=m.getComponent(e,"Position");s.x+=i.velocityX,s.y+=i.velocityY}}class ga extends G{constructor(){super(),super.addRequiredComponentTypename("IdleControls"),super.addRequiredComponentTypename("Idle")}onEntityUpdate(t,e){(R.isActiveAction("LEFT")||R.isActiveAction("RIGHT"))&&(m.removeComponent(e,"IdleControls"),m.removeComponent(e,"Idle"),m.addComponent(e,new ha(4,0)),m.addComponent(e,new la(4,0)))}onActionOnce(t,e){t=="UP"&&(m.removeComponent(e,"IdleControls"),m.removeComponent(e,"Idle"),m.addComponent(e,new _s),m.addComponent(e,new ri(-15,10)))}}class Ea extends G{constructor(){super(),super.addRequiredComponentTypename("Idle")}onEntityUpdate(t,e){const i=m.getComponent(e,"Move"),s=m.getComponent(e,"Sprite");i.velocityX=0,s.jas.play("IDLE",!0,!0)}}class Ca extends G{constructor(){super(),super.addRequiredComponentTypename("RunControls"),super.addRequiredComponentTypename("Run"),super.addRequiredComponentTypename("Move")}onEntityUpdate(t,e){const i=m.getComponent(e,"Move");let s=!1,r=0;R.isActiveAction("LEFT")&&(s=!0,r+=-1,i.direction=r),R.isActiveAction("RIGHT")&&(s=!0,r+=1,i.direction=r),R.isActiveAction("UP")&&(s=!0,m.removeComponent(e,"RunControls"),m.removeComponent(e,"Run"),m.addComponent(e,new ri(-15,10)),m.addComponent(e,new _s)),s||(m.removeComponent(e,"RunControls"),m.removeComponent(e,"Run"),m.addComponent(e,new Oe),m.addComponent(e,new Zt))}}class Ia extends G{constructor(){super(),super.addRequiredComponentTypename("Run"),super.addRequiredComponentTypename("Sprite"),super.addRequiredComponentTypename("Move")}onEntityBind(t){m.getComponent(t,"Sprite").jas.play("RUN",!0,!0)}onEntityUpdate(t,e){const i=m.getComponent(e,"Run"),s=m.getComponent(e,"Sprite"),r=m.getComponent(e,"Move");let n=0;r.direction==-1?(n+=i.speed*r.direction,r.velocityX=n,s.jas.setFlipX(!0)):r.direction==1&&(n+=i.speed*r.direction,r.velocityX=n,s.jas.setFlipX(!1))}}class Aa extends G{constructor(){super(),super.addRequiredComponentTypename("Jump"),super.addRequiredComponentTypename("JumpControls")}onActionOnce(t,e){const i=m.getComponent(e,"Jump"),s=m.getComponent(e,"Move");t=="UP"&&Date.now()-i.createdAt>i.doubleJumpGapTime&&i.numJump<=1&&(s.velocityY=0,m.removeComponent(e,"Jump"),m.addComponent(e,new ri(-13,3,2)))}}class Ta extends G{constructor(){super(),super.addRequiredComponentTypename("Jump"),super.addRequiredComponentTypename("Move"),super.addRequiredComponentTypename("Sprite")}onEntityBind(t){const e=m.getComponent(t,"Jump"),i=m.getComponent(t,"Move"),s=m.getComponent(t,"Sprite");i.velocityY+=e.accelerationY,s.jas.play("JUMP",!1,!0)}onEntityUpdate(t,e){m.getComponent(e,"Move").velocityY>0&&(m.removeComponent(e,"JumpControls"),m.removeComponent(e,"Jump"),m.addComponent(e,new na))}}class Sa extends G{constructor(){super(),super.addRequiredComponentTypename("Fallof")}onEntityBind(t){m.getComponent(t,"Sprite").jas.play("FALLOF",!1,!0)}onEntityUpdate(t,e){m.getComponent(e,"Move").velocityY==0&&(m.removeComponent(e,"Fallof"),m.addComponent(e,new Oe),m.addComponent(e,new Zt))}}class ya extends G{constructor(){super(),super.addRequiredComponentTypename("Body"),super.addRequiredComponentTypename("Move"),super.addRequiredComponentTypename("Position")}onEntityUpdate(t,e){const i=m.findEntity("Background"),s=m.getComponent(i,"Background"),r=m.getComponent(e,"Position"),n=m.getComponent(e,"Move"),o=m.getComponent(e,"Body"),h=r.x+n.velocityX;(h-o.w/2<0||h+o.w/2>s.texture.width)&&(n.velocityX=0)}}class xa extends G{constructor(){super(),super.addRequiredComponentTypename("Body"),super.addRequiredComponentTypename("Position")}onEntityDraw(t){const e=m.getComponent(t,"Body"),i=m.getComponent(t,"Position"),s=V.getContext();s.globalAlpha=.2,s.fillStyle="#000",s.fillRect(i.x-e.w/2,i.y-e.h/2,e.w,e.h),s.globalAlpha=1}}class Ma extends G{constructor(){super(),super.addRequiredComponentTypename("CMBControls"),super.addRequiredComponentTypename("CMB")}onActionOnce(t,e){const i=m.getComponent(e,"CMB");i.currentAction+=t,i.currentActionAge=0}}class wa extends G{constructor(){super(),super.addRequiredComponentTypename("CMB")}onEntityUpdate(t,e){const i=m.getComponent(e,"CMB");if(!m.hasComponent(e,"Combo")){i.currentActionAge>1e3&&(i.currentActionAge=0,i.currentAction="");for(let s of i.comboComponents){if(i.currentAction.indexOf(s.actions)==-1)continue;if(i.currentAction.endsWith(s.actions)&&m.hasComponent(e,s.requiredComponent)){m.removeComponentIfExist(e,"IdleControls"),m.removeComponentIfExist(e,"Idle"),m.removeComponentIfExist(e,"RunControls"),m.removeComponentIfExist(e,"Run");const o=m.getComponent(e,"Move");o.velocityX=0,i.currentActionAge=0,i.currentAction="",m.addComponent(e,s)}}i.currentActionAge+=t}}}class va extends G{constructor(){super(),super.addRequiredComponentTypename("CMB"),super.addRequiredComponentTypename("Combo"),super.addRequiredComponentTypename("Sprite"),super.addRequiredComponentTypename("Position"),super.addRequiredComponentTypename("Move")}async onEntityBind(t){const e=m.getComponent(t,"Combo"),i=m.getComponent(t,"Sprite");i.jas.play(e.animationName,!1,!0),await u.wait(i.jas,"E_FINISHED"),m.removeComponent(t,"Combo"),m.addComponent(t,new Oe),m.addComponent(t,new Zt)}onEntityUpdate(t,e){const i=m.getComponent(e,"CMB"),s=m.getComponent(e,"Combo"),r=m.getComponent(e,"Sprite"),n=m.getComponent(e,"Position"),o=m.getComponent(e,"Move");if(r.jas.getCurrentAnimationFrameIndex()==r.lastAnimationFrameIndex)return;r.lastAnimationFrameIndex=r.jas.getCurrentAnimationFrameIndex();const h=s.hits.filter(c=>c.frameIndex==r.jas.getCurrentAnimationFrameIndex());if(h.length!=0)for(const c of h){const d=new wt;d.setAnimations(i.animations),d.setTexture(i.texture),Ba(n.x,n.y,d,Object.assign(c,{owner:e,direction:o.direction}))}}}class ba extends G{constructor(){super(),super.addRequiredComponentTypename("Hit"),super.addRequiredComponentTypename("Position"),super.addRequiredComponentTypename("Sprite")}onEntityBind(t){const e=m.getComponent(t,"Hit"),i=m.getComponent(t,"Position");if(i.x+=e.relativeX*e.direction,i.y+=e.relativeY,e.spriteAnimationOnLaunch){const s=m.getComponent(t,"Sprite");s.jas.setVisible(!0),s.jas.setOffset(e.spriteOffsetX,e.spriteOffsetY),s.jas.play(e.spriteAnimationOnLaunch,!1,!1)}}async onEntityUpdate(t,e){const i=m.getComponent(e,"Hit");if(i.marked)return;const s=m.getComponent(e,"Position"),r=m.getComponent(e,"Sprite");if(i.isCollide){const o=m.findEntities("Fighter").filter(h=>h!=i.owner);for(let h of o){const c=m.getComponent(h,"Body"),d=m.getComponent(h,"Position"),f=[s.x-i.w/2,s.y-i.h/2],g=[s.x+i.w/2,s.y+i.h/2],E=[d.x-c.w/2,d.y-c.h/2],I=[d.x+c.w/2,d.y+c.h/2];if(l.COLLIDE_RECT_TO_RECT(f,g,E,I)){i.marked=!0,m.removeComponentIfExist(h,"Damage"),m.removeComponentIfExist(h,"RunControls"),m.removeComponentIfExist(h,"Run"),m.removeComponentIfExist(h,"IdleControls"),m.removeComponentIfExist(h,"Idle"),m.removeComponentIfExist(h,"JumpControls"),m.removeComponentIfExist(h,"Jump"),m.addComponent(h,new ca([i.velocityImpact[0]*i.direction,i.velocityImpact[1]],i.damageHP,i.damageMaxAge,i.damageSpriteAnimation,i.damageSpriteOffset)),i.spriteAnimationOnImpact&&(r.jas.setVisible(!0),r.jas.setOffset(i.spriteOffsetX,i.spriteOffsetY),r.jas.play(i.spriteAnimationOnImpact,!1,!1),await u.wait(r.jas,"E_FINISHED"),r.jas.setVisible(!1)),m.removeEntity(e);return}}}if(i.age>i.maxAge){m.removeEntity(e);return}if(i.velocityTween){const n=i.velocityTween.interpolate(i.age);s.x+=n[0]*i.direction,s.y+=n[1]}i.age+=t/1e3}}class Pa extends G{constructor(){super(),super.addRequiredComponentTypename("Hit"),super.addRequiredComponentTypename("Position")}onEntityDraw(t){const e=m.getComponent(t,"Hit"),i=m.getComponent(t,"Position"),s=V.getContext();s.fillStyle="red",s.fillRect(i.x-e.w/2,i.y-e.h/2,e.w,e.h)}}class Ra extends G{constructor(){super(),super.addRequiredComponentTypename("Damage"),super.addRequiredComponentTypename("Position"),super.addRequiredComponentTypename("Move"),super.addRequiredComponentTypename("Sprite"),this.frictionX=.5}onEntityBind(t){const e=m.getComponent(t,"Damage"),i=m.getComponent(t,"Fighter"),s=m.getComponent(t,"Move");e.velocityImpact&&(s.velocityX=e.velocityImpact[0],s.velocityY=e.velocityImpact[1]),i.health-=e.damageHP}async onEntityUpdate(t,e){const i=m.getComponent(e,"Damage"),s=m.getComponent(e,"Move"),r=m.getComponent(e,"Sprite");if(i.age>i.maxAge){m.removeComponent(e,"Damage"),i.airDropped||m.addComponent(e,new Zt);return}s.velocityY<0?(i.airDropped=!0,r.jas.play("PAIN_UP",!1,!0)):s.velocityY>0&&(i.airDropped=!0,r.jas.play("PAIN_DOWN",!1,!0)),s.velocityY==0&&i.airDropped?r.jas.play("PAIN_GROUND",!1,!0):s.velocityY==0&&r.jas.play("PAIN",!1,!1),s.velocityX>0&&(s.velocityX=Math.max(s.velocityX-this.frictionX,0)),s.velocityX<0&&(s.velocityX=Math.min(s.velocityX+this.frictionX,0)),i.age+=t/1e3}}class Da extends G{constructor(){super(),super.addRequiredComponentTypename("Damage"),super.addRequiredComponentTypename("Fighter"),super.addRequiredComponentTypename("Position")}onEntityBind(t){const e=m.getComponent(t,"Damage"),i=m.getComponent(t,"Fighter");e.spriteAnimation&&(i.dmgSprite.setOffset(e.spriteOffset[0],e.spriteOffset[1]),i.dmgSprite.play(e.spriteAnimation,!0,!0))}onEntityDraw(t){const e=m.getComponent(t,"Damage"),i=m.getComponent(t,"Fighter"),s=m.getComponent(t,"Position");e.spriteAnimation&&(i.dmgSprite.setPosition(s.x,s.y),i.dmgSprite.draw())}}class Oa extends G{constructor(){super(),super.addRequiredComponentTypename("Gravity"),super.addRequiredComponentTypename("Move"),super.addRequiredComponentTypename("Position")}onEntityUpdate(t,e){const i=m.getComponent(e,"Move"),s=m.getComponent(e,"Position"),r=m.getComponent(e,"Gravity"),n=s.y+r.collider,o=m.findEntity("Floor"),h=m.getComponent(o,"Floor");if(i.velocityY>0){if(n>h.elevation){s.y=h.elevation-r.collider,i.velocityY=0,r.onFloor=!0;return}for(let c of m.findEntities("Platform")){const d=m.getComponent(c,"Platform"),f=m.getComponent(c,"Position"),g=Math.abs(n-d.elevation)-ua,E=f.x-d.w/2,I=f.x+d.w/2;if(n>d.elevation&&g<=i.velocityY&&s.x>=E&&s.x<=I){s.y=d.elevation-r.collider,i.velocityY=0,r.onFloor=!0;return}}}if(n<h.elevation){i.velocityY+=r.gravityFactor,r.onFloor=!1;return}}}class _a extends k{constructor(){super()}async onEnter(){m.setup([new pa,new ga,new Ea,new Ca,new Ia,new Aa,new Ta,new Sa,new Ma,new wa,new va,new ya,new ma,new Oa,new ba,new Ra,new da,new fa,new xa,new Pa,new Da]),this.initialize()}async initialize(){await La(),await Na(),await Fa(),await Va(),await Ua()}update(t){m.update(t)}draw(){m.draw()}}async function La(){const a=m.createEntity();m.addComponent(a,new Jo(await St.loadTexture("./samples/scrolling/bg.png")));const t=m.createEntity();m.addComponent(t,new ta)}async function Na(){const a=new wt;await a.loadFromFile("./samples/scrolling/floating-rock.jas"),a.setTexture(await St.loadTexture("./samples/scrolling/floating-rock.png")),a.setOffset(52,18),a.play("DEFAULT",!1,!0);const t=m.createEntity();m.addComponent(t,new _e(220,400)),m.addComponent(t,new aa(395,104,37)),m.addComponent(t,new Le(a))}async function Fa(){const a=m.createEntity();m.addComponent(a,new oa(540))}async function Ba(a,t,e,i){const s=m.createEntity();m.addComponent(s,new _e(a,t)),m.addComponent(s,new Le(e)),m.addComponent(s,new ra(i))}async function Va(){const a=new wt;await a.loadFromFile("./samples/scrolling/naruto.jas"),a.setTexture(await St.loadTexture("./samples/scrolling/naruto.png")),a.setOffset(44,44);const t=new wt;await t.loadFromFile("./samples/scrolling/naruto.jas"),t.setTexture(await St.loadTexture("./samples/scrolling/naruto.png")),t.setOffset(44,44);const e=m.createEntity();return m.addComponent(e,new Os(100,t)),m.addComponent(e,new _e(190,490)),m.addComponent(e,new Le(a)),m.addComponent(e,new Ls),m.addComponent(e,new Oe),m.addComponent(e,new Zt),m.addComponent(e,new Rs(88,88)),m.addComponent(e,new Ds(1,44)),m.addComponent(e,new ia(a.animations,a.texture,[Ha()])),m.addComponent(e,new ea),e}async function Ua(){const a=new wt;await a.loadFromFile("./samples/scrolling/naruto.jas"),a.setTexture(await St.loadTexture("./samples/scrolling/naruto.png")),a.setOffset(44,44);const t=new wt;await t.loadFromFile("./samples/scrolling/naruto.jas"),t.setTexture(await St.loadTexture("./samples/scrolling/naruto.png")),t.setOffset(44,44);const e=m.createEntity();return m.addComponent(e,new Os(100,t)),m.addComponent(e,new _e(490,490)),m.addComponent(e,new Le(a)),m.addComponent(e,new Zt),m.addComponent(e,new Ls),m.addComponent(e,new Rs(88,88)),m.addComponent(e,new Ds(1,44)),e}function Ha(){return new sa("Run","OKOK","PUNCH1",[{spriteAnimationOnImpact:"HIT",frameIndex:0,w:10,h:10,damageHP:10,damageMaxAge:1,damageSpriteAnimation:"HIT",damageSpriteOffset:[21,29],maxAge:.2,relativeX:44,relativeY:0,velocityImpact:[10,-10]}])}class ja extends k{constructor(){super(),this.uiMenu=new it}async onEnter(){this.uiMenu.add("0","3D Viewer"),this.uiMenu.add("1","User Interface"),this.uiMenu.add("2","3D Pre-rendered Demo"),this.uiMenu.add("3","3D Iso Pre-rendered Demo"),this.uiMenu.add("4","Visual Novel Demo"),this.uiMenu.add("5","2D Tilemap Demo"),this.uiMenu.add("6","2D Tilemap Pathfinding Demo"),this.uiMenu.add("7","Checker Demo"),this.uiMenu.add("8","CCG Demo"),this.uiMenu.add("9","FPS Demo"),this.uiMenu.add("10","RPG Demo"),this.uiMenu.add("11","Perf Demo"),this.uiMenu.add("12","Particles Demo"),this.uiMenu.add("13","2D Scrolling Demo"),p.addWidget(this.uiMenu,"position:absolute; top:50%; left:50%; width:60%; transform:translate(-50%,-50%);"),u.subscribe(this.uiMenu,"E_ITEM_SELECTED",this,this.handleMenuItemSelected),p.focus(this.uiMenu)}onExit(){p.removeWidget(this.uiMenu)}handleMenuItemSelected(t){t.id==0?_.requestSetScreen(new gr):t.id==1?_.requestSetScreen(new Ar):t.id==2?_.requestSetScreen(new wr):t.id==3?_.requestSetScreen(new Nr):t.id==4?_.requestSetScreen(new Xr):t.id==5?_.requestSetScreen(new Ur):t.id==6?_.requestSetScreen(new Gr):t.id==7?_.requestSetScreen(new gn):t.id==8?_.requestSetScreen(new kn,{duelId:"0000"}):t.id==9?_.requestSetScreen(new so):t.id==10?_.requestSetScreen(new jo):t.id==11?_.requestSetScreen(new Go):t.id==12?_.requestSetScreen(new Qo):t.id==13&&_.requestSetScreen(new _a)}}class Wa{constructor(){this.then=0}startup(){Mt.setShowDebug(!0),this.run(0)}run(t){const e=t-this.then;this.then=t,V.update(e),p.update(e),_.update(e),x.beginDrawing(0),V.beginDrawing(),_.draw(),V.endDrawing(),x.endDrawing(),x.beginRender(),Ji.render(),Mt.render(),ot.render(),Qi.render(),es.render(),x.endRender(),document.getElementById("time").innerHTML=parseInt(x.getLastRenderTime()),document.getElementById("fps").innerHTML=(1e3/x.getLastRenderTime()).toFixed(2),requestAnimationFrame(i=>this.run(i))}}const ka=new Wa;ka.startup();_.requestSetScreen(new ja);
