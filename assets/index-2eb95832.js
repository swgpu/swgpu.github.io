(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const n of r.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function e(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=e(i);fetch(i.href,r)}})();class re{subscribers;constructor(){this.subscribers=[]}wait(t,e){return new Promise(s=>{this.subscribeOnce(t,e,this,i=>{s(i)})})}subscribe(t,e,s,i){this.subscribers.push({emitter:t,type:e,listener:s,once:!1,cb:i})}subscribeOnce(t,e,s,i){this.subscribers.push({emitter:t,type:e,listener:s,once:!0,cb:i})}unsubscribe(t,e,s){for(let i of this.subscribers)if(i.emitter==t&&i.type==e&&i.listener==s){this.subscribers.splice(this.subscribers.indexOf(i),1);return}}unsubscribeAll(){this.subscribers=[]}async emit(t,e,s={}){}}const D=new re;class ne{container;resWidth;resHeight;sizeMode;constructor(){if(this.container=document.getElementById("APP"),!this.container)throw new Error("Application::Application: APP element not found !");this.resWidth=this.container.clientWidth,this.resHeight=this.container.clientHeight,this.sizeMode=2,window.addEventListener("resize",()=>D.emit(this,"E_RESIZE"))}setSize(t,e,s=2){this.container.style.width=t+"px",this.container.style.height=e+"px",s==0?this.container.style.transform="scale("+window.innerWidth/t+","+window.innerHeight/e+")":s==1?this.container.style.transform="scale("+Math.min(window.innerWidth/t,window.innerHeight/e)+")":s==2?(this.container.style.transform="none",this.container.style.margin="0 auto"):s==3&&(this.container.style.width="100vw",this.container.style.height="100vh"),this.resWidth=t,this.resHeight=e,this.sizeMode=s,D.emit(this,"E_RESIZE")}getSize(){return[this.container.clientWidth,this.container.clientHeight]}getResolution(){return[this.resWidth,this.resHeight]}addClass(t){this.container.classList.add(t)}removeClass(t){this.container.classList.remove(t)}toggleClass(t){this.container.classList.toggle(t)}enableScanlines(t){this.container.classList.toggle("scanlines",t)}}const St=new ne;class c{static DEG_TO_RAD_RATIO=Math.PI/180;static EPSILON=1e-7;static BIG_EPSILON=1e-4;static VEC2_SIZE=8;static VEC2_ZERO=[0,0];static VEC2_LEFT=[-1,0];static VEC2_RIGHT=[1,0];static VEC2_UP=[0,1];static VEC2_DOWN=[0,-1];static VEC2_ISO_LEFT=[0,1];static VEC2_ISO_RIGHT=[0,-1];static VEC2_ISO_FORWARD=[-1,0];static VEC2_ISO_BACKWARD=[1,0];static VEC3_SIZE=12;static VEC3_ZERO=[0,0,0];static VEC3_BACKWARD=[0,0,1];static VEC3_FORWARD=[0,0,-1];static VEC3_LEFT=[-1,0,0];static VEC3_RIGHT=[1,0,0];static VEC3_UP=[0,1,0];static VEC3_DOWN=[0,-1,0];static FAIL(t){const e=document.querySelector("#APP_FAIL");e.classList.add("SHOW"),e.textContent=t}static WAIT(t){return new Promise(e=>{window.setTimeout(()=>e(),t)})}static SHUFFLE(t){const e=t.slice();let s,i,r=e.length;if(r)for(;--r;)i=Math.floor(Math.random()*(r+1)),s=e[i],e[i]=e[r],e[r]=s;return e}static RANGE_ARRAY(t,e,s=0){return Array.from({length:(e-t)/s+1},(i,r)=>t+r*s)}static RANDARRAY(t,e){const s=[];for(let i=t;i<=e;i++)s.push(i);return c.SHUFFLE(s)}static SPREAD(t,e){return t+e*(Math.random()-.5)}static GET_RANDOM_INT(t,e){return t=Math.ceil(t),e=Math.floor(e),Math.floor(Math.random()*(e-t))+t}static GET_RANDOM_FLOAT(t,e){return Math.random()*(e-t)+t}static CLAMP(t,e,s){return Math.max(e,Math.min(s,t))}static DEG_TO_RAD(t){return t*(Math.PI/180)}static LERP(t,e,s){return t+(e-t)*s}static TO_FIXED_NUMBER(t,e,s=10){const i=Math.pow(s,e);return Math.round(t*i)/i}static VEC1_COPY(t,e=[0]){return e[0]=t,e}static VEC2_CREATE(t=0,e=0){const s=new Float32Array(2);return s[0]=t,s[1]=e,s}static VEC2_PARSE(t,e=" ",s=[0,0]){const i=t.split(e);return s[0]=parseFloat(i[0]),s[1]=parseFloat(i[1]),s}static VEC2_COPY(t,e=[0,0]){return e[0]=t[0],e[1]=t[1],e}static VEC2_ISZERO(t){return Math.abs(t[0])<=c.EPSILON&&Math.abs(t[1])<=c.EPSILON}static VEC2_SPREAD(t,e){const s=c.VEC2_CREATE(Math.random()-.5,Math.random()-.5);return c.VEC2_ADD(t,c.VEC2_MULTIPLY(e,s))}static VEC2_ROTATE_AROUND(t,e,s){const i=Math.cos(s)*e,r=Math.sin(s)*e;return[t[0]+i,t[1]+r]}static VEC2_OPPOSITE(t,e=[0,0]){return e[0]=-t[0],e[1]=-t[1],e}static VEC2_DISTANCE(t,e){const s=e[0]-t[0],i=e[1]-t[1];return Math.sqrt(s*s+i*i)}static VEC2_LENGTH(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1])}static VEC2_NORMALIZE(t,e=[0,0]){const s=c.VEC2_LENGTH(t);return s>0&&(e[0]=t[0]/s,e[1]=t[1]/s),e}static VEC2_DOT(t,e){return t[0]*e[0]+t[1]*e[1]}static VEC2_CROSS(t,e){return t[0]*e[1]-t[1]*e[0]}static VEC2_ORIENTATION(t,e,s){const i=(e[1]-t[1])*(s[0]-e[0])-(e[0]-t[0])*(s[1]-e[1]);return i==0?0:i>0?1:2}static VEC2_ADD(t,e,s=[0,0]){return s[0]=t[0]+e[0],s[1]=t[1]+e[1],s}static VEC2_SUBSTRACT(t,e,s=[0,0]){return s[0]=t[0]-e[0],s[1]=t[1]-e[1],s}static VEC2_MULTIPLY(t,e,s=[0,0]){return s[0]=t[0]*e[0],s[1]=t[1]*e[1],s}static VEC2_SCALE(t,e,s=[0,0]){return s[0]=t[0]*e,s[1]=t[1]*e,s}static VEC2_ADD_SCALED(t,e,s,i=[0,0]){return i[0]=t[0]+e[0]*s,i[1]=t[1]+e[1]*s,i}static VEC2_ANGLE_BETWEEN(t,e){return Math.acos(c.VEC2_DOT(t,e)/(c.VEC2_LENGTH(t)*c.VEC2_LENGTH(e)))}static VEC2_ANGLE(t){const e=Math.atan2(t[1],t[0]);return e>0?e:e+Math.PI*2}static VEC2_ISEQUAL(t,e){return t[0]==e[0]&&t[1]==e[1]}static VEC2_PROJECTION_COS(t,e,s=[0,0]){const i=Math.sqrt(e[0]*e[0]+e[1]*e[1]),r=(t[0]*e[0]+t[1]*e[1])/(i*i);return s[0]=e[0]*r,s[1]=e[1]*r,s}static VEC2_QUADRATIC_BEZIER(t,e,s,i,r=[0,0]){const n=t[0]+(e[0]-t[0])*i,a=t[1]+(e[1]-t[1])*i,h=e[0]+(s[0]-e[0])*i,o=e[1]+(s[1]-e[1])*i;return r[0]=n+(h-n)*i,r[1]=a+(o-a)*i,r}static VEC2_ISO_TO_2D(t){let e=(2*t[1]+t[0])*.5,s=(2*t[1]-t[0])*.5;return[e,s]}static VEC2_2D_TO_ISO(t){let e=t[0]-t[1],s=(t[0]+t[1])*.5;return[e,s]}static VEC2_ISO_CARDINAL_POINTS(t,e,s){if(t=="FORWARD"){const i=c.VEC2_2D_TO_ISO([-e*.5,0]),r=c.VEC2_2D_TO_ISO([0,s*.5]),n=c.VEC2_2D_TO_ISO([0,-s*.5]),a=c.VEC2_2D_TO_ISO([e*.5,0]);return{f:i,l:r,r:n,b:a}}if(t=="BACKWARD"){const i=c.VEC2_2D_TO_ISO([e*.5,0]),r=c.VEC2_2D_TO_ISO([0,-s*.5]),n=c.VEC2_2D_TO_ISO([0,s*.5]),a=c.VEC2_2D_TO_ISO([-e*.5,0]);return{f:i,l:r,r:n,b:a}}if(t=="LEFT"){const i=c.VEC2_2D_TO_ISO([0,e*.5]),r=c.VEC2_2D_TO_ISO([-s*.5,0]),n=c.VEC2_2D_TO_ISO([s*.5,0]),a=c.VEC2_2D_TO_ISO([0,e*.5]);return{f:i,l:r,r:n,b:a}}if(t=="RIGHT"){const i=c.VEC2_2D_TO_ISO([0,-e*.5]),r=c.VEC2_2D_TO_ISO([s*.5,0]),n=c.VEC2_2D_TO_ISO([-s*.5,0]),a=c.VEC2_2D_TO_ISO([0,e*.5]);return{f:i,l:r,r:n,b:a}}return{f:[0,0],l:[0,0],r:[0,0],b:[0,0]}}static VEC3_CREATE(t=0,e=0,s=0){const i=new Float32Array(3);return i[0]=t,i[1]=e,i[2]=s,i}static VEC3_PARSE(t,e=" ",s=[0,0,0]){const i=t.split(e);return s[0]=parseFloat(i[0]),s[1]=parseFloat(i[1]),s[2]=parseFloat(i[2]),s}static VEC3_COPY(t,e=[0,0,0]){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}static VEC3_ISZERO(t){return Math.abs(t[0])<=c.EPSILON&&Math.abs(t[1])<=c.EPSILON&&Math.abs(t[2])<=c.EPSILON}static VEC3_SPREAD(t,e){const s=c.VEC3_CREATE(Math.random()-.5,Math.random()-.5,Math.random()-.5);return c.VEC3_ADD(t,c.VEC3_MULTIPLY(e,s))}static VEC3_ROTATE_AROUND(t,e,s,i){const r=Math.cos(i)*e,n=Math.sin(i)*e,a=Math.sin(s)*r,h=Math.cos(s)*r;return[t[0]+h,t[1]+n,t[2]+a]}static VEC3_OPPOSITE(t,e=[0,0,0]){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e}static VEC3_DISTANCE(t,e){const s=e[0]-t[0],i=e[1]-t[1],r=e[2]-t[2];return Math.sqrt(s*s+i*i+r*r)}static VEC3_LENGTH(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2])}static VEC3_NORMALIZE(t,e=[0,0,0]){const s=c.VEC3_LENGTH(t);return s>0&&(e[0]=t[0]/s,e[1]=t[1]/s,e[2]=t[2]/s),e}static VEC3_DOT(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}static VEC3_CROSS(t,e,s=[0,0,0]){return s[0]=t[1]*e[2]-t[2]*e[1],s[1]=t[2]*e[0]-t[0]*e[2],s[2]=t[0]*e[1]-t[1]*e[0],s}static VEC3_ADD(t,e,s=[0,0,0]){return s[0]=t[0]+e[0],s[1]=t[1]+e[1],s[2]=t[2]+e[2],s}static VEC3_SUBSTRACT(t,e,s=[0,0,0]){return s[0]=t[0]-e[0],s[1]=t[1]-e[1],s[2]=t[2]-e[2],s}static VEC3_MULTIPLY(t,e,s=[0,0,0]){return s[0]=t[0]*e[0],s[1]=t[1]*e[1],s[2]=t[2]*e[2],s}static VEC3_SCALE(t,e,s=[0,0,0]){return s[0]=t[0]*e,s[1]=t[1]*e,s[2]=t[2]*e,s}static VEC3_ADD_SCALED(t,e,s,i=[0,0,0]){return i[0]=t[0]+e[0]*s,i[1]=t[1]+e[1]*s,i[2]=t[2]+e[2]*s,i}static VEC3_ISEQUAL(t,e){return t[0]==e[0]&&t[1]==e[1]&&t[2]==e[2]}static VEC3_QUADRATIC_BEZIER(t,e,s,i,r=[0,0,0]){const n=t[0]+(e[0]-t[0])*i,a=t[1]+(e[1]-t[1])*i,h=t[2]+(e[2]-t[2])*i,o=e[0]+(s[0]-e[0])*i,l=e[1]+(s[1]-e[1])*i,f=e[2]+(s[2]-e[2])*i;return r[0]=n+(o-n)*i,r[1]=a+(l-a)*i,r[2]=h+(f-h)*i,r}static VEC4_CREATE(t=0,e=0,s=0,i=0){const r=new Float32Array(4);return r[0]=t,r[1]=e,r[2]=s,r[3]=i,r}static VEC4_PARSE(t,e=" ",s=[0,0,0,0]){const i=t.split(e);return s[0]=parseFloat(i[0]),s[1]=parseFloat(i[1]),s[2]=parseFloat(i[2]),s[3]=1,s}static VEC4_COPY(t,e=[0,0,0,0]){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}static VEC4_ISZERO(t){return Math.abs(t[0])<=c.EPSILON&&Math.abs(t[1])<=c.EPSILON&&Math.abs(t[2])<=c.EPSILON&&Math.abs(t[3])<=c.EPSILON}static MAT3_CREATE(){const t=new Float32Array(9);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t}static MAT3_COPY(t,e){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e}static MAT3_MULTIPLY_BY_VEC3(t,e,s=[0,0,0]){const i=t[0],r=t[1],n=t[2],a=t[3],h=t[4],o=t[5],l=t[6],f=t[7],p=t[8],g=e[0],E=e[1],T=e[2];return s[0]=g*i+E*a+T*l,s[1]=g*r+E*h+T*f,s[2]=g*n+E*o+T*p,s}static MAT3_MULTIPLY(t,e,s=[0,0,0,0,0,0,0,0,0]){const i=t[0],r=t[1],n=t[2],a=t[3],h=t[4],o=t[5],l=t[6],f=t[7],p=t[8],g=e[0],E=e[1],T=e[2],M=e[3],m=e[4],d=e[5],A=e[6],S=e[7],I=e[8],P=g*i+E*a+T*l,C=g*r+E*h+T*f,R=g*n+E*o+T*p,_=M*i+m*a+d*l,O=M*r+m*h+d*f,y=M*n+m*o+d*p,b=A*i+S*a+I*l,B=A*r+S*h+I*f,U=A*n+S*o+I*p;return s[0]=P,s[1]=C,s[2]=R,s[3]=_,s[4]=O,s[5]=y,s[6]=b,s[7]=B,s[8]=U,s}static MAT3_INVERT(t,e=[0,0,0,0,0,0,0,0,0]){const s=t[0],i=t[1],r=t[2],n=t[3],a=t[4],h=t[5],o=t[6],l=t[7],f=t[8],p=f*a-h*l,g=-f*n+h*o,E=l*n-a*o;let T=s*p+i*g+r*E;if(!T)throw new Error("UT::MAT4_INVERT(): det is invalid !");T=1/T;const M=p*T,m=(-f*i+r*l)*T,d=(h*i-r*a)*T,A=g*T,S=(f*s-r*o)*T,I=(-h*s+r*n)*T,P=E*T,C=(-l*s+i*o)*T,R=(a*s-i*n)*T;return e[0]=M,e[1]=m,e[2]=d,e[3]=A,e[4]=S,e[5]=I,e[6]=P,e[7]=C,e[8]=R,e}static MAT3_IDENTITY(t=[0,0,0,0,0,0,0,0,0]){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t}static MAT3_SCALE(t,e,s=[0,0,0,0,0,0,0,0,0]){return s[0]=t,s[1]=0,s[2]=0,s[3]=0,s[4]=e,s[5]=0,s[6]=0,s[7]=0,s[8]=1,s}static MAT3_ROTATE(t,e=[0,0,0,0,0,0,0,0,0]){const s=Math.cos(t),i=Math.sin(t);return e[0]=s,e[1]=-i,e[2]=0,e[3]=i,e[4]=s,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e}static MAT3_TRANSLATE(t,e,s=[0,0,0,0,0,0,0,0,0]){return s[0]=1,s[1]=0,s[2]=0,s[3]=0,s[4]=1,s[5]=0,s[6]=t,s[7]=e,s[8]=1,s}static MAT3_TRANSFORM(t,e,s,i,r=[0,0,0,0,0,0,0,0,0]){return c.MAT3_TRANSLATE(t[0],t[1],r),c.MAT3_MULTIPLY(r,c.MAT3_ROTATE(s),r),c.MAT3_MULTIPLY(r,c.MAT3_SCALE(i[0],i[1]),r),c.MAT3_MULTIPLY(r,c.MAT3_TRANSLATE(-e[0],-e[1]),r),r}static MAT3_PROJECTION(t,e,s=[0,0,0,0,0,0,0,0,0]){return s[0]=2/t,s[1]=0,s[2]=0,s[3]=0,s[4]=2/e,s[5]=0,s[6]=-1,s[7]=-1,s[8]=1,s}static MAT4_CREATE(){const t=new Float32Array(16);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}static MAT4_COPY(t,e){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}static MAT4_MULTIPLY_BY_VEC4(t,e,s=[0,0,0,0]){const i=t[0],r=t[1],n=t[2],a=t[3],h=t[4],o=t[5],l=t[6],f=t[7],p=t[8],g=t[9],E=t[10],T=t[11],M=t[12],m=t[13],d=t[14],A=t[15],S=e[0],I=e[1],P=e[2],C=e[3];return s[0]=S*i+I*h+P*p+C*M,s[1]=S*r+I*o+P*g+C*m,s[2]=S*n+I*l+P*E+C*d,s[3]=S*a+I*f+P*T+C*A,s}static MAT4_MULTIPLY(t,e,s=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){const i=t[0],r=t[1],n=t[2],a=t[3],h=t[4],o=t[5],l=t[6],f=t[7],p=t[8],g=t[9],E=t[10],T=t[11],M=t[12],m=t[13],d=t[14],A=t[15],S=e[0],I=e[1],P=e[2],C=e[3],R=e[4],_=e[5],O=e[6],y=e[7],b=e[8],B=e[9],U=e[10],L=e[11],$=e[12],k=e[13],K=e[14],J=e[15];return s[0]=S*i+I*h+P*p+C*M,s[1]=S*r+I*o+P*g+C*m,s[2]=S*n+I*l+P*E+C*d,s[3]=S*a+I*f+P*T+C*A,s[4]=R*i+_*h+O*p+y*M,s[5]=R*r+_*o+O*g+y*m,s[6]=R*n+_*l+O*E+y*d,s[7]=R*a+_*f+O*T+y*A,s[8]=b*i+B*h+U*p+L*M,s[9]=b*r+B*o+U*g+L*m,s[10]=b*n+B*l+U*E+L*d,s[11]=b*a+B*f+U*T+L*A,s[12]=$*i+k*h+K*p+J*M,s[13]=$*r+k*o+K*g+J*m,s[14]=$*n+k*l+K*E+J*d,s[15]=$*a+k*f+K*T+J*A,s}static MAT4_COMPUTE(...t){for(let e=0;e<t.length-1;e++)t[e+1]=c.MAT4_MULTIPLY(t[e],t[e+1]);return t[t.length-1]}static MAT4_INVERT(t,e=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){const s=t[0],i=t[1],r=t[2],n=t[3],a=t[4],h=t[5],o=t[6],l=t[7],f=t[8],p=t[9],g=t[10],E=t[11],T=t[12],M=t[13],m=t[14],d=t[15],A=s*h-i*a,S=s*o-r*a,I=s*l-n*a,P=i*o-r*h,C=i*l-n*h,R=r*l-n*o,_=f*M-p*T,O=f*m-g*T,y=f*d-E*T,b=p*m-g*M,B=p*d-E*M,U=g*d-E*m;let L=A*U-S*B+I*b+P*y-C*O+R*_;if(!L)throw new Error("UT::MAT4_INVERT(): det is invalid !");L=1/L;const $=(h*U-o*B+l*b)*L,k=(r*B-i*U-n*b)*L,K=(M*R-m*C+d*P)*L,J=(g*C-p*R-E*P)*L,Zt=(o*y-a*U-l*O)*L,qt=(s*U-r*y+n*O)*L,jt=(m*I-T*R-d*S)*L,$t=(f*R-g*I+E*S)*L,kt=(a*B-h*y+l*_)*L,Kt=(i*y-s*B-n*_)*L,Jt=(T*C-M*I+d*A)*L,Qt=(p*I-f*C-E*A)*L,te=(h*O-a*b-o*_)*L,ee=(s*b-i*O+r*_)*L,se=(M*S-T*P-m*A)*L,ie=(f*P-p*S+g*A)*L;return e[0]=$,e[1]=k,e[2]=K,e[3]=J,e[4]=Zt,e[5]=qt,e[6]=jt,e[7]=$t,e[8]=kt,e[9]=Kt,e[10]=Jt,e[11]=Qt,e[12]=te,e[13]=ee,e[14]=se,e[15]=ie,e}static MAT4_IDENTITY(t=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}static MAT4_SCALE(t,e,s,i=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){return i[0]=t,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=e,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=s,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i}static MAT4_ROTATE_X(t,e=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){const s=Math.cos(t),i=Math.sin(t);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=s,e[6]=-i,e[7]=0,e[8]=0,e[9]=i,e[10]=s,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}static MAT4_ROTATE_Y(t,e=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){const s=Math.cos(t),i=Math.sin(t);return e[0]=s,e[1]=0,e[2]=i,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=-i,e[9]=0,e[10]=s,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}static MAT4_ROTATE_Z(t,e=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){const s=Math.cos(t),i=Math.sin(t);return e[0]=s,e[1]=i,e[2]=0,e[3]=0,e[4]=-i,e[5]=s,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}static MAT4_TRANSLATE(t,e,s,i=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){return i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=t,i[13]=e,i[14]=s,i[15]=1,i}static MAT4_TRANSFORM(t,e,s,i,r=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){return c.MAT4_TRANSLATE(t[0],t[1],t[2],r),c.MAT4_MULTIPLY(r,i.toMatrix4(),r),c.MAT4_MULTIPLY(r,c.MAT4_ROTATE_Y(e[1]),r),c.MAT4_MULTIPLY(r,c.MAT4_ROTATE_X(e[0]),r),c.MAT4_MULTIPLY(r,c.MAT4_ROTATE_Z(e[2]),r),c.MAT4_MULTIPLY(r,c.MAT4_SCALE(s[0],s[1],s[2]),r),r}static MAT4_ORTHOGRAPHIC(t,e,s,i=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){return i[0]=2/t,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=2/e,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=-2/s,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i}static MAT4_ORTHO(t,e,s,i,r,n,a=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){return a[0]=2/(e-t),a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2/(i-s),a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=2/(r-n),a[11]=0,a[12]=(t+e)/(t-e),a[13]=(s+i)/(s-i),a[14]=(r+n)/(r-n),a[15]=1,a}static MAT4_PERSPECTIVE(t,e,s,i,r=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){return r[0]=1/(Math.tan(t/2)*e),r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1/Math.tan(t/2),r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=(s+i)/(s-i),r[11]=-1,r[12]=0,r[13]=0,r[14]=2*i*s/(s-i),r[15]=0,r}static MAT4_LOOKAT(t,e,s=c.VEC3_UP,i=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){const r=c.VEC3_NORMALIZE(c.VEC3_SUBSTRACT(t,e));if(s=c.VEC3_NORMALIZE(s),Math.abs(c.VEC3_DOT(r,s))>1-c.EPSILON){const h=Math.abs(r[1])<1-c.EPSILON?[0,1,0]:[1,0,0];s=c.VEC3_NORMALIZE(c.VEC3_CROSS(h,r))}const n=c.VEC3_NORMALIZE(c.VEC3_CROSS(s,r)),a=c.VEC3_NORMALIZE(c.VEC3_CROSS(r,n));return i[0]=n[0],i[1]=n[1],i[2]=n[2],i[3]=0,i[4]=a[0],i[5]=a[1],i[6]=a[2],i[7]=0,i[8]=r[0],i[9]=r[1],i[10]=r[2],i[11]=0,i[12]=t[0],i[13]=t[1],i[14]=t[2],i[15]=1,i}static MAT4_TRANSPOSE(t,e=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){const s=t[0],i=t[1],r=t[2],n=t[3],a=t[4],h=t[5],o=t[6],l=t[7],f=t[8],p=t[9],g=t[10],E=t[11],T=t[12],M=t[13],m=t[14],d=t[15];return e[0]=s,e[1]=a,e[2]=f,e[3]=T,e[4]=i,e[5]=h,e[6]=p,e[7]=M,e[8]=r,e[9]=o,e[10]=g,e[11]=m,e[12]=n,e[13]=l,e[14]=E,e[15]=d,e}static COLLIDE_CIRCLE(t,e,s,i,r=[0,0]){const n=c.VEC2_SUBSTRACT(t,s),a=c.VEC2_LENGTH(n),h=e+i;if(a>h)return!1;const o=Math.PI*2-(Math.PI*2-Math.atan2(n[1],n[0]));return r[0]=Math.cos(o)*(h-a),r[1]=Math.sin(o)*(h-a),!0}static COLLIDE_CYLINDER(t,e,s,i,r,n,a=[0,0]){if(!c.COLLIDE_CIRCLE([t[0],t[2]],e,[i[0],i[2]],r,a))return!1;let o=t[1],l=t[1]+s,f=i[1],p=i[1]+n;return o<=p&&l>=f}static COLLIDE_POINT_TO_RECT(t,e,s){return t[0]>=e[0]&&t[0]<=s[0]&&t[1]>=e[1]&&t[1]<=s[1]}static COLLIDE_RECT_TO_RECT(t,e,s,i){return t[0]<=i[0]&&e[0]>=s[0]&&t[1]<=i[1]&&e[1]>=s[1]}static COLLIDE_POINT_TO_BOX(t,e,s){return t[0]>=e[0]&&t[0]<=s[0]&&t[1]>=e[1]&&t[1]<=s[1]&&t[2]>=e[2]&&t[2]<=s[2]}static COLLIDE_BOX_TO_BOX(t,e,s,i){return t[0]<=i[0]&&e[0]>=s[0]&&t[1]<=i[1]&&e[1]>=s[1]&&t[2]<=i[2]&&e[2]>=s[2]}static COLLIDE_LINE_TO_LINE(t,e,s,i){let r=c.VEC2_ORIENTATION(t,e,s),n=c.VEC2_ORIENTATION(t,e,i),a=c.VEC2_ORIENTATION(s,i,t),h=c.VEC2_ORIENTATION(s,i,e);return r!=n&&a!=h}static TRI2_POINT_INSIDE(t,e,s,i){const r=c.VEC2_SUBSTRACT(s,e),n=c.VEC2_SUBSTRACT(i,s),a=c.VEC2_SUBSTRACT(e,i),h=c.VEC2_SUBSTRACT(t,e),o=c.VEC2_SUBSTRACT(t,s),l=c.VEC2_SUBSTRACT(t,i);return c.VEC2_CROSS(h,r)<-c.EPSILON?-1:c.VEC2_CROSS(o,n)<-c.EPSILON?-2:c.VEC2_CROSS(l,a)<-c.EPSILON?-3:1}static TRI3_NORMAL(t,e,s,i=[0,0,0]){const r=c.VEC3_SUBSTRACT(e,t),n=c.VEC3_SUBSTRACT(s,t);return c.VEC3_CROSS(r,n,i)}static TRI3_POINT_INSIDE(t,e,s,i){const r=c.VEC3_SUBSTRACT(i,e),n=c.VEC3_SUBSTRACT(s,e),a=c.VEC3_SUBSTRACT(t,e),h=c.VEC3_DOT(r,r),o=c.VEC3_DOT(r,n),l=c.VEC3_DOT(r,a),f=c.VEC3_DOT(n,n),p=c.VEC3_DOT(n,a),g=1/(h*f-o*o),E=(f*l-o*p)*g,T=(h*p-o*l)*g;return E>=0&&T>=0&&E+T<1}static TRI3_POINT_ELEVATION(t,e,s,i){const r=c.VEC3_CREATE(s[0]-e[0],0,s[2]-e[2]),n=c.VEC3_CREATE(e[0]-i[0],0,e[2]-i[2]),a=c.VEC3_CREATE(t[0]-e[0],0,t[1]-e[2]),h=c.VEC3_CREATE(t[0]-s[0],0,t[1]-s[2]),o=c.VEC3_CREATE(t[0]-i[0],0,t[1]-i[2]),l=c.VEC3_LENGTH(c.VEC3_CROSS(r,n)),f=c.VEC3_LENGTH(c.VEC3_CROSS(h,o))/l,p=c.VEC3_LENGTH(c.VEC3_CROSS(a,o))/l,g=c.VEC3_LENGTH(c.VEC3_CROSS(a,h))/l;if(f+p+g>1+c.BIG_EPSILON)return 1/0;const E=e[1]+(s[1]-e[1])*(p/(f+p));return E+(i[1]-E)*(g/(f+p+g))}static RAY_TRIANGLE(t,e,s,i,r,n=!1,a=[0,0,0]){const h=c.TRI3_NORMAL(s,i,r);return c.RAY_PLAN(t,e,s,h,n,a)?c.TRI3_POINT_INSIDE(a,s,i,r):!1}static RAY_PLAN(t,e,s,i,r,n=[0,0,0]){const a=c.VEC3_DOT(e,i);if(r&&a>=0||a>-c.EPSILON&&a<c.EPSILON)return!1;const h=c.VEC3_DOT(i,s)*-1,l=(c.VEC3_DOT(i,t)*-1-h)/a;return l<0?!1:(n[0]=t[0]+e[0]*l,n[1]=t[1]+e[1]*l,n[2]=t[2]+e[2]*l,!0)}static RAY_BOX(t,e,s,i,r=[0,0,0]){for(let n=0;n<3;n++)if(t[n]<s[n]){const a=(s[n]-t[n])/e[n],h=t[0]+e[0]*a,o=t[1]+e[1]*a,l=t[2]+e[2]*a;if(h>=s[0]&&h<=i[0]&&o>=s[1]&&o<=i[1]&&l>=s[2]&&l<=i[2])return r[0]=h,r[1]=o,r[2]=l,!0}else if(t[n]>i[n]){const a=(i[n]-t[n])/e[n],h=t[0]+e[0]*a,o=t[1]+e[1]*a,l=t[2]+e[2]*a;if(h>=s[0]&&h<=i[0]&&o>=s[1]&&o<=i[1]&&l>=s[2]&&l<=i[2])return r[0]=h,r[1]=o,r[2]=l,!0}return!1}static LINEAR(t,e,s,i=1){return e+(s-e)*t/i}static EASE_IN_QUAD(t,e,s,i=1){return(s-e)*(t/=i)*t+e}static EASE_OUT_QUAD(t,e,s,i=1){return-(s-e)*(t/=i)*(t-2)+e}static EASE_IN_OUT_QUAD(t,e,s,i=1){const r=s-e;return(t/=i/2)<1?r/2*t*t+e:-r/2*(--t*(t-2)-1)+e}static LINEAR_VEC2(t,e,s,i=1){const r=c.VEC2_SUBSTRACT(s,e),n=t/i;return[e[0]+r[0]*n,e[1]+r[1]*n]}static LINEAR_VEC3(t,e,s,i=1){const r=c.VEC3_SUBSTRACT(s,e),n=t/i;return[e[0]+r[0]*n,e[1]+r[1]*n,e[2]+r[2]*n]}}class Lt{cameraMatrix;clipOffset;viewport;projectionMode;perspectiveFovy;perspectiveNear;perspectiveFar;orthographicSize;orthographicDepth;bgColor;screenSize;constructor(){this.cameraMatrix=c.MAT4_IDENTITY(),this.clipOffset=[0,0],this.viewport={xFactor:0,yFactor:0,widthFactor:1,heightFactor:1},this.projectionMode="PERSPECTIVE",this.perspectiveFovy=Math.PI/4,this.perspectiveNear=.1,this.perspectiveFar=2e3,this.orthographicSize=1,this.orthographicDepth=700,this.bgColor=[0,0,0,0],this.screenSize=[0,0]}getCameraPosition(){return[this.cameraMatrix[12],this.cameraMatrix[13],this.cameraMatrix[14]]}getClipOffset(){return this.clipOffset}getClipOffsetX(){return this.clipOffset[0]}getClipOffsetY(){return this.clipOffset[1]}setClipOffset(t,e){this.clipOffset[0]=t,this.clipOffset[1]=e}getCameraMatrix(){return this.cameraMatrix}setCameraMatrix(t){this.cameraMatrix=t}getViewport(){return this.viewport}setViewport(t){this.viewport=t}getProjectionMode(){return this.projectionMode}setProjectionMode(t){this.projectionMode=t}getPerspectiveFovy(){return this.perspectiveFovy}setPerspectiveFovy(t){this.perspectiveFovy=t}getPerspectiveNear(){return this.perspectiveNear}setPerspectiveNear(t){this.perspectiveNear=t}getPerspectiveFar(){return this.perspectiveFar}setPerspectiveFar(t){this.perspectiveFar=t}getOrthographicSize(){return this.orthographicSize}setOrthographicSize(t){this.orthographicSize=t}getOrthographicDepth(){return this.orthographicDepth}setOrthographicDepth(t){this.orthographicDepth=t}getBgColor(){return this.bgColor}setBgColor(t,e,s,i){this.bgColor[0]=t,this.bgColor[1]=e,this.bgColor[2]=s,this.bgColor[3]=i}getScreenSize(){return this.screenSize}setScreenSize(t,e){this.screenSize[0]=t,this.screenSize[1]=e}getViewportSize(){const t=this.screenSize[0]*this.viewport.widthFactor,e=this.screenSize[1]*this.viewport.heightFactor;return[t,e]}getViewportClientSize(){const t=this.screenSize[0]*this.viewport.widthFactor/window.devicePixelRatio,e=this.screenSize[1]*this.viewport.heightFactor/window.devicePixelRatio;return[t,e]}getProjectionMatrix(){const t=c.MAT4_IDENTITY(),e=this.screenSize[0]*this.viewport.widthFactor,s=this.screenSize[1]*this.viewport.heightFactor,i=e/s;return this.projectionMode=="PERSPECTIVE"?c.MAT4_PERSPECTIVE(this.perspectiveFovy,i,this.perspectiveNear,this.perspectiveFar,t):this.projectionMode=="ORTHOGRAPHIC"&&c.MAT4_ORTHOGRAPHIC(this.orthographicSize,this.orthographicSize/i,this.orthographicDepth,t),t}getClipMatrix(){return c.MAT4_INVERT(c.MAT4_TRANSLATE(this.clipOffset[0],this.clipOffset[1],0))}getCameraViewMatrix(){return c.MAT4_INVERT(this.cameraMatrix)}getProjectionClipMatrix(){const t=c.MAT4_IDENTITY();return c.MAT4_MULTIPLY(t,this.getClipMatrix(),t),c.MAT4_MULTIPLY(t,this.getProjectionMatrix(),t),t}getViewProjectionClipMatrix(){const t=c.MAT4_IDENTITY();return c.MAT4_MULTIPLY(t,this.getClipMatrix(),t),c.MAT4_MULTIPLY(t,this.getProjectionMatrix(),t),c.MAT4_MULTIPLY(t,this.getCameraViewMatrix(),t),t}getClientScreenPosition(t,e,s){const i=c.MAT4_IDENTITY();c.MAT4_MULTIPLY(i,this.getClipMatrix(),i),c.MAT4_MULTIPLY(i,this.getProjectionMatrix(),i),c.MAT4_MULTIPLY(i,this.getCameraViewMatrix(),i);const r=c.MAT4_MULTIPLY_BY_VEC4(i,[t,e,s,1]),n=this.getViewportClientSize();return r[0]=r[0]/r[3],r[1]=r[1]/r[3],r[0]=(r[0]+1)*n[0]/2,r[1]=n[1]-(r[1]+1)*n[1]/2,[r[0],r[1]]}getScreenNormalizedPosition(t,e,s){const i=c.MAT4_IDENTITY();c.MAT4_MULTIPLY(i,this.getClipMatrix(),i),c.MAT4_MULTIPLY(i,this.getProjectionMatrix(),i),c.MAT4_MULTIPLY(i,this.getCameraViewMatrix(),i);const r=c.MAT4_MULTIPLY_BY_VEC4(i,[t,e,s,1]);return[r[0]/r[3],r[1]/r[3]]}}const st=256;class ae{device;pipeline;groupIndex;uniformsByteLength;uniforms;textures;buffer;currentOffset;bindGroup;constructor(t,e,s){this.device=t,this.pipeline=e,this.groupIndex=s,this.uniformsByteLength=0,this.uniforms=new Map,this.textures=new Map,this.buffer=t.createBuffer({size:16*4,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.currentOffset=0,this.bindGroup=null}delete(){this.buffer.destroy()}setFloat(t,e,s){let i=s*4,r=Math.ceil(i/256)*st;return this.uniforms.set(t,{binding:t,name:e,size:i,alignment:r}),this.uniformsByteLength+=r,new Float32Array(s)}setInteger(t,e,s){let i=s*4,r=Math.ceil(i/256)*st;return this.uniforms.set(t,{binding:t,name:e,size:i,alignment:r}),this.uniformsByteLength+=r,new Uint32Array(s)}setTexture(t,e,s,i={}){return this.textures.set(t,{binding:t,name:e,resource:s.gpuTexture.createView(i)}),s}setSampler(t,e,s){return this.textures.set(t,{binding:t,name:e,resource:s.gpuSampler}),s}allocate(){this.buffer.size!=this.uniformsByteLength&&(this.buffer.destroy(),this.buffer=this.device.createBuffer({size:this.uniformsByteLength,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}));let t=[],e=0;for(const s of this.uniforms.values())t[s.binding]={binding:s.binding,resource:{buffer:this.buffer,offset:e,size:s.size}},e+=s.alignment;for(const s of this.textures.values())t[s.binding]={binding:s.binding,resource:s.resource};this.bindGroup=this.device.createBindGroup({layout:this.pipeline.getBindGroupLayout(this.groupIndex),entries:t})}beginWrite(){this.currentOffset=0}write(t,e){this.device.queue.writeBuffer(this.buffer,this.currentOffset,e),this.currentOffset+=Math.ceil(e.byteLength/256)*st}endWrite(){this.currentOffset=0}getBindGroup(){return this.bindGroup}}class oe{device;pipeline;groupIndex;uniformsByteLength;uniforms;buffer;currentOffset;bindGroups;size;constructor(t,e,s){this.device=t,this.pipeline=e,this.groupIndex=s,this.uniformsByteLength=0,this.uniforms=new Map,this.buffer=t.createBuffer({size:16*4,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.currentOffset=0,this.bindGroups=[],this.size=0}delete(){this.buffer.destroy(),this.bindGroups=[]}setFloat(t,e,s){let i=s*4,r=Math.ceil(i/256)*st;return this.uniforms.set(t,{binding:t,name:e,size:i,alignment:r}),this.uniformsByteLength+=r,new Float32Array(s)}setInteger(t,e,s){let i=s*4,r=Math.ceil(i/256)*st;return this.uniforms.set(t,{binding:t,name:e,size:i,alignment:r}),this.uniformsByteLength+=r,new Uint32Array(s)}allocate(t=1){this.bindGroups=[],this.buffer.size!=t*this.uniformsByteLength&&(this.buffer.destroy(),this.buffer=this.device.createBuffer({size:t*this.uniformsByteLength,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}));for(let e=0,s=0,i=[];e<t;e++){for(const r of this.uniforms.values())i[r.binding]={binding:r.binding,resource:{buffer:this.buffer,offset:s,size:r.size}},s+=r.alignment;this.bindGroups.push(this.device.createBindGroup({layout:this.pipeline.getBindGroupLayout(this.groupIndex),entries:i}))}this.size=t}beginWrite(){this.currentOffset=0}write(t,e){this.device.queue.writeBuffer(this.buffer,this.currentOffset,e),this.currentOffset+=Math.ceil(e.byteLength/256)*st}endWrite(){this.currentOffset=0}getBindGroup(t=0){return this.bindGroups[t]}getSize(){return this.size}}class he{adapter;device;canvas;ctx;destinationTexture;normalsTexture;idsTexture;depthTexture;commandEncoder;passEncoder;pipelines;vertexBuffer;vertexSubBuffers;vertexSubBuffersSize;views;currentView;lastRenderStart;lastRenderTime;constructor(){this.adapter={},this.device={},this.canvas={},this.ctx={},this.destinationTexture=null,this.normalsTexture={},this.idsTexture={},this.depthTexture={},this.commandEncoder={},this.passEncoder={},this.pipelines=new Map,this.vertexBuffer={},this.vertexSubBuffers=[],this.vertexSubBuffersSize=0,this.views=[],this.currentView=new Lt,this.lastRenderStart=0,this.lastRenderTime=0}async initialize(){if(!navigator.gpu)throw c.FAIL("This browser does not support webgpu"),new Error("Gfx3Manager::Gfx3Manager: WebGPU cannot be initialized - navigator.gpu not found");if(this.adapter=await navigator.gpu.requestAdapter(),!this.adapter)throw c.FAIL("This browser appears to support WebGPU but it's disabled"),new Error("Gfx3Manager::Gfx3Manager: WebGPU cannot be initialized - Adapter not found");if(this.device=await this.adapter.requestDevice(),this.device.lost.then(()=>{throw new Error("Gfx3Manager::Gfx3Manager: WebGPU cannot be initialized - Device has been lost")}),this.canvas=document.getElementById("CANVAS_3D"),!this.canvas)throw new Error("Gfx3Manager::Gfx3Manager: CANVAS_3D not found");if(this.ctx=this.canvas.getContext("webgpu"),!this.ctx)throw new Error("Gfx3Manager::Gfx3Manager: WebGPU cannot be initialized - Canvas does not support WebGPU");this.ctx.configure({device:this.device,format:navigator.gpu.getPreferredCanvasFormat(),alphaMode:"opaque"});const t=window.devicePixelRatio||1;this.canvas.width=this.canvas.clientWidth*t,this.canvas.height=this.canvas.clientHeight*t,this.currentView=this.createView(),this.normalsTexture=this.createRenderingTexture("rgba16float"),this.idsTexture=this.createRenderingTexture("rgba16float"),this.depthTexture=this.createRenderingTexture("depth24plus"),this.vertexBuffer=this.device.createBuffer({size:0,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),D.subscribe(St,"E_RESIZE",this,this.$handleWindowResize)}beginDrawing(){}endDrawing(){if(this.vertexSubBuffersSize>0&&this.vertexSubBuffersSize!=this.vertexBuffer.size){this.vertexBuffer.destroy(),this.vertexBuffer=this.device.createBuffer({size:this.vertexSubBuffersSize,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST});for(const t of this.vertexSubBuffers)this.device.queue.writeBuffer(this.vertexBuffer,t.offset,t.vertices),t.changed=!1;return}for(const t of this.vertexSubBuffers)t.changed&&(this.device.queue.writeBuffer(this.vertexBuffer,t.offset,t.vertices),t.changed=!1)}beginRender(){this.commandEncoder=this.device.createCommandEncoder(),this.lastRenderStart=Date.now()}beginPassRender(t){const e=this.views[t],s=e.getViewport(),i=this.canvas.width*s.xFactor,r=this.canvas.height*s.yFactor,n=this.canvas.width*s.widthFactor,a=this.canvas.height*s.heightFactor,h=e.getBgColor(),o=this.destinationTexture?this.destinationTexture.createView():this.ctx.getCurrentTexture().createView();this.passEncoder=this.commandEncoder.beginRenderPass({colorAttachments:[{view:o,clearValue:{r:h[0],g:h[1],b:h[2],a:h[3]},loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{view:this.depthTexture.gpuTexture.createView(),depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"}}),this.currentView=e,this.passEncoder.setViewport(i,r,n,a,0,1),this.passEncoder.setScissorRect(i,r,n,a)}endPassRender(){this.passEncoder.end()}endRender(){this.device.queue.submit([this.commandEncoder.finish()]),this.lastRenderTime=Date.now()-this.lastRenderStart}loadPipeline(t,e,s,i){if(this.pipelines.has(t))return this.pipelines.get(t);i.vertex&&(i.vertex.module=this.device.createShaderModule({code:e})),i.fragment&&(i.fragment.module=this.device.createShaderModule({code:s}));const r=this.device.createRenderPipeline(i);return this.pipelines.set(t,r),r}deletePipeline(t){if(!this.pipelines.has(t))throw new Error("Gfx3Manager::deletePipeline(): pipeline not found !");this.pipelines.delete(t)}getPipeline(t){if(!this.pipelines.has(t))throw new Error("Gfx3Manager::getPipeline(): pipeline not found !");return this.pipelines.get(t)}createVertexBuffer(t){const e={vertices:new Float32Array(t),offset:this.vertexSubBuffersSize,changed:!1};return this.vertexSubBuffers.push(e),this.vertexSubBuffersSize+=t,e}destroyVertexBuffer(t){const e=this.vertexSubBuffers.indexOf(t);this.vertexSubBuffers.splice(e,1);for(const s of this.vertexSubBuffers)s.offset>t.offset&&(s.offset-=t.vertices.byteLength);this.vertexSubBuffersSize-=t.vertices.byteLength}writeVertexBuffer(t,e){t.vertices=new Float32Array(e),t.changed=!0}createStaticGroup(t,e){return new ae(this.device,this.getPipeline(t),e)}createDynamicGroup(t,e){return new oe(this.device,this.getPipeline(t),e)}createRenderingTexture(t=navigator.gpu.getPreferredCanvasFormat()){return this.createEmptyTexture(this.getWidth(),this.getHeight(),t,{magFilter:"nearest",minFilter:"nearest"})}createEmptyTexture(t,e,s,i={}){const r=this.device.createTexture({size:[t,e],format:s,usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT}),n=this.device.createSampler({magFilter:i.magFilter??"linear",minFilter:i.minFilter??"linear",addressModeU:i.addressModeU??"repeat",addressModeV:i.addressModeV??"repeat"});return{gpuTexture:r,gpuSampler:n}}createTextureFromBitmap(t,e=!1,s={}){if(!t){const n=document.createElement("canvas");n.getContext("2d"),n.width=1,n.height=1,t=n}const i=this.device.createTexture({size:[t.width,t.height],format:e?"r8unorm":"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT});this.device.queue.copyExternalImageToTexture({source:t},{texture:i},[t.width,t.height]);const r=this.device.createSampler({magFilter:s.magFilter??"linear",minFilter:s.minFilter??"linear",addressModeU:s.addressModeU??"repeat",addressModeV:s.addressModeV??"repeat"});return{gpuTexture:i,gpuSampler:r}}createCubeMapFromBitmap(t){if(!t||t.length==0){const i=document.createElement("canvas");i.getContext("2d"),i.width=1,i.height=1,t=[];for(let r=0;r<6;r++)t.push(i)}const e=this.device.createTexture({dimension:"2d",size:[t[0].width,t[0].height,6],format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT});for(let i=0;i<t.length;i++){const r=t[i];this.device.queue.copyExternalImageToTexture({source:r},{texture:e,origin:[0,0,i]},[r.width,r.height])}const s=this.device.createSampler({magFilter:"linear",minFilter:"linear"});return{gpuTexture:e,gpuSampler:s}}setFilter(t){this.canvas.style.filter=t}hasFilter(){return this.canvas.style.filter!=""&&this.canvas.style.filter!="none"}getClientWidth(){return this.canvas.clientWidth}getClientHeight(){return this.canvas.clientHeight}getWidth(){const t=window.devicePixelRatio||1;return this.canvas.clientWidth*t}getHeight(){const t=window.devicePixelRatio||1;return this.canvas.clientHeight*t}getContext(){return this.ctx}getDevice(){return this.device}setDestinationTexture(t){this.destinationTexture=t}getNormalsTexture(){return this.normalsTexture}getIdsTexture(){return this.idsTexture}getDepthTexture(){return this.depthTexture}getCurrentRenderingTexture(){return this.ctx.getCurrentTexture()}getCommandEncoder(){return this.commandEncoder}getPassEncoder(){return this.passEncoder}getView(t){return this.views[t]}getNumViews(){return this.views.length}createView(){const t=new Lt;return t.setScreenSize(this.canvas.width,this.canvas.height),this.views.push(t),t}changeView(t,e){this.views[t]=e}removeView(t){this.views.splice(this.views.indexOf(t),1)}removeViewAt(t){this.views.splice(t,1)}getCurrentView(){return this.currentView}getVertexBuffer(){return this.vertexBuffer}getLastRenderTime(){return this.lastRenderTime}$handleWindowResize(){const t=window.devicePixelRatio||1;this.canvas.width=this.canvas.clientWidth*t,this.canvas.height=this.canvas.clientHeight*t,this.normalsTexture.gpuTexture.destroy(),this.normalsTexture=this.createRenderingTexture("rgba16float"),this.idsTexture.gpuTexture.destroy(),this.idsTexture=this.createRenderingTexture("rgba16float"),this.depthTexture.gpuTexture.destroy(),this.depthTexture=this.createRenderingTexture("depth24plus");for(const e of this.views)e.setScreenSize(this.canvas.width,this.canvas.height)}}const v=new he;await v.initialize();class j{pipeline;constructor(t,e,s,i){this.pipeline=v.loadPipeline(t,e,s,i)}}const Ft=6,ce={label:"Debug pipeline",layout:"auto",vertex:{entryPoint:"main",buffers:[{arrayStride:Ft*4,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:3*4,format:"float32x3"}]}]},fragment:{entryPoint:"main",targets:[{format:navigator.gpu.getPreferredCanvasFormat()},{format:"rgba16float"},{format:"rgba16float"}]},primitive:{topology:"line-list",cullMode:"back",frontFace:"ccw"},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth24plus"}},ue=`
struct VertexOutput {
  @builtin(position) Position: vec4<f32>,
  @location(0) Color: vec3<f32>
};

@binding(0) @group(0) var<uniform> MVPC_MATRIX: mat4x4<f32>;

@vertex
fn main(
  @location(0) Position: vec4<f32>,
  @location(1) Color: vec3<f32>
) -> VertexOutput {
  var output: VertexOutput;
  output.Position = MVPC_MATRIX * Position;
  output.Color = Color;
  return output;
}`,le=`
struct FragOutput {
  @location(0) Base: vec4f,
  @location(1) Normal: vec4f,
  @location(2) Id: vec4f
}

@fragment
fn main(
  @location(0) Color: vec3<f32>
) -> FragOutput {
  var output: FragOutput;
  output.Base = vec4(Color, 1);
  output.Normal = vec4(0.0, 0.0, 0.0, 0.0);
  output.Id = vec4(0.0, 0.0, 0.0, 0.0);
  return output;
}`;class pe extends j{device;vertexBuffer;vertexCount;commands;showDebug;grp0;mvpcMatrix;constructor(){super("DEBUG_PIPELINE",ue,le,ce),this.device=v.getDevice(),this.vertexBuffer=this.device.createBuffer({size:0,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC}),this.vertexCount=0,this.commands=[],this.showDebug=!1,this.grp0=v.createDynamicGroup("DEBUG_PIPELINE",0),this.mvpcMatrix=this.grp0.setFloat(0,"MVPC_MATRIX",16),this.grp0.allocate()}render(){if(!this.showDebug)return;const t=v.getCurrentView(),e=v.getPassEncoder(),s=t.getViewProjectionClipMatrix();e.setPipeline(this.pipeline),this.vertexBuffer.destroy(),this.vertexBuffer=this.device.createBuffer({size:this.vertexCount*Ft*4,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC}),this.grp0.allocate(this.commands.length),this.grp0.beginWrite();for(let i=0,r=0;i<this.commands.length;i++){const n=this.commands[i];this.grp0.write(0,c.MAT4_MULTIPLY(s,n.matrix,this.mvpcMatrix)),e.setBindGroup(0,this.grp0.getBindGroup(i)),this.device.queue.writeBuffer(this.vertexBuffer,r,n.vertices),e.setVertexBuffer(0,this.vertexBuffer,r,n.vertices.byteLength),e.draw(n.vertexCount),r+=n.vertices.byteLength}this.grp0.endWrite(),this.commands=[],this.vertexCount=0}drawVertices(t,e,s){this.commands.push({vertices:new Float32Array(t),vertexCount:e,matrix:s}),this.vertexCount+=e}drawCylinder(t,e,s,i,r,n=[1,1,1]){let a=0;const h=[],o=Math.PI*2/i,l=0,f=0,p=0,g=0,E=s,T=0;for(let M=0;M<Math.PI*2;M+=o){const m=e*Math.cos(M),d=0,A=e*Math.sin(M)*-1,S=e*Math.cos(M+o),I=0,P=e*Math.sin(M+o)*-1,C=e*Math.cos(M),R=s,_=e*Math.sin(M)*-1,O=e*Math.cos(M+o),y=s,b=e*Math.sin(M+o)*-1;h.push(m,d,A,n[0],n[1],n[2]),h.push(C,R,_,n[0],n[1],n[2]),h.push(m,d,A,n[0],n[1],n[2]),h.push(S,I,P,n[0],n[1],n[2]),h.push(C,R,_,n[0],n[1],n[2]),h.push(O,y,b,n[0],n[1],n[2]),a+=6,r&&(h.push(l,f,p,n[0],n[1],n[2]),h.push(m,d,A,n[0],n[1],n[2]),h.push(g,E,T,n[0],n[1],n[2]),h.push(C,R,_,n[0],n[1],n[2]),a+=4)}this.commands.push({vertices:new Float32Array(h),vertexCount:a,matrix:t}),this.vertexCount+=a}drawGrid(t,e=3,s=1,i=[1,1,1]){let r=0;const n=[],a=e*2,h=a*s,o=-h*.5,l=-h*.5;for(let f=0;f<=a;f++){const p=o+f*s,g=l,E=0,T=o+f*s,M=l+h,m=0,d=o,A=l+f*s,S=0,I=o+h,P=l+f*s,C=0;n.push(p,g,E,i[0],i[1],i[2]),n.push(T,M,m,i[0],i[1],i[2]),n.push(d,A,S,i[0],i[1],i[2]),n.push(I,P,C,i[0],i[1],i[2]),r+=4}this.commands.push({vertices:new Float32Array(n),vertexCount:r,matrix:t}),this.vertexCount+=r}drawGizmo(t,e=1){let s=0;const i=[],r=[[1*e,0,0],[0,1*e,0],[0,0,1*e]],n=[[1,0,0],[0,1,0],[0,0,1]];for(let a=0;a<r.length;a++)i.push(0,0,0,n[a][0],n[a][1],n[a][2]),i.push(r[a][0],r[a][1],r[a][2],n[a][0],n[a][1],n[a][2]),s+=2;this.commands.push({vertices:new Float32Array(i),vertexCount:s,matrix:t}),this.vertexCount+=s}drawCircle(t,e=1,s=4,i=[1,1,1]){let r=0;const n=[],a=Math.PI*2/s;for(let h=0;h<s;h++){const o=Math.cos(h*a)*e,l=Math.sin(h*a)*e,f=0,p=Math.cos((h+1)*a)*e,g=Math.sin((h+1)*a)*e,E=0;n.push(o,l,f,i[0],i[1],i[2]),n.push(p,g,E,i[0],i[1],i[2]),r+=2}this.commands.push({vertices:new Float32Array(n),vertexCount:r,matrix:t}),this.vertexCount+=r}drawBoundingRect(t,e,s,i=[1,1,1]){let r=0;const n=[],a=[e[0],0,e[1]],h=[e[0],0,s[1]],o=[s[0],0,e[1]],l=[s[0],0,s[1]];n.push(a[0],a[1],a[2],i[0],i[1],i[2]),n.push(h[0],h[1],h[2],i[0],i[1],i[2]),r+=2,n.push(h[0],h[1],h[2],i[0],i[1],i[2]),n.push(l[0],l[1],l[2],i[0],i[1],i[2]),r+=2,n.push(l[0],l[1],l[2],i[0],i[1],i[2]),n.push(o[0],o[1],o[2],i[0],i[1],i[2]),r+=2,n.push(o[0],o[1],o[2],i[0],i[1],i[2]),n.push(a[0],a[1],a[2],i[0],i[1],i[2]),r+=2,this.commands.push({vertices:new Float32Array(n),vertexCount:r,matrix:t}),this.vertexCount+=r}drawSphere(t,e=1,s=4,i=[1,1,1]){let r=0;const n=[],a=[],h=Math.PI*.5/s;for(let o=-s;o<=s;o++){const l=Math.cos(o*h)*e,f=Math.sin(o*h)*e;for(let p=0;p<=s*4;p++){const g=Math.sin(p*h)*l,E=Math.cos(p*h)*l;a.push([E,f,g])}}for(let o=-s;o<=s;o++)for(let l=0;l<=s*4;l++){const f=Math.cos(l*h)*e*Math.cos(o*h),p=Math.sin(l*h)*e,g=Math.cos(l*h)*e*Math.sin(o*h);a.push([f,p,g])}for(let o=0;o<a.length-1;o++)n.push(a[o][0],a[o][1],a[o][2],i[0],i[1],i[2]),n.push(a[o+1][0],a[o+1][1],a[o+1][2],i[0],i[1],i[2]),r+=2;this.commands.push({vertices:new Float32Array(n),vertexCount:r,matrix:t}),this.vertexCount+=r}drawBoundingBox(t,e,s,i=[1,1,1]){let r=0;const n=[],a=[e[0],e[1],e[2]],h=[s[0],e[1],e[2]],o=[s[0],s[1],e[2]],l=[e[0],s[1],e[2]],f=[e[0],s[1],s[2]],p=[s[0],s[1],s[2]],g=[s[0],e[1],s[2]],E=[e[0],e[1],s[2]];n.push(a[0],a[1],a[2],i[0],i[1],i[2]),n.push(h[0],h[1],h[2],i[0],i[1],i[2]),n.push(E[0],E[1],E[2],i[0],i[1],i[2]),n.push(g[0],g[1],g[2],i[0],i[1],i[2]),r+=4,n.push(l[0],l[1],l[2],i[0],i[1],i[2]),n.push(o[0],o[1],o[2],i[0],i[1],i[2]),n.push(f[0],f[1],f[2],i[0],i[1],i[2]),n.push(p[0],p[1],p[2],i[0],i[1],i[2]),r+=4,n.push(a[0],a[1],a[2],i[0],i[1],i[2]),n.push(l[0],l[1],l[2],i[0],i[1],i[2]),n.push(E[0],E[1],E[2],i[0],i[1],i[2]),n.push(f[0],f[1],f[2],i[0],i[1],i[2]),r+=4,n.push(h[0],h[1],h[2],i[0],i[1],i[2]),n.push(o[0],o[1],o[2],i[0],i[1],i[2]),n.push(g[0],g[1],g[2],i[0],i[1],i[2]),n.push(p[0],p[1],p[2],i[0],i[1],i[2]),r+=4,n.push(l[0],l[1],l[2],i[0],i[1],i[2]),n.push(f[0],f[1],f[2],i[0],i[1],i[2]),n.push(o[0],o[1],o[2],i[0],i[1],i[2]),n.push(p[0],p[1],p[2],i[0],i[1],i[2]),r+=4,n.push(a[0],a[1],a[2],i[0],i[1],i[2]),n.push(E[0],E[1],E[2],i[0],i[1],i[2]),n.push(h[0],h[1],h[2],i[0],i[1],i[2]),n.push(g[0],g[1],g[2],i[0],i[1],i[2]),r+=4,this.commands.push({vertices:new Float32Array(n),vertexCount:r,matrix:t}),this.vertexCount+=r}isShowDebug(){return this.showDebug}setShowDebug(t){this.showDebug=t}}const Ct=new pe,Pt=17,dt=64,Et=64,fe={label:"Mesh pipeline",layout:"auto",vertex:{entryPoint:"main",buffers:[{arrayStride:Pt*4,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:3*4,format:"float32x2"},{shaderLocation:2,offset:5*4,format:"float32x3"},{shaderLocation:3,offset:8*4,format:"float32x3"},{shaderLocation:4,offset:11*4,format:"float32x3"},{shaderLocation:5,offset:14*4,format:"float32x3"}]}]},fragment:{entryPoint:"main",targets:[{format:navigator.gpu.getPreferredCanvasFormat(),blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha",operation:"add"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"}}}]},primitive:{topology:"triangle-list",cullMode:"back",frontFace:"ccw"},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth24plus"}},ge=`
struct VertexOutput {
  @builtin(position) Position: vec4<f32>,
  @location(0) FragPos: vec3<f32>,
  @location(1) FragUV: vec2<f32>,
  @location(2) FragColor: vec3<f32>,
  @location(3) FragNormal: vec3<f32>,
  @location(4) FragTangent: vec3<f32>,
  @location(5) FragBinormal: vec3<f32>,
  @location(6) FragShadowPos: vec3<f32>
}

struct MeshInfos {
  MVPC_MATRIX: mat4x4<f32>,
  M_MATRIX: mat4x4<f32>,
  NORM_MATRIX: mat3x3<f32>,
  ID: vec4<f32>
}

@group(0) @binding(7) var<uniform> LVP_MATRIX: mat4x4<f32>;
@group(1) @binding(0) var<uniform> MESH_INFOS: MeshInfos;

@vertex
fn main(
  @location(0) Position: vec4<f32>,
  @location(1) TexUV: vec2<f32>,
  @location(2) Color: vec3<f32>,
  @location(3) Normal: vec3<f32>,
  @location(4) Tangent: vec3<f32>,
  @location(5) Binormal: vec3<f32>
) -> VertexOutput {
  var posFromLight = LVP_MATRIX * MESH_INFOS.M_MATRIX * Position;
  var output: VertexOutput;
  output.Position = MESH_INFOS.MVPC_MATRIX * Position;
  output.FragPos = vec4(MESH_INFOS.M_MATRIX * Position).xyz;
  output.FragUV = TexUV;
  output.FragColor = Color;
  output.FragNormal = MESH_INFOS.NORM_MATRIX * Normal;
  output.FragTangent = MESH_INFOS.NORM_MATRIX * Tangent;
  output.FragBinormal = MESH_INFOS.NORM_MATRIX * Binormal;
  output.FragShadowPos = vec3(posFromLight.xy * vec2(0.5, -0.5) + vec2(0.5), posFromLight.z); // Convert XY to (0, 1) and Y is flipped because texture coords are Y-down.
  return output;
}`,de=`
struct FragOutput {
  @location(0) Base: vec4f,
  @location(1) Normal: vec4f,
  @location(2) Id: vec4f
}

struct MeshInfos {
  MVPC_MATRIX: mat4x4<f32>,
  M_MATRIX: mat4x4<f32>,
  NORM_MATRIX: mat3x3<f32>,
  ID: vec4<f32>
}

struct MaterialColors {
  EMISSIVE: vec3<f32>,
  AMBIENT: vec3<f32>,
  DIFFUSE: vec3<f32>,
  SPECULAR: vec3<f32>
}

struct MaterialParams {
  OPACITY: f32,
  NORMAL_INTENSITY: f32,
  HAS_LIGHTNING: f32,
  HAS_TEXTURE: f32,
  HAS_DISPLACEMENT_MAP: f32,
  DISPLACEMENT_MAP_FACTOR: f32,
  HAS_DIFFUSE_MAP: f32,
  HAS_SPECULAR_MAP: f32,
  HAS_EMISSIVE_MAP: f32,
  HAS_NORMAL_MAP: f32,
  HAS_ENV_MAP: f32,
  HAS_DECAL: f32,
  HAS_SHADOW: f32,
  SHININESS: f32,
  EMISSIVE_FACTOR: f32
}

struct MaterialUvs {
  TEXTURE_SCROLL: vec2<f32>,
  TEXTURE_OFFSET: vec2<f32>,
  DISPLACEMENT_MAP_SCROLL: vec2<f32>
}

struct PointLight {
  POSITION: vec3<f32>,
  AMBIENT: vec3<f32>,
  DIFFUSE: vec3<f32>,
  SPECULAR: vec3<f32>,
  ATTEN: vec3<f32>,
  INTENSITY: f32
}

struct DirLight {
  DIR: vec3<f32>,
  ENABLED: f32,
  AMBIENT: vec3<f32>,
  DIFFUSE: vec3<f32>,
  SPECULAR: vec3<f32>,
  INTENSITY: f32
}

struct Fog {
  ENABLED: f32,
  NEAR: f32,
  FAR: f32,
  COLOR: vec3<f32>,
  FROM: vec3<f32>
}

struct Decal {
  VP_MATRIX: mat4x4<f32>,
  TEXTURE_LEFT: f32,
  TEXTURE_TOP: f32,
  TEXTURE_WIDTH: f32,
  TEXTURE_HEIGHT: f32,
  ASPECT_RATIO: vec2<f32>,
  OPACITY: f32,
  GROUP: f32
}

@group(1) @binding(0) var<uniform> MESH_INFOS: MeshInfos;
@group(0) @binding(0) var<uniform> CAMERA_POS: vec3<f32>;
@group(0) @binding(1) var<uniform> DIR_LIGHT: DirLight;
@group(0) @binding(2) var<uniform> FOG: Fog;
@group(0) @binding(3) var<uniform> POINT_LIGHT_COUNT: u32;
@group(0) @binding(4) var<uniform> POINT_LIGHTS: array<PointLight, ${dt}>;
@group(0) @binding(5) var<uniform> DECAL_COUNT: u32;
@group(0) @binding(6) var<uniform> DECALS: array<Decal, ${Et}>;
@group(0) @binding(8) var DECAL_ATLAS_TEXTURE: texture_2d<f32>;
@group(0) @binding(9) var DECAL_ATLAS_SAMPLER: sampler;
@group(0) @binding(10) var SHADOW_MAP_TEXTURE: texture_depth_2d;
@group(0) @binding(11) var SHADOW_MAP_SAMPLER: sampler_comparison;
@group(2) @binding(0) var<uniform> MAT_COLORS: MaterialColors;
@group(2) @binding(1) var<uniform> MAT_PARAMS: MaterialParams;
@group(2) @binding(2) var<uniform> MAT_UVS: MaterialUvs;
@group(3) @binding(0) var MAT_TEXTURE: texture_2d<f32>;
@group(3) @binding(1) var MAT_SAMPLER: sampler;
@group(3) @binding(2) var MAT_DISPLACEMENT_TEXTURE: texture_2d<f32>;
@group(3) @binding(3) var MAT_DISPLACEMENT_SAMPLER: sampler;
@group(3) @binding(4) var MAT_DIFFUSE_TEXTURE: texture_2d<f32>;
@group(3) @binding(5) var MAT_DIFFUSE_SAMPLER: sampler;
@group(3) @binding(6) var MAT_SPECULAR_TEXTURE: texture_2d<f32>;
@group(3) @binding(7) var MAT_SPECULAR_SAMPLER: sampler;
@group(3) @binding(8) var MAT_EMISSIVE_TEXTURE: texture_2d<f32>;
@group(3) @binding(9) var MAT_EMISSIVE_SAMPLER: sampler;
@group(3) @binding(10) var MAT_NORM_TEXTURE: texture_2d<f32>;
@group(3) @binding(11) var MAT_NORM_SAMPLER: sampler;
@group(3) @binding(12) var MAT_ENV_MAP_TEXTURE: texture_cube<f32>;
@group(3) @binding(13) var MAT_ENV_MAP_SAMPLER: sampler;

@fragment
fn main(
  @builtin(position) Position: vec4<f32>,
  @location(0) FragPos: vec3<f32>,
  @location(1) FragUV: vec2<f32>,
  @location(2) FragColor: vec3<f32>,
  @location(3) FragNormal: vec3<f32>,
  @location(4) FragTangent: vec3<f32>,
  @location(5) FragBinormal: vec3<f32>,
  @location(6) FragShadowPos: vec3<f32>
) -> FragOutput {
  var normal = normalize(FragNormal);
  var outputColor = vec4(0.0, 0.0, 0.0, 1.0);
  var texel = vec4(1.0, 1.0, 1.0, 1.0);
  var textureUV = MAT_UVS.TEXTURE_SCROLL + MAT_UVS.TEXTURE_OFFSET + FragUV;

  if (MAT_PARAMS.HAS_DISPLACEMENT_MAP == 1.0)
  {
    textureUV += CalcDisplacementMap(FragUV);
  }

  if (MAT_PARAMS.HAS_TEXTURE == 1.0)
  {
    texel = textureSample(MAT_TEXTURE, MAT_SAMPLER, textureUV) * vec4<f32>(FragColor, 1.0);
  }

  if (texel.a == 0)
  {
    discard;
  }

  if (MAT_PARAMS.HAS_DECAL == 1.0)
  {
    var decalsColor = vec4(0.0, 0.0, 0.0, 0.0);
    for (var i: u32 = 0; i < DECAL_COUNT; i++)
    {
      if (MESH_INFOS.ID.g == DECALS[i].GROUP)
      {
        decalsColor += CalcDecal(i, FragPos);
      }
    }

    var alpha = min(texel.a + decalsColor.a, 1.0);
    texel = mix(texel, decalsColor, decalsColor.a);
    texel.a = alpha;
  }

  if (MAT_PARAMS.HAS_NORMAL_MAP == 1.0)
  {
    normal = CalcNormalMap(normal, FragTangent, FragBinormal, textureUV);
  }

  if (MAT_PARAMS.HAS_LIGHTNING == 1.0)
  {
    var totalLight = vec4(0.0, 0.0, 0.0, 0.0);
    var shadow = 1.0;
    
    if (MAT_PARAMS.HAS_SHADOW == 1.0)
    {
      shadow = CalcShadow(FragShadowPos);
    }

    if (DIR_LIGHT.ENABLED == 1.0)
    {
      totalLight += CalcDirLight(normal, FragPos, textureUV, shadow);
    }

    for (var i: u32 = 0; i < POINT_LIGHT_COUNT; i++)
    {
      totalLight += CalcPointLight(i, normal, FragPos, textureUV, shadow);
    }

    outputColor = texel * totalLight;
  }
  else
  {
    outputColor = texel;
  }

  if (MAT_PARAMS.HAS_ENV_MAP == 1.0)
  {
    outputColor += CalcEnvMap(normal, FragPos);
  }

  if (FOG.ENABLED == 1.0)
  {
    outputColor = CalcFog(outputColor.rgb, texel.a * MAT_PARAMS.OPACITY, FragPos);
  }
  else
  {
    outputColor = vec4(outputColor.rgb, texel.a * MAT_PARAMS.OPACITY);
  }

  var output: FragOutput;
  output.Base = outputColor;
  output.Normal = vec4(normalize(FragNormal), 1.0);
  output.Id = MESH_INFOS.ID;
  return output;
}

// *****************************************************************************************************************
// CALC FOG
// *****************************************************************************************************************
fn CalcFog(inputColor: vec3<f32>, inputAlpha: f32, fragPos: vec3<f32>) -> vec4<f32>
{
  var fogColor = FOG.COLOR;
  var fogStart = FOG.NEAR;
  var fogEnd = FOG.FAR;
  var fogDist = length(FOG.FROM - fragPos);
  var fogFactor = clamp((fogEnd - fogDist) / (fogEnd - fogStart), 0.0, 1.0);
  var outputColor = (fogColor * (1.0 - fogFactor)) + (inputColor * fogFactor);
  var outputAlpha = mix(inputAlpha, 1.0, fogFactor);
  return vec4<f32>(outputColor, outputAlpha);
}

// *****************************************************************************************************************
// CALC DECAL
// *****************************************************************************************************************
fn CalcDecal(index: u32, fragPos: vec3<f32>) -> vec4<f32>
{
  var ctrlColor = vec4(1.0, 1.0, 1.0, 1.0);
  var clipPos = DECALS[index].VP_MATRIX * vec4<f32>(fragPos, 1.0);
  if (clipPos.z < -1.0 || clipPos.z > 1.0)
  {
    ctrlColor = vec4(0.0, 0.0, 0.0, 0.0);
  }

  var ndcPos = vec3<f32>(clipPos.xyz / clipPos.w).xy * DECALS[index].ASPECT_RATIO;
  if (ndcPos.x < -1.0 || ndcPos.x > 1.0 || ndcPos.y < -1.0 || ndcPos.y > 1.0)
  {
    ctrlColor = vec4(0.0, 0.0, 0.0, 0.0);
  }

  var uvx = ndcPos.x * 0.5 + 0.5;
  uvx = (uvx * DECALS[index].TEXTURE_WIDTH) + DECALS[index].TEXTURE_LEFT;

  var uvy = 1.0 - (ndcPos.y * 0.5 + 0.5);
  uvy = (uvy * DECALS[index].TEXTURE_HEIGHT) + DECALS[index].TEXTURE_TOP;

  var texColor = textureSample(DECAL_ATLAS_TEXTURE, DECAL_ATLAS_SAMPLER, vec2<f32>(uvx, uvy));
  texColor.a = max(texColor.a - (1.0 - DECALS[index].OPACITY), 0.0);
  return texColor * ctrlColor;
}

// *****************************************************************************************************************
// CALC NORMAL MAP
// *****************************************************************************************************************
fn CalcNormalMap(normal: vec3<f32>, fragTangent: vec3<f32>, fragBinormal: vec3<f32>, textureUV: vec2<f32>) -> vec3<f32>
{
  var normalIntensity = vec4<f32>(MAT_PARAMS.NORMAL_INTENSITY, MAT_PARAMS.NORMAL_INTENSITY, 1, 1);
  var normalPixel = textureSample(MAT_NORM_TEXTURE, MAT_NORM_SAMPLER, textureUV) * normalIntensity;
  return normalize(normalize(fragTangent) * normalPixel.x + normalize(fragBinormal) * normalPixel.y + normal * normalPixel.z);
}

// *****************************************************************************************************************
// CALC ENV MAP
// *****************************************************************************************************************
fn CalcEnvMap(normal: vec3<f32>, fragPos: vec3<f32>) -> vec4<f32>
{
  var viewDir = normalize(CAMERA_POS - fragPos);
  var rvec = normalize(reflect(viewDir, normal));
  return textureSample(MAT_ENV_MAP_TEXTURE, MAT_ENV_MAP_SAMPLER, vec3<f32>(rvec.x, rvec.y, rvec.z));
}

// *****************************************************************************************************************
// CALC DISPLACEMENT MAP
// *****************************************************************************************************************
fn CalcDisplacementMap(fragUV: vec2<f32>) -> vec2<f32>
{
  var textureUV = MAT_UVS.DISPLACEMENT_MAP_SCROLL + fragUV;
  var offset = vec2(0.0, 0.0);
  var greyScale = textureSample(MAT_DISPLACEMENT_TEXTURE, MAT_DISPLACEMENT_SAMPLER, textureUV).r;
  offset.x = clamp(MAT_PARAMS.DISPLACEMENT_MAP_FACTOR * ((greyScale * 2) - 1), 0.0, 1.0);
  offset.y = clamp(MAT_PARAMS.DISPLACEMENT_MAP_FACTOR * ((greyScale * 2) - 1), 0.0, 1.0);
  return offset;
}

// *****************************************************************************************************************
// CALC LIGHT INTERNAL
// *****************************************************************************************************************
fn CalcLightInternal(lightDir: vec3<f32>, lightAmbient: vec3<f32>, lightDiffuse: vec3<f32>, lightSpecular: vec3<f32>, lightIntensity: f32, normal: vec3<f32>, fragPos: vec3<f32>, textureUV: vec2<f32>, shadow: f32) -> vec4<f32>
{
  var ambientColor = lightAmbient * lightIntensity * MAT_COLORS.AMBIENT; // change for lightambiantintensity
  var diffuseColor = vec3(0.0, 0.0, 0.0);
  var specularColor = vec3(0.0, 0.0, 0.0);
  var emissiveColor = vec3(0.0, 0.0, 0.0);
  var matDiffuse = MAT_COLORS.DIFFUSE;
  var matSpecular = MAT_COLORS.SPECULAR;
  var matEmissive = MAT_COLORS.EMISSIVE * MAT_PARAMS.EMISSIVE_FACTOR;

  var diffuseFactor = max(dot(normal, -lightDir), 0.0);

  if (MAT_PARAMS.HAS_DIFFUSE_MAP == 1.0)
  {
    matDiffuse = textureSample(MAT_DIFFUSE_TEXTURE, MAT_DIFFUSE_SAMPLER, textureUV).rgb;
  }

  if (MAT_PARAMS.HAS_SPECULAR_MAP == 1.0)
  {
    matSpecular = textureSample(MAT_SPECULAR_TEXTURE, MAT_SPECULAR_SAMPLER, textureUV).rgb;
  }

  if (MAT_PARAMS.HAS_EMISSIVE_MAP == 1.0)
  {
    matEmissive = textureSample(MAT_EMISSIVE_TEXTURE, MAT_EMISSIVE_SAMPLER, textureUV).rgb * MAT_PARAMS.EMISSIVE_FACTOR;
  }

  if (diffuseFactor > 0.0)
  {
    diffuseColor = lightDiffuse * lightIntensity * matDiffuse * diffuseFactor;
    if (MAT_PARAMS.SHININESS > 0.0)
    {
      var reflectDir = reflect(lightDir, normal);
      var viewDir = normalize(CAMERA_POS - fragPos);
      var specularFactor = max(dot(viewDir, reflectDir), 0.0);
      if (specularFactor > 0.0)
      {
        specularFactor = pow(specularFactor, MAT_PARAMS.SHININESS);
        specularColor = lightSpecular * lightIntensity * matSpecular * specularFactor;
      }
    }
  }

  if (specularColor.r > 0.0)
  {
    emissiveColor = matEmissive;
  }

  return vec4(ambientColor + (diffuseColor * shadow) + (specularColor * shadow) + emissiveColor, 1.0);
}

// *****************************************************************************************************************
// CALC DIR LIGHT
// *****************************************************************************************************************
fn CalcDirLight(normal: vec3<f32>, fragPos: vec3<f32>, textureUV: vec2<f32>, shadow: f32) -> vec4<f32>
{
  return CalcLightInternal(normalize(DIR_LIGHT.DIR), DIR_LIGHT.AMBIENT, DIR_LIGHT.DIFFUSE, DIR_LIGHT.SPECULAR, DIR_LIGHT.INTENSITY, normal, fragPos, textureUV, shadow);
}

// *****************************************************************************************************************
// CALC POINT LIGHT
// *****************************************************************************************************************
fn CalcPointLight(index: u32, normal: vec3<f32>, fragPos: vec3<f32>, textureUV: vec2<f32>, shadow: f32) -> vec4<f32>
{
  var lightDir = fragPos - POINT_LIGHTS[index].POSITION;
  var distance = length(lightDir);
  lightDir = normalize(lightDir);

  var color = CalcLightInternal(lightDir, POINT_LIGHTS[index].AMBIENT, POINT_LIGHTS[index].DIFFUSE, POINT_LIGHTS[index].SPECULAR, POINT_LIGHTS[index].INTENSITY, normal, fragPos, textureUV, shadow);
  var attenuation = POINT_LIGHTS[index].ATTEN[0] + POINT_LIGHTS[index].ATTEN[1] * distance + POINT_LIGHTS[index].ATTEN[2] * distance * distance;
  return color / attenuation;
}

// *****************************************************************************************************************
// CALC SHADOW
// *****************************************************************************************************************
fn CalcShadow(fragShadowPos: vec3<f32>) -> f32
{
  var visibility = 0.0;
  var shadowDepthTextureSize = f32(textureDimensions(SHADOW_MAP_TEXTURE).x);
  var oneOverShadowDepthTextureSize = 1.0 / shadowDepthTextureSize;

  for (var y = -1; y <= 1; y++)
  {
    for (var x = -1; x <= 1; x++)
    {
      var offset = vec2<f32>(vec2(x, y)) * oneOverShadowDepthTextureSize;
      visibility += textureSampleCompare(SHADOW_MAP_TEXTURE, SHADOW_MAP_SAMPLER, fragShadowPos.xy + offset, fragShadowPos.z - 0.007);
    }
  }

  return visibility / 9.0;
}`,Ee={label:"Mesh Shadow pipeline",layout:"auto",vertex:{entryPoint:"main",buffers:[{arrayStride:Pt*4,attributes:[{shaderLocation:0,offset:0,format:"float32x3"}]}]},primitive:{topology:"triangle-list",cullMode:"back",frontFace:"ccw"},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth32float"}},me=`
@group(0) @binding(0) var<uniform> LVP_MATRIX: mat4x4<f32>;
@group(0) @binding(1) var<uniform> M_MATRIX: mat4x4<f32>;

@vertex
fn main(
  @location(0) position: vec3<f32>
) -> @builtin(position) vec4<f32> {
  return LVP_MATRIX * M_MATRIX * vec4(position, 1.0);
}`;class ve{pipeline;depthTextureSize;depthTexture;depthTextureSampler;depthTextureView;meshCommands;grp0;lvpMatrix;mMatrix;constructor(){this.pipeline=v.loadPipeline("MESH_SHADOW_PIPELINE",me,"",Ee),this.depthTextureSize=1024,this.depthTexture=v.getDevice().createTexture({size:[this.depthTextureSize,this.depthTextureSize,1],usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING,format:"depth32float"}),this.depthTextureView=this.depthTexture.createView(),this.depthTextureSampler=v.getDevice().createSampler({compare:"less"}),this.meshCommands=[],this.grp0=v.createDynamicGroup("MESH_SHADOW_PIPELINE",0),this.lvpMatrix=this.grp0.setFloat(0,"LVP_MATRIX",16),this.mMatrix=this.grp0.setFloat(1,"M_MATRIX",16)}render(){const e=v.getCommandEncoder().beginRenderPass({colorAttachments:[],depthStencilAttachment:{view:this.depthTextureView,depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"}});e.setPipeline(this.pipeline),this.grp0.getSize()<this.meshCommands.length&&this.grp0.allocate(this.meshCommands.length),this.grp0.beginWrite();for(let s=0;s<this.meshCommands.length;s++){const i=this.meshCommands[s],r=i.matrix?i.matrix:i.mesh.getTransformMatrix();this.grp0.write(0,this.lvpMatrix),this.grp0.write(1,c.MAT4_COPY(r,this.mMatrix)),e.setBindGroup(0,this.grp0.getBindGroup(s)),e.setVertexBuffer(0,v.getVertexBuffer(),i.mesh.getVertexSubBufferOffset(),i.mesh.getVertexSubBufferSize()),e.draw(i.mesh.getVertexCount())}this.grp0.endWrite(),this.meshCommands=[],e.end()}drawMesh(t,e=null){this.meshCommands.push({mesh:t,matrix:e})}setShadowProjection(t,e,s=600,i=200){const r=c.MAT4_ORTHOGRAPHIC(s,s,i),n=c.MAT4_INVERT(c.MAT4_LOOKAT(t,e,[0,1,0]));c.MAT4_MULTIPLY(r,n,this.lvpMatrix)}setDepthTextureSize(t){this.depthTexture=v.getDevice().createTexture({size:[t,t,1],usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING,format:"depth32float"}),this.depthTextureView=this.depthTexture.createView(),this.depthTextureSampler=v.getDevice().createSampler({compare:"less"}),this.depthTextureSize=t}getDepthTexture(){return{gpuTexture:this.depthTexture,gpuSampler:this.depthTextureSampler}}getLVPMatrix(){return this.lvpMatrix}}const it=new ve;class Te extends j{shadowEnabled;decalAtlasChanged;meshCommands;grp0;camPos;dirLight;fog;pointLightCount;pointLights;decalCount;decals;lvpMatrix;decalAtlas;shadowMap;grp1;meshInfos;constructor(){super("MESH_PIPELINE",ge,de,fe),this.shadowEnabled=!1,this.decalAtlasChanged=!1,this.meshCommands=[],this.grp0=v.createStaticGroup("MESH_PIPELINE",0),this.camPos=this.grp0.setFloat(0,"CAM_POS",3),this.dirLight=this.grp0.setFloat(1,"DIR_LIGHT",16),this.fog=this.grp0.setFloat(2,"FOG",12),this.pointLightCount=this.grp0.setInteger(3,"POINT_LIGHT_COUNT",1),this.pointLights=this.grp0.setFloat(4,"POINT_LIGHTS",20*dt),this.decalCount=this.grp0.setInteger(5,"DECAL_COUNT",1),this.decals=this.grp0.setFloat(6,"DECALS",24*Et),this.lvpMatrix=this.grp0.setFloat(7,"LVP_MATRIX",16),this.decalAtlas=this.grp0.setTexture(8,"DECAL_ATLAS_TEXTURE",v.createTextureFromBitmap()),this.decalAtlas=this.grp0.setSampler(9,"DECAL_ATLAS_SAMPLER",this.decalAtlas),this.shadowMap=this.grp0.setTexture(10,"SHADOW_MAP_TEXTURE",it.getDepthTexture()),this.shadowMap=this.grp0.setSampler(11,"SHADOW_MAP_SAMPLER",this.shadowMap),this.grp1=v.createDynamicGroup("MESH_PIPELINE",1),this.meshInfos=this.grp1.setFloat(0,"MESH_MATRICES",16*4),this.grp0.allocate(),this.grp1.allocate()}render(){const t=v.getCurrentView(),e=v.getPassEncoder(),s=t.getViewProjectionClipMatrix();e.setPipeline(this.pipeline),this.decalAtlasChanged&&(this.grp0.setTexture(8,"DECAL_ATLAS_TEXTURE",this.decalAtlas),this.grp0.allocate(),this.decalAtlasChanged=!1),this.shadowEnabled&&(this.grp0.setTexture(10,"SHADOW_MAP_TEXTURE",it.getDepthTexture()),this.grp0.allocate()),this.grp0.beginWrite(),this.grp0.write(0,c.VEC3_COPY(t.getCameraPosition(),this.camPos)),this.grp0.write(1,this.dirLight),this.grp0.write(2,this.fog),this.grp0.write(3,this.pointLightCount),this.grp0.write(4,this.pointLights),this.grp0.write(5,this.decalCount),this.grp0.write(6,this.decals),this.grp0.write(7,it.getLVPMatrix()),this.grp0.endWrite(),e.setBindGroup(0,this.grp0.getBindGroup()),this.grp1.getSize()<this.meshCommands.length&&this.grp1.allocate(this.meshCommands.length),this.grp1.beginWrite();for(let i=0;i<this.meshCommands.length;i++){const r=this.meshCommands[i],n=r.matrix?r.matrix:r.mesh.getTransformMatrix();this.grp1.write(0,Me(s,n,r.mesh.getId(),this.meshInfos)),e.setBindGroup(1,this.grp1.getBindGroup(i));const a=r.mesh.getMaterial(),h=a.getGroup02(),o=a.getGroup03();e.setBindGroup(2,h.getBindGroup()),e.setBindGroup(3,o.getBindGroup()),e.setVertexBuffer(0,v.getVertexBuffer(),r.mesh.getVertexSubBufferOffset(),r.mesh.getVertexSubBufferSize()),e.draw(r.mesh.getVertexCount())}this.grp1.endWrite(),this.dirLight.fill(0),this.pointLightCount[0]=0,this.pointLights.fill(0),this.decalCount[0]=0,this.decals.fill(0),this.meshCommands=[]}enableShadow(t){this.shadowEnabled=t}setDecalAtlas(t){this.decalAtlas=t,this.decalAtlasChanged=!0}enableFog(t,e=[0,0,0],s=[.5,.5,.5],i=3,r=15){this.fog[0]=t?1:0,this.fog[1]=i,this.fog[2]=r,this.fog[3]=0,this.fog[4]=s[0],this.fog[5]=s[1],this.fog[6]=s[2],this.fog[7]=0,this.fog[8]=e[0],this.fog[9]=e[1],this.fog[10]=e[2],this.fog[11]=0}drawMesh(t,e=null){this.meshCommands.push({mesh:t,matrix:e}),this.shadowEnabled&&t.getShadowCasting()&&it.drawMesh(t,e)}drawDirLight(t,e,s,i,r=1){this.dirLight[0]=t[0],this.dirLight[1]=t[1],this.dirLight[2]=t[2],this.dirLight[3]=1,this.dirLight[4]=e[0],this.dirLight[5]=e[1],this.dirLight[6]=e[2],this.dirLight[7]=0,this.dirLight[8]=s[0],this.dirLight[9]=s[1],this.dirLight[10]=s[2],this.dirLight[11]=0,this.dirLight[12]=i[0],this.dirLight[13]=i[1],this.dirLight[14]=i[2],this.dirLight[15]=r}drawPointLight(t,e,s,i,r=1,n=1,a=0,h=0){const o=this.pointLightCount[0];if(o>=dt)throw new Error("Gfx3MeshRenderer::drawPointLight(): Max point lights number exceeded !");this.pointLights[o*20+0]=t[0],this.pointLights[o*20+1]=t[1],this.pointLights[o*20+2]=t[2],this.pointLights[o*20+3]=0,this.pointLights[o*20+4]=e[0],this.pointLights[o*20+5]=e[1],this.pointLights[o*20+6]=e[2],this.pointLights[o*20+7]=0,this.pointLights[o*20+8]=s[0],this.pointLights[o*20+9]=s[1],this.pointLights[o*20+10]=s[2],this.pointLights[o*20+11]=0,this.pointLights[o*20+12]=i[0],this.pointLights[o*20+13]=i[1],this.pointLights[o*20+14]=i[2],this.pointLights[o*20+15]=0,this.pointLights[o*20+16]=n,this.pointLights[o*20+17]=a,this.pointLights[o*20+18]=h,this.pointLights[o*20+19]=r,this.pointLightCount[0]++}drawDecal(t,e,s,i,r,n,a,h,o,l,f){const p=this.decalCount[0];if(p>=Et)throw new Error("Gfx3MeshRenderer::drawDecal(): Max decals number exceeded !");const g=[a[0],a[1],a[2],0,h[0],h[1],h[2],0,o[0],o[1],o[2],0,n[0],n[1],n[2],1],E=[i>r?1:r/i,i>r?i/r:1],T=c.MAT4_INVERT(g),M=c.MAT4_ORTHOGRAPHIC(l[0],l[1],l[2]),m=c.MAT4_MULTIPLY(T,M);this.decals[p*24+0]=m[0],this.decals[p*24+1]=m[1],this.decals[p*24+2]=m[2],this.decals[p*24+3]=m[3],this.decals[p*24+4]=m[4],this.decals[p*24+5]=m[5],this.decals[p*24+6]=m[6],this.decals[p*24+7]=m[7],this.decals[p*24+8]=m[8],this.decals[p*24+9]=m[9],this.decals[p*24+10]=m[10],this.decals[p*24+11]=m[11],this.decals[p*24+12]=m[12],this.decals[p*24+13]=m[13],this.decals[p*24+14]=m[14],this.decals[p*24+15]=m[15],this.decals[p*24+16]=e/this.decalAtlas.gpuTexture.width,this.decals[p*24+17]=s/this.decalAtlas.gpuTexture.height,this.decals[p*24+18]=i/this.decalAtlas.gpuTexture.width,this.decals[p*24+19]=r/this.decalAtlas.gpuTexture.height,this.decals[p*24+20]=E[0],this.decals[p*24+21]=E[1],this.decals[p*24+22]=f,this.decals[p*24+23]=t,this.decalCount[0]++}}const _t=new Te;function Me(u,t,e,s){return c.MAT4_MULTIPLY(u,t,s),s.set(t,16),s[32+0]=t[0],s[32+1]=t[1],s[32+2]=t[2],s[32+3]=0,s[32+4]=t[4],s[32+5]=t[5],s[32+6]=t[6],s[32+7]=0,s[32+8]=t[8],s[32+9]=t[9],s[32+10]=t[10],s[32+11]=0,s[32+12]=e[0],s[32+13]=e[1],s[32+14]=e[2],s[32+15]=e[3],s}const Ae=5,xe={label:"Sprite pipeline",layout:"auto",vertex:{entryPoint:"main",buffers:[{arrayStride:Ae*4,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:3*4,format:"float32x2"}]}]},fragment:{entryPoint:"main",targets:[{format:navigator.gpu.getPreferredCanvasFormat(),blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha",operation:"add"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"}}},{format:"rgba16float"},{format:"rgba16float"}]},primitive:{topology:"triangle-list",cullMode:"back",frontFace:"ccw"},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth24plus"}},Se=`
struct VertexOutput {
  @builtin(position) Position: vec4<f32>,
  @location(0) FragUV: vec2<f32>
};

@group(0) @binding(0) var<uniform> MVPC_MATRIX: mat4x4<f32>;

@vertex
fn main(
  @location(0) Position : vec4<f32>,
  @location(1) TexUV : vec2<f32>
) -> VertexOutput {
  var output: VertexOutput;
  output.Position = MVPC_MATRIX * Position;
  output.FragUV = TexUV;
  return output;
}`,Ce=`
struct FragOutput {
  @location(0) Base: vec4f,
  @location(1) Normal: vec4f,
  @location(2) Id: vec4f
}

@group(0) @binding(1) var<uniform> ID: vec4<f32>;
@group(1) @binding(0) var TEXTURE: texture_2d<f32>;
@group(1) @binding(1) var SAMPLER: sampler;

@fragment
fn main(
  @location(0) FragUV: vec2<f32>
) -> FragOutput {
  var textureColor = textureSample(TEXTURE, SAMPLER, FragUV);
  if (textureColor.a == 0)
  {
    discard;
  }

  var output: FragOutput;
  output.Base = textureColor;
  output.Normal = vec4(0.0, 0.0, 0.0, 0.0);
  output.Id = ID;
  return output;
}`;class Pe extends j{sprites;grp0;mvpcMatrix;id;constructor(){super("SPRITE_PIPELINE",Se,Ce,xe),this.sprites=[],this.grp0=v.createDynamicGroup("SPRITE_PIPELINE",0),this.mvpcMatrix=this.grp0.setFloat(0,"MVPC_MATRIX",16),this.id=this.grp0.setFloat(1,"ID",4),this.grp0.allocate()}render(){const t=v.getCurrentView(),e=v.getPassEncoder();e.setPipeline(this.pipeline),this.grp0.getSize()<this.sprites.length&&this.grp0.allocate(this.sprites.length),this.grp0.beginWrite();for(let s=0;s<this.sprites.length;s++){const i=this.sprites[s];if(i.getBillboardMode()){const n=t.getCameraMatrix(),a=t.getCameraViewMatrix(),h=t.getProjectionClipMatrix(),o=c.MAT4_MULTIPLY(a,i.getTransformMatrix());c.MAT4_MULTIPLY(o,n,o),c.MAT4_MULTIPLY(o,c.MAT4_TRANSLATE(a[12],a[13],a[14]),o),c.MAT4_MULTIPLY(h,o,this.mvpcMatrix)}else{const n=t.getViewProjectionClipMatrix();c.MAT4_MULTIPLY(n,i.getTransformMatrix(),this.mvpcMatrix)}this.grp0.write(0,this.mvpcMatrix),this.grp0.write(1,c.VEC4_COPY(i.getId(),this.id)),e.setBindGroup(0,this.grp0.getBindGroup(s));const r=i.getGroup01();e.setBindGroup(1,r.getBindGroup()),e.setVertexBuffer(0,v.getVertexBuffer(),i.getVertexSubBufferOffset(),i.getVertexSubBufferSize()),e.draw(i.getVertexCount())}this.grp0.endWrite(),this.sprites=[]}drawSprite(t){this.sprites.push(t)}}new Pe;const _e=6,Ie={label:"Skybox pipeline",layout:"auto",vertex:{entryPoint:"main",buffers:[{arrayStride:_e*4,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:3*4,format:"float32x3"}]}]},fragment:{entryPoint:"main",targets:[{format:navigator.gpu.getPreferredCanvasFormat(),blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha",operation:"add"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"}}},{format:"rgba16float"},{format:"rgba16float"}]},primitive:{topology:"triangle-list",cullMode:"back",frontFace:"ccw"},depthStencil:{depthWriteEnabled:!1,depthCompare:"always",format:"depth24plus"}},Re=`
struct VertexOutput {
  @builtin(position) Position: vec4<f32>,
  @location(0) ClipPos: vec4<f32>
};

@vertex
fn main(
  @location(0) Position: vec4<f32>,
) -> VertexOutput {
  var output : VertexOutput;
  output.Position = Position;
  output.Position.z = 1;
  output.ClipPos = Position;
  return output;
}`,Le=`
struct FragOutput {
  @location(0) Base: vec4f,
  @location(1) Normal: vec4f,
  @location(2) Id: vec4f
};

@group(0) @binding(0) var<uniform> VPC_INVERSE_MATRIX: mat4x4<f32>;
@group(0) @binding(1) var<uniform> ID: vec4<f32>;
@group(1) @binding(0) var CUBEMAP_TEXTURE: texture_cube<f32>;
@group(1) @binding(1) var CUBEMAP_SAMPLER: sampler;

@fragment
fn main(
  @builtin(position) Position: vec4<f32>,
  @location(0) ClipPos: vec4<f32>
) -> FragOutput {
  var t = VPC_INVERSE_MATRIX * ClipPos;

  var output: FragOutput;
  output.Base = textureSample(CUBEMAP_TEXTURE, CUBEMAP_SAMPLER, normalize(t.xyz / t.w));
  output.Normal = vec4(0.0, 0.0, 0.0, 0.0);
  output.Id = ID;
  return output;
}`;class we extends j{skybox;grp0;vpcInverseMatrix;id;constructor(){super("SKYBOX_PIPELINE",Re,Le,Ie),this.skybox=null,this.grp0=v.createStaticGroup("SKYBOX_PIPELINE",0),this.vpcInverseMatrix=this.grp0.setFloat(0,"VPC_INVERSE_MATRIX",16),this.id=this.grp0.setFloat(1,"ID",4),this.grp0.allocate()}render(){if(!this.skybox)return;const t=v.getCurrentView(),e=v.getPassEncoder();e.setPipeline(this.pipeline);const s=new Float32Array(t.getCameraViewMatrix());s[12]=s[13]=s[14]=0;const i=c.MAT4_MULTIPLY(t.getProjectionClipMatrix(),s);this.grp0.beginWrite(),this.grp0.write(0,c.MAT4_INVERT(i,this.vpcInverseMatrix)),this.grp0.write(1,c.VEC4_COPY(this.skybox.getId(),this.id)),this.grp0.endWrite(),e.setBindGroup(0,this.grp0.getBindGroup());const r=this.skybox.getGroup01();e.setBindGroup(1,r.getBindGroup()),e.setVertexBuffer(0,v.getVertexBuffer(),this.skybox.getVertexSubBufferOffset(),this.skybox.getVertexSubBufferSize()),e.draw(this.skybox.getVertexCount())}draw(t){this.skybox=t}}new we;const ye=4,Oe={label:"Flare pipeline",layout:"auto",vertex:{entryPoint:"main",buffers:[{arrayStride:ye*4,attributes:[{shaderLocation:0,offset:0,format:"float32x2"},{shaderLocation:1,offset:2*4,format:"float32x2"}]}]},fragment:{entryPoint:"main",targets:[{format:navigator.gpu.getPreferredCanvasFormat(),blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha",operation:"add"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"}}},{format:"rgba16float"},{format:"rgba16float"}]},primitive:{topology:"triangle-list",cullMode:"none",frontFace:"ccw"},depthStencil:{depthWriteEnabled:!1,depthCompare:"less",format:"depth24plus"}},be=`
struct VertexOutput {
  @builtin(position) Position: vec4<f32>,
  @location(0) FragUV: vec2<f32>
};

@group(0) @binding(0) var<uniform> RESOLUTION: vec2<f32>;
@group(1) @binding(1) var<uniform> TRANSLATION: vec2<f32>;
@group(1) @binding(2) var<uniform> SCALE: vec2<f32>;
@group(1) @binding(3) var<uniform> ANGLE: f32;
@group(1) @binding(4) var<uniform> SIZE: vec2<f32>;
@group(1) @binding(5) var<uniform> OFFSET: vec2<f32>;

@vertex
fn main(
  @location(0) Pos: vec2<f32>,
  @location(1) TexUV: vec2<f32>
) -> VertexOutput {
  var c = cos(ANGLE);
  var s = sin(ANGLE);
  var transformedPos = Pos + OFFSET;
  transformedPos = transformedPos * SIZE * SCALE;
  transformedPos = vec2(c * (transformedPos.x) + s * (transformedPos.y), c * (transformedPos.y) - s * (transformedPos.x));

  var screenPos = transformedPos + TRANSLATION;
  var normScreenPos = screenPos / RESOLUTION;
  var clipPos = normScreenPos * 2.0 - 1.0;
  clipPos.y = clipPos.y * -1;

  var output: VertexOutput;
  output.Position = vec4<f32>(clipPos, 0, 1);
  output.FragUV = TexUV;
  return output;
}`,Ve=`
struct FragOutput {
  @location(0) Base: vec4f,
  @location(1) Normal: vec4f,
  @location(2) Id: vec4f
}

@group(1) @binding(0) var<uniform> ID: vec4<f32>;
@group(1) @binding(6) var<uniform> COLOR: vec4<f32>;
@group(2) @binding(0) var TEXTURE: texture_2d<f32>;
@group(2) @binding(1) var SAMPLER: sampler;

@fragment
fn main(
  @builtin(position) Position: vec4<f32>,
  @location(0) FragUV: vec2<f32>
) -> FragOutput {
  var output: FragOutput;
  output.Base = textureSample(TEXTURE, SAMPLER, FragUV) * COLOR;
  output.Normal = vec4(0.0, 0.0, 0.0, 0.0);
  output.Id = ID;
  return output;
}`;class De extends j{flares;grp0;resolution;grp1;id;translation;scale;angle;size;offset;color;constructor(){super("FLARE_PIPELINE",be,Ve,Oe),this.flares=[],this.grp0=v.createStaticGroup("FLARE_PIPELINE",0),this.resolution=this.grp0.setFloat(0,"RESOLUTION",2),this.grp1=v.createDynamicGroup("FLARE_PIPELINE",1),this.id=this.grp1.setFloat(0,"ID",4),this.translation=this.grp1.setFloat(1,"TRANSLATION",2),this.scale=this.grp1.setFloat(2,"SCALE",2),this.angle=this.grp1.setFloat(3,"ANGLE",1),this.size=this.grp1.setFloat(4,"SIZE",2),this.offset=this.grp1.setFloat(5,"OFFSET",2),this.color=this.grp1.setFloat(6,"COLOR",4),this.grp0.allocate(),this.grp1.allocate()}render(){const t=v.getCurrentView(),e=v.getPassEncoder();e.setPipeline(this.pipeline),this.grp0.beginWrite(),this.grp0.write(0,c.VEC2_COPY(t.getViewportSize(),this.resolution)),this.grp0.endWrite(),e.setBindGroup(0,this.grp0.getBindGroup()),this.grp1.getSize()<this.flares.length&&this.grp1.allocate(this.flares.length),this.grp1.beginWrite();for(let s=0;s<this.flares.length;s++){const i=this.flares[s];this.grp1.write(0,c.VEC4_COPY(i.getId(),this.id)),this.grp1.write(1,c.VEC2_COPY(i.getPosition2D(),this.translation)),this.grp1.write(2,c.VEC2_COPY(i.getScale2D(),this.scale)),this.grp1.write(3,c.VEC1_COPY(i.getRotation2D(),this.angle)),this.grp1.write(4,c.VEC2_COPY(i.getSize2D(),this.size)),this.grp1.write(5,c.VEC2_COPY(i.getOffset2D(),this.offset)),this.grp1.write(6,c.VEC4_COPY(i.getColor(),this.color)),e.setBindGroup(1,this.grp1.getBindGroup(s));const r=i.getGroup02();e.setBindGroup(2,r.getBindGroup()),e.setVertexBuffer(0,v.getVertexBuffer(),i.getVertexSubBufferOffset(),i.getVertexSubBufferSize()),e.draw(i.getVertexCount())}this.grp1.endWrite(),this.flares=[]}drawFlare(t){this.flares.push(t)}}new De;const Ne=15,Fe={label:"Particles pipeline",layout:"auto",vertex:{entryPoint:"main",buffers:[{arrayStride:Ne*4,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:3*4,format:"float32x3"},{shaderLocation:2,offset:6*4,format:"float32x2"},{shaderLocation:3,offset:8*4,format:"float32x3"},{shaderLocation:4,offset:11*4,format:"float32"},{shaderLocation:5,offset:12*4,format:"float32"},{shaderLocation:6,offset:13*4,format:"float32"},{shaderLocation:7,offset:14*4,format:"float32"}]}]},fragment:{entryPoint:"main",targets:[{format:navigator.gpu.getPreferredCanvasFormat(),blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha",operation:"add"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"}}},{format:"rgba16float"},{format:"rgba16float"}]},primitive:{topology:"triangle-list",cullMode:"none",frontFace:"ccw"},depthStencil:{depthWriteEnabled:!1,depthCompare:"less",format:"depth24plus"}},Be=`
struct VertexOutput {
  @builtin(position) Position: vec4<f32>,
  @location(0) FragUV: vec2<f32>,
  @location(1) Color: vec4<f32>,
  @location(2) Angle: f32
};

@group(0) @binding(0) var<uniform> V_MATRIX: mat4x4<f32>;
@group(1) @binding(0) var<uniform> MVPC_MATRIX: mat4x4<f32>;

@vertex
fn main(
  @location(0) Pos: vec3<f32>,
  @location(1) Center: vec3<f32>,
  @location(2) TexUV: vec2<f32>,
  @location(3) Color: vec3<f32>,
  @location(4) Size: f32,
  @location(5) Opacity: f32,
  @location(6) Angle: f32,
  @location(7) Visible: f32
) -> VertexOutput {
  var output: VertexOutput;

  if(Visible == 1)
  {
    output.Color = vec4(Color, Opacity);
  }
  else
  {
    output.Color = vec4(0.0, 0.0, 0.0, 0.0);
  }

  var right = vec3<f32>(V_MATRIX[0][0], V_MATRIX[1][0], V_MATRIX[2][0]);
  var up = vec3<f32>(V_MATRIX[0][1], V_MATRIX[1][1], V_MATRIX[2][1]);

  output.Position = MVPC_MATRIX * vec4<f32>(Center + (right * Pos.x * Size) + (up * Pos.y * Size), 1.0);
  output.FragUV = TexUV;
  output.Angle = Angle;
  return output;
}`,Ue=`
struct FragOutput {
  @location(0) Base: vec4f,
  @location(1) Normal: vec4f,
  @location(2) Id: vec4f
}

@group(1) @binding(1) var<uniform> ID: vec4<f32>;
@group(2) @binding(0) var TEXTURE: texture_2d<f32>;
@group(2) @binding(1) var SAMPLER: sampler;

@fragment
fn main(
  @builtin(position) Position: vec4<f32>,
  @location(0) FragUV: vec2<f32>,
  @location(1) Color: vec4<f32>,
  @location(2) Angle: f32
) -> FragOutput {
  var c = cos(Angle);
  var s = sin(Angle);

  var rotatedUV = vec2(
    c * (FragUV.x - 0.5) + s * (FragUV.y - 0.5) + 0.5,
    c * (FragUV.y - 0.5) - s * (FragUV.x - 0.5) + 0.5
  );

  var output: FragOutput;
  output.Base = textureSample(TEXTURE, SAMPLER, rotatedUV) * Color;
  output.Normal = vec4(0.0, 0.0, 0.0, 0.0);
  output.Id = ID;
  return output;
}`;class Ge extends j{particlesList;grp0;vMatrix;grp1;mvpcMatrix;id;constructor(){super("PARTICLES_PIPELINE",Be,Ue,Fe),this.particlesList=[],this.grp0=v.createStaticGroup("PARTICLES_PIPELINE",0),this.vMatrix=this.grp0.setFloat(0,"V_MATRIX",16),this.grp1=v.createDynamicGroup("PARTICLES_PIPELINE",1),this.mvpcMatrix=this.grp1.setFloat(0,"MVPC_MATRIX",16),this.id=this.grp1.setFloat(1,"ID",4),this.grp0.allocate(),this.grp1.allocate()}render(){const t=v.getCurrentView(),e=v.getPassEncoder(),s=t.getViewProjectionClipMatrix();e.setPipeline(this.pipeline),this.grp0.beginWrite(),this.grp0.write(0,c.MAT4_COPY(t.getCameraViewMatrix(),this.vMatrix)),this.grp0.endWrite(),e.setBindGroup(0,this.grp0.getBindGroup()),this.grp1.getSize()<this.particlesList.length&&this.grp1.allocate(this.particlesList.length),this.grp1.beginWrite();for(let i=0;i<this.particlesList.length;i++){const r=this.particlesList[i];this.grp1.write(0,c.MAT4_MULTIPLY(s,r.getTransformMatrix(),this.mvpcMatrix)),this.grp1.write(1,c.VEC4_COPY(r.getId(),this.id)),e.setBindGroup(1,this.grp1.getBindGroup(i));const n=r.getGroup02();e.setBindGroup(2,n.getBindGroup()),e.setVertexBuffer(0,v.getVertexBuffer(),r.getVertexSubBufferOffset(),r.getVertexSubBufferSize()),e.draw(r.getVertexCount())}this.grp1.endWrite(),this.particlesList=[]}drawParticles(t){this.particlesList.push(t)}}new Ge;class ze{canvas;ctx;cameraTransform;cameraScale;cameraRotation;cameraPosition;bgColor;constructor(){if(this.canvas=document.getElementById("CANVAS_2D"),this.ctx=this.canvas.getContext("2d"),this.cameraTransform=c.MAT3_IDENTITY(),this.cameraScale=[1,1],this.cameraRotation=0,this.cameraPosition=[0,0],this.bgColor=[0,0,0,0],!this.ctx)throw c.FAIL("This browser does not support canvas"),new Error("Gfx2Manager::Gfx2Manager: Your browser not support 2D")}update(t){(this.canvas.width!=this.canvas.clientWidth||this.canvas.height!=this.canvas.clientHeight)&&(this.canvas.width=this.canvas.clientWidth,this.canvas.height=this.canvas.clientHeight)}beginDrawing(){this.ctx.save(),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle=`rgba(${this.bgColor[0]}, ${this.bgColor[1]}, ${this.bgColor[2]}, ${this.bgColor[3]})`,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.transform(this.cameraTransform[0],this.cameraTransform[1],this.cameraTransform[3],this.cameraTransform[4],this.cameraTransform[6],this.cameraTransform[7]),this.ctx.translate(this.canvas.width*.5,this.canvas.height*.5),this.ctx.scale(this.cameraScale[0],this.cameraScale[1]),this.ctx.rotate(this.cameraRotation),this.ctx.translate(-this.cameraPosition[0],-this.cameraPosition[1])}endDrawing(){this.ctx.restore()}moveCamera(t,e){this.cameraPosition[0]+=t,this.cameraPosition[1]+=e}setFilter(t){this.canvas.style.filter=t}hasFilter(){return this.canvas.style.filter!=""&&this.canvas.style.filter!="none"}findCanvasPosFromClientPos(t,e){const s=this.canvas.getBoundingClientRect(),i=t-s.x,r=e-s.y;return[i,r]}findWorldPosFromClientPos(t,e){const s=this.canvas.getBoundingClientRect(),i=t-s.x+this.cameraPosition[0]-this.canvas.width*.5,r=e-s.y+this.cameraPosition[1]-this.canvas.height*.5;return[i,r]}getWidth(){return this.canvas.clientWidth}getHeight(){return this.canvas.clientHeight}getContext(){return this.ctx}setCameraTransform(t){this.cameraTransform=t}getCameraTransform(){return this.cameraTransform}setCameraPosition(t,e){this.cameraPosition[0]=t,this.cameraPosition[1]=e}getCameraPosition(){return this.cameraPosition}getCameraPositionX(){return this.cameraPosition[0]}getCameraPositionY(){return this.cameraPosition[1]}setCameraScale(t,e){this.cameraScale[0]=t,this.cameraScale[1]=e}getCameraScale(){return this.cameraScale}getCameraScaleX(){return this.cameraScale[0]}getCameraScaleY(){return this.cameraScale[1]}setCameraRotation(t){this.cameraRotation=t}getCameraRotation(){return this.cameraRotation}setBgColor(t,e,s,i){this.bgColor[0]=t,this.bgColor[1]=e,this.bgColor[2]=s,this.bgColor[3]=i}getBgColor(){return this.bgColor}getDefaultTexture(){const t=new Image;return t.src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",t}}const ft=new ze;class Xe{requests;screens;constructor(){this.requests=[],this.screens=[]}update(t){for(;this.requests.length>0;)this.requests.pop()();for(let e=this.screens.length-1;e>=0;e--)this.screens[e].isBlocking()||this.screens[e].update(t)}draw(){for(let t=this.screens.length-1;t>=0;t--)this.screens[t].isBlocking()||this.screens[t].draw()}requestPushScreen(t,e={}){this.requests.push(()=>{if(this.screens.indexOf(t)!=-1)throw new Error("ScreenManager::requestPushScreen(): You try to push an existing screen to the stack !");this.screens[this.screens.length-1].onBringToBack(t),t.onEnter(e).then(()=>this.screens.push(t))})}requestSetScreen(t,e={}){this.requests.push(()=>{this.screens.forEach(i=>i.onExit()),this.screens=[],t.onEnter(e).then(()=>this.screens.push(t))})}requestPopScreen(){this.requests.push(()=>{if(this.screens.length==0)throw new Error("ScreenManager::requestPopScreen: You try to pop an empty state stack !");let t=this.screens[this.screens.length-1];t.onExit(),this.screens.pop(),this.screens.length>0&&this.screens[this.screens.length-1].onBringToFront(t)})}}const mt=new Xe;class He{root;fadeLayer;overLayer;focusedWidget;widgets;constructor(){this.root=document.getElementById("UI_ROOT"),this.fadeLayer=document.getElementById("UI_FADELAYER"),this.overLayer=document.getElementById("UI_OVERLAYER"),this.focusedWidget=null,this.widgets=[]}update(t){for(let e of this.widgets)e.update(t)}getWidgets(){return this.widgets}focus(t){this.focusedWidget&&this.focusedWidget.unfocus(),t.focus(),this.focusedWidget=t,D.emit(this,"E_FOCUSED",{widget:t})}unfocus(){this.focusedWidget&&(this.focusedWidget.unfocus(),this.focusedWidget=null,D.emit(this,"E_UNFOCUSED"))}addNode(t,e=""){t.style.cssText+=e,this.root.appendChild(t)}removeNode(t){this.root.removeChild(t)}addWidget(t,e=""){return t.appendStyles(e),this.root.appendChild(t.getNode()),this.widgets.push(t),t}removeWidget(t){const e=this.widgets.indexOf(t);if(e==-1)throw new Error("UIManager::removeWidget: fail to remove widget !");return t==this.focusedWidget&&this.unfocus(),t.delete(),this.widgets.splice(e,1),!0}clear(){for(this.root.innerHTML="",this.focusedWidget=null;this.widgets.length>0;)this.widgets.pop().delete()}fadeIn(t,e,s="#000",i="linear",r=()=>{}){this.fadeLayer.style.transitionDelay=t+"ms",this.fadeLayer.style.transitionDuration=e+"ms",this.fadeLayer.style.backgroundColor=s,this.fadeLayer.style.transitionTimingFunction=i,this.fadeLayer.style.opacity="1",setTimeout(()=>{r()},t+e)}fadeOut(t,e,s="linear",i=()=>{}){this.fadeLayer.style.transitionDuration=e+"ms",this.fadeLayer.style.transitionDelay=t+"ms",this.fadeLayer.style.transitionTimingFunction=s,this.fadeLayer.style.opacity="0",setTimeout(()=>{i()},t+e)}enableOverlayer(t){this.overLayer.style.opacity=t?"1":"0"}setClassName(t){this.root.className=t}}const vt=new He,Bt=4,wt={label:"PPE pipeline",layout:"auto",vertex:{entryPoint:"main",buffers:[{arrayStride:Bt*4,attributes:[{shaderLocation:0,offset:0,format:"float32x2"},{shaderLocation:1,offset:2*4,format:"float32x2"}]}]},fragment:{entryPoint:"main",targets:[{format:navigator.gpu.getPreferredCanvasFormat()}]},primitive:{topology:"triangle-list"}},yt=`
struct VertexOutput {
  @builtin(position) Position: vec4<f32>,
  @location(0) FragUV: vec2<f32>
};

@vertex
fn main(
  @location(0) Position: vec2<f32>,
  @location(1) TexUV: vec2<f32>
) -> VertexOutput {
  var output: VertexOutput;
  output.Position = vec4(Position, 0.0, 1.0);
  output.FragUV = TexUV;
  return output;
}`,Ye=`
struct Params {
  ENABLED: f32,
  PIXELATION_ENABLED: f32,
  PIXELATION_WIDTH: f32,
  PIXELATION_HEIGHT: f32,
  COLOR_ENABLED: f32,
  COLOR_PRECISION: f32,
  DITHER_ENABLED: f32,
  DITHER_PATTERN_INDEX: f32,
  DITHER_THRESHOLD: f32,
  DITHER_SCALE_X: f32,
  DITHER_SCALE_Y: f32,
  OUTLINE_ENABLED: f32,
  OUTLINE_THICKNESS: f32,
  OUTLINE_R: f32,
  OUTLINE_G: f32,
  OUTLINE_B: f32
};

@group(0) @binding(0) var<uniform> PARAMS: Params;
@group(0) @binding(1) var<uniform> SIZE: vec2<f32>;
@group(0) @binding(2) var SOURCE_TEXTURE: texture_2d<f32>;
@group(0) @binding(3) var SOURCE_SAMPLER: sampler;
@group(0) @binding(4) var NORMALS_TEXTURE: texture_2d<f32>;
@group(0) @binding(5) var NORMALS_SAMPLER: sampler;
@group(0) @binding(6) var IDS_TEXTURE: texture_2d<f32>;
@group(0) @binding(7) var IDS_SAMPLER: sampler;
@group(0) @binding(8) var DEPTH_TEXTURE: texture_depth_2d;
@group(0) @binding(9) var DEPTH_SAMPLER: sampler;

@fragment
fn main(
  @location(0) FragUV: vec2<f32>
) -> @location(0) vec4<f32> {
  var outputColor = textureSample(SOURCE_TEXTURE, SOURCE_SAMPLER, FragUV);
  var normal = textureSample(NORMALS_TEXTURE, NORMALS_SAMPLER, FragUV);
  var id = textureSample(IDS_TEXTURE, IDS_SAMPLER, FragUV);
  var depth = textureSample(DEPTH_TEXTURE, DEPTH_SAMPLER, FragUV);

  if (PARAMS.ENABLED == 0.0)
  {
    return outputColor;
  }

  var pixelCoord = FragUV;

  if (PARAMS.PIXELATION_ENABLED == 1.0 && id.r == -1.0)
  {
    pixelCoord.x = floor(FragUV.x * PARAMS.PIXELATION_WIDTH) / PARAMS.PIXELATION_WIDTH;
    pixelCoord.y = floor(FragUV.y * PARAMS.PIXELATION_HEIGHT) / PARAMS.PIXELATION_HEIGHT;
  }

  outputColor = textureSample(SOURCE_TEXTURE, SOURCE_SAMPLER, pixelCoord);

  if (PARAMS.COLOR_ENABLED == 1.0 && id.g == -1.0)
  {
    outputColor = floor(outputColor * PARAMS.COLOR_PRECISION) / PARAMS.COLOR_PRECISION;
  }

  if (PARAMS.DITHER_ENABLED == 1.0 && id.b == -1.0)
  {
    var brightness = GetPixelBrightness(outputColor.rgb);
    var ditherPattern = GetDitherPattern(PARAMS.DITHER_PATTERN_INDEX);
    var ditherX = u32((FragUV.x * SIZE.x) / PARAMS.DITHER_SCALE_X);
    var ditherY = u32((FragUV.y * SIZE.y) / PARAMS.DITHER_SCALE_Y);
    var ditherPixel = GetDitherValue(ditherX, ditherY, brightness, ditherPattern);
    outputColor = outputColor * ditherPixel;
  }

  if (PARAMS.OUTLINE_ENABLED == 1.0)
  {
    var t = PARAMS.OUTLINE_THICKNESS * (1.0 - depth);
    var idDiff = 0.0;

    idDiff += distance(id, getIdValue(FragUV, vec2<f32>( t,  0)));
    idDiff += distance(id, getIdValue(FragUV, vec2<f32>( 0,  t)));
    idDiff += distance(id, getIdValue(FragUV, vec2<f32>( 0,  t)));
    idDiff += distance(id, getIdValue(FragUV, vec2<f32>( 0, -t)));
    idDiff += distance(id, getIdValue(FragUV, vec2<f32>( t,  t)));
    idDiff += distance(id, getIdValue(FragUV, vec2<f32>( t, -t)));
    idDiff += distance(id, getIdValue(FragUV, vec2<f32>(-t,  t)));
    idDiff += distance(id, getIdValue(FragUV, vec2<f32>(-t, -t)));

    if (idDiff != 0.0 && id.a == -1)
    {
      idDiff = 1.0;
      var outline = clamp(idDiff, 0, 1);
      outputColor = mix(outputColor, vec4<f32>(PARAMS.OUTLINE_R, PARAMS.OUTLINE_G, PARAMS.OUTLINE_B, 1.0), outline);  
    }
  }

  return outputColor;
}

// *****************************************************************************************************************
// GET TEXEL VALUE
// *****************************************************************************************************************
fn getTexelValue(textureUV: vec2<f32>, offset: vec2<f32>) -> vec4<f32>
{
  var ps = vec2<f32>(1.0 / SIZE.x, 1.0 / SIZE.y);
  return textureSample(SOURCE_TEXTURE, SOURCE_SAMPLER, textureUV + ps * offset);
}

// *****************************************************************************************************************
// GET NORMAL VALUE
// *****************************************************************************************************************
fn getNormalValue(textureUV: vec2<f32>, offset: vec2<f32>) -> vec4<f32>
{
  var ps = vec2<f32>(1.0 / SIZE.x, 1.0 / SIZE.y);
  return textureSampleBaseClampToEdge(NORMALS_TEXTURE, NORMALS_SAMPLER, textureUV + ps * offset);
}

// *****************************************************************************************************************
// GET ID VALUE
// *****************************************************************************************************************
fn getIdValue(textureUV: vec2<f32>, offset: vec2<f32>) -> vec4<f32>
{
  var ps = vec2<f32>(1.0 / SIZE.x, 1.0 / SIZE.y);
  return textureSampleBaseClampToEdge(IDS_TEXTURE, IDS_SAMPLER, textureUV + ps * offset);
}

// *****************************************************************************************************************
// GET DEPTH VALUE
// *****************************************************************************************************************
fn getDepthValue(textureUV: vec2<f32>, offset: vec2<f32>) -> f32
{
  var ps = vec2<f32>(1.0 / SIZE.x, 1.0 / SIZE.y);
  return textureSample(DEPTH_TEXTURE, DEPTH_SAMPLER, textureUV + ps * offset);
}

// *****************************************************************************************************************
// GET DITHER PATTERN
// *****************************************************************************************************************
fn GetDitherPattern(index: f32) -> mat4x4<f32>
{
  var pattern = mat4x4<f32>();

  if (index == 0)
  {
    pattern = mat4x4<f32>(
      0, 1, 0, 1,
      1, 0, 1, 0,
      0, 1, 0, 1,
      1, 0, 1, 0 
    );
  }         
  else if (index == 1)
  {
    pattern = mat4x4<f32>(
      0.23, 0.2, 0.6, 0.2,
      0.2, 0.43, 0.2, 0.77,
      0.88, 0.2, 0.87, 0.2,
      0.2, 0.46, 0.2, 0
    );
  }           
  else if (index == 2)
  {
    pattern = mat4x4<f32>(
      -4.0, 0.0, -3.0, 1.0,
      2.0, -2.0, 3.0, -1.0,
      -3.0, 1.0, -4.0, 0.0,
      3.0, -1.0, 2.0, -2.0
    );
  }       
  else if (index == 3)
  {
    pattern = mat4x4<f32>(
      1, 0, 0, 1,
      0, 1, 1, 0,
      0, 1, 1, 0,
      1, 0, 0, 1 
    );
  }
  else 
  {
    pattern = mat4x4<f32>(
      1, 1, 1, 1,
      1, 1, 1, 1,
      1, 1, 1, 1,
      1, 1, 1, 1
    );
  }
  
  return pattern;
}

// *****************************************************************************************************************
// GET DITHER VALUE
// *****************************************************************************************************************
fn GetDitherValue(x: u32, y: u32, brightness: f32, pattern: mat4x4<f32>) -> f32
{
  if ((brightness * PARAMS.DITHER_THRESHOLD) < pattern[x % 4][y % 4]) 
  {
    return 0;
  }
  else
  {
    return 1;
  }
}

// *****************************************************************************************************************
// GET PIXEL BRIGHTNESS
// *****************************************************************************************************************
fn GetPixelBrightness(color: vec3<f32>) -> f32
{
  return color.r + color.g + color.b / 3.0;
}`;class We extends j{device;vertexBuffer;grp0;params;size;sourceTexture;normalsTexture;idsTexture;depthTexture;constructor(){super("PPE_PIPELINE",yt,Ye,wt),this.device=v.getDevice(),this.vertexBuffer=this.device.createBuffer({size:6*Bt*4,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC}),this.grp0=v.createStaticGroup("PPE_PIPELINE",0),this.params=this.grp0.setFloat(0,"PARAMS",16),this.params[0]=1,this.params[1]=0,this.params[2]=400,this.params[3]=400,this.params[4]=0,this.params[5]=32,this.params[6]=0,this.params[7]=0,this.params[8]=1,this.params[9]=1,this.params[10]=1,this.params[11]=0,this.params[12]=120,this.params[13]=0,this.params[14]=0,this.params[15]=0,this.size=this.grp0.setFloat(1,"SIZE",2),this.size[0]=v.getWidth(),this.size[1]=v.getHeight(),this.sourceTexture=this.grp0.setTexture(2,"SOURCE_TEXTURE",v.createRenderingTexture()),this.sourceTexture=this.grp0.setSampler(3,"SOURCE_SAMPLER",this.sourceTexture),this.normalsTexture=this.grp0.setTexture(4,"NORMALS_TEXTURE",v.getNormalsTexture()),this.normalsTexture=this.grp0.setSampler(5,"NORMALS_SAMPLER",this.normalsTexture),this.idsTexture=this.grp0.setTexture(6,"IDS_TEXTURE",v.getIdsTexture()),this.idsTexture=this.grp0.setSampler(7,"IDS_SAMPLER",this.idsTexture),this.depthTexture=this.grp0.setTexture(8,"DEPTH_TEXTURE",v.getDepthTexture()),this.depthTexture=this.grp0.setSampler(9,"DEPTH_SAMPLER",this.depthTexture),this.grp0.allocate(),this.device.queue.writeBuffer(this.vertexBuffer,0,new Float32Array([-1,1,0,0,1,1,1,0,-1,-1,0,1,-1,-1,0,1,1,1,1,0,1,-1,1,1])),D.subscribe(St,"E_RESIZE",this,this.$handleWindowResize)}render(t){const s=v.getCommandEncoder().beginRenderPass({colorAttachments:[{view:t.createView(),loadOp:"clear",storeOp:"store"}]});s.setPipeline(this.pipeline),this.grp0.beginWrite(),this.grp0.write(0,this.params),this.grp0.write(1,this.size),this.grp0.endWrite(),s.setBindGroup(0,this.grp0.getBindGroup()),s.setVertexBuffer(0,this.vertexBuffer),s.draw(6),s.end()}loadPipeline(t,e){v.deletePipeline("PPE_PIPELINE"),this.pipeline=v.loadPipeline("PPE_PIPELINE",yt,t,wt),this.grp0=v.createStaticGroup("PPE_PIPELINE",0),this.params=this.grp0.setFloat(0,"PARAMS",e.length);for(let s=0;s<e.length;s++)this.params[s]=e[s];this.size=this.grp0.setFloat(1,"SIZE",2),this.size[0]=v.getWidth(),this.size[1]=v.getHeight(),this.sourceTexture=this.grp0.setTexture(2,"SOURCE_TEXTURE",v.createRenderingTexture()),this.sourceTexture=this.grp0.setSampler(3,"SOURCE_SAMPLER",this.sourceTexture),this.normalsTexture=this.grp0.setTexture(4,"NORMALS_TEXTURE",v.getNormalsTexture()),this.normalsTexture=this.grp0.setSampler(5,"NORMALS_SAMPLER",this.normalsTexture),this.idsTexture=this.grp0.setTexture(6,"IDS_TEXTURE",v.getIdsTexture()),this.idsTexture=this.grp0.setSampler(7,"IDS_SAMPLER",this.idsTexture),this.depthTexture=this.grp0.setTexture(8,"DEPTH_TEXTURE",v.getDepthTexture()),this.depthTexture=this.grp0.setSampler(9,"DEPTH_SAMPLER",this.depthTexture),this.grp0.allocate()}setParam(t,e){this.params[t]=e}getParam(t){return this.params[t]}getSourceTexture(){return this.sourceTexture.gpuTexture}$handleWindowResize(){this.size[0]=v.getWidth(),this.size[1]=v.getHeight(),this.sourceTexture.gpuTexture.destroy(),this.sourceTexture=this.grp0.setTexture(2,"SOURCE_TEXTURE",v.createRenderingTexture()),this.normalsTexture=this.grp0.setTexture(4,"NORMALS_TEXTURE",v.getNormalsTexture()),this.idsTexture=this.grp0.setTexture(6,"IDS_TEXTURE",v.getIdsTexture()),this.depthTexture=this.grp0.setTexture(8,"DEPTH_TEXTURE",v.getDepthTexture()),this.grp0.allocate()}}new We;class Ze{blocking;constructor(){this.blocking=!1}setBlocking(t){this.blocking=t}isBlocking(){return this.blocking}update(t){}draw(){}async onEnter(t){}onExit(){}onBringToFront(t){}onBringToBack(t){}}const Z=new Map;Z.set("0","0");Z.set("1","1");Z.set("BtnSelect","8");Z.set("PadTop","12");Z.set("PadBottom","13");Z.set("PadLeft","14");Z.set("PadRight","15");class qe{keymap;actionmap;actionRegister;pads;padsInterval;mouseDown;mousePosition;mouseWheel;dragStartPosition;constructor(){this.keymap=new Map,this.actionmap=new Map,this.actionRegister=[],this.pads=[],this.padsInterval,this.mouseDown=!1,this.mousePosition=[0,0],this.mouseWheel=0,this.dragStartPosition=[0,0],document.addEventListener("keydown",t=>this.$handleKeyDown(t)),document.addEventListener("keyup",t=>this.$handleKeyUp(t)),this.registerAction("keyboard","Enter","OK"),this.registerAction("keyboard","Escape","BACK"),this.registerAction("keyboard"," ","SELECT"),this.registerAction("keyboard","ArrowLeft","LEFT"),this.registerAction("keyboard","ArrowRight","RIGHT"),this.registerAction("keyboard","ArrowUp","UP"),this.registerAction("keyboard","ArrowDown","DOWN"),this.registerAction("gamepad0","0","OK"),this.registerAction("gamepad0","1","BACK"),this.registerAction("gamepad0","BtnSelect","SELECT"),this.registerAction("gamepad0","PadLeft","LEFT"),this.registerAction("gamepad0","PadRight","RIGHT"),this.registerAction("gamepad0","PadTop","UP"),this.registerAction("gamepad0","PadBottom","DOWN")}registerAction(t,e,s){this.actionRegister.find(r=>r.inputSource==t&&r.eventKey==e&&r.id==s)||this.actionRegister.push({id:s,inputSource:t,eventKey:t.startsWith("gamepad")?Z.get(e):e})}unregisterAction(t,e,s){const i=this.actionRegister.findIndex(r=>r.inputSource==t&&r.eventKey==e&&r.id==s);if(i==-1)throw new Error("InputManager::unregisterAction(): action not found !");this.actionRegister.splice(i,1)}findActionIds(t,e){const s=[];for(const i of this.actionRegister)i.inputSource==t&&i.eventKey==e&&s.push(i.id);return s}isActiveAction(t){return this.actionmap.get(t)}isActiveKey(t){return this.keymap.get(t)}isMouseDown(){return this.mouseDown}getMousePosition(){return this.mousePosition}getMouseWheel(){return this.mouseWheel}getDragDelta(){return this.mouseDown?[this.mousePosition[0]-this.dragStartPosition[0],this.mousePosition[1]-this.dragStartPosition[1]]:[0,0]}getPad(t){return this.pads.find(e=>e.index==t)}removePad(t){this.pads=this.pads.filter(e=>e.id!=t),this.pads.length<=0&&(clearInterval(this.padsInterval),this.padsInterval=void 0)}$addPad(t){this.pads.push(t),this.padsInterval===null&&(this.padsInterval=setInterval(()=>this.$updatePadsStatus(),50))}$handleKeyDown(t){return this.keymap.set(t.key,!0),!1}$handleKeyUp(t){this.keymap.set(t.key,!1)}$handlePointerDown(t){this.mouseDown=!0,this.dragStartPosition[0]=t.clientX,this.dragStartPosition[1]=t.clientY,D.emit(this,"E_MOUSE_DOWN",{buttons:t.buttons})}$handlePointerUp(){this.mouseDown=!1,this.dragStartPosition[0]=0,this.dragStartPosition[1]=0,D.emit(this,"E_MOUSE_UP")}$handlePointerMove(t){this.mouseDown=t.pointerType=="mouse"?(t.buttons&1)!==0:!0,this.mousePosition=[t.clientX,t.clientY],D.emit(this,"E_MOUSE_MOVE",{movementX:t.movementX,movementY:t.movementY}),this.mouseDown&&D.emit(this,"E_MOUSE_DRAG",{movementX:t.movementX,movementY:t.movementY})}$handleWheel(t){this.mouseDown=(t.buttons&1)!==0,this.mouseWheel+=Math.sign(t.deltaY),t.preventDefault(),t.stopPropagation(),D.emit(this,"E_MOUSE_WHEEL",{delta:Math.sign(t.deltaY)})}$handleGamePadDisconnected(t){this.removePad(t.gamepad.id)}$handleGamePadConnected(t){const e={index:t.gamepad.index,id:t.gamepad.id,nButtons:t.gamepad.buttons.length,nAxes:t.gamepad.axes.length,axes:t.gamepad.axes,pressed:[]};for(let s=0;s<t.gamepad.buttons.length;s++)e.pressed[s]=t.gamepad.buttons[s].pressed;this.$addPad(e)}$updatePadsStatus(){const t=window.navigator,e=t.getGamepads?t.getGamepads():t.webkitGetGamepads?t.webkitGetGamepads():[];for(const s of e){if(!s)continue;const i=this.getPad(s.index);if(i!=null){for(let r=0;r<s.buttons.length;r++)if(s.buttons[r].pressed!=i.pressed[r]){for(const n of this.findActionIds("gamepad"+s.index,r.toString()))this.actionmap.set(n,s.buttons[r].pressed),s.buttons[r].pressed&&D.emit(this,"E_ACTION",{actionId:n});this.keymap.set("gamepad"+s.index+"-"+r,s.buttons[r].pressed),i.pressed[r]=s.buttons[r].pressed}}}}}const Q=new qe;class je{textures;constructor(){this.textures=new Map}async loadTexture(t,e={}){if(this.textures.has(t))return this.textures.get(t);const i=await(await fetch(t)).blob(),r=await createImageBitmap(i),n=v.createTextureFromBitmap(r,!1,e);return this.textures.set(t,n),n}async loadTexture8bit(t,e={}){if(this.textures.has(t))return this.textures.get(t);const i=await(await fetch(t)).blob(),r=await createImageBitmap(i),n=v.createTextureFromBitmap(r,!0,e);return this.textures.set(t,n),n}async loadCubemapTexture(t,e){if(this.textures.has(t))return this.textures.get(t);const s=["right","left","top","bottom","front","back"],i=[];for(const n of s){const h=await(await fetch(t+n+"."+e)).blob(),o=await createImageBitmap(h);i.push(o)}const r=v.createCubeMapFromBitmap(i);return this.textures.set(t,r),r}deleteTexture(t){if(!this.textures.has(t))throw new Error("Gfx3TextureManager::deleteTexture(): The texture file doesn't exist, cannot delete !");this.textures.get(t).gpuTexture.destroy(),this.textures.delete(t)}getTexture(t){if(!this.textures.has(t))throw new Error("Gfx2TextureManager::getTexture(): The texture file doesn't exist, cannot get !");return this.textures.get(t)}hasTexture(t){return this.textures.has(t)}releaseTextures(){for(const t of this.textures.keys())this.textures.get(t).gpuTexture.destroy(),this.textures.delete(t)}}const V=new je,Y=1e-16;class x{w;x;y;z;constructor(t=1,e=0,s=0,i=0){this.w=t,this.x=e,this.y=s,this.z=i}static ZERO=new x(0,0,0,0);static ONE=new x(1,0,0,0);static createNormalized(t,e,s,i){let r=1/Math.sqrt(t*t+e*e+s*s+i*i);return new x(t*r,e*r,s*r,i*r)}static createRandom(){let t=Math.random(),e=Math.random(),s=Math.random(),i=Math.sqrt(1-t),r=Math.sqrt(t);return new x(r*Math.cos(2*Math.PI*s),i*Math.sin(2*Math.PI*e),i*Math.cos(2*Math.PI*e),r*Math.sin(2*Math.PI*s))}static createFromBetweenVectors(t,e){let s=t[0],i=t[1],r=t[2],n=e[0],a=e[1],h=e[2],o=Math.sqrt(s*s+i*i+r*r),l=Math.sqrt(n*n+a*a+h*h);o>0&&(s/=o,i/=o,r/=o),l>0&&(n/=l,a/=l,h/=l);let f=s*n+i*a+r*h;if(f>=1-Y)return x.ONE;if(1+f<=Y)return Math.abs(s)>Math.abs(r)?x.createNormalized(0,-i,s,0):x.createNormalized(0,0,-r,i);let p=i*h-r*a,g=r*n-s*h,E=s*a-i*n;return x.createNormalized(1+f,p,g,E)}static createFromAxisAngle(t,e){let s=t[0],i=t[1],r=t[2],n=e*.5,a=Math.sin(n),h=Math.cos(n),o=a/Math.sqrt(s*s+i*i+r*r);return new x(h,s*o,i*o,r*o)}static createFromEuler(t,e,s,i){let r=t*.5,n=e*.5,a=s*.5,h=Math.cos(r),o=Math.cos(n),l=Math.cos(a),f=Math.sin(r),p=Math.sin(n),g=Math.sin(a);return i===void 0||i==="ZXY"?new x(h*o*l-f*p*g,p*h*l-f*g*o,f*p*l+g*h*o,f*o*l+p*g*h):i==="XYZ"||i==="RPY"?new x(h*o*l-f*p*g,f*o*l+p*g*h,p*h*l-f*g*o,f*p*l+g*h*o):i==="YXZ"?new x(f*p*g+h*o*l,f*g*o+p*h*l,f*o*l-p*g*h,g*h*o-f*p*l):i==="ZYX"||i==="YPR"?new x(f*p*g+h*o*l,g*h*o-f*p*l,f*g*o+p*h*l,f*o*l-p*g*h):i==="YZX"?new x(h*o*l-f*p*g,f*p*l+g*h*o,f*o*l+p*g*h,p*h*l-f*g*o):i==="XZY"?new x(f*p*g+h*o*l,f*o*l-p*g*h,g*h*o-f*p*l,f*g*o+p*h*l):i==="ZYZ"?new x(h*o*l-f*g*o,p*g*h-f*p*l,f*p*g+p*h*l,f*o*l+g*h*o):i==="ZXZ"?new x(h*o*l-f*g*o,f*p*g+p*h*l,f*p*l-p*g*h,f*o*l+g*h*o):i==="YXY"?new x(h*o*l-f*g*o,f*p*g+p*h*l,f*o*l+g*h*o,p*g*h-f*p*l):i==="YZY"?new x(h*o*l-f*g*o,f*p*l-p*g*h,f*o*l+g*h*o,f*p*g+p*h*l):i==="XYX"?new x(h*o*l-f*g*o,f*o*l+g*h*o,f*p*g+p*h*l,f*p*l-p*g*h):i==="XZX"?new x(h*o*l-f*g*o,f*o*l+g*h*o,p*g*h-f*p*l,f*p*g+p*h*l):new x}static createFromMatrix(t){let e=t[0],s=t[1],i=t[2],r=t[3],n=t[4],a=t[5],h=t[6],o=t[7],l=t[8],f=e+n+l;return f>0?x.createNormalized(f+1,o-a,i-h,r-s):e>n&&e>l?x.createNormalized(o-a,1+e-n-l,s+r,i+h):n>l?x.createNormalized(i-h,s+r,1+n-e-l,a+o):x.createNormalized(r-s,i+h,a+o,1+l-e-n)}static createFromLookAt(t,e=c.VEC3_UP){const s=c.VEC3_NORMALIZE([-t[0],-t[1],-t[2]]),i=c.VEC3_CROSS(e,s),r=c.VEC3_CROSS(s,i);return x.createFromMatrix([i[0],i[1],i[2],r[0],r[1],r[2],s[0],s[1],s[2]])}rotateX(t){t*=.5;let e=Math.sin(t),s=Math.cos(t);return new x(this.w*s-this.x*e,this.x*s+this.w*e,this.y*s+this.z*e,this.z*s-this.y*e)}rotateY(t){t*=.5;let e=Math.sin(t),s=Math.cos(t);return new x(this.w*s-this.y*e,this.x*s-this.z*e,this.y*s+this.w*e,this.z*s+this.x*e)}rotateZ(t){t*=.5;let e=Math.sin(t),s=Math.cos(t);return new x(this.w*s-this.z*e,this.x*s+this.y*e,this.y*s-this.x*e,this.z*s+this.w*e)}add(t,e,s,i){return new x(this.w+t,this.x+e,this.y+s,this.z+i)}sub(t,e,s,i){return new x(this.w-t,this.x-e,this.y-s,this.z-i)}neg(){return new x(-this.w,-this.x,-this.y,-this.z)}norm(){return Math.sqrt(this.w*this.w+this.x*this.x+this.y*this.y+this.z*this.z)}normSq(){return this.w*this.w+this.x*this.x+this.y*this.y+this.z*this.z}normalize(){let t=Math.sqrt(this.w*this.w+this.x*this.x+this.y*this.y+this.z*this.z);return t<Y?x.ZERO:(t=1/t,new x(this.w*t,this.x*t,this.y*t,this.z*t))}mul(t,e,s,i){return new x(this.w*t-this.x*e-this.y*s-this.z*i,this.w*e+this.x*t+this.y*i-this.z*s,this.w*s+this.y*t+this.z*e-this.x*i,this.w*i+this.z*t+this.x*s-this.y*e)}scale(t){return new x(this.w*t,this.x*t,this.y*t,this.z*t)}dot(t,e,s,i){return this.w*t+this.x*e+this.y*s+this.z*i}inverse(){let t=this.w*this.w+this.x*this.x+this.y*this.y+this.z*this.z;return t===0?x.ZERO:(t=1/t,new x(this.w*t,-this.x*t,-this.y*t,-this.z*t))}div(t,e,s,i){var r=t*t+e*e+s*s+i*i;return r===0?x.ZERO:(r=1/r,new x((this.w*t+this.x*e+this.y*s+this.z*i)*r,(this.x*t-this.w*e-this.y*i+this.z*s)*r,(this.y*t-this.w*s-this.z*e+this.x*i)*r,(this.z*t-this.w*i-this.x*s+this.y*e)*r))}conjugate(){return new x(this.w,-this.x,-this.y,-this.z)}exp(){let t=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z),e=Math.exp(this.w),s=e*Math.sin(t)/t;return t===0?new x(e,0,0,0):new x(e*Math.cos(t),this.x*s,this.y*s,this.z*s)}log(){if(this.y===0&&this.z===0)return new x($e(this.w,this.x),Math.atan2(this.x,this.w),0,0);let t=this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w,e=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z),s=Math.atan2(e,this.w)/e;return new x(Math.log(t)*.5,this.x*s,this.y*s,this.z*s)}equals(t,e,s,i){return Math.abs(t-this.w)<Y&&Math.abs(e-this.x)<Y&&Math.abs(s-this.y)<Y&&Math.abs(i-this.z)<Y}isFinite(){return isFinite(this.w)&&isFinite(this.x)&&isFinite(this.y)&&isFinite(this.z)}isNaN(){return isNaN(this.w)||isNaN(this.x)||isNaN(this.y)||isNaN(this.z)}real(){return this.w}imag(){return[this.x,this.y,this.z]}toVector(){return[this.w,this.x,this.y,this.z]}toMatrix(){let t=this.w*this.x,e=this.w*this.y,s=this.w*this.z,i=this.x*this.x,r=this.x*this.y,n=this.x*this.z,a=this.y*this.y,h=this.y*this.z,o=this.z*this.z;return[1-2*(a+o),2*(r-s),2*(n+e),2*(r+s),1-2*(i+o),2*(h-t),2*(n-e),2*(h+t),1-2*(i+a)]}toMatrix4(){var t=this.w*this.x,e=this.w*this.y,s=this.w*this.z,i=this.x*this.x,r=this.x*this.y,n=this.x*this.z,a=this.y*this.y,h=this.y*this.z,o=this.z*this.z;return[1-2*(a+o),2*(r-s),2*(n+e),0,2*(r+s),1-2*(i+o),2*(h-t),0,2*(n-e),2*(h+t),1-2*(i+a),0,0,0,0,1]}toCSSTransform(){let t=2*Math.acos(this.w),e=1-this.w*this.w;return e<Y?(t=0,e=1):e=1/Math.sqrt(e),`rotate3d(${this.x*e}, ${this.y*e}, ${this.z*e}, ${t}rad)`}toAxisAngle(){let t=1-this.w*this.w;if(t<Y)return[[this.x,this.y,this.z],0];let e=1/Math.sqrt(t),s=2*Math.acos(this.w);return[[this.x*e,this.y*e,this.z*e],s]}clone(){return new x(this.w,this.x,this.y,this.z)}rotateVector(t){var e=2*(this.y*t[2]-this.z*t[1]),s=2*(this.z*t[0]-this.x*t[2]),i=2*(this.x*t[1]-this.y*t[0]);return[t[0]+this.w*e+this.y*i-this.z*s,t[1]+this.w*s+this.z*e-this.x*i,t[2]+this.w*i+this.x*s-this.y*e]}slerp(t,e,s,i){let r=this.w,n=this.x,a=this.y,h=this.z;var o=r*t+n*e+a*s+h*i;if(o<0&&(r=-r,n=-n,a=-a,h=-h,o=-o),o>=1-Y)return function(p){return x.createNormalized(r+p*(t-r),n+p*(e-n),a+p*(s-a),h+p*(i-h))};var l=Math.acos(o),f=Math.sin(l);return function(p){let g=l*p,E=Math.sin(g),M=Math.cos(g)-o*E/f,m=E/f;return new x(M*r+m*t,M*n+m*e,M*a+m*s,M*h+m*i)}}}function $e(u,t){var e=Math.abs(u),s=Math.abs(t);return u===0?Math.log(s):t===0?Math.log(e):e<3e3&&s<3e3?.5*Math.log(u*u+t*t):(u=u/2,t=t/2,.5*Math.log(u*u+t*t)+Math.LN2)}class Ut{position;rotation;scale;quaternion;transformMatrix;constructor(){this.position=[0,0,0],this.rotation=[0,0,0],this.scale=[1,1,1],this.quaternion=new x,this.transformMatrix=c.MAT4_IDENTITY()}getPosition(){return this.position}getPositionX(){return this.position[0]}getPositionY(){return this.position[1]}getPositionZ(){return this.position[2]}setPosition(t,e,s){this.position[0]=t,this.position[1]=e,this.position[2]=s}translate(t,e,s){this.position[0]+=t,this.position[1]+=e,this.position[2]+=s}getRotation(){return this.rotation}getRotationX(){return this.rotation[0]}getRotationY(){return this.rotation[1]}getRotationZ(){return this.rotation[2]}setRotation(t,e,s){this.rotation[0]=t,this.rotation[1]=e,this.rotation[2]=s}rotate(t,e,s){this.rotation[0]+=t,this.rotation[1]+=e,this.rotation[2]+=s}setQuaternion(t){this.quaternion=t.clone()}getQuaternion(){return this.quaternion}getScale(){return this.scale}getScaleX(){return this.scale[0]}getScaleY(){return this.scale[1]}getScaleZ(){return this.scale[2]}setScale(t,e,s){this.scale[0]=t,this.scale[1]=e,this.scale[2]=s}zoom(t,e,s){this.scale[0]+=t,this.scale[1]+=e,this.scale[2]+=s}getTransformMatrix(){return c.MAT4_TRANSFORM(this.position,this.rotation,this.scale,this.quaternion,this.transformMatrix),this.transformMatrix}lookAt(t,e,s,i=[0,1,0]){c.MAT4_LOOKAT(this.position,[t,e,s],i,this.transformMatrix),c.MAT4_MULTIPLY(this.transformMatrix,c.MAT4_SCALE(this.scale[0],this.scale[1],this.scale[2]),this.transformMatrix),this.rotation[0]=-Math.asin(e),this.rotation[1]=Math.atan2(t,s),this.rotation[2]=0}getAxies(){const t=this.getTransformMatrix();return[[t[0],t[1],t[2]],[t[4],t[5],t[6]],[t[8],t[9],t[10]]]}}class ke extends Ut{view;constructor(t){super(),this.view=v.getView(t)}setPosition(t,e,s){super.setPosition(t,e,s),this.view.setCameraMatrix(this.getTransformMatrix())}translate(t,e,s){super.translate(t,e,s),this.view.setCameraMatrix(this.getTransformMatrix())}setRotation(t,e,s){super.setRotation(t,e,s),this.view.setCameraMatrix(this.getTransformMatrix())}rotate(t,e,s){super.rotate(t,e,s),this.view.setCameraMatrix(this.getTransformMatrix())}setQuaternion(t){super.setQuaternion(t),this.view.setCameraMatrix(this.getTransformMatrix())}setScale(t,e,s){super.setScale(t,e,s),this.view.setCameraMatrix(this.getTransformMatrix())}zoom(t,e,s){super.zoom(t,e,s),this.view.setCameraMatrix(this.getTransformMatrix())}changeView(t){this.view=v.getView(t)}lookAt(t,e,s,i=[0,1,0]){super.lookAt(t,e,s,i),this.view.setCameraMatrix(this.transformMatrix)}getCameraMatrix(){return this.view.getCameraMatrix()}getAxies(){const t=this.view.getCameraMatrix();return[c.VEC3_CREATE(t[0],t[1],t[2]),c.VEC3_CREATE(t[4],t[5],t[6]),c.VEC3_CREATE(t[8],t[9],t[10])]}}class w{min;max;constructor(t=[0,0,0],e=[0,0,0]){this.min=t,this.max=e}static createFromCoord(t,e,s,i,r,n){const a=new w;return a.min[0]=t,a.min[1]=e,a.min[2]=s,a.max[0]=t+i,a.max[1]=e+r,a.max[2]=s+n,a}static createFromCenter(t,e,s,i,r,n){const a=new w;return a.min[0]=t-i*.5,a.min[1]=e-r*.5,a.min[2]=s-n*.5,a.max[0]=t+i*.5,a.max[1]=e+r*.5,a.max[2]=s+n*.5,a}static createFromVertices(t,e){const s=new w;return s.fromVertices(t,e),s}static merge(t){const e=[t[0].min[0],t[0].min[1],t[0].min[2]],s=[t[0].max[0],t[0].max[1],t[0].max[2]];for(const i of t)for(let r=0;r<3;r++)e[r]=Math.min(i.min[r],e[r]),s[r]=Math.max(i.max[r],s[r]);return new w(e,s)}fromVertices(t,e){const s=[t[0],t[1],t[2]],i=[t[0],t[1],t[2]];for(let r=0;r<t.length;r+=e)for(let n=0;n<3;n++){const a=t[r+n];s[n]=Math.min(a,s[n]),i[n]=Math.max(a,i[n])}this.min=s,this.max=i}merge(t){const e=[this.min[0],this.min[1],this.min[2]],s=[this.max[0],this.max[1],this.max[2]];for(let i=0;i<3;i++)e[i]=Math.min(t.min[i],e[i]),s[i]=Math.max(t.max[i],s[i]);return new w(e,s)}getCenter(){const t=(this.min[0]+this.max[0])*.5,e=(this.min[1]+this.max[1])*.5,s=(this.min[2]+this.max[2])*.5;return[t,e,s]}getSize(){const t=this.max[0]-this.min[0],e=this.max[1]-this.min[1],s=this.max[2]-this.min[2];return[t,e,s]}getRadius(){return c.VEC3_DISTANCE(this.min,this.max)*.5}getPerimeter(){const t=this.max[0]-this.min[0],e=this.max[2]-this.min[2];return t+t+e+e}getVolume(){const t=this.max[0]-this.min[0],e=this.max[1]-this.min[1],s=this.max[2]-this.min[2];return t*e*s}transform(t){const e=[];e.push([this.min[0],this.min[1],this.min[2]]),e.push([this.max[0],this.min[1],this.min[2]]),e.push([this.max[0],this.max[1],this.min[2]]),e.push([this.min[0],this.max[1],this.min[2]]),e.push([this.min[0],this.max[1],this.max[2]]),e.push([this.max[0],this.max[1],this.max[2]]),e.push([this.max[0],this.min[1],this.max[2]]),e.push([this.min[0],this.min[1],this.max[2]]);const s=e.map(n=>c.MAT4_MULTIPLY_BY_VEC4(t,[n[0],n[1],n[2],1])),i=[s[0][0],s[0][1],s[0][2]],r=[s[0][0],s[0][1],s[0][2]];for(let n=0;n<s.length;n++)for(let a=0;a<3;a++){const h=s[n][a];i[a]=Math.min(h,i[a]),r[a]=Math.max(h,r[a])}return new w(i,r)}splitVertical(){const t=this.getSize(),e=this.getCenter();return[w.createFromCoord(this.min[0],this.min[1],this.min[2],t[0]*.5,t[1],t[2]),w.createFromCoord(e[0],this.min[1],this.min[2],t[0]*.5,t[1],t[2])]}splitHorizontal(){const t=this.getSize(),e=this.getCenter();return[w.createFromCoord(this.min[0],this.min[1],this.min[2],t[0],t[1]*.5,t[2]),w.createFromCoord(this.min[0],e[1],this.min[2],t[0],t[1]*.5,t[2])]}splitDepth(){const t=this.getSize(),e=this.getCenter();return[w.createFromCoord(this.min[0],this.min[1],this.min[2],t[0],t[1],t[2]*.5),w.createFromCoord(this.min[0],this.min[1],e[2],t[0],t[1],t[2]*.5)]}isPointInside(t,e,s){return c.COLLIDE_POINT_TO_BOX([t,e,s],this.min,this.max)}intersectBoundingBox(t){return c.COLLIDE_BOX_TO_BOX(this.min,this.max,t.min,t.max)}reset(){this.min=[0,0,0],this.max=[0,0,0]}setMin(t){this.min=t}setMax(t){this.max=t}}class It extends Ut{id;vertexSubBuffer;vertices;vertexCount;vertexStride;boundingBox;constructor(t){super(),this.id=[0,0,0,1],this.vertexSubBuffer=v.createVertexBuffer(0),this.vertices=[],this.vertexCount=0,this.vertexStride=t,this.boundingBox=new w}delete(){v.destroyVertexBuffer(this.vertexSubBuffer)}update(t){}draw(){}beginVertices(t){v.destroyVertexBuffer(this.vertexSubBuffer),this.vertexSubBuffer=v.createVertexBuffer(t*this.vertexStride*4),this.vertices=[],this.vertexCount=t}defineVertex(...t){this.vertices.push(...t)}setVertices(t){this.vertices=t}endVertices(){v.writeVertexBuffer(this.vertexSubBuffer,this.vertices)}getVertexSubBufferOffset(){return this.vertexSubBuffer.offset}getVertexSubBufferSize(){return this.vertexSubBuffer.vertices.byteLength}getVertices(){return this.vertices}getVertexCount(){return this.vertexCount}setId(t,e,s,i){this.id=[t,e,s,i]}getId(){return this.id}getStringId(){return""+this.id[0]+this.id[1]+this.id[2]+this.id[3]}setBoundingBox(t){this.boundingBox=t}getBoundingBox(){return this.boundingBox}getWorldBoundingBox(){return this.boundingBox.transform(this.getTransformMatrix())}clone(t=new It(this.vertexStride),e=c.MAT4_IDENTITY()){t.position=[this.position[0],this.position[1],this.position[2]],t.rotation=[this.rotation[0],this.rotation[1],this.rotation[2]],t.scale=[this.scale[0],this.scale[1],this.scale[2]],t.quaternion=new x(this.quaternion.w,this.quaternion.x,this.quaternion.y,this.quaternion.z),t.boundingBox=new w(this.boundingBox.min,this.boundingBox.max),t.beginVertices(this.vertexCount);for(let s=0;s<this.vertices.length;s+=this.vertexStride){const i=c.MAT4_MULTIPLY_BY_VEC4(e,[this.vertices[s+0],this.vertices[s+1],this.vertices[s+2],1]);t.defineVertex(i[0],i[1],i[2],...this.vertices.slice(3,this.vertexStride))}return t.endVertices(),t}}class lt{animations;currentAnimation;currentAnimationFrameIndex;looped;frameProgress;dataChanged;texturesChanged;textureScrollAngle;textureScrollRate;displacementMapScrollAngle;displacementMapScrollRate;grp2;colors;params;uvs;grp3;texture;displacementMap;diffuseMap;specularMap;emissiveMap;normalMap;envMap;constructor(t){this.animations=t.animations??[],this.currentAnimation=null,this.currentAnimationFrameIndex=0,this.looped=!1,this.frameProgress=0,this.dataChanged=!0,this.texturesChanged=!1,this.textureScrollAngle=t.textureScrollAngle??0,this.textureScrollRate=t.textureScrollRate??0,this.displacementMapScrollAngle=t.displacementMapScrollAngle??0,this.displacementMapScrollRate=t.displacementMapScrollRate??0,this.grp2=v.createStaticGroup("MESH_PIPELINE",2),this.colors=this.grp2.setFloat(0,"MAT_COLORS",16),this.colors[0]=t.emissive?t.emissive[0]:0,this.colors[1]=t.emissive?t.emissive[1]:0,this.colors[2]=t.emissive?t.emissive[2]:0,this.colors[3]=0,this.colors[4]=t.ambient?t.ambient[0]:.5,this.colors[5]=t.ambient?t.ambient[1]:.5,this.colors[6]=t.ambient?t.ambient[2]:.5,this.colors[7]=0,this.colors[8]=t.diffuse?t.diffuse[0]:1,this.colors[9]=t.diffuse?t.diffuse[1]:1,this.colors[10]=t.diffuse?t.diffuse[2]:1,this.colors[11]=0,this.colors[12]=t.specular?t.specular[0]:0,this.colors[13]=t.specular?t.specular[1]:0,this.colors[14]=t.specular?t.specular[2]:0,this.colors[15]=0,this.params=this.grp2.setFloat(1,"MAT_PARAMS",15),this.params[0]=t.opacity??1,this.params[1]=t.normalIntensity??1,this.params[2]=t.lightning?1:0,this.params[3]=t.texture?1:0,this.params[4]=t.displacementMap?1:0,this.params[5]=t.displacementMapFactor??0,this.params[6]=t.diffuseMap?1:0,this.params[7]=t.specularMap?1:0,this.params[8]=t.emissiveMap?1:0,this.params[9]=t.normalMap?1:0,this.params[10]=t.envMap?1:0,this.params[11]=t.decalEnabled?1:0,this.params[12]=t.shadowEnabled?1:0,this.params[13]=t.shininess??0,this.params[14]=t.emissiveFactor??1,this.uvs=this.grp2.setFloat(2,"MAT_UVS",6),this.grp3=v.createStaticGroup("MESH_PIPELINE",3),this.texture=this.grp3.setTexture(0,"MAT_TEXTURE",t.texture??v.createTextureFromBitmap()),this.texture=this.grp3.setSampler(1,"MAT_SAMPLER",this.texture),this.displacementMap=this.grp3.setTexture(2,"MAT_DISPLACEMENT_TEXTURE",t.displacementMap??v.createTextureFromBitmap()),this.displacementMap=this.grp3.setSampler(3,"MAT_DISPLACEMENT_SAMPLER",this.displacementMap),this.diffuseMap=this.grp3.setTexture(4,"MAT_DIFFUSE_TEXTURE",t.diffuseMap??v.createTextureFromBitmap()),this.diffuseMap=this.grp3.setSampler(5,"MAT_DIFFUSE_SAMPLER",this.diffuseMap),this.specularMap=this.grp3.setTexture(6,"MAT_SPECULAR_TEXTURE",t.specularMap??v.createTextureFromBitmap()),this.specularMap=this.grp3.setSampler(7,"MAT_SPECULAR_SAMPLER",this.specularMap),this.emissiveMap=this.grp3.setTexture(8,"MAT_EMISSIVE_TEXTURE",t.emissiveMap??v.createTextureFromBitmap()),this.emissiveMap=this.grp3.setSampler(9,"MAT_EMISSIVE_SAMPLER",this.emissiveMap),this.normalMap=this.grp3.setTexture(10,"MAT_NORM_TEXTURE",t.normalMap??v.createTextureFromBitmap()),this.normalMap=this.grp3.setSampler(11,"MAT_NORM_SAMPLER",this.normalMap),this.envMap=this.grp3.setTexture(12,"MAT_ENV_MAP_TEXTURE",t.envMap??v.createCubeMapFromBitmap(),{dimension:"cube"}),this.envMap=this.grp3.setSampler(13,"MAT_ENV_MAP_SAMPLER",this.envMap),this.grp2.allocate(),this.grp3.allocate()}static async createFromFile(t){const s=await(await fetch(t)).json();if(!s.hasOwnProperty("Ident")||s.Ident!="MAT")throw new Error("Gfx3Material::loadFromFile(): File not valid !");const i=new Array;for(const r of s.Animations){const n={name:r.Name,frames:[],frameDuration:parseInt(r.FrameDuration)};for(const a of r.Frames)n.frames.push({offsetX:a.OffsetX,offsetY:a.OffsetY});i.push(n)}return new lt({animations:i,opacity:s.Opacity,normalIntensity:s.NormalIntensity,lightning:s.Lightning,emissive:s.Emissive,ambient:s.Ambient,diffuse:s.Diffuse,specular:s.Specular,texture:s.Texture?await V.loadTexture(s.Texture):void 0,textureScrollAngle:s.TextureScrollAngle,textureScrollRate:s.TextureScrollRate,displacementMap:s.DisplacementMap?await V.loadTexture(s.DisplacementMap):void 0,displacementMapScrollAngle:s.DisplacementMapScrollAngle,displacementMapScrollRate:s.DisplacementMapScrollRate,displacementMapFactor:s.DisplacementMapFactor,diffuseMap:s.DiffuseMap?await V.loadTexture(s.DiffuseMap):void 0,specularMap:s.SpecularMap?await V.loadTexture(s.SpecularMap):void 0,emissiveMap:s.EmissiveMap?await V.loadTexture(s.EmissiveMap):void 0,normalMap:s.NormalMap?await V.loadTexture(s.NormalMap):void 0,envMap:s.EnvMap?await V.loadTexture(s.EnvMap):void 0,decalEnabled:s.DecalEnabled,shadowEnabled:s.ShadowEnabled,shininess:s.Shininess,emissiveFactor:s.EmissiveFactor})}delete(){this.grp2.delete(),this.grp3.delete()}update(t){if(this.textureScrollRate!=0&&(this.uvs[0]+=Math.cos(this.textureScrollAngle)*this.textureScrollRate*(t/1e3),this.uvs[1]+=Math.sin(this.textureScrollAngle)*this.textureScrollRate*(t/1e3),this.dataChanged=!0),this.displacementMapScrollRate!=0&&(this.uvs[4]+=Math.cos(this.displacementMapScrollAngle)*this.displacementMapScrollRate*(t/1e3),this.uvs[5]+=Math.sin(this.displacementMapScrollAngle)*this.displacementMapScrollRate*(t/1e3),this.dataChanged=!0),!this.currentAnimation)return;const e=this.currentAnimation.frames[this.currentAnimationFrameIndex];this.uvs[2]=e.offsetX/this.texture.gpuTexture.width,this.uvs[3]=e.offsetY/this.texture.gpuTexture.height,this.dataChanged=!0,this.frameProgress>=this.currentAnimation.frameDuration?this.currentAnimationFrameIndex==this.currentAnimation.frames.length-1?(D.emit(this,"E_FINISHED"),this.currentAnimationFrameIndex=this.looped?0:this.currentAnimation.frames.length-1,this.frameProgress=0):(this.currentAnimationFrameIndex=this.currentAnimationFrameIndex+1,this.frameProgress=0):this.frameProgress+=t}playAnimation(t,e=!1,s=!1){if(s&&this.currentAnimation&&t==this.currentAnimation.name)return;const i=this.animations.find(r=>r.name==t);if(!i)throw new Error("Gfx3Material::play: animation not found.");this.currentAnimation=i,this.currentAnimationFrameIndex=0,this.looped=e,this.frameProgress=0}resetAnimation(){this.currentAnimation=null,this.uvs[2]=0,this.uvs[3]=0,this.dataChanged=!0}setOpacity(t){this.params[0]=t,this.dataChanged=!0}setNormalIntensity(t){this.params[1]=t,this.dataChanged=!0}setLightning(t){this.params[2]=t?1:0,this.dataChanged=!0}setEmissive(t,e,s,i){this.colors[0]=t,this.colors[1]=e,this.colors[2]=s,this.colors[3]=i,this.dataChanged=!0}setAmbient(t,e,s){this.colors[4]=t,this.colors[5]=e,this.colors[6]=s,this.dataChanged=!0}setDiffuse(t,e,s){this.colors[8]=t,this.colors[9]=e,this.colors[10]=s,this.dataChanged=!0}setSpecular(t,e,s){this.colors[12]=t,this.colors[13]=e,this.colors[14]=s,this.dataChanged=!0}setSpecularity(t){this.colors[15]=t,this.dataChanged=!0}setTexture(t,e=0,s=0){this.texture=t,this.textureScrollAngle=e,this.textureScrollRate=s,this.params[3]=1,this.texturesChanged=!0,this.dataChanged=!0}setDisplacementMap(t,e=0,s=0,i=0){this.displacementMap=t,this.displacementMapScrollAngle=e,this.displacementMapScrollRate=s,this.params[4]=1,this.params[5]=i,this.texturesChanged=!0,this.dataChanged=!0}setDiffuseMap(t){this.diffuseMap=t,this.params[6]=1,this.texturesChanged=!0,this.dataChanged=!0}setSpecularMap(t){this.specularMap=t,this.params[7]=1,this.texturesChanged=!0,this.dataChanged=!0}setEmissiveMap(t){this.emissiveMap=t,this.params[8]=1,this.texturesChanged=!0,this.dataChanged=!0}setNormalMap(t){this.normalMap=t,this.params[9]=1,this.texturesChanged=!0,this.dataChanged=!0}setEnvMap(t){this.envMap=t,this.params[10]=1,this.texturesChanged=!0,this.dataChanged=!0}enableDecal(t){this.params[11]=t?1:0,this.dataChanged=!0}enableShadow(t){this.params[12]=t?1:0,this.dataChanged=!0}setShininess(t){this.params[13]=t,this.dataChanged=!0}setEmissiveFactor(t){this.params[14]=t,this.dataChanged=!0}getGroup02(){return this.dataChanged&&(this.grp2.beginWrite(),this.grp2.write(0,this.colors),this.grp2.write(1,this.params),this.grp2.write(2,this.uvs),this.grp2.endWrite(),this.dataChanged=!1),this.grp2}getGroup03(){return this.texturesChanged&&(this.grp3.setTexture(0,"MAT_TEXTURE",this.texture),this.grp3.setTexture(2,"MAT_DISPLACEMENT_TEXTURE",this.displacementMap),this.grp3.setTexture(4,"MAT_DIFFUSE_TEXTURE",this.diffuseMap),this.grp3.setTexture(6,"MAT_SPECULAR_TEXTURE",this.specularMap),this.grp3.setTexture(8,"MAT_EMISSIVE_TEXTURE",this.emissiveMap),this.grp3.setTexture(10,"MAT_NORM_TEXTURE",this.normalMap),this.grp3.setTexture(12,"MAT_ENV_MAP_TEXTURE",this.envMap,{dimension:"cube"}),this.grp3.allocate(),this.texturesChanged=!1),this.grp3}getTexture(){return this.texture}getDisplacementMap(){return this.displacementMap}getDiffuseMap(){return this.diffuseMap}getSpecularMap(){return this.specularMap}getEmissiveMap(){return this.emissiveMap}getNormalMap(){return this.normalMap}getEnvMap(){return this.envMap}}class at extends It{shadowCasting;material;constructor(){super(Pt),this.shadowCasting=!1,this.material=new lt({})}static buildVertices(t,e,s,i,r,n){const a=new Array,h=new Array,o=new Array,l=new Array,f=new Array,p=new Array,g=new Array,E=new Array,T=new Array,M=new Array;if(!n){n=[{name:"default",faces:[],vertexCount:t}];for(let m=0;m<t;m+=3)n[0].faces.push({v:[m+0,m+1,m+2],t:[m+0,m+1,m+2],n:[m+0,m+1,m+2],smoothGroup:0})}for(const m of n)for(const d of m.faces){h.push([e[d.v[0]*3+0],e[d.v[0]*3+1],e[d.v[0]*3+2]]),h.push([e[d.v[1]*3+0],e[d.v[1]*3+1],e[d.v[1]*3+2]]),h.push([e[d.v[2]*3+0],e[d.v[2]*3+1],e[d.v[2]*3+2]]),s?(o.push([s[d.t[0]*2+0],s[d.t[0]*2+1]]),o.push([s[d.t[1]*2+0],s[d.t[1]*2+1]]),o.push([s[d.t[2]*2+0],s[d.t[2]*2+1]])):(o.push([0,0]),o.push([0,0]),o.push([0,0])),i?(l.push([i[d.v[0]*3+0],i[d.v[0]*3+1],i[d.v[0]*3+2]]),l.push([i[d.v[1]*3+0],i[d.v[1]*3+1],i[d.v[1]*3+2]]),l.push([i[d.v[2]*3+0],i[d.v[2]*3+1],i[d.v[2]*3+2]])):(l.push([1,1,1]),l.push([1,1,1]),l.push([1,1,1]));const A=c.VEC3_SUBSTRACT(h.at(-2),h.at(-3)),S=c.VEC3_SUBSTRACT(h.at(-1),h.at(-3)),I=c.VEC2_SUBSTRACT(o.at(-2),o.at(-3)),P=c.VEC2_SUBSTRACT(o.at(-1),o.at(-3));if(r)f.push([r[d.n[0]*3+0],r[d.n[0]*3+1],r[d.n[0]*3+2]]),f.push([r[d.n[1]*3+0],r[d.n[1]*3+1],r[d.n[1]*3+2]]),f.push([r[d.n[2]*3+0],r[d.n[2]*3+1],r[d.n[2]*3+2]]);else{const _=c.VEC3_NORMALIZE(c.VEC3_CROSS(A,S));f.push(_),f.push(_),f.push(_)}const C=[0,0,0],R=Ke(A,S,I,P,C);g.push(R),g.push(R),g.push(R),p.push(C),p.push(C),p.push(C),d.smoothGroup&&(T[d.smoothGroup]=T[d.smoothGroup]||[],T[d.smoothGroup][d.v[0]]=T[d.smoothGroup][d.v[0]]?c.VEC3_ADD(T[d.smoothGroup][d.v[0]],f.at(-3)):f.at(-3),T[d.smoothGroup][d.v[1]]=T[d.smoothGroup][d.v[1]]?c.VEC3_ADD(T[d.smoothGroup][d.v[1]],f.at(-2)):f.at(-2),T[d.smoothGroup][d.v[2]]=T[d.smoothGroup][d.v[2]]?c.VEC3_ADD(T[d.smoothGroup][d.v[2]],f.at(-1)):f.at(-1),M[d.smoothGroup]=M[d.smoothGroup]||[],M[d.smoothGroup][d.v[0]]=M[d.smoothGroup][d.v[0]]?c.VEC3_ADD(M[d.smoothGroup][d.v[0]],C):C,M[d.smoothGroup][d.v[1]]=M[d.smoothGroup][d.v[1]]?c.VEC3_ADD(M[d.smoothGroup][d.v[1]],C):C,M[d.smoothGroup][d.v[2]]=M[d.smoothGroup][d.v[2]]?c.VEC3_ADD(M[d.smoothGroup][d.v[2]],C):C)}for(let m=0,d=0;m<n.length;m++)for(const A of n[m].faces)for(let S=0;S<3;S++)A.smoothGroup&&(f[d]=c.VEC3_NORMALIZE(T[A.smoothGroup][A.v[S]]),p[d]=c.VEC3_NORMALIZE(M[A.smoothGroup][A.v[S]])),E[d]=c.VEC3_SCALE(c.VEC3_CROSS(f[d],p[d]),g[d]),a.push(h[d][0],h[d][1],h[d][2],o[d][0],o[d][1],l[d][0],l[d][1],l[d][2],f[d][0],f[d][1],f[d][2],p[d][0],p[d][1],p[d][2],E[d][0],E[d][1],E[d][2]),d++;return a}delete(t=!1){t||this.material.delete(),super.delete()}update(t){this.material.update(t)}draw(){_t.drawMesh(this)}setShadowCasting(t){this.shadowCasting=t}getShadowCasting(){return this.shadowCasting}setMaterial(t,e=!0){e||this.material.delete(),this.material=t}getMaterial(){return this.material}clone(t=new at,e=c.MAT4_IDENTITY()){return super.clone(t,e),t.shadowCasting=this.shadowCasting,t.material=this.material,t}get mat(){return this.material}}function Ke(u,t,e,s,i){const r=e[0]*s[1]-e[1]*s[0];if(Math.abs(r)>c.EPSILON){const n=1/r,a=r>0?1:-1,h=(u[0]*s[1]-t[0]*e[1])*n,o=(u[1]*s[1]-t[1]*e[1])*n,l=(u[2]*s[1]-t[2]*e[1])*n,f=c.VEC3_NORMALIZE([h,o,l]);return i[0]=f[0],i[1]=f[1],i[2]=f[2],a}return-1}class Rt extends at{constructor(){super()}async loadFromFile(t){const s=await(await fetch(t)).json();if(!s.hasOwnProperty("Ident")||s.Ident!="JSM")throw new Error("Gfx3MeshJSM::loadFromFile(): File not valid !");this.beginVertices(s.NumVertices),this.setVertices(at.buildVertices(s.NumVertices,s.Vertices,s.TextureCoords,s.Colors,s.Normals)),this.endVertices(),this.boundingBox=w.createFromVertices(s.Vertices,3)}clone(t=new Rt,e=c.MAT4_IDENTITY()){return super.clone(t,e),t}}class Je{maxChildren;maxDepth;root;constructor(t,e,s){this.maxChildren=t,this.maxDepth=e,this.root=new ot(this,0,s)}draw(){this.root.draw()}search(t,e=[]){return this.root.search(t,e)}addChild(t){this.root.addChild(t)}getMaxChildren(){return this.maxChildren}getMaxDepth(){return this.maxDepth}}class ot{tree;depth;method;parent=null;left=null;right=null;children=[];constructor(t,e,s){this.reset(),this.tree=t,this.depth=e,this.method=s}draw(){this.method.draw(),this.left&&this.left.draw(),this.right&&this.right.draw()}search(t,e=[]){return this.method.search(this,t,e)}reset(){this.children=[],this.left=null,this.right=null}addChild(t){if(this.children.length>=this.tree.getMaxChildren()&&this.depth<this.tree.getMaxDepth()&&this.$createSubNodes(),this.left===null&&this.right===null)this.children.push(t);else{const e=this.method.split([t]);this.left&&e.left.length>0&&this.left.addChild(e.left[0]),this.right&&e.right.length>0&&this.right.addChild(e.right[0])}}getChildren(){return this.children}getMethod(){return this.method}getLeft(){return this.left}getRight(){return this.right}getDepth(){return this.depth}setDepth(t){this.depth=t}$createSubNodes(){const t=this.method.split(this.children);this.left=new ot(this.tree,this.depth+1,t.leftMethod),this.right=new ot(this.tree,this.depth+1,t.rightMethod),t.left.forEach(this.left.addChild.bind(this.left)),t.right.forEach(this.right.addChild.bind(this.right)),this.left.parent=this,this.right.parent=this,this.children=[]}}class Ot extends Je{constructor(t,e,s=new w([0,0,0],[0,0,0])){super(t,e,new ht(s,"x"))}}class ht{box;axis;constructor(t,e){this.box=t,this.axis=e}draw(){Ct.drawBoundingBox(c.MAT4_IDENTITY(),this.box.min,this.box.max)}search(t,e,s=[]){if(!this.box.intersectBoundingBox(e))return[];const i=t.getLeft(),r=t.getRight();if(i&&r)i.search(e,s),r.search(e,s);else{const n=t.getChildren();for(let a=0;a<n.length;a++)n[a].intersectBoundingBox(e)&&s.push(n[a])}return s}split(t){const e=[],s=[],i=this.box.getCenter();for(const o of t)this.axis==="x"?o.min[0]<=i[0]&&o.max[0]>=i[0]?(e.push(o),s.push(o)):o.max[0]<=i[0]?e.push(o):s.push(o):this.axis==="y"?o.min[1]<=i[1]&&o.max[1]>=i[1]?(e.push(o),s.push(o)):o.max[1]<=i[1]?e.push(o):s.push(o):o.min[2]<=i[2]&&o.max[2]>=i[2]?(e.push(o),s.push(o)):o.max[2]<=i[2]?e.push(o):s.push(o);let r=[],n="x";this.axis==="x"?(r=this.box.splitVertical(),n="y"):this.axis==="y"?(r=this.box.splitHorizontal(),n="z"):(r=this.box.splitDepth(),n="x");const a=new ht(r[0],n),h=new ht(r[1],n);return{left:e,right:s,leftMethod:a,rightMethod:h}}}class Qe extends w{index;v1;v2;v3;n;t;constructor(t,e,s,i){super(),this.index=t,this.v1=e,this.v2=s,this.v3=i,this.n=c.VEC3_NORMALIZE(c.TRI3_NORMAL(this.v1,this.v2,this.v3)),this.t=c.VEC3_NORMALIZE(c.VEC3_CROSS([0,1,0],this.n)),super.fromVertices([...this.v1,...this.v2,...this.v3],3)}}class ts{boundingBox;frags;fragsData;btree;debugMeshEnabled;debugBspEnabled;debugVertices;debugVertexCount;constructor(){this.boundingBox=new w,this.frags=[],this.fragsData=[],this.btree=new Ot(20,3),this.debugBspEnabled=!0,this.debugMeshEnabled=!0,this.debugVertices=[],this.debugVertexCount=0}async loadFromFile(t,e=20,s=10){const r=await(await fetch(t)).json();if(!r.hasOwnProperty("Ident")||r.Ident!="JNM")throw new Error("GfxJNM::loadFromFile(): File not valid !");this.boundingBox=new w(r.Min,r.Max),this.btree=new Ot(e,s,this.boundingBox),this.frags=[];for(let n=0;n<r.Frags.length;n++){const a=r.Frags[n],h=new Qe(n,a[0],a[1],a[2]);this.btree.addChild(h),this.frags.push(h)}this.fragsData=[];for(const n of r.FragsData){const a=n.FragIndex;this.fragsData[a]=n}}update(t){this.debugVertices=[],this.debugVertexCount=0;for(const e of this.frags)this.debugVertices.push(e.v1[0],e.v1[1],e.v1[2],1,1,1),this.debugVertices.push(e.v2[0],e.v2[1],e.v2[2],1,1,1),this.debugVertices.push(e.v1[0],e.v1[1],e.v1[2],1,1,1),this.debugVertices.push(e.v3[0],e.v3[1],e.v3[2],1,1,1),this.debugVertices.push(e.v2[0],e.v2[1],e.v2[2],1,1,1),this.debugVertices.push(e.v3[0],e.v3[1],e.v3[2],1,1,1),this.debugVertexCount+=6}draw(){this.debugBspEnabled&&this.btree.draw(),this.debugMeshEnabled&&Ct.drawVertices(this.debugVertices,this.debugVertexCount,c.MAT4_IDENTITY())}box(t,e,s,i,r,n,a,h,o=.2,l=!0,f=1,p=.1){const g=[t-i,e-r*.5,s-i],E=[t+i,e+r*.5,s+i];g[1]+=o;const T=this.btree.search(new w([g[0]+n-p,g[1]+a,g[2]+h-p],[E[0]+n+p,E[1]+a,E[2]+h+p]));let M=n,m=a,d=h,A=[],S=!1,I=!1,P=0;const C=[[g[0],g[1]+o,E[2]],[g[0],g[1]+o,g[2]],[E[0],g[1]+o,g[2]],[E[0],g[1]+o,E[2]]];for(;P<C.length;){if(A[P]){P++;continue}const y=this.$moveXZ([t,e,s],T,C[P],[M,d]);if(y.move[0]==0&&y.move[1]==0){M=0,d=0,I=!0;break}else if(y.move[0]!=M||y.move[1]!=d){M=y.move[0],d=y.move[1],I=!0,A[P]=!0,P=0;continue}P++}g[1]-=o,f=f==0?Math.abs(a):f;const R=this.btree.search(new w([t+M,g[1]-f,s+d],[t+M,E[1]+o,s+d])),_=this.$getElevation(R,[t+M,E[1],s+d]),O=_?g[1]-_.value:1/0;return l&&O<f&&_&&(S=!0,m=_.value-g[1]),{move:[M,m,d],collideWall:I,collideFloor:S,fragIndex:_?_.fragIndex:-1}}raycast(t,e,s,i){const r=this.btree.search(new w([t[0]-s,t[1]-i*.5,t[2]-s],[t[0]+s,t[1]+i*.5,t[2]+s]));let n=null,a=1/0,h=[0,0,0];for(const o of r){const l=[0,0,0];if(c.RAY_TRIANGLE(t,e,o.v1,o.v2,o.v3,!0,l)){const f=c.VEC3_SUBSTRACT(l,t),p=c.VEC3_LENGTH(f);p<a&&(a=p,n=o,h=l)}}return n?{hit:h,distance:a,fragIndex:n.index}:null}getElevation(t,e,s,i,r,n,a){const h=this.btree.search(new w([t-i,e-r*.5,s-i],[t+i,e+r*.5,s+i])),o=this.$getElevation(h,[t+n,e+r,s+a]);return{yMove:o?o.value-e:0,fragIndex:o?o.fragIndex:-1}}enableDebugBsp(t){this.debugBspEnabled=t}enableDebugMesh(t){this.debugMeshEnabled=t}isDebugBspEnabled(){return this.debugBspEnabled}isDebugMeshEnabled(){return this.debugMeshEnabled}getBinaryTree(){return this.btree}getSectorData(t){return this.fragsData[t]}$moveXZ(t,e,s,i,r=0){let n=null,a=1/0;for(const h of e){const o=[0,0,0];c.RAY_PLAN(s,[i[0],0,i[1]],h.v1,h.n,!0,o);const l=[o[0]-h.t[0]*100,o[2]-h.t[2]*100],f=[o[0]+h.t[0]*100,o[2]+h.t[2]*100],p=[s[0],s[2]],g=[s[0]+i[0],s[2]+i[1]];if(c.COLLIDE_LINE_TO_LINE(l,f,p,g)){const E=c.VEC2_SUBSTRACT([o[0],o[2]],[s[0]+i[0],s[2]+i[1]]),T=c.VEC2_SUBSTRACT([o[0],o[2]],[t[0],t[2]]),M=c.VEC2_LENGTH(E);c.VEC2_DOT(E,T)<0&&M<a&&(a=M,n=h)}}if(n){const h=c.VEC2_PROJECTION_COS([i[0],i[1]],[n.t[0],n.t[2]]);return this.$moveXZ(t,e,s,h,r+1)}return{move:i}}$getElevation(t,e){let s=null,i=1/0,r=[0,0,0];for(const n of t){const a=[0,0,0];if(c.RAY_TRIANGLE(e,[0,-1,0],n.v1,n.v2,n.v3,!0,a)){const h=c.VEC3_SUBSTRACT(a,e),o=c.VEC3_LENGTH(h);o<i&&(i=o,s=n,r=a)}}return s!=null?{value:r[1],fragIndex:s.index}:null}}class es{constructor(t,e){this.player=t,this.camera=e,this.handleClickedCb=this.handleClicked.bind(this),this.handlePointerLockChangeCb=this.handlePointerLockChange.bind(this),this.handleMouseMoveCb=this.handleMouseMove.bind(this)}delete(){document.removeEventListener("click",this.handleClickedCb),document.removeEventListener("pointerlockchange",this.handlePointerLockChangeCb,!1),document.removeEventListener("mousemove",this.handleMouseMoveCb)}update(t){const e=this.camera.getAxies();let s=!1;this.player.dir=[0,0,0],Q.isActiveKey("ArrowLeft")&&(this.player.dir[0]+=e[0][0]*-1,this.player.dir[2]+=e[0][2]*-1,s=!0),Q.isActiveKey("ArrowRight")&&(this.player.dir[0]+=e[0][0],this.player.dir[2]+=e[0][2],s=!0),Q.isActiveKey("ArrowUp")&&(this.player.dir[0]+=e[2][0]*-1,this.player.dir[2]+=e[2][2]*-1,s=!0),Q.isActiveKey("ArrowDown")&&(this.player.dir[0]+=e[2][0],this.player.dir[2]+=e[2][2],s=!0),s&&(this.player.dir=c.VEC3_NORMALIZE(this.player.dir))}async handleClicked(t){document.pointerLockElement||await document.body.requestPointerLock({unadjustedMovement:!0})}handlePointerLockChange(t){document.pointerLockElement==document.body?document.addEventListener("mousemove",this.handleMouseMoveCb,!1):document.removeEventListener("mousemove",this.handleMouseMoveCb,!1)}handleMouseMove(t){this.player.rotation[0]+=t.movementY*this.player.rotationSpeed/1e3,this.player.rotation[1]+=t.movementX*this.player.rotationSpeed/1e3}}class ss{constructor(t,e){this.player=t,this.jnm=e,this.lift=.3,this.radius=.5,this.frictionCoefficient=.99999999,this.gravityCoefficient=.8,this.gravityMax=10}update(t){const e=c.VEC3_SCALE(this.player.dir,this.player.movementSpeed);if(this.player.velocity[0]=c.LINEAR(Math.pow(1-this.frictionCoefficient,t/1e3),e[0],this.player.velocity[0]),this.player.velocity[2]=c.LINEAR(Math.pow(1-this.frictionCoefficient,t/1e3),e[2],this.player.velocity[2]),c.VEC3_LENGTH(this.player.velocity)>.1){const s=c.VEC3_SCALE(this.player.velocity,t/1e3),i=this.jnm.box(this.player.x,this.player.y,this.player.z,this.radius,this.player.height,s[0],s[1],s[2],this.lift,!0,.1);this.player.x+=i.move[0],this.player.y+=i.move[1],this.player.z+=i.move[2],i.collideFloor?this.player.velocity[1]=0:this.player.velocity[1]=c.LINEAR(Math.pow(1-this.gravityCoefficient,t/1e3),-this.gravityMax,this.player.velocity[1]),this.player.dir[0]==0&&this.player.dir[2]==0&&i.collideWall&&(this.player.velocity[0]=0,this.player.velocity[2]=0)}else this.player.velocity=[0,0,0]}}class is{constructor(t,e){this.player=t,this.camera=e,this.crosshair=document.createElement("img"),this.crosshair.src="samples/fps/crosshair.png",vt.addNode(this.crosshair,"position:absolute; left:50%; top:50%; transform: translate(-50%,-50%);")}delete(){vt.removeNode(this.crosshair)}update(t){this.camera.setPosition(this.player.x,this.player.y+this.player.height/2,this.player.z),this.camera.setRotation(this.player.rotation[0],this.player.rotation[1],this.player.rotation[2])}}class rs{constructor(t,e){this.input=new es(this,e),this.camera=new is(this,e),this.physics=new ss(this,t),this.x=0,this.y=1,this.z=20,this.height=1.3,this.dir=[0,0,0],this.velocity=[0,0,0],this.rotation=[0,0,0],this.movementSpeed=17,this.rotationSpeed=1}async load(){}update(t){this.input.update(t);const e=c.VEC3_SCALE(this.dir,this.movementSpeed);this.x+=e[0]*(t/1e3),this.y+=e[1]*(t/1e3),this.z+=e[2]*(t/1e3),this.camera.update(t)}}class ns extends Ze{constructor(){super(),this.map={},this.player=null,this.camera=new ke(0)}async onEnter(){this.map=await this.createMap(),this.player=new rs(this.map.jnm,this.camera)}update(t){this.map.mesh.update(t),this.player.update(t)}draw(){_t.drawDirLight([0,-1,0],[1,1,1],[1,1,1],[0,0,0]),this.map.mesh.draw()}async createMap(){const t=new Rt;await t.loadFromFile("./samples/fps/Plane.jsm"),t.setMaterial(new lt({texture:await V.loadTexture("./samples/fps/map.png")}));const e=new ts;return await e.loadFromFile("./samples/fps/Level.jnm"),{mesh:t,jnm:e}}}class Gt{times;values;fns;defaultFn;constructor(t,e,s,i=[]){this.times=t,this.values=e,this.fns=i,this.defaultFn=s}interpolate(t){let e=0,s=this.times.length;for(;e<s&&t>this.times[e];)e++;if(e==0)return this.values[0];if(e==s)return this.values[s-1];const i=this.values[e-1],r=this.values[e],n=t-this.times[e-1],a=this.times[e]-this.times[e-1];return this.fns[e]?this.fns[e](n,i,r,a):this.defaultFn(n,i,r,a)}isEmpty(){return this.times.length==0||this.values.length==0}}class F extends Gt{constructor(t=[],e=[],s=[]){super(t,e,c.LINEAR,s)}}class pt extends Gt{constructor(t=[],e=[],s=[]){super(t,e,c.LINEAR_VEC3,s)}}var z=(u=>(u.CLASSIC="CLASSIC",u.EXPLODE="EXPLODE",u))(z||{}),X=(u=>(u.CUBE="CUBE",u.SPHERE="SPHERE",u))(X||{});await V.loadTexture("./textures/star.png"),X.CUBE,z.CLASSIC,new pt([.5,2],[[0,1,.5],[.8,1,.5]]),new F([0,1],[1,20]),new F([2,3],[1,0]),360*4;await V.loadTexture("./textures/smokeparticle.png"),X.SPHERE,z.EXPLODE,new F([0,.1],[1,150]),new F([.7,1],[1,0]);await V.loadTexture("./textures/smokeparticle.png"),X.CUBE,z.CLASSIC,new pt([.4,1],[[0,0,.2],[0,0,.5]]),new F([0,1],[32,128]),new F([.8,2],[.5,0]);await V.loadTexture("./textures/smokeparticle.png"),X.CUBE,z.CLASSIC,new F([0,1,4,5],[0,1,1,0]);await V.loadTexture("./textures/snowflake.png"),X.CUBE,z.CLASSIC,new F([0,.25],[1,10]),new F([2,3],[.8,0]);await V.loadTexture("./textures/raindrop2flip.png"),X.CUBE,z.CLASSIC;await V.loadTexture("./textures/spikey.png"),X.CUBE,z.CLASSIC;await V.loadTexture("./textures/spark.png"),X.CUBE,z.CLASSIC,new F([0,1,1.1,2,2.1,3,3.1,4,4.1,5,5.1,6,6.1],[.2,.2,1,1,.2,.2,1,1,.2,.2,1,1,.2]);await V.loadTexture("./textures/spikey.png"),X.CUBE,z.CLASSIC;await V.loadTexture("./textures/spark.png"),X.SPHERE,z.EXPLODE,new pt([.4,.8,1],[[0,1,1],[0,1,.6],[.8,1,.6]]),new F([.5,.7,1.3],[2,3,1]),new F([.2,.7,2.5],[.75,1,0]);await V.loadTexture("./textures/smokeparticle.png"),X.SPHERE,z.CLASSIC,new pt([.5,1],[[1,0,0],[0,1,0]]),new F([0,.3,1.2],[2,6,2]),new F([.9,1.5],[1,0]);class as{entityIndex;entities;systems;constructor(){this.entityIndex=0,this.entities=new Map,this.systems=[],D.subscribe(Q,"E_ACTION",this,t=>{for(let e of this.systems)e.action(t.actionId)}),D.subscribe(Q,"E_ACTION_ONCE",this,t=>{for(let e of this.systems)e.actionOnce(t.actionId)})}update(t){for(const e of this.systems)e.update(t)}draw(){for(const t of this.systems)t.draw()}setup(t){this.entityIndex=0,this.entities.clear(),this.systems=t}reset(){this.entityIndex=0,this.entities.clear(),this.systems=[]}createEntity(){return this.entities.set(this.entityIndex,new Map),this.entityIndex++}removeEntity(t){if(!this.entities.get(t))throw new Error("DNAManager::removeEntity(): Entity not found");this.entities.delete(t);for(const s of this.systems)s.hasEntity(t)&&s.unbindEntity(t)}hasEntity(t){return this.entities.has(t)}findEntities(t){const e=Array();for(let[s,i]of this.entities)i.has(t)&&e.push(s);return e}findEntity(t){for(let[e,s]of this.entities)if(s.has(t))return e;return-1}addComponent(t,e){const s=this.entities.get(t);if(!s)throw new Error("DNAManager::addComponent(): Entity not found");if(s.has(e.getTypename()))throw new Error("ECSEntity::addComponent(): Entity already has "+e.getTypename());s.set(e.getTypename(),e);for(const r of this.systems)r.isMatchingComponentRequirements(s.values())&&!r.hasEntity(t)&&r.bindEntity(t)}removeComponent(t,e){const s=this.entities.get(t);if(!s)throw new Error("DNAManager::removeComponent(): Entity not found");if(!s.has(e))throw new Error("DNAManager::removeComponent(): Entity has not "+e);s.delete(e);for(const r of this.systems)!r.isMatchingComponentRequirements(s.values())&&r.hasEntity(t)&&r.unbindEntity(t)}removeComponentIfExist(t,e){return this.hasComponent(t,e)?(this.removeComponent(t,e),!0):!1}getComponent(t,e){const s=this.entities.get(t);if(!s)throw new Error("DNAManager::getComponent(): Entity not found");const i=s.get(e);if(!i)throw new Error("DNAManager::getComponent(): Entity has not "+e);return i}getComponents(t){const e=this.entities.get(t);if(!e)throw new Error("DNAManager::getEntity(): Entity not found");return e}hasComponent(t,e){const s=this.entities.get(t);if(!s)throw new Error("DNAManager::hasComponent(): Entity not found");return s.has(e)}getSystems(){return this.systems}findSystems(t){return this.systems.filter(e=>e.hasTag(t))}}new as;/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var Tt=function(u,t){return Tt=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,s){e.__proto__=s}||function(e,s){for(var i in s)s.hasOwnProperty(i)&&(e[i]=s[i])},Tt(u,t)};function zt(u,t){function e(){this.constructor=u}Tt(u,t),u.prototype=t===null?Object.create(t):(e.prototype=t.prototype,new e)}var ct=function(){return ct=Object.assign||function(u){for(var t,e=1,s=arguments.length;e<s;e++)for(var i in t=arguments[e])Object.prototype.hasOwnProperty.call(t,i)&&(u[i]=t[i]);return u},ct.apply(this,arguments)};function bt(u,t){for(var e=new Array(u.length),s=0;s<u.length;s++)e[s]=2*u[s]-t[s];return e}function Mt(u,t,e){var s,i,r,n,a=t.length-1;if(e)s=t[u-1<0?a:u-1],i=t[u%t.length],r=t[(u+1)%t.length],n=t[(u+2)%t.length];else{if(u===a)throw Error("There is no spline segment at this index for a closed curve!");i=t[u],r=t[u+1],s=u>0?t[u-1]:bt(i,r),n=u<a-1?t[u+2]:bt(r,i)}return[s,i,r,n]}function os(u,t,e){e===void 0&&(e=!1);var s=e?t.length:t.length-1;if(u===1)return{index:s-1,weight:1};var i=s*u,r=Math.floor(i);return{index:r,weight:i-r}}function hs(u,t){for(var e=0;e<u.length;e++)u[e]=t;return u}function cs(u,t){for(var e=0;e<u.length;e++)u[e]=t(u[e],e);return u}function us(u,t,e){e===void 0&&(e=0);for(var s=0;s<u.length;s++)e=t(e,u[s],s);return e}function nt(u,t){t=t||new Array(u.length);for(var e=0;e<u.length;e++)t[e]=u[e];return t}function N(u,t,e){return t===void 0&&(t=0),e===void 0&&(e=1),u<t?t:u>e?e:u}function At(u,t){var e=t[0];if(u>=t[t.length-1])return t.length-1;if(u<=e)return 0;for(var s=0,i=t.length-1;s<=i;){var r=Math.floor((s+i)/2),n=t[r];if(n<u)s=r+1;else{if(!(n>u))return r;i=r-1}}return Math.max(0,i)}var G=Math.pow(2,-42);function Vt(u){var t=Math.pow(Math.abs(u),.3333333333333333);return u<0?-t:t}function Xt(u,t,e){if(Math.abs(u)<G)return Math.abs(t)<G?[]:[-e/t];var s=t*t-4*u*e;return Math.abs(s)<G?[-t/(2*u)]:s>0?[(-t+Math.sqrt(s))/(2*u),(-t-Math.sqrt(s))/(2*u)]:[]}function ls(u,t,e,s){if(Math.abs(u)<G)return Xt(t,e,s);var i,r=(3*u*e-t*t)/(3*u*u),n=(2*t*t*t-9*u*t*e+27*u*u*s)/(27*u*u*u);if(Math.abs(r)<G)i=[Vt(-n)];else if(Math.abs(n)<G)i=[0].concat(r<0?[Math.sqrt(-r),-Math.sqrt(-r)]:[]);else{var a=n*n/4+r*r*r/27;if(Math.abs(a)<G)i=[-1.5*n/r,3*n/r];else if(a>0)i=[(h=Vt(-n/2-Math.sqrt(a)))-r/(3*h)];else{var h=2*Math.sqrt(-r/3),o=Math.acos(3*n/r/h)/3,l=2*Math.PI/3;i=[h*Math.cos(o),h*Math.cos(o-l),h*Math.cos(o-2*l)]}}for(var f=0;f<i.length;f++)i[f]-=t/(3*u);return i}function rt(u,t){if(u.length!==t.length)throw Error("Vectors must be of equal length!");for(var e=0,s=0;s<u.length;s++)e+=u[s]*t[s];return e}function H(u,t,e){if(!(u.length>3)){e=e||new Array(3);var s=u[0],i=u[1],r=u[2]||0,n=t[0],a=t[1],h=t[2]||0;return e[0]=i*h-r*a,e[1]=r*n-s*h,e[2]=s*a-i*n,e}}function Ht(u,t){for(var e=0,s=0;s<u.length;s++)e+=(u[s]-t[s])*(u[s]-t[s]);return e}function q(u){for(var t=0,e=0;e<u.length;e++)t+=u[e]*u[e];return Math.sqrt(t)}function ut(u,t){var e=Ht(u,t);return e===0?0:Math.sqrt(e)}function W(u,t){var e=t?nt(u,t):u,s=us(e,function(r,n){return r+Math.pow(n,2)}),i=Math.sqrt(s);return i===0?hs(e,0):cs(e,function(r){return r/i})}function Dt(u,t,e,s){t===void 0&&(t=[0,1,0]),e===void 0&&(e=0);var i=Math.cos(e),r=Math.sin(e),n=1-i,a=u[0],h=u[1],o=u[2],l=t[0],f=t[1],p=t[2],g=n*l,E=n*f;return(s=s||u)[0]=(g*l+i)*a+(g*f-r*p)*h+(g*p+r*f)*o,s[1]=(g*f+r*p)*a+(E*f+i)*h+(E*p-r*l)*o,s[2]=(g*p-r*f)*a+(E*p+r*l)*h+(n*p*p+i)*o,s}function ps(u,t,e,s,i){if(i===void 0&&(i=0),i===0)return[0,1,2,3];var r=function(h,o){return Math.pow(Ht(h,o),.5*i)},n=r(t,u),a=r(e,t)+n;return[0,n,a,r(s,e)+a]}function fs(u,t,e,s,i){for(var r=Number.isFinite(i.tension)?i.tension:.5,n=Number.isFinite(i.alpha)?i.alpha:null,a=n>0?ps(u,t,e,s,n):null,h=new Array(u.length),o=0;o<u.length;o++){var l=0,f=0,p=u[o],g=t[o],E=e[o],T=s[o];if(a){var M=a[0],m=a[1],d=a[2],A=a[3];m-d!=0&&(M-m!=0&&M-d!=0&&(l=(1-r)*(d-m)*((p-g)/(M-m)-(p-E)/(M-d)+(g-E)/(m-d))),m-A!=0&&d-A!=0&&(f=(1-r)*(d-m)*((g-E)/(m-d)-(g-T)/(m-A)+(E-T)/(d-A))))}else l=(1-r)*(E-p)*.5,f=(1-r)*(T-g)*.5;var S=2*g-2*E+l+f,I=-3*g+3*E-2*l-f,P=l,C=g;h[o]=[S,I,P,C]}return h}function tt(u,t){var e=u*u,s=u*e;return t[0]*s+t[1]*e+t[2]*u+t[3]}function et(u,t){var e=u*u;return 3*t[0]*e+2*t[1]*u+t[2]}function gt(u,t){return 6*t[0]*u+2*t[1]}function gs(u,t){var e=t[0],s=t[1],i=t[2],r=t[3]-u;return e===0&&s===0&&i===0&&r===0?[0]:ls(e,s,i,r).filter(function(n){return n>-G&&n<=1+G}).map(function(n){return N(n,0,1)})}function xt(u,t,e,s){s===void 0&&(s=null),s=s||new Array(e.length);for(var i=0;i<e.length;i++)s[i]=u(t,e[i]);return s}var Yt=function(){function u(t){t===void 0&&(t=null),this._alpha=0,this._tension=.5,this._closed=!1,this._onInvalidateCache=null,this._onInvalidateCache=t,this._cache={arcLengths:null,coefficients:null}}return u.prototype._invalidateCache=function(){this.points&&(this._cache={arcLengths:null,coefficients:null},this._onInvalidateCache&&this._onInvalidateCache())},Object.defineProperty(u.prototype,"alpha",{get:function(){return this._alpha},set:function(t){Number.isFinite(t)&&t!==this._alpha&&(this._invalidateCache(),this._alpha=t)},enumerable:!1,configurable:!0}),Object.defineProperty(u.prototype,"tension",{get:function(){return this._tension},set:function(t){Number.isFinite(t)&&t!==this._tension&&(this._invalidateCache(),this._tension=t)},enumerable:!1,configurable:!0}),Object.defineProperty(u.prototype,"points",{get:function(){return this._points},set:function(t){if(!t||t.length<2)throw Error("At least 2 control points are required!");this._points=t,this._invalidateCache()},enumerable:!1,configurable:!0}),Object.defineProperty(u.prototype,"closed",{get:function(){return this._closed},set:function(t){t=!!t,this._closed!==t&&(this._invalidateCache(),this._closed=t)},enumerable:!1,configurable:!0}),u.prototype.reset=function(){this._invalidateCache()},u.prototype.evaluateForT=function(t,e,s){var i=os(e,this.points,this.closed),r=i.index;return xt(t,i.weight,this.getCoefficients(r),s)},u.prototype.getCoefficients=function(t){if(this.points){if(this._cache.coefficients||(this._cache.coefficients=new Map),!this._cache.coefficients.has(t)){var e=Mt(t,this.points,this.closed),s=fs(e[0],e[1],e[2],e[3],{tension:this.tension,alpha:this.alpha});this._cache.coefficients.set(t,s)}return this._cache.coefficients.get(t)}},u}(),ds=function(u){function t(e,s){e===void 0&&(e=300),s===void 0&&(s=null);var i=u.call(this,s)||this;return i._subDivisions=e,i}return zt(t,u),Object.defineProperty(t.prototype,"arcLengths",{get:function(){return this._cache.arcLengths||(this._cache.arcLengths=this.computeArcLengths()),this._cache.arcLengths},enumerable:!1,configurable:!0}),t.prototype._invalidateCache=function(){u.prototype._invalidateCache.call(this),this._cache.arcLengths=null},t.prototype.computeArcLengths=function(){var e,s=[],i=this.evaluateForT(tt,0),r=0;s.push(0);for(var n=1;n<=this._subDivisions;n++)r+=ut(e=this.evaluateForT(tt,n/this._subDivisions),i),s.push(r),i=e;return s},t.prototype.lengthAt=function(e){var s=this.arcLengths;return e*s[s.length-1]},t.prototype.getT=function(e){var s=this.arcLengths,i=s.length,r=e*s[i-1],n=At(r,s);if(s[n]===r)return n/(i-1);var a=s[n];return(n+(r-a)/(s[n+1]-a))/(i-1)},t.prototype.getU=function(e){if(e===0)return 0;if(e===1)return 1;var s=this.arcLengths,i=s.length-1,r=s[i],n=e*i,a=Math.floor(n),h=s[a];if(n===a)return h/r;var o=a/i;return(h+ut(this.evaluateForT(tt,o),this.evaluateForT(tt,e)))/r},t}(Yt),Wt=[[[-.906179845938664,.23692688505618908],[-.5384693101056831,.47862867049936647],[0,.5688888888888889],[.5384693101056831,.47862867049936647],[.906179845938664,.23692688505618908]],[[-.932469514203152,.17132449237917036],[-.6612093864662645,.3607615730481386],[-.2386191860831969,.46791393457269104],[.2386191860831969,.46791393457269104],[.6612093864662645,.3607615730481386],[.932469514203152,.17132449237917036]],[[-.9491079123427585,.1294849661688697],[-.7415311855993945,.27970539148927664],[-.4058451513773972,.3818300505051189],[0,.4179591836734694],[.4058451513773972,.3818300505051189],[.7415311855993945,.27970539148927664],[.9491079123427585,.1294849661688697]],[[-.9602898564975363,.10122853629037626],[-.7966664774136267,.22238103445337448],[-.525532409916329,.31370664587788727],[-.1834346424956498,.362683783378362],[.1834346424956498,.362683783378362],[.525532409916329,.31370664587788727],[.7966664774136267,.22238103445337448],[.9602898564975363,.10122853629037626]],[[-.9681602395076261,.08127438836157441],[-.8360311073266358,.1806481606948574],[-.6133714327005904,.26061069640293544],[-.3242534234038089,.31234707704000286],[0,.3302393550012598],[.3242534234038089,.31234707704000286],[.6133714327005904,.26061069640293544],[.8360311073266358,.1806481606948574],[.9681602395076261,.08127438836157441]],[[-.9739065285171717,.06667134430868814],[-.8650633666889845,.1494513491505806],[-.6794095682990244,.21908636251598204],[-.4333953941292472,.26926671930999635],[-.14887433898163122,.29552422471475287],[.14887433898163122,.29552422471475287],[.4333953941292472,.26926671930999635],[.6794095682990244,.21908636251598204],[.8650633666889845,.1494513491505806],[.9739065285171717,.06667134430868814]],[[-.978228658146056,.0556685671161736],[-.887062599768095,.125580369464904],[-.730152005574049,.186290210927734],[-.519096129206811,.23319376459199],[-.269543155952344,.262804544510246],[0,.2729250867779],[.269543155952344,.262804544510246],[.519096129206811,.23319376459199],[.730152005574049,.186290210927734],[.887062599768095,.125580369464904],[.978228658146056,.0556685671161736]],[[-.981560634246719,.0471753363865118],[-.904117256370474,.106939325995318],[-.769902674194304,.160078328543346],[-.587317954286617,.203167426723065],[-.36783149899818,.233492536538354],[-.125233408511468,.249147045813402],[.125233408511468,.249147045813402],[.36783149899818,.233492536538354],[.587317954286617,.203167426723065],[.769902674194304,.160078328543346],[.904117256370474,.106939325995318],[.981560634246719,.0471753363865118]],[[-.984183054718588,.0404840047653158],[-.917598399222977,.0921214998377284],[-.801578090733309,.138873510219787],[-.64234933944034,.178145980761945],[-.448492751036446,.207816047536888],[-.230458315955134,.226283180262897],[0,.232551553230873],[.230458315955134,.226283180262897],[.448492751036446,.207816047536888],[.64234933944034,.178145980761945],[.801578090733309,.138873510219787],[.917598399222977,.0921214998377284],[.984183054718588,.0404840047653158]],[[-.986283808696812,.0351194603317518],[-.928434883663573,.0801580871597602],[-.827201315069764,.121518570687903],[-.687292904811685,.157203167158193],[-.515248636358154,.185538397477937],[-.319112368927889,.205198463721295],[-.108054948707343,.215263853463157],[.108054948707343,.215263853463157],[.319112368927889,.205198463721295],[.515248636358154,.185538397477937],[.687292904811685,.157203167158193],[.827201315069764,.121518570687903],[.928434883663573,.0801580871597602],[.986283808696812,.0351194603317518]],[[-.987992518020485,.0307532419961172],[-.937273392400705,.0703660474881081],[-.848206583410427,.107159220467171],[-.72441773136017,.139570677926154],[-.570972172608538,.166269205816993],[-.394151347077563,.186161000015562],[-.201194093997434,.198431485327111],[0,.202578241925561],[.201194093997434,.198431485327111],[.394151347077563,.186161000015562],[.570972172608538,.166269205816993],[.72441773136017,.139570677926154],[.848206583410427,.107159220467171],[.937273392400705,.0703660474881081],[.987992518020485,.0307532419961172]],[[-.989400934991649,.027152459411754],[-.944575023073232,.0622535239386478],[-.865631202387831,.0951585116824927],[-.755404408355003,.124628971255533],[-.617876244402643,.149595988816576],[-.458016777657227,.169156519395002],[-.281603550779258,.182603415044923],[-.0950125098376374,.189450610455068],[.0950125098376374,.189450610455068],[.281603550779258,.182603415044923],[.458016777657227,.169156519395002],[.617876244402643,.149595988816576],[.755404408355003,.124628971255533],[.865631202387831,.0951585116824927],[.944575023073232,.0622535239386478],[.989400934991649,.027152459411754]],[[-.990575475314417,.0241483028685479],[-.950675521768767,.0554595293739872],[-.880239153726985,.0850361483171791],[-.781514003896801,.111883847193403],[-.65767115921669,.135136368468525],[-.512690537086476,.15404576107681],[-.351231763453876,.16800410215645],[-.178484181495847,.176562705366992],[0,.179446470356206],[.178484181495847,.176562705366992],[.351231763453876,.16800410215645],[.512690537086476,.15404576107681],[.65767115921669,.135136368468525],[.781514003896801,.111883847193403],[.880239153726985,.0850361483171791],[.950675521768767,.0554595293739872],[.990575475314417,.0241483028685479]],[[-.99156516842093,.0216160135264833],[-.955823949571397,.0497145488949698],[-.892602466497555,.076425730254889],[-.803704958972523,.100942044106287],[-.691687043060353,.122555206711478],[-.559770831073947,.14064291467065],[-.411751161462842,.154684675126265],[-.251886225691505,.164276483745832],[-.0847750130417353,.169142382963143],[.0847750130417353,.169142382963143],[.251886225691505,.164276483745832],[.411751161462842,.154684675126265],[.559770831073947,.14064291467065],[.691687043060353,.122555206711478],[.803704958972523,.100942044106287],[.892602466497555,.076425730254889],[.955823949571397,.0497145488949697],[.99156516842093,.0216160135264833]],[[-.992406843843584,.0194617882297264],[-.96020815213483,.0448142267656996],[-.903155903614817,.0690445427376412],[-.822714656537142,.0914900216224499],[-.720966177335229,.111566645547333],[-.600545304661681,.128753962539336],[-.46457074137596,.142606702173606],[-.316564099963629,.152766042065859],[-.160358645640225,.158968843393954],[0,.161054449848783],[.160358645640225,.158968843393954],[.316564099963629,.152766042065859],[.46457074137596,.142606702173606],[.600545304661681,.128753962539336],[.720966177335229,.111566645547333],[.822714656537142,.0914900216224499],[.903155903614817,.0690445427376412],[.96020815213483,.0448142267656996],[.992406843843584,.0194617882297264]],[[-.993128599185094,.0176140071391521],[-.963971927277913,.0406014298003869],[-.912234428251325,.062672048334109],[-.839116971822218,.0832767415767047],[-.74633190646015,.10193011981724],[-.636053680726515,.118194531961518],[-.510867001950827,.131688638449176],[-.373706088715419,.142096109318382],[-.227785851141645,.149172986472603],[-.0765265211334973,.152753387130725],[.0765265211334973,.152753387130725],[.227785851141645,.149172986472603],[.373706088715419,.142096109318382],[.510867001950827,.131688638449176],[.636053680726515,.118194531961518],[.74633190646015,.10193011981724],[.839116971822218,.0832767415767047],[.912234428251325,.062672048334109],[.963971927277913,.0406014298003869],[.993128599185094,.0176140071391521]],[[-.993752170620389,.0160172282577743],[-.967226838566306,.0369537897708524],[-.9200993341504,.0571344254268572],[-.853363364583317,.0761001136283793],[-.768439963475677,.0934444234560338],[-.667138804197412,.108797299167148],[-.551618835887219,.121831416053728],[-.424342120207438,.132268938633337],[-.288021316802401,.139887394791073],[-.145561854160895,.14452440398997],[0,.14608113364969],[.145561854160895,.14452440398997],[.288021316802401,.139887394791073],[.424342120207438,.132268938633337],[.551618835887219,.121831416053728],[.667138804197412,.108797299167148],[.768439963475677,.0934444234560338],[.853363364583317,.0761001136283793],[.9200993341504,.0571344254268572],[.967226838566306,.0369537897708524],[.993752170620389,.0160172282577743]],[[-.994294585482399,.0146279952982722],[-.970060497835428,.0337749015848141],[-.926956772187174,.0522933351526832],[-.8658125777203,.0697964684245204],[-.787816805979208,.0859416062170677],[-.694487263186682,.10041414444288],[-.587640403506911,.112932296080539],[-.469355837986757,.123252376810512],[-.341935820892084,.131173504787062],[-.207860426688221,.136541498346015],[-.0697392733197222,.139251872855631],[.0697392733197222,.139251872855631],[.207860426688221,.136541498346015],[.341935820892084,.131173504787062],[.469355837986757,.123252376810512],[.587640403506911,.112932296080539],[.694487263186682,.10041414444288],[.787816805979208,.0859416062170677],[.8658125777203,.0697964684245204],[.926956772187174,.0522933351526832],[.970060497835428,.0337749015848141],[.994294585482399,.0146279952982722]],[[-.994769334997552,.0134118594871417],[-.972542471218115,.0309880058569794],[-.932971086826016,.0480376717310846],[-.876752358270441,.0642324214085258],[-.804888401618839,.0792814117767189],[-.71866136313195,.0929157660600351],[-.619609875763646,.104892091464541],[-.509501477846007,.114996640222411],[-.39030103803029,.123049084306729],[-.264135680970344,.128905722188082],[-.133256824298466,.132462039404696],[0,.133654572186106],[.133256824298466,.132462039404696],[.264135680970344,.128905722188082],[.39030103803029,.123049084306729],[.509501477846007,.114996640222411],[.619609875763646,.104892091464541],[.71866136313195,.0929157660600351],[.804888401618839,.0792814117767189],[.876752358270441,.0642324214085258],[.932971086826016,.0480376717310846],[.972542471218115,.0309880058569794],[.994769334997552,.0134118594871417]],[[-.995187219997021,.0123412297999872],[-.974728555971309,.0285313886289336],[-.938274552002732,.0442774388174198],[-.886415527004401,.0592985849154367],[-.820001985973902,.0733464814110803],[-.740124191578554,.0861901615319532],[-.648093651936975,.0976186521041138],[-.545421471388839,.107444270115965],[-.433793507626045,.115505668053725],[-.315042679696163,.121670472927803],[-.191118867473616,.125837456346828],[-.0640568928626056,.127938195346752],[.0640568928626056,.127938195346752],[.191118867473616,.125837456346828],[.315042679696163,.121670472927803],[.433793507626045,.115505668053725],[.545421471388839,.107444270115965],[.648093651936975,.0976186521041138],[.740124191578554,.0861901615319532],[.820001985973902,.0733464814110803],[.886415527004401,.0592985849154367],[.938274552002732,.0442774388174198],[.974728555971309,.0285313886289336],[.995187219997021,.0123412297999872]],[[-.995556969790498,.0113937985010262],[-.976663921459517,.0263549866150321],[-.942974571228974,.0409391567013063],[-.894991997878275,.0549046959758351],[-.833442628760834,.0680383338123569],[-.759259263037357,.080140700335001],[-.673566368473468,.0910282619829636],[-.577662930241222,.10053594906705],[-.473002731445714,.108519624474263],[-.361172305809387,.114858259145711],[-.243866883720988,.119455763535784],[-.12286469261071,.12224244299031],[0,.123176053726715],[.12286469261071,.12224244299031],[.243866883720988,.119455763535784],[.361172305809387,.114858259145711],[.473002731445714,.108519624474263],[.577662930241222,.10053594906705],[.673566368473468,.0910282619829636],[.759259263037357,.080140700335001],[.833442628760834,.0680383338123569],[.894991997878275,.0549046959758351],[.942974571228974,.0409391567013063],[.976663921459517,.0263549866150321],[.995556969790498,.0113937985010262]],[[-.995885701145616,.010551372617343],[-.97838544595647,.0244178510926319],[-.947159066661714,.0379623832943627],[-.902637861984307,.0509758252971478],[-.845445942788498,.0632740463295748],[-.776385948820678,.0746841497656597],[-.696427260419957,.0850458943134852],[-.606692293017618,.0942138003559141],[-.508440714824505,.102059161094425],[-.403051755123486,.108471840528576],[-.292004839485956,.113361816546319],[-.17685882035689,.116660443485296],[-.0592300934293132,.118321415279262],[.0592300934293132,.118321415279262],[.17685882035689,.116660443485296],[.292004839485956,.113361816546319],[.403051755123486,.108471840528576],[.508440714824505,.102059161094425],[.606692293017618,.0942138003559141],[.696427260419957,.0850458943134852],[.776385948820678,.0746841497656597],[.845445942788498,.0632740463295748],[.902637861984307,.0509758252971478],[.947159066661714,.0379623832943627],[.97838544595647,.0244178510926319],[.995885701145616,.010551372617343]],[[-.996179262888988,.00979899605129436],[-.979923475961501,.0226862315961806],[-.950900557814705,.0352970537574197],[-.909482320677491,.047449412520615],[-.856207908018294,.0589835368598335],[-.791771639070508,.0697488237662455],[-.717013473739423,.0796048677730577],[-.632907971946495,.0884231585437569],[-.540551564579456,.0960887273700285],[-.441148251750026,.102501637817745],[-.335993903638508,.107578285788533],[-.226459365439536,.111252488356845],[-.113972585609529,.113476346108965],[0,.114220867378956],[.113972585609529,.113476346108965],[.226459365439536,.111252488356845],[.335993903638508,.107578285788533],[.441148251750026,.102501637817745],[.540551564579456,.0960887273700285],[.632907971946495,.0884231585437569],[.717013473739423,.0796048677730577],[.791771639070508,.0697488237662455],[.856207908018294,.0589835368598336],[.909482320677491,.047449412520615],[.950900557814705,.0352970537574197],[.979923475961501,.0226862315961806],[.996179262888988,.00979899605129436]],[[-.996442497573954,.00912428259309452],[-.981303165370872,.0211321125927712],[-.954259280628938,.0329014277823043],[-.915633026392132,.0442729347590042],[-.865892522574395,.0551073456757167],[-.805641370917179,.0652729239669995],[-.735610878013631,.0746462142345687],[-.656651094038864,.0831134172289012],[-.569720471811401,.0905717443930328],[-.475874224955118,.0969306579979299],[-.376251516089078,.10211296757806],[-.272061627635178,.106055765922846],[-.16456928213338,.108711192258294],[-.0550792898840342,.110047013016475],[.0550792898840342,.110047013016475],[.16456928213338,.108711192258294],[.272061627635178,.106055765922846],[.376251516089078,.10211296757806],[.475874224955118,.0969306579979299],[.569720471811401,.0905717443930328],[.656651094038864,.0831134172289012],[.735610878013631,.0746462142345687],[.805641370917179,.0652729239669995],[.865892522574395,.0551073456757167],[.915633026392132,.0442729347590042],[.954259280628938,.0329014277823043],[.981303165370872,.0211321125927712],[.996442497573954,.00912428259309452]],[[-.996679442260596,.00851690387874641],[-.982545505261413,.0197320850561227],[-.957285595778087,.0307404922020936],[-.921180232953058,.0414020625186828],[-.874637804920102,.0515948269024979],[-.818185487615252,.0612030906570791],[-.752462851734477,.0701179332550512],[-.678214537602686,.0782383271357637],[-.596281797138227,.0854722573661725],[-.507592955124227,.0917377571392587],[-.413152888174008,.0969638340944086],[-.314031637867639,.101091273759914],[-.211352286166001,.104073310077729],[-.106278230132679,.10587615509732],[0,.106479381718314],[.106278230132679,.10587615509732],[.211352286166001,.104073310077729],[.314031637867639,.101091273759914],[.413152888174008,.0969638340944086],[.507592955124227,.0917377571392587],[.596281797138227,.0854722573661725],[.678214537602686,.0782383271357637],[.752462851734477,.0701179332550512],[.818185487615252,.0612030906570791],[.874637804920102,.0515948269024979],[.921180232953058,.0414020625186828],[.957285595778087,.0307404922020936],[.982545505261413,.0197320850561227],[.996679442260596,.00851690387874641]],[[-.996893484074649,.0079681924961666],[-.983668123279747,.0184664683110909],[-.960021864968307,.0287847078833233],[-.926200047429274,.038799192569627],[-.882560535792052,.048402672830594],[-.829565762382768,.057493156217619],[-.767777432104826,.0659742298821805],[-.697850494793315,.0737559747377052],[-.620526182989242,.0807558952294202],[-.536624148142019,.0868997872010829],[-.447033769538089,.0921225222377861],[-.352704725530878,.0963687371746442],[-.254636926167889,.0995934205867952],[-.153869913608583,.101762389748405],[-.0514718425553176,.102852652893558],[.0514718425553176,.102852652893558],[.153869913608583,.101762389748405],[.254636926167889,.0995934205867952],[.352704725530878,.0963687371746442],[.447033769538089,.0921225222377861],[.536624148142019,.0868997872010829],[.620526182989242,.0807558952294202],[.697850494793315,.0737559747377052],[.767777432104826,.0659742298821805],[.829565762382768,.057493156217619],[.882560535792052,.048402672830594],[.926200047429274,.038799192569627],[.960021864968307,.0287847078833233],[.983668123279747,.0184664683110909],[.996893484074649,.0079681924961666]]],Nt=Wt.length+5,Es=function(u){function t(e,s,i){e===void 0&&(e=24),s===void 0&&(s=21);var r=u.call(this,i)||this;return r._nSamples=21,r._gauss=function(n){if(n<5||n>Nt)throw Error("Order for Gaussian Quadrature must be in the range of ".concat(5," and ").concat(Nt,"."));return Wt[n-5]}(e),r._nSamples=s,r}return zt(t,u),t.prototype._invalidateCache=function(){u.prototype._invalidateCache.call(this),this._cache.arcLengths=null,this._cache.samples=null},Object.defineProperty(t.prototype,"arcLengths",{get:function(){return this._cache.arcLengths||(this._cache.arcLengths=this.computeArcLengths()),this._cache.arcLengths},enumerable:!1,configurable:!0}),t.prototype.getSamples=function(e){if(this.points){if(this._cache.samples||(this._cache.samples=new Map),!this._cache.samples.has(e)){for(var s=this._nSamples,i=[],r=[],n=this.getCoefficients(e),a=0;a<s;++a){var h=a/(s-1);i.push(this.computeArcLength(e,0,h));var o=q(xt(et,h,n)),l=o===0?0:1/o;this.tension>.95&&(l=N(l,-1,1)),r.push(l)}var f=s-1,p=[],g=[],E=i[0],T=r[0],M=1/f;for(a=0;a<f;++a){var m=E,d=(E=i[a+1])-m,A=T,S=r[a+1];T=S;var I=M/d,P=(A+S-2*I)/(d*d),C=(3*I-2*A-S)/d;p.push(P),g.push(C)}this._cache.samples.set(e,[i,r,g,p])}return this._cache.samples.get(e)}},t.prototype.computeArcLength=function(e,s,i){if(s===void 0&&(s=0),i===void 0&&(i=1),s===i)return 0;for(var r=this.getCoefficients(e),n=.5*(i-s),a=0,h=0;h<this._gauss.length;h++){var o=this._gauss[h],l=o[0];a+=o[1]*q(xt(et,n*l+n+s,r))}return n*a},t.prototype.computeArcLengths=function(){if(this.points){var e=[];e.push(0);for(var s=this.closed?this.points.length:this.points.length-1,i=0,r=0;r<s;r++)i+=this.computeArcLength(r),e.push(i);return e}},t.prototype.inverse=function(e,s){var i=1/(this._nSamples-1),r=this.getSamples(e),n=r[0],a=r[1],h=r[2],o=r[3];if(s>=n[n.length-1])return 1;if(s<=0)return 0;var l=Math.max(0,At(s,n)),f=l*i;if(n[l]===s)return f;var p=a[l],g=o[l],E=h[l],T=s-n[l];return((g*T+E)*T+p)*T+f},t.prototype.lengthAt=function(e){return e*this.arcLengths[this.arcLengths.length-1]},t.prototype.getT=function(e){var s=this.arcLengths,i=s.length,r=e*s[i-1],n=At(r,s),a=n/(i-1);if(s[n]===r)return a;var h=r-s[n];return(n+this.inverse(n,h))/(i-1)},t.prototype.getU=function(e){if(e===0)return 0;if(e===1)return 1;var s=this.arcLengths,i=s.length-1,r=s[i],n=e*i,a=Math.floor(n),h=s[a];if(n===a)return h/r;var o=n-a;return(h+this.computeArcLength(a,0,o))/r},t}(Yt);(function(){function u(t,e){e===void 0&&(e={});var s=this;this._cache=new Map;var i=(e=ct({tension:.5,alpha:0,closed:!1},e)).arcDivisions?new ds(e.arcDivisions,function(){return s._invalidateCache()}):new Es(e.numericalApproximationOrder,e.numericalInverseSamples,function(){return s._invalidateCache()});i.alpha=e.alpha,i.tension=e.tension,i.closed=e.closed,i.points=t,this._lmargin=e.lmargin||1-i.tension,this._curveMapper=i}return u.prototype.getTimeFromPosition=function(t,e){return e===void 0&&(e=!1),this._curveMapper.getT(e?N(t,0,1):t)},u.prototype.getPositionFromTime=function(t,e){return e===void 0&&(e=!1),this._curveMapper.getU(e?N(t,0,1):t)},u.prototype.getPositionFromLength=function(t,e){e===void 0&&(e=!1);var s=e?N(t,0,this.length):t;return this._curveMapper.getU(s/this.length)},u.prototype.getLengthAt=function(t,e){return t===void 0&&(t=1),e===void 0&&(e=!1),this._curveMapper.lengthAt(e?N(t,0,1):t)},u.prototype.getTimeAtKnot=function(t){if(t<0||t>this.points.length-1)throw Error("Invalid index!");return t===0?0:this.closed||t!==this.points.length-1?t/(this.closed?this.points.length:this.points.length-1):1},u.prototype.getPositionAtKnot=function(t){return this.getPositionFromTime(this.getTimeAtKnot(t))},u.prototype.getPointAtTime=function(t,e){return(t=N(t,0,1))===0?nt(this.points[0],e):t===1?nt(this.closed?this.points[0]:this.points[this.points.length-1],e):this._curveMapper.evaluateForT(tt,t,e)},u.prototype.getPointAt=function(t,e){return this.getPointAtTime(this.getTimeFromPosition(t),e)},u.prototype.getTangentAt=function(t,e){var s=N(this.getTimeFromPosition(t),0,1);return this.getTangentAtTime(s,e)},u.prototype.getTangentAtTime=function(t,e){return W(this._curveMapper.evaluateForT(et,t,e))},u.prototype.getNormalAt=function(t,e){var s=N(this.getTimeFromPosition(t),0,1);return this.getNormalAtTime(s,e)},u.prototype.getNormalAtTime=function(t,e){var s=W(this._curveMapper.evaluateForT(et,t));if(!(s.length<2||s.length>3)){var i=e||new Array(s.length);if(s.length===2)return i[0]=-s[1],i[1]=s[0],i;var r=W(this._curveMapper.evaluateForT(gt,t));return W(H(H(s,r),s),i)}},u.prototype.getFrenetFrames=function(t,e,s){if(e===void 0&&(e=0),s===void 0&&(s=1),!(e<0||s>1||s<e)){for(var i=new Array(t+1),r=new Array(t+1),n=0;n<=t;n++){var a=e===0&&s===1?n/t:e+n/t*(s-e);i[n]=this.getTangentAt(a)}if(this.dim===2){for(n=0;n<i.length;n++)r[n]=[-i[n][1],i[n][0]];return{tangents:i,normals:r}}if(this.dim===3){var h=new Array(t+1),o=void 0,l=Number.MAX_VALUE,f=Math.abs(i[0][0]),p=Math.abs(i[0][1]);f<=l&&(l=f,o=[1,0,0]),p<=l&&(l=p,o=[0,1,0]),Math.abs(i[0][2])<=l&&(o=[0,0,1]);var g=W(H(i[0],o));for(r[0]=H(i[0],g),h[0]=H(i[0],r[0]),n=1;n<=t;n++){if(g=H(i[n-1],i[n]),r[n]=nt(r[n-1]),q(g)>G){W(g);var E=Math.acos(N(rt(i[n-1],i[n]),-1,1));Dt(r[n-1],g,E,r[n])}h[n]=H(i[n],r[n])}if(this.closed===!0)for(E=Math.acos(N(rt(r[0],r[t]),-1,1))/t,rt(i[0],H(r[0],r[t]))>0&&(E=-E),n=1;n<=t;n++)Dt(r[n],i[n],E*n,r[n]),h[n]=H(i[n],r[n]);return{tangents:i,normals:r,binormals:h}}}},u.prototype.getCurvatureAt=function(t){var e=N(this.getTimeFromPosition(t),0,1);return this.getCurvatureAtTime(e)},u.prototype.getCurvatureAtTime=function(t){var e=this._curveMapper.evaluateForT(et,t),s=this._curveMapper.evaluateForT(gt,t),i=W(e,[]),r=0,n=void 0;if(e.length===2){if((f=Math.pow(e[0]*e[0]+e[1]*e[1],1.5))!==0){var a=(e[0]*s[1]-e[1]*s[0])/f;n=a<0?[i[1],-i[0]]:[-i[1],i[0]],r=Math.abs(a)}}else if(e.length===3){var h=q(e),o=H(e,s);n=W(H(o,e)),h!==0&&(r=q(o)/Math.pow(h,3))}else{h=q(e);var l=q(s),f=Math.pow(h,3),p=rt(e,s);f!==0&&(r=Math.sqrt(Math.pow(h,2)*Math.pow(l,2)-Math.pow(p,2))/f)}return{curvature:r,radius:r!==0?1/r:0,tangent:i,direction:n}},u.prototype.getDerivativeAt=function(t,e){var s=N(this.getTimeFromPosition(t),0,1);return this._curveMapper.evaluateForT(et,s,e)},u.prototype.getSecondDerivativeAt=function(t,e){var s=N(this.getTimeFromPosition(t),0,1);return this._curveMapper.evaluateForT(gt,s,e)},u.prototype.getBoundingBox=function(t,e){if(t===void 0&&(t=0),e===void 0&&(e=1),t===0&&e===1&&this._cache.has("bbox"))return this._cache.get("bbox");for(var s=[],i=[],r=this.getTimeFromPosition(t),n=this.getTimeFromPosition(e),a=this.getPointAtTime(r),h=this.getPointAtTime(n),o=this.closed?this.points.length:this.points.length-1,l=Math.floor(o*r),f=Math.ceil(o*n),p=0;p<a.length;p++)s[p]=Math.min(a[p],h[p]),i[p]=Math.max(a[p],h[p]);for(var g=function(m){var d=Mt(m-1,E.points,E.closed)[2];if(m<f)for(var A=0;A<d.length;A++)d[A]<s[A]&&(s[A]=d[A]),d[A]>i[A]&&(i[A]=d[A]);if(E.tension<1){var S=o*r-(m-1),I=o*n-(m-1),P=function(_){return _>-G&&_<=1+G&&(m-1!==l||_>S)&&(m!==f||_<I)},C=E._curveMapper.getCoefficients(m-1),R=function(_){var O=C[_];Xt(3*O[0],2*O[1],O[2]).filter(P).forEach(function(y){var b=tt(y,C[_]);b<s[_]&&(s[_]=b),b>i[_]&&(i[_]=b)})};for(A=0;A<C.length;A++)R(A)}},E=this,T=l+1;T<=f;T++)g(T);var M={min:s,max:i};return t===0&&e===1&&this._cache.set("bbox",M),M},u.prototype.getPoints=function(t,e,s,i){if(t===void 0&&(t=100),s===void 0&&(s=0),i===void 0&&(i=1),!t||t<=0)throw Error("Invalid arguments passed to getPoints(). You must specify at least 1 sample/segment.");if(!(s<0||i>1||i<s)){for(var r=[],n=0;n<=t;n++){var a=s===0&&i===1?n/t:s+n/t*(i-s);r.push(this.getPointAt(a,e&&new e))}return r}},u.prototype.getNearestPosition=function(t,e,s){var i=this;if(e===void 0&&(e=1e-5),e<=0||!Number.isFinite(e))throw Error("Invalid threshold. Must be a number greater than zero!");s=s||10*this.points.length-1;var r=new Array(t.length),n=1/0,a=0,h=this.createLookupTable(function(p){return i.getPointAt(p)},s,{cacheKey:"lut_nearest_".concat(s)});Array.from(h.keys()).forEach(function(p){var g=h.get(p),E=ut(t,g);if(E<n)return n=E,a=p,!0});for(var o=this.getTimeFromPosition(a),l=function(p){if(p>=0&&p<=1){i.getPointAtTime(p,r);var g=ut(t,r);if(g<n)return n=g,o=p,!0}},f=.005;f>e;)l(o-f)||l(o+f)||(f/=2);return{u:a=this._curveMapper.getU(o),distance:n,point:r}},u.prototype.getIntersects=function(t,e,s,i){var r=this;e===void 0&&(e=0),s===void 0&&(s=0),i===void 0&&(i=this._lmargin);var n=this.getIntersectsAsTime(t,e,s,i).map(function(a){return r.getPointAtTime(a)});return Math.abs(s)===1?n.length===1?n[0]:null:n},u.prototype.getIntersectsAsPositions=function(t,e,s,i){var r=this;return e===void 0&&(e=0),s===void 0&&(s=0),i===void 0&&(i=this._lmargin),this.getIntersectsAsTime(t,e,s,i).map(function(n){return r.getPositionFromTime(n)})},u.prototype.getIntersectsAsTime=function(t,e,s,i){e===void 0&&(e=0),s===void 0&&(s=0),i===void 0&&(i=this._lmargin);for(var r=e,n=new Set,a=this.closed?this.points.length:this.points.length-1,h=0;h<a&&(s===0||n.size<Math.abs(s));h+=1){var o=s<0?a-(h+1):h,l=Mt(o,this.points,this.closed),f=l[1],p=l[2],g=this._curveMapper.getCoefficients(o),E=void 0,T=void 0;if(f[r]<p[r]?(E=f[r],T=p[r]):(E=p[r],T=f[r]),t-i<=T&&t+i>=E){var M=gs(t,g[r]);s<0?M.sort(function(A,S){return S-A}):s>=0&&M.sort(function(A,S){return A-S});for(var m=0;m<M.length;m++){var d=(M[m]+o)/a;if(n.add(d),s!==0&&n.size===Math.abs(s))break}}}return Array.from(n)},u.prototype.createLookupTable=function(t,e,s){if(!e||e<=1)throw Error("Invalid arguments passed to createLookupTable(). You must specify at least 2 samples.");var i=ct({from:0,to:1,cacheForceUpdate:!1},s),r=i.from,n=i.to,a=i.cacheKey,h=i.cacheForceUpdate;if(!(r<0||n>1||n<r)){var o=null;if(a&&!h&&this._cache.has(a))a&&this._cache.has(a)&&(o=this._cache.get(a));else{o=new Map;for(var l=0;l<e;l++){var f=r===0&&n===1?l/(e-1):r+l/(e-1)*(n-r),p=t(f);o.set(f,p)}a&&this._cache.set(a,o)}return o}},u.prototype.forEach=function(t,e,s,i){var r=this;s===void 0&&(s=0),i===void 0&&(i=1);var n=[];if(Number.isFinite(e)){var a=e;if(a<=1)throw Error("Invalid arguments passed to forEach(). You must specify at least 2 samples.");for(var h=0;h<a;h++){var o=s===0&&i===1?h/(a-1):s+h/(a-1)*(i-s);n.push(o)}}else Array.isArray(e)&&(n=e);var l=null;n.forEach(function(f,p){if(!Number.isFinite(f)||f<0||f>1)throw Error("Invalid position (u) for sample in forEach!");var g=r.getTimeFromPosition(f),E=t({u:f,t:g,i:p,prev:l});l={u:f,t:g,i:p,value:E}})},u.prototype.map=function(t,e,s,i){var r=this;s===void 0&&(s=0),i===void 0&&(i=1);var n=[];if(Number.isFinite(e)){var a=e;if(a<=1)throw Error("Invalid arguments passed to map(). You must specify at least 2 samples.");for(var h=0;h<a;h++){var o=s===0&&i===1?h/(a-1):s+h/(a-1)*(i-s);n.push(o)}}else Array.isArray(e)&&(n=e);var l=null;return n.map(function(f,p){if(!Number.isFinite(f)||f<0||f>1)throw Error("Invalid position (u) for sample in map()!");var g=r.getTimeFromPosition(f),E=t({u:f,t:g,i:p,prev:l});return l={u:f,t:g,i:p,value:E},E})},u.prototype.reduce=function(t,e,s,i,r){var n=this;i===void 0&&(i=0),r===void 0&&(r=1);var a=[];if(Number.isFinite(s)){var h=s;if(h<=1)throw Error("Invalid arguments passed to map(). You must specify at least 2 samples.");for(var o=0;o<h;o++){var l=i===0&&r===1?o/(h-1):i+o/(h-1)*(r-i);a.push(l)}}else Array.isArray(s)&&(a=s);return a.reduce(function(f,p,g){if(!Number.isFinite(p)||p<0||p>1)throw Error("Invalid position (u) for sample in map()!");var E=n.getTimeFromPosition(p);return t({acc:f,u:p,t:E,i:g})},e)},u.prototype._invalidateCache=function(){return this._cache=new Map,this},u.prototype.reset=function(){this._curveMapper.reset()},Object.defineProperty(u.prototype,"points",{get:function(){return this._curveMapper.points},set:function(t){this._curveMapper.points=t},enumerable:!1,configurable:!0}),Object.defineProperty(u.prototype,"tension",{get:function(){return this._curveMapper.tension},set:function(t){this._curveMapper.tension=t},enumerable:!1,configurable:!0}),Object.defineProperty(u.prototype,"alpha",{get:function(){return this._curveMapper.alpha},set:function(t){this._curveMapper.alpha=t},enumerable:!1,configurable:!0}),Object.defineProperty(u.prototype,"closed",{get:function(){return this._curveMapper.closed},set:function(t){this._curveMapper.closed=t},enumerable:!1,configurable:!0}),Object.defineProperty(u.prototype,"length",{get:function(){return this._curveMapper.lengthAt(1)},enumerable:!1,configurable:!0}),Object.defineProperty(u.prototype,"minX",{get:function(){return this.getBoundingBox().min[0]},enumerable:!1,configurable:!0}),Object.defineProperty(u.prototype,"maxX",{get:function(){return this.getBoundingBox().max[0]},enumerable:!1,configurable:!0}),Object.defineProperty(u.prototype,"minY",{get:function(){return this.getBoundingBox().min[1]},enumerable:!1,configurable:!0}),Object.defineProperty(u.prototype,"maxY",{get:function(){return this.getBoundingBox().max[1]},enumerable:!1,configurable:!0}),Object.defineProperty(u.prototype,"minZ",{get:function(){return this.getBoundingBox().min[2]},enumerable:!1,configurable:!0}),Object.defineProperty(u.prototype,"maxZ",{get:function(){return this.getBoundingBox().max[2]},enumerable:!1,configurable:!0}),Object.defineProperty(u.prototype,"dim",{get:function(){var t;return((t=this.points[0])===null||t===void 0?void 0:t.length)||void 0},enumerable:!1,configurable:!0}),u})();class ms{constructor(){this.then=0}startup(){St.enableScanlines(!0),Ct.setShowDebug(!0),this.run(0)}run(t){const e=t-this.then;this.then=t,ft.update(e),vt.update(e),mt.update(e),v.beginDrawing(),ft.beginDrawing(),mt.draw(),ft.endDrawing(),v.endDrawing(),v.beginRender(),v.beginPassRender(0),_t.render(),v.endPassRender(),v.endRender(),requestAnimationFrame(s=>this.run(s))}}const vs=new ms;vs.startup();mt.requestSetScreen(new ns);
