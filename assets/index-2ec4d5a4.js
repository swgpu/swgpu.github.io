(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const n of r.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function e(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=e(i);fetch(i.href,r)}})();var Gs=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Go(h){return h&&h.__esModule&&Object.prototype.hasOwnProperty.call(h,"default")?h.default:h}function zs(h){throw new Error('Could not dynamically require "'+h+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var si={exports:{}};/*!

JSZip v3.10.1 - A JavaScript class for generating and reading zip files
<http://stuartk.com/jszip>

(c) 2009-2016 Stuart Knightley <stuart [at] stuartk.com>
Dual licenced under the MIT license or GPLv3. See https://raw.github.com/Stuk/jszip/main/LICENSE.markdown.

JSZip uses the library pako released under the MIT license :
https://github.com/nodeca/pako/blob/main/LICENSE
*/var op=si.exports;(function(h,t){(function(e){h.exports=e()})(function(){return function e(s,i,r){function n(l,c){if(!i[l]){if(!s[l]){var u=typeof zs=="function"&&zs;if(!c&&u)return u(l,!0);if(o)return o(l,!0);var p=new Error("Cannot find module '"+l+"'");throw p.code="MODULE_NOT_FOUND",p}var d=i[l]={exports:{}};s[l][0].call(d.exports,function(E){var m=s[l][1][E];return n(m||E)},d,d.exports,e,s,i,r)}return i[l].exports}for(var o=typeof zs=="function"&&zs,a=0;a<r.length;a++)n(r[a]);return n}({1:[function(e,s,i){"use strict";var r=e("./utils"),n=e("./support"),o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";i.encode=function(a){for(var l,c,u,p,d,E,m,y=[],C=0,w=a.length,A=w,_=r.getTypeOf(a)!=="string";C<a.length;)A=w-C,u=_?(l=a[C++],c=C<w?a[C++]:0,C<w?a[C++]:0):(l=a.charCodeAt(C++),c=C<w?a.charCodeAt(C++):0,C<w?a.charCodeAt(C++):0),p=l>>2,d=(3&l)<<4|c>>4,E=1<A?(15&c)<<2|u>>6:64,m=2<A?63&u:64,y.push(o.charAt(p)+o.charAt(d)+o.charAt(E)+o.charAt(m));return y.join("")},i.decode=function(a){var l,c,u,p,d,E,m=0,y=0,C="data:";if(a.substr(0,C.length)===C)throw new Error("Invalid base64 input, it looks like a data url.");var w,A=3*(a=a.replace(/[^A-Za-z0-9+/=]/g,"")).length/4;if(a.charAt(a.length-1)===o.charAt(64)&&A--,a.charAt(a.length-2)===o.charAt(64)&&A--,A%1!=0)throw new Error("Invalid base64 input, bad content length.");for(w=n.uint8array?new Uint8Array(0|A):new Array(0|A);m<a.length;)l=o.indexOf(a.charAt(m++))<<2|(p=o.indexOf(a.charAt(m++)))>>4,c=(15&p)<<4|(d=o.indexOf(a.charAt(m++)))>>2,u=(3&d)<<6|(E=o.indexOf(a.charAt(m++))),w[y++]=l,d!==64&&(w[y++]=c),E!==64&&(w[y++]=u);return w}},{"./support":30,"./utils":32}],2:[function(e,s,i){"use strict";var r=e("./external"),n=e("./stream/DataWorker"),o=e("./stream/Crc32Probe"),a=e("./stream/DataLengthProbe");function l(c,u,p,d,E){this.compressedSize=c,this.uncompressedSize=u,this.crc32=p,this.compression=d,this.compressedContent=E}l.prototype={getContentWorker:function(){var c=new n(r.Promise.resolve(this.compressedContent)).pipe(this.compression.uncompressWorker()).pipe(new a("data_length")),u=this;return c.on("end",function(){if(this.streamInfo.data_length!==u.uncompressedSize)throw new Error("Bug : uncompressed data size mismatch")}),c},getCompressedWorker:function(){return new n(r.Promise.resolve(this.compressedContent)).withStreamInfo("compressedSize",this.compressedSize).withStreamInfo("uncompressedSize",this.uncompressedSize).withStreamInfo("crc32",this.crc32).withStreamInfo("compression",this.compression)}},l.createWorkerFrom=function(c,u,p){return c.pipe(new o).pipe(new a("uncompressedSize")).pipe(u.compressWorker(p)).pipe(new a("compressedSize")).withStreamInfo("compression",u)},s.exports=l},{"./external":6,"./stream/Crc32Probe":25,"./stream/DataLengthProbe":26,"./stream/DataWorker":27}],3:[function(e,s,i){"use strict";var r=e("./stream/GenericWorker");i.STORE={magic:"\0\0",compressWorker:function(){return new r("STORE compression")},uncompressWorker:function(){return new r("STORE decompression")}},i.DEFLATE=e("./flate")},{"./flate":7,"./stream/GenericWorker":28}],4:[function(e,s,i){"use strict";var r=e("./utils"),n=function(){for(var o,a=[],l=0;l<256;l++){o=l;for(var c=0;c<8;c++)o=1&o?3988292384^o>>>1:o>>>1;a[l]=o}return a}();s.exports=function(o,a){return o!==void 0&&o.length?r.getTypeOf(o)!=="string"?function(l,c,u,p){var d=n,E=p+u;l^=-1;for(var m=p;m<E;m++)l=l>>>8^d[255&(l^c[m])];return-1^l}(0|a,o,o.length,0):function(l,c,u,p){var d=n,E=p+u;l^=-1;for(var m=p;m<E;m++)l=l>>>8^d[255&(l^c.charCodeAt(m))];return-1^l}(0|a,o,o.length,0):0}},{"./utils":32}],5:[function(e,s,i){"use strict";i.base64=!1,i.binary=!1,i.dir=!1,i.createFolders=!0,i.date=null,i.compression=null,i.compressionOptions=null,i.comment=null,i.unixPermissions=null,i.dosPermissions=null},{}],6:[function(e,s,i){"use strict";var r=null;r=typeof Promise<"u"?Promise:e("lie"),s.exports={Promise:r}},{lie:37}],7:[function(e,s,i){"use strict";var r=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Uint32Array<"u",n=e("pako"),o=e("./utils"),a=e("./stream/GenericWorker"),l=r?"uint8array":"array";function c(u,p){a.call(this,"FlateWorker/"+u),this._pako=null,this._pakoAction=u,this._pakoOptions=p,this.meta={}}i.magic="\b\0",o.inherits(c,a),c.prototype.processChunk=function(u){this.meta=u.meta,this._pako===null&&this._createPako(),this._pako.push(o.transformTo(l,u.data),!1)},c.prototype.flush=function(){a.prototype.flush.call(this),this._pako===null&&this._createPako(),this._pako.push([],!0)},c.prototype.cleanUp=function(){a.prototype.cleanUp.call(this),this._pako=null},c.prototype._createPako=function(){this._pako=new n[this._pakoAction]({raw:!0,level:this._pakoOptions.level||-1});var u=this;this._pako.onData=function(p){u.push({data:p,meta:u.meta})}},i.compressWorker=function(u){return new c("Deflate",u)},i.uncompressWorker=function(){return new c("Inflate",{})}},{"./stream/GenericWorker":28,"./utils":32,pako:38}],8:[function(e,s,i){"use strict";function r(d,E){var m,y="";for(m=0;m<E;m++)y+=String.fromCharCode(255&d),d>>>=8;return y}function n(d,E,m,y,C,w){var A,_,M=d.file,L=d.compression,O=w!==l.utf8encode,H=o.transformTo("string",w(M.name)),D=o.transformTo("string",l.utf8encode(M.name)),W=M.comment,et=o.transformTo("string",w(W)),b=o.transformTo("string",l.utf8encode(W)),B=D.length!==M.name.length,T=b.length!==W.length,V="",ot="",X="",ct=M.dir,Z=M.date,at={crc32:0,compressedSize:0,uncompressedSize:0};E&&!m||(at.crc32=d.crc32,at.compressedSize=d.compressedSize,at.uncompressedSize=d.uncompressedSize);var U=0;E&&(U|=8),O||!B&&!T||(U|=2048);var F=0,rt=0;ct&&(F|=16),C==="UNIX"?(rt=798,F|=function($,_t){var Nt=$;return $||(Nt=_t?16893:33204),(65535&Nt)<<16}(M.unixPermissions,ct)):(rt=20,F|=function($){return 63&($||0)}(M.dosPermissions)),A=Z.getUTCHours(),A<<=6,A|=Z.getUTCMinutes(),A<<=5,A|=Z.getUTCSeconds()/2,_=Z.getUTCFullYear()-1980,_<<=4,_|=Z.getUTCMonth()+1,_<<=5,_|=Z.getUTCDate(),B&&(ot=r(1,1)+r(c(H),4)+D,V+="up"+r(ot.length,2)+ot),T&&(X=r(1,1)+r(c(et),4)+b,V+="uc"+r(X.length,2)+X);var tt="";return tt+=`
\0`,tt+=r(U,2),tt+=L.magic,tt+=r(A,2),tt+=r(_,2),tt+=r(at.crc32,4),tt+=r(at.compressedSize,4),tt+=r(at.uncompressedSize,4),tt+=r(H.length,2),tt+=r(V.length,2),{fileRecord:u.LOCAL_FILE_HEADER+tt+H+V,dirRecord:u.CENTRAL_FILE_HEADER+r(rt,2)+tt+r(et.length,2)+"\0\0\0\0"+r(F,4)+r(y,4)+H+V+et}}var o=e("../utils"),a=e("../stream/GenericWorker"),l=e("../utf8"),c=e("../crc32"),u=e("../signature");function p(d,E,m,y){a.call(this,"ZipFileWorker"),this.bytesWritten=0,this.zipComment=E,this.zipPlatform=m,this.encodeFileName=y,this.streamFiles=d,this.accumulate=!1,this.contentBuffer=[],this.dirRecords=[],this.currentSourceOffset=0,this.entriesCount=0,this.currentFile=null,this._sources=[]}o.inherits(p,a),p.prototype.push=function(d){var E=d.meta.percent||0,m=this.entriesCount,y=this._sources.length;this.accumulate?this.contentBuffer.push(d):(this.bytesWritten+=d.data.length,a.prototype.push.call(this,{data:d.data,meta:{currentFile:this.currentFile,percent:m?(E+100*(m-y-1))/m:100}}))},p.prototype.openedSource=function(d){this.currentSourceOffset=this.bytesWritten,this.currentFile=d.file.name;var E=this.streamFiles&&!d.file.dir;if(E){var m=n(d,E,!1,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);this.push({data:m.fileRecord,meta:{percent:0}})}else this.accumulate=!0},p.prototype.closedSource=function(d){this.accumulate=!1;var E=this.streamFiles&&!d.file.dir,m=n(d,E,!0,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);if(this.dirRecords.push(m.dirRecord),E)this.push({data:function(y){return u.DATA_DESCRIPTOR+r(y.crc32,4)+r(y.compressedSize,4)+r(y.uncompressedSize,4)}(d),meta:{percent:100}});else for(this.push({data:m.fileRecord,meta:{percent:0}});this.contentBuffer.length;)this.push(this.contentBuffer.shift());this.currentFile=null},p.prototype.flush=function(){for(var d=this.bytesWritten,E=0;E<this.dirRecords.length;E++)this.push({data:this.dirRecords[E],meta:{percent:100}});var m=this.bytesWritten-d,y=function(C,w,A,_,M){var L=o.transformTo("string",M(_));return u.CENTRAL_DIRECTORY_END+"\0\0\0\0"+r(C,2)+r(C,2)+r(w,4)+r(A,4)+r(L.length,2)+L}(this.dirRecords.length,m,d,this.zipComment,this.encodeFileName);this.push({data:y,meta:{percent:100}})},p.prototype.prepareNextSource=function(){this.previous=this._sources.shift(),this.openedSource(this.previous.streamInfo),this.isPaused?this.previous.pause():this.previous.resume()},p.prototype.registerPrevious=function(d){this._sources.push(d);var E=this;return d.on("data",function(m){E.processChunk(m)}),d.on("end",function(){E.closedSource(E.previous.streamInfo),E._sources.length?E.prepareNextSource():E.end()}),d.on("error",function(m){E.error(m)}),this},p.prototype.resume=function(){return!!a.prototype.resume.call(this)&&(!this.previous&&this._sources.length?(this.prepareNextSource(),!0):this.previous||this._sources.length||this.generatedError?void 0:(this.end(),!0))},p.prototype.error=function(d){var E=this._sources;if(!a.prototype.error.call(this,d))return!1;for(var m=0;m<E.length;m++)try{E[m].error(d)}catch{}return!0},p.prototype.lock=function(){a.prototype.lock.call(this);for(var d=this._sources,E=0;E<d.length;E++)d[E].lock()},s.exports=p},{"../crc32":4,"../signature":23,"../stream/GenericWorker":28,"../utf8":31,"../utils":32}],9:[function(e,s,i){"use strict";var r=e("../compressions"),n=e("./ZipFileWorker");i.generateWorker=function(o,a,l){var c=new n(a.streamFiles,l,a.platform,a.encodeFileName),u=0;try{o.forEach(function(p,d){u++;var E=function(w,A){var _=w||A,M=r[_];if(!M)throw new Error(_+" is not a valid compression method !");return M}(d.options.compression,a.compression),m=d.options.compressionOptions||a.compressionOptions||{},y=d.dir,C=d.date;d._compressWorker(E,m).withStreamInfo("file",{name:p,dir:y,date:C,comment:d.comment||"",unixPermissions:d.unixPermissions,dosPermissions:d.dosPermissions}).pipe(c)}),c.entriesCount=u}catch(p){c.error(p)}return c}},{"../compressions":3,"./ZipFileWorker":8}],10:[function(e,s,i){"use strict";function r(){if(!(this instanceof r))return new r;if(arguments.length)throw new Error("The constructor with parameters has been removed in JSZip 3.0, please check the upgrade guide.");this.files=Object.create(null),this.comment=null,this.root="",this.clone=function(){var n=new r;for(var o in this)typeof this[o]!="function"&&(n[o]=this[o]);return n}}(r.prototype=e("./object")).loadAsync=e("./load"),r.support=e("./support"),r.defaults=e("./defaults"),r.version="3.10.1",r.loadAsync=function(n,o){return new r().loadAsync(n,o)},r.external=e("./external"),s.exports=r},{"./defaults":5,"./external":6,"./load":11,"./object":15,"./support":30}],11:[function(e,s,i){"use strict";var r=e("./utils"),n=e("./external"),o=e("./utf8"),a=e("./zipEntries"),l=e("./stream/Crc32Probe"),c=e("./nodejsUtils");function u(p){return new n.Promise(function(d,E){var m=p.decompressed.getContentWorker().pipe(new l);m.on("error",function(y){E(y)}).on("end",function(){m.streamInfo.crc32!==p.decompressed.crc32?E(new Error("Corrupted zip : CRC32 mismatch")):d()}).resume()})}s.exports=function(p,d){var E=this;return d=r.extend(d||{},{base64:!1,checkCRC32:!1,optimizedBinaryString:!1,createFolders:!1,decodeFileName:o.utf8decode}),c.isNode&&c.isStream(p)?n.Promise.reject(new Error("JSZip can't accept a stream when loading a zip file.")):r.prepareContent("the loaded zip file",p,!0,d.optimizedBinaryString,d.base64).then(function(m){var y=new a(d);return y.load(m),y}).then(function(m){var y=[n.Promise.resolve(m)],C=m.files;if(d.checkCRC32)for(var w=0;w<C.length;w++)y.push(u(C[w]));return n.Promise.all(y)}).then(function(m){for(var y=m.shift(),C=y.files,w=0;w<C.length;w++){var A=C[w],_=A.fileNameStr,M=r.resolve(A.fileNameStr);E.file(M,A.decompressed,{binary:!0,optimizedBinaryString:!0,date:A.date,dir:A.dir,comment:A.fileCommentStr.length?A.fileCommentStr:null,unixPermissions:A.unixPermissions,dosPermissions:A.dosPermissions,createFolders:d.createFolders}),A.dir||(E.file(M).unsafeOriginalName=_)}return y.zipComment.length&&(E.comment=y.zipComment),E})}},{"./external":6,"./nodejsUtils":14,"./stream/Crc32Probe":25,"./utf8":31,"./utils":32,"./zipEntries":33}],12:[function(e,s,i){"use strict";var r=e("../utils"),n=e("../stream/GenericWorker");function o(a,l){n.call(this,"Nodejs stream input adapter for "+a),this._upstreamEnded=!1,this._bindStream(l)}r.inherits(o,n),o.prototype._bindStream=function(a){var l=this;(this._stream=a).pause(),a.on("data",function(c){l.push({data:c,meta:{percent:0}})}).on("error",function(c){l.isPaused?this.generatedError=c:l.error(c)}).on("end",function(){l.isPaused?l._upstreamEnded=!0:l.end()})},o.prototype.pause=function(){return!!n.prototype.pause.call(this)&&(this._stream.pause(),!0)},o.prototype.resume=function(){return!!n.prototype.resume.call(this)&&(this._upstreamEnded?this.end():this._stream.resume(),!0)},s.exports=o},{"../stream/GenericWorker":28,"../utils":32}],13:[function(e,s,i){"use strict";var r=e("readable-stream").Readable;function n(o,a,l){r.call(this,a),this._helper=o;var c=this;o.on("data",function(u,p){c.push(u)||c._helper.pause(),l&&l(p)}).on("error",function(u){c.emit("error",u)}).on("end",function(){c.push(null)})}e("../utils").inherits(n,r),n.prototype._read=function(){this._helper.resume()},s.exports=n},{"../utils":32,"readable-stream":16}],14:[function(e,s,i){"use strict";s.exports={isNode:typeof Buffer<"u",newBufferFrom:function(r,n){if(Buffer.from&&Buffer.from!==Uint8Array.from)return Buffer.from(r,n);if(typeof r=="number")throw new Error('The "data" argument must not be a number');return new Buffer(r,n)},allocBuffer:function(r){if(Buffer.alloc)return Buffer.alloc(r);var n=new Buffer(r);return n.fill(0),n},isBuffer:function(r){return Buffer.isBuffer(r)},isStream:function(r){return r&&typeof r.on=="function"&&typeof r.pause=="function"&&typeof r.resume=="function"}}},{}],15:[function(e,s,i){"use strict";function r(M,L,O){var H,D=o.getTypeOf(L),W=o.extend(O||{},c);W.date=W.date||new Date,W.compression!==null&&(W.compression=W.compression.toUpperCase()),typeof W.unixPermissions=="string"&&(W.unixPermissions=parseInt(W.unixPermissions,8)),W.unixPermissions&&16384&W.unixPermissions&&(W.dir=!0),W.dosPermissions&&16&W.dosPermissions&&(W.dir=!0),W.dir&&(M=C(M)),W.createFolders&&(H=y(M))&&w.call(this,H,!0);var et=D==="string"&&W.binary===!1&&W.base64===!1;O&&O.binary!==void 0||(W.binary=!et),(L instanceof u&&L.uncompressedSize===0||W.dir||!L||L.length===0)&&(W.base64=!1,W.binary=!0,L="",W.compression="STORE",D="string");var b=null;b=L instanceof u||L instanceof a?L:E.isNode&&E.isStream(L)?new m(M,L):o.prepareContent(M,L,W.binary,W.optimizedBinaryString,W.base64);var B=new p(M,b,W);this.files[M]=B}var n=e("./utf8"),o=e("./utils"),a=e("./stream/GenericWorker"),l=e("./stream/StreamHelper"),c=e("./defaults"),u=e("./compressedObject"),p=e("./zipObject"),d=e("./generate"),E=e("./nodejsUtils"),m=e("./nodejs/NodejsStreamInputAdapter"),y=function(M){M.slice(-1)==="/"&&(M=M.substring(0,M.length-1));var L=M.lastIndexOf("/");return 0<L?M.substring(0,L):""},C=function(M){return M.slice(-1)!=="/"&&(M+="/"),M},w=function(M,L){return L=L!==void 0?L:c.createFolders,M=C(M),this.files[M]||r.call(this,M,null,{dir:!0,createFolders:L}),this.files[M]};function A(M){return Object.prototype.toString.call(M)==="[object RegExp]"}var _={load:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},forEach:function(M){var L,O,H;for(L in this.files)H=this.files[L],(O=L.slice(this.root.length,L.length))&&L.slice(0,this.root.length)===this.root&&M(O,H)},filter:function(M){var L=[];return this.forEach(function(O,H){M(O,H)&&L.push(H)}),L},file:function(M,L,O){if(arguments.length!==1)return M=this.root+M,r.call(this,M,L,O),this;if(A(M)){var H=M;return this.filter(function(W,et){return!et.dir&&H.test(W)})}var D=this.files[this.root+M];return D&&!D.dir?D:null},folder:function(M){if(!M)return this;if(A(M))return this.filter(function(D,W){return W.dir&&M.test(D)});var L=this.root+M,O=w.call(this,L),H=this.clone();return H.root=O.name,H},remove:function(M){M=this.root+M;var L=this.files[M];if(L||(M.slice(-1)!=="/"&&(M+="/"),L=this.files[M]),L&&!L.dir)delete this.files[M];else for(var O=this.filter(function(D,W){return W.name.slice(0,M.length)===M}),H=0;H<O.length;H++)delete this.files[O[H].name];return this},generate:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},generateInternalStream:function(M){var L,O={};try{if((O=o.extend(M||{},{streamFiles:!1,compression:"STORE",compressionOptions:null,type:"",platform:"DOS",comment:null,mimeType:"application/zip",encodeFileName:n.utf8encode})).type=O.type.toLowerCase(),O.compression=O.compression.toUpperCase(),O.type==="binarystring"&&(O.type="string"),!O.type)throw new Error("No output type specified.");o.checkSupport(O.type),O.platform!=="darwin"&&O.platform!=="freebsd"&&O.platform!=="linux"&&O.platform!=="sunos"||(O.platform="UNIX"),O.platform==="win32"&&(O.platform="DOS");var H=O.comment||this.comment||"";L=d.generateWorker(this,O,H)}catch(D){(L=new a("error")).error(D)}return new l(L,O.type||"string",O.mimeType)},generateAsync:function(M,L){return this.generateInternalStream(M).accumulate(L)},generateNodeStream:function(M,L){return(M=M||{}).type||(M.type="nodebuffer"),this.generateInternalStream(M).toNodejsStream(L)}};s.exports=_},{"./compressedObject":2,"./defaults":5,"./generate":9,"./nodejs/NodejsStreamInputAdapter":12,"./nodejsUtils":14,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31,"./utils":32,"./zipObject":35}],16:[function(e,s,i){"use strict";s.exports=e("stream")},{stream:void 0}],17:[function(e,s,i){"use strict";var r=e("./DataReader");function n(o){r.call(this,o);for(var a=0;a<this.data.length;a++)o[a]=255&o[a]}e("../utils").inherits(n,r),n.prototype.byteAt=function(o){return this.data[this.zero+o]},n.prototype.lastIndexOfSignature=function(o){for(var a=o.charCodeAt(0),l=o.charCodeAt(1),c=o.charCodeAt(2),u=o.charCodeAt(3),p=this.length-4;0<=p;--p)if(this.data[p]===a&&this.data[p+1]===l&&this.data[p+2]===c&&this.data[p+3]===u)return p-this.zero;return-1},n.prototype.readAndCheckSignature=function(o){var a=o.charCodeAt(0),l=o.charCodeAt(1),c=o.charCodeAt(2),u=o.charCodeAt(3),p=this.readData(4);return a===p[0]&&l===p[1]&&c===p[2]&&u===p[3]},n.prototype.readData=function(o){if(this.checkOffset(o),o===0)return[];var a=this.data.slice(this.zero+this.index,this.zero+this.index+o);return this.index+=o,a},s.exports=n},{"../utils":32,"./DataReader":18}],18:[function(e,s,i){"use strict";var r=e("../utils");function n(o){this.data=o,this.length=o.length,this.index=0,this.zero=0}n.prototype={checkOffset:function(o){this.checkIndex(this.index+o)},checkIndex:function(o){if(this.length<this.zero+o||o<0)throw new Error("End of data reached (data length = "+this.length+", asked index = "+o+"). Corrupted zip ?")},setIndex:function(o){this.checkIndex(o),this.index=o},skip:function(o){this.setIndex(this.index+o)},byteAt:function(){},readInt:function(o){var a,l=0;for(this.checkOffset(o),a=this.index+o-1;a>=this.index;a--)l=(l<<8)+this.byteAt(a);return this.index+=o,l},readString:function(o){return r.transformTo("string",this.readData(o))},readData:function(){},lastIndexOfSignature:function(){},readAndCheckSignature:function(){},readDate:function(){var o=this.readInt(4);return new Date(Date.UTC(1980+(o>>25&127),(o>>21&15)-1,o>>16&31,o>>11&31,o>>5&63,(31&o)<<1))}},s.exports=n},{"../utils":32}],19:[function(e,s,i){"use strict";var r=e("./Uint8ArrayReader");function n(o){r.call(this,o)}e("../utils").inherits(n,r),n.prototype.readData=function(o){this.checkOffset(o);var a=this.data.slice(this.zero+this.index,this.zero+this.index+o);return this.index+=o,a},s.exports=n},{"../utils":32,"./Uint8ArrayReader":21}],20:[function(e,s,i){"use strict";var r=e("./DataReader");function n(o){r.call(this,o)}e("../utils").inherits(n,r),n.prototype.byteAt=function(o){return this.data.charCodeAt(this.zero+o)},n.prototype.lastIndexOfSignature=function(o){return this.data.lastIndexOf(o)-this.zero},n.prototype.readAndCheckSignature=function(o){return o===this.readData(4)},n.prototype.readData=function(o){this.checkOffset(o);var a=this.data.slice(this.zero+this.index,this.zero+this.index+o);return this.index+=o,a},s.exports=n},{"../utils":32,"./DataReader":18}],21:[function(e,s,i){"use strict";var r=e("./ArrayReader");function n(o){r.call(this,o)}e("../utils").inherits(n,r),n.prototype.readData=function(o){if(this.checkOffset(o),o===0)return new Uint8Array(0);var a=this.data.subarray(this.zero+this.index,this.zero+this.index+o);return this.index+=o,a},s.exports=n},{"../utils":32,"./ArrayReader":17}],22:[function(e,s,i){"use strict";var r=e("../utils"),n=e("../support"),o=e("./ArrayReader"),a=e("./StringReader"),l=e("./NodeBufferReader"),c=e("./Uint8ArrayReader");s.exports=function(u){var p=r.getTypeOf(u);return r.checkSupport(p),p!=="string"||n.uint8array?p==="nodebuffer"?new l(u):n.uint8array?new c(r.transformTo("uint8array",u)):new o(r.transformTo("array",u)):new a(u)}},{"../support":30,"../utils":32,"./ArrayReader":17,"./NodeBufferReader":19,"./StringReader":20,"./Uint8ArrayReader":21}],23:[function(e,s,i){"use strict";i.LOCAL_FILE_HEADER="PK",i.CENTRAL_FILE_HEADER="PK",i.CENTRAL_DIRECTORY_END="PK",i.ZIP64_CENTRAL_DIRECTORY_LOCATOR="PK\x07",i.ZIP64_CENTRAL_DIRECTORY_END="PK",i.DATA_DESCRIPTOR="PK\x07\b"},{}],24:[function(e,s,i){"use strict";var r=e("./GenericWorker"),n=e("../utils");function o(a){r.call(this,"ConvertWorker to "+a),this.destType=a}n.inherits(o,r),o.prototype.processChunk=function(a){this.push({data:n.transformTo(this.destType,a.data),meta:a.meta})},s.exports=o},{"../utils":32,"./GenericWorker":28}],25:[function(e,s,i){"use strict";var r=e("./GenericWorker"),n=e("../crc32");function o(){r.call(this,"Crc32Probe"),this.withStreamInfo("crc32",0)}e("../utils").inherits(o,r),o.prototype.processChunk=function(a){this.streamInfo.crc32=n(a.data,this.streamInfo.crc32||0),this.push(a)},s.exports=o},{"../crc32":4,"../utils":32,"./GenericWorker":28}],26:[function(e,s,i){"use strict";var r=e("../utils"),n=e("./GenericWorker");function o(a){n.call(this,"DataLengthProbe for "+a),this.propName=a,this.withStreamInfo(a,0)}r.inherits(o,n),o.prototype.processChunk=function(a){if(a){var l=this.streamInfo[this.propName]||0;this.streamInfo[this.propName]=l+a.data.length}n.prototype.processChunk.call(this,a)},s.exports=o},{"../utils":32,"./GenericWorker":28}],27:[function(e,s,i){"use strict";var r=e("../utils"),n=e("./GenericWorker");function o(a){n.call(this,"DataWorker");var l=this;this.dataIsReady=!1,this.index=0,this.max=0,this.data=null,this.type="",this._tickScheduled=!1,a.then(function(c){l.dataIsReady=!0,l.data=c,l.max=c&&c.length||0,l.type=r.getTypeOf(c),l.isPaused||l._tickAndRepeat()},function(c){l.error(c)})}r.inherits(o,n),o.prototype.cleanUp=function(){n.prototype.cleanUp.call(this),this.data=null},o.prototype.resume=function(){return!!n.prototype.resume.call(this)&&(!this._tickScheduled&&this.dataIsReady&&(this._tickScheduled=!0,r.delay(this._tickAndRepeat,[],this)),!0)},o.prototype._tickAndRepeat=function(){this._tickScheduled=!1,this.isPaused||this.isFinished||(this._tick(),this.isFinished||(r.delay(this._tickAndRepeat,[],this),this._tickScheduled=!0))},o.prototype._tick=function(){if(this.isPaused||this.isFinished)return!1;var a=null,l=Math.min(this.max,this.index+16384);if(this.index>=this.max)return this.end();switch(this.type){case"string":a=this.data.substring(this.index,l);break;case"uint8array":a=this.data.subarray(this.index,l);break;case"array":case"nodebuffer":a=this.data.slice(this.index,l)}return this.index=l,this.push({data:a,meta:{percent:this.max?this.index/this.max*100:0}})},s.exports=o},{"../utils":32,"./GenericWorker":28}],28:[function(e,s,i){"use strict";function r(n){this.name=n||"default",this.streamInfo={},this.generatedError=null,this.extraStreamInfo={},this.isPaused=!0,this.isFinished=!1,this.isLocked=!1,this._listeners={data:[],end:[],error:[]},this.previous=null}r.prototype={push:function(n){this.emit("data",n)},end:function(){if(this.isFinished)return!1;this.flush();try{this.emit("end"),this.cleanUp(),this.isFinished=!0}catch(n){this.emit("error",n)}return!0},error:function(n){return!this.isFinished&&(this.isPaused?this.generatedError=n:(this.isFinished=!0,this.emit("error",n),this.previous&&this.previous.error(n),this.cleanUp()),!0)},on:function(n,o){return this._listeners[n].push(o),this},cleanUp:function(){this.streamInfo=this.generatedError=this.extraStreamInfo=null,this._listeners=[]},emit:function(n,o){if(this._listeners[n])for(var a=0;a<this._listeners[n].length;a++)this._listeners[n][a].call(this,o)},pipe:function(n){return n.registerPrevious(this)},registerPrevious:function(n){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.streamInfo=n.streamInfo,this.mergeStreamInfo(),this.previous=n;var o=this;return n.on("data",function(a){o.processChunk(a)}),n.on("end",function(){o.end()}),n.on("error",function(a){o.error(a)}),this},pause:function(){return!this.isPaused&&!this.isFinished&&(this.isPaused=!0,this.previous&&this.previous.pause(),!0)},resume:function(){if(!this.isPaused||this.isFinished)return!1;var n=this.isPaused=!1;return this.generatedError&&(this.error(this.generatedError),n=!0),this.previous&&this.previous.resume(),!n},flush:function(){},processChunk:function(n){this.push(n)},withStreamInfo:function(n,o){return this.extraStreamInfo[n]=o,this.mergeStreamInfo(),this},mergeStreamInfo:function(){for(var n in this.extraStreamInfo)Object.prototype.hasOwnProperty.call(this.extraStreamInfo,n)&&(this.streamInfo[n]=this.extraStreamInfo[n])},lock:function(){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.isLocked=!0,this.previous&&this.previous.lock()},toString:function(){var n="Worker "+this.name;return this.previous?this.previous+" -> "+n:n}},s.exports=r},{}],29:[function(e,s,i){"use strict";var r=e("../utils"),n=e("./ConvertWorker"),o=e("./GenericWorker"),a=e("../base64"),l=e("../support"),c=e("../external"),u=null;if(l.nodestream)try{u=e("../nodejs/NodejsStreamOutputAdapter")}catch{}function p(E,m){return new c.Promise(function(y,C){var w=[],A=E._internalType,_=E._outputType,M=E._mimeType;E.on("data",function(L,O){w.push(L),m&&m(O)}).on("error",function(L){w=[],C(L)}).on("end",function(){try{var L=function(O,H,D){switch(O){case"blob":return r.newBlob(r.transformTo("arraybuffer",H),D);case"base64":return a.encode(H);default:return r.transformTo(O,H)}}(_,function(O,H){var D,W=0,et=null,b=0;for(D=0;D<H.length;D++)b+=H[D].length;switch(O){case"string":return H.join("");case"array":return Array.prototype.concat.apply([],H);case"uint8array":for(et=new Uint8Array(b),D=0;D<H.length;D++)et.set(H[D],W),W+=H[D].length;return et;case"nodebuffer":return Buffer.concat(H);default:throw new Error("concat : unsupported type '"+O+"'")}}(A,w),M);y(L)}catch(O){C(O)}w=[]}).resume()})}function d(E,m,y){var C=m;switch(m){case"blob":case"arraybuffer":C="uint8array";break;case"base64":C="string"}try{this._internalType=C,this._outputType=m,this._mimeType=y,r.checkSupport(C),this._worker=E.pipe(new n(C)),E.lock()}catch(w){this._worker=new o("error"),this._worker.error(w)}}d.prototype={accumulate:function(E){return p(this,E)},on:function(E,m){var y=this;return E==="data"?this._worker.on(E,function(C){m.call(y,C.data,C.meta)}):this._worker.on(E,function(){r.delay(m,arguments,y)}),this},resume:function(){return r.delay(this._worker.resume,[],this._worker),this},pause:function(){return this._worker.pause(),this},toNodejsStream:function(E){if(r.checkSupport("nodestream"),this._outputType!=="nodebuffer")throw new Error(this._outputType+" is not supported by this method");return new u(this,{objectMode:this._outputType!=="nodebuffer"},E)}},s.exports=d},{"../base64":1,"../external":6,"../nodejs/NodejsStreamOutputAdapter":13,"../support":30,"../utils":32,"./ConvertWorker":24,"./GenericWorker":28}],30:[function(e,s,i){"use strict";if(i.base64=!0,i.array=!0,i.string=!0,i.arraybuffer=typeof ArrayBuffer<"u"&&typeof Uint8Array<"u",i.nodebuffer=typeof Buffer<"u",i.uint8array=typeof Uint8Array<"u",typeof ArrayBuffer>"u")i.blob=!1;else{var r=new ArrayBuffer(0);try{i.blob=new Blob([r],{type:"application/zip"}).size===0}catch{try{var n=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);n.append(r),i.blob=n.getBlob("application/zip").size===0}catch{i.blob=!1}}}try{i.nodestream=!!e("readable-stream").Readable}catch{i.nodestream=!1}},{"readable-stream":16}],31:[function(e,s,i){"use strict";for(var r=e("./utils"),n=e("./support"),o=e("./nodejsUtils"),a=e("./stream/GenericWorker"),l=new Array(256),c=0;c<256;c++)l[c]=252<=c?6:248<=c?5:240<=c?4:224<=c?3:192<=c?2:1;l[254]=l[254]=1;function u(){a.call(this,"utf-8 decode"),this.leftOver=null}function p(){a.call(this,"utf-8 encode")}i.utf8encode=function(d){return n.nodebuffer?o.newBufferFrom(d,"utf-8"):function(E){var m,y,C,w,A,_=E.length,M=0;for(w=0;w<_;w++)(64512&(y=E.charCodeAt(w)))==55296&&w+1<_&&(64512&(C=E.charCodeAt(w+1)))==56320&&(y=65536+(y-55296<<10)+(C-56320),w++),M+=y<128?1:y<2048?2:y<65536?3:4;for(m=n.uint8array?new Uint8Array(M):new Array(M),w=A=0;A<M;w++)(64512&(y=E.charCodeAt(w)))==55296&&w+1<_&&(64512&(C=E.charCodeAt(w+1)))==56320&&(y=65536+(y-55296<<10)+(C-56320),w++),y<128?m[A++]=y:(y<2048?m[A++]=192|y>>>6:(y<65536?m[A++]=224|y>>>12:(m[A++]=240|y>>>18,m[A++]=128|y>>>12&63),m[A++]=128|y>>>6&63),m[A++]=128|63&y);return m}(d)},i.utf8decode=function(d){return n.nodebuffer?r.transformTo("nodebuffer",d).toString("utf-8"):function(E){var m,y,C,w,A=E.length,_=new Array(2*A);for(m=y=0;m<A;)if((C=E[m++])<128)_[y++]=C;else if(4<(w=l[C]))_[y++]=65533,m+=w-1;else{for(C&=w===2?31:w===3?15:7;1<w&&m<A;)C=C<<6|63&E[m++],w--;1<w?_[y++]=65533:C<65536?_[y++]=C:(C-=65536,_[y++]=55296|C>>10&1023,_[y++]=56320|1023&C)}return _.length!==y&&(_.subarray?_=_.subarray(0,y):_.length=y),r.applyFromCharCode(_)}(d=r.transformTo(n.uint8array?"uint8array":"array",d))},r.inherits(u,a),u.prototype.processChunk=function(d){var E=r.transformTo(n.uint8array?"uint8array":"array",d.data);if(this.leftOver&&this.leftOver.length){if(n.uint8array){var m=E;(E=new Uint8Array(m.length+this.leftOver.length)).set(this.leftOver,0),E.set(m,this.leftOver.length)}else E=this.leftOver.concat(E);this.leftOver=null}var y=function(w,A){var _;for((A=A||w.length)>w.length&&(A=w.length),_=A-1;0<=_&&(192&w[_])==128;)_--;return _<0||_===0?A:_+l[w[_]]>A?_:A}(E),C=E;y!==E.length&&(n.uint8array?(C=E.subarray(0,y),this.leftOver=E.subarray(y,E.length)):(C=E.slice(0,y),this.leftOver=E.slice(y,E.length))),this.push({data:i.utf8decode(C),meta:d.meta})},u.prototype.flush=function(){this.leftOver&&this.leftOver.length&&(this.push({data:i.utf8decode(this.leftOver),meta:{}}),this.leftOver=null)},i.Utf8DecodeWorker=u,r.inherits(p,a),p.prototype.processChunk=function(d){this.push({data:i.utf8encode(d.data),meta:d.meta})},i.Utf8EncodeWorker=p},{"./nodejsUtils":14,"./stream/GenericWorker":28,"./support":30,"./utils":32}],32:[function(e,s,i){"use strict";var r=e("./support"),n=e("./base64"),o=e("./nodejsUtils"),a=e("./external");function l(m){return m}function c(m,y){for(var C=0;C<m.length;++C)y[C]=255&m.charCodeAt(C);return y}e("setimmediate"),i.newBlob=function(m,y){i.checkSupport("blob");try{return new Blob([m],{type:y})}catch{try{var C=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);return C.append(m),C.getBlob(y)}catch{throw new Error("Bug : can't construct the Blob.")}}};var u={stringifyByChunk:function(m,y,C){var w=[],A=0,_=m.length;if(_<=C)return String.fromCharCode.apply(null,m);for(;A<_;)y==="array"||y==="nodebuffer"?w.push(String.fromCharCode.apply(null,m.slice(A,Math.min(A+C,_)))):w.push(String.fromCharCode.apply(null,m.subarray(A,Math.min(A+C,_)))),A+=C;return w.join("")},stringifyByChar:function(m){for(var y="",C=0;C<m.length;C++)y+=String.fromCharCode(m[C]);return y},applyCanBeUsed:{uint8array:function(){try{return r.uint8array&&String.fromCharCode.apply(null,new Uint8Array(1)).length===1}catch{return!1}}(),nodebuffer:function(){try{return r.nodebuffer&&String.fromCharCode.apply(null,o.allocBuffer(1)).length===1}catch{return!1}}()}};function p(m){var y=65536,C=i.getTypeOf(m),w=!0;if(C==="uint8array"?w=u.applyCanBeUsed.uint8array:C==="nodebuffer"&&(w=u.applyCanBeUsed.nodebuffer),w)for(;1<y;)try{return u.stringifyByChunk(m,C,y)}catch{y=Math.floor(y/2)}return u.stringifyByChar(m)}function d(m,y){for(var C=0;C<m.length;C++)y[C]=m[C];return y}i.applyFromCharCode=p;var E={};E.string={string:l,array:function(m){return c(m,new Array(m.length))},arraybuffer:function(m){return E.string.uint8array(m).buffer},uint8array:function(m){return c(m,new Uint8Array(m.length))},nodebuffer:function(m){return c(m,o.allocBuffer(m.length))}},E.array={string:p,array:l,arraybuffer:function(m){return new Uint8Array(m).buffer},uint8array:function(m){return new Uint8Array(m)},nodebuffer:function(m){return o.newBufferFrom(m)}},E.arraybuffer={string:function(m){return p(new Uint8Array(m))},array:function(m){return d(new Uint8Array(m),new Array(m.byteLength))},arraybuffer:l,uint8array:function(m){return new Uint8Array(m)},nodebuffer:function(m){return o.newBufferFrom(new Uint8Array(m))}},E.uint8array={string:p,array:function(m){return d(m,new Array(m.length))},arraybuffer:function(m){return m.buffer},uint8array:l,nodebuffer:function(m){return o.newBufferFrom(m)}},E.nodebuffer={string:p,array:function(m){return d(m,new Array(m.length))},arraybuffer:function(m){return E.nodebuffer.uint8array(m).buffer},uint8array:function(m){return d(m,new Uint8Array(m.length))},nodebuffer:l},i.transformTo=function(m,y){if(y=y||"",!m)return y;i.checkSupport(m);var C=i.getTypeOf(y);return E[C][m](y)},i.resolve=function(m){for(var y=m.split("/"),C=[],w=0;w<y.length;w++){var A=y[w];A==="."||A===""&&w!==0&&w!==y.length-1||(A===".."?C.pop():C.push(A))}return C.join("/")},i.getTypeOf=function(m){return typeof m=="string"?"string":Object.prototype.toString.call(m)==="[object Array]"?"array":r.nodebuffer&&o.isBuffer(m)?"nodebuffer":r.uint8array&&m instanceof Uint8Array?"uint8array":r.arraybuffer&&m instanceof ArrayBuffer?"arraybuffer":void 0},i.checkSupport=function(m){if(!r[m.toLowerCase()])throw new Error(m+" is not supported by this platform")},i.MAX_VALUE_16BITS=65535,i.MAX_VALUE_32BITS=-1,i.pretty=function(m){var y,C,w="";for(C=0;C<(m||"").length;C++)w+="\\x"+((y=m.charCodeAt(C))<16?"0":"")+y.toString(16).toUpperCase();return w},i.delay=function(m,y,C){setImmediate(function(){m.apply(C||null,y||[])})},i.inherits=function(m,y){function C(){}C.prototype=y.prototype,m.prototype=new C},i.extend=function(){var m,y,C={};for(m=0;m<arguments.length;m++)for(y in arguments[m])Object.prototype.hasOwnProperty.call(arguments[m],y)&&C[y]===void 0&&(C[y]=arguments[m][y]);return C},i.prepareContent=function(m,y,C,w,A){return a.Promise.resolve(y).then(function(_){return r.blob&&(_ instanceof Blob||["[object File]","[object Blob]"].indexOf(Object.prototype.toString.call(_))!==-1)&&typeof FileReader<"u"?new a.Promise(function(M,L){var O=new FileReader;O.onload=function(H){M(H.target.result)},O.onerror=function(H){L(H.target.error)},O.readAsArrayBuffer(_)}):_}).then(function(_){var M=i.getTypeOf(_);return M?(M==="arraybuffer"?_=i.transformTo("uint8array",_):M==="string"&&(A?_=n.decode(_):C&&w!==!0&&(_=function(L){return c(L,r.uint8array?new Uint8Array(L.length):new Array(L.length))}(_))),_):a.Promise.reject(new Error("Can't read the data of '"+m+"'. Is it in a supported JavaScript type (String, Blob, ArrayBuffer, etc) ?"))})}},{"./base64":1,"./external":6,"./nodejsUtils":14,"./support":30,setimmediate:54}],33:[function(e,s,i){"use strict";var r=e("./reader/readerFor"),n=e("./utils"),o=e("./signature"),a=e("./zipEntry"),l=e("./support");function c(u){this.files=[],this.loadOptions=u}c.prototype={checkSignature:function(u){if(!this.reader.readAndCheckSignature(u)){this.reader.index-=4;var p=this.reader.readString(4);throw new Error("Corrupted zip or bug: unexpected signature ("+n.pretty(p)+", expected "+n.pretty(u)+")")}},isSignature:function(u,p){var d=this.reader.index;this.reader.setIndex(u);var E=this.reader.readString(4)===p;return this.reader.setIndex(d),E},readBlockEndOfCentral:function(){this.diskNumber=this.reader.readInt(2),this.diskWithCentralDirStart=this.reader.readInt(2),this.centralDirRecordsOnThisDisk=this.reader.readInt(2),this.centralDirRecords=this.reader.readInt(2),this.centralDirSize=this.reader.readInt(4),this.centralDirOffset=this.reader.readInt(4),this.zipCommentLength=this.reader.readInt(2);var u=this.reader.readData(this.zipCommentLength),p=l.uint8array?"uint8array":"array",d=n.transformTo(p,u);this.zipComment=this.loadOptions.decodeFileName(d)},readBlockZip64EndOfCentral:function(){this.zip64EndOfCentralSize=this.reader.readInt(8),this.reader.skip(4),this.diskNumber=this.reader.readInt(4),this.diskWithCentralDirStart=this.reader.readInt(4),this.centralDirRecordsOnThisDisk=this.reader.readInt(8),this.centralDirRecords=this.reader.readInt(8),this.centralDirSize=this.reader.readInt(8),this.centralDirOffset=this.reader.readInt(8),this.zip64ExtensibleData={};for(var u,p,d,E=this.zip64EndOfCentralSize-44;0<E;)u=this.reader.readInt(2),p=this.reader.readInt(4),d=this.reader.readData(p),this.zip64ExtensibleData[u]={id:u,length:p,value:d}},readBlockZip64EndOfCentralLocator:function(){if(this.diskWithZip64CentralDirStart=this.reader.readInt(4),this.relativeOffsetEndOfZip64CentralDir=this.reader.readInt(8),this.disksCount=this.reader.readInt(4),1<this.disksCount)throw new Error("Multi-volumes zip are not supported")},readLocalFiles:function(){var u,p;for(u=0;u<this.files.length;u++)p=this.files[u],this.reader.setIndex(p.localHeaderOffset),this.checkSignature(o.LOCAL_FILE_HEADER),p.readLocalPart(this.reader),p.handleUTF8(),p.processAttributes()},readCentralDir:function(){var u;for(this.reader.setIndex(this.centralDirOffset);this.reader.readAndCheckSignature(o.CENTRAL_FILE_HEADER);)(u=new a({zip64:this.zip64},this.loadOptions)).readCentralPart(this.reader),this.files.push(u);if(this.centralDirRecords!==this.files.length&&this.centralDirRecords!==0&&this.files.length===0)throw new Error("Corrupted zip or bug: expected "+this.centralDirRecords+" records in central dir, got "+this.files.length)},readEndOfCentral:function(){var u=this.reader.lastIndexOfSignature(o.CENTRAL_DIRECTORY_END);if(u<0)throw this.isSignature(0,o.LOCAL_FILE_HEADER)?new Error("Corrupted zip: can't find end of central directory"):new Error("Can't find end of central directory : is this a zip file ? If it is, see https://stuk.github.io/jszip/documentation/howto/read_zip.html");this.reader.setIndex(u);var p=u;if(this.checkSignature(o.CENTRAL_DIRECTORY_END),this.readBlockEndOfCentral(),this.diskNumber===n.MAX_VALUE_16BITS||this.diskWithCentralDirStart===n.MAX_VALUE_16BITS||this.centralDirRecordsOnThisDisk===n.MAX_VALUE_16BITS||this.centralDirRecords===n.MAX_VALUE_16BITS||this.centralDirSize===n.MAX_VALUE_32BITS||this.centralDirOffset===n.MAX_VALUE_32BITS){if(this.zip64=!0,(u=this.reader.lastIndexOfSignature(o.ZIP64_CENTRAL_DIRECTORY_LOCATOR))<0)throw new Error("Corrupted zip: can't find the ZIP64 end of central directory locator");if(this.reader.setIndex(u),this.checkSignature(o.ZIP64_CENTRAL_DIRECTORY_LOCATOR),this.readBlockZip64EndOfCentralLocator(),!this.isSignature(this.relativeOffsetEndOfZip64CentralDir,o.ZIP64_CENTRAL_DIRECTORY_END)&&(this.relativeOffsetEndOfZip64CentralDir=this.reader.lastIndexOfSignature(o.ZIP64_CENTRAL_DIRECTORY_END),this.relativeOffsetEndOfZip64CentralDir<0))throw new Error("Corrupted zip: can't find the ZIP64 end of central directory");this.reader.setIndex(this.relativeOffsetEndOfZip64CentralDir),this.checkSignature(o.ZIP64_CENTRAL_DIRECTORY_END),this.readBlockZip64EndOfCentral()}var d=this.centralDirOffset+this.centralDirSize;this.zip64&&(d+=20,d+=12+this.zip64EndOfCentralSize);var E=p-d;if(0<E)this.isSignature(p,o.CENTRAL_FILE_HEADER)||(this.reader.zero=E);else if(E<0)throw new Error("Corrupted zip: missing "+Math.abs(E)+" bytes.")},prepareReader:function(u){this.reader=r(u)},load:function(u){this.prepareReader(u),this.readEndOfCentral(),this.readCentralDir(),this.readLocalFiles()}},s.exports=c},{"./reader/readerFor":22,"./signature":23,"./support":30,"./utils":32,"./zipEntry":34}],34:[function(e,s,i){"use strict";var r=e("./reader/readerFor"),n=e("./utils"),o=e("./compressedObject"),a=e("./crc32"),l=e("./utf8"),c=e("./compressions"),u=e("./support");function p(d,E){this.options=d,this.loadOptions=E}p.prototype={isEncrypted:function(){return(1&this.bitFlag)==1},useUTF8:function(){return(2048&this.bitFlag)==2048},readLocalPart:function(d){var E,m;if(d.skip(22),this.fileNameLength=d.readInt(2),m=d.readInt(2),this.fileName=d.readData(this.fileNameLength),d.skip(m),this.compressedSize===-1||this.uncompressedSize===-1)throw new Error("Bug or corrupted zip : didn't get enough information from the central directory (compressedSize === -1 || uncompressedSize === -1)");if((E=function(y){for(var C in c)if(Object.prototype.hasOwnProperty.call(c,C)&&c[C].magic===y)return c[C];return null}(this.compressionMethod))===null)throw new Error("Corrupted zip : compression "+n.pretty(this.compressionMethod)+" unknown (inner file : "+n.transformTo("string",this.fileName)+")");this.decompressed=new o(this.compressedSize,this.uncompressedSize,this.crc32,E,d.readData(this.compressedSize))},readCentralPart:function(d){this.versionMadeBy=d.readInt(2),d.skip(2),this.bitFlag=d.readInt(2),this.compressionMethod=d.readString(2),this.date=d.readDate(),this.crc32=d.readInt(4),this.compressedSize=d.readInt(4),this.uncompressedSize=d.readInt(4);var E=d.readInt(2);if(this.extraFieldsLength=d.readInt(2),this.fileCommentLength=d.readInt(2),this.diskNumberStart=d.readInt(2),this.internalFileAttributes=d.readInt(2),this.externalFileAttributes=d.readInt(4),this.localHeaderOffset=d.readInt(4),this.isEncrypted())throw new Error("Encrypted zip are not supported");d.skip(E),this.readExtraFields(d),this.parseZIP64ExtraField(d),this.fileComment=d.readData(this.fileCommentLength)},processAttributes:function(){this.unixPermissions=null,this.dosPermissions=null;var d=this.versionMadeBy>>8;this.dir=!!(16&this.externalFileAttributes),d==0&&(this.dosPermissions=63&this.externalFileAttributes),d==3&&(this.unixPermissions=this.externalFileAttributes>>16&65535),this.dir||this.fileNameStr.slice(-1)!=="/"||(this.dir=!0)},parseZIP64ExtraField:function(){if(this.extraFields[1]){var d=r(this.extraFields[1].value);this.uncompressedSize===n.MAX_VALUE_32BITS&&(this.uncompressedSize=d.readInt(8)),this.compressedSize===n.MAX_VALUE_32BITS&&(this.compressedSize=d.readInt(8)),this.localHeaderOffset===n.MAX_VALUE_32BITS&&(this.localHeaderOffset=d.readInt(8)),this.diskNumberStart===n.MAX_VALUE_32BITS&&(this.diskNumberStart=d.readInt(4))}},readExtraFields:function(d){var E,m,y,C=d.index+this.extraFieldsLength;for(this.extraFields||(this.extraFields={});d.index+4<C;)E=d.readInt(2),m=d.readInt(2),y=d.readData(m),this.extraFields[E]={id:E,length:m,value:y};d.setIndex(C)},handleUTF8:function(){var d=u.uint8array?"uint8array":"array";if(this.useUTF8())this.fileNameStr=l.utf8decode(this.fileName),this.fileCommentStr=l.utf8decode(this.fileComment);else{var E=this.findExtraFieldUnicodePath();if(E!==null)this.fileNameStr=E;else{var m=n.transformTo(d,this.fileName);this.fileNameStr=this.loadOptions.decodeFileName(m)}var y=this.findExtraFieldUnicodeComment();if(y!==null)this.fileCommentStr=y;else{var C=n.transformTo(d,this.fileComment);this.fileCommentStr=this.loadOptions.decodeFileName(C)}}},findExtraFieldUnicodePath:function(){var d=this.extraFields[28789];if(d){var E=r(d.value);return E.readInt(1)!==1||a(this.fileName)!==E.readInt(4)?null:l.utf8decode(E.readData(d.length-5))}return null},findExtraFieldUnicodeComment:function(){var d=this.extraFields[25461];if(d){var E=r(d.value);return E.readInt(1)!==1||a(this.fileComment)!==E.readInt(4)?null:l.utf8decode(E.readData(d.length-5))}return null}},s.exports=p},{"./compressedObject":2,"./compressions":3,"./crc32":4,"./reader/readerFor":22,"./support":30,"./utf8":31,"./utils":32}],35:[function(e,s,i){"use strict";function r(E,m,y){this.name=E,this.dir=y.dir,this.date=y.date,this.comment=y.comment,this.unixPermissions=y.unixPermissions,this.dosPermissions=y.dosPermissions,this._data=m,this._dataBinary=y.binary,this.options={compression:y.compression,compressionOptions:y.compressionOptions}}var n=e("./stream/StreamHelper"),o=e("./stream/DataWorker"),a=e("./utf8"),l=e("./compressedObject"),c=e("./stream/GenericWorker");r.prototype={internalStream:function(E){var m=null,y="string";try{if(!E)throw new Error("No output type specified.");var C=(y=E.toLowerCase())==="string"||y==="text";y!=="binarystring"&&y!=="text"||(y="string"),m=this._decompressWorker();var w=!this._dataBinary;w&&!C&&(m=m.pipe(new a.Utf8EncodeWorker)),!w&&C&&(m=m.pipe(new a.Utf8DecodeWorker))}catch(A){(m=new c("error")).error(A)}return new n(m,y,"")},async:function(E,m){return this.internalStream(E).accumulate(m)},nodeStream:function(E,m){return this.internalStream(E||"nodebuffer").toNodejsStream(m)},_compressWorker:function(E,m){if(this._data instanceof l&&this._data.compression.magic===E.magic)return this._data.getCompressedWorker();var y=this._decompressWorker();return this._dataBinary||(y=y.pipe(new a.Utf8EncodeWorker)),l.createWorkerFrom(y,E,m)},_decompressWorker:function(){return this._data instanceof l?this._data.getContentWorker():this._data instanceof c?this._data:new o(this._data)}};for(var u=["asText","asBinary","asNodeBuffer","asUint8Array","asArrayBuffer"],p=function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},d=0;d<u.length;d++)r.prototype[u[d]]=p;s.exports=r},{"./compressedObject":2,"./stream/DataWorker":27,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31}],36:[function(e,s,i){(function(r){"use strict";var n,o,a=r.MutationObserver||r.WebKitMutationObserver;if(a){var l=0,c=new a(E),u=r.document.createTextNode("");c.observe(u,{characterData:!0}),n=function(){u.data=l=++l%2}}else if(r.setImmediate||r.MessageChannel===void 0)n="document"in r&&"onreadystatechange"in r.document.createElement("script")?function(){var m=r.document.createElement("script");m.onreadystatechange=function(){E(),m.onreadystatechange=null,m.parentNode.removeChild(m),m=null},r.document.documentElement.appendChild(m)}:function(){setTimeout(E,0)};else{var p=new r.MessageChannel;p.port1.onmessage=E,n=function(){p.port2.postMessage(0)}}var d=[];function E(){var m,y;o=!0;for(var C=d.length;C;){for(y=d,d=[],m=-1;++m<C;)y[m]();C=d.length}o=!1}s.exports=function(m){d.push(m)!==1||o||n()}}).call(this,typeof Gs<"u"?Gs:typeof self<"u"?self:typeof window<"u"?window:{})},{}],37:[function(e,s,i){"use strict";var r=e("immediate");function n(){}var o={},a=["REJECTED"],l=["FULFILLED"],c=["PENDING"];function u(C){if(typeof C!="function")throw new TypeError("resolver must be a function");this.state=c,this.queue=[],this.outcome=void 0,C!==n&&m(this,C)}function p(C,w,A){this.promise=C,typeof w=="function"&&(this.onFulfilled=w,this.callFulfilled=this.otherCallFulfilled),typeof A=="function"&&(this.onRejected=A,this.callRejected=this.otherCallRejected)}function d(C,w,A){r(function(){var _;try{_=w(A)}catch(M){return o.reject(C,M)}_===C?o.reject(C,new TypeError("Cannot resolve promise with itself")):o.resolve(C,_)})}function E(C){var w=C&&C.then;if(C&&(typeof C=="object"||typeof C=="function")&&typeof w=="function")return function(){w.apply(C,arguments)}}function m(C,w){var A=!1;function _(O){A||(A=!0,o.reject(C,O))}function M(O){A||(A=!0,o.resolve(C,O))}var L=y(function(){w(M,_)});L.status==="error"&&_(L.value)}function y(C,w){var A={};try{A.value=C(w),A.status="success"}catch(_){A.status="error",A.value=_}return A}(s.exports=u).prototype.finally=function(C){if(typeof C!="function")return this;var w=this.constructor;return this.then(function(A){return w.resolve(C()).then(function(){return A})},function(A){return w.resolve(C()).then(function(){throw A})})},u.prototype.catch=function(C){return this.then(null,C)},u.prototype.then=function(C,w){if(typeof C!="function"&&this.state===l||typeof w!="function"&&this.state===a)return this;var A=new this.constructor(n);return this.state!==c?d(A,this.state===l?C:w,this.outcome):this.queue.push(new p(A,C,w)),A},p.prototype.callFulfilled=function(C){o.resolve(this.promise,C)},p.prototype.otherCallFulfilled=function(C){d(this.promise,this.onFulfilled,C)},p.prototype.callRejected=function(C){o.reject(this.promise,C)},p.prototype.otherCallRejected=function(C){d(this.promise,this.onRejected,C)},o.resolve=function(C,w){var A=y(E,w);if(A.status==="error")return o.reject(C,A.value);var _=A.value;if(_)m(C,_);else{C.state=l,C.outcome=w;for(var M=-1,L=C.queue.length;++M<L;)C.queue[M].callFulfilled(w)}return C},o.reject=function(C,w){C.state=a,C.outcome=w;for(var A=-1,_=C.queue.length;++A<_;)C.queue[A].callRejected(w);return C},u.resolve=function(C){return C instanceof this?C:o.resolve(new this(n),C)},u.reject=function(C){var w=new this(n);return o.reject(w,C)},u.all=function(C){var w=this;if(Object.prototype.toString.call(C)!=="[object Array]")return this.reject(new TypeError("must be an array"));var A=C.length,_=!1;if(!A)return this.resolve([]);for(var M=new Array(A),L=0,O=-1,H=new this(n);++O<A;)D(C[O],O);return H;function D(W,et){w.resolve(W).then(function(b){M[et]=b,++L!==A||_||(_=!0,o.resolve(H,M))},function(b){_||(_=!0,o.reject(H,b))})}},u.race=function(C){var w=this;if(Object.prototype.toString.call(C)!=="[object Array]")return this.reject(new TypeError("must be an array"));var A=C.length,_=!1;if(!A)return this.resolve([]);for(var M=-1,L=new this(n);++M<A;)O=C[M],w.resolve(O).then(function(H){_||(_=!0,o.resolve(L,H))},function(H){_||(_=!0,o.reject(L,H))});var O;return L}},{immediate:36}],38:[function(e,s,i){"use strict";var r={};(0,e("./lib/utils/common").assign)(r,e("./lib/deflate"),e("./lib/inflate"),e("./lib/zlib/constants")),s.exports=r},{"./lib/deflate":39,"./lib/inflate":40,"./lib/utils/common":41,"./lib/zlib/constants":44}],39:[function(e,s,i){"use strict";var r=e("./zlib/deflate"),n=e("./utils/common"),o=e("./utils/strings"),a=e("./zlib/messages"),l=e("./zlib/zstream"),c=Object.prototype.toString,u=0,p=-1,d=0,E=8;function m(C){if(!(this instanceof m))return new m(C);this.options=n.assign({level:p,method:E,chunkSize:16384,windowBits:15,memLevel:8,strategy:d,to:""},C||{});var w=this.options;w.raw&&0<w.windowBits?w.windowBits=-w.windowBits:w.gzip&&0<w.windowBits&&w.windowBits<16&&(w.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new l,this.strm.avail_out=0;var A=r.deflateInit2(this.strm,w.level,w.method,w.windowBits,w.memLevel,w.strategy);if(A!==u)throw new Error(a[A]);if(w.header&&r.deflateSetHeader(this.strm,w.header),w.dictionary){var _;if(_=typeof w.dictionary=="string"?o.string2buf(w.dictionary):c.call(w.dictionary)==="[object ArrayBuffer]"?new Uint8Array(w.dictionary):w.dictionary,(A=r.deflateSetDictionary(this.strm,_))!==u)throw new Error(a[A]);this._dict_set=!0}}function y(C,w){var A=new m(w);if(A.push(C,!0),A.err)throw A.msg||a[A.err];return A.result}m.prototype.push=function(C,w){var A,_,M=this.strm,L=this.options.chunkSize;if(this.ended)return!1;_=w===~~w?w:w===!0?4:0,typeof C=="string"?M.input=o.string2buf(C):c.call(C)==="[object ArrayBuffer]"?M.input=new Uint8Array(C):M.input=C,M.next_in=0,M.avail_in=M.input.length;do{if(M.avail_out===0&&(M.output=new n.Buf8(L),M.next_out=0,M.avail_out=L),(A=r.deflate(M,_))!==1&&A!==u)return this.onEnd(A),!(this.ended=!0);M.avail_out!==0&&(M.avail_in!==0||_!==4&&_!==2)||(this.options.to==="string"?this.onData(o.buf2binstring(n.shrinkBuf(M.output,M.next_out))):this.onData(n.shrinkBuf(M.output,M.next_out)))}while((0<M.avail_in||M.avail_out===0)&&A!==1);return _===4?(A=r.deflateEnd(this.strm),this.onEnd(A),this.ended=!0,A===u):_!==2||(this.onEnd(u),!(M.avail_out=0))},m.prototype.onData=function(C){this.chunks.push(C)},m.prototype.onEnd=function(C){C===u&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=n.flattenChunks(this.chunks)),this.chunks=[],this.err=C,this.msg=this.strm.msg},i.Deflate=m,i.deflate=y,i.deflateRaw=function(C,w){return(w=w||{}).raw=!0,y(C,w)},i.gzip=function(C,w){return(w=w||{}).gzip=!0,y(C,w)}},{"./utils/common":41,"./utils/strings":42,"./zlib/deflate":46,"./zlib/messages":51,"./zlib/zstream":53}],40:[function(e,s,i){"use strict";var r=e("./zlib/inflate"),n=e("./utils/common"),o=e("./utils/strings"),a=e("./zlib/constants"),l=e("./zlib/messages"),c=e("./zlib/zstream"),u=e("./zlib/gzheader"),p=Object.prototype.toString;function d(m){if(!(this instanceof d))return new d(m);this.options=n.assign({chunkSize:16384,windowBits:0,to:""},m||{});var y=this.options;y.raw&&0<=y.windowBits&&y.windowBits<16&&(y.windowBits=-y.windowBits,y.windowBits===0&&(y.windowBits=-15)),!(0<=y.windowBits&&y.windowBits<16)||m&&m.windowBits||(y.windowBits+=32),15<y.windowBits&&y.windowBits<48&&!(15&y.windowBits)&&(y.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new c,this.strm.avail_out=0;var C=r.inflateInit2(this.strm,y.windowBits);if(C!==a.Z_OK)throw new Error(l[C]);this.header=new u,r.inflateGetHeader(this.strm,this.header)}function E(m,y){var C=new d(y);if(C.push(m,!0),C.err)throw C.msg||l[C.err];return C.result}d.prototype.push=function(m,y){var C,w,A,_,M,L,O=this.strm,H=this.options.chunkSize,D=this.options.dictionary,W=!1;if(this.ended)return!1;w=y===~~y?y:y===!0?a.Z_FINISH:a.Z_NO_FLUSH,typeof m=="string"?O.input=o.binstring2buf(m):p.call(m)==="[object ArrayBuffer]"?O.input=new Uint8Array(m):O.input=m,O.next_in=0,O.avail_in=O.input.length;do{if(O.avail_out===0&&(O.output=new n.Buf8(H),O.next_out=0,O.avail_out=H),(C=r.inflate(O,a.Z_NO_FLUSH))===a.Z_NEED_DICT&&D&&(L=typeof D=="string"?o.string2buf(D):p.call(D)==="[object ArrayBuffer]"?new Uint8Array(D):D,C=r.inflateSetDictionary(this.strm,L)),C===a.Z_BUF_ERROR&&W===!0&&(C=a.Z_OK,W=!1),C!==a.Z_STREAM_END&&C!==a.Z_OK)return this.onEnd(C),!(this.ended=!0);O.next_out&&(O.avail_out!==0&&C!==a.Z_STREAM_END&&(O.avail_in!==0||w!==a.Z_FINISH&&w!==a.Z_SYNC_FLUSH)||(this.options.to==="string"?(A=o.utf8border(O.output,O.next_out),_=O.next_out-A,M=o.buf2string(O.output,A),O.next_out=_,O.avail_out=H-_,_&&n.arraySet(O.output,O.output,A,_,0),this.onData(M)):this.onData(n.shrinkBuf(O.output,O.next_out)))),O.avail_in===0&&O.avail_out===0&&(W=!0)}while((0<O.avail_in||O.avail_out===0)&&C!==a.Z_STREAM_END);return C===a.Z_STREAM_END&&(w=a.Z_FINISH),w===a.Z_FINISH?(C=r.inflateEnd(this.strm),this.onEnd(C),this.ended=!0,C===a.Z_OK):w!==a.Z_SYNC_FLUSH||(this.onEnd(a.Z_OK),!(O.avail_out=0))},d.prototype.onData=function(m){this.chunks.push(m)},d.prototype.onEnd=function(m){m===a.Z_OK&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=n.flattenChunks(this.chunks)),this.chunks=[],this.err=m,this.msg=this.strm.msg},i.Inflate=d,i.inflate=E,i.inflateRaw=function(m,y){return(y=y||{}).raw=!0,E(m,y)},i.ungzip=E},{"./utils/common":41,"./utils/strings":42,"./zlib/constants":44,"./zlib/gzheader":47,"./zlib/inflate":49,"./zlib/messages":51,"./zlib/zstream":53}],41:[function(e,s,i){"use strict";var r=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Int32Array<"u";i.assign=function(a){for(var l=Array.prototype.slice.call(arguments,1);l.length;){var c=l.shift();if(c){if(typeof c!="object")throw new TypeError(c+"must be non-object");for(var u in c)c.hasOwnProperty(u)&&(a[u]=c[u])}}return a},i.shrinkBuf=function(a,l){return a.length===l?a:a.subarray?a.subarray(0,l):(a.length=l,a)};var n={arraySet:function(a,l,c,u,p){if(l.subarray&&a.subarray)a.set(l.subarray(c,c+u),p);else for(var d=0;d<u;d++)a[p+d]=l[c+d]},flattenChunks:function(a){var l,c,u,p,d,E;for(l=u=0,c=a.length;l<c;l++)u+=a[l].length;for(E=new Uint8Array(u),l=p=0,c=a.length;l<c;l++)d=a[l],E.set(d,p),p+=d.length;return E}},o={arraySet:function(a,l,c,u,p){for(var d=0;d<u;d++)a[p+d]=l[c+d]},flattenChunks:function(a){return[].concat.apply([],a)}};i.setTyped=function(a){a?(i.Buf8=Uint8Array,i.Buf16=Uint16Array,i.Buf32=Int32Array,i.assign(i,n)):(i.Buf8=Array,i.Buf16=Array,i.Buf32=Array,i.assign(i,o))},i.setTyped(r)},{}],42:[function(e,s,i){"use strict";var r=e("./common"),n=!0,o=!0;try{String.fromCharCode.apply(null,[0])}catch{n=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{o=!1}for(var a=new r.Buf8(256),l=0;l<256;l++)a[l]=252<=l?6:248<=l?5:240<=l?4:224<=l?3:192<=l?2:1;function c(u,p){if(p<65537&&(u.subarray&&o||!u.subarray&&n))return String.fromCharCode.apply(null,r.shrinkBuf(u,p));for(var d="",E=0;E<p;E++)d+=String.fromCharCode(u[E]);return d}a[254]=a[254]=1,i.string2buf=function(u){var p,d,E,m,y,C=u.length,w=0;for(m=0;m<C;m++)(64512&(d=u.charCodeAt(m)))==55296&&m+1<C&&(64512&(E=u.charCodeAt(m+1)))==56320&&(d=65536+(d-55296<<10)+(E-56320),m++),w+=d<128?1:d<2048?2:d<65536?3:4;for(p=new r.Buf8(w),m=y=0;y<w;m++)(64512&(d=u.charCodeAt(m)))==55296&&m+1<C&&(64512&(E=u.charCodeAt(m+1)))==56320&&(d=65536+(d-55296<<10)+(E-56320),m++),d<128?p[y++]=d:(d<2048?p[y++]=192|d>>>6:(d<65536?p[y++]=224|d>>>12:(p[y++]=240|d>>>18,p[y++]=128|d>>>12&63),p[y++]=128|d>>>6&63),p[y++]=128|63&d);return p},i.buf2binstring=function(u){return c(u,u.length)},i.binstring2buf=function(u){for(var p=new r.Buf8(u.length),d=0,E=p.length;d<E;d++)p[d]=u.charCodeAt(d);return p},i.buf2string=function(u,p){var d,E,m,y,C=p||u.length,w=new Array(2*C);for(d=E=0;d<C;)if((m=u[d++])<128)w[E++]=m;else if(4<(y=a[m]))w[E++]=65533,d+=y-1;else{for(m&=y===2?31:y===3?15:7;1<y&&d<C;)m=m<<6|63&u[d++],y--;1<y?w[E++]=65533:m<65536?w[E++]=m:(m-=65536,w[E++]=55296|m>>10&1023,w[E++]=56320|1023&m)}return c(w,E)},i.utf8border=function(u,p){var d;for((p=p||u.length)>u.length&&(p=u.length),d=p-1;0<=d&&(192&u[d])==128;)d--;return d<0||d===0?p:d+a[u[d]]>p?d:p}},{"./common":41}],43:[function(e,s,i){"use strict";s.exports=function(r,n,o,a){for(var l=65535&r|0,c=r>>>16&65535|0,u=0;o!==0;){for(o-=u=2e3<o?2e3:o;c=c+(l=l+n[a++]|0)|0,--u;);l%=65521,c%=65521}return l|c<<16|0}},{}],44:[function(e,s,i){"use strict";s.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],45:[function(e,s,i){"use strict";var r=function(){for(var n,o=[],a=0;a<256;a++){n=a;for(var l=0;l<8;l++)n=1&n?3988292384^n>>>1:n>>>1;o[a]=n}return o}();s.exports=function(n,o,a,l){var c=r,u=l+a;n^=-1;for(var p=l;p<u;p++)n=n>>>8^c[255&(n^o[p])];return-1^n}},{}],46:[function(e,s,i){"use strict";var r,n=e("../utils/common"),o=e("./trees"),a=e("./adler32"),l=e("./crc32"),c=e("./messages"),u=0,p=4,d=0,E=-2,m=-1,y=4,C=2,w=8,A=9,_=286,M=30,L=19,O=2*_+1,H=15,D=3,W=258,et=W+D+1,b=42,B=113,T=1,V=2,ot=3,X=4;function ct(g,G){return g.msg=c[G],G}function Z(g){return(g<<1)-(4<g?9:0)}function at(g){for(var G=g.length;0<=--G;)g[G]=0}function U(g){var G=g.state,j=G.pending;j>g.avail_out&&(j=g.avail_out),j!==0&&(n.arraySet(g.output,G.pending_buf,G.pending_out,j,g.next_out),g.next_out+=j,G.pending_out+=j,g.total_out+=j,g.avail_out-=j,G.pending-=j,G.pending===0&&(G.pending_out=0))}function F(g,G){o._tr_flush_block(g,0<=g.block_start?g.block_start:-1,g.strstart-g.block_start,G),g.block_start=g.strstart,U(g.strm)}function rt(g,G){g.pending_buf[g.pending++]=G}function tt(g,G){g.pending_buf[g.pending++]=G>>>8&255,g.pending_buf[g.pending++]=255&G}function $(g,G){var j,S,I=g.max_chain_length,R=g.strstart,q=g.prev_length,Y=g.nice_match,N=g.strstart>g.w_size-et?g.strstart-(g.w_size-et):0,K=g.window,it=g.w_mask,J=g.prev,lt=g.strstart+W,Mt=K[R+q-1],At=K[R+q];g.prev_length>=g.good_match&&(I>>=2),Y>g.lookahead&&(Y=g.lookahead);do if(K[(j=G)+q]===At&&K[j+q-1]===Mt&&K[j]===K[R]&&K[++j]===K[R+1]){R+=2,j++;do;while(K[++R]===K[++j]&&K[++R]===K[++j]&&K[++R]===K[++j]&&K[++R]===K[++j]&&K[++R]===K[++j]&&K[++R]===K[++j]&&K[++R]===K[++j]&&K[++R]===K[++j]&&R<lt);if(S=W-(lt-R),R=lt-W,q<S){if(g.match_start=G,Y<=(q=S))break;Mt=K[R+q-1],At=K[R+q]}}while((G=J[G&it])>N&&--I!=0);return q<=g.lookahead?q:g.lookahead}function _t(g){var G,j,S,I,R,q,Y,N,K,it,J=g.w_size;do{if(I=g.window_size-g.lookahead-g.strstart,g.strstart>=J+(J-et)){for(n.arraySet(g.window,g.window,J,J,0),g.match_start-=J,g.strstart-=J,g.block_start-=J,G=j=g.hash_size;S=g.head[--G],g.head[G]=J<=S?S-J:0,--j;);for(G=j=J;S=g.prev[--G],g.prev[G]=J<=S?S-J:0,--j;);I+=J}if(g.strm.avail_in===0)break;if(q=g.strm,Y=g.window,N=g.strstart+g.lookahead,K=I,it=void 0,it=q.avail_in,K<it&&(it=K),j=it===0?0:(q.avail_in-=it,n.arraySet(Y,q.input,q.next_in,it,N),q.state.wrap===1?q.adler=a(q.adler,Y,it,N):q.state.wrap===2&&(q.adler=l(q.adler,Y,it,N)),q.next_in+=it,q.total_in+=it,it),g.lookahead+=j,g.lookahead+g.insert>=D)for(R=g.strstart-g.insert,g.ins_h=g.window[R],g.ins_h=(g.ins_h<<g.hash_shift^g.window[R+1])&g.hash_mask;g.insert&&(g.ins_h=(g.ins_h<<g.hash_shift^g.window[R+D-1])&g.hash_mask,g.prev[R&g.w_mask]=g.head[g.ins_h],g.head[g.ins_h]=R,R++,g.insert--,!(g.lookahead+g.insert<D)););}while(g.lookahead<et&&g.strm.avail_in!==0)}function Nt(g,G){for(var j,S;;){if(g.lookahead<et){if(_t(g),g.lookahead<et&&G===u)return T;if(g.lookahead===0)break}if(j=0,g.lookahead>=D&&(g.ins_h=(g.ins_h<<g.hash_shift^g.window[g.strstart+D-1])&g.hash_mask,j=g.prev[g.strstart&g.w_mask]=g.head[g.ins_h],g.head[g.ins_h]=g.strstart),j!==0&&g.strstart-j<=g.w_size-et&&(g.match_length=$(g,j)),g.match_length>=D)if(S=o._tr_tally(g,g.strstart-g.match_start,g.match_length-D),g.lookahead-=g.match_length,g.match_length<=g.max_lazy_match&&g.lookahead>=D){for(g.match_length--;g.strstart++,g.ins_h=(g.ins_h<<g.hash_shift^g.window[g.strstart+D-1])&g.hash_mask,j=g.prev[g.strstart&g.w_mask]=g.head[g.ins_h],g.head[g.ins_h]=g.strstart,--g.match_length!=0;);g.strstart++}else g.strstart+=g.match_length,g.match_length=0,g.ins_h=g.window[g.strstart],g.ins_h=(g.ins_h<<g.hash_shift^g.window[g.strstart+1])&g.hash_mask;else S=o._tr_tally(g,0,g.window[g.strstart]),g.lookahead--,g.strstart++;if(S&&(F(g,!1),g.strm.avail_out===0))return T}return g.insert=g.strstart<D-1?g.strstart:D-1,G===p?(F(g,!0),g.strm.avail_out===0?ot:X):g.last_lit&&(F(g,!1),g.strm.avail_out===0)?T:V}function pt(g,G){for(var j,S,I;;){if(g.lookahead<et){if(_t(g),g.lookahead<et&&G===u)return T;if(g.lookahead===0)break}if(j=0,g.lookahead>=D&&(g.ins_h=(g.ins_h<<g.hash_shift^g.window[g.strstart+D-1])&g.hash_mask,j=g.prev[g.strstart&g.w_mask]=g.head[g.ins_h],g.head[g.ins_h]=g.strstart),g.prev_length=g.match_length,g.prev_match=g.match_start,g.match_length=D-1,j!==0&&g.prev_length<g.max_lazy_match&&g.strstart-j<=g.w_size-et&&(g.match_length=$(g,j),g.match_length<=5&&(g.strategy===1||g.match_length===D&&4096<g.strstart-g.match_start)&&(g.match_length=D-1)),g.prev_length>=D&&g.match_length<=g.prev_length){for(I=g.strstart+g.lookahead-D,S=o._tr_tally(g,g.strstart-1-g.prev_match,g.prev_length-D),g.lookahead-=g.prev_length-1,g.prev_length-=2;++g.strstart<=I&&(g.ins_h=(g.ins_h<<g.hash_shift^g.window[g.strstart+D-1])&g.hash_mask,j=g.prev[g.strstart&g.w_mask]=g.head[g.ins_h],g.head[g.ins_h]=g.strstart),--g.prev_length!=0;);if(g.match_available=0,g.match_length=D-1,g.strstart++,S&&(F(g,!1),g.strm.avail_out===0))return T}else if(g.match_available){if((S=o._tr_tally(g,0,g.window[g.strstart-1]))&&F(g,!1),g.strstart++,g.lookahead--,g.strm.avail_out===0)return T}else g.match_available=1,g.strstart++,g.lookahead--}return g.match_available&&(S=o._tr_tally(g,0,g.window[g.strstart-1]),g.match_available=0),g.insert=g.strstart<D-1?g.strstart:D-1,G===p?(F(g,!0),g.strm.avail_out===0?ot:X):g.last_lit&&(F(g,!1),g.strm.avail_out===0)?T:V}function gt(g,G,j,S,I){this.good_length=g,this.max_lazy=G,this.nice_length=j,this.max_chain=S,this.func=I}function Ft(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=w,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new n.Buf16(2*O),this.dyn_dtree=new n.Buf16(2*(2*M+1)),this.bl_tree=new n.Buf16(2*(2*L+1)),at(this.dyn_ltree),at(this.dyn_dtree),at(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new n.Buf16(H+1),this.heap=new n.Buf16(2*_+1),at(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new n.Buf16(2*_+1),at(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function bt(g){var G;return g&&g.state?(g.total_in=g.total_out=0,g.data_type=C,(G=g.state).pending=0,G.pending_out=0,G.wrap<0&&(G.wrap=-G.wrap),G.status=G.wrap?b:B,g.adler=G.wrap===2?0:1,G.last_flush=u,o._tr_init(G),d):ct(g,E)}function le(g){var G=bt(g);return G===d&&function(j){j.window_size=2*j.w_size,at(j.head),j.max_lazy_match=r[j.level].max_lazy,j.good_match=r[j.level].good_length,j.nice_match=r[j.level].nice_length,j.max_chain_length=r[j.level].max_chain,j.strstart=0,j.block_start=0,j.lookahead=0,j.insert=0,j.match_length=j.prev_length=D-1,j.match_available=0,j.ins_h=0}(g.state),G}function Qt(g,G,j,S,I,R){if(!g)return E;var q=1;if(G===m&&(G=6),S<0?(q=0,S=-S):15<S&&(q=2,S-=16),I<1||A<I||j!==w||S<8||15<S||G<0||9<G||R<0||y<R)return ct(g,E);S===8&&(S=9);var Y=new Ft;return(g.state=Y).strm=g,Y.wrap=q,Y.gzhead=null,Y.w_bits=S,Y.w_size=1<<Y.w_bits,Y.w_mask=Y.w_size-1,Y.hash_bits=I+7,Y.hash_size=1<<Y.hash_bits,Y.hash_mask=Y.hash_size-1,Y.hash_shift=~~((Y.hash_bits+D-1)/D),Y.window=new n.Buf8(2*Y.w_size),Y.head=new n.Buf16(Y.hash_size),Y.prev=new n.Buf16(Y.w_size),Y.lit_bufsize=1<<I+6,Y.pending_buf_size=4*Y.lit_bufsize,Y.pending_buf=new n.Buf8(Y.pending_buf_size),Y.d_buf=1*Y.lit_bufsize,Y.l_buf=3*Y.lit_bufsize,Y.level=G,Y.strategy=R,Y.method=j,le(g)}r=[new gt(0,0,0,0,function(g,G){var j=65535;for(j>g.pending_buf_size-5&&(j=g.pending_buf_size-5);;){if(g.lookahead<=1){if(_t(g),g.lookahead===0&&G===u)return T;if(g.lookahead===0)break}g.strstart+=g.lookahead,g.lookahead=0;var S=g.block_start+j;if((g.strstart===0||g.strstart>=S)&&(g.lookahead=g.strstart-S,g.strstart=S,F(g,!1),g.strm.avail_out===0)||g.strstart-g.block_start>=g.w_size-et&&(F(g,!1),g.strm.avail_out===0))return T}return g.insert=0,G===p?(F(g,!0),g.strm.avail_out===0?ot:X):(g.strstart>g.block_start&&(F(g,!1),g.strm.avail_out),T)}),new gt(4,4,8,4,Nt),new gt(4,5,16,8,Nt),new gt(4,6,32,32,Nt),new gt(4,4,16,16,pt),new gt(8,16,32,32,pt),new gt(8,16,128,128,pt),new gt(8,32,128,256,pt),new gt(32,128,258,1024,pt),new gt(32,258,258,4096,pt)],i.deflateInit=function(g,G){return Qt(g,G,w,15,8,0)},i.deflateInit2=Qt,i.deflateReset=le,i.deflateResetKeep=bt,i.deflateSetHeader=function(g,G){return g&&g.state?g.state.wrap!==2?E:(g.state.gzhead=G,d):E},i.deflate=function(g,G){var j,S,I,R;if(!g||!g.state||5<G||G<0)return g?ct(g,E):E;if(S=g.state,!g.output||!g.input&&g.avail_in!==0||S.status===666&&G!==p)return ct(g,g.avail_out===0?-5:E);if(S.strm=g,j=S.last_flush,S.last_flush=G,S.status===b)if(S.wrap===2)g.adler=0,rt(S,31),rt(S,139),rt(S,8),S.gzhead?(rt(S,(S.gzhead.text?1:0)+(S.gzhead.hcrc?2:0)+(S.gzhead.extra?4:0)+(S.gzhead.name?8:0)+(S.gzhead.comment?16:0)),rt(S,255&S.gzhead.time),rt(S,S.gzhead.time>>8&255),rt(S,S.gzhead.time>>16&255),rt(S,S.gzhead.time>>24&255),rt(S,S.level===9?2:2<=S.strategy||S.level<2?4:0),rt(S,255&S.gzhead.os),S.gzhead.extra&&S.gzhead.extra.length&&(rt(S,255&S.gzhead.extra.length),rt(S,S.gzhead.extra.length>>8&255)),S.gzhead.hcrc&&(g.adler=l(g.adler,S.pending_buf,S.pending,0)),S.gzindex=0,S.status=69):(rt(S,0),rt(S,0),rt(S,0),rt(S,0),rt(S,0),rt(S,S.level===9?2:2<=S.strategy||S.level<2?4:0),rt(S,3),S.status=B);else{var q=w+(S.w_bits-8<<4)<<8;q|=(2<=S.strategy||S.level<2?0:S.level<6?1:S.level===6?2:3)<<6,S.strstart!==0&&(q|=32),q+=31-q%31,S.status=B,tt(S,q),S.strstart!==0&&(tt(S,g.adler>>>16),tt(S,65535&g.adler)),g.adler=1}if(S.status===69)if(S.gzhead.extra){for(I=S.pending;S.gzindex<(65535&S.gzhead.extra.length)&&(S.pending!==S.pending_buf_size||(S.gzhead.hcrc&&S.pending>I&&(g.adler=l(g.adler,S.pending_buf,S.pending-I,I)),U(g),I=S.pending,S.pending!==S.pending_buf_size));)rt(S,255&S.gzhead.extra[S.gzindex]),S.gzindex++;S.gzhead.hcrc&&S.pending>I&&(g.adler=l(g.adler,S.pending_buf,S.pending-I,I)),S.gzindex===S.gzhead.extra.length&&(S.gzindex=0,S.status=73)}else S.status=73;if(S.status===73)if(S.gzhead.name){I=S.pending;do{if(S.pending===S.pending_buf_size&&(S.gzhead.hcrc&&S.pending>I&&(g.adler=l(g.adler,S.pending_buf,S.pending-I,I)),U(g),I=S.pending,S.pending===S.pending_buf_size)){R=1;break}R=S.gzindex<S.gzhead.name.length?255&S.gzhead.name.charCodeAt(S.gzindex++):0,rt(S,R)}while(R!==0);S.gzhead.hcrc&&S.pending>I&&(g.adler=l(g.adler,S.pending_buf,S.pending-I,I)),R===0&&(S.gzindex=0,S.status=91)}else S.status=91;if(S.status===91)if(S.gzhead.comment){I=S.pending;do{if(S.pending===S.pending_buf_size&&(S.gzhead.hcrc&&S.pending>I&&(g.adler=l(g.adler,S.pending_buf,S.pending-I,I)),U(g),I=S.pending,S.pending===S.pending_buf_size)){R=1;break}R=S.gzindex<S.gzhead.comment.length?255&S.gzhead.comment.charCodeAt(S.gzindex++):0,rt(S,R)}while(R!==0);S.gzhead.hcrc&&S.pending>I&&(g.adler=l(g.adler,S.pending_buf,S.pending-I,I)),R===0&&(S.status=103)}else S.status=103;if(S.status===103&&(S.gzhead.hcrc?(S.pending+2>S.pending_buf_size&&U(g),S.pending+2<=S.pending_buf_size&&(rt(S,255&g.adler),rt(S,g.adler>>8&255),g.adler=0,S.status=B)):S.status=B),S.pending!==0){if(U(g),g.avail_out===0)return S.last_flush=-1,d}else if(g.avail_in===0&&Z(G)<=Z(j)&&G!==p)return ct(g,-5);if(S.status===666&&g.avail_in!==0)return ct(g,-5);if(g.avail_in!==0||S.lookahead!==0||G!==u&&S.status!==666){var Y=S.strategy===2?function(N,K){for(var it;;){if(N.lookahead===0&&(_t(N),N.lookahead===0)){if(K===u)return T;break}if(N.match_length=0,it=o._tr_tally(N,0,N.window[N.strstart]),N.lookahead--,N.strstart++,it&&(F(N,!1),N.strm.avail_out===0))return T}return N.insert=0,K===p?(F(N,!0),N.strm.avail_out===0?ot:X):N.last_lit&&(F(N,!1),N.strm.avail_out===0)?T:V}(S,G):S.strategy===3?function(N,K){for(var it,J,lt,Mt,At=N.window;;){if(N.lookahead<=W){if(_t(N),N.lookahead<=W&&K===u)return T;if(N.lookahead===0)break}if(N.match_length=0,N.lookahead>=D&&0<N.strstart&&(J=At[lt=N.strstart-1])===At[++lt]&&J===At[++lt]&&J===At[++lt]){Mt=N.strstart+W;do;while(J===At[++lt]&&J===At[++lt]&&J===At[++lt]&&J===At[++lt]&&J===At[++lt]&&J===At[++lt]&&J===At[++lt]&&J===At[++lt]&&lt<Mt);N.match_length=W-(Mt-lt),N.match_length>N.lookahead&&(N.match_length=N.lookahead)}if(N.match_length>=D?(it=o._tr_tally(N,1,N.match_length-D),N.lookahead-=N.match_length,N.strstart+=N.match_length,N.match_length=0):(it=o._tr_tally(N,0,N.window[N.strstart]),N.lookahead--,N.strstart++),it&&(F(N,!1),N.strm.avail_out===0))return T}return N.insert=0,K===p?(F(N,!0),N.strm.avail_out===0?ot:X):N.last_lit&&(F(N,!1),N.strm.avail_out===0)?T:V}(S,G):r[S.level].func(S,G);if(Y!==ot&&Y!==X||(S.status=666),Y===T||Y===ot)return g.avail_out===0&&(S.last_flush=-1),d;if(Y===V&&(G===1?o._tr_align(S):G!==5&&(o._tr_stored_block(S,0,0,!1),G===3&&(at(S.head),S.lookahead===0&&(S.strstart=0,S.block_start=0,S.insert=0))),U(g),g.avail_out===0))return S.last_flush=-1,d}return G!==p?d:S.wrap<=0?1:(S.wrap===2?(rt(S,255&g.adler),rt(S,g.adler>>8&255),rt(S,g.adler>>16&255),rt(S,g.adler>>24&255),rt(S,255&g.total_in),rt(S,g.total_in>>8&255),rt(S,g.total_in>>16&255),rt(S,g.total_in>>24&255)):(tt(S,g.adler>>>16),tt(S,65535&g.adler)),U(g),0<S.wrap&&(S.wrap=-S.wrap),S.pending!==0?d:1)},i.deflateEnd=function(g){var G;return g&&g.state?(G=g.state.status)!==b&&G!==69&&G!==73&&G!==91&&G!==103&&G!==B&&G!==666?ct(g,E):(g.state=null,G===B?ct(g,-3):d):E},i.deflateSetDictionary=function(g,G){var j,S,I,R,q,Y,N,K,it=G.length;if(!g||!g.state||(R=(j=g.state).wrap)===2||R===1&&j.status!==b||j.lookahead)return E;for(R===1&&(g.adler=a(g.adler,G,it,0)),j.wrap=0,it>=j.w_size&&(R===0&&(at(j.head),j.strstart=0,j.block_start=0,j.insert=0),K=new n.Buf8(j.w_size),n.arraySet(K,G,it-j.w_size,j.w_size,0),G=K,it=j.w_size),q=g.avail_in,Y=g.next_in,N=g.input,g.avail_in=it,g.next_in=0,g.input=G,_t(j);j.lookahead>=D;){for(S=j.strstart,I=j.lookahead-(D-1);j.ins_h=(j.ins_h<<j.hash_shift^j.window[S+D-1])&j.hash_mask,j.prev[S&j.w_mask]=j.head[j.ins_h],j.head[j.ins_h]=S,S++,--I;);j.strstart=S,j.lookahead=D-1,_t(j)}return j.strstart+=j.lookahead,j.block_start=j.strstart,j.insert=j.lookahead,j.lookahead=0,j.match_length=j.prev_length=D-1,j.match_available=0,g.next_in=Y,g.input=N,g.avail_in=q,j.wrap=R,d},i.deflateInfo="pako deflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./messages":51,"./trees":52}],47:[function(e,s,i){"use strict";s.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}},{}],48:[function(e,s,i){"use strict";s.exports=function(r,n){var o,a,l,c,u,p,d,E,m,y,C,w,A,_,M,L,O,H,D,W,et,b,B,T,V;o=r.state,a=r.next_in,T=r.input,l=a+(r.avail_in-5),c=r.next_out,V=r.output,u=c-(n-r.avail_out),p=c+(r.avail_out-257),d=o.dmax,E=o.wsize,m=o.whave,y=o.wnext,C=o.window,w=o.hold,A=o.bits,_=o.lencode,M=o.distcode,L=(1<<o.lenbits)-1,O=(1<<o.distbits)-1;t:do{A<15&&(w+=T[a++]<<A,A+=8,w+=T[a++]<<A,A+=8),H=_[w&L];e:for(;;){if(w>>>=D=H>>>24,A-=D,(D=H>>>16&255)===0)V[c++]=65535&H;else{if(!(16&D)){if(!(64&D)){H=_[(65535&H)+(w&(1<<D)-1)];continue e}if(32&D){o.mode=12;break t}r.msg="invalid literal/length code",o.mode=30;break t}W=65535&H,(D&=15)&&(A<D&&(w+=T[a++]<<A,A+=8),W+=w&(1<<D)-1,w>>>=D,A-=D),A<15&&(w+=T[a++]<<A,A+=8,w+=T[a++]<<A,A+=8),H=M[w&O];s:for(;;){if(w>>>=D=H>>>24,A-=D,!(16&(D=H>>>16&255))){if(!(64&D)){H=M[(65535&H)+(w&(1<<D)-1)];continue s}r.msg="invalid distance code",o.mode=30;break t}if(et=65535&H,A<(D&=15)&&(w+=T[a++]<<A,(A+=8)<D&&(w+=T[a++]<<A,A+=8)),d<(et+=w&(1<<D)-1)){r.msg="invalid distance too far back",o.mode=30;break t}if(w>>>=D,A-=D,(D=c-u)<et){if(m<(D=et-D)&&o.sane){r.msg="invalid distance too far back",o.mode=30;break t}if(B=C,(b=0)===y){if(b+=E-D,D<W){for(W-=D;V[c++]=C[b++],--D;);b=c-et,B=V}}else if(y<D){if(b+=E+y-D,(D-=y)<W){for(W-=D;V[c++]=C[b++],--D;);if(b=0,y<W){for(W-=D=y;V[c++]=C[b++],--D;);b=c-et,B=V}}}else if(b+=y-D,D<W){for(W-=D;V[c++]=C[b++],--D;);b=c-et,B=V}for(;2<W;)V[c++]=B[b++],V[c++]=B[b++],V[c++]=B[b++],W-=3;W&&(V[c++]=B[b++],1<W&&(V[c++]=B[b++]))}else{for(b=c-et;V[c++]=V[b++],V[c++]=V[b++],V[c++]=V[b++],2<(W-=3););W&&(V[c++]=V[b++],1<W&&(V[c++]=V[b++]))}break}}break}}while(a<l&&c<p);a-=W=A>>3,w&=(1<<(A-=W<<3))-1,r.next_in=a,r.next_out=c,r.avail_in=a<l?l-a+5:5-(a-l),r.avail_out=c<p?p-c+257:257-(c-p),o.hold=w,o.bits=A}},{}],49:[function(e,s,i){"use strict";var r=e("../utils/common"),n=e("./adler32"),o=e("./crc32"),a=e("./inffast"),l=e("./inftrees"),c=1,u=2,p=0,d=-2,E=1,m=852,y=592;function C(b){return(b>>>24&255)+(b>>>8&65280)+((65280&b)<<8)+((255&b)<<24)}function w(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new r.Buf16(320),this.work=new r.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function A(b){var B;return b&&b.state?(B=b.state,b.total_in=b.total_out=B.total=0,b.msg="",B.wrap&&(b.adler=1&B.wrap),B.mode=E,B.last=0,B.havedict=0,B.dmax=32768,B.head=null,B.hold=0,B.bits=0,B.lencode=B.lendyn=new r.Buf32(m),B.distcode=B.distdyn=new r.Buf32(y),B.sane=1,B.back=-1,p):d}function _(b){var B;return b&&b.state?((B=b.state).wsize=0,B.whave=0,B.wnext=0,A(b)):d}function M(b,B){var T,V;return b&&b.state?(V=b.state,B<0?(T=0,B=-B):(T=1+(B>>4),B<48&&(B&=15)),B&&(B<8||15<B)?d:(V.window!==null&&V.wbits!==B&&(V.window=null),V.wrap=T,V.wbits=B,_(b))):d}function L(b,B){var T,V;return b?(V=new w,(b.state=V).window=null,(T=M(b,B))!==p&&(b.state=null),T):d}var O,H,D=!0;function W(b){if(D){var B;for(O=new r.Buf32(512),H=new r.Buf32(32),B=0;B<144;)b.lens[B++]=8;for(;B<256;)b.lens[B++]=9;for(;B<280;)b.lens[B++]=7;for(;B<288;)b.lens[B++]=8;for(l(c,b.lens,0,288,O,0,b.work,{bits:9}),B=0;B<32;)b.lens[B++]=5;l(u,b.lens,0,32,H,0,b.work,{bits:5}),D=!1}b.lencode=O,b.lenbits=9,b.distcode=H,b.distbits=5}function et(b,B,T,V){var ot,X=b.state;return X.window===null&&(X.wsize=1<<X.wbits,X.wnext=0,X.whave=0,X.window=new r.Buf8(X.wsize)),V>=X.wsize?(r.arraySet(X.window,B,T-X.wsize,X.wsize,0),X.wnext=0,X.whave=X.wsize):(V<(ot=X.wsize-X.wnext)&&(ot=V),r.arraySet(X.window,B,T-V,ot,X.wnext),(V-=ot)?(r.arraySet(X.window,B,T-V,V,0),X.wnext=V,X.whave=X.wsize):(X.wnext+=ot,X.wnext===X.wsize&&(X.wnext=0),X.whave<X.wsize&&(X.whave+=ot))),0}i.inflateReset=_,i.inflateReset2=M,i.inflateResetKeep=A,i.inflateInit=function(b){return L(b,15)},i.inflateInit2=L,i.inflate=function(b,B){var T,V,ot,X,ct,Z,at,U,F,rt,tt,$,_t,Nt,pt,gt,Ft,bt,le,Qt,g,G,j,S,I=0,R=new r.Buf8(4),q=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!b||!b.state||!b.output||!b.input&&b.avail_in!==0)return d;(T=b.state).mode===12&&(T.mode=13),ct=b.next_out,ot=b.output,at=b.avail_out,X=b.next_in,V=b.input,Z=b.avail_in,U=T.hold,F=T.bits,rt=Z,tt=at,G=p;t:for(;;)switch(T.mode){case E:if(T.wrap===0){T.mode=13;break}for(;F<16;){if(Z===0)break t;Z--,U+=V[X++]<<F,F+=8}if(2&T.wrap&&U===35615){R[T.check=0]=255&U,R[1]=U>>>8&255,T.check=o(T.check,R,2,0),F=U=0,T.mode=2;break}if(T.flags=0,T.head&&(T.head.done=!1),!(1&T.wrap)||(((255&U)<<8)+(U>>8))%31){b.msg="incorrect header check",T.mode=30;break}if((15&U)!=8){b.msg="unknown compression method",T.mode=30;break}if(F-=4,g=8+(15&(U>>>=4)),T.wbits===0)T.wbits=g;else if(g>T.wbits){b.msg="invalid window size",T.mode=30;break}T.dmax=1<<g,b.adler=T.check=1,T.mode=512&U?10:12,F=U=0;break;case 2:for(;F<16;){if(Z===0)break t;Z--,U+=V[X++]<<F,F+=8}if(T.flags=U,(255&T.flags)!=8){b.msg="unknown compression method",T.mode=30;break}if(57344&T.flags){b.msg="unknown header flags set",T.mode=30;break}T.head&&(T.head.text=U>>8&1),512&T.flags&&(R[0]=255&U,R[1]=U>>>8&255,T.check=o(T.check,R,2,0)),F=U=0,T.mode=3;case 3:for(;F<32;){if(Z===0)break t;Z--,U+=V[X++]<<F,F+=8}T.head&&(T.head.time=U),512&T.flags&&(R[0]=255&U,R[1]=U>>>8&255,R[2]=U>>>16&255,R[3]=U>>>24&255,T.check=o(T.check,R,4,0)),F=U=0,T.mode=4;case 4:for(;F<16;){if(Z===0)break t;Z--,U+=V[X++]<<F,F+=8}T.head&&(T.head.xflags=255&U,T.head.os=U>>8),512&T.flags&&(R[0]=255&U,R[1]=U>>>8&255,T.check=o(T.check,R,2,0)),F=U=0,T.mode=5;case 5:if(1024&T.flags){for(;F<16;){if(Z===0)break t;Z--,U+=V[X++]<<F,F+=8}T.length=U,T.head&&(T.head.extra_len=U),512&T.flags&&(R[0]=255&U,R[1]=U>>>8&255,T.check=o(T.check,R,2,0)),F=U=0}else T.head&&(T.head.extra=null);T.mode=6;case 6:if(1024&T.flags&&(Z<($=T.length)&&($=Z),$&&(T.head&&(g=T.head.extra_len-T.length,T.head.extra||(T.head.extra=new Array(T.head.extra_len)),r.arraySet(T.head.extra,V,X,$,g)),512&T.flags&&(T.check=o(T.check,V,$,X)),Z-=$,X+=$,T.length-=$),T.length))break t;T.length=0,T.mode=7;case 7:if(2048&T.flags){if(Z===0)break t;for($=0;g=V[X+$++],T.head&&g&&T.length<65536&&(T.head.name+=String.fromCharCode(g)),g&&$<Z;);if(512&T.flags&&(T.check=o(T.check,V,$,X)),Z-=$,X+=$,g)break t}else T.head&&(T.head.name=null);T.length=0,T.mode=8;case 8:if(4096&T.flags){if(Z===0)break t;for($=0;g=V[X+$++],T.head&&g&&T.length<65536&&(T.head.comment+=String.fromCharCode(g)),g&&$<Z;);if(512&T.flags&&(T.check=o(T.check,V,$,X)),Z-=$,X+=$,g)break t}else T.head&&(T.head.comment=null);T.mode=9;case 9:if(512&T.flags){for(;F<16;){if(Z===0)break t;Z--,U+=V[X++]<<F,F+=8}if(U!==(65535&T.check)){b.msg="header crc mismatch",T.mode=30;break}F=U=0}T.head&&(T.head.hcrc=T.flags>>9&1,T.head.done=!0),b.adler=T.check=0,T.mode=12;break;case 10:for(;F<32;){if(Z===0)break t;Z--,U+=V[X++]<<F,F+=8}b.adler=T.check=C(U),F=U=0,T.mode=11;case 11:if(T.havedict===0)return b.next_out=ct,b.avail_out=at,b.next_in=X,b.avail_in=Z,T.hold=U,T.bits=F,2;b.adler=T.check=1,T.mode=12;case 12:if(B===5||B===6)break t;case 13:if(T.last){U>>>=7&F,F-=7&F,T.mode=27;break}for(;F<3;){if(Z===0)break t;Z--,U+=V[X++]<<F,F+=8}switch(T.last=1&U,F-=1,3&(U>>>=1)){case 0:T.mode=14;break;case 1:if(W(T),T.mode=20,B!==6)break;U>>>=2,F-=2;break t;case 2:T.mode=17;break;case 3:b.msg="invalid block type",T.mode=30}U>>>=2,F-=2;break;case 14:for(U>>>=7&F,F-=7&F;F<32;){if(Z===0)break t;Z--,U+=V[X++]<<F,F+=8}if((65535&U)!=(U>>>16^65535)){b.msg="invalid stored block lengths",T.mode=30;break}if(T.length=65535&U,F=U=0,T.mode=15,B===6)break t;case 15:T.mode=16;case 16:if($=T.length){if(Z<$&&($=Z),at<$&&($=at),$===0)break t;r.arraySet(ot,V,X,$,ct),Z-=$,X+=$,at-=$,ct+=$,T.length-=$;break}T.mode=12;break;case 17:for(;F<14;){if(Z===0)break t;Z--,U+=V[X++]<<F,F+=8}if(T.nlen=257+(31&U),U>>>=5,F-=5,T.ndist=1+(31&U),U>>>=5,F-=5,T.ncode=4+(15&U),U>>>=4,F-=4,286<T.nlen||30<T.ndist){b.msg="too many length or distance symbols",T.mode=30;break}T.have=0,T.mode=18;case 18:for(;T.have<T.ncode;){for(;F<3;){if(Z===0)break t;Z--,U+=V[X++]<<F,F+=8}T.lens[q[T.have++]]=7&U,U>>>=3,F-=3}for(;T.have<19;)T.lens[q[T.have++]]=0;if(T.lencode=T.lendyn,T.lenbits=7,j={bits:T.lenbits},G=l(0,T.lens,0,19,T.lencode,0,T.work,j),T.lenbits=j.bits,G){b.msg="invalid code lengths set",T.mode=30;break}T.have=0,T.mode=19;case 19:for(;T.have<T.nlen+T.ndist;){for(;gt=(I=T.lencode[U&(1<<T.lenbits)-1])>>>16&255,Ft=65535&I,!((pt=I>>>24)<=F);){if(Z===0)break t;Z--,U+=V[X++]<<F,F+=8}if(Ft<16)U>>>=pt,F-=pt,T.lens[T.have++]=Ft;else{if(Ft===16){for(S=pt+2;F<S;){if(Z===0)break t;Z--,U+=V[X++]<<F,F+=8}if(U>>>=pt,F-=pt,T.have===0){b.msg="invalid bit length repeat",T.mode=30;break}g=T.lens[T.have-1],$=3+(3&U),U>>>=2,F-=2}else if(Ft===17){for(S=pt+3;F<S;){if(Z===0)break t;Z--,U+=V[X++]<<F,F+=8}F-=pt,g=0,$=3+(7&(U>>>=pt)),U>>>=3,F-=3}else{for(S=pt+7;F<S;){if(Z===0)break t;Z--,U+=V[X++]<<F,F+=8}F-=pt,g=0,$=11+(127&(U>>>=pt)),U>>>=7,F-=7}if(T.have+$>T.nlen+T.ndist){b.msg="invalid bit length repeat",T.mode=30;break}for(;$--;)T.lens[T.have++]=g}}if(T.mode===30)break;if(T.lens[256]===0){b.msg="invalid code -- missing end-of-block",T.mode=30;break}if(T.lenbits=9,j={bits:T.lenbits},G=l(c,T.lens,0,T.nlen,T.lencode,0,T.work,j),T.lenbits=j.bits,G){b.msg="invalid literal/lengths set",T.mode=30;break}if(T.distbits=6,T.distcode=T.distdyn,j={bits:T.distbits},G=l(u,T.lens,T.nlen,T.ndist,T.distcode,0,T.work,j),T.distbits=j.bits,G){b.msg="invalid distances set",T.mode=30;break}if(T.mode=20,B===6)break t;case 20:T.mode=21;case 21:if(6<=Z&&258<=at){b.next_out=ct,b.avail_out=at,b.next_in=X,b.avail_in=Z,T.hold=U,T.bits=F,a(b,tt),ct=b.next_out,ot=b.output,at=b.avail_out,X=b.next_in,V=b.input,Z=b.avail_in,U=T.hold,F=T.bits,T.mode===12&&(T.back=-1);break}for(T.back=0;gt=(I=T.lencode[U&(1<<T.lenbits)-1])>>>16&255,Ft=65535&I,!((pt=I>>>24)<=F);){if(Z===0)break t;Z--,U+=V[X++]<<F,F+=8}if(gt&&!(240&gt)){for(bt=pt,le=gt,Qt=Ft;gt=(I=T.lencode[Qt+((U&(1<<bt+le)-1)>>bt)])>>>16&255,Ft=65535&I,!(bt+(pt=I>>>24)<=F);){if(Z===0)break t;Z--,U+=V[X++]<<F,F+=8}U>>>=bt,F-=bt,T.back+=bt}if(U>>>=pt,F-=pt,T.back+=pt,T.length=Ft,gt===0){T.mode=26;break}if(32&gt){T.back=-1,T.mode=12;break}if(64&gt){b.msg="invalid literal/length code",T.mode=30;break}T.extra=15&gt,T.mode=22;case 22:if(T.extra){for(S=T.extra;F<S;){if(Z===0)break t;Z--,U+=V[X++]<<F,F+=8}T.length+=U&(1<<T.extra)-1,U>>>=T.extra,F-=T.extra,T.back+=T.extra}T.was=T.length,T.mode=23;case 23:for(;gt=(I=T.distcode[U&(1<<T.distbits)-1])>>>16&255,Ft=65535&I,!((pt=I>>>24)<=F);){if(Z===0)break t;Z--,U+=V[X++]<<F,F+=8}if(!(240&gt)){for(bt=pt,le=gt,Qt=Ft;gt=(I=T.distcode[Qt+((U&(1<<bt+le)-1)>>bt)])>>>16&255,Ft=65535&I,!(bt+(pt=I>>>24)<=F);){if(Z===0)break t;Z--,U+=V[X++]<<F,F+=8}U>>>=bt,F-=bt,T.back+=bt}if(U>>>=pt,F-=pt,T.back+=pt,64&gt){b.msg="invalid distance code",T.mode=30;break}T.offset=Ft,T.extra=15&gt,T.mode=24;case 24:if(T.extra){for(S=T.extra;F<S;){if(Z===0)break t;Z--,U+=V[X++]<<F,F+=8}T.offset+=U&(1<<T.extra)-1,U>>>=T.extra,F-=T.extra,T.back+=T.extra}if(T.offset>T.dmax){b.msg="invalid distance too far back",T.mode=30;break}T.mode=25;case 25:if(at===0)break t;if($=tt-at,T.offset>$){if(($=T.offset-$)>T.whave&&T.sane){b.msg="invalid distance too far back",T.mode=30;break}_t=$>T.wnext?($-=T.wnext,T.wsize-$):T.wnext-$,$>T.length&&($=T.length),Nt=T.window}else Nt=ot,_t=ct-T.offset,$=T.length;for(at<$&&($=at),at-=$,T.length-=$;ot[ct++]=Nt[_t++],--$;);T.length===0&&(T.mode=21);break;case 26:if(at===0)break t;ot[ct++]=T.length,at--,T.mode=21;break;case 27:if(T.wrap){for(;F<32;){if(Z===0)break t;Z--,U|=V[X++]<<F,F+=8}if(tt-=at,b.total_out+=tt,T.total+=tt,tt&&(b.adler=T.check=T.flags?o(T.check,ot,tt,ct-tt):n(T.check,ot,tt,ct-tt)),tt=at,(T.flags?U:C(U))!==T.check){b.msg="incorrect data check",T.mode=30;break}F=U=0}T.mode=28;case 28:if(T.wrap&&T.flags){for(;F<32;){if(Z===0)break t;Z--,U+=V[X++]<<F,F+=8}if(U!==(4294967295&T.total)){b.msg="incorrect length check",T.mode=30;break}F=U=0}T.mode=29;case 29:G=1;break t;case 30:G=-3;break t;case 31:return-4;case 32:default:return d}return b.next_out=ct,b.avail_out=at,b.next_in=X,b.avail_in=Z,T.hold=U,T.bits=F,(T.wsize||tt!==b.avail_out&&T.mode<30&&(T.mode<27||B!==4))&&et(b,b.output,b.next_out,tt-b.avail_out)?(T.mode=31,-4):(rt-=b.avail_in,tt-=b.avail_out,b.total_in+=rt,b.total_out+=tt,T.total+=tt,T.wrap&&tt&&(b.adler=T.check=T.flags?o(T.check,ot,tt,b.next_out-tt):n(T.check,ot,tt,b.next_out-tt)),b.data_type=T.bits+(T.last?64:0)+(T.mode===12?128:0)+(T.mode===20||T.mode===15?256:0),(rt==0&&tt===0||B===4)&&G===p&&(G=-5),G)},i.inflateEnd=function(b){if(!b||!b.state)return d;var B=b.state;return B.window&&(B.window=null),b.state=null,p},i.inflateGetHeader=function(b,B){var T;return b&&b.state&&2&(T=b.state).wrap?((T.head=B).done=!1,p):d},i.inflateSetDictionary=function(b,B){var T,V=B.length;return b&&b.state?(T=b.state).wrap!==0&&T.mode!==11?d:T.mode===11&&n(1,B,V,0)!==T.check?-3:et(b,B,V,V)?(T.mode=31,-4):(T.havedict=1,p):d},i.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./inffast":48,"./inftrees":50}],50:[function(e,s,i){"use strict";var r=e("../utils/common"),n=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],o=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],a=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],l=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];s.exports=function(c,u,p,d,E,m,y,C){var w,A,_,M,L,O,H,D,W,et=C.bits,b=0,B=0,T=0,V=0,ot=0,X=0,ct=0,Z=0,at=0,U=0,F=null,rt=0,tt=new r.Buf16(16),$=new r.Buf16(16),_t=null,Nt=0;for(b=0;b<=15;b++)tt[b]=0;for(B=0;B<d;B++)tt[u[p+B]]++;for(ot=et,V=15;1<=V&&tt[V]===0;V--);if(V<ot&&(ot=V),V===0)return E[m++]=20971520,E[m++]=20971520,C.bits=1,0;for(T=1;T<V&&tt[T]===0;T++);for(ot<T&&(ot=T),b=Z=1;b<=15;b++)if(Z<<=1,(Z-=tt[b])<0)return-1;if(0<Z&&(c===0||V!==1))return-1;for($[1]=0,b=1;b<15;b++)$[b+1]=$[b]+tt[b];for(B=0;B<d;B++)u[p+B]!==0&&(y[$[u[p+B]]++]=B);if(O=c===0?(F=_t=y,19):c===1?(F=n,rt-=257,_t=o,Nt-=257,256):(F=a,_t=l,-1),b=T,L=m,ct=B=U=0,_=-1,M=(at=1<<(X=ot))-1,c===1&&852<at||c===2&&592<at)return 1;for(;;){for(H=b-ct,W=y[B]<O?(D=0,y[B]):y[B]>O?(D=_t[Nt+y[B]],F[rt+y[B]]):(D=96,0),w=1<<b-ct,T=A=1<<X;E[L+(U>>ct)+(A-=w)]=H<<24|D<<16|W|0,A!==0;);for(w=1<<b-1;U&w;)w>>=1;if(w!==0?(U&=w-1,U+=w):U=0,B++,--tt[b]==0){if(b===V)break;b=u[p+y[B]]}if(ot<b&&(U&M)!==_){for(ct===0&&(ct=ot),L+=T,Z=1<<(X=b-ct);X+ct<V&&!((Z-=tt[X+ct])<=0);)X++,Z<<=1;if(at+=1<<X,c===1&&852<at||c===2&&592<at)return 1;E[_=U&M]=ot<<24|X<<16|L-m|0}}return U!==0&&(E[L+U]=b-ct<<24|64<<16|0),C.bits=ot,0}},{"../utils/common":41}],51:[function(e,s,i){"use strict";s.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],52:[function(e,s,i){"use strict";var r=e("../utils/common"),n=0,o=1;function a(I){for(var R=I.length;0<=--R;)I[R]=0}var l=0,c=29,u=256,p=u+1+c,d=30,E=19,m=2*p+1,y=15,C=16,w=7,A=256,_=16,M=17,L=18,O=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],H=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],D=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],W=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],et=new Array(2*(p+2));a(et);var b=new Array(2*d);a(b);var B=new Array(512);a(B);var T=new Array(256);a(T);var V=new Array(c);a(V);var ot,X,ct,Z=new Array(d);function at(I,R,q,Y,N){this.static_tree=I,this.extra_bits=R,this.extra_base=q,this.elems=Y,this.max_length=N,this.has_stree=I&&I.length}function U(I,R){this.dyn_tree=I,this.max_code=0,this.stat_desc=R}function F(I){return I<256?B[I]:B[256+(I>>>7)]}function rt(I,R){I.pending_buf[I.pending++]=255&R,I.pending_buf[I.pending++]=R>>>8&255}function tt(I,R,q){I.bi_valid>C-q?(I.bi_buf|=R<<I.bi_valid&65535,rt(I,I.bi_buf),I.bi_buf=R>>C-I.bi_valid,I.bi_valid+=q-C):(I.bi_buf|=R<<I.bi_valid&65535,I.bi_valid+=q)}function $(I,R,q){tt(I,q[2*R],q[2*R+1])}function _t(I,R){for(var q=0;q|=1&I,I>>>=1,q<<=1,0<--R;);return q>>>1}function Nt(I,R,q){var Y,N,K=new Array(y+1),it=0;for(Y=1;Y<=y;Y++)K[Y]=it=it+q[Y-1]<<1;for(N=0;N<=R;N++){var J=I[2*N+1];J!==0&&(I[2*N]=_t(K[J]++,J))}}function pt(I){var R;for(R=0;R<p;R++)I.dyn_ltree[2*R]=0;for(R=0;R<d;R++)I.dyn_dtree[2*R]=0;for(R=0;R<E;R++)I.bl_tree[2*R]=0;I.dyn_ltree[2*A]=1,I.opt_len=I.static_len=0,I.last_lit=I.matches=0}function gt(I){8<I.bi_valid?rt(I,I.bi_buf):0<I.bi_valid&&(I.pending_buf[I.pending++]=I.bi_buf),I.bi_buf=0,I.bi_valid=0}function Ft(I,R,q,Y){var N=2*R,K=2*q;return I[N]<I[K]||I[N]===I[K]&&Y[R]<=Y[q]}function bt(I,R,q){for(var Y=I.heap[q],N=q<<1;N<=I.heap_len&&(N<I.heap_len&&Ft(R,I.heap[N+1],I.heap[N],I.depth)&&N++,!Ft(R,Y,I.heap[N],I.depth));)I.heap[q]=I.heap[N],q=N,N<<=1;I.heap[q]=Y}function le(I,R,q){var Y,N,K,it,J=0;if(I.last_lit!==0)for(;Y=I.pending_buf[I.d_buf+2*J]<<8|I.pending_buf[I.d_buf+2*J+1],N=I.pending_buf[I.l_buf+J],J++,Y===0?$(I,N,R):($(I,(K=T[N])+u+1,R),(it=O[K])!==0&&tt(I,N-=V[K],it),$(I,K=F(--Y),q),(it=H[K])!==0&&tt(I,Y-=Z[K],it)),J<I.last_lit;);$(I,A,R)}function Qt(I,R){var q,Y,N,K=R.dyn_tree,it=R.stat_desc.static_tree,J=R.stat_desc.has_stree,lt=R.stat_desc.elems,Mt=-1;for(I.heap_len=0,I.heap_max=m,q=0;q<lt;q++)K[2*q]!==0?(I.heap[++I.heap_len]=Mt=q,I.depth[q]=0):K[2*q+1]=0;for(;I.heap_len<2;)K[2*(N=I.heap[++I.heap_len]=Mt<2?++Mt:0)]=1,I.depth[N]=0,I.opt_len--,J&&(I.static_len-=it[2*N+1]);for(R.max_code=Mt,q=I.heap_len>>1;1<=q;q--)bt(I,K,q);for(N=lt;q=I.heap[1],I.heap[1]=I.heap[I.heap_len--],bt(I,K,1),Y=I.heap[1],I.heap[--I.heap_max]=q,I.heap[--I.heap_max]=Y,K[2*N]=K[2*q]+K[2*Y],I.depth[N]=(I.depth[q]>=I.depth[Y]?I.depth[q]:I.depth[Y])+1,K[2*q+1]=K[2*Y+1]=N,I.heap[1]=N++,bt(I,K,1),2<=I.heap_len;);I.heap[--I.heap_max]=I.heap[1],function(At,ue){var As,we,ws,Vt,ks,_i,be=ue.dyn_tree,vr=ue.max_code,jo=ue.stat_desc.static_tree,ko=ue.stat_desc.has_stree,Wo=ue.stat_desc.extra_bits,Ir=ue.stat_desc.extra_base,xs=ue.stat_desc.max_length,Ws=0;for(Vt=0;Vt<=y;Vt++)At.bl_count[Vt]=0;for(be[2*At.heap[At.heap_max]+1]=0,As=At.heap_max+1;As<m;As++)xs<(Vt=be[2*be[2*(we=At.heap[As])+1]+1]+1)&&(Vt=xs,Ws++),be[2*we+1]=Vt,vr<we||(At.bl_count[Vt]++,ks=0,Ir<=we&&(ks=Wo[we-Ir]),_i=be[2*we],At.opt_len+=_i*(Vt+ks),ko&&(At.static_len+=_i*(jo[2*we+1]+ks)));if(Ws!==0){do{for(Vt=xs-1;At.bl_count[Vt]===0;)Vt--;At.bl_count[Vt]--,At.bl_count[Vt+1]+=2,At.bl_count[xs]--,Ws-=2}while(0<Ws);for(Vt=xs;Vt!==0;Vt--)for(we=At.bl_count[Vt];we!==0;)vr<(ws=At.heap[--As])||(be[2*ws+1]!==Vt&&(At.opt_len+=(Vt-be[2*ws+1])*be[2*ws],be[2*ws+1]=Vt),we--)}}(I,R),Nt(K,Mt,I.bl_count)}function g(I,R,q){var Y,N,K=-1,it=R[1],J=0,lt=7,Mt=4;for(it===0&&(lt=138,Mt=3),R[2*(q+1)+1]=65535,Y=0;Y<=q;Y++)N=it,it=R[2*(Y+1)+1],++J<lt&&N===it||(J<Mt?I.bl_tree[2*N]+=J:N!==0?(N!==K&&I.bl_tree[2*N]++,I.bl_tree[2*_]++):J<=10?I.bl_tree[2*M]++:I.bl_tree[2*L]++,K=N,Mt=(J=0)===it?(lt=138,3):N===it?(lt=6,3):(lt=7,4))}function G(I,R,q){var Y,N,K=-1,it=R[1],J=0,lt=7,Mt=4;for(it===0&&(lt=138,Mt=3),Y=0;Y<=q;Y++)if(N=it,it=R[2*(Y+1)+1],!(++J<lt&&N===it)){if(J<Mt)for(;$(I,N,I.bl_tree),--J!=0;);else N!==0?(N!==K&&($(I,N,I.bl_tree),J--),$(I,_,I.bl_tree),tt(I,J-3,2)):J<=10?($(I,M,I.bl_tree),tt(I,J-3,3)):($(I,L,I.bl_tree),tt(I,J-11,7));K=N,Mt=(J=0)===it?(lt=138,3):N===it?(lt=6,3):(lt=7,4)}}a(Z);var j=!1;function S(I,R,q,Y){tt(I,(l<<1)+(Y?1:0),3),function(N,K,it,J){gt(N),J&&(rt(N,it),rt(N,~it)),r.arraySet(N.pending_buf,N.window,K,it,N.pending),N.pending+=it}(I,R,q,!0)}i._tr_init=function(I){j||(function(){var R,q,Y,N,K,it=new Array(y+1);for(N=Y=0;N<c-1;N++)for(V[N]=Y,R=0;R<1<<O[N];R++)T[Y++]=N;for(T[Y-1]=N,N=K=0;N<16;N++)for(Z[N]=K,R=0;R<1<<H[N];R++)B[K++]=N;for(K>>=7;N<d;N++)for(Z[N]=K<<7,R=0;R<1<<H[N]-7;R++)B[256+K++]=N;for(q=0;q<=y;q++)it[q]=0;for(R=0;R<=143;)et[2*R+1]=8,R++,it[8]++;for(;R<=255;)et[2*R+1]=9,R++,it[9]++;for(;R<=279;)et[2*R+1]=7,R++,it[7]++;for(;R<=287;)et[2*R+1]=8,R++,it[8]++;for(Nt(et,p+1,it),R=0;R<d;R++)b[2*R+1]=5,b[2*R]=_t(R,5);ot=new at(et,O,u+1,p,y),X=new at(b,H,0,d,y),ct=new at(new Array(0),D,0,E,w)}(),j=!0),I.l_desc=new U(I.dyn_ltree,ot),I.d_desc=new U(I.dyn_dtree,X),I.bl_desc=new U(I.bl_tree,ct),I.bi_buf=0,I.bi_valid=0,pt(I)},i._tr_stored_block=S,i._tr_flush_block=function(I,R,q,Y){var N,K,it=0;0<I.level?(I.strm.data_type===2&&(I.strm.data_type=function(J){var lt,Mt=4093624447;for(lt=0;lt<=31;lt++,Mt>>>=1)if(1&Mt&&J.dyn_ltree[2*lt]!==0)return n;if(J.dyn_ltree[18]!==0||J.dyn_ltree[20]!==0||J.dyn_ltree[26]!==0)return o;for(lt=32;lt<u;lt++)if(J.dyn_ltree[2*lt]!==0)return o;return n}(I)),Qt(I,I.l_desc),Qt(I,I.d_desc),it=function(J){var lt;for(g(J,J.dyn_ltree,J.l_desc.max_code),g(J,J.dyn_dtree,J.d_desc.max_code),Qt(J,J.bl_desc),lt=E-1;3<=lt&&J.bl_tree[2*W[lt]+1]===0;lt--);return J.opt_len+=3*(lt+1)+5+5+4,lt}(I),N=I.opt_len+3+7>>>3,(K=I.static_len+3+7>>>3)<=N&&(N=K)):N=K=q+5,q+4<=N&&R!==-1?S(I,R,q,Y):I.strategy===4||K===N?(tt(I,2+(Y?1:0),3),le(I,et,b)):(tt(I,4+(Y?1:0),3),function(J,lt,Mt,At){var ue;for(tt(J,lt-257,5),tt(J,Mt-1,5),tt(J,At-4,4),ue=0;ue<At;ue++)tt(J,J.bl_tree[2*W[ue]+1],3);G(J,J.dyn_ltree,lt-1),G(J,J.dyn_dtree,Mt-1)}(I,I.l_desc.max_code+1,I.d_desc.max_code+1,it+1),le(I,I.dyn_ltree,I.dyn_dtree)),pt(I),Y&&gt(I)},i._tr_tally=function(I,R,q){return I.pending_buf[I.d_buf+2*I.last_lit]=R>>>8&255,I.pending_buf[I.d_buf+2*I.last_lit+1]=255&R,I.pending_buf[I.l_buf+I.last_lit]=255&q,I.last_lit++,R===0?I.dyn_ltree[2*q]++:(I.matches++,R--,I.dyn_ltree[2*(T[q]+u+1)]++,I.dyn_dtree[2*F(R)]++),I.last_lit===I.lit_bufsize-1},i._tr_align=function(I){tt(I,2,3),$(I,A,et),function(R){R.bi_valid===16?(rt(R,R.bi_buf),R.bi_buf=0,R.bi_valid=0):8<=R.bi_valid&&(R.pending_buf[R.pending++]=255&R.bi_buf,R.bi_buf>>=8,R.bi_valid-=8)}(I)}},{"../utils/common":41}],53:[function(e,s,i){"use strict";s.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},{}],54:[function(e,s,i){(function(r){(function(n,o){"use strict";if(!n.setImmediate){var a,l,c,u,p=1,d={},E=!1,m=n.document,y=Object.getPrototypeOf&&Object.getPrototypeOf(n);y=y&&y.setTimeout?y:n,a={}.toString.call(n.process)==="[object process]"?function(_){process.nextTick(function(){w(_)})}:function(){if(n.postMessage&&!n.importScripts){var _=!0,M=n.onmessage;return n.onmessage=function(){_=!1},n.postMessage("","*"),n.onmessage=M,_}}()?(u="setImmediate$"+Math.random()+"$",n.addEventListener?n.addEventListener("message",A,!1):n.attachEvent("onmessage",A),function(_){n.postMessage(u+_,"*")}):n.MessageChannel?((c=new MessageChannel).port1.onmessage=function(_){w(_.data)},function(_){c.port2.postMessage(_)}):m&&"onreadystatechange"in m.createElement("script")?(l=m.documentElement,function(_){var M=m.createElement("script");M.onreadystatechange=function(){w(_),M.onreadystatechange=null,l.removeChild(M),M=null},l.appendChild(M)}):function(_){setTimeout(w,0,_)},y.setImmediate=function(_){typeof _!="function"&&(_=new Function(""+_));for(var M=new Array(arguments.length-1),L=0;L<M.length;L++)M[L]=arguments[L+1];var O={callback:_,args:M};return d[p]=O,a(p),p++},y.clearImmediate=C}function C(_){delete d[_]}function w(_){if(E)setTimeout(w,0,_);else{var M=d[_];if(M){E=!0;try{(function(L){var O=L.callback,H=L.args;switch(H.length){case 0:O();break;case 1:O(H[0]);break;case 2:O(H[0],H[1]);break;case 3:O(H[0],H[1],H[2]);break;default:O.apply(o,H)}})(M)}finally{C(_),E=!1}}}}function A(_){_.source===n&&typeof _.data=="string"&&_.data.indexOf(u)===0&&w(+_.data.slice(u.length))}})(typeof self>"u"?r===void 0?this:r:self)}).call(this,typeof Gs<"u"?Gs:typeof self<"u"?self:typeof window<"u"?window:{})},{}]},{},[10])(10)})})(si,si.exports);var zo=si.exports;const Sr=Go(zo);class qo{subscribers;constructor(){this.subscribers=[]}wait(t,e){return new Promise(s=>{this.subscribeOnce(t,e,this,i=>{s(i)})})}subscribe(t,e,s,i){this.subscribers.push({emitter:t,type:e,listener:s,once:!1,cb:i})}subscribeOnce(t,e,s,i){this.subscribers.push({emitter:t,type:e,listener:s,once:!0,cb:i})}unsubscribe(t,e,s){for(let i of this.subscribers)if(i.emitter==t&&i.type==e&&i.listener==s){this.subscribers.splice(this.subscribers.indexOf(i),1);return}}unsubscribeAll(){this.subscribers=[]}async emitAsync(t,e,s={}){const i=[];for(const r of this.subscribers.slice())if(r.emitter==t&&r.type==e){const n=r.cb.call(r.listener,s);n instanceof Promise&&i.push(n),r.once&&this.subscribers.splice(this.subscribers.indexOf(r),1)}return Promise.all(i)}emit(t,e,s={}){for(const i of this.subscribers.slice())i.emitter==t&&i.type==e&&(i.cb.call(i.listener,s),i.once&&this.subscribers.splice(this.subscribers.indexOf(i),1))}}const v=new qo;var Mn=(h=>(h[h.FIT=0]="FIT",h[h.ADJUST=1]="ADJUST",h[h.FIXED=2]="FIXED",h[h.FULL=3]="FULL",h))(Mn||{});class Xo{container;resWidth;resHeight;sizeMode;constructor(){if(this.container=document.getElementById("APP"),!this.container)throw new Error("Application::Application: APP element not found !");this.resWidth=this.container.clientWidth,this.resHeight=this.container.clientHeight,this.sizeMode=2,window.addEventListener("resize",()=>v.emit(this,"E_RESIZE"))}setSize(t,e,s=2){this.container.style.width=t+"px",this.container.style.height=e+"px",s==0?(this.container.style.transform="scale("+window.innerWidth/t+","+window.innerHeight/e+")",this.container.style.margin="0"):s==1?(this.container.style.transform="scale("+Math.min(window.innerWidth/t,window.innerHeight/e)+")",this.container.style.margin="0"):s==2?(this.container.style.transform="none",this.container.style.margin="0 auto"):s==3&&(this.container.style.width="100vw",this.container.style.height="100vh",this.container.style.margin="0"),this.resWidth=t,this.resHeight=e,this.sizeMode=s,v.emit(this,"E_RESIZE")}getSize(){return[this.container.clientWidth,this.container.clientHeight]}getResolution(){return[this.resWidth,this.resHeight]}addClass(t){this.container.classList.add(t)}removeClass(t){this.container.classList.remove(t)}toggleClass(t){this.container.classList.toggle(t)}enableScanlines(t){this.container.classList.toggle("scanlines",t)}}const Cs=new Xo,Ge=new Map;Ge.set("0","0");Ge.set("1","1");Ge.set("BtnSelect","8");Ge.set("PadTop","12");Ge.set("PadBottom","13");Ge.set("PadLeft","14");Ge.set("PadRight","15");class Yo{keyMap;actionMap;actionOnceMap;actionRegister;pads;padsInterval;mouseDown;mousePosition;mouseWheel;dragStartPosition;pointerLockEnabled;pointerLockCaptured;constructor(){this.keyMap=new Map,this.actionMap=new Map,this.actionOnceMap=new Map,this.actionRegister=new Map,this.pads=[],this.padsInterval,this.mouseDown=!1,this.mousePosition=[0,0],this.mouseWheel=0,this.dragStartPosition=[0,0],this.pointerLockEnabled=!1,this.pointerLockCaptured=!1,document.addEventListener("keydown",t=>this.#e(t)),document.addEventListener("keyup",t=>this.#s(t)),document.addEventListener("pointerdown",t=>this.#i(t)),document.addEventListener("pointerup",()=>this.#r()),document.addEventListener("pointermove",t=>this.#n(t)),document.addEventListener("wheel",t=>this.#o(t),{passive:!1}),document.addEventListener("pointerlockchange",t=>this.#a(t),!1),window.addEventListener("gamepadconnected",t=>this.#l(t)),window.addEventListener("gamepaddisconnected",t=>this.#h(t)),this.registerAction("keyboard","Enter","OK"),this.registerAction("keyboard","Escape","BACK"),this.registerAction("keyboard","Space","SELECT"),this.registerAction("keyboard","ArrowLeft","LEFT"),this.registerAction("keyboard","ArrowRight","RIGHT"),this.registerAction("keyboard","ArrowUp","UP"),this.registerAction("keyboard","ArrowDown","DOWN"),this.registerAction("gamepad0","0","OK"),this.registerAction("gamepad0","1","BACK"),this.registerAction("gamepad0","BtnSelect","SELECT"),this.registerAction("gamepad0","PadLeft","LEFT"),this.registerAction("gamepad0","PadRight","RIGHT"),this.registerAction("gamepad0","PadTop","UP"),this.registerAction("gamepad0","PadBottom","DOWN"),this.registerAction("gamepad1","0","OK"),this.registerAction("gamepad1","1","BACK"),this.registerAction("gamepad1","BtnSelect","SELECT"),this.registerAction("gamepad1","PadLeft","LEFT"),this.registerAction("gamepad1","PadRight","RIGHT"),this.registerAction("gamepad1","PadTop","UP"),this.registerAction("gamepad1","PadBottom","DOWN"),this.registerAction("gamepad2","0","OK"),this.registerAction("gamepad2","1","BACK"),this.registerAction("gamepad2","BtnSelect","SELECT"),this.registerAction("gamepad2","PadLeft","LEFT"),this.registerAction("gamepad2","PadRight","RIGHT"),this.registerAction("gamepad2","PadTop","UP"),this.registerAction("gamepad2","PadBottom","DOWN"),this.registerAction("gamepad3","0","OK"),this.registerAction("gamepad3","1","BACK"),this.registerAction("gamepad3","BtnSelect","SELECT"),this.registerAction("gamepad3","PadLeft","LEFT"),this.registerAction("gamepad3","PadRight","RIGHT"),this.registerAction("gamepad3","PadTop","UP"),this.registerAction("gamepad3","PadBottom","DOWN")}update(t){for(const e of this.actionOnceMap.keys())this.actionOnceMap.get(e)==1?this.actionOnceMap.delete(e):this.actionOnceMap.set(e,1)}registerAction(t,e,s){this.actionRegister.set(t+e,{id:s,inputSource:t,eventKey:t.startsWith("gamepad")?Ge.get(e):e})}unregisterAction(t,e){this.actionRegister.delete(t+e)}isActiveAction(t){return this.actionMap.get(t)}isJustActiveAction(t){return this.actionOnceMap.get(t)==1}isActiveActions(t){for(const e of t)if(!this.actionMap.get(e))return!1;return!0}isJustActiveActions(t){for(const e of t)if(this.actionOnceMap.get(e)!=1)return!1;return!0}isMouseDown(){return this.mouseDown}getMousePosition(){return this.mousePosition}getMouseWheel(){return this.mouseWheel}isPointerLockEnabled(){return this.pointerLockEnabled}isPointerLockCaptured(){return this.pointerLockCaptured}setPointerLockEnabled(t){this.pointerLockEnabled=t}getDragDelta(){return this.mouseDown?[this.mousePosition[0]-this.dragStartPosition[0],this.mousePosition[1]-this.dragStartPosition[1]]:[0,0]}getPad(t){return this.pads.find(e=>e.index==t)}getPadAxis(t,e){const s=this.pads.find(i=>i.index==t);return s?s.axes[e]:0}removePad(t){this.pads=this.pads.filter(e=>e.id!=t),this.pads.length<=0&&(clearInterval(this.padsInterval),this.padsInterval=void 0),v.emit(this,"E_GAMEPAD_REMOVED",{id:t})}#t(t){this.pads.push(t),this.padsInterval===null&&(this.padsInterval=setInterval(()=>this.#c(),50))}#e(t){const e=this.actionRegister.get("keyboard"+t.code);return!this.keyMap.get(t.code)&&e&&(v.emit(this,"E_ACTION_ONCE",{actionId:e.id}),this.actionMap.set(e.id,!0),this.actionOnceMap.set(e.id,0)),e&&(v.emit(this,"E_ACTION",{actionId:e.id}),this.actionMap.set(e.id,!0)),this.keyMap.set(t.code,!0),!1}#s(t){const e=this.actionRegister.get("keyboard"+t.code);e&&(v.emit(this,"E_ACTION_RELEASED",{actionId:e.id}),this.actionMap.set(e.id,!1)),this.keyMap.set(t.code,!1)}async#i(t){this.pointerLockEnabled&&!document.pointerLockElement&&await document.body.requestPointerLock(),this.mouseDown=!0,this.dragStartPosition[0]=t.clientX,this.dragStartPosition[1]=t.clientY,v.emit(this,"E_MOUSE_DOWN",{buttons:t.buttons})}#r(){this.mouseDown=!1,this.dragStartPosition[0]=0,this.dragStartPosition[1]=0,v.emit(this,"E_MOUSE_UP")}#n(t){this.pointerLockEnabled&&!this.pointerLockCaptured||(this.mouseDown=t.pointerType=="mouse"?(t.buttons&1)!==0:!0,this.mousePosition=[t.clientX,t.clientY],v.emit(this,"E_MOUSE_MOVE",{movementX:t.movementX,movementY:t.movementY}),this.mouseDown&&v.emit(this,"E_MOUSE_DRAG",{movementX:t.movementX,movementY:t.movementY}))}#o(t){this.mouseDown=(t.buttons&1)!==0,this.mouseWheel+=Math.sign(t.deltaY),v.emit(this,"E_MOUSE_WHEEL",{delta:Math.sign(t.deltaY)})}#a(t){this.pointerLockEnabled&&(document.pointerLockElement==document.body?(this.pointerLockCaptured=!0,v.emit(this,"E_POINTER_LOCK_CHANGED",{lockCaptured:!0})):(this.pointerLockCaptured=!1,v.emit(this,"E_POINTER_LOCK_CHANGED",{lockCaptured:!1})))}#h(t){this.removePad(t.gamepad.id),v.emit(this,"E_GAMEPAD_DISCONNECTED",{id:t.gamepad.id})}#l(t){const e={index:t.gamepad.index,id:t.gamepad.id,nButtons:t.gamepad.buttons.length,nAxes:t.gamepad.axes.length,axes:t.gamepad.axes,pressed:[]};for(let s=0;s<t.gamepad.buttons.length;s++)e.pressed[s]=t.gamepad.buttons[s].pressed;this.#t(e),v.emit(this,"E_GAMEPAD_CONNECTED",{id:t.gamepad.id})}#c(){const t=window.navigator,e=t.getGamepads?t.getGamepads():t.webkitGetGamepads?t.webkitGetGamepads():[];for(const s of e){if(!s)continue;const i=this.getPad(s.index);if(i!=null)for(let r=0;r<s.buttons.length;r++){if(s.buttons[r].pressed==i.pressed[r])continue;const n=this.actionRegister.get("gamepad"+s.index+r.toString());n&&(this.actionMap.set(n.id,s.buttons[r].pressed),s.buttons[r].pressed&&v.emit(this,"E_ACTION",{actionId:n.id})),this.keyMap.set("gamepad"+s.index+"-"+r,s.buttons[r].pressed),i.pressed[r]=s.buttons[r].pressed}}}}const Q=new Yo;class f{static DEG_TO_RAD_RATIO=Math.PI/180;static EPSILON=1e-7;static BIG_EPSILON=1e-4;static VEC2_SIZE=8;static VEC2_ZERO=[0,0];static VEC2_LEFT=[-1,0];static VEC2_RIGHT=[1,0];static VEC2_UP=[0,1];static VEC2_DOWN=[0,-1];static VEC2_ISO_LEFT=[0,1];static VEC2_ISO_RIGHT=[0,-1];static VEC2_ISO_FORWARD=[-1,0];static VEC2_ISO_BACKWARD=[1,0];static VEC3_SIZE=12;static VEC3_ZERO=[0,0,0];static VEC3_BACKWARD=[0,0,1];static VEC3_FORWARD=[0,0,-1];static VEC3_LEFT=[-1,0,0];static VEC3_RIGHT=[1,0,0];static VEC3_UP=[0,1,0];static VEC3_DOWN=[0,-1,0];static FAIL(t){const e=document.querySelector("#APP_FAIL");e.classList.add("SHOW"),e.textContent=t}static WAIT(t){return new Promise(e=>{window.setTimeout(()=>e(),t)})}static SHUFFLE(t){const e=t.slice();let s,i,r=e.length;if(r)for(;--r;)i=Math.floor(Math.random()*(r+1)),s=e[i],e[i]=e[r],e[r]=s;return e}static RANGE_ARRAY(t,e,s=0){return Array.from({length:(e-t)/s+1},(i,r)=>t+r*s)}static RANDARRAY(t,e){const s=[];for(let i=t;i<=e;i++)s.push(i);return f.SHUFFLE(s)}static SPREAD(t,e){return t+e*(Math.random()-.5)}static GET_RANDOM_INT(t,e){return t=Math.ceil(t),e=Math.floor(e),Math.floor(Math.random()*(e-t))+t}static GET_RANDOM_FLOAT(t,e){return Math.random()*(e-t)+t}static CLAMP(t,e,s){return Math.max(e,Math.min(s,t))}static DEG_TO_RAD(t){return t*(Math.PI/180)}static NORMALIZE_ANGLE(t){return t=t%Math.PI*2,t>Math.PI?t-=Math.PI*2:t<-Math.PI&&(t+=Math.PI*2),t}static LERP(t,e,s){return t+(e-t)*s}static LERP_EXP(t,e,s,i){return t+(e-t)*Math.pow(s,i)}static MIX(t,e,s){return t.map((i,r)=>f.LERP(i,e[r],s))}static BILINEAR_FILTER(t,e,s,i,r,n){const o=f.MIX(t,e,r),a=f.MIX(s,i,r);return f.MIX(o,a,n)}static TO_FIXED_NUMBER(t,e,s=10){const i=Math.pow(s,e);return Math.round(t*i)/i}static VEC1_COPY(t,e=[0]){return e[0]=t,e}static VEC2_CREATE(t=0,e=0){const s=new Float32Array(2);return s[0]=t,s[1]=e,s}static VEC2_PARSE(t,e=" ",s=[0,0]){const i=t.split(e);return s[0]=parseFloat(i[0]),s[1]=parseFloat(i[1]),s}static VEC2_COPY(t,e=[0,0]){return e[0]=t[0],e[1]=t[1],e}static VEC2_ISZERO(t){return Math.abs(t[0])<=f.EPSILON&&Math.abs(t[1])<=f.EPSILON}static VEC2_SPREAD(t,e){const s=[Math.random()-.5,Math.random()-.5];return f.VEC2_ADD(t,f.VEC2_MULTIPLY(e,s))}static VEC2_LERP(t,e,s,i=1){const r=f.VEC2_SUBSTRACT(e,t),n=s/i;return[t[0]+r[0]*n,t[1]+r[1]*n]}static VEC2_ROTATE_AROUND(t,e,s){const i=Math.cos(s)*e,r=Math.sin(s)*e;return[t[0]+i,t[1]+r]}static VEC2_OPPOSITE(t,e=[0,0]){return e[0]=-t[0],e[1]=-t[1],e}static VEC2_DISTANCE(t,e){const s=e[0]-t[0],i=e[1]-t[1];return Math.sqrt(s*s+i*i)}static VEC2_LENGTH(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1])}static VEC2_NORMALIZE(t,e=[0,0]){const s=f.VEC2_LENGTH(t);return s>0&&(e[0]=t[0]/s,e[1]=t[1]/s),e}static VEC2_DOT(t,e){return t[0]*e[0]+t[1]*e[1]}static VEC2_CROSS(t,e){return t[0]*e[1]-t[1]*e[0]}static VEC2_ORIENTATION(t,e,s){const i=(e[1]-t[1])*(s[0]-e[0])-(e[0]-t[0])*(s[1]-e[1]);return i==0?0:i>0?1:2}static VEC2_ADD(t,e,s=[0,0]){return s[0]=t[0]+e[0],s[1]=t[1]+e[1],s}static VEC2_SUBSTRACT(t,e,s=[0,0]){return s[0]=t[0]-e[0],s[1]=t[1]-e[1],s}static VEC2_MULTIPLY(t,e,s=[0,0]){return s[0]=t[0]*e[0],s[1]=t[1]*e[1],s}static VEC2_SCALE(t,e,s=[0,0]){return s[0]=t[0]*e,s[1]=t[1]*e,s}static VEC2_ADD_SCALED(t,e,s,i=[0,0]){return i[0]=t[0]+e[0]*s,i[1]=t[1]+e[1]*s,i}static VEC2_MIN(t,e,s=[0,0]){return s[0]=Math.min(t[0],e[0]),s[1]=Math.min(t[1],e[1]),s}static VEC2_MAX(t,e,s=[0,0]){return s[0]=Math.max(t[0],e[0]),s[1]=Math.max(t[1],e[1]),s}static VEC2_CLAMP(t,e,s,i=[0,0]){return i[0]=Math.max(e[0],Math.min(s[0],t[0])),i[1]=Math.max(e[1],Math.min(s[1],t[1])),i}static VEC2_FLOOR(t,e=[0,0]){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e}static VEC2_CEIL(t,e=[0,0]){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e}static VEC2_ANGLE_BETWEEN(t,e){return Math.acos(f.VEC2_DOT(t,e)/(f.VEC2_LENGTH(t)*f.VEC2_LENGTH(e)))}static VEC2_ANGLE(t){const e=Math.atan2(t[1],t[0]);return e>0?e:e+Math.PI*2}static VEC2_ISEQUAL(t,e){return t[0]==e[0]&&t[1]==e[1]}static VEC2_PROJECTION_COS(t,e,s=[0,0]){const i=Math.sqrt(e[0]*e[0]+e[1]*e[1]),r=(t[0]*e[0]+t[1]*e[1])/(i*i);return s[0]=e[0]*r,s[1]=e[1]*r,s}static VEC2_QUADRATIC_BEZIER(t,e,s,i,r=[0,0]){const n=t[0]+(e[0]-t[0])*i,o=t[1]+(e[1]-t[1])*i,a=e[0]+(s[0]-e[0])*i,l=e[1]+(s[1]-e[1])*i;return r[0]=n+(a-n)*i,r[1]=o+(l-o)*i,r}static VEC2_ISO_TO_2D(t){let e=(2*t[1]+t[0])*.5,s=(2*t[1]-t[0])*.5;return[e,s]}static VEC2_2D_TO_ISO(t){let e=t[0]-t[1],s=(t[0]+t[1])*.5;return[e,s]}static VEC2_ISO_CARDINAL_POINTS(t,e,s){if(t=="FORWARD"){const i=f.VEC2_2D_TO_ISO([-e*.5,0]),r=f.VEC2_2D_TO_ISO([0,s*.5]),n=f.VEC2_2D_TO_ISO([0,-s*.5]),o=f.VEC2_2D_TO_ISO([e*.5,0]);return{f:i,l:r,r:n,b:o}}if(t=="BACKWARD"){const i=f.VEC2_2D_TO_ISO([e*.5,0]),r=f.VEC2_2D_TO_ISO([0,-s*.5]),n=f.VEC2_2D_TO_ISO([0,s*.5]),o=f.VEC2_2D_TO_ISO([-e*.5,0]);return{f:i,l:r,r:n,b:o}}if(t=="LEFT"){const i=f.VEC2_2D_TO_ISO([0,e*.5]),r=f.VEC2_2D_TO_ISO([-s*.5,0]),n=f.VEC2_2D_TO_ISO([s*.5,0]),o=f.VEC2_2D_TO_ISO([0,e*.5]);return{f:i,l:r,r:n,b:o}}if(t=="RIGHT"){const i=f.VEC2_2D_TO_ISO([0,-e*.5]),r=f.VEC2_2D_TO_ISO([s*.5,0]),n=f.VEC2_2D_TO_ISO([-s*.5,0]),o=f.VEC2_2D_TO_ISO([0,e*.5]);return{f:i,l:r,r:n,b:o}}return{f:[0,0],l:[0,0],r:[0,0],b:[0,0]}}static VEC3_CREATE(t=0,e=0,s=0){const i=new Float32Array(3);return i[0]=t,i[1]=e,i[2]=s,i}static VEC3_PARSE(t,e=" ",s=[0,0,0]){const i=t.split(e);return s[0]=parseFloat(i[0]),s[1]=parseFloat(i[1]),s[2]=parseFloat(i[2]),s}static VEC3_COPY(t,e=[0,0,0]){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}static VEC3_ISZERO(t){return Math.abs(t[0])<=f.EPSILON&&Math.abs(t[1])<=f.EPSILON&&Math.abs(t[2])<=f.EPSILON}static VEC3_SPREAD(t,e){const s=f.VEC3_CREATE(Math.random()-.5,Math.random()-.5,Math.random()-.5);return f.VEC3_ADD(t,f.VEC3_MULTIPLY(e,s))}static VEC3_LERP(t,e,s,i=1){const r=f.VEC3_SUBSTRACT(e,t),n=s/i;return[t[0]+r[0]*n,t[1]+r[1]*n,t[2]+r[2]*n]}static VEC3_ROTATE_AROUND(t,e,s,i){const r=Math.cos(i)*e,n=Math.sin(i)*e,o=Math.sin(s)*r,a=Math.cos(s)*r;return[t[0]+a,t[1]+n,t[2]+o]}static VEC3_OPPOSITE(t,e=[0,0,0]){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e}static VEC3_DISTANCE(t,e){const s=e[0]-t[0],i=e[1]-t[1],r=e[2]-t[2];return Math.sqrt(s*s+i*i+r*r)}static VEC3_LENGTH(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2])}static VEC3_NORMALIZE(t,e=[0,0,0]){const s=f.VEC3_LENGTH(t);return s>0&&(e[0]=t[0]/s,e[1]=t[1]/s,e[2]=t[2]/s),e}static VEC3_DOT(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}static VEC3_CROSS(t,e,s=[0,0,0]){return s[0]=t[1]*e[2]-t[2]*e[1],s[1]=t[2]*e[0]-t[0]*e[2],s[2]=t[0]*e[1]-t[1]*e[0],s}static VEC3_ADD(t,e,s=[0,0,0]){return s[0]=t[0]+e[0],s[1]=t[1]+e[1],s[2]=t[2]+e[2],s}static VEC3_SUBSTRACT(t,e,s=[0,0,0]){return s[0]=t[0]-e[0],s[1]=t[1]-e[1],s[2]=t[2]-e[2],s}static VEC3_MULTIPLY(t,e,s=[0,0,0]){return s[0]=t[0]*e[0],s[1]=t[1]*e[1],s[2]=t[2]*e[2],s}static VEC3_SCALE(t,e,s=[0,0,0]){return s[0]=t[0]*e,s[1]=t[1]*e,s[2]=t[2]*e,s}static VEC3_ADD_SCALED(t,e,s,i=[0,0,0]){return i[0]=t[0]+e[0]*s,i[1]=t[1]+e[1]*s,i[2]=t[2]+e[2]*s,i}static VEC3_ANGLE_BETWEEN(t,e){return Math.acos(f.VEC3_DOT(t,e)/(f.VEC3_LENGTH(t)*f.VEC3_LENGTH(e)))}static VEC3_MIN(t,e,s=[0,0,0]){return s[0]=Math.min(t[0],e[0]),s[1]=Math.min(t[1],e[1]),s[2]=Math.min(t[2],e[2]),s}static VEC3_MAX(t,e,s=[0,0,0]){return s[0]=Math.max(t[0],e[0]),s[1]=Math.max(t[1],e[1]),s[2]=Math.max(t[2],e[2]),s}static VEC3_CLAMP(t,e,s,i=[0,0,0]){return i[0]=Math.max(e[0],Math.min(s[0],t[0])),i[1]=Math.max(e[1],Math.min(s[1],t[1])),i[2]=Math.max(e[2],Math.min(s[2],t[2])),i}static VEC3_FLOOR(t,e=[0,0,0]){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e}static VEC3_CEIL(t,e=[0,0,0]){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e}static VEC3_ISEQUAL(t,e){return t[0]==e[0]&&t[1]==e[1]&&t[2]==e[2]}static VEC3_QUADRATIC_BEZIER(t,e,s,i,r=[0,0,0]){const n=t[0]+(e[0]-t[0])*i,o=t[1]+(e[1]-t[1])*i,a=t[2]+(e[2]-t[2])*i,l=e[0]+(s[0]-e[0])*i,c=e[1]+(s[1]-e[1])*i,u=e[2]+(s[2]-e[2])*i;return r[0]=n+(l-n)*i,r[1]=o+(c-o)*i,r[2]=a+(u-a)*i,r}static VEC4_CREATE(t=0,e=0,s=0,i=0){const r=new Float32Array(4);return r[0]=t,r[1]=e,r[2]=s,r[3]=i,r}static VEC4_PARSE(t,e=" ",s=[0,0,0,0]){const i=t.split(e);return s[0]=parseFloat(i[0]),s[1]=parseFloat(i[1]),s[2]=parseFloat(i[2]),s[3]=1,s}static VEC4_COPY(t,e=[0,0,0,0]){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}static VEC4_ISZERO(t){return Math.abs(t[0])<=f.EPSILON&&Math.abs(t[1])<=f.EPSILON&&Math.abs(t[2])<=f.EPSILON&&Math.abs(t[3])<=f.EPSILON}static MAT3_CREATE(){const t=new Float32Array(9);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t}static MAT3_COPY(t,e){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e}static MAT3_MULTIPLY_BY_VEC3(t,e,s=[0,0,0]){const i=t[0],r=t[1],n=t[2],o=t[3],a=t[4],l=t[5],c=t[6],u=t[7],p=t[8],d=e[0],E=e[1],m=e[2];return s[0]=d*i+E*o+m*c,s[1]=d*r+E*a+m*u,s[2]=d*n+E*l+m*p,s}static MAT3_MULTIPLY(t,e,s=[0,0,0,0,0,0,0,0,0]){const i=t[0],r=t[1],n=t[2],o=t[3],a=t[4],l=t[5],c=t[6],u=t[7],p=t[8],d=e[0],E=e[1],m=e[2],y=e[3],C=e[4],w=e[5],A=e[6],_=e[7],M=e[8],L=d*i+E*o+m*c,O=d*r+E*a+m*u,H=d*n+E*l+m*p,D=y*i+C*o+w*c,W=y*r+C*a+w*u,et=y*n+C*l+w*p,b=A*i+_*o+M*c,B=A*r+_*a+M*u,T=A*n+_*l+M*p;return s[0]=L,s[1]=O,s[2]=H,s[3]=D,s[4]=W,s[5]=et,s[6]=b,s[7]=B,s[8]=T,s}static MAT3_INVERT(t,e=[0,0,0,0,0,0,0,0,0]){const s=t[0],i=t[1],r=t[2],n=t[3],o=t[4],a=t[5],l=t[6],c=t[7],u=t[8],p=u*o-a*c,d=-u*n+a*l,E=c*n-o*l;let m=s*p+i*d+r*E;if(!m)throw new Error("UT::MAT4_INVERT(): det is invalid !");m=1/m;const y=p*m,C=(-u*i+r*c)*m,w=(a*i-r*o)*m,A=d*m,_=(u*s-r*l)*m,M=(-a*s+r*n)*m,L=E*m,O=(-c*s+i*l)*m,H=(o*s-i*n)*m;return e[0]=y,e[1]=C,e[2]=w,e[3]=A,e[4]=_,e[5]=M,e[6]=L,e[7]=O,e[8]=H,e}static MAT3_IDENTITY(t=[0,0,0,0,0,0,0,0,0]){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t}static MAT3_SCALE(t,e,s=[0,0,0,0,0,0,0,0,0]){return s[0]=t,s[1]=0,s[2]=0,s[3]=0,s[4]=e,s[5]=0,s[6]=0,s[7]=0,s[8]=1,s}static MAT3_ROTATE(t,e=[0,0,0,0,0,0,0,0,0]){const s=Math.cos(t),i=Math.sin(t);return e[0]=s,e[1]=-i,e[2]=0,e[3]=i,e[4]=s,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e}static MAT3_TRANSLATE(t,e,s=[0,0,0,0,0,0,0,0,0]){return s[0]=1,s[1]=0,s[2]=0,s[3]=0,s[4]=1,s[5]=0,s[6]=t,s[7]=e,s[8]=1,s}static MAT3_TRANSFORM(t,e,s,i,r=[0,0,0,0,0,0,0,0,0]){return f.MAT3_TRANSLATE(t[0],t[1],r),f.MAT3_MULTIPLY(r,f.MAT3_ROTATE(s),r),f.MAT3_MULTIPLY(r,f.MAT3_SCALE(i[0],i[1]),r),f.MAT3_MULTIPLY(r,f.MAT3_TRANSLATE(-e[0],-e[1]),r),r}static MAT3_PROJECTION(t,e,s=[0,0,0,0,0,0,0,0,0]){return s[0]=2/t,s[1]=0,s[2]=0,s[3]=0,s[4]=2/e,s[5]=0,s[6]=-1,s[7]=-1,s[8]=1,s}static MAT4_CREATE(){const t=new Float32Array(16);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}static MAT4_COPY(t,e){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}static MAT4_MULTIPLY_BY_VEC4(t,e,s=[0,0,0,0]){const i=t[0],r=t[1],n=t[2],o=t[3],a=t[4],l=t[5],c=t[6],u=t[7],p=t[8],d=t[9],E=t[10],m=t[11],y=t[12],C=t[13],w=t[14],A=t[15],_=e[0],M=e[1],L=e[2],O=e[3];return s[0]=_*i+M*a+L*p+O*y,s[1]=_*r+M*l+L*d+O*C,s[2]=_*n+M*c+L*E+O*w,s[3]=_*o+M*u+L*m+O*A,s}static MAT4_MULTIPLY(t,e,s=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){const i=t[0],r=t[1],n=t[2],o=t[3],a=t[4],l=t[5],c=t[6],u=t[7],p=t[8],d=t[9],E=t[10],m=t[11],y=t[12],C=t[13],w=t[14],A=t[15],_=e[0],M=e[1],L=e[2],O=e[3],H=e[4],D=e[5],W=e[6],et=e[7],b=e[8],B=e[9],T=e[10],V=e[11],ot=e[12],X=e[13],ct=e[14],Z=e[15];return s[0]=_*i+M*a+L*p+O*y,s[1]=_*r+M*l+L*d+O*C,s[2]=_*n+M*c+L*E+O*w,s[3]=_*o+M*u+L*m+O*A,s[4]=H*i+D*a+W*p+et*y,s[5]=H*r+D*l+W*d+et*C,s[6]=H*n+D*c+W*E+et*w,s[7]=H*o+D*u+W*m+et*A,s[8]=b*i+B*a+T*p+V*y,s[9]=b*r+B*l+T*d+V*C,s[10]=b*n+B*c+T*E+V*w,s[11]=b*o+B*u+T*m+V*A,s[12]=ot*i+X*a+ct*p+Z*y,s[13]=ot*r+X*l+ct*d+Z*C,s[14]=ot*n+X*c+ct*E+Z*w,s[15]=ot*o+X*u+ct*m+Z*A,s}static MAT4_COMPUTE(...t){for(let e=0;e<t.length-1;e++)t[e+1]=f.MAT4_MULTIPLY(t[e],t[e+1]);return t[t.length-1]}static MAT4_INVERT(t,e=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){const s=t[0],i=t[1],r=t[2],n=t[3],o=t[4],a=t[5],l=t[6],c=t[7],u=t[8],p=t[9],d=t[10],E=t[11],m=t[12],y=t[13],C=t[14],w=t[15],A=s*a-i*o,_=s*l-r*o,M=s*c-n*o,L=i*l-r*a,O=i*c-n*a,H=r*c-n*l,D=u*y-p*m,W=u*C-d*m,et=u*w-E*m,b=p*C-d*y,B=p*w-E*y,T=d*w-E*C;let V=A*T-_*B+M*b+L*et-O*W+H*D;if(!V)throw new Error("UT::MAT4_INVERT(): det is invalid !");V=1/V;const ot=(a*T-l*B+c*b)*V,X=(r*B-i*T-n*b)*V,ct=(y*H-C*O+w*L)*V,Z=(d*O-p*H-E*L)*V,at=(l*et-o*T-c*W)*V,U=(s*T-r*et+n*W)*V,F=(C*M-m*H-w*_)*V,rt=(u*H-d*M+E*_)*V,tt=(o*B-a*et+c*D)*V,$=(i*et-s*B-n*D)*V,_t=(m*O-y*M+w*A)*V,Nt=(p*M-u*O-E*A)*V,pt=(a*W-o*b-l*D)*V,gt=(s*b-i*W+r*D)*V,Ft=(y*_-m*L-C*A)*V,bt=(u*L-p*_+d*A)*V;return e[0]=ot,e[1]=X,e[2]=ct,e[3]=Z,e[4]=at,e[5]=U,e[6]=F,e[7]=rt,e[8]=tt,e[9]=$,e[10]=_t,e[11]=Nt,e[12]=pt,e[13]=gt,e[14]=Ft,e[15]=bt,e}static MAT4_IDENTITY(t=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}static MAT4_SCALE(t,e,s,i=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){return i[0]=t,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=e,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=s,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i}static MAT4_ROTATE_X(t,e=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){const s=Math.cos(t),i=Math.sin(t);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=s,e[6]=-i,e[7]=0,e[8]=0,e[9]=i,e[10]=s,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}static MAT4_ROTATE_Y(t,e=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){const s=Math.cos(t),i=Math.sin(t);return e[0]=s,e[1]=0,e[2]=i,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=-i,e[9]=0,e[10]=s,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}static MAT4_ROTATE_Z(t,e=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){const s=Math.cos(t),i=Math.sin(t);return e[0]=s,e[1]=i,e[2]=0,e[3]=0,e[4]=-i,e[5]=s,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}static MAT4_TRANSLATE(t,e,s,i=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){return i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=t,i[13]=e,i[14]=s,i[15]=1,i}static MAT4_TRANSFORM(t,e,s,i,r=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){return f.MAT4_TRANSLATE(t[0],t[1],t[2],r),f.MAT4_MULTIPLY(r,i.toMatrix4(),r),f.MAT4_MULTIPLY(r,f.MAT4_ROTATE_Y(e[1]),r),f.MAT4_MULTIPLY(r,f.MAT4_ROTATE_X(e[0]),r),f.MAT4_MULTIPLY(r,f.MAT4_ROTATE_Z(e[2]),r),f.MAT4_MULTIPLY(r,f.MAT4_SCALE(s[0],s[1],s[2]),r),r}static MAT4_ORTHOGRAPHIC(t,e,s,i=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){return i[0]=2/t,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=2/e,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=-2/s,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i}static MAT4_ORTHO(t,e,s,i,r,n,o=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){return o[0]=2/(e-t),o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=2/(i-s),o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[10]=2/(r-n),o[11]=0,o[12]=(t+e)/(t-e),o[13]=(s+i)/(s-i),o[14]=(r+n)/(r-n),o[15]=1,o}static MAT4_PERSPECTIVE(t,e,s,i,r=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){return r[0]=1/(Math.tan(t/2)*e),r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1/Math.tan(t/2),r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=(s+i)/(s-i),r[11]=-1,r[12]=0,r[13]=0,r[14]=2*i*s/(s-i),r[15]=0,r}static MAT4_LOOKAT(t,e,s=f.VEC3_UP,i=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){const r=f.VEC3_NORMALIZE(f.VEC3_SUBSTRACT(t,e));if(s=f.VEC3_NORMALIZE(s),Math.abs(f.VEC3_DOT(r,s))>1-f.EPSILON){const a=Math.abs(r[1])<1-f.EPSILON?[0,1,0]:[1,0,0];s=f.VEC3_NORMALIZE(f.VEC3_CROSS(a,r))}const n=f.VEC3_NORMALIZE(f.VEC3_CROSS(s,r)),o=f.VEC3_NORMALIZE(f.VEC3_CROSS(r,n));return i[0]=n[0],i[1]=n[1],i[2]=n[2],i[3]=0,i[4]=o[0],i[5]=o[1],i[6]=o[2],i[7]=0,i[8]=r[0],i[9]=r[1],i[10]=r[2],i[11]=0,i[12]=t[0],i[13]=t[1],i[14]=t[2],i[15]=1,i}static MAT4_TRANSPOSE(t,e=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){const s=t[0],i=t[1],r=t[2],n=t[3],o=t[4],a=t[5],l=t[6],c=t[7],u=t[8],p=t[9],d=t[10],E=t[11],m=t[12],y=t[13],C=t[14],w=t[15];return e[0]=s,e[1]=o,e[2]=u,e[3]=m,e[4]=i,e[5]=a,e[6]=p,e[7]=y,e[8]=r,e[9]=l,e[10]=d,e[11]=C,e[12]=n,e[13]=c,e[14]=E,e[15]=w,e}static GET_LINES_FROM_RECT(t,e,s,i){return{t:[[t,e],[s,e]],r:[[s,e],[s,i]],b:[[s,i],[t,i]],l:[[t,i],[t,e]]}}static COLLIDE_CIRCLE_TO_CIRCLE(t,e,s,i,r=[0,0]){const n=f.VEC2_SUBSTRACT(t,s),o=f.VEC2_LENGTH(n),a=e+i;if(o>a)return!1;const l=Math.PI*2-(Math.PI*2-Math.atan2(n[1],n[0]));return r[0]=Math.cos(l)*(a-o),r[1]=Math.sin(l)*(a-o),!0}static COLLIDE_CYLINDER_TO_CYLINDER(t,e,s,i,r,n,o=[0,0]){if(!f.COLLIDE_CIRCLE_TO_CIRCLE([t[0],t[2]],e,[i[0],i[2]],r,o))return!1;const l=t[1],c=t[1]+s,u=i[1],p=i[1]+n;return l<=p&&c>=u}static COLLIDE_POINT_TO_CYLINDER(t,e,s,i){const r=f.VEC2_SUBSTRACT([t[0],t[2]],[e[0],e[2]]);return f.VEC2_LENGTH(r)>i?!1:t[1]>=e[1]&&t[1]<=e[1]+s}static COLLIDE_POINT_TO_RECT(t,e,s){return t[0]>=e[0]&&t[0]<=s[0]&&t[1]>=e[1]&&t[1]<=s[1]}static COLLIDE_RECT_TO_RECT(t,e,s,i){return t[0]<=i[0]&&e[0]>=s[0]&&t[1]<=i[1]&&e[1]>=s[1]}static COLLIDE_POINT_TO_BOX(t,e,s){return t[0]>=e[0]&&t[0]<=s[0]&&t[1]>=e[1]&&t[1]<=s[1]&&t[2]>=e[2]&&t[2]<=s[2]}static COLLIDE_BOX_TO_BOX(t,e,s,i){return t[0]<=i[0]&&e[0]>=s[0]&&t[1]<=i[1]&&e[1]>=s[1]&&t[2]<=i[2]&&e[2]>=s[2]}static COLLIDE_LINE_TO_LINE(t,e,s,i){let r=f.VEC2_ORIENTATION(t,e,s),n=f.VEC2_ORIENTATION(t,e,i),o=f.VEC2_ORIENTATION(s,i,t),a=f.VEC2_ORIENTATION(s,i,e);return r!=n&&o!=a}static TRI2_POINT_INSIDE(t,e,s,i){const r=f.VEC2_SUBSTRACT(s,e),n=f.VEC2_SUBSTRACT(i,s),o=f.VEC2_SUBSTRACT(e,i),a=f.VEC2_SUBSTRACT(t,e),l=f.VEC2_SUBSTRACT(t,s),c=f.VEC2_SUBSTRACT(t,i);return f.VEC2_CROSS(a,r)<-f.EPSILON?-1:f.VEC2_CROSS(l,n)<-f.EPSILON?-2:f.VEC2_CROSS(c,o)<-f.EPSILON?-3:1}static TRI3_NORMAL(t,e,s,i=[0,0,0]){const r=f.VEC3_SUBSTRACT(e,t),n=f.VEC3_SUBSTRACT(s,t);return f.VEC3_CROSS(r,n,i)}static TRI3_POINT_INSIDE(t,e,s,i){const r=f.VEC3_SUBSTRACT(i,e),n=f.VEC3_SUBSTRACT(s,e),o=f.VEC3_SUBSTRACT(t,e),a=f.VEC3_DOT(r,r),l=f.VEC3_DOT(r,n),c=f.VEC3_DOT(r,o),u=f.VEC3_DOT(n,n),p=f.VEC3_DOT(n,o),d=1/(a*u-l*l),E=(u*c-l*p)*d,m=(a*p-l*c)*d;return E>=0&&m>=0&&E+m<1}static TRI3_POINT_ELEVATION(t,e,s,i){const r=f.VEC3_CREATE(s[0]-e[0],0,s[2]-e[2]),n=f.VEC3_CREATE(e[0]-i[0],0,e[2]-i[2]),o=f.VEC3_CREATE(t[0]-e[0],0,t[1]-e[2]),a=f.VEC3_CREATE(t[0]-s[0],0,t[1]-s[2]),l=f.VEC3_CREATE(t[0]-i[0],0,t[1]-i[2]),c=f.VEC3_LENGTH(f.VEC3_CROSS(r,n)),u=f.VEC3_LENGTH(f.VEC3_CROSS(a,l))/c,p=f.VEC3_LENGTH(f.VEC3_CROSS(o,l))/c,d=f.VEC3_LENGTH(f.VEC3_CROSS(o,a))/c;if(u+p+d>1+f.BIG_EPSILON)return 1/0;const E=e[1]+(s[1]-e[1])*(p/(u+p));return E+(i[1]-E)*(d/(u+p+d))}static RAY_TRIANGLE(t,e,s,i,r,n=!1,o=[0,0,0]){const a=f.TRI3_NORMAL(s,i,r);return f.RAY_PLAN(t,e,s,a,n,o)?f.TRI3_POINT_INSIDE(o,s,i,r):!1}static RAY_PLAN(t,e,s,i,r,n=[0,0,0]){const o=f.VEC3_DOT(e,i);if(r&&o>=0||o>-f.EPSILON&&o<f.EPSILON)return!1;const a=f.VEC3_DOT(i,s)*-1,c=(f.VEC3_DOT(i,t)*-1-a)/o;return c<0?!1:(n[0]=t[0]+e[0]*c,n[1]=t[1]+e[1]*c,n[2]=t[2]+e[2]*c,!0)}static RAY_BOX(t,e,s,i,r=[0,0,0]){for(let n=0;n<3;n++)if(t[n]<s[n]){const o=(s[n]-t[n])/e[n],a=t[0]+e[0]*o,l=t[1]+e[1]*o,c=t[2]+e[2]*o;if(a>=s[0]&&a<=i[0]&&l>=s[1]&&l<=i[1]&&c>=s[2]&&c<=i[2])return r[0]=a,r[1]=l,r[2]=c,!0}else if(t[n]>i[n]){const o=(i[n]-t[n])/e[n],a=t[0]+e[0]*o,l=t[1]+e[1]*o,c=t[2]+e[2]*o;if(a>=s[0]&&a<=i[0]&&l>=s[1]&&l<=i[1]&&c>=s[2]&&c<=i[2])return r[0]=a,r[1]=l,r[2]=c,!0}return!1}static LINEAR(t,e,s,i=1){return e+(s-e)*t/i}static EASE_IN_QUAD(t,e,s,i=1){return(s-e)*(t/=i)*t+e}static EASE_OUT_QUAD(t,e,s,i=1){return-(s-e)*(t/=i)*(t-2)+e}static EASE_IN_OUT_QUAD(t,e,s,i=1){const r=s-e;return(t/=i/2)<1?r/2*t*t+e:-r/2*(--t*(t-2)-1)+e}}class Zo{canvas;ctx;drawables;mode;cameraTransform;cameraScale;cameraRotation;cameraPosition;bgColor;constructor(){if(this.canvas=document.getElementById("CANVAS_2D"),this.ctx=this.canvas.getContext("2d"),this.drawables=[],this.mode="ORTHOGRAPHIC",this.cameraTransform=f.MAT3_IDENTITY(),this.cameraScale=[1,1],this.cameraRotation=0,this.cameraPosition=[0,0],this.bgColor=[0,0,0,0],!this.ctx)throw f.FAIL("This browser does not support canvas"),new Error("Gfx2Manager::Gfx2Manager: Your browser not support 2D")}update(t){(this.canvas.width!=this.canvas.clientWidth||this.canvas.height!=this.canvas.clientHeight)&&(this.canvas.width=this.canvas.clientWidth,this.canvas.height=this.canvas.clientHeight)}beginRender(){this.ctx.imageSmoothingEnabled=!1,this.ctx.save(),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle=`rgba(${this.bgColor[0]}, ${this.bgColor[1]}, ${this.bgColor[2]}, ${this.bgColor[3]})`,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.transform(this.cameraTransform[0],this.cameraTransform[1],this.cameraTransform[3],this.cameraTransform[4],this.cameraTransform[6],this.cameraTransform[7]),this.ctx.translate(this.canvas.width*.5,this.canvas.height*.5),this.ctx.scale(this.cameraScale[0],this.cameraScale[1]),this.ctx.rotate(this.cameraRotation),this.ctx.translate(-this.cameraPosition[0],-this.cameraPosition[1])}render(){const t=this.mode=="ISOMETRIC"?Ko:$o;this.drawables.sort(t);for(const e of this.drawables)e.render()}endRender(){this.ctx.restore(),this.drawables=[]}draw(t){this.drawables.push(t)}setMode(t){this.mode=t}moveCamera(t,e){this.cameraPosition[0]+=t,this.cameraPosition[1]+=e}setFilter(t){this.canvas.style.filter=t}hasFilter(){return this.canvas.style.filter!=""&&this.canvas.style.filter!="none"}findCanvasPosFromClientPos(t,e){const s=this.canvas.getBoundingClientRect(),i=t-s.x,r=e-s.y;return[i,r]}findWorldPosFromClientPos(t,e){const s=this.canvas.getBoundingClientRect(),i=t-s.x+this.cameraPosition[0]-this.canvas.width*.5,r=e-s.y+this.cameraPosition[1]-this.canvas.height*.5;return[i,r]}getWidth(){return this.canvas.clientWidth}getHeight(){return this.canvas.clientHeight}getContext(){return this.ctx}setCameraTransform(t){this.cameraTransform=t}getCameraTransform(){return this.cameraTransform}setCameraPosition(t,e){this.cameraPosition[0]=t,this.cameraPosition[1]=e}getCameraPosition(){return this.cameraPosition}getCameraPositionX(){return this.cameraPosition[0]}getCameraPositionY(){return this.cameraPosition[1]}setCameraScale(t,e){this.cameraScale[0]=t,this.cameraScale[1]=e}getCameraScale(){return this.cameraScale}getCameraScaleX(){return this.cameraScale[0]}getCameraScaleY(){return this.cameraScale[1]}setCameraRotation(t){this.cameraRotation=t}getCameraRotation(){return this.cameraRotation}setBgColor(t,e,s,i){this.bgColor[0]=t,this.bgColor[1]=e,this.bgColor[2]=s,this.bgColor[3]=i}getBgColor(){return this.bgColor}getDefaultTexture(){const t=new Image;return t.src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",t}}const nt=new Zo;function Ko(h,t){return h.getElevation()<t.getElevation()?-1:h.getElevation()>t.getElevation()?1:h.getPositionY()-t.getPositionY()}function $o(h,t){return h.getPositionZ()-t.getPositionZ()}class Jo{textures;constructor(){this.textures=new Map}async loadTexture(t,e=""){if(e=e||t,this.textures.has(e))return this.textures.get(e);const i=await(await fetch(t)).blob(),r=await createImageBitmap(i);return this.textures.set(e,r),r}deleteTexture(t){if(!this.textures.has(t))throw new Error("Gfx2TextureManager::deleteTexture(): The texture file doesn't exist, cannot delete !");this.textures.delete(t)}getTexture(t){if(!this.textures.has(t))throw new Error("Gfx2TextureManager::getTexture(): The texture file doesn't exist, cannot get !");return this.textures.get(t)}hasTexture(t){return this.textures.has(t)}releaseTextures(){for(const t of this.textures.keys())this.textures.delete(t)}}const It=new Jo;var ir=(h=>(h.PERSPECTIVE="PERSPECTIVE",h.ORTHOGRAPHIC="ORTHOGRAPHIC",h))(ir||{});class _r{cameraMatrix;clipOffset;viewport;projectionMode;perspectiveFovy;perspectiveNear;perspectiveFar;orthographicSize;orthographicDepth;bgColor;screenSize;constructor(){this.cameraMatrix=f.MAT4_IDENTITY(),this.clipOffset=[0,0],this.viewport={xFactor:0,yFactor:0,widthFactor:1,heightFactor:1},this.projectionMode="PERSPECTIVE",this.perspectiveFovy=Math.PI/4,this.perspectiveNear=.1,this.perspectiveFar=2e3,this.orthographicSize=1,this.orthographicDepth=700,this.bgColor=[0,0,0,1],this.screenSize=[0,0]}getCameraPosition(){return[this.cameraMatrix[12],this.cameraMatrix[13],this.cameraMatrix[14]]}getClipOffset(){return this.clipOffset}getClipOffsetX(){return this.clipOffset[0]}getClipOffsetY(){return this.clipOffset[1]}setClipOffset(t,e){this.clipOffset[0]=t,this.clipOffset[1]=e}getCameraMatrix(){return this.cameraMatrix}setCameraMatrix(t){this.cameraMatrix=t}getViewport(){return this.viewport}setViewport(t){this.viewport=t}getProjectionMode(){return this.projectionMode}setProjectionMode(t){this.projectionMode=t}getPerspectiveFovy(){return this.perspectiveFovy}setPerspectiveFovy(t){this.perspectiveFovy=t}getPerspectiveNear(){return this.perspectiveNear}setPerspectiveNear(t){this.perspectiveNear=t}getPerspectiveFar(){return this.perspectiveFar}setPerspectiveFar(t){this.perspectiveFar=t}getOrthographicSize(){return this.orthographicSize}setOrthographicSize(t){this.orthographicSize=t}getOrthographicDepth(){return this.orthographicDepth}setOrthographicDepth(t){this.orthographicDepth=t}getBgColor(){return this.bgColor}setBgColor(t,e,s,i){this.bgColor[0]=t,this.bgColor[1]=e,this.bgColor[2]=s,this.bgColor[3]=i}getScreenSize(){return this.screenSize}setScreenSize(t,e){this.screenSize[0]=t,this.screenSize[1]=e}getViewportSize(){const t=this.screenSize[0]*this.viewport.widthFactor,e=this.screenSize[1]*this.viewport.heightFactor;return[t,e]}getViewportClientSize(){const t=this.screenSize[0]*this.viewport.widthFactor/window.devicePixelRatio,e=this.screenSize[1]*this.viewport.heightFactor/window.devicePixelRatio;return[t,e]}getProjectionMatrix(){const t=f.MAT4_IDENTITY(),e=this.screenSize[0]*this.viewport.widthFactor,s=this.screenSize[1]*this.viewport.heightFactor,i=e/s;return this.projectionMode=="PERSPECTIVE"?f.MAT4_PERSPECTIVE(this.perspectiveFovy,i,this.perspectiveNear,this.perspectiveFar,t):this.projectionMode=="ORTHOGRAPHIC"&&f.MAT4_ORTHOGRAPHIC(this.orthographicSize,this.orthographicSize/i,this.orthographicDepth,t),t}getClipMatrix(){return f.MAT4_INVERT(f.MAT4_TRANSLATE(this.clipOffset[0],this.clipOffset[1],0))}getCameraViewMatrix(){return f.MAT4_INVERT(this.cameraMatrix)}getProjectionClipMatrix(){const t=f.MAT4_IDENTITY();return f.MAT4_MULTIPLY(t,this.getClipMatrix(),t),f.MAT4_MULTIPLY(t,this.getProjectionMatrix(),t),t}getViewProjectionClipMatrix(){const t=f.MAT4_IDENTITY();return f.MAT4_MULTIPLY(t,this.getClipMatrix(),t),f.MAT4_MULTIPLY(t,this.getProjectionMatrix(),t),f.MAT4_MULTIPLY(t,this.getCameraViewMatrix(),t),t}getBillboardProjectionClipMatrix(){const t=f.MAT4_IDENTITY(),e=this.getCameraViewMatrix();return f.MAT4_MULTIPLY(t,this.getClipMatrix(),t),f.MAT4_MULTIPLY(t,this.getProjectionMatrix(),t),f.MAT4_MULTIPLY(t,f.MAT4_TRANSLATE(e[12],e[13],e[14]),t),t}getScreenPosition(t,e,s){const i=f.MAT4_IDENTITY();f.MAT4_MULTIPLY(i,this.getClipMatrix(),i),f.MAT4_MULTIPLY(i,this.getProjectionMatrix(),i),f.MAT4_MULTIPLY(i,this.getCameraViewMatrix(),i);const r=f.MAT4_MULTIPLY_BY_VEC4(i,[t,e,s,1]),n=this.getViewportSize();return r[0]=r[0]/r[3],r[1]=r[1]/r[3],r[0]=(r[0]+1)*n[0]/2,r[1]=n[1]-(r[1]+1)*n[1]/2,[r[0],r[1]]}getClientScreenPosition(t,e,s){const i=f.MAT4_IDENTITY();f.MAT4_MULTIPLY(i,this.getClipMatrix(),i),f.MAT4_MULTIPLY(i,this.getProjectionMatrix(),i),f.MAT4_MULTIPLY(i,this.getCameraViewMatrix(),i);const r=f.MAT4_MULTIPLY_BY_VEC4(i,[t,e,s,1]),n=this.getViewportClientSize();return r[0]=r[0]/r[3],r[1]=r[1]/r[3],r[0]=(r[0]+1)*n[0]/2,r[1]=n[1]-(r[1]+1)*n[1]/2,[r[0],r[1]]}getScreenNormalizedPosition(t,e,s){const i=f.MAT4_IDENTITY();f.MAT4_MULTIPLY(i,this.getClipMatrix(),i),f.MAT4_MULTIPLY(i,this.getProjectionMatrix(),i),f.MAT4_MULTIPLY(i,this.getCameraViewMatrix(),i);const r=f.MAT4_MULTIPLY_BY_VEC4(i,[t,e,s,1]);return[r[0]/r[3],r[1]/r[3]]}getScreenNormalizedPositionZeroToOne(t,e,s){const i=f.MAT4_IDENTITY();f.MAT4_MULTIPLY(i,this.getClipMatrix(),i),f.MAT4_MULTIPLY(i,this.getProjectionMatrix(),i),f.MAT4_MULTIPLY(i,this.getCameraViewMatrix(),i);const r=f.MAT4_MULTIPLY_BY_VEC4(i,[t,e,s,1]);return r[0]=r[0]/r[3],r[1]=r[1]/r[3],r[0]=(r[0]+1)/2,r[1]=(r[1]+1)/2,[r[0],r[1]]}}const ls=256;class Qo{device;pipeline;groupIndex;uniformsByteLength;uniforms;textures;buffer;currentOffset;bindGroup;constructor(t,e,s){this.device=t,this.pipeline=e,this.groupIndex=s,this.uniformsByteLength=0,this.uniforms=new Map,this.textures=new Map,this.buffer=t.createBuffer({size:16*4,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.currentOffset=0,this.bindGroup=null}delete(){this.buffer.destroy()}setFloat(t,e,s){let i=s*4,r=Math.ceil(i/256)*ls;return this.uniforms.set(t,{binding:t,name:e,size:i,alignment:r}),this.uniformsByteLength+=r,new Float32Array(s)}setInteger(t,e,s){let i=s*4,r=Math.ceil(i/256)*ls;return this.uniforms.set(t,{binding:t,name:e,size:i,alignment:r}),this.uniformsByteLength+=r,new Uint32Array(s)}setTexture(t,e,s,i={}){return this.textures.set(t,{binding:t,name:e,resource:s.gpuTexture.createView(i)}),s}setSampler(t,e,s){return this.textures.set(t,{binding:t,name:e,resource:s.gpuSampler}),s}allocate(){this.buffer.size!=this.uniformsByteLength&&(this.buffer.destroy(),this.buffer=this.device.createBuffer({size:this.uniformsByteLength,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}));let t=[],e=0;for(const s of this.uniforms.values())t[s.binding]={binding:s.binding,resource:{buffer:this.buffer,offset:e,size:s.size}},e+=s.alignment;for(const s of this.textures.values())t[s.binding]={binding:s.binding,resource:s.resource};this.bindGroup=this.device.createBindGroup({layout:this.pipeline.getBindGroupLayout(this.groupIndex),entries:t})}beginWrite(){this.currentOffset=0}write(t,e){this.device.queue.writeBuffer(this.buffer,this.currentOffset,e),this.currentOffset+=Math.ceil(e.byteLength/256)*ls}endWrite(){this.currentOffset=0}getBindGroup(){return this.bindGroup}}class ta{device;pipeline;groupIndex;uniformsByteLength;uniforms;buffer;currentOffset;bindGroups;size;constructor(t,e,s){this.device=t,this.pipeline=e,this.groupIndex=s,this.uniformsByteLength=0,this.uniforms=new Map,this.buffer=t.createBuffer({size:16*4,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.currentOffset=0,this.bindGroups=[],this.size=0}delete(){this.buffer.destroy(),this.bindGroups=[]}setFloat(t,e,s){let i=s*4,r=Math.ceil(i/256)*ls;return this.uniforms.set(t,{binding:t,name:e,size:i,alignment:r}),this.uniformsByteLength+=r,new Float32Array(s)}setInteger(t,e,s){let i=s*4,r=Math.ceil(i/256)*ls;return this.uniforms.set(t,{binding:t,name:e,size:i,alignment:r}),this.uniformsByteLength+=r,new Uint32Array(s)}allocate(t=1){this.bindGroups=[],this.buffer.size!=t*this.uniformsByteLength&&(this.buffer.destroy(),this.buffer=this.device.createBuffer({size:t*this.uniformsByteLength,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}));for(let e=0,s=0,i=[];e<t;e++){for(const r of this.uniforms.values())i[r.binding]={binding:r.binding,resource:{buffer:this.buffer,offset:s,size:r.size}},s+=r.alignment;this.bindGroups.push(this.device.createBindGroup({layout:this.pipeline.getBindGroupLayout(this.groupIndex),entries:i}))}this.size=t}beginWrite(){this.currentOffset=0}write(t,e){this.device.queue.writeBuffer(this.buffer,this.currentOffset,e),this.currentOffset+=Math.ceil(e.byteLength/256)*ls}endWrite(){this.currentOffset=0}getBindGroup(t=0){return this.bindGroups[t]}getSize(){return this.size}}const br=window,ea=br.__ALPHA_MODE__?br.__ALPHA_MODE__:"opaque";class sa{adapter;device;canvas;ctx;destinationTexture;normalsTexture;idsTexture;depthTexture;commandEncoder;passEncoder;pipelines;vertexBuffer;vertexSubBuffers;vertexSubBuffersSize;views;currentView;lastRenderStart;lastRenderTime;constructor(){this.adapter={},this.device={},this.canvas={},this.ctx={},this.destinationTexture=null,this.normalsTexture={},this.idsTexture={},this.depthTexture={},this.commandEncoder={},this.passEncoder={},this.pipelines=new Map,this.vertexBuffer={},this.vertexSubBuffers=[],this.vertexSubBuffersSize=0,this.views=[],this.currentView=new _r,this.lastRenderStart=0,this.lastRenderTime=0}async initialize(){if(!navigator.gpu)throw f.FAIL("This browser does not support webgpu"),new Error("Gfx3Manager::Gfx3Manager: WebGPU cannot be initialized - navigator.gpu not found");if(this.adapter=await navigator.gpu.requestAdapter(),!this.adapter)throw f.FAIL("This browser appears to support WebGPU but it's disabled"),new Error("Gfx3Manager::Gfx3Manager: WebGPU cannot be initialized - Adapter not found");if(this.device=await this.adapter.requestDevice(),this.device.lost.then(()=>{throw new Error("Gfx3Manager::Gfx3Manager: WebGPU cannot be initialized - Device has been lost")}),this.canvas=document.getElementById("CANVAS_3D"),!this.canvas)throw new Error("Gfx3Manager::Gfx3Manager: CANVAS_3D not found");if(this.ctx=this.canvas.getContext("webgpu"),!this.ctx)throw new Error("Gfx3Manager::Gfx3Manager: WebGPU cannot be initialized - Canvas does not support WebGPU");this.ctx.configure({device:this.device,format:navigator.gpu.getPreferredCanvasFormat(),alphaMode:ea});const t=window.devicePixelRatio||1;this.canvas.width=this.canvas.clientWidth*t,this.canvas.height=this.canvas.clientHeight*t,this.currentView=this.createView(),this.normalsTexture=this.createRenderingTexture("rgba16float"),this.idsTexture=this.createRenderingTexture("rgba16float"),this.depthTexture=this.createRenderingTexture("depth24plus"),this.vertexBuffer=this.device.createBuffer({size:0,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),v.subscribe(Cs,"E_RESIZE",this,this.#t)}beginDrawing(){}endDrawing(){if(this.vertexSubBuffersSize>0&&this.vertexSubBuffersSize!=this.vertexBuffer.size){this.vertexBuffer.destroy(),this.vertexBuffer=this.device.createBuffer({size:this.vertexSubBuffersSize,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST});for(const t of this.vertexSubBuffers)this.device.queue.writeBuffer(this.vertexBuffer,t.offset,t.vertices),t.changed=!1;return}for(const t of this.vertexSubBuffers)t.changed&&(this.device.queue.writeBuffer(this.vertexBuffer,t.offset,t.vertices),t.changed=!1)}beginRender(){this.commandEncoder=this.device.createCommandEncoder(),this.lastRenderStart=Date.now()}beginPassRender(t){const e=this.views[t],s=e.getViewport(),i=this.canvas.width*s.xFactor,r=this.canvas.height*s.yFactor,n=this.canvas.width*s.widthFactor,o=this.canvas.height*s.heightFactor,a=e.getBgColor(),l=this.destinationTexture?this.destinationTexture.createView():this.ctx.getCurrentTexture().createView();this.passEncoder=this.commandEncoder.beginRenderPass({colorAttachments:[{view:l,clearValue:{r:a[0],g:a[1],b:a[2],a:a[3]},loadOp:"clear",storeOp:"store"},{view:this.normalsTexture.gpuTexture.createView(),clearValue:{r:0,g:0,b:1,a:1},loadOp:"clear",storeOp:"store"},{view:this.idsTexture.gpuTexture.createView(),clearValue:{r:0,g:0,b:0,a:1},loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{view:this.depthTexture.gpuTexture.createView(),depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"}}),this.currentView=e,this.passEncoder.setViewport(i,r,n,o,0,1),this.passEncoder.setScissorRect(i,r,n,o)}endPassRender(){this.passEncoder.end()}endRender(){this.device.queue.submit([this.commandEncoder.finish()]),this.lastRenderTime=Date.now()-this.lastRenderStart}loadPipeline(t,e,s,i){if(this.pipelines.has(t))return this.pipelines.get(t);i.vertex&&(i.vertex.module=this.device.createShaderModule({code:e})),i.fragment&&(i.fragment.module=this.device.createShaderModule({code:s}));const r=this.device.createRenderPipeline(i);return this.pipelines.set(t,r),r}deletePipeline(t){if(!this.pipelines.has(t))throw new Error("Gfx3Manager::deletePipeline(): pipeline not found !");this.pipelines.delete(t)}getPipeline(t){if(!this.pipelines.has(t))throw new Error("Gfx3Manager::getPipeline(): pipeline not found !");return this.pipelines.get(t)}createVertexBuffer(t){const e={vertices:new Float32Array(t),offset:this.vertexSubBuffersSize,changed:!1};return this.vertexSubBuffers.push(e),this.vertexSubBuffersSize+=t,e}destroyVertexBuffer(t){const e=this.vertexSubBuffers.indexOf(t);this.vertexSubBuffers.splice(e,1);for(const s of this.vertexSubBuffers)s.offset>t.offset&&(s.offset-=t.vertices.byteLength);this.vertexSubBuffersSize-=t.vertices.byteLength}writeVertexBuffer(t,e){t.vertices=new Float32Array(e),t.changed=!0}createStaticGroup(t,e){return new Qo(this.device,this.getPipeline(t),e)}createDynamicGroup(t,e){return new ta(this.device,this.getPipeline(t),e)}createRenderingTexture(t=navigator.gpu.getPreferredCanvasFormat()){return this.createEmptyTexture(this.getWidth(),this.getHeight(),t,{magFilter:"nearest",minFilter:"nearest"})}createEmptyTexture(t,e,s,i={}){const r=this.device.createTexture({size:[t,e],format:s,usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT}),n=this.device.createSampler(Object.assign(i,{magFilter:i.magFilter??"linear",minFilter:i.minFilter??"linear",addressModeU:i.addressModeU??"repeat",addressModeV:i.addressModeV??"repeat"}));return{gpuTexture:r,gpuSampler:n}}createTextureFromBitmap(t,e=!1,s={}){if(!t){const n=document.createElement("canvas");n.getContext("2d"),n.width=1,n.height=1,t=n}const i=this.device.createTexture({size:[t.width,t.height],format:e?"r8unorm":"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT});this.device.queue.copyExternalImageToTexture({source:t},{texture:i},[t.width,t.height]);const r=this.device.createSampler(Object.assign(s,{magFilter:s.magFilter??"linear",minFilter:s.minFilter??"linear",addressModeU:s.addressModeU??"repeat",addressModeV:s.addressModeV??"repeat"}));return{gpuTexture:i,gpuSampler:r}}createCubeMapFromBitmap(t){if(!t||t.length==0){const i=document.createElement("canvas");i.getContext("2d"),i.width=1,i.height=1,t=[];for(let r=0;r<6;r++)t.push(i)}const e=this.device.createTexture({dimension:"2d",size:[t[0].width,t[0].height,6],format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT});for(let i=0;i<t.length;i++){const r=t[i];this.device.queue.copyExternalImageToTexture({source:r},{texture:e,origin:[0,0,i]},[r.width,r.height])}const s=this.device.createSampler({magFilter:"linear",minFilter:"linear"});return{gpuTexture:e,gpuSampler:s}}setFilter(t){this.canvas.style.filter=t}hasFilter(){return this.canvas.style.filter!=""&&this.canvas.style.filter!="none"}getClientWidth(){return this.canvas.clientWidth}getClientHeight(){return this.canvas.clientHeight}getWidth(){const t=window.devicePixelRatio||1;return this.canvas.clientWidth*t}getHeight(){const t=window.devicePixelRatio||1;return this.canvas.clientHeight*t}getContext(){return this.ctx}getDevice(){return this.device}setDestinationTexture(t){this.destinationTexture=t}getNormalsTexture(){return this.normalsTexture}getIdsTexture(){return this.idsTexture}getDepthTexture(){return this.depthTexture}getCurrentRenderingTexture(){return this.ctx.getCurrentTexture()}getCommandEncoder(){return this.commandEncoder}getPassEncoder(){return this.passEncoder}getView(t){return this.views[t]}getNumViews(){return this.views.length}createView(){const t=new _r;return t.setScreenSize(this.canvas.width,this.canvas.height),this.views.push(t),t}changeView(t,e){this.views[t]=e}removeView(t){this.views.splice(this.views.indexOf(t),1)}removeViewAt(t){this.views.splice(t,1)}getCurrentView(){return this.currentView}getVertexBuffer(){return this.vertexBuffer}getLastRenderTime(){return this.lastRenderTime}#t(){const t=window.devicePixelRatio||1;this.canvas.width=this.canvas.clientWidth*t,this.canvas.height=this.canvas.clientHeight*t,this.normalsTexture.gpuTexture.destroy(),this.normalsTexture=this.createRenderingTexture("rgba16float"),this.idsTexture.gpuTexture.destroy(),this.idsTexture=this.createRenderingTexture("rgba16float"),this.depthTexture.gpuTexture.destroy(),this.depthTexture=this.createRenderingTexture("depth24plus");for(const e of this.views)e.setScreenSize(this.canvas.width,this.canvas.height)}}const k=new sa;await k.initialize();const ia=`
struct VSOutput {
  @builtin(position) position: vec4f,
  @location(0) texcoord: vec2f,
};

@vertex fn vs(
  @builtin(vertex_index) vertexIndex : u32
) -> VSOutput {
  let pos = array(

    vec2f( 0.0,  0.0),  // centre
    vec2f( 1.0,  0.0),  //  droite, au centre
    vec2f( 0.0,  1.0),  // centre, haut

    // 2me triangle
    vec2f( 0.0,  1.0),  // centre, haut
    vec2f( 1.0,  0.0),  //  droite, au centre
    vec2f( 1.0,  1.0),  // En haut  droite
  );

  var vsOutput: VSOutput;
  let xy = pos[vertexIndex];
  vsOutput.position = vec4f(xy * 2.0 - 1.0, 0.0, 1.0);
  vsOutput.texcoord = vec2f(xy.x, 1.0 - xy.y);
  return vsOutput;
}

@group(0) @binding(0) var ourSampler: sampler;
@group(0) @binding(1) var ourTexture: texture_2d<f32>;

@fragment fn fs(fsInput: VSOutput) -> @location(0) vec4f {
  return textureSample(ourTexture, ourSampler, fsInput.texcoord);
}`;class ra{device;sampler;pipelines;shaderModule;constructor(){this.device=k.getDevice(),this.sampler=this.device.createSampler({minFilter:"linear"}),this.pipelines=new Map,this.shaderModule=this.device.createShaderModule({code:ia})}createTextureFromBitmap(t,e=!1,s={}){const i=this.device.createTexture({format:e?"r8unorm":"rgba8unorm",mipLevelCount:oa(t.width,t.height),size:[t.width,t.height],usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT});this.device.queue.copyExternalImageToTexture({source:t,flipY:!0},{texture:i},[t.width,t.height]);const r=this.device.createSampler(Object.assign(s,{magFilter:s.magFilter??"linear",minFilter:s.minFilter??"linear",addressModeU:s.addressModeU??"repeat",addressModeV:s.addressModeV??"repeat"}));return i.mipLevelCount>1&&this.generateMipmap(i),{gpuTexture:i,gpuSampler:r}}generateMipmap(t){if(t.dimension=="3d"||t.dimension=="1d")throw new Error("Gfx3MipmapManager::generateMipmap(): Generating mipmaps for non-2d textures is currently unsupported!");const e=this.#t(t.format),s=this.device.createCommandEncoder();let i=t.width,r=t.height,n=0;for(;i>1||r>1;){i=Math.max(1,i/2|0),r=Math.max(1,r/2|0);const a=this.device.createBindGroup({layout:e.getBindGroupLayout(0),entries:[{binding:0,resource:this.sampler},{binding:1,resource:t.createView({baseMipLevel:n,mipLevelCount:1})}]});++n;const l=s.beginRenderPass({colorAttachments:[{view:t.createView({baseMipLevel:n,mipLevelCount:1}),loadOp:"clear",storeOp:"store"}]});l.setPipeline(e),l.setBindGroup(0,a),l.draw(6),l.end()}const o=s.finish();this.device.queue.submit([o])}#t(t){const e=this.pipelines.get(t);if(e)return e;const s=this.device.createRenderPipeline({layout:"auto",vertex:{module:this.shaderModule,entryPoint:"vs"},fragment:{module:this.shaderModule,entryPoint:"fs",targets:[{format:t}]}});return this.pipelines.set(t,s),s}}const na=new ra;function oa(...h){const t=Math.max(...h);return 1+Math.log2(t)|0}class aa{textures;constructor(){this.textures=new Map}async loadTexture(t,e={},s=!1,i=""){if(i=i||t,this.textures.has(i))return this.textures.get(i);const n=await(await fetch(t)).blob(),o=await createImageBitmap(n,{colorSpaceConversion:"none"}),a=k.createTextureFromBitmap(o,s,e);return this.textures.set(i,a),a}async loadTextureMips(t,e={},s=!1,i=""){if(i=i||t,this.textures.has(i))return this.textures.get(i);const n=await(await fetch(t)).blob(),o=await createImageBitmap(n,{colorSpaceConversion:"none"}),a=na.createTextureFromBitmap(o,s,e);return this.textures.set(i,a),a}async loadCubemapTexture(t,e,s=""){if(s=s||t,this.textures.has(s))return this.textures.get(s);const i=["right","left","top","bottom","front","back"],r=[];for(const o of i){const l=await(await fetch(t+o+"."+e)).blob(),c=await createImageBitmap(l,{colorSpaceConversion:"none"});r.push(c)}const n=k.createCubeMapFromBitmap(r);return this.textures.set(s,n),n}deleteTexture(t){if(!this.textures.has(t))throw new Error("Gfx3TextureManager::deleteTexture(): The texture file doesn't exist, cannot delete !");this.textures.get(t).gpuTexture.destroy(),this.textures.delete(t)}getTexture(t){if(!this.textures.has(t))throw new Error("Gfx2TextureManager::getTexture(): The texture file doesn't exist, cannot get !");return this.textures.get(t)}hasTexture(t){return this.textures.has(t)}releaseTextures(){for(const t of this.textures.keys())this.textures.get(t).gpuTexture.destroy(),this.textures.delete(t)}}const st=new aa;class ze{pipeline;constructor(t,e,s,i){this.pipeline=k.loadPipeline(t,e,s,i)}}const Pn=6,ha={label:"Debug pipeline",layout:"auto",vertex:{entryPoint:"main",buffers:[{arrayStride:Pn*4,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:3*4,format:"float32x3"}]}]},fragment:{entryPoint:"main",targets:[{format:navigator.gpu.getPreferredCanvasFormat()},{format:"rgba16float"},{format:"rgba16float"}]},primitive:{topology:"line-list",cullMode:"back",frontFace:"ccw"},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth24plus"}},la=`
struct VertexOutput {
  @builtin(position) Position: vec4<f32>,
  @location(0) Color: vec3<f32>
};

@binding(0) @group(0) var<uniform> MVPC_MATRIX: mat4x4<f32>;

@vertex
fn main(
  @location(0) Position: vec4<f32>,
  @location(1) Color: vec3<f32>
) -> VertexOutput {
  var output: VertexOutput;
  output.Position = MVPC_MATRIX * Position;
  output.Color = Color;
  return output;
}`,ca=`
struct FragOutput {
  @location(0) Base: vec4f,
  @location(1) Normal: vec4f,
  @location(2) Id: vec4f
}

@fragment
fn main(
  @location(0) Color: vec3<f32>
) -> FragOutput {
  var output: FragOutput;
  output.Base = vec4(Color, 1);
  output.Normal = vec4(0.0, 0.0, 0.0, 0.0);
  output.Id = vec4(0.0, 0.0, 0.0, 0.0);
  return output;
}`;class ua extends ze{device;vertexBuffer;vertexCount;commands;showDebug;grp0;mvpcMatrix;constructor(){super("DEBUG_PIPELINE",la,ca,ha),this.device=k.getDevice(),this.vertexBuffer=this.device.createBuffer({size:0,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC}),this.vertexCount=0,this.commands=[],this.showDebug=!1,this.grp0=k.createDynamicGroup("DEBUG_PIPELINE",0),this.mvpcMatrix=this.grp0.setFloat(0,"MVPC_MATRIX",16),this.grp0.allocate()}render(){if(!this.showDebug)return;const t=k.getCurrentView(),e=k.getPassEncoder(),s=t.getViewProjectionClipMatrix();e.setPipeline(this.pipeline),this.vertexBuffer.destroy(),this.vertexBuffer=this.device.createBuffer({size:this.vertexCount*Pn*4,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC}),this.grp0.allocate(this.commands.length),this.grp0.beginWrite();for(let i=0,r=0;i<this.commands.length;i++){const n=this.commands[i];this.grp0.write(0,f.MAT4_MULTIPLY(s,n.matrix,this.mvpcMatrix)),e.setBindGroup(0,this.grp0.getBindGroup(i)),this.device.queue.writeBuffer(this.vertexBuffer,r,n.vertices),e.setVertexBuffer(0,this.vertexBuffer,r,n.vertices.byteLength),e.draw(n.vertexCount),r+=n.vertices.byteLength}this.grp0.endWrite(),this.commands=[],this.vertexCount=0}drawVertices(t,e,s=f.MAT4_IDENTITY()){this.commands.push({vertices:new Float32Array(t),vertexCount:e,matrix:s}),this.vertexCount+=e}drawCylinder(t,e,s,i,r,n=[1,1,1]){let o=0;const a=[],l=Math.PI*2/i,c=0,u=0,p=0,d=0,E=s,m=0;for(let y=0;y<Math.PI*2;y+=l){const C=e*Math.cos(y),w=0,A=e*Math.sin(y)*-1,_=e*Math.cos(y+l),M=0,L=e*Math.sin(y+l)*-1,O=e*Math.cos(y),H=s,D=e*Math.sin(y)*-1,W=e*Math.cos(y+l),et=s,b=e*Math.sin(y+l)*-1;a.push(C,w,A,n[0],n[1],n[2]),a.push(O,H,D,n[0],n[1],n[2]),a.push(C,w,A,n[0],n[1],n[2]),a.push(_,M,L,n[0],n[1],n[2]),a.push(O,H,D,n[0],n[1],n[2]),a.push(W,et,b,n[0],n[1],n[2]),o+=6,r&&(a.push(c,u,p,n[0],n[1],n[2]),a.push(C,w,A,n[0],n[1],n[2]),a.push(d,E,m,n[0],n[1],n[2]),a.push(O,H,D,n[0],n[1],n[2]),o+=4)}this.commands.push({vertices:new Float32Array(a),vertexCount:o,matrix:t}),this.vertexCount+=o}drawGrid(t,e=3,s=1,i=[1,1,1]){let r=0;const n=[],o=e*2,a=o*s,l=-a*.5,c=-a*.5;for(let u=0;u<=o;u++){const p=l+u*s,d=c,E=0,m=l+u*s,y=c+a,C=0,w=l,A=c+u*s,_=0,M=l+a,L=c+u*s,O=0;n.push(p,d,E,i[0],i[1],i[2]),n.push(m,y,C,i[0],i[1],i[2]),n.push(w,A,_,i[0],i[1],i[2]),n.push(M,L,O,i[0],i[1],i[2]),r+=4}this.commands.push({vertices:new Float32Array(n),vertexCount:r,matrix:t}),this.vertexCount+=r}drawGizmo(t,e=1){let s=0;const i=[],r=[[1*e,0,0],[0,1*e,0],[0,0,1*e]],n=[[1,0,0],[0,1,0],[0,0,1]];for(let o=0;o<r.length;o++)i.push(0,0,0,n[o][0],n[o][1],n[o][2]),i.push(r[o][0],r[o][1],r[o][2],n[o][0],n[o][1],n[o][2]),s+=2;this.commands.push({vertices:new Float32Array(i),vertexCount:s,matrix:t}),this.vertexCount+=s}drawCircle(t,e=1,s=4,i=[1,1,1]){let r=0;const n=[],o=Math.PI*2/s;for(let a=0;a<s;a++){const l=Math.cos(a*o)*e,c=Math.sin(a*o)*e,u=0,p=Math.cos((a+1)*o)*e,d=Math.sin((a+1)*o)*e,E=0;n.push(l,c,u,i[0],i[1],i[2]),n.push(p,d,E,i[0],i[1],i[2]),r+=2}this.commands.push({vertices:new Float32Array(n),vertexCount:r,matrix:t}),this.vertexCount+=r}drawBoundingRect(t,e,s,i=[1,1,1]){let r=0;const n=[],o=[e[0],0,e[1]],a=[e[0],0,s[1]],l=[s[0],0,e[1]],c=[s[0],0,s[1]];n.push(o[0],o[1],o[2],i[0],i[1],i[2]),n.push(a[0],a[1],a[2],i[0],i[1],i[2]),r+=2,n.push(a[0],a[1],a[2],i[0],i[1],i[2]),n.push(c[0],c[1],c[2],i[0],i[1],i[2]),r+=2,n.push(c[0],c[1],c[2],i[0],i[1],i[2]),n.push(l[0],l[1],l[2],i[0],i[1],i[2]),r+=2,n.push(l[0],l[1],l[2],i[0],i[1],i[2]),n.push(o[0],o[1],o[2],i[0],i[1],i[2]),r+=2,this.commands.push({vertices:new Float32Array(n),vertexCount:r,matrix:t}),this.vertexCount+=r}drawSphere(t,e=1,s=4,i=[1,1,1]){let r=0;const n=[],o=[],a=Math.PI*.5/s;for(let l=-s;l<=s;l++){const c=Math.cos(l*a)*e,u=Math.sin(l*a)*e;for(let p=0;p<=s*4;p++){const d=Math.sin(p*a)*c,E=Math.cos(p*a)*c;o.push([E,u,d])}}for(let l=-s;l<=s;l++)for(let c=0;c<=s*4;c++){const u=Math.cos(c*a)*e*Math.cos(l*a),p=Math.sin(c*a)*e,d=Math.cos(c*a)*e*Math.sin(l*a);o.push([u,p,d])}for(let l=0;l<o.length-1;l++)n.push(o[l][0],o[l][1],o[l][2],i[0],i[1],i[2]),n.push(o[l+1][0],o[l+1][1],o[l+1][2],i[0],i[1],i[2]),r+=2;this.commands.push({vertices:new Float32Array(n),vertexCount:r,matrix:t}),this.vertexCount+=r}drawBoundingBox(t,e,s,i=[1,1,1]){let r=0;const n=[],o=[e[0],e[1],e[2]],a=[s[0],e[1],e[2]],l=[s[0],s[1],e[2]],c=[e[0],s[1],e[2]],u=[e[0],s[1],s[2]],p=[s[0],s[1],s[2]],d=[s[0],e[1],s[2]],E=[e[0],e[1],s[2]];n.push(o[0],o[1],o[2],i[0],i[1],i[2]),n.push(a[0],a[1],a[2],i[0],i[1],i[2]),n.push(E[0],E[1],E[2],i[0],i[1],i[2]),n.push(d[0],d[1],d[2],i[0],i[1],i[2]),r+=4,n.push(c[0],c[1],c[2],i[0],i[1],i[2]),n.push(l[0],l[1],l[2],i[0],i[1],i[2]),n.push(u[0],u[1],u[2],i[0],i[1],i[2]),n.push(p[0],p[1],p[2],i[0],i[1],i[2]),r+=4,n.push(o[0],o[1],o[2],i[0],i[1],i[2]),n.push(c[0],c[1],c[2],i[0],i[1],i[2]),n.push(E[0],E[1],E[2],i[0],i[1],i[2]),n.push(u[0],u[1],u[2],i[0],i[1],i[2]),r+=4,n.push(a[0],a[1],a[2],i[0],i[1],i[2]),n.push(l[0],l[1],l[2],i[0],i[1],i[2]),n.push(d[0],d[1],d[2],i[0],i[1],i[2]),n.push(p[0],p[1],p[2],i[0],i[1],i[2]),r+=4,n.push(c[0],c[1],c[2],i[0],i[1],i[2]),n.push(u[0],u[1],u[2],i[0],i[1],i[2]),n.push(l[0],l[1],l[2],i[0],i[1],i[2]),n.push(p[0],p[1],p[2],i[0],i[1],i[2]),r+=4,n.push(o[0],o[1],o[2],i[0],i[1],i[2]),n.push(E[0],E[1],E[2],i[0],i[1],i[2]),n.push(a[0],a[1],a[2],i[0],i[1],i[2]),n.push(d[0],d[1],d[2],i[0],i[1],i[2]),r+=4,this.commands.push({vertices:new Float32Array(n),vertexCount:r,matrix:t}),this.vertexCount+=r}isShowDebug(){return this.showDebug}setShowDebug(t){this.showDebug=t}}const Jt=new ua,Dt=window,Et=17,Vi=64,Hi=16,ji=64,kt=Dt.__MESH_MATERIAL_SLOT_NAMES__??["S00","S01","S02","S03","S04","S05","S06","S07","S08","S09","S10","S11","S12","S13","S14","S15"],zt=Dt.__MESH_SCENE_SLOT_NAMES__??["S00","S01","S02","S03","S04","S05","S06","S07","S08","S09","S10","S11","S12","S13","S14","S15"],da=Dt.__MESH_VERT_BEGIN__?Dt.__MESH_VERT_BEGIN__:"",pa=Dt.__MESH_VERT_END__?Dt.__MESH_VERT_END__:"",fa=Dt.__MESH_VERT_OUT_POSITION__,ma=Dt.__MESH_VERT_OUT_FRAG_POS__,ga=Dt.__MESH_VERT_OUT_FRAG_UV__,Ea=Dt.__MESH_VERT_OUT_FRAG_COLOR__,Ca=Dt.__MESH_VERT_OUT_FRAG_NORMAL__,Ta=Dt.__MESH_VERT_OUT_FRAG_TANGENT__,ya=Dt.__MESH_VERT_OUT_FRAG_BINORMAL__,Aa=Dt.__MESH_VERT_OUT_FRAG_SHADOW_POS__,wa=Dt.__MESH_FRAG_BEGIN__?Dt.__MESH_FRAG_BEGIN__:"",xa=Dt.__MESH_FRAG_PRE_TEXTURE__?Dt.__MESH_FRAG_PRE_TEXTURE__:"",va=Dt.__MESH_FRAG_POST_TEXTURE__?Dt.__MESH_FRAG_POST_TEXTURE__:"",Ia=Dt.__MESH_FRAG_END__?Dt.__MESH_FRAG_END__:"",Sa=Dt.__MESH_FRAG_OUT_BASE__,_a=Dt.__MESH_FRAG_OUT_NORMAL__,ba=Dt.__MESH_FRAG_OUT_ID__,Ma={label:"Mesh pipeline",layout:"auto",vertex:{entryPoint:"main",buffers:[{arrayStride:Et*4,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:3*4,format:"float32x2"},{shaderLocation:2,offset:5*4,format:"float32x3"},{shaderLocation:3,offset:8*4,format:"float32x3"},{shaderLocation:4,offset:11*4,format:"float32x3"},{shaderLocation:5,offset:14*4,format:"float32x3"}]}]},fragment:{entryPoint:"main",targets:[{format:navigator.gpu.getPreferredCanvasFormat(),blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha",operation:"add"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"}}},{format:"rgba16float"},{format:"rgba16float"}]},primitive:{topology:"triangle-list",cullMode:"back",frontFace:"ccw"},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth24plus"}},Rn=`
struct MaterialParams {
  ID: f32,
  OPACITY: f32,
  NORMAL_INTENSITY: f32,
  HAS_LIGHTNING: f32,
  HAS_TEXTURE: f32,
  HAS_DISPLACEMENT_MAP: f32,
  DISPLACEMENT_MAP_FACTOR: f32,
  HAS_DIFFUSE_MAP: f32,
  HAS_SPECULAR_MAP: f32,
  HAS_EMISSIVE_MAP: f32,
  HAS_NORMAL_MAP: f32,
  HAS_ENV_MAP: f32,
  HAS_TOON_MAP: f32,
  HAS_DECAL: f32,
  HAS_SHADOW: f32,
  SHININESS: f32,
  EMISSIVE_FACTOR: f32,
  TOON_BLENDING: f32,
  HAS_S0_TEXTURE: f32,
  HAS_S1_TEXTURE: f32,
  ${kt[0]}: f32,
  ${kt[1]}: f32,
  ${kt[2]}: f32,
  ${kt[3]}: f32,
  ${kt[4]}: f32,
  ${kt[5]}: f32,
  ${kt[6]}: f32,
  ${kt[7]}: f32,
  ${kt[8]}: f32,
  ${kt[9]}: f32,
  ${kt[10]}: f32,
  ${kt[11]}: f32,
  ${kt[12]}: f32,
  ${kt[13]}: f32,
  ${kt[14]}: f32,
  ${kt[15]}: f32
};`,On=`
struct SceneInfos {
  CAMERA_POS: vec3<f32>,
  AMBIENT_COLOR: vec3<f32>,
  POINT_LIGHT_COUNT: f32,
  SPOT_LIGHT_COUNT: f32,
  DECAL_COUNT: f32,
  DELTA_TIME: f32,
  TIME: f32,
  ${zt[0]}: f32,
  ${zt[1]}: f32,
  ${zt[2]}: f32,
  ${zt[3]}: f32,
  ${zt[4]}: f32,
  ${zt[5]}: f32,
  ${zt[6]}: f32,
  ${zt[7]}: f32,
  ${zt[8]}: f32,
  ${zt[9]}: f32,
  ${zt[10]}: f32,
  ${zt[11]}: f32,
  ${zt[12]}: f32,
  ${zt[13]}: f32,
  ${zt[14]}: f32,
  ${zt[15]}: f32
};`,Dn=`
struct MeshInfos {
  MVPC_MATRIX: mat4x4<f32>,
  M_MATRIX: mat4x4<f32>,
  NORM_MATRIX: mat3x3<f32>,
  ID: vec4<f32>
};`,Pa=`
struct VertexOutput {
  @builtin(position) Position: vec4<f32>,
  @location(0) FragPos: vec3<f32>,
  @location(1) FragUV: vec2<f32>,
  @location(2) FragColor: vec3<f32>,
  @location(3) FragNormal: vec3<f32>,
  @location(4) FragTangent: vec3<f32>,
  @location(5) FragBinormal: vec3<f32>,
  @location(6) FragShadowPos: vec3<f32>
}

${Dn}
${Rn}
${On}

@group(0) @binding(0) var<uniform> SCENE_INFOS: SceneInfos;
@group(0) @binding(1) var<uniform> LVP_MATRIX: mat4x4<f32>;
@group(1) @binding(0) var<uniform> MESH_INFOS: MeshInfos;
@group(2) @binding(1) var<uniform> MAT_PARAMS: MaterialParams;

@vertex
fn main(
  @location(0) Position: vec4<f32>,
  @location(1) TexUV: vec2<f32>,
  @location(2) Color: vec3<f32>,
  @location(3) Normal: vec3<f32>,
  @location(4) Tangent: vec3<f32>,
  @location(5) Binormal: vec3<f32>
) -> VertexOutput {
  var position = Position;
  var texUV = TexUV;
  var color = Color;
  var normal = Normal;
  var tangent = Tangent;
  var binormal = Binormal;

  ${da}
  var posFromLight = LVP_MATRIX * MESH_INFOS.M_MATRIX * position;
  ${pa}

  var output: VertexOutput;
  ${fa??"output.Position = MESH_INFOS.MVPC_MATRIX * position;"}
  ${ma??"output.FragPos = vec4(MESH_INFOS.M_MATRIX * position).xyz;"}
  ${ga??"output.FragUV = texUV;"}
  ${Ea??"output.FragColor = color;"}
  ${Ca??"output.FragNormal = MESH_INFOS.NORM_MATRIX * normal;"}
  ${Ta??"output.FragTangent = MESH_INFOS.NORM_MATRIX * tangent;"}
  ${ya??"output.FragBinormal = MESH_INFOS.NORM_MATRIX * binormal;"}
  ${Aa??"output.FragShadowPos = vec3(posFromLight.xy * vec2(0.5, -0.5) + vec2(0.5), posFromLight.z); // Convert XY to (0, 1) and Y is flipped because texture coords are Y-down."}
  return output;
}`,Ra=`
struct FragOutput {
  @location(0) Base: vec4f,
  @location(1) Normal: vec4f,
  @location(2) Id: vec4f
}

struct MaterialColors {
  EMISSIVE: vec3<f32>,
  AMBIENT: vec3<f32>,
  DIFFUSE: vec3<f32>,
  SPECULAR: vec3<f32>
}

${Dn}
${Rn}
${On}

struct MaterialUvs {
  TEXTURE_SCROLL: vec2<f32>,
  TEXTURE_OFFSET: vec2<f32>,
  DISPLACEMENT_MAP_SCROLL: vec2<f32>
}

struct PointLight {
  POSITION: vec3<f32>,
  DIFFUSE: vec3<f32>,
  SPECULAR: vec3<f32>,
  ATTEN: vec3<f32>,
  INTENSITY: f32,
  MESH_ID: f32
}

struct SpotLight {
  POSITION: vec3<f32>,
  DIRECTION: vec3<f32>,
  DIFFUSE: vec3<f32>,
  SPECULAR: vec3<f32>,
  ATTEN: vec3<f32>,
  INTENSITY: f32,
  MESH_ID: f32,
  CUTOFF: f32
}

struct DirLight {
  DIR: vec3<f32>,
  ENABLED: f32,
  DIFFUSE: vec3<f32>,
  SPECULAR: vec3<f32>,
  INTENSITY: f32,
  MESH_ID: f32
}

struct Fog {
  ENABLED: f32,
  NEAR: f32,
  FAR: f32,
  COLOR: vec3<f32>,
  FROM: vec3<f32>
}

struct Decal {
  VP_MATRIX: mat4x4<f32>,
  TEXTURE_LEFT: f32,
  TEXTURE_TOP: f32,
  TEXTURE_WIDTH: f32,
  TEXTURE_HEIGHT: f32,
  ASPECT_RATIO: vec2<f32>,
  OPACITY: f32,
  GROUP: f32
}

@group(0) @binding(0) var<uniform> SCENE_INFOS: SceneInfos;
@group(0) @binding(2) var<uniform> DIR_LIGHT: DirLight;
@group(0) @binding(3) var<uniform> POINT_LIGHTS: array<PointLight, ${Vi}>;
@group(0) @binding(4) var<uniform> SPOT_LIGHTS: array<SpotLight, ${Hi}>;
@group(0) @binding(5) var<uniform> DECALS: array<Decal, ${ji}>;
@group(0) @binding(6) var<uniform> FOG: Fog;
@group(0) @binding(7) var DECAL_ATLAS_TEXTURE: texture_2d<f32>;
@group(0) @binding(8) var DECAL_ATLAS_SAMPLER: sampler;
@group(0) @binding(9) var SHADOW_MAP_TEXTURE: texture_depth_2d;
@group(0) @binding(10) var SHADOW_MAP_SAMPLER: sampler_comparison;
@group(0) @binding(11) var S0_TEXTURE: texture_2d<f32>;
@group(0) @binding(12) var S0_SAMPLER: sampler;
@group(0) @binding(13) var S1_TEXTURE: texture_2d<f32>;
@group(0) @binding(14) var S1_SAMPLER: sampler;
@group(1) @binding(0) var<uniform> MESH_INFOS: MeshInfos;
@group(2) @binding(0) var<uniform> MAT_COLORS: MaterialColors;
@group(2) @binding(1) var<uniform> MAT_PARAMS: MaterialParams;
@group(2) @binding(2) var<uniform> MAT_UVS: MaterialUvs;
@group(2) @binding(3) var<uniform> MAT_TOON_LIGHT_DIR: vec3<f32>;
@group(3) @binding(0) var MAT_TEXTURE: texture_2d<f32>;
@group(3) @binding(1) var MAT_SAMPLER: sampler;
@group(3) @binding(2) var MAT_DISPLACEMENT_TEXTURE: texture_2d<f32>;
@group(3) @binding(3) var MAT_DISPLACEMENT_SAMPLER: sampler;
@group(3) @binding(4) var MAT_DIFFUSE_TEXTURE: texture_2d<f32>;
@group(3) @binding(5) var MAT_DIFFUSE_SAMPLER: sampler;
@group(3) @binding(6) var MAT_SPECULAR_TEXTURE: texture_2d<f32>;
@group(3) @binding(7) var MAT_SPECULAR_SAMPLER: sampler;
@group(3) @binding(8) var MAT_EMISSIVE_TEXTURE: texture_2d<f32>;
@group(3) @binding(9) var MAT_EMISSIVE_SAMPLER: sampler;
@group(3) @binding(10) var MAT_NORM_TEXTURE: texture_2d<f32>;
@group(3) @binding(11) var MAT_NORM_SAMPLER: sampler;
@group(3) @binding(12) var MAT_ENV_MAP_TEXTURE: texture_cube<f32>;
@group(3) @binding(13) var MAT_ENV_MAP_SAMPLER: sampler;
@group(3) @binding(14) var MAT_TOON_TEXTURE: texture_2d<f32>;
@group(3) @binding(15) var MAT_TOON_SAMPLER: sampler;
@group(3) @binding(16) var MAT_S0_TEXTURE: texture_2d<f32>;
@group(3) @binding(17) var MAT_S0_SAMPLER: sampler;
@group(3) @binding(18) var MAT_S1_TEXTURE: texture_2d<f32>;
@group(3) @binding(19) var MAT_S1_SAMPLER: sampler;

@fragment
fn main(
  @builtin(position) Position: vec4<f32>,
  @location(0) FragPos: vec3<f32>,
  @location(1) FragUV: vec2<f32>,
  @location(2) FragColor: vec3<f32>,
  @location(3) FragNormal: vec3<f32>,
  @location(4) FragTangent: vec3<f32>,
  @location(5) FragBinormal: vec3<f32>,
  @location(6) FragShadowPos: vec3<f32>
) -> FragOutput {
  var fragPos = FragPos;
  var fragUV = FragUV;
  var fragColor = FragColor;
  var fragNormal = normalize(FragNormal);
  var fragTangent = FragTangent;
  var fragBinormal = FragBinormal;
  var fragShadowPos = FragShadowPos;
  var outputColor = vec4(0.0, 0.0, 0.0, 1.0);
  var texel = vec4(1.0, 1.0, 1.0, 1.0);
  var normalUV = FragUV;

  ${wa}

  ${xa}
  var matS0 = textureSample(MAT_S0_TEXTURE, MAT_S0_SAMPLER, fragUV);
  var matS1 = textureSample(MAT_S1_TEXTURE, MAT_S1_SAMPLER, fragUV);
  var s0 = textureSample(S0_TEXTURE, S0_SAMPLER, fragUV);
  var s1 = textureSample(S1_TEXTURE, S1_SAMPLER, fragUV);
  ${va}

  var textureUV = MAT_UVS.TEXTURE_SCROLL + MAT_UVS.TEXTURE_OFFSET + fragUV;
  var shadow = 1.0;

  if (MAT_PARAMS.HAS_DISPLACEMENT_MAP == 1.0)
  {
    textureUV += CalcDisplacementMap(fragUV);
  }

  if (MAT_PARAMS.HAS_TEXTURE == 1.0)
  {
    texel = textureSample(MAT_TEXTURE, MAT_SAMPLER, textureUV) * vec4<f32>(fragColor, 1.0);
  }

  if (texel.a == 0)
  {
    discard;
  }

  if (MAT_PARAMS.HAS_DECAL == 1.0)
  {
    var decalsColor = CalcDecals(fragPos);
    var alpha = min(texel.a + decalsColor.a, 1.0);
    texel = mix(texel, decalsColor, decalsColor.a);
    texel.a = alpha;
  }

  if (MAT_PARAMS.HAS_NORMAL_MAP == 1.0)
  {
    fragNormal = CalcNormalMap(fragNormal, fragTangent, fragBinormal, normalUV);
  }

  if (MAT_PARAMS.HAS_SHADOW == 1.0)
  {
    shadow = CalcShadow(fragShadowPos);
  }

  if (MAT_PARAMS.HAS_TOON_MAP == 1.0)
  {
    var toonColor = CalcToon(fragNormal, fragPos, shadow);
    outputColor = mix(texel, toonColor, MAT_PARAMS.TOON_BLENDING);
  }
  else if (MAT_PARAMS.HAS_LIGHTNING == 1.0)
  {
    var totalLight = CalcLights(fragNormal, fragPos, textureUV, shadow);
    outputColor = texel * totalLight;
  }
  else
  {
    outputColor = texel;
  }

  if (MAT_PARAMS.HAS_ENV_MAP == 1.0)
  {
    outputColor += CalcEnvMap(fragNormal, fragPos);
  }

  if (FOG.ENABLED == 1.0)
  {
    outputColor = CalcFog(outputColor.rgb, texel.a * MAT_PARAMS.OPACITY, fragPos);
  }
  else
  {
    outputColor = vec4(outputColor.rgb, texel.a * MAT_PARAMS.OPACITY);
  }

  ${Ia}

  var output: FragOutput;
  ${Sa??"output.Base = outputColor;"}
  ${_a??"output.Normal = vec4(normalize(fragNormal), 1.0);"}
  ${ba??"output.Id = MESH_INFOS.ID;"}
  return output;
}

// *****************************************************************************************************************
// CALC FOG
// *****************************************************************************************************************
fn CalcFog(inputColor: vec3<f32>, inputAlpha: f32, fragPos: vec3<f32>) -> vec4<f32>
{
  var fogColor = FOG.COLOR;
  var fogStart = FOG.NEAR;
  var fogEnd = FOG.FAR;
  var fogDist = length(FOG.FROM - fragPos);
  var fogFactor = clamp((fogEnd - fogDist) / (fogEnd - fogStart), 0.0, 1.0);
  var outputColor = (fogColor * (1.0 - fogFactor)) + (inputColor * fogFactor);
  var outputAlpha = mix(inputAlpha, 1.0, fogFactor);
  return vec4<f32>(outputColor, outputAlpha);
}

// *****************************************************************************************************************
// CALC DECALS
// *****************************************************************************************************************
fn CalcDecals(fragPos: vec3<f32>) -> vec4<f32>
{
  var decalsColor = vec4(0.0, 0.0, 0.0, 0.0);
  for (var i: u32 = 0; i < u32(SCENE_INFOS.DECAL_COUNT); i++)
  {
    if (MESH_INFOS.ID.g == DECALS[i].GROUP)
    {
      decalsColor += CalcDecal(DECALS[i], fragPos);
    }
  }

  return decalsColor;
}

// *****************************************************************************************************************
// CALC DECAL
// *****************************************************************************************************************
fn CalcDecal(decal: Decal, fragPos: vec3<f32>) -> vec4<f32>
{
  var ctrlColor = vec4(1.0, 1.0, 1.0, 1.0);
  var clipPos = decal.VP_MATRIX * vec4<f32>(fragPos, 1.0);
  if (clipPos.z < -1.0 || clipPos.z > 1.0)
  {
    ctrlColor = vec4(0.0, 0.0, 0.0, 0.0);
  }

  var ndcPos = vec3<f32>(clipPos.xyz / clipPos.w).xy * decal.ASPECT_RATIO;
  if (ndcPos.x < -1.0 || ndcPos.x > 1.0 || ndcPos.y < -1.0 || ndcPos.y > 1.0)
  {
    ctrlColor = vec4(0.0, 0.0, 0.0, 0.0);
  }

  var uvx = ndcPos.x * 0.5 + 0.5;
  uvx = (uvx * decal.TEXTURE_WIDTH) + decal.TEXTURE_LEFT;

  var uvy = 1.0 - (ndcPos.y * 0.5 + 0.5);
  uvy = (uvy * decal.TEXTURE_HEIGHT) + decal.TEXTURE_TOP;

  var texColor = textureSample(DECAL_ATLAS_TEXTURE, DECAL_ATLAS_SAMPLER, vec2<f32>(uvx, uvy));
  texColor.a = max(texColor.a - (1.0 - decal.OPACITY), 0.0);
  return texColor * ctrlColor;
}

// *****************************************************************************************************************
// CALC NORMAL MAP
// *****************************************************************************************************************
fn CalcNormalMap(normal: vec3<f32>, fragTangent: vec3<f32>, fragBinormal: vec3<f32>, textureUV: vec2<f32>) -> vec3<f32>
{
  var normalIntensity = vec4<f32>(MAT_PARAMS.NORMAL_INTENSITY, MAT_PARAMS.NORMAL_INTENSITY, 1, 1);
  var normalPixel = textureSample(MAT_NORM_TEXTURE, MAT_NORM_SAMPLER, textureUV) * normalIntensity;
  return normalize(normalize(fragTangent) * normalPixel.x + normalize(fragBinormal) * normalPixel.y + normal * normalPixel.z);
}

// *****************************************************************************************************************
// CALC ENV MAP
// *****************************************************************************************************************
fn CalcEnvMap(normal: vec3<f32>, fragPos: vec3<f32>) -> vec4<f32>
{
  var viewDir = normalize(SCENE_INFOS.CAMERA_POS - fragPos);
  var rvec = normalize(reflect(viewDir, normal));
  return textureSample(MAT_ENV_MAP_TEXTURE, MAT_ENV_MAP_SAMPLER, vec3<f32>(rvec.x, rvec.y, rvec.z));
}

// *****************************************************************************************************************
// CALC DISPLACEMENT MAP
// *****************************************************************************************************************
fn CalcDisplacementMap(fragUV: vec2<f32>) -> vec2<f32>
{
  var textureUV = MAT_UVS.DISPLACEMENT_MAP_SCROLL + fragUV;
  var offset = vec2(0.0, 0.0);
  var greyScale = textureSample(MAT_DISPLACEMENT_TEXTURE, MAT_DISPLACEMENT_SAMPLER, textureUV).r;
  offset.x = clamp(MAT_PARAMS.DISPLACEMENT_MAP_FACTOR * ((greyScale * 2) - 1), 0.0, 1.0);
  offset.y = clamp(MAT_PARAMS.DISPLACEMENT_MAP_FACTOR * ((greyScale * 2) - 1), 0.0, 1.0);
  return offset;
}

// *****************************************************************************************************************
// CALC LIGHTS
// *****************************************************************************************************************
fn CalcLights(normal: vec3<f32>, fragPos: vec3<f32>, textureUV: vec2<f32>, shadow: f32) -> vec4<f32>
{
  var totalLight = vec4(0.0, 0.0, 0.0, 0.0);
  var matEmissive = MAT_COLORS.EMISSIVE * MAT_PARAMS.EMISSIVE_FACTOR;

  if (DIR_LIGHT.ENABLED == 1.0 && (DIR_LIGHT.MESH_ID == 0.0 || DIR_LIGHT.MESH_ID == MESH_INFOS.ID.b))
  {
    totalLight += CalcDirLight(normal, fragPos, textureUV, shadow);
  }

  for (var i: u32 = 0; i < u32(SCENE_INFOS.POINT_LIGHT_COUNT); i++)
  {
    if (POINT_LIGHTS[i].MESH_ID == 0.0 || POINT_LIGHTS[i].MESH_ID == MESH_INFOS.ID.b) {
      totalLight += CalcPointLight(POINT_LIGHTS[i], normal, fragPos, textureUV, shadow);
    }
  }

  for (var i: u32 = 0; i < u32(SCENE_INFOS.SPOT_LIGHT_COUNT); i++)
  {
    if (SPOT_LIGHTS[i].MESH_ID == 0.0 || SPOT_LIGHTS[i].MESH_ID == MESH_INFOS.ID.b) {
      totalLight += CalcSpotLight(SPOT_LIGHTS[i], normal, fragPos, textureUV, shadow);
    }
  }

  if (MAT_PARAMS.HAS_EMISSIVE_MAP == 1.0)
  {
    matEmissive = textureSample(MAT_EMISSIVE_TEXTURE, MAT_EMISSIVE_SAMPLER, textureUV).rgb * MAT_PARAMS.EMISSIVE_FACTOR;
  }

  if (length(matEmissive) > 0)
  {
    return vec4(matEmissive, 1.0);
  }

  return totalLight + vec4(SCENE_INFOS.AMBIENT_COLOR, 1.0);
}

// *****************************************************************************************************************
// CALC LIGHT INTERNAL
// *****************************************************************************************************************
fn CalcLightInternal(lightDir: vec3<f32>, lightDiffuse: vec3<f32>, lightSpecular: vec3<f32>, lightIntensity: f32, normal: vec3<f32>, fragPos: vec3<f32>, textureUV: vec2<f32>, shadow: f32) -> vec4<f32>
{
  var diffuseColor = vec3(0.0, 0.0, 0.0);
  var specularColor = vec3(0.0, 0.0, 0.0);
  var matDiffuse = MAT_COLORS.DIFFUSE;
  var matSpecular = MAT_COLORS.SPECULAR;
  var matShininess = MAT_PARAMS.SHININESS;
  var diffuseFactor = max(dot(normal, -lightDir), 0.0);

  if (MAT_PARAMS.HAS_DIFFUSE_MAP == 1.0)
  {
    matDiffuse = textureSample(MAT_DIFFUSE_TEXTURE, MAT_DIFFUSE_SAMPLER, textureUV).rgb;
  }

  if (MAT_PARAMS.HAS_SPECULAR_MAP == 1.0)
  {
    matSpecular = textureSample(MAT_SPECULAR_TEXTURE, MAT_SPECULAR_SAMPLER, textureUV).rgb;
    matShininess = textureSample(MAT_SPECULAR_TEXTURE, MAT_SPECULAR_SAMPLER, textureUV).a;
  }

  if (diffuseFactor > 0.0)
  {
    diffuseColor = lightDiffuse * lightIntensity * matDiffuse * diffuseFactor;
    if (matShininess > 0.0)
    {
      var reflectDir = reflect(lightDir, normal);
      var viewDir = normalize(SCENE_INFOS.CAMERA_POS - fragPos);
      var specularFactor = max(dot(viewDir, reflectDir), 0.0);
      if (specularFactor > 0.0)
      {
        specularFactor = pow(specularFactor, matShininess);
        specularColor = lightSpecular * lightIntensity * matSpecular * specularFactor;
      }
    }
  }

  return vec4((diffuseColor * shadow) + (specularColor * shadow), 1.0);
}

// *****************************************************************************************************************
// CALC DIR LIGHT
// *****************************************************************************************************************
fn CalcDirLight(normal: vec3<f32>, fragPos: vec3<f32>, textureUV: vec2<f32>, shadow: f32) -> vec4<f32>
{
  var lightDir = normalize(DIR_LIGHT.DIR);
  return CalcLightInternal(lightDir, DIR_LIGHT.DIFFUSE, DIR_LIGHT.SPECULAR, DIR_LIGHT.INTENSITY, normal, fragPos, textureUV, shadow);
}

// *****************************************************************************************************************
// CALC POINT LIGHT
// *****************************************************************************************************************
fn CalcPointLight(light: PointLight, normal: vec3<f32>, fragPos: vec3<f32>, textureUV: vec2<f32>, shadow: f32) -> vec4<f32>
{
  var lightDir = fragPos - light.POSITION;
  var distance = length(lightDir);

  var color = CalcLightInternal(normalize(lightDir), light.DIFFUSE, light.SPECULAR, light.INTENSITY, normal, fragPos, textureUV, shadow);
  var attenuation = light.ATTEN[0] + light.ATTEN[1] * distance + light.ATTEN[2] * distance * distance;
  return color / attenuation;
}

// *****************************************************************************************************************
// CALC SPOT LIGHT
// *****************************************************************************************************************
fn CalcSpotLight(light: SpotLight, normal: vec3<f32>, fragPos: vec3<f32>, textureUV: vec2<f32>, shadow: f32) -> vec4<f32>
{
  var lightDir = fragPos - light.POSITION;
  var normLightDir = normalize(lightDir);
  var distance = length(lightDir);
  var spotFactor = dot(normLightDir, normalize(light.DIRECTION));
  var color = CalcLightInternal(normalize(lightDir), light.DIFFUSE, light.SPECULAR, light.INTENSITY, normal, fragPos, textureUV, shadow);

  if (spotFactor > light.CUTOFF)
  {
    var attenuation = light.ATTEN[0] + light.ATTEN[1] * distance + light.ATTEN[2] * distance * distance;
    var spotIntensity = (1.0 - (1.0 - spotFactor) / (1.0 - light.CUTOFF));
    return (color / attenuation) * spotIntensity;
  }
  else
  {
    return vec4(0.0, 0.0, 0.0, 0.0);
  }
}

// *****************************************************************************************************************
// CALC TOON
// *****************************************************************************************************************
fn CalcToon(normal: vec3<f32>, fragPos: vec3<f32>, shadow: f32) -> vec4<f32>
{
  var n = normalize(normal);
  var lightDir = normalize(MAT_TOON_LIGHT_DIR);
  var viewDir = normalize(SCENE_INFOS.CAMERA_POS - fragPos);
  var s = max(dot(n, -lightDir), 0.0);
  var t = max(dot(n, viewDir), 0.0);
  var color = textureSample(MAT_TOON_TEXTURE, MAT_TOON_SAMPLER, vec2<f32>(s, t));
  return color * shadow;
}

// *****************************************************************************************************************
// CALC SHADOW
// *****************************************************************************************************************
fn CalcShadow(fragShadowPos: vec3<f32>) -> f32
{
  var visibility = 0.0;
  var shadowDepthTextureSize = f32(textureDimensions(SHADOW_MAP_TEXTURE).x);
  var oneOverShadowDepthTextureSize = 1.0 / shadowDepthTextureSize;

  for (var y = -1; y <= 1; y++)
  {
    for (var x = -1; x <= 1; x++)
    {
      var offset = vec2<f32>(vec2(x, y)) * oneOverShadowDepthTextureSize;
      visibility += textureSampleCompare(SHADOW_MAP_TEXTURE, SHADOW_MAP_SAMPLER, fragShadowPos.xy + offset, fragShadowPos.z - 0.007);
    }
  }

  return visibility / 9.0;
}`;const Oa={label:"Mesh Shadow pipeline",layout:"auto",vertex:{entryPoint:"main",buffers:[{arrayStride:Et*4,attributes:[{shaderLocation:0,offset:0,format:"float32x3"}]}]},primitive:{topology:"triangle-list",cullMode:"back",frontFace:"ccw"},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth32float"}},Da=`
@group(0) @binding(0) var<uniform> LVP_MATRIX: mat4x4<f32>;
@group(0) @binding(1) var<uniform> M_MATRIX: mat4x4<f32>;

@vertex
fn main(
  @location(0) position: vec3<f32>
) -> @builtin(position) vec4<f32> {
  return LVP_MATRIX * M_MATRIX * vec4(position, 1.0);
}`;class La extends ze{depthTextureSize;depthTexture;depthTextureSampler;meshCommands;grp0;lvpMatrix;mMatrix;constructor(){super("MESH_SHADOW_MAP_PIPELINE",Da,"",Oa),this.depthTextureSize=2048,this.depthTexture=k.getDevice().createTexture({size:[this.depthTextureSize,this.depthTextureSize,1],usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING,format:"depth32float"}),this.depthTextureSampler=k.getDevice().createSampler({compare:"less"}),this.meshCommands=[],this.grp0=k.createDynamicGroup("MESH_SHADOW_MAP_PIPELINE",0),this.lvpMatrix=this.grp0.setFloat(0,"LVP_MATRIX",16),this.mMatrix=this.grp0.setFloat(1,"M_MATRIX",16)}render(){const e=k.getCommandEncoder().beginRenderPass({colorAttachments:[],depthStencilAttachment:{view:this.depthTexture.createView(),depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"}});e.setPipeline(this.pipeline),this.grp0.getSize()<this.meshCommands.length&&this.grp0.allocate(this.meshCommands.length),this.grp0.beginWrite();for(let s=0;s<this.meshCommands.length;s++){const i=this.meshCommands[s];this.grp0.write(0,this.lvpMatrix),this.grp0.write(1,f.MAT4_COPY(i.matrix,this.mMatrix)),e.setBindGroup(0,this.grp0.getBindGroup(s)),e.setVertexBuffer(0,k.getVertexBuffer(),i.mesh.getVertexSubBufferOffset(),i.mesh.getVertexSubBufferSize()),e.draw(i.mesh.getVertexCount())}this.grp0.endWrite(),this.meshCommands=[],e.end()}drawMesh(t,e=null){const s=e||t.getTransformMatrix();this.meshCommands.push({mesh:t,matrix:s})}setShadowProjection(t,e,s=600,i=200){const r=f.MAT4_ORTHOGRAPHIC(s,s,i),n=f.MAT4_INVERT(f.MAT4_LOOKAT(t,e,[0,1,0]));f.MAT4_MULTIPLY(r,n,this.lvpMatrix)}setDepthTextureSize(t){this.depthTexture=k.getDevice().createTexture({size:[t,t,1],usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING,format:"depth32float"}),this.depthTextureSampler=k.getDevice().createSampler({compare:"less"}),this.depthTextureSize=t}getDepthTexture(){return{gpuTexture:this.depthTexture,gpuSampler:this.depthTextureSampler}}getLVPMatrix(){return this.lvpMatrix}}const Ps=new La;class Na extends ze{shadowEnabled;textureChanged;meshCommands;grp0;sceneInfos;lvpMatrix;dirLight;pointLights;spotLights;decals;fog;decalAtlas;shadowMap;s0Texture;s1Texture;grp1;meshInfos;constructor(){super("MESH_PIPELINE",Pa,Ra,Ma),this.shadowEnabled=!1,this.textureChanged=!1,this.meshCommands=[],this.grp0=k.createStaticGroup("MESH_PIPELINE",0),this.sceneInfos=this.grp0.setFloat(0,"SCENE_INFOS",28),this.lvpMatrix=this.grp0.setFloat(1,"LVP_MATRIX",16),this.dirLight=this.grp0.setFloat(2,"DIR_LIGHT",16),this.pointLights=this.grp0.setFloat(3,"POINT_LIGHTS",20*Vi),this.spotLights=this.grp0.setFloat(4,"SPOT_LIGHTS",24*Hi),this.decals=this.grp0.setFloat(5,"DECALS",24*ji),this.fog=this.grp0.setFloat(6,"FOG",12),this.decalAtlas=this.grp0.setTexture(7,"DECAL_ATLAS_TEXTURE",k.createTextureFromBitmap()),this.decalAtlas=this.grp0.setSampler(8,"DECAL_ATLAS_SAMPLER",this.decalAtlas),this.shadowMap=this.grp0.setTexture(9,"SHADOW_MAP_TEXTURE",Ps.getDepthTexture()),this.shadowMap=this.grp0.setSampler(10,"SHADOW_MAP_SAMPLER",this.shadowMap),this.s0Texture=this.grp0.setTexture(11,"S0_TEXTURE",k.createTextureFromBitmap()),this.s0Texture=this.grp0.setSampler(12,"S0_SAMPLER",this.s0Texture),this.s1Texture=this.grp0.setTexture(13,"S1_TEXTURE",k.createTextureFromBitmap()),this.s1Texture=this.grp0.setSampler(14,"S1_SAMPLER",this.s1Texture),this.grp1=k.createDynamicGroup("MESH_PIPELINE",1),this.meshInfos=this.grp1.setFloat(0,"MESH_MATRICES",16*5),this.grp0.allocate(),this.grp1.allocate()}render(t){const e=k.getCurrentView(),s=k.getPassEncoder(),i=e.getBillboardProjectionClipMatrix(),r=e.getViewProjectionClipMatrix();s.setPipeline(this.pipeline),this.textureChanged&&(this.grp0.setTexture(7,"DECAL_ATLAS_TEXTURE",this.decalAtlas),this.grp0.setTexture(11,"S0_TEXTURE",this.s0Texture),this.grp0.setTexture(13,"S1_TEXTURE",this.s1Texture),this.grp0.allocate(),this.textureChanged=!1),this.grp0.beginWrite(),this.grp0.write(0,Fa(e.getCameraPosition(),t,this.sceneInfos)),this.grp0.write(1,Ps.getLVPMatrix()),this.grp0.write(2,this.dirLight),this.grp0.write(3,this.pointLights),this.grp0.write(4,this.spotLights),this.grp0.write(5,this.decals),this.grp0.write(6,this.fog),this.grp0.endWrite(),s.setBindGroup(0,this.grp0.getBindGroup()),this.grp1.getSize()<this.meshCommands.length&&this.grp1.allocate(this.meshCommands.length),this.grp1.beginWrite();for(let n=0;n<this.meshCommands.length;n++){const o=this.meshCommands[n];this.grp1.write(0,Ua(o.mesh.billboard?i:r,o.matrix,o.mesh.getId(),this.meshInfos)),s.setBindGroup(1,this.grp1.getBindGroup(n));const a=o.mesh.getMaterial(),l=a.getGroup02(),c=a.getGroup03();s.setBindGroup(2,l.getBindGroup()),s.setBindGroup(3,c.getBindGroup()),s.setVertexBuffer(0,k.getVertexBuffer(),o.mesh.getVertexSubBufferOffset(),o.mesh.getVertexSubBufferSize()),s.draw(o.mesh.getVertexCount())}this.grp1.endWrite(),this.dirLight.fill(0),this.sceneInfos[7]=0,this.pointLights.fill(0),this.sceneInfos[8]=0,this.spotLights.fill(0),this.sceneInfos[9]=0,this.decals.fill(0),this.meshCommands=[]}enableShadow(t){this.shadowEnabled=t}setDecalAtlas(t){this.decalAtlas=t,this.textureChanged=!0}enableFog(t,e=[0,0,0],s=[.5,.5,.5],i=3,r=15){this.fog[0]=t?1:0,this.fog[1]=i,this.fog[2]=r,this.fog[3]=0,this.fog[4]=s[0],this.fog[5]=s[1],this.fog[6]=s[2],this.fog[7]=0,this.fog[8]=e[0],this.fog[9]=e[1],this.fog[10]=e[2],this.fog[11]=0}drawMesh(t,e=null){const s=e??t.getTransformMatrix();this.meshCommands.push({mesh:t,matrix:s}),this.shadowEnabled&&t.getShadowCasting()&&Ps.drawMesh(t,s)}setAmbientColor(t){this.sceneInfos[4]=t[0],this.sceneInfos[5]=t[1],this.sceneInfos[6]=t[2]}setCustomParam(t,e){const s=zt.findIndex(i=>i==t);if(s==-1)throw new Error("Gfx3MeshRenderer::setCustomParam(): Custom param name not found !");this.sceneInfos[12+s]=e}getCustomParam(t){const e=zt.findIndex(s=>s==t);if(e==-1)throw new Error("Gfx3MeshRenderer::getCustomParam(): Custom param name not found !");return this.sceneInfos[12+e]}setCustomTextures(t){t[0]&&(this.s0Texture=t[0],this.textureChanged=!0),t[1]&&(this.s1Texture=t[1],this.textureChanged=!0)}drawDirLight(t,e,s,i=1,r=0){this.dirLight[0]=t[0],this.dirLight[1]=t[1],this.dirLight[2]=t[2],this.dirLight[3]=1,this.dirLight[4]=e[0],this.dirLight[5]=e[1],this.dirLight[6]=e[2],this.dirLight[7]=0,this.dirLight[8]=s[0],this.dirLight[9]=s[1],this.dirLight[10]=s[2],this.dirLight[11]=i,this.dirLight[12]=r,this.dirLight[13]=0,this.dirLight[14]=0,this.dirLight[15]=0}drawPointLight(t,e,s,i=1,r=0,n=1,o=0,a=0){const l=this.sceneInfos[7];if(l>=Vi)throw new Error("Gfx3MeshRenderer::drawPointLight(): Max point lights number exceeded !");this.pointLights[l*20+0]=t[0],this.pointLights[l*20+1]=t[1],this.pointLights[l*20+2]=t[2],this.pointLights[l*20+3]=0,this.pointLights[l*20+4]=e[0],this.pointLights[l*20+5]=e[1],this.pointLights[l*20+6]=e[2],this.pointLights[l*20+7]=0,this.pointLights[l*20+8]=s[0],this.pointLights[l*20+9]=s[1],this.pointLights[l*20+10]=s[2],this.pointLights[l*20+11]=0,this.pointLights[l*20+12]=n,this.pointLights[l*20+13]=o,this.pointLights[l*20+14]=a,this.pointLights[l*20+15]=i,this.pointLights[l*20+16]=r,this.pointLights[l*20+17]=0,this.pointLights[l*20+18]=0,this.pointLights[l*20+19]=0,this.sceneInfos[7]++}drawSpotLight(t,e,s,i,r,n=1,o=0,a=1,l=0,c=0){const u=this.sceneInfos[8];if(u>=Hi)throw new Error("Gfx3MeshRenderer::drawSpotLight(): Max spot lights number exceeded !");this.spotLights[u*24+0]=t[0],this.spotLights[u*24+1]=t[1],this.spotLights[u*24+2]=t[2],this.spotLights[u*24+3]=0,this.spotLights[u*24+4]=e[0],this.spotLights[u*24+5]=e[1],this.spotLights[u*24+6]=e[2],this.spotLights[u*24+7]=0,this.spotLights[u*24+8]=i[0],this.spotLights[u*24+9]=i[1],this.spotLights[u*24+10]=i[2],this.spotLights[u*24+11]=0,this.spotLights[u*24+12]=r[0],this.spotLights[u*24+13]=r[1],this.spotLights[u*24+14]=r[2],this.spotLights[u*24+15]=0,this.spotLights[u*24+16]=a,this.spotLights[u*24+17]=l,this.spotLights[u*24+18]=c,this.spotLights[u*24+19]=n,this.spotLights[u*24+20]=o,this.spotLights[u*24+21]=Math.cos(s),this.spotLights[u*24+22]=0,this.spotLights[u*24+23]=0,this.sceneInfos[8]++}drawDecal(t,e,s,i,r,n,o,a,l,c,u){const p=this.sceneInfos[9];if(p>=ji)throw new Error("Gfx3MeshRenderer::drawDecal(): Max decals number exceeded !");const d=[o[0],o[1],o[2],0,a[0],a[1],a[2],0,l[0],l[1],l[2],0,n[0],n[1],n[2],1],E=[i>r?1:r/i,i>r?i/r:1],m=f.MAT4_INVERT(d),y=f.MAT4_ORTHOGRAPHIC(c[0],c[1],c[2]),C=f.MAT4_MULTIPLY(m,y);this.decals[p*24+0]=C[0],this.decals[p*24+1]=C[1],this.decals[p*24+2]=C[2],this.decals[p*24+3]=C[3],this.decals[p*24+4]=C[4],this.decals[p*24+5]=C[5],this.decals[p*24+6]=C[6],this.decals[p*24+7]=C[7],this.decals[p*24+8]=C[8],this.decals[p*24+9]=C[9],this.decals[p*24+10]=C[10],this.decals[p*24+11]=C[11],this.decals[p*24+12]=C[12],this.decals[p*24+13]=C[13],this.decals[p*24+14]=C[14],this.decals[p*24+15]=C[15],this.decals[p*24+16]=e/this.decalAtlas.gpuTexture.width,this.decals[p*24+17]=s/this.decalAtlas.gpuTexture.height,this.decals[p*24+18]=i/this.decalAtlas.gpuTexture.width,this.decals[p*24+19]=r/this.decalAtlas.gpuTexture.height,this.decals[p*24+20]=E[0],this.decals[p*24+21]=E[1],this.decals[p*24+22]=u,this.decals[p*24+23]=t,this.sceneInfos[9]++}}const Ot=new Na;function Fa(h,t,e){return e[0]=h[0],e[1]=h[1],e[2]=h[2],e[3]=0,e[10]=t/1e3,e[11]+=e[10],e}function Ua(h,t,e,s){return f.MAT4_MULTIPLY(h,t,s),s.set(t,16),s[32+0]=t[0],s[32+1]=t[1],s[32+2]=t[2],s[32+3]=0,s[32+4]=t[4],s[32+5]=t[5],s[32+6]=t[6],s[32+7]=0,s[32+8]=t[8],s[32+9]=t[9],s[32+10]=t[10],s[32+11]=0,s[32+12]=e[0],s[32+13]=e[1],s[32+14]=e[2],s[32+15]=e[3],s}const Ln=5,Ba={label:"Sprite pipeline",layout:"auto",vertex:{entryPoint:"main",buffers:[{arrayStride:Ln*4,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:3*4,format:"float32x2"}]}]},fragment:{entryPoint:"main",targets:[{format:navigator.gpu.getPreferredCanvasFormat(),blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha",operation:"add"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"}}},{format:"rgba16float"},{format:"rgba16float"}]},primitive:{topology:"triangle-list",cullMode:"back",frontFace:"ccw"},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth24plus"}},Va=`
struct VertexOutput {
  @builtin(position) Position: vec4<f32>,
  @location(0) FragUV: vec2<f32>
};

@group(0) @binding(0) var<uniform> MVPC_MATRIX: mat4x4<f32>;

@vertex
fn main(
  @location(0) Position : vec4<f32>,
  @location(1) TexUV : vec2<f32>
) -> VertexOutput {
  var output: VertexOutput;
  output.Position = MVPC_MATRIX * Position;
  output.FragUV = TexUV;
  return output;
}`,Ha=`
struct FragOutput {
  @location(0) Base: vec4f,
  @location(1) Normal: vec4f,
  @location(2) Id: vec4f
}

@group(0) @binding(1) var<uniform> ID: vec4<f32>;
@group(1) @binding(0) var TEXTURE: texture_2d<f32>;
@group(1) @binding(1) var SAMPLER: sampler;

@fragment
fn main(
  @location(0) FragUV: vec2<f32>
) -> FragOutput {
  var textureColor = textureSample(TEXTURE, SAMPLER, FragUV);
  if (textureColor.a == 0)
  {
    discard;
  }

  var output: FragOutput;
  output.Base = textureColor;
  output.Normal = vec4(0.0, 0.0, 0.0, 0.0);
  output.Id = ID;
  return output;
}`;class ja extends ze{sprites;grp0;mvpcMatrix;id;constructor(){super("SPRITE_PIPELINE",Va,Ha,Ba),this.sprites=[],this.grp0=k.createDynamicGroup("SPRITE_PIPELINE",0),this.mvpcMatrix=this.grp0.setFloat(0,"MVPC_MATRIX",16),this.id=this.grp0.setFloat(1,"ID",4),this.grp0.allocate()}render(){const t=k.getCurrentView(),e=k.getPassEncoder();e.setPipeline(this.pipeline),this.grp0.getSize()<this.sprites.length&&this.grp0.allocate(this.sprites.length),this.grp0.beginWrite();for(let s=0;s<this.sprites.length;s++){const i=this.sprites[s];if(i.getBillboardMode()){const n=t.getCameraMatrix(),o=t.getCameraViewMatrix(),a=t.getProjectionClipMatrix(),l=f.MAT4_MULTIPLY(o,i.getTransformMatrix());f.MAT4_MULTIPLY(l,n,l),f.MAT4_MULTIPLY(l,f.MAT4_TRANSLATE(o[12],o[13],o[14]),l),f.MAT4_MULTIPLY(a,l,this.mvpcMatrix)}else{const n=t.getViewProjectionClipMatrix();f.MAT4_MULTIPLY(n,i.getTransformMatrix(),this.mvpcMatrix)}this.grp0.write(0,this.mvpcMatrix),this.grp0.write(1,f.VEC4_COPY(i.getId(),this.id)),e.setBindGroup(0,this.grp0.getBindGroup(s));const r=i.getGroup01();e.setBindGroup(1,r.getBindGroup()),e.setVertexBuffer(0,k.getVertexBuffer(),i.getVertexSubBufferOffset(),i.getVertexSubBufferSize()),e.draw(i.getVertexCount())}this.grp0.endWrite(),this.sprites=[]}drawSprite(t){this.sprites.push(t)}}const Nn=new ja,Fn=6,ka={label:"Skybox pipeline",layout:"auto",vertex:{entryPoint:"main",buffers:[{arrayStride:Fn*4,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:3*4,format:"float32x3"}]}]},fragment:{entryPoint:"main",targets:[{format:navigator.gpu.getPreferredCanvasFormat(),blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha",operation:"add"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"}}},{format:"rgba16float"},{format:"rgba16float"}]},primitive:{topology:"triangle-list",cullMode:"back",frontFace:"ccw"},depthStencil:{depthWriteEnabled:!1,depthCompare:"always",format:"depth24plus"}},Wa=`
struct VertexOutput {
  @builtin(position) Position: vec4<f32>,
  @location(0) ClipPos: vec4<f32>
};

@vertex
fn main(
  @location(0) Position: vec4<f32>,
) -> VertexOutput {
  var output : VertexOutput;
  output.Position = Position;
  output.Position.z = 1;
  output.ClipPos = Position;
  return output;
}`,Ga=`
struct FragOutput {
  @location(0) Base: vec4f,
  @location(1) Normal: vec4f,
  @location(2) Id: vec4f
};

@group(0) @binding(0) var<uniform> VPC_INVERSE_MATRIX: mat4x4<f32>;
@group(0) @binding(1) var<uniform> ID: vec4<f32>;
@group(1) @binding(0) var CUBEMAP_TEXTURE: texture_cube<f32>;
@group(1) @binding(1) var CUBEMAP_SAMPLER: sampler;

@fragment
fn main(
  @builtin(position) Position: vec4<f32>,
  @location(0) ClipPos: vec4<f32>
) -> FragOutput {
  var t = VPC_INVERSE_MATRIX * ClipPos;

  var output: FragOutput;
  output.Base = textureSample(CUBEMAP_TEXTURE, CUBEMAP_SAMPLER, normalize(t.xyz / t.w));
  output.Normal = vec4(0.0, 0.0, 0.0, 0.0);
  output.Id = ID;
  return output;
}`;class za extends ze{skybox;grp0;vpcInverseMatrix;id;constructor(){super("SKYBOX_PIPELINE",Wa,Ga,ka),this.skybox=null,this.grp0=k.createStaticGroup("SKYBOX_PIPELINE",0),this.vpcInverseMatrix=this.grp0.setFloat(0,"VPC_INVERSE_MATRIX",16),this.id=this.grp0.setFloat(1,"ID",4),this.grp0.allocate()}render(){if(!this.skybox)return;const t=k.getCurrentView(),e=k.getPassEncoder();e.setPipeline(this.pipeline);const s=new Float32Array(t.getCameraViewMatrix());s[12]=s[13]=s[14]=0;const i=f.MAT4_MULTIPLY(t.getProjectionClipMatrix(),s);this.grp0.beginWrite(),this.grp0.write(0,f.MAT4_INVERT(i,this.vpcInverseMatrix)),this.grp0.write(1,f.VEC4_COPY(this.skybox.getId(),this.id)),this.grp0.endWrite(),e.setBindGroup(0,this.grp0.getBindGroup());const r=this.skybox.getGroup01();e.setBindGroup(1,r.getBindGroup()),e.setVertexBuffer(0,k.getVertexBuffer(),this.skybox.getVertexSubBufferOffset(),this.skybox.getVertexSubBufferSize()),e.draw(this.skybox.getVertexCount())}draw(t){this.skybox=t}}const Un=new za,Bn=4,qa={label:"Flare pipeline",layout:"auto",vertex:{entryPoint:"main",buffers:[{arrayStride:Bn*4,attributes:[{shaderLocation:0,offset:0,format:"float32x2"},{shaderLocation:1,offset:2*4,format:"float32x2"}]}]},fragment:{entryPoint:"main",targets:[{format:navigator.gpu.getPreferredCanvasFormat(),blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha",operation:"add"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"}}},{format:"rgba16float"},{format:"rgba16float"}]},primitive:{topology:"triangle-list",cullMode:"none",frontFace:"ccw"},depthStencil:{depthWriteEnabled:!1,depthCompare:"less",format:"depth24plus"}},Xa=`
struct VertexOutput {
  @builtin(position) Position: vec4<f32>,
  @location(0) FragUV: vec2<f32>
};

@group(0) @binding(0) var<uniform> RESOLUTION: vec2<f32>;
@group(1) @binding(1) var<uniform> TRANSLATION: vec2<f32>;
@group(1) @binding(2) var<uniform> SCALE: vec2<f32>;
@group(1) @binding(3) var<uniform> ANGLE: f32;
@group(1) @binding(4) var<uniform> SIZE: vec2<f32>;
@group(1) @binding(5) var<uniform> OFFSET: vec2<f32>;

@vertex
fn main(
  @location(0) Pos: vec2<f32>,
  @location(1) TexUV: vec2<f32>
) -> VertexOutput {
  var c = cos(ANGLE);
  var s = sin(ANGLE);
  var transformedPos = Pos * SIZE + OFFSET;
  transformedPos = transformedPos * SCALE;
  transformedPos = vec2(c * (transformedPos.x) + s * (transformedPos.y), c * (transformedPos.y) - s * (transformedPos.x));

  var screenPos = transformedPos + TRANSLATION;
  var normScreenPos = screenPos / RESOLUTION;
  var clipPos = normScreenPos * 2.0 - 1.0;
  clipPos.y = clipPos.y * -1;

  var output: VertexOutput;
  output.Position = vec4<f32>(clipPos, 0, 1);
  output.FragUV = TexUV;
  return output;
}`,Ya=`
struct FragOutput {
  @location(0) Base: vec4f,
  @location(1) Normal: vec4f,
  @location(2) Id: vec4f
}

@group(1) @binding(0) var<uniform> ID: vec4<f32>;
@group(1) @binding(6) var<uniform> COLOR: vec4<f32>;
@group(2) @binding(0) var TEXTURE: texture_2d<f32>;
@group(2) @binding(1) var SAMPLER: sampler;

@fragment
fn main(
  @builtin(position) Position: vec4<f32>,
  @location(0) FragUV: vec2<f32>
) -> FragOutput {
  var output: FragOutput;
  output.Base = textureSample(TEXTURE, SAMPLER, FragUV) * COLOR;
  output.Normal = vec4(0.0, 0.0, 0.0, 0.0);
  output.Id = ID;
  return output;
}`;class Za extends ze{flares;grp0;resolution;grp1;id;translation;scale;angle;size;offset;color;constructor(){super("FLARE_PIPELINE",Xa,Ya,qa),this.flares=[],this.grp0=k.createStaticGroup("FLARE_PIPELINE",0),this.resolution=this.grp0.setFloat(0,"RESOLUTION",2),this.grp1=k.createDynamicGroup("FLARE_PIPELINE",1),this.id=this.grp1.setFloat(0,"ID",4),this.translation=this.grp1.setFloat(1,"TRANSLATION",2),this.scale=this.grp1.setFloat(2,"SCALE",2),this.angle=this.grp1.setFloat(3,"ANGLE",1),this.size=this.grp1.setFloat(4,"SIZE",2),this.offset=this.grp1.setFloat(5,"OFFSET",2),this.color=this.grp1.setFloat(6,"COLOR",4),this.grp0.allocate(),this.grp1.allocate()}render(){const t=k.getCurrentView(),e=k.getPassEncoder();e.setPipeline(this.pipeline),this.grp0.beginWrite(),this.grp0.write(0,f.VEC2_COPY(t.getViewportSize(),this.resolution)),this.grp0.endWrite(),e.setBindGroup(0,this.grp0.getBindGroup()),this.grp1.getSize()<this.flares.length&&this.grp1.allocate(this.flares.length),this.grp1.beginWrite();for(let s=0;s<this.flares.length;s++){const i=this.flares[s];this.grp1.write(0,f.VEC4_COPY(i.getId(),this.id)),this.grp1.write(1,f.VEC2_COPY(i.getPosition2D(),this.translation)),this.grp1.write(2,f.VEC2_COPY(i.getScale2D(),this.scale)),this.grp1.write(3,f.VEC1_COPY(i.getRotation2D(),this.angle)),this.grp1.write(4,f.VEC2_COPY(i.getSize2D(),this.size)),this.grp1.write(5,f.VEC2_COPY(i.getOffset2D(),this.offset)),this.grp1.write(6,f.VEC4_COPY(i.getColor(),this.color)),e.setBindGroup(1,this.grp1.getBindGroup(s));const r=i.getGroup02();e.setBindGroup(2,r.getBindGroup()),e.setVertexBuffer(0,k.getVertexBuffer(),i.getVertexSubBufferOffset(),i.getVertexSubBufferSize()),e.draw(i.getVertexCount())}this.grp1.endWrite(),this.flares=[]}drawFlare(t){this.flares.push(t)}}const Vn=new Za,Hn=15,Ka={label:"Particles pipeline",layout:"auto",vertex:{entryPoint:"main",buffers:[{arrayStride:Hn*4,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:3*4,format:"float32x3"},{shaderLocation:2,offset:6*4,format:"float32x2"},{shaderLocation:3,offset:8*4,format:"float32x3"},{shaderLocation:4,offset:11*4,format:"float32"},{shaderLocation:5,offset:12*4,format:"float32"},{shaderLocation:6,offset:13*4,format:"float32"},{shaderLocation:7,offset:14*4,format:"float32"}]}]},fragment:{entryPoint:"main",targets:[{format:navigator.gpu.getPreferredCanvasFormat(),blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha",operation:"add"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"}}},{format:"rgba16float"},{format:"rgba16float"}]},primitive:{topology:"triangle-list",cullMode:"none",frontFace:"ccw"},depthStencil:{depthWriteEnabled:!1,depthCompare:"less",format:"depth24plus"}},$a=`
struct VertexOutput {
  @builtin(position) Position: vec4<f32>,
  @location(0) FragUV: vec2<f32>,
  @location(1) Color: vec4<f32>,
  @location(2) Angle: f32
};

@group(0) @binding(0) var<uniform> V_MATRIX: mat4x4<f32>;
@group(1) @binding(0) var<uniform> MVPC_MATRIX: mat4x4<f32>;

@vertex
fn main(
  @location(0) Pos: vec3<f32>,
  @location(1) Center: vec3<f32>,
  @location(2) TexUV: vec2<f32>,
  @location(3) Color: vec3<f32>,
  @location(4) Size: f32,
  @location(5) Opacity: f32,
  @location(6) Angle: f32,
  @location(7) Visible: f32
) -> VertexOutput {
  var output: VertexOutput;

  if(Visible == 1)
  {
    output.Color = vec4(Color, Opacity);
  }
  else
  {
    output.Color = vec4(0.0, 0.0, 0.0, 0.0);
  }

  var right = vec3<f32>(V_MATRIX[0][0], V_MATRIX[1][0], V_MATRIX[2][0]);
  var up = vec3<f32>(V_MATRIX[0][1], V_MATRIX[1][1], V_MATRIX[2][1]);

  output.Position = MVPC_MATRIX * vec4<f32>(Center + (right * Pos.x * Size) + (up * Pos.y * Size), 1.0);
  output.FragUV = TexUV;
  output.Angle = Angle;
  return output;
}`,Ja=`
struct FragOutput {
  @location(0) Base: vec4f,
  @location(1) Normal: vec4f,
  @location(2) Id: vec4f
}

@group(1) @binding(1) var<uniform> ID: vec4<f32>;
@group(2) @binding(0) var TEXTURE: texture_2d<f32>;
@group(2) @binding(1) var SAMPLER: sampler;

@fragment
fn main(
  @builtin(position) Position: vec4<f32>,
  @location(0) FragUV: vec2<f32>,
  @location(1) Color: vec4<f32>,
  @location(2) Angle: f32
) -> FragOutput {
  var c = cos(Angle);
  var s = sin(Angle);

  var rotatedUV = vec2(
    c * (FragUV.x - 0.5) + s * (FragUV.y - 0.5) + 0.5,
    c * (FragUV.y - 0.5) - s * (FragUV.x - 0.5) + 0.5
  );

  var output: FragOutput;
  output.Base = textureSample(TEXTURE, SAMPLER, rotatedUV) * Color;
  output.Normal = vec4(0.0, 0.0, 0.0, 0.0);
  output.Id = ID;
  return output;
}`;class Qa extends ze{particlesList;grp0;vMatrix;grp1;mvpcMatrix;id;constructor(){super("PARTICLES_PIPELINE",$a,Ja,Ka),this.particlesList=[],this.grp0=k.createStaticGroup("PARTICLES_PIPELINE",0),this.vMatrix=this.grp0.setFloat(0,"V_MATRIX",16),this.grp1=k.createDynamicGroup("PARTICLES_PIPELINE",1),this.mvpcMatrix=this.grp1.setFloat(0,"MVPC_MATRIX",16),this.id=this.grp1.setFloat(1,"ID",4),this.grp0.allocate(),this.grp1.allocate()}render(){const t=k.getCurrentView(),e=k.getPassEncoder(),s=t.getViewProjectionClipMatrix();e.setPipeline(this.pipeline),this.grp0.beginWrite(),this.grp0.write(0,f.MAT4_COPY(t.getCameraViewMatrix(),this.vMatrix)),this.grp0.endWrite(),e.setBindGroup(0,this.grp0.getBindGroup()),this.grp1.getSize()<this.particlesList.length&&this.grp1.allocate(this.particlesList.length),this.grp1.beginWrite();for(let i=0;i<this.particlesList.length;i++){const r=this.particlesList[i];this.grp1.write(0,f.MAT4_MULTIPLY(s,r.getTransformMatrix(),this.mvpcMatrix)),this.grp1.write(1,f.VEC4_COPY(r.getId(),this.id)),e.setBindGroup(1,this.grp1.getBindGroup(i));const n=r.getGroup02();e.setBindGroup(2,n.getBindGroup()),e.setVertexBuffer(0,k.getVertexBuffer(),r.getVertexSubBufferOffset(),r.getVertexSubBufferSize()),e.draw(r.getVertexCount())}this.grp1.endWrite(),this.particlesList=[]}drawParticles(t){this.particlesList.push(t)}}const jn=new Qa,rr=6;const th={label:"Mesh Shadow Volume CW pipeline",layout:"auto",vertex:{entryPoint:"main",buffers:[{arrayStride:rr*4,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:3*4,format:"float32x3"}]}]},fragment:{entryPoint:"main",targets:[{format:"rgba16float"}]},primitive:{topology:"triangle-list",cullMode:"back",frontFace:"cw"},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth24plus"}},eh={label:"Mesh Shadow Volume CCW pipeline",layout:"auto",vertex:{entryPoint:"main",buffers:[{arrayStride:rr*4,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:3*4,format:"float32x3"}]}]},fragment:{entryPoint:"main",targets:[{format:"rgba16float"}]},primitive:{topology:"triangle-list",cullMode:"back",frontFace:"ccw"},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth24plus"}},Mr=`
struct VertexOutput {
  @builtin(position) Position: vec4<f32>,
  @location(0) Color: vec3<f32>
}

@group(0) @binding(0) var<uniform> MVPC_MATRIX: mat4x4<f32>;

@vertex
fn main(
  @location(0) Position: vec4<f32>,
  @location(1) Color: vec3<f32>
) -> VertexOutput {
  var output: VertexOutput;
  output.Position = MVPC_MATRIX * Position;
  output.Color = Color;
  return output;
}`,Pr=`
@fragment
fn main(
  @builtin(position) Position: vec4<f32>,
  @location(0) Color: vec3<f32>
) -> @location(0) vec4f {
  return vec4<f32>(Color.r, Color.g, Color.b, 1.0);
}`;class sh{pipelineCW;pipelineCCW;shadowVolumes;mvpcMatrix;constructor(){this.pipelineCW={gpu:k.loadPipeline("SHADOW_VOLUME_CW_PIPELINE",Mr,Pr,th),grp0:k.createDynamicGroup("SHADOW_VOLUME_CW_PIPELINE",0),shadowTexture:k.createRenderingTexture("rgba16float"),depthTexture:k.createRenderingTexture("depth24plus")},this.pipelineCCW={gpu:k.loadPipeline("SHADOW_VOLUME_CCW_PIPELINE",Mr,Pr,eh),grp0:k.createDynamicGroup("SHADOW_VOLUME_CCW_PIPELINE",0),shadowTexture:k.createRenderingTexture("rgba16float"),depthTexture:k.createRenderingTexture("depth24plus")},this.shadowVolumes=[],this.mvpcMatrix=this.pipelineCW.grp0.setFloat(0,"MVPC_MATRIX",16),this.mvpcMatrix=this.pipelineCCW.grp0.setFloat(0,"MVPC_MATRIX",16),this.pipelineCW.grp0.allocate(),this.pipelineCCW.grp0.allocate(),v.subscribe(Cs,"E_RESIZE",this,this.#e)}render(){this.#t(this.pipelineCW),this.#t(this.pipelineCCW),this.shadowVolumes=[]}drawShadowVolume(t){this.shadowVolumes.push(t)}getShadowTexture(){return this.pipelineCCW.shadowTexture}getDepthCWTexture(){return this.pipelineCW.depthTexture}getDepthCCWTexture(){return this.pipelineCCW.depthTexture}#t(t){const e=k.getCurrentView(),i=k.getCommandEncoder().beginRenderPass({colorAttachments:[{view:t.shadowTexture.gpuTexture.createView(),clearValue:{r:1,g:1,b:1,a:1},loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{view:t.depthTexture.gpuTexture.createView(),depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"}}),r=e.getViewProjectionClipMatrix();i.setPipeline(t.gpu),t.grp0.getSize()<this.shadowVolumes.length&&t.grp0.allocate(this.shadowVolumes.length),t.grp0.beginWrite();for(let n=0;n<this.shadowVolumes.length;n++){const o=this.shadowVolumes[n];f.MAT4_MULTIPLY(r,o.getTransformMatrix(),this.mvpcMatrix),t.grp0.write(0,this.mvpcMatrix),i.setBindGroup(0,t.grp0.getBindGroup(n)),i.setVertexBuffer(0,k.getVertexBuffer(),o.getVertexSubBufferOffset(),o.getVertexSubBufferSize()),i.draw(o.getVertexCount())}t.grp0.endWrite(),i.end()}#e(){this.pipelineCCW.shadowTexture.gpuTexture.destroy(),this.pipelineCCW.shadowTexture=k.createRenderingTexture("rgba16float"),this.pipelineCCW.depthTexture.gpuTexture.destroy(),this.pipelineCCW.depthTexture=k.createRenderingTexture("depth24plus"),this.pipelineCW.shadowTexture.gpuTexture.destroy(),this.pipelineCW.shadowTexture=k.createRenderingTexture("rgba16float"),this.pipelineCW.depthTexture.gpuTexture.destroy(),this.pipelineCW.depthTexture=k.createRenderingTexture("depth24plus")}}const Ve=new sh,Os=window,kn=4,qt=Os.__POST_SLOT_NAMES__??["S00","S01","S02","S03","S04","S05","S06","S07","S08","S09","S10","S11","S12","S13","S14","S15"],ih=Os.__POST_FRAG_BEGIN__?Os.__POST_FRAG_BEGIN__:"",rh=Os.__POST_FRAG_END__?Os.__POST_FRAG_END__:"",nh={label:"POST pipeline",layout:"auto",vertex:{entryPoint:"main",buffers:[{arrayStride:kn*4,attributes:[{shaderLocation:0,offset:0,format:"float32x2"},{shaderLocation:1,offset:2*4,format:"float32x2"}]}]},fragment:{entryPoint:"main",targets:[{format:navigator.gpu.getPreferredCanvasFormat()}]},primitive:{topology:"triangle-list"}},oh=`
struct VertexOutput {
  @builtin(position) Position: vec4<f32>,
  @location(0) FragUV: vec2<f32>
};

@vertex
fn main(
  @location(0) Position: vec2<f32>,
  @location(1) TexUV: vec2<f32>
) -> VertexOutput {
  var output: VertexOutput;
  output.Position = vec4(Position, 0.0, 1.0);
  output.FragUV = TexUV;
  return output;
}`,ah=`
struct Infos {
  RES_WIDTH: f32,
  RES_HEIGHT: f32,
  DELTA_TIME: f32,
  TIME: f32
};

struct Params {
  ENABLED: f32,
  PIXELATION_ENABLED: f32,
  PIXELATION_WIDTH: f32,
  PIXELATION_HEIGHT: f32,
  COLOR_ENABLED: f32,
  COLOR_PRECISION: f32,
  DITHER_ENABLED: f32,
  DITHER_PATTERN_INDEX: f32,
  DITHER_THRESHOLD: f32,
  DITHER_SCALE_X: f32,
  DITHER_SCALE_Y: f32,
  OUTLINE_ENABLED: f32,
  OUTLINE_THICKNESS: f32,
  OUTLINE_R: f32,
  OUTLINE_G: f32,
  OUTLINE_B: f32,
  OUTLINE_CONSTANT: f32,
  SHADOW_VOLUME_ENABLED: f32,
  SHADOW_VOLUME_BLEND_MODE: f32,
  ${qt[0]}: f32,
  ${qt[1]}: f32,
  ${qt[2]}: f32,
  ${qt[3]}: f32,
  ${qt[4]}: f32,
  ${qt[5]}: f32,
  ${qt[6]}: f32,
  ${qt[7]}: f32,
  ${qt[8]}: f32,
  ${qt[9]}: f32,
  ${qt[10]}: f32,
  ${qt[11]}: f32,
  ${qt[12]}: f32,
  ${qt[13]}: f32,
  ${qt[14]}: f32,
  ${qt[15]}: f32
};

@group(0) @binding(0) var<uniform> PARAMS: Params;
@group(0) @binding(1) var<uniform> INFOS: Infos;
@group(0) @binding(2) var SOURCE_TEXTURE: texture_2d<f32>;
@group(0) @binding(3) var SOURCE_SAMPLER: sampler;
@group(0) @binding(4) var NORMALS_TEXTURE: texture_2d<f32>;
@group(0) @binding(5) var NORMALS_SAMPLER: sampler;
@group(0) @binding(6) var IDS_TEXTURE: texture_2d<f32>;
@group(0) @binding(7) var IDS_SAMPLER: sampler;
@group(0) @binding(8) var DEPTH_TEXTURE: texture_depth_2d;
@group(0) @binding(9) var DEPTH_SAMPLER: sampler;

@group(1) @binding(0) var SHADOW_VOL_TEXTURE: texture_2d<f32>;
@group(1) @binding(1) var SHADOW_VOL_SAMPLER: sampler;
@group(1) @binding(2) var SHADOW_VOL_DEPTH_CCW_TEXTURE: texture_depth_2d;
@group(1) @binding(3) var SHADOW_VOL_DEPTH_CCW_SAMPLER: sampler;
@group(1) @binding(4) var SHADOW_VOL_DEPTH_CW_TEXTURE: texture_depth_2d;
@group(1) @binding(5) var SHADOW_VOL_DEPTH_CW_SAMPLER: sampler;

@group(2) @binding(0) var S0_TEXTURE: texture_2d<f32>;
@group(2) @binding(1) var S0_SAMPLER: sampler;
@group(2) @binding(2) var S1_TEXTURE: texture_2d<f32>;
@group(2) @binding(3) var S1_SAMPLER: sampler;

@fragment
fn main(
  @location(0) FragUV: vec2<f32>
) -> @location(0) vec4<f32> {
  var outputColor = textureSample(SOURCE_TEXTURE, SOURCE_SAMPLER, FragUV);
  var fragUV = FragUV;

  ${ih}

  if (PARAMS.ENABLED == 0.0)
  {
    return outputColor;
  }

  var id = textureSample(IDS_TEXTURE, IDS_SAMPLER, fragUV);
  var flags = u32(id.a);

  if (PARAMS.PIXELATION_ENABLED == 1.0 && (flags & 1) == 1)
  {    
    fragUV.x = floor(fragUV.x * PARAMS.PIXELATION_WIDTH) / PARAMS.PIXELATION_WIDTH;
    fragUV.y = floor(fragUV.y * PARAMS.PIXELATION_HEIGHT) / PARAMS.PIXELATION_HEIGHT;
  }

  outputColor = textureSample(SOURCE_TEXTURE, SOURCE_SAMPLER, fragUV);
  id = textureSample(IDS_TEXTURE, IDS_SAMPLER, fragUV);
  flags = u32(id.a);

  var normal = textureSample(NORMALS_TEXTURE, NORMALS_SAMPLER, fragUV);
  var depth = textureSample(DEPTH_TEXTURE, DEPTH_SAMPLER, fragUV);
  var shadowVol = textureSample(SHADOW_VOL_TEXTURE, SHADOW_VOL_SAMPLER, fragUV);
  var shadowVolDepthCW = textureSample(SHADOW_VOL_DEPTH_CW_TEXTURE, SHADOW_VOL_DEPTH_CW_SAMPLER, fragUV);
  var shadowVolDepthCCW = textureSample(SHADOW_VOL_DEPTH_CCW_TEXTURE, SHADOW_VOL_DEPTH_CCW_SAMPLER, fragUV);
  var s0 = textureSample(S0_TEXTURE, S0_SAMPLER, fragUV);
  var s1 = textureSample(S1_TEXTURE, S1_SAMPLER, fragUV);

  if (PARAMS.COLOR_ENABLED == 1.0 && (flags & 2) == 2)
  {
    outputColor = floor(outputColor * PARAMS.COLOR_PRECISION) / PARAMS.COLOR_PRECISION;
  }

  if (PARAMS.DITHER_ENABLED == 1.0 && (flags & 4) == 4)
  {
    var brightness = GetPixelBrightness(outputColor.rgb);
    var ditherPattern = GetDitherPattern(PARAMS.DITHER_PATTERN_INDEX);
    var ditherX = u32((FragUV.x * INFOS.RES_WIDTH) / PARAMS.DITHER_SCALE_X);
    var ditherY = u32((FragUV.y * INFOS.RES_HEIGHT) / PARAMS.DITHER_SCALE_Y);
    var ditherPixel = GetDitherValue(ditherX, ditherY, brightness, ditherPattern);
    outputColor = outputColor * ditherPixel;
  }

  if (PARAMS.OUTLINE_ENABLED == 1.0 && (flags & 8) == 8)
  {
    var t = PARAMS.OUTLINE_THICKNESS * (depth - 1.0);
    var idDiff = 0.0;

    if (PARAMS.OUTLINE_CONSTANT == 1.0)
    {
      t = PARAMS.OUTLINE_THICKNESS;
    }

    idDiff += distance(id, getIdValue(fragUV, vec2<f32>( t,  0)));
    idDiff += distance(id, getIdValue(fragUV, vec2<f32>( 0,  t)));
    idDiff += distance(id, getIdValue(fragUV, vec2<f32>( 0,  t)));
    idDiff += distance(id, getIdValue(fragUV, vec2<f32>( 0, -t)));
    idDiff += distance(id, getIdValue(fragUV, vec2<f32>( t,  t)));
    idDiff += distance(id, getIdValue(fragUV, vec2<f32>( t, -t)));
    idDiff += distance(id, getIdValue(fragUV, vec2<f32>(-t,  t)));
    idDiff += distance(id, getIdValue(fragUV, vec2<f32>(-t, -t)));

    if (idDiff != 0.0)
    {
      idDiff = 1.0;
      var outline = clamp(idDiff, 0, 1);
      outputColor = mix(outputColor, vec4<f32>(PARAMS.OUTLINE_R, PARAMS.OUTLINE_G, PARAMS.OUTLINE_B, 1.0), outline);  
    }
  }

  if (PARAMS.SHADOW_VOLUME_ENABLED == 1.0 && (flags & 16) == 16)
  {
    if (shadowVolDepthCW != 1.0 && shadowVolDepthCCW != 1.0 && depth >= shadowVolDepthCCW && depth <= shadowVolDepthCW)
    {
      if (PARAMS.SHADOW_VOLUME_BLEND_MODE == 1.0)
      {
        outputColor += shadowVol;
      }
      else
      {
        outputColor *= shadowVol;
      }
    }
  }

  ${rh}

  return outputColor;
}

// *****************************************************************************************************************
// GET TEXEL VALUE
// *****************************************************************************************************************
fn getTexelValue(textureUV: vec2<f32>, offset: vec2<f32>) -> vec4<f32>
{
  var ps = vec2<f32>(1.0 / INFOS.RES_WIDTH, 1.0 / INFOS.RES_HEIGHT);
  return textureSample(SOURCE_TEXTURE, SOURCE_SAMPLER, textureUV + ps * offset);
}

// *****************************************************************************************************************
// GET NORMAL VALUE
// *****************************************************************************************************************
fn getNormalValue(textureUV: vec2<f32>, offset: vec2<f32>) -> vec4<f32>
{
  var ps = vec2<f32>(1.0 / INFOS.RES_WIDTH, 1.0 / INFOS.RES_HEIGHT);
  return textureSampleBaseClampToEdge(NORMALS_TEXTURE, NORMALS_SAMPLER, textureUV + ps * offset);
}

// *****************************************************************************************************************
// GET ID VALUE
// *****************************************************************************************************************
fn getIdValue(textureUV: vec2<f32>, offset: vec2<f32>) -> vec4<f32>
{
  var ps = vec2<f32>(1.0 / INFOS.RES_WIDTH, 1.0 / INFOS.RES_HEIGHT);
  return textureSampleBaseClampToEdge(IDS_TEXTURE, IDS_SAMPLER, textureUV + ps * offset);
}

// *****************************************************************************************************************
// GET DEPTH VALUE
// *****************************************************************************************************************
fn getDepthValue(textureUV: vec2<f32>, offset: vec2<f32>) -> f32
{
  var ps = vec2<f32>(1.0 / INFOS.RES_WIDTH, 1.0 / INFOS.RES_HEIGHT);
  return textureSample(DEPTH_TEXTURE, DEPTH_SAMPLER, textureUV + ps * offset);
}

// *****************************************************************************************************************
// GET DITHER PATTERN
// *****************************************************************************************************************
fn GetDitherPattern(index: f32) -> mat4x4<f32>
{
  var pattern = mat4x4<f32>();

  if (index == 0)
  {
    pattern = mat4x4<f32>(
      0, 1, 0, 1,
      1, 0, 1, 0,
      0, 1, 0, 1,
      1, 0, 1, 0 
    );
  }         
  else if (index == 1)
  {
    pattern = mat4x4<f32>(
      0.23, 0.2, 0.6, 0.2,
      0.2, 0.43, 0.2, 0.77,
      0.88, 0.2, 0.87, 0.2,
      0.2, 0.46, 0.2, 0
    );
  }           
  else if (index == 2)
  {
    pattern = mat4x4<f32>(
      -4.0, 0.0, -3.0, 1.0,
      2.0, -2.0, 3.0, -1.0,
      -3.0, 1.0, -4.0, 0.0,
      3.0, -1.0, 2.0, -2.0
    );
  }       
  else if (index == 3)
  {
    pattern = mat4x4<f32>(
      1, 0, 0, 1,
      0, 1, 1, 0,
      0, 1, 1, 0,
      1, 0, 0, 1 
    );
  }
  else 
  {
    pattern = mat4x4<f32>(
      1, 1, 1, 1,
      1, 1, 1, 1,
      1, 1, 1, 1,
      1, 1, 1, 1
    );
  }
  
  return pattern;
}

// *****************************************************************************************************************
// GET DITHER VALUE
// *****************************************************************************************************************
fn GetDitherValue(x: u32, y: u32, brightness: f32, pattern: mat4x4<f32>) -> f32
{
  if ((brightness * PARAMS.DITHER_THRESHOLD) < pattern[x % 4][y % 4]) 
  {
    return 0;
  }
  else
  {
    return 1;
  }
}

// *****************************************************************************************************************
// GET PIXEL BRIGHTNESS
// *****************************************************************************************************************
fn GetPixelBrightness(color: vec3<f32>) -> f32
{
  return color.r + color.g + color.b / 3.0;
}`;var Ss=(h=>(h[h.ENABLED=0]="ENABLED",h[h.PIXELATION_ENABLED=1]="PIXELATION_ENABLED",h[h.PIXELATION_WIDTH=2]="PIXELATION_WIDTH",h[h.PIXELATION_HEIGHT=3]="PIXELATION_HEIGHT",h[h.COLOR_ENABLED=4]="COLOR_ENABLED",h[h.COLOR_PRECISION=5]="COLOR_PRECISION",h[h.DITHER_ENABLED=6]="DITHER_ENABLED",h[h.DITHER_PATTERN_INDEX=7]="DITHER_PATTERN_INDEX",h[h.DITHER_THRESHOLD=8]="DITHER_THRESHOLD",h[h.DITHER_SCALE_X=9]="DITHER_SCALE_X",h[h.DITHER_SCALE_Y=10]="DITHER_SCALE_Y",h[h.OUTLINE_ENABLED=11]="OUTLINE_ENABLED",h[h.OUTLINE_THICKNESS=12]="OUTLINE_THICKNESS",h[h.OUTLINE_R=13]="OUTLINE_R",h[h.OUTLINE_G=14]="OUTLINE_G",h[h.OUTLINE_B=15]="OUTLINE_B",h[h.OUTLINE_CONSTANT=16]="OUTLINE_CONSTANT",h[h.SHADOW_VOLUME_ENABLED=17]="SHADOW_VOLUME_ENABLED",h[h.SHADOW_VOLUME_BLEND_MODE=18]="SHADOW_VOLUME_BLEND_MODE",h))(Ss||{});class hh extends ze{device;vertexBuffer;grp0;params;infos;sourceTexture;normalsTexture;idsTexture;depthTexture;grp1;shadowVolFactorTexture;shadowVolDepthCWTexture;shadowVolDepthCCWTexture;grp2;s0Texture;s1Texture;constructor(){super("POST_PIPELINE",oh,ah,nh),this.device=k.getDevice(),this.vertexBuffer=this.device.createBuffer({size:6*kn*4,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC}),this.grp0=k.createStaticGroup("POST_PIPELINE",0),this.params=this.grp0.setFloat(0,"PARAMS",35),this.params[0]=1,this.params[1]=0,this.params[2]=400,this.params[3]=400,this.params[4]=0,this.params[5]=32,this.params[6]=0,this.params[7]=0,this.params[8]=1,this.params[9]=1,this.params[10]=1,this.params[11]=0,this.params[12]=120,this.params[13]=0,this.params[14]=0,this.params[15]=0,this.params[16]=0,this.params[17]=1,this.params[18]=0,this.infos=this.grp0.setFloat(1,"INFOS",4),this.infos[0]=k.getWidth(),this.infos[1]=k.getHeight(),this.sourceTexture=this.grp0.setTexture(2,"SOURCE_TEXTURE",k.createRenderingTexture()),this.sourceTexture=this.grp0.setSampler(3,"SOURCE_SAMPLER",this.sourceTexture),this.normalsTexture=this.grp0.setTexture(4,"NORMALS_TEXTURE",k.getNormalsTexture()),this.normalsTexture=this.grp0.setSampler(5,"NORMALS_SAMPLER",this.normalsTexture),this.idsTexture=this.grp0.setTexture(6,"IDS_TEXTURE",k.getIdsTexture()),this.idsTexture=this.grp0.setSampler(7,"IDS_SAMPLER",this.idsTexture),this.depthTexture=this.grp0.setTexture(8,"DEPTH_TEXTURE",k.getDepthTexture()),this.depthTexture=this.grp0.setSampler(9,"DEPTH_SAMPLER",this.depthTexture),this.grp0.allocate(),this.grp1=k.createStaticGroup("POST_PIPELINE",1),this.shadowVolFactorTexture=this.grp1.setTexture(0,"SHADOW_VOL_TEXTURE",Ve.getShadowTexture()),this.shadowVolFactorTexture=this.grp1.setSampler(1,"SHADOW_VOL_SAMPLER",this.shadowVolFactorTexture),this.shadowVolDepthCCWTexture=this.grp1.setTexture(2,"SHADOW_VOL_DEPTH_CCW_TEXTURE",Ve.getDepthCCWTexture()),this.shadowVolDepthCCWTexture=this.grp1.setSampler(3,"SHADOW_VOL_DEPTH_CCW_SAMPLER",this.shadowVolDepthCCWTexture),this.shadowVolDepthCWTexture=this.grp1.setTexture(4,"SHADOW_VOL_DEPTH_CW_TEXTURE",Ve.getDepthCWTexture()),this.shadowVolDepthCWTexture=this.grp1.setSampler(5,"SHADOW_VOL_DEPTH_CW_SAMPLER",this.shadowVolDepthCWTexture),this.grp1.allocate(),this.grp2=k.createStaticGroup("POST_PIPELINE",2),this.s0Texture=this.grp2.setTexture(0,"S0_TEXTURE",k.createTextureFromBitmap()),this.s0Texture=this.grp2.setSampler(1,"S0_SAMPLER",this.s0Texture),this.s1Texture=this.grp2.setTexture(2,"S1_TEXTURE",k.createTextureFromBitmap()),this.s1Texture=this.grp2.setSampler(3,"S1_SAMPLER",this.s1Texture),this.grp2.allocate(),this.device.queue.writeBuffer(this.vertexBuffer,0,new Float32Array([-1,1,0,0,1,1,1,0,-1,-1,0,1,-1,-1,0,1,1,1,1,0,1,-1,1,1])),v.subscribe(Cs,"E_RESIZE",this,this.#t)}render(t,e){const i=k.getCommandEncoder().beginRenderPass({colorAttachments:[{view:e.createView(),loadOp:"clear",storeOp:"store"}]});this.infos[2]=t/1e3,this.infos[3]+=this.infos[2],i.setPipeline(this.pipeline),this.grp0.beginWrite(),this.grp0.write(0,this.params),this.grp0.write(1,this.infos),this.grp0.endWrite(),i.setBindGroup(0,this.grp0.getBindGroup()),i.setBindGroup(1,this.grp1.getBindGroup()),i.setBindGroup(2,this.grp2.getBindGroup()),i.setVertexBuffer(0,this.vertexBuffer),i.draw(6),i.end()}setParam(t,e){this.params[t]=e}getParam(t){return this.params[t]}setCustomParam(t,e){const s=qt.findIndex(i=>i==t);if(s==-1)throw new Error("Gfx3PostRenderer::setCustomParam(): Custom param name not found !");this.params[19+s]=e}getCustomParam(t){const e=qt.findIndex(s=>s==t);if(e==-1)throw new Error("Gfx3PostRenderer::getCustomParam(): Custom param name not found !");return this.params[19+e]}setCustomTextures(t){t[0]&&(this.s0Texture=this.grp2.setTexture(0,"S0_TEXTURE",t[0])),t[1]&&(this.s1Texture=this.grp2.setTexture(2,"S1_TEXTURE",t[1])),this.grp2.allocate()}getSourceTexture(){return this.sourceTexture.gpuTexture}setSourceTexture(t){this.sourceTexture.gpuTexture.destroy(),this.sourceTexture=this.grp0.setTexture(2,"SOURCE_TEXTURE",t),this.sourceTexture=this.grp0.setSampler(3,"SOURCE_SAMPLER",this.sourceTexture),this.grp0.allocate()}#t(){this.infos[0]=k.getWidth(),this.infos[1]=k.getHeight(),this.sourceTexture.gpuTexture.destroy(),this.sourceTexture=this.grp0.setTexture(2,"SOURCE_TEXTURE",k.createRenderingTexture()),this.normalsTexture=this.grp0.setTexture(4,"NORMALS_TEXTURE",k.getNormalsTexture()),this.idsTexture=this.grp0.setTexture(6,"IDS_TEXTURE",k.getIdsTexture()),this.depthTexture=this.grp0.setTexture(8,"DEPTH_TEXTURE",k.getDepthTexture()),this.grp0.allocate(),this.shadowVolFactorTexture=this.grp1.setTexture(0,"SHADOW_VOL_TEXTURE",Ve.getShadowTexture()),this.shadowVolDepthCCWTexture=this.grp1.setTexture(2,"SHADOW_VOL_DEPTH_CCW_TEXTURE",Ve.getDepthCCWTexture()),this.shadowVolDepthCWTexture=this.grp1.setTexture(4,"SHADOW_VOL_DEPTH_CW_TEXTURE",Ve.getDepthCWTexture()),this.grp1.allocate()}}const os=new hh,qs="default",lh={muted:!1,volume:1};class ch{sounds;soundGroups;constructor(){this.sounds=new Map,this.soundGroups=new Map}async loadSound(t,e=qs,s=""){return s=s||t,new Promise(i=>{const r={audio:new Audio(t),groupId:e};r.audio.addEventListener("canplaythrough",()=>{this.sounds.set(s,r),this.soundGroups.set(e,{...lh}),i(r)})})}deleteSound(t){if(!this.sounds.has(t))throw new Error("SoundManager::deleteSound(): The sound file doesn't exist, cannot delete !");const e=this.sounds.get(t);e.audio.src="",this.sounds.delete(t)}playSound(t,e=!1){if(!this.sounds.has(t))throw new Error("SoundManager::play(): The sound file doesn't exist, cannot play !");const s=this.sounds.get(t);return s.audio.loop=e,s.audio.play()}pauseSound(t){if(!this.sounds.has(t))throw new Error("SoundManager::pause(): The sound file doesn't exist, cannot pause !");this.sounds.get(t).audio.pause()}releaseSounds(){for(const t of this.sounds.keys()){const e=this.sounds.get(t);e.audio.src="",this.sounds.delete(t)}}mute(t,e=qs){const s=this.soundGroups.get(e);if(!s)throw new Error("SoundManager::mute(): Group not found !");for(const i of this.sounds.values())i.groupId==e&&(i.audio.muted=t);s.muted=t}setVolume(t,e=qs){const s=this.soundGroups.get(e);if(!s)throw new Error("SoundManager::setVolume(): Group not found !");for(const i of this.sounds.values())i.groupId==e&&(i.audio.volume=t);s.volume=t}isMuted(t=qs){const e=this.soundGroups.get(t);if(!e)throw new Error("SoundManager::isMuted(): Group not found !");return e.muted}}const ki=new ch;class uh{requests;screens;constructor(){this.requests=[],this.screens=[]}update(t){for(;this.requests.length>0;)this.requests.pop()();for(let e=this.screens.length-1;e>=0;e--)this.screens[e].isBlocking()||this.screens[e].update(t)}draw(){for(let t=this.screens.length-1;t>=0;t--)this.screens[t].isBlocking()||this.screens[t].draw()}requestPushScreen(t,e={}){this.requests.push(()=>{if(this.screens.indexOf(t)!=-1)throw new Error("ScreenManager::requestPushScreen(): You try to push an existing screen to the stack !");this.screens[this.screens.length-1].onBringToBack(t),t.onEnter(e).then(()=>this.screens.push(t))})}requestSetScreen(t,e={}){this.requests.push(()=>{this.screens.forEach(i=>i.onExit()),this.screens=[],t.onEnter(e).then(()=>this.screens.push(t))})}requestPopScreen(){this.requests.push(()=>{if(this.screens.length==0)throw new Error("ScreenManager::requestPopScreen: You try to pop an empty state stack !");let t=this.screens[this.screens.length-1];t.onExit(),this.screens.pop(),this.screens.length>0&&this.screens[this.screens.length-1].onBringToFront(t)})}}const ut=new uh;class dh{root;fadeLayer;overLayer;focusedWidget;widgets;constructor(){this.root=document.getElementById("UI_ROOT"),this.fadeLayer=document.getElementById("UI_FADELAYER"),this.overLayer=document.getElementById("UI_OVERLAYER"),this.focusedWidget=null,this.widgets=[]}update(t){for(let e of this.widgets)e.update(t)}getWidgets(){return this.widgets}focus(t){this.focusedWidget&&this.focusedWidget.unfocus(),t.focus(),this.focusedWidget=t,v.emit(this,"E_FOCUSED",{widget:t})}unfocus(){this.focusedWidget&&(this.focusedWidget.unfocus(),this.focusedWidget=null,v.emit(this,"E_UNFOCUSED"))}addNode(t,e=""){t.style.cssText+=e,this.root.appendChild(t)}removeNode(t){this.root.removeChild(t)}addWidget(t,e=""){return t.appendStyles(e),this.root.appendChild(t.getNode()),this.widgets.push(t),t}removeWidget(t){const e=this.widgets.indexOf(t);if(e==-1)throw new Error("UIManager::removeWidget: fail to remove widget !");return t==this.focusedWidget&&this.unfocus(),t.delete(),this.widgets.splice(e,1),!0}clear(){for(this.root.innerHTML="",this.focusedWidget=null;this.widgets.length>0;)this.widgets.pop().delete()}fadeIn(t,e,s="#000",i="linear",r=()=>{}){this.fadeLayer.style.transitionDelay=t+"ms",this.fadeLayer.style.transitionDuration=e+"ms",this.fadeLayer.style.backgroundColor=s,this.fadeLayer.style.transitionTimingFunction=i,this.fadeLayer.style.opacity="1",setTimeout(()=>{r()},t+e)}fadeOut(t,e,s="linear",i=()=>{}){this.fadeLayer.style.transitionDuration=e+"ms",this.fadeLayer.style.transitionDelay=t+"ms",this.fadeLayer.style.transitionTimingFunction=s,this.fadeLayer.style.opacity="0",setTimeout(()=>{i()},t+e)}enableOverlayer(t){this.overLayer.style.opacity=t?"1":"0"}setClassName(t){this.root.className=t}}const P=new dh;class Tt{min;max;constructor(t=[0,0,0],e=[0,0,0]){this.min=t,this.max=e}static createFromCoord(t,e,s,i,r,n){const o=new Tt;return o.min[0]=t,o.min[1]=e,o.min[2]=s,o.max[0]=t+i,o.max[1]=e+r,o.max[2]=s+n,o}static createFromCenter(t,e,s,i,r,n){const o=new Tt;return o.min[0]=t-i*.5,o.min[1]=e-r*.5,o.min[2]=s-n*.5,o.max[0]=t+i*.5,o.max[1]=e+r*.5,o.max[2]=s+n*.5,o}static createFromVertices(t,e){const s=new Tt;return s.fromVertices(t,e),s}static merge(t){const e=[t[0].min[0],t[0].min[1],t[0].min[2]],s=[t[0].max[0],t[0].max[1],t[0].max[2]];for(const i of t)for(let r=0;r<3;r++)e[r]=Math.min(i.min[r],e[r]),s[r]=Math.max(i.max[r],s[r]);return new Tt(e,s)}fromVertices(t,e){const s=[t[0],t[1],t[2]],i=[t[0],t[1],t[2]];for(let r=0;r<t.length;r+=e)for(let n=0;n<3;n++){const o=t[r+n];s[n]=Math.min(o,s[n]),i[n]=Math.max(o,i[n])}this.min=s,this.max=i}merge(t){const e=[this.min[0],this.min[1],this.min[2]],s=[this.max[0],this.max[1],this.max[2]];for(let i=0;i<3;i++)e[i]=Math.min(t.min[i],e[i]),s[i]=Math.max(t.max[i],s[i]);return new Tt(e,s)}getCenter(){const t=(this.min[0]+this.max[0])*.5,e=(this.min[1]+this.max[1])*.5,s=(this.min[2]+this.max[2])*.5;return[t,e,s]}getSize(){const t=this.max[0]-this.min[0],e=this.max[1]-this.min[1],s=this.max[2]-this.min[2];return[t,e,s]}getWidth(){return this.max[0]-this.min[0]}getHeight(){return this.max[1]-this.min[1]}getDepth(){return this.max[2]-this.min[2]}getRadius(){return f.VEC3_DISTANCE(this.min,this.max)*.5}getPerimeter(){const t=this.max[0]-this.min[0],e=this.max[2]-this.min[2];return t+t+e+e}getVolume(){const t=this.max[0]-this.min[0],e=this.max[1]-this.min[1],s=this.max[2]-this.min[2];return t*e*s}transform(t){const e=[];e.push([this.min[0],this.min[1],this.min[2]]),e.push([this.max[0],this.min[1],this.min[2]]),e.push([this.max[0],this.max[1],this.min[2]]),e.push([this.min[0],this.max[1],this.min[2]]),e.push([this.min[0],this.max[1],this.max[2]]),e.push([this.max[0],this.max[1],this.max[2]]),e.push([this.max[0],this.min[1],this.max[2]]),e.push([this.min[0],this.min[1],this.max[2]]);const s=e.map(n=>f.MAT4_MULTIPLY_BY_VEC4(t,[n[0],n[1],n[2],1])),i=[s[0][0],s[0][1],s[0][2]],r=[s[0][0],s[0][1],s[0][2]];for(let n=0;n<s.length;n++)for(let o=0;o<3;o++){const a=s[n][o];i[o]=Math.min(a,i[o]),r[o]=Math.max(a,r[o])}return new Tt(i,r)}splitVertical(){const t=this.getSize(),e=this.getCenter();return[Tt.createFromCoord(this.min[0],this.min[1],this.min[2],t[0]*.5,t[1],t[2]),Tt.createFromCoord(e[0],this.min[1],this.min[2],t[0]*.5,t[1],t[2])]}splitHorizontal(){const t=this.getSize(),e=this.getCenter();return[Tt.createFromCoord(this.min[0],this.min[1],this.min[2],t[0],t[1]*.5,t[2]),Tt.createFromCoord(this.min[0],e[1],this.min[2],t[0],t[1]*.5,t[2])]}splitDepth(){const t=this.getSize(),e=this.getCenter();return[Tt.createFromCoord(this.min[0],this.min[1],this.min[2],t[0],t[1],t[2]*.5),Tt.createFromCoord(this.min[0],this.min[1],e[2],t[0],t[1],t[2]*.5)]}isPointInside(t,e,s){return f.COLLIDE_POINT_TO_BOX([t,e,s],this.min,this.max)}intersectBoundingBox(t){return f.COLLIDE_BOX_TO_BOX(this.min,this.max,t.min,t.max)}reset(){this.min=[0,0,0],this.max=[0,0,0]}setMin(t){this.min=t}setMax(t){this.max=t}}const xe=1e-16;class ht{w;x;y;z;constructor(t=1,e=0,s=0,i=0){this.w=t,this.x=e,this.y=s,this.z=i}static ZERO=new ht(0,0,0,0);static ONE=new ht(1,0,0,0);static createNormalized(t,e,s,i){let r=1/Math.sqrt(t*t+e*e+s*s+i*i);return new ht(t*r,e*r,s*r,i*r)}static createRandom(){let t=Math.random(),e=Math.random(),s=Math.random(),i=Math.sqrt(1-t),r=Math.sqrt(t);return new ht(r*Math.cos(2*Math.PI*s),i*Math.sin(2*Math.PI*e),i*Math.cos(2*Math.PI*e),r*Math.sin(2*Math.PI*s))}static createFromBetweenVectors(t,e){let s=t[0],i=t[1],r=t[2],n=e[0],o=e[1],a=e[2],l=Math.sqrt(s*s+i*i+r*r),c=Math.sqrt(n*n+o*o+a*a);l>0&&(s/=l,i/=l,r/=l),c>0&&(n/=c,o/=c,a/=c);let u=s*n+i*o+r*a;if(u>=1-xe)return ht.ONE;if(1+u<=xe)return Math.abs(s)>Math.abs(r)?ht.createNormalized(0,-i,s,0):ht.createNormalized(0,0,-r,i);let p=i*a-r*o,d=r*n-s*a,E=s*o-i*n;return ht.createNormalized(1+u,p,d,E)}static createFromAxisAngle(t,e){let s=t[0],i=t[1],r=t[2],n=e*.5,o=Math.sin(n),a=Math.cos(n),l=o/Math.sqrt(s*s+i*i+r*r);return new ht(a,s*l,i*l,r*l)}static createFromEuler(t,e,s,i){let r=t*.5,n=e*.5,o=s*.5,a=Math.cos(r),l=Math.cos(n),c=Math.cos(o),u=Math.sin(r),p=Math.sin(n),d=Math.sin(o);return i===void 0||i==="ZXY"?new ht(a*l*c-u*p*d,p*a*c-u*d*l,u*p*c+d*a*l,u*l*c+p*d*a):i==="XYZ"||i==="RPY"?new ht(a*l*c-u*p*d,u*l*c+p*d*a,p*a*c-u*d*l,u*p*c+d*a*l):i==="YXZ"?new ht(u*p*d+a*l*c,u*d*l+p*a*c,u*l*c-p*d*a,d*a*l-u*p*c):i==="ZYX"||i==="YPR"?new ht(u*p*d+a*l*c,d*a*l-u*p*c,u*d*l+p*a*c,u*l*c-p*d*a):i==="YZX"?new ht(a*l*c-u*p*d,u*p*c+d*a*l,u*l*c+p*d*a,p*a*c-u*d*l):i==="XZY"?new ht(u*p*d+a*l*c,u*l*c-p*d*a,d*a*l-u*p*c,u*d*l+p*a*c):i==="ZYZ"?new ht(a*l*c-u*d*l,p*d*a-u*p*c,u*p*d+p*a*c,u*l*c+d*a*l):i==="ZXZ"?new ht(a*l*c-u*d*l,u*p*d+p*a*c,u*p*c-p*d*a,u*l*c+d*a*l):i==="YXY"?new ht(a*l*c-u*d*l,u*p*d+p*a*c,u*l*c+d*a*l,p*d*a-u*p*c):i==="YZY"?new ht(a*l*c-u*d*l,u*p*c-p*d*a,u*l*c+d*a*l,u*p*d+p*a*c):i==="XYX"?new ht(a*l*c-u*d*l,u*l*c+d*a*l,u*p*d+p*a*c,u*p*c-p*d*a):i==="XZX"?new ht(a*l*c-u*d*l,u*l*c+d*a*l,p*d*a-u*p*c,u*p*d+p*a*c):new ht}static createFromMatrix(t){let e=t[0],s=t[1],i=t[2],r=t[3],n=t[4],o=t[5],a=t[6],l=t[7],c=t[8],u=e+n+c;return u>0?ht.createNormalized(u+1,l-o,i-a,r-s):e>n&&e>c?ht.createNormalized(l-o,1+e-n-c,s+r,i+a):n>c?ht.createNormalized(i-a,s+r,1+n-e-c,o+l):ht.createNormalized(r-s,i+a,o+l,1+c-e-n)}static createFromLookAt(t,e=f.VEC3_UP){const s=f.VEC3_NORMALIZE([-t[0],-t[1],-t[2]]),i=f.VEC3_CROSS(e,s),r=f.VEC3_CROSS(s,i);return ht.createFromMatrix([i[0],i[1],i[2],r[0],r[1],r[2],s[0],s[1],s[2]])}rotateX(t){t*=.5;let e=Math.sin(t),s=Math.cos(t);return new ht(this.w*s-this.x*e,this.x*s+this.w*e,this.y*s+this.z*e,this.z*s-this.y*e)}rotateY(t){t*=.5;let e=Math.sin(t),s=Math.cos(t);return new ht(this.w*s-this.y*e,this.x*s-this.z*e,this.y*s+this.w*e,this.z*s+this.x*e)}rotateZ(t){t*=.5;let e=Math.sin(t),s=Math.cos(t);return new ht(this.w*s-this.z*e,this.x*s+this.y*e,this.y*s-this.x*e,this.z*s+this.w*e)}add(t,e,s,i){return new ht(this.w+t,this.x+e,this.y+s,this.z+i)}sub(t,e,s,i){return new ht(this.w-t,this.x-e,this.y-s,this.z-i)}neg(){return new ht(-this.w,-this.x,-this.y,-this.z)}norm(){return Math.sqrt(this.w*this.w+this.x*this.x+this.y*this.y+this.z*this.z)}normSq(){return this.w*this.w+this.x*this.x+this.y*this.y+this.z*this.z}normalize(){let t=Math.sqrt(this.w*this.w+this.x*this.x+this.y*this.y+this.z*this.z);return t<xe?ht.ZERO:(t=1/t,new ht(this.w*t,this.x*t,this.y*t,this.z*t))}mul(t,e,s,i){return new ht(this.w*t-this.x*e-this.y*s-this.z*i,this.w*e+this.x*t+this.y*i-this.z*s,this.w*s+this.y*t+this.z*e-this.x*i,this.w*i+this.z*t+this.x*s-this.y*e)}scale(t){return new ht(this.w*t,this.x*t,this.y*t,this.z*t)}dot(t,e,s,i){return this.w*t+this.x*e+this.y*s+this.z*i}inverse(){let t=this.w*this.w+this.x*this.x+this.y*this.y+this.z*this.z;return t===0?ht.ZERO:(t=1/t,new ht(this.w*t,-this.x*t,-this.y*t,-this.z*t))}div(t,e,s,i){var r=t*t+e*e+s*s+i*i;return r===0?ht.ZERO:(r=1/r,new ht((this.w*t+this.x*e+this.y*s+this.z*i)*r,(this.x*t-this.w*e-this.y*i+this.z*s)*r,(this.y*t-this.w*s-this.z*e+this.x*i)*r,(this.z*t-this.w*i-this.x*s+this.y*e)*r))}conjugate(){return new ht(this.w,-this.x,-this.y,-this.z)}exp(){let t=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z),e=Math.exp(this.w),s=e*Math.sin(t)/t;return t===0?new ht(e,0,0,0):new ht(e*Math.cos(t),this.x*s,this.y*s,this.z*s)}log(){if(this.y===0&&this.z===0)return new ht(ph(this.w,this.x),Math.atan2(this.x,this.w),0,0);let t=this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w,e=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z),s=Math.atan2(e,this.w)/e;return new ht(Math.log(t)*.5,this.x*s,this.y*s,this.z*s)}equals(t,e,s,i){return Math.abs(t-this.w)<xe&&Math.abs(e-this.x)<xe&&Math.abs(s-this.y)<xe&&Math.abs(i-this.z)<xe}isFinite(){return isFinite(this.w)&&isFinite(this.x)&&isFinite(this.y)&&isFinite(this.z)}isNaN(){return isNaN(this.w)||isNaN(this.x)||isNaN(this.y)||isNaN(this.z)}real(){return this.w}imag(){return[this.x,this.y,this.z]}toVector(){return[this.w,this.x,this.y,this.z]}toMatrix(){let t=this.w*this.x,e=this.w*this.y,s=this.w*this.z,i=this.x*this.x,r=this.x*this.y,n=this.x*this.z,o=this.y*this.y,a=this.y*this.z,l=this.z*this.z;return[1-2*(o+l),2*(r-s),2*(n+e),2*(r+s),1-2*(i+l),2*(a-t),2*(n-e),2*(a+t),1-2*(i+o)]}toMatrix4(){var t=this.w*this.x,e=this.w*this.y,s=this.w*this.z,i=this.x*this.x,r=this.x*this.y,n=this.x*this.z,o=this.y*this.y,a=this.y*this.z,l=this.z*this.z;return[1-2*(o+l),2*(r-s),2*(n+e),0,2*(r+s),1-2*(i+l),2*(a-t),0,2*(n-e),2*(a+t),1-2*(i+o),0,0,0,0,1]}toCSSTransform(){let t=2*Math.acos(this.w),e=1-this.w*this.w;return e<xe?(t=0,e=1):e=1/Math.sqrt(e),`rotate3d(${this.x*e}, ${this.y*e}, ${this.z*e}, ${t}rad)`}toAxisAngle(){let t=1-this.w*this.w;if(t<xe)return[[this.x,this.y,this.z],0];let e=1/Math.sqrt(t),s=2*Math.acos(this.w);return[[this.x*e,this.y*e,this.z*e],s]}clone(){return new ht(this.w,this.x,this.y,this.z)}rotateVector(t){var e=2*(this.y*t[2]-this.z*t[1]),s=2*(this.z*t[0]-this.x*t[2]),i=2*(this.x*t[1]-this.y*t[0]);return[t[0]+this.w*e+this.y*i-this.z*s,t[1]+this.w*s+this.z*e-this.x*i,t[2]+this.w*i+this.x*s-this.y*e]}slerp(t,e,s,i){let r=this.w,n=this.x,o=this.y,a=this.z;var l=r*t+n*e+o*s+a*i;if(l<0&&(r=-r,n=-n,o=-o,a=-a,l=-l),l>=1-xe)return function(p){return ht.createNormalized(r+p*(t-r),n+p*(e-n),o+p*(s-o),a+p*(i-a))};var c=Math.acos(l),u=Math.sin(c);return function(p){let d=c*p,E=Math.sin(d),y=Math.cos(d)-l*E/u,C=E/u;return new ht(y*r+C*t,y*n+C*e,y*o+C*s,y*a+C*i)}}}function ph(h,t){var e=Math.abs(h),s=Math.abs(t);return h===0?Math.log(s):t===0?Math.log(e):e<3e3&&s<3e3?.5*Math.log(h*h+t*t):(h=h/2,t=t/2,.5*Math.log(h*h+t*t)+Math.LN2)}class _e{position;rotation;scale;quaternion;lookTarget;lookUp;transformMatrix;constructor(){this.position=[0,0,0],this.rotation=[0,0,0],this.scale=[1,1,1],this.quaternion=new ht,this.lookTarget=null,this.lookUp=[0,1,0],this.transformMatrix=f.MAT4_IDENTITY()}getPosition(){return this.position}getPositionX(){return this.position[0]}getPositionY(){return this.position[1]}getPositionZ(){return this.position[2]}setPosition(t,e,s){this.position[0]=t,this.position[1]=e,this.position[2]=s}translate(t,e,s){this.position[0]+=t,this.position[1]+=e,this.position[2]+=s}getRotation(){return this.rotation}getRotationX(){return this.rotation[0]}getRotationY(){return this.rotation[1]}getRotationZ(){return this.rotation[2]}setRotation(t,e,s){this.rotation[0]=t,this.rotation[1]=e,this.rotation[2]=s,this.lookTarget=null}rotate(t,e,s){this.rotation[0]+=t,this.rotation[1]+=e,this.rotation[2]+=s,this.lookTarget=null}setQuaternion(t){this.quaternion=t.clone(),this.lookTarget=null}getQuaternion(){return this.quaternion}getScale(){return this.scale}getScaleX(){return this.scale[0]}getScaleY(){return this.scale[1]}getScaleZ(){return this.scale[2]}setScale(t,e,s){this.scale[0]=t,this.scale[1]=e,this.scale[2]=s}zoom(t,e,s){this.scale[0]+=t,this.scale[1]+=e,this.scale[2]+=s}getTransformMatrix(){return this.lookTarget?(f.MAT4_LOOKAT(this.position,this.lookTarget,this.lookUp,this.transformMatrix),f.MAT4_MULTIPLY(this.transformMatrix,f.MAT4_SCALE(this.scale[0],this.scale[1],this.scale[2]),this.transformMatrix)):f.MAT4_TRANSFORM(this.position,this.rotation,this.scale,this.quaternion,this.transformMatrix),this.transformMatrix}lookAt(t,e,s,i=[0,1,0]){this.lookTarget=[t,e,s],this.lookUp=i}getAxies(){const t=this.getTransformMatrix();return[[t[0],t[1],t[2]],[t[4],t[5],t[6]],[t[8],t[9],t[10]]]}getAxis(t){const e=this.getAxies();return t=="FORWARD"?[-e[2][0],-e[2][1],-e[2][2]]:t=="BACKWARD"?[e[2][0],e[2][1],e[2][2]]:t=="LEFT"?[-e[0][0],-e[0][1],-e[0][2]]:t=="RIGHT"?[e[0][0],e[0][1],e[0][2]]:t=="UP"?[e[1][0],e[1][1],e[1][2]]:[-e[1][0],-e[1][1],-e[1][2]]}}class qe extends _e{id;vertexSubBuffer;vertices;vertexCount;vertexStride;boundingBox;constructor(t){super(),this.id=[0,0,0,0],this.vertexSubBuffer=k.createVertexBuffer(0),this.vertices=[],this.vertexCount=0,this.vertexStride=t,this.boundingBox=new Tt}delete(){k.destroyVertexBuffer(this.vertexSubBuffer)}update(t){}draw(){}beginVertices(t){k.destroyVertexBuffer(this.vertexSubBuffer),this.vertexSubBuffer=k.createVertexBuffer(t*this.vertexStride*4),this.vertices=[],this.vertexCount=t}defineVertex(...t){this.vertices.push(...t)}setVertices(t){this.vertices=t}endVertices(){k.writeVertexBuffer(this.vertexSubBuffer,this.vertices)}getVertexSubBufferOffset(){return this.vertexSubBuffer.offset}getVertexSubBufferSize(){return this.vertexSubBuffer.vertices.byteLength}getVertices(){return this.vertices}getVertexCount(){return this.vertexCount}setId(t,e,s,i){this.id=[t,e,s,i]}setSingleId(t,e){this.id[t]=e}getId(){return this.id}getStringId(){return""+this.id[0]+this.id[1]+this.id[2]+this.id[3]}setBoundingBox(t){this.boundingBox=t}getBoundingBox(){return this.boundingBox}getWorldBoundingBox(){return this.boundingBox.transform(this.getTransformMatrix())}clone(t=new qe(this.vertexStride),e=f.MAT4_IDENTITY()){t.position=[this.position[0],this.position[1],this.position[2]],t.rotation=[this.rotation[0],this.rotation[1],this.rotation[2]],t.scale=[this.scale[0],this.scale[1],this.scale[2]],t.quaternion=new ht(this.quaternion.w,this.quaternion.x,this.quaternion.y,this.quaternion.z),t.boundingBox=new Tt(this.boundingBox.min,this.boundingBox.max),t.beginVertices(this.vertexCount);for(let s=0;s<this.vertices.length;s+=this.vertexStride){const i=f.MAT4_MULTIPLY_BY_VEC4(e,[this.vertices[s+0],this.vertices[s+1],this.vertices[s+2],1]);t.defineVertex(i[0],i[1],i[2],...this.vertices.slice(3,this.vertexStride))}return t.endVertices(),t}}class vt{animations;currentAnimation;currentAnimationFrameIndex;looped;frameProgress;dataChanged;texturesChanged;textureScrollAngle;textureScrollRate;displacementMapScrollAngle;displacementMapScrollRate;grp2;colors;params;uvs;toonLightDir;grp3;texture;displacementMap;diffuseMap;specularMap;emissiveMap;normalMap;envMap;toonMap;s0Texture;s1Texture;constructor(t){if(this.animations=t.animations??[],this.currentAnimation=null,this.currentAnimationFrameIndex=0,this.looped=!1,this.frameProgress=0,this.dataChanged=!0,this.texturesChanged=!1,this.textureScrollAngle=t.textureScrollAngle??0,this.textureScrollRate=t.textureScrollRate??0,this.displacementMapScrollAngle=t.displacementMapScrollAngle??0,this.displacementMapScrollRate=t.displacementMapScrollRate??0,this.grp2=k.createStaticGroup("MESH_PIPELINE",2),this.colors=this.grp2.setFloat(0,"MAT_COLORS",16),this.colors[0]=t.emissive?t.emissive[0]:0,this.colors[1]=t.emissive?t.emissive[1]:0,this.colors[2]=t.emissive?t.emissive[2]:0,this.colors[3]=0,this.colors[4]=t.ambient?t.ambient[0]:.5,this.colors[5]=t.ambient?t.ambient[1]:.5,this.colors[6]=t.ambient?t.ambient[2]:.5,this.colors[7]=0,this.colors[8]=t.diffuse?t.diffuse[0]:1,this.colors[9]=t.diffuse?t.diffuse[1]:1,this.colors[10]=t.diffuse?t.diffuse[2]:1,this.colors[11]=0,this.colors[12]=t.specular?t.specular[0]:0,this.colors[13]=t.specular?t.specular[1]:0,this.colors[14]=t.specular?t.specular[2]:0,this.colors[15]=0,this.params=this.grp2.setFloat(1,"MAT_PARAMS",36),this.params[0]=t.id??0,this.params[1]=t.opacity??1,this.params[2]=t.normalIntensity??1,this.params[3]=t.lightning?1:0,this.params[4]=t.texture?1:0,this.params[5]=t.displacementMap?1:0,this.params[6]=t.displacementMapFactor??0,this.params[7]=t.diffuseMap?1:0,this.params[8]=t.specularMap?1:0,this.params[9]=t.emissiveMap?1:0,this.params[10]=t.normalMap?1:0,this.params[11]=t.envMap?1:0,this.params[12]=t.toonMap?1:0,this.params[13]=t.decalEnabled?1:0,this.params[14]=t.shadowEnabled?1:0,this.params[15]=t.shininess??0,this.params[16]=t.emissiveFactor??1,this.params[17]=t.toonBlending??1,this.params[18]=t.s0Texture?1:0,this.params[19]=t.s1Texture?1:0,t.sParams)for(const e of t.sParams){const s=kt.findIndex(i=>i==e.name);s!=-1&&(this.params[20+s]=e.value??0)}this.uvs=this.grp2.setFloat(2,"MAT_UVS",6),this.toonLightDir=this.grp2.setFloat(3,"MAT_TOON_LIGHT_DIR",3),this.toonLightDir[0]=t.toonLightDir?t.toonLightDir[0]:0,this.toonLightDir[1]=t.toonLightDir?t.toonLightDir[1]:0,this.toonLightDir[2]=t.toonLightDir?t.toonLightDir[2]:0,this.grp3=k.createStaticGroup("MESH_PIPELINE",3),this.texture=this.grp3.setTexture(0,"MAT_TEXTURE",t.texture??k.createTextureFromBitmap()),this.texture=this.grp3.setSampler(1,"MAT_SAMPLER",this.texture),this.displacementMap=this.grp3.setTexture(2,"MAT_DISPLACEMENT_TEXTURE",t.displacementMap??k.createTextureFromBitmap()),this.displacementMap=this.grp3.setSampler(3,"MAT_DISPLACEMENT_SAMPLER",this.displacementMap),this.diffuseMap=this.grp3.setTexture(4,"MAT_DIFFUSE_TEXTURE",t.diffuseMap??k.createTextureFromBitmap()),this.diffuseMap=this.grp3.setSampler(5,"MAT_DIFFUSE_SAMPLER",this.diffuseMap),this.specularMap=this.grp3.setTexture(6,"MAT_SPECULAR_TEXTURE",t.specularMap??k.createTextureFromBitmap()),this.specularMap=this.grp3.setSampler(7,"MAT_SPECULAR_SAMPLER",this.specularMap),this.emissiveMap=this.grp3.setTexture(8,"MAT_EMISSIVE_TEXTURE",t.emissiveMap??k.createTextureFromBitmap()),this.emissiveMap=this.grp3.setSampler(9,"MAT_EMISSIVE_SAMPLER",this.emissiveMap),this.normalMap=this.grp3.setTexture(10,"MAT_NORM_TEXTURE",t.normalMap??k.createTextureFromBitmap()),this.normalMap=this.grp3.setSampler(11,"MAT_NORM_SAMPLER",this.normalMap),this.envMap=this.grp3.setTexture(12,"MAT_ENV_MAP_TEXTURE",t.envMap??k.createCubeMapFromBitmap(),{dimension:"cube"}),this.envMap=this.grp3.setSampler(13,"MAT_ENV_MAP_SAMPLER",this.envMap),this.toonMap=this.grp3.setTexture(14,"MAT_TOON_TEXTURE",t.toonMap??k.createTextureFromBitmap()),this.toonMap=this.grp3.setSampler(15,"MAT_TOON_SAMPLER",this.toonMap),this.s0Texture=this.grp3.setTexture(16,"MAT_S0_TEXTURE",k.createTextureFromBitmap()),this.s0Texture=this.grp3.setSampler(17,"MAT_S0_SAMPLER",this.s0Texture),this.s1Texture=this.grp3.setTexture(18,"MAT_S1_TEXTURE",k.createTextureFromBitmap()),this.s1Texture=this.grp3.setSampler(19,"MAT_S1_SAMPLER",this.s1Texture),this.grp2.allocate(),this.grp3.allocate()}static async createFromFile(t,e=""){const i=await(await fetch(t)).json();if(!i.hasOwnProperty("Ident")||i.Ident!="MAT")throw new Error("Gfx3Material::loadFromFile(): File not valid !");const r=new Array;for(const o of i.Animations){const a={name:o.Name,frames:[],frameDuration:parseInt(o.FrameDuration)},l=o.Frames.split(";");for(const c of l){const u=c.split(",");a.frames.push({offsetX:u[0],offsetY:u[1]})}r.push(a)}const n=new Array;for(const o of i.SParams)n.push({name:o.Name,value:o.Value});return new vt({animations:r,id:i.Id,opacity:i.Opacity,normalIntensity:i.NormalIntensity,lightning:i.Lightning,emissive:i.Emissive,ambient:i.Ambient,diffuse:i.Diffuse,specular:i.Specular,texture:i.Texture?await st.loadTexture(e+i.Texture):void 0,textureScrollAngle:i.TextureScrollAngle,textureScrollRate:i.TextureScrollRate,displacementMap:i.DisplacementMap?await st.loadTexture(e+i.DisplacementMap):void 0,displacementMapScrollAngle:i.DisplacementMapScrollAngle,displacementMapScrollRate:i.DisplacementMapScrollRate,displacementMapFactor:i.DisplacementMapFactor,diffuseMap:i.DiffuseMap?await st.loadTexture(e+i.DiffuseMap):void 0,specularMap:i.SpecularMap?await st.loadTexture(e+i.SpecularMap):void 0,emissiveMap:i.EmissiveMap?await st.loadTexture(e+i.EmissiveMap):void 0,normalMap:i.NormalMap?await st.loadTexture(e+i.NormalMap):void 0,envMap:i.EnvMap?await st.loadTexture(e+i.EnvMap):void 0,toonMap:i.ToonMap?await st.loadTexture(e+i.ToonMap):void 0,decalEnabled:i.DecalEnabled,shadowEnabled:i.ShadowEnabled,shininess:i.Shininess,emissiveFactor:i.EmissiveFactor,toonBlending:i.ToonBlending,toonLightDir:i.ToonLightDir,sParams:n,s0Texture:i.S0Texture?await st.loadTexture(e+i.S0Texture):void 0,s1Texture:i.S1Texture?await st.loadTexture(e+i.S1Texture):void 0})}delete(){this.grp2.delete(),this.grp3.delete()}update(t){if(this.textureScrollRate!=0&&(this.uvs[0]+=Math.cos(this.textureScrollAngle)*this.textureScrollRate*(t/1e3),this.uvs[1]+=Math.sin(this.textureScrollAngle)*this.textureScrollRate*(t/1e3),this.dataChanged=!0),this.displacementMapScrollRate!=0&&(this.uvs[4]+=Math.cos(this.displacementMapScrollAngle)*this.displacementMapScrollRate*(t/1e3),this.uvs[5]+=Math.sin(this.displacementMapScrollAngle)*this.displacementMapScrollRate*(t/1e3),this.dataChanged=!0),!this.currentAnimation)return;const e=this.currentAnimation.frames[this.currentAnimationFrameIndex];this.uvs[2]=e.offsetX/this.texture.gpuTexture.width,this.uvs[3]=e.offsetY/this.texture.gpuTexture.height,this.dataChanged=!0,this.frameProgress>=this.currentAnimation.frameDuration?this.currentAnimationFrameIndex==this.currentAnimation.frames.length-1?(v.emit(this,"E_FINISHED"),this.currentAnimationFrameIndex=this.looped?0:this.currentAnimation.frames.length-1,this.frameProgress=0):(this.currentAnimationFrameIndex=this.currentAnimationFrameIndex+1,this.frameProgress=0):this.frameProgress+=t}playAnimation(t,e=!1,s=!1){if(s&&this.currentAnimation&&t==this.currentAnimation.name)return;const i=this.animations.find(r=>r.name==t);if(!i)throw new Error("Gfx3Material::play: animation not found.");this.currentAnimation=i,this.currentAnimationFrameIndex=0,this.looped=e,this.frameProgress=0}resetAnimation(){this.currentAnimation=null,this.uvs[2]=0,this.uvs[3]=0,this.dataChanged=!0}setOpacity(t){this.params[1]=t,this.dataChanged=!0}setNormalIntensity(t){this.params[2]=t,this.dataChanged=!0}setLightning(t){this.params[3]=t?1:0,this.dataChanged=!0}setEmissive(t,e,s,i){this.colors[0]=t,this.colors[1]=e,this.colors[2]=s,this.colors[3]=i,this.dataChanged=!0}setAmbient(t,e,s){this.colors[4]=t,this.colors[5]=e,this.colors[6]=s,this.dataChanged=!0}setDiffuse(t,e,s){this.colors[8]=t,this.colors[9]=e,this.colors[10]=s,this.dataChanged=!0}setSpecular(t,e,s){this.colors[12]=t,this.colors[13]=e,this.colors[14]=s,this.dataChanged=!0}setSpecularity(t){this.colors[15]=t,this.dataChanged=!0}setTexture(t,e=0,s=0){this.texture=t,this.textureScrollAngle=e,this.textureScrollRate=s,this.params[4]=1,this.texturesChanged=!0,this.dataChanged=!0}setDisplacementMap(t,e=0,s=0,i=0){this.displacementMap=t,this.displacementMapScrollAngle=e,this.displacementMapScrollRate=s,this.params[5]=1,this.params[6]=i,this.texturesChanged=!0,this.dataChanged=!0}setDiffuseMap(t){this.diffuseMap=t,this.params[7]=1,this.texturesChanged=!0,this.dataChanged=!0}setSpecularMap(t){this.specularMap=t,this.params[8]=1,this.texturesChanged=!0,this.dataChanged=!0}setEmissiveMap(t){this.emissiveMap=t,this.params[9]=1,this.texturesChanged=!0,this.dataChanged=!0}setNormalMap(t){this.normalMap=t,this.params[10]=1,this.texturesChanged=!0,this.dataChanged=!0}setEnvMap(t){this.envMap=t,this.params[11]=1,this.texturesChanged=!0,this.dataChanged=!0}setToonMap(t){this.toonMap=t,this.params[12]=1,this.texturesChanged=!0,this.dataChanged=!0}enableDecal(t){this.params[13]=t?1:0,this.dataChanged=!0}enableShadow(t){this.params[14]=t?1:0,this.dataChanged=!0}setShininess(t){this.params[15]=t,this.dataChanged=!0}setEmissiveFactor(t){this.params[16]=t,this.dataChanged=!0}setToonBlending(t){this.params[17]=t,this.dataChanged=!0}setCustomParam(t,e){const s=kt.findIndex(i=>i==t);if(s==-1)throw new Error("Gfx3Material::setCustomParam(): Custom param name not found !");this.params[20+s]=e}getCustomParam(t){const e=kt.findIndex(s=>s==t);if(e==-1)throw new Error("Gfx3Material::getCustomParam(): Custom param name not found !");return this.params[20+e]}setCustomTextures(t){t[0]&&(this.s0Texture=t[0],this.texturesChanged=!0),t[1]&&(this.s1Texture=t[1],this.texturesChanged=!0)}setToonLightDirection(t){this.toonLightDir[0]=t[0],this.toonLightDir[1]=t[1],this.toonLightDir[2]=t[2],this.dataChanged=!0}getGroup02(){return this.dataChanged&&(this.grp2.beginWrite(),this.grp2.write(0,this.colors),this.grp2.write(1,this.params),this.grp2.write(2,this.uvs),this.grp2.write(3,this.toonLightDir),this.grp2.endWrite(),this.dataChanged=!1),this.grp2}getGroup03(){return this.texturesChanged&&(this.grp3.setTexture(0,"MAT_TEXTURE",this.texture),this.grp3.setTexture(2,"MAT_DISPLACEMENT_TEXTURE",this.displacementMap),this.grp3.setTexture(4,"MAT_DIFFUSE_TEXTURE",this.diffuseMap),this.grp3.setTexture(6,"MAT_SPECULAR_TEXTURE",this.specularMap),this.grp3.setTexture(8,"MAT_EMISSIVE_TEXTURE",this.emissiveMap),this.grp3.setTexture(10,"MAT_NORM_TEXTURE",this.normalMap),this.grp3.setTexture(12,"MAT_ENV_MAP_TEXTURE",this.envMap,{dimension:"cube"}),this.grp3.setTexture(14,"MAT_TOON_TEXTURE",this.toonMap),this.grp3.setTexture(16,"MAT_S0_TEXTURE",this.s0Texture),this.grp3.setTexture(18,"MAT_S1_TEXTURE",this.s1Texture),this.grp3.allocate(),this.texturesChanged=!1),this.grp3}getTexture(){return this.texture}getDisplacementMap(){return this.displacementMap}getDiffuseMap(){return this.diffuseMap}getSpecularMap(){return this.specularMap}getEmissiveMap(){return this.emissiveMap}getNormalMap(){return this.normalMap}getEnvMap(){return this.envMap}getToonMap(){return this.toonMap}}class re extends qe{shadowCasting;billboard;material;geo;constructor(){super(Et),this.shadowCasting=!1,this.billboard=!1,this.material=new vt({}),this.geo={vertices:[],indexes:[],coords:[]}}static buildVertices(t,e,s,i,r,n){const o=new Array,a=new Array,l=new Array,c=new Array,u=new Array,p=new Array,d=new Array,E=new Array,m=new Array,y=new Array,C=new Array;if(!n){n=[{name:"default",faces:[],vertexCount:t}];for(let w=0;w<t;w+=3)n[0].faces.push({v:[w+0,w+1,w+2],t:[w+0,w+1,w+2],n:[w+0,w+1,w+2],smoothGroup:0})}for(const w of n)for(const A of w.faces){l.push([e[A.v[0]*3+0],e[A.v[0]*3+1],e[A.v[0]*3+2]]),l.push([e[A.v[1]*3+0],e[A.v[1]*3+1],e[A.v[1]*3+2]]),l.push([e[A.v[2]*3+0],e[A.v[2]*3+1],e[A.v[2]*3+2]]),s&&s.length>0?(c.push([s[A.t[0]*2+0],s[A.t[0]*2+1]]),c.push([s[A.t[1]*2+0],s[A.t[1]*2+1]]),c.push([s[A.t[2]*2+0],s[A.t[2]*2+1]])):(c.push([0,0]),c.push([0,0]),c.push([0,0])),i&&i.length>0?(u.push([i[A.v[0]*3+0],i[A.v[0]*3+1],i[A.v[0]*3+2]]),u.push([i[A.v[1]*3+0],i[A.v[1]*3+1],i[A.v[1]*3+2]]),u.push([i[A.v[2]*3+0],i[A.v[2]*3+1],i[A.v[2]*3+2]])):(u.push([1,1,1]),u.push([1,1,1]),u.push([1,1,1]));const _=f.VEC3_SUBSTRACT(l.at(-2),l.at(-3)),M=f.VEC3_SUBSTRACT(l.at(-1),l.at(-3)),L=f.VEC2_SUBSTRACT(c.at(-2),c.at(-3)),O=f.VEC2_SUBSTRACT(c.at(-1),c.at(-3));if(r&&r.length>0)p.push([r[A.n[0]*3+0],r[A.n[0]*3+1],r[A.n[0]*3+2]]),p.push([r[A.n[1]*3+0],r[A.n[1]*3+1],r[A.n[1]*3+2]]),p.push([r[A.n[2]*3+0],r[A.n[2]*3+1],r[A.n[2]*3+2]]);else{const W=f.VEC3_NORMALIZE(f.VEC3_CROSS(_,M));p.push(W),p.push(W),p.push(W)}const H=[0,0,0],D=fh(_,M,L,O,H);E.push(D),E.push(D),E.push(D),d.push(H),d.push(H),d.push(H),A.smoothGroup&&(y[A.smoothGroup]=y[A.smoothGroup]||[],y[A.smoothGroup][A.v[0]]=y[A.smoothGroup][A.v[0]]?f.VEC3_ADD(y[A.smoothGroup][A.v[0]],p.at(-3)):p.at(-3),y[A.smoothGroup][A.v[1]]=y[A.smoothGroup][A.v[1]]?f.VEC3_ADD(y[A.smoothGroup][A.v[1]],p.at(-2)):p.at(-2),y[A.smoothGroup][A.v[2]]=y[A.smoothGroup][A.v[2]]?f.VEC3_ADD(y[A.smoothGroup][A.v[2]],p.at(-1)):p.at(-1),C[A.smoothGroup]=C[A.smoothGroup]||[],C[A.smoothGroup][A.v[0]]=C[A.smoothGroup][A.v[0]]?f.VEC3_ADD(C[A.smoothGroup][A.v[0]],H):H,C[A.smoothGroup][A.v[1]]=C[A.smoothGroup][A.v[1]]?f.VEC3_ADD(C[A.smoothGroup][A.v[1]],H):H,C[A.smoothGroup][A.v[2]]=C[A.smoothGroup][A.v[2]]?f.VEC3_ADD(C[A.smoothGroup][A.v[2]],H):H),a.push(A.v[0],A.v[1],A.v[2])}for(let w=0,A=0;w<n.length;w++)for(const _ of n[w].faces)for(let M=0;M<3;M++)_.smoothGroup&&(p[A]=f.VEC3_NORMALIZE(y[_.smoothGroup][_.v[M]]),d[A]=f.VEC3_NORMALIZE(C[_.smoothGroup][_.v[M]])),m[A]=f.VEC3_SCALE(f.VEC3_CROSS(p[A],d[A]),E[A]),o.push(l[A][0],l[A][1],l[A][2],c[A][0],c[A][1],u[A][0],u[A][1],u[A][2],p[A][0],p[A][1],p[A][2],d[A][0],d[A][1],d[A][2],m[A][0],m[A][1],m[A][2]),A++;return{vertices:o,indexes:a,coords:e,texcoords:s,colors:i,normals:r}}delete(t=!1){t||this.material.delete(),super.delete()}update(t){this.material.update(t)}draw(){Ot.drawMesh(this)}setShadowCasting(t){this.shadowCasting=t}getShadowCasting(){return this.shadowCasting}setBillboard(t){this.billboard=t}isBillboard(){return this.billboard}setMaterial(t,e=!0){e||this.material.delete(),this.material=t}getMaterial(){return this.material}getGeo(){return this.geo}clone(t=new re,e=f.MAT4_IDENTITY()){return super.clone(t,e),t.shadowCasting=this.shadowCasting,t.material=this.material,t}get mat(){return this.material}}function fh(h,t,e,s,i){const r=e[0]*s[1]-e[1]*s[0];if(Math.abs(r)>f.EPSILON){const n=1/r,o=r>0?1:-1,a=(h[0]*s[1]-t[0]*e[1])*n,l=(h[1]*s[1]-t[1]*e[1])*n,c=(h[2]*s[1]-t[2]*e[1])*n,u=f.VEC3_NORMALIZE([a,l,c]);return i[0]=u[0],i[1]=u[1],i[2]=u[2],o}return-1}class ke extends re{numVertices;frames;animations;interpolationEnabled;looped;currentAnimation;currentFrameIndex;frameProgress;geos;boundingBoxes;constructor(){super(),this.numVertices=0,this.frames=[],this.animations=[],this.interpolationEnabled=!0,this.looped=!0,this.currentAnimation=null,this.currentFrameIndex=0,this.frameProgress=0,this.geos=[],this.boundingBoxes=[]}async loadFromFile(t){const s=await(await fetch(t)).json();if(!s.hasOwnProperty("Ident")||s.Ident!="JAM")throw new Error("Gfx3MeshJAM::loadFromFile(): File not valid !");this.frames=[],this.boundingBoxes=[];for(const i of s.Frames){const r=i.Vertices??s.Vertices,n=i.TextureCoords??s.TextureCoords,o=i.Colors??s.Colors,a=i.Normals??s.Normals,l=re.buildVertices(s.NumVertices,r,n,o,a);this.geos.push(l),this.frames.push({vertices:l.vertices}),this.boundingBoxes.push(Tt.createFromVertices(r,3))}this.animations=[];for(const i of s.Animations)this.animations.push({name:i.Name,startFrame:parseInt(i.StartFrame),endFrame:parseInt(i.EndFrame),frameDuration:parseInt(i.FrameDuration)});this.beginVertices(s.NumVertices),this.setVertices(this.frames[0].vertices),this.endVertices(),this.geo=this.geos[0],this.boundingBox=this.boundingBoxes[0],this.numVertices=s.NumVertices,this.currentAnimation=null,this.interpolationEnabled=!0,this.looped=!0,this.currentFrameIndex=0,this.frameProgress=0}async loadFromBinaryFile(t){const s=await(await fetch(t)).arrayBuffer(),i=new Float32Array(s),r=new Uint32Array(s);let n=0;const o=r[0],a=r[1],l=r[2];n+=3;const c=[];for(let u=0;u<o*2;u++)c.push(i[n]),n++;this.frames=[],this.boundingBoxes=[];for(let u=0;u<a;u++){const p=[];for(let m=0;m<o*3;m++)p.push(i[n]),n++;const d=[];for(let m=0;m<o*3;m++)d.push(i[n]),n++;const E=re.buildVertices(o,p,c,void 0,d);this.frames.push({vertices:E.vertices}),this.boundingBoxes.push(Tt.createFromVertices(p,3))}this.animations=[];for(let u=0;u<l;u++){const p=r[n];n+=1;let d="";for(let E=0;E<p;E++)d+=String.fromCharCode(r[n++]);this.animations.push({name:d,startFrame:r[n++],endFrame:r[n++],frameDuration:r[n++]})}this.beginVertices(o),this.setVertices(this.frames[0].vertices),this.endVertices(),this.boundingBox=this.boundingBoxes[0],this.numVertices=o,this.currentAnimation=null,this.interpolationEnabled=!0,this.looped=!0,this.currentFrameIndex=0,this.frameProgress=0}update(t){if(!this.currentAnimation)return;const e=this.frameProgress/this.currentAnimation.frameDuration;let s=0;this.currentFrameIndex==this.currentAnimation.endFrame?(v.emit(this,"E_FINISHED"),s=this.looped?this.currentAnimation.startFrame:this.currentAnimation.endFrame):s=this.currentFrameIndex+1,this.beginVertices(this.numVertices);const i=this.frames[this.currentFrameIndex],r=this.frames[s];for(let n=0;n<this.numVertices;n++){const o=i.vertices[n*Et+0],a=i.vertices[n*Et+1],l=i.vertices[n*Et+2],c=i.vertices[n*Et+3],u=i.vertices[n*Et+4],p=i.vertices[n*Et+5],d=i.vertices[n*Et+6],E=i.vertices[n*Et+7],m=i.vertices[n*Et+8],y=i.vertices[n*Et+9],C=i.vertices[n*Et+10],w=i.vertices[n*Et+11],A=i.vertices[n*Et+12],_=i.vertices[n*Et+13],M=i.vertices[n*Et+14],L=i.vertices[n*Et+15],O=i.vertices[n*Et+16];if(this.interpolationEnabled){const H=r.vertices[n*Et+0],D=r.vertices[n*Et+1],W=r.vertices[n*Et+2],et=o+(H-o)*e,b=a+(D-a)*e,B=l+(W-l)*e,T=r.vertices[n*Et+5],V=r.vertices[n*Et+6],ot=r.vertices[n*Et+7],X=p+(T-p)*e,ct=d+(V-d)*e,Z=E+(ot-E)*e,at=r.vertices[n*Et+8],U=r.vertices[n*Et+9],F=r.vertices[n*Et+10],rt=m+(at-m)*e,tt=y+(U-y)*e,$=C+(F-C)*e,_t=r.vertices[n*Et+11],Nt=r.vertices[n*Et+12],pt=r.vertices[n*Et+13],gt=w+(_t-w)*e,Ft=A+(Nt-A)*e,bt=_+(pt-_)*e,le=r.vertices[n*Et+14],Qt=r.vertices[n*Et+15],g=r.vertices[n*Et+16],G=w+(le-M)*e,j=A+(Qt-L)*e,S=_+(g-O)*e;this.defineVertex(et,b,B,c,u,X,ct,Z,rt,tt,$,gt,Ft,bt,G,j,S)}else this.defineVertex(o,a,l,c,u,p,d,E,m,y,C,w,A,_,M,L,O)}this.endVertices(),e>=1?(this.currentFrameIndex=s,this.frameProgress=0):this.frameProgress+=t,super.update(t)}play(t,e=!1,s=!1,i=!0){if(s&&this.currentAnimation&&this.currentAnimation.name==t)return;const r=this.animations.find(n=>n.name==t);if(!r)throw new Error("Gfx3MeshJAM::play: animation not found !");this.currentAnimation=r,this.interpolationEnabled=i,this.looped=e,this.currentFrameIndex=r.startFrame,this.frameProgress=0}getInterpolationEnabled(){return this.interpolationEnabled}getLooped(){return this.looped}getCurrentAnimation(){return this.currentAnimation}getCurrentFrameIndex(){return this.currentFrameIndex}getFrameProgress(){return this.frameProgress}getBoundingBox(t=!1){return t&&this.currentAnimation?this.boundingBoxes[this.currentFrameIndex]:this.boundingBox}getWorldBoundingBox(t=!1){return t&&this.currentAnimation?this.boundingBoxes[this.currentFrameIndex].transform(this.getTransformMatrix()):this.boundingBox.transform(this.getTransformMatrix())}clone(t=new ke,e=f.MAT4_IDENTITY()){super.clone(t,e),t.numVertices=this.numVertices,t.frames=this.frames,t.animations=this.animations,t.interpolationEnabled=this.interpolationEnabled,t.looped=!1,t.currentAnimation=null,t.currentFrameIndex=0,t.frameProgress=0;for(const s of this.boundingBoxes)t.boundingBoxes.push(new Tt(s.min,s.max));return t}}class ft extends re{constructor(){super()}async loadFromFile(t){const s=await(await fetch(t)).json();if(!s.hasOwnProperty("Ident")||s.Ident!="JSM")throw new Error("Gfx3MeshJSM::loadFromFile(): File not valid !");const i=re.buildVertices(s.NumVertices,s.Vertices,s.TextureCoords,s.Colors,s.Normals);this.beginVertices(s.NumVertices),this.setVertices(i.vertices),this.endVertices(),this.geo=i,this.boundingBox=Tt.createFromVertices(s.Vertices,3)}async loadFromBinaryFile(t){const s=await(await fetch(t)).arrayBuffer(),i=new Float32Array(s);let r=0;const n=new Int32Array(s),o=n[0],a=n[1],l=n[2],c=n[3];r+=4;const u=[];for(let y=0;y<o*3;y++)u.push(i[r]),r++;const p=[];for(let y=0;y<a*2;y++)p.push(i[r]),r++;const d=[];for(let y=0;y<l*3;y++)d.push(i[r]),r++;const E=[];for(let y=0;y<c*3;y++)E.push(i[r]),r++;const m=re.buildVertices(o,u,p,E,d);this.beginVertices(o),this.setVertices(m.vertices),this.endVertices(),this.boundingBox=Tt.createFromVertices(u,3)}clone(t=new ft,e=f.MAT4_IDENTITY()){return super.clone(t,e),t}}class Rr{name;coords;colors;texcoords;normals;lines;groups;materialName;vertexCount;constructor(){this.name="",this.coords=new Array,this.colors=new Array,this.texcoords=new Array,this.normals=new Array,this.lines=new Array,this.groups=new Array,this.materialName="",this.vertexCount=0}}class Hs extends re{coords;colors;texcoords;normals;objects;materials;meshes;debugVertices;debugVertexCount;constructor(){super(),this.coords=new Array,this.colors=new Array,this.texcoords=new Array,this.normals=new Array,this.objects=new Map,this.materials=new Map,this.meshes=new Map,this.debugVertices=new Array,this.debugVertexCount=0}async loadFromFile(t,e){await this.#t(e),await this.#e(t),this.#s()}delete(){for(const t of this.meshes.values())t.delete(!0);for(const t of this.materials.values())t.delete();super.delete()}update(t){for(const e of this.meshes.values())e.update(t)}draw(){for(const t of this.meshes.values()){const e=f.MAT4_MULTIPLY(this.getTransformMatrix(),t.getTransformMatrix());Ot.drawMesh(t,e)}this.debugVertexCount>0&&Jt.drawVertices(this.debugVertices,this.debugVertexCount,this.getTransformMatrix())}getVertexCount(){let t=0;for(const e of this.meshes.values())t+=e.getVertexCount();return t}getVertices(){let t=new Array;for(const e of this.meshes.values())t.concat(e.getVertices());return t}getMesh(t){if(!this.meshes.has(t))throw new Error("Gfx3MeshOBJ::getMesh(): The mesh object doesn't exist !");return this.meshes.get(t)}getMeshes(){return this.meshes.values()}getObject(t){if(!this.objects.has(t))throw new Error("Gfx3MeshOBJ::getObject(): The object doesn't exist !");return this.objects.get(t)}getBoundingBox(){const t=new Array;for(const e of this.meshes.values())t.push(e.getBoundingBox());return Tt.merge(t)}getWorldBoundingBox(){const t=new Array;for(const e of this.meshes.values())t.push(e.getWorldBoundingBox());return Tt.merge(t)}clone(t=new Hs,e=f.MAT4_IDENTITY()){t.coords=this.coords,t.colors=this.colors,t.texcoords=this.texcoords,t.normals=this.normals,t.objects=this.objects,t.materials=this.materials;for(const s in this.meshes){const i=this.meshes.get(s);t.meshes.set(s,i.clone(new re,e))}return t.debugVertices=this.debugVertices,t.debugVertexCount=this.debugVertexCount,t}async#t(t){const i=(await(await fetch(t)).text()).split(`
`);this.materials.clear();let r=null,n=null;t=t.split("/").slice(0,-1).join("/")+"/";for(const o of i)if(o.startsWith("newmtl ")&&(n=Kt(o,7),r=new vt({lightning:!0}),this.materials.set(n,r)),!!r){if(o.startsWith("Kd ")){const a=Kt(o,3).split(" "),l=parseFloat(a[0]),c=parseFloat(a[1]),u=parseFloat(a[2]);r.setDiffuse(l,c,u)}if(o.startsWith("Ks ")){const a=Kt(o,3).split(" "),l=parseFloat(a[0]),c=parseFloat(a[1]),u=parseFloat(a[2]);r.setSpecular(l,c,u)}if(o.startsWith("Ns ")){const a=Kt(o,3);r.setSpecularity(parseFloat(a))}if(o.startsWith("d")){const a=Kt(o,1);r.setOpacity(parseFloat(a))}if(o.startsWith("Ke ")){const a=Kt(o,3).split(" "),l=parseFloat(a[0]),c=parseFloat(a[1]),u=parseFloat(a[2]);r.setEmissive(l,c,u,1)}if(o.startsWith("map_Kd ")){const a=Kt(o,7);r.setTexture(await st.loadTexture(t+a))}if(o.startsWith("map_Ns ")){const a=Kt(o,7);r.setSpecularMap(await st.loadTexture(t+a,{},!0))}if(o.startsWith("map_Bump ")){const a=o.split(" ");let l=1;for(;a[l][0]=="-";)a[l].substring(1)=="bm"&&r.setNormalIntensity(parseFloat(a[l+1])),l++;const c=a.join(" ");r.setNormalMap(await st.loadTexture(t+c))}}}async#e(t){const i=(await(await fetch(t)).text()).split(`
`);this.coords=[],this.colors=[],this.texcoords=[],this.normals=[],this.objects.clear();let r={name:"default",faces:[],vertexCount:0},n=0,o=new Rr;o.groups=[r];for(const a of i){if(a.startsWith("o ")){const l=new Rr;l.name=Kt(a,2),l.groups=[{name:"default",faces:[],vertexCount:0}],o=l,r=l.groups[0],this.objects.set(l.name,l)}if(a.startsWith("usemtl ")&&(o.materialName=Kt(a,7)),a.startsWith("v ")){const l=Kt(a,2).split(" "),c=parseFloat(l[0]),u=parseFloat(l[1]),p=parseFloat(l[2]);if(this.coords.push(c,u,p),o.coords.push(c,u,p),l.length>3){const d=parseFloat(l[3]),E=parseFloat(l[4]),m=parseFloat(l[5]);this.colors.push(d,E,m),o.colors.push(d,E,m)}}if(a.startsWith("vt ")){const l=Kt(a,3).split(" "),c=parseFloat(l[0]),u=1-parseFloat(l[1]);this.texcoords.push(c,u),o.texcoords.push(c,u)}if(a.startsWith("vn ")){const l=Kt(a,3).split(" "),c=parseFloat(l[0]),u=parseFloat(l[1]),p=parseFloat(l[2]);this.normals.push(c,u,p),o.normals.push(c,u,p)}if(a.startsWith("s ")){const l=Kt(a,2);n=parseInt(l)}if(a.startsWith("g ")){const l=Kt(a,2),c=o.groups.find(u=>u.name==l);if(c)r=c;else{const u={name:l,faces:[],vertexCount:0};o.groups.push(u),r=u}}if(a.startsWith("f ")){const l=Kt(a,2).split(" ");if(l.length>3)throw new Error("Gfx3MeshOBJ::loadObjects(): No support of quad faces !");const c=l[0].split("/"),u=l[1].split("/"),p=l[2].split("/");r.faces.push({v:[parseInt(c[0])-1,parseInt(u[0])-1,parseInt(p[0])-1],t:[parseInt(c[1])-1,parseInt(u[1])-1,parseInt(p[1])-1],n:[parseInt(c[2])-1,parseInt(u[2])-1,parseInt(p[2])-1],smoothGroup:n}),r.vertexCount+=3,o.vertexCount+=3}if(a.startsWith("l ")){const l=Kt(a,2).split(" "),c=this.coords[(parseInt(l[0])-1)*3+0],u=this.coords[(parseInt(l[0])-1)*3+1],p=this.coords[(parseInt(l[0])-1)*3+2],d=this.coords[(parseInt(l[1])-1)*3+0],E=this.coords[(parseInt(l[1])-1)*3+1],m=this.coords[(parseInt(l[1])-1)*3+2];o.lines.push([c,u,p]),o.lines.push([d,E,m]),o.vertexCount+=2}}}#s(){this.meshes.clear(),this.debugVertices=[],this.debugVertexCount=0;for(const t of this.objects.values())if(t.lines.length>0)for(const e of t.lines)this.debugVertices.push(e[0],e[1],e[2],1,1,1),this.debugVertexCount++;else{const e=new re,s=this.materials.get(t.materialName);s&&e.setMaterial(s);const i=t.texcoords.length>0?this.texcoords:void 0,r=t.normals.length>0?this.normals:void 0,n=t.colors.length>0?this.colors:void 0;e.geo=re.buildVertices(t.vertexCount,this.coords,i,n,r,t.groups),e.beginVertices(t.vertexCount),e.setVertices(e.geo.vertices),e.endVertices(),e.setBoundingBox(Tt.createFromVertices(this.coords,3)),this.meshes.set(t.name,e)}}}function Kt(h,t){return h.substring(t).replace("\r","")}class Ut{min;max;constructor(t=[0,0],e=[0,0]){this.min=t,this.max=e}static createFrom(t,e,s,i){const r=new Ut;return r.min[0]=t,r.min[1]=e,r.max[0]=s,r.max[1]=i,r}static createFromCoord(t,e,s,i){const r=new Ut;return r.min[0]=t,r.min[1]=e,r.max[0]=t+s,r.max[1]=e+i,r}static createFromCenter(t,e,s,i){const r=new Ut;return r.min[0]=t-s*.5,r.min[1]=e-i*.5,r.max[0]=t+s*.5,r.max[1]=e+i*.5,r}static createFromVertices(t){const e=new Ut;return e.fromVertices(t),e}fromVertices(t){const e=[t[0],t[1]],s=[t[0],t[1]];for(let i=0;i<t.length;i+=2)for(let r=0;r<2;r++){const n=t[i+r];e[r]=Math.min(n,e[r]),s[r]=Math.max(n,s[r])}this.min=e,this.max=s}merge(t){const e=[this.min[0],this.min[1]],s=[this.max[0],this.max[2]];for(let i=0;i<2;i++)e[i]=Math.min(t.min[i],e[i]),s[i]=Math.max(t.max[i],s[i]);return new Ut(e,s)}getCenter(){const t=this.max[0]-this.min[0],e=this.max[1]-this.min[1],s=this.min[0]+t*.5,i=this.min[1]+e*.5;return[s,i]}getSize(){const t=this.max[0]-this.min[0],e=this.max[1]-this.min[1];return[t,e]}getWidth(){return this.max[0]-this.min[0]}getHeight(){return this.max[1]-this.min[1]}getRadius(){return f.VEC2_DISTANCE(this.min,this.max)*.5}getPerimeter(){const t=this.max[0]-this.min[0],e=this.max[1]-this.min[1];return t+t+e+e}getVolume(){return(this.max[0]-this.min[0])*(this.max[1]-this.min[1])}transform(t){const e=[];e.push([this.min[0],this.min[1]]),e.push([this.max[0],this.min[1]]),e.push([this.max[0],this.max[1]]),e.push([this.min[0],this.max[1]]);const s=e.map(n=>f.MAT3_MULTIPLY_BY_VEC3(t,[n[0],n[1],1])),i=[s[0][0],s[0][1]],r=[s[0][0],s[0][1]];for(let n=0;n<s.length;n++)for(let o=0;o<2;o++){const a=s[n][o];i[o]=Math.min(a,i[o]),r[o]=Math.max(a,r[o])}return new Ut(i,r)}splitVertical(){const t=this.getSize(),e=this.getCenter();return[Ut.createFromCoord(this.min[0],this.min[1],t[0]*.5,t[1]),Ut.createFromCoord(e[0],this.min[1],t[0]*.5,t[1])]}splitHorizontal(){const t=this.getSize(),e=this.getCenter();return[Ut.createFromCoord(this.min[0],this.min[1],t[0],t[1]*.5),Ut.createFromCoord(this.min[0],e[1],t[0],t[1]*.5)]}isPointInside(t,e){return f.COLLIDE_POINT_TO_RECT([t,e],this.min,this.max)}intersectBoundingRect(t){return f.COLLIDE_RECT_TO_RECT(this.min,this.max,t.min,t.max)}getLines(){return f.GET_LINES_FROM_RECT(this.min[0],this.min[1],this.max[0],this.max[1])}}class Wn{maxChildren;maxDepth;root;constructor(t,e,s){this.maxChildren=t,this.maxDepth=e,this.root=new ii(this,0,s)}draw(){this.root.draw()}search(t,e=[]){return this.root.search(t,e)}addChild(t){this.root.addChild(t)}getMaxChildren(){return this.maxChildren}getMaxDepth(){return this.maxDepth}getRoot(){return this.root}}class ii{tree;depth;method;parent=null;left=null;right=null;children=[];constructor(t,e,s){this.reset(),this.tree=t,this.depth=e,this.method=s}draw(){this.method.draw(),this.left&&this.left.draw(),this.right&&this.right.draw()}search(t,e=[]){return this.method.search(this,t,e)}reset(){this.children=[],this.left=null,this.right=null}addChild(t){if(this.children.length>=this.tree.getMaxChildren()&&this.depth<this.tree.getMaxDepth()&&this.#t(),this.left===null&&this.right===null)this.children.push(t);else{const e=this.method.split([t]);this.left&&e.left.length>0&&this.left.addChild(e.left[0]),this.right&&e.right.length>0&&this.right.addChild(e.right[0])}}getChildren(){return this.children}getMethod(){return this.method}getLeft(){return this.left}getRight(){return this.right}getDepth(){return this.depth}setDepth(t){this.depth=t}#t(){const t=this.method.split(this.children);this.left=new ii(this.tree,this.depth+1,t.leftMethod),this.right=new ii(this.tree,this.depth+1,t.rightMethod),t.left.forEach(this.left.addChild.bind(this.left)),t.right.forEach(this.right.addChild.bind(this.right)),this.left.parent=this,this.right.parent=this,this.children=[]}}class bi extends Wn{constructor(t,e,s=new Ut([0,0],[0,0])){super(t,e,new ri(s,"x"))}}class ri{rect;axis;constructor(t,e){this.rect=t,this.axis=e}draw(){const t=nt.getContext(),e=this.rect.getSize();t.fillStyle="blue",t.fillRect(this.rect.min[0],this.rect.min[1],e[0],e[1])}search(t,e,s=[]){if(!this.rect.intersectBoundingRect(e))return[];const i=t.getLeft(),r=t.getRight();if(i&&r)i.search(e,s),r.search(e,s);else{const n=t.getChildren(),o=n.length;for(let a=0;a<o;a++)n[a].intersectBoundingRect(e)&&s.push(n[a])}return s}split(t){const e=[],s=[],i=this.rect.getCenter();for(const l of t)this.axis==="x"?l.min[0]<=i[0]&&l.max[0]>=i[0]?(e.push(l),s.push(l)):l.max[0]<=i[0]?e.push(l):s.push(l):l.min[1]<=i[1]&&l.max[1]>=i[1]?(e.push(l),s.push(l)):l.max[1]<=i[1]?e.push(l):s.push(l);const r=this.axis==="x"?this.rect.splitVertical():this.rect.splitHorizontal(),n=this.axis==="x"?"y":"x",o=new ri(r[0],n),a=new ri(r[1],n);return{left:e,right:s,leftMethod:o,rightMethod:a}}}class Or extends Ut{index;v1;v2;v3;n;t;constructor(t,e,s,i){super(),this.index=t,this.v1=e,this.v2=s,this.v3=i,this.n=f.VEC3_NORMALIZE(f.TRI3_NORMAL(this.v1,this.v2,this.v3)),this.t=f.VEC3_NORMALIZE(f.VEC3_CROSS([0,1,0],this.n)),super.fromVertices([this.v1[0],this.v1[2],this.v2[0],this.v2[2],this.v3[0],this.v3[2]])}}class ps{boundingRect;sectors;sectorColors;neighborPool;sharedPool;btree;points;walkers;debugVertices;debugVertexCount;constructor(){this.boundingRect=new Ut,this.sectors=[],this.sectorColors=[],this.neighborPool=[],this.sharedPool=[],this.btree=new bi(0,0),this.points=new Map,this.walkers=new Map,this.debugVertices=[],this.debugVertexCount=0}async loadFromFile(t,e=20,s=10){const r=await(await fetch(t)).json();if(!r.hasOwnProperty("Ident")||r.Ident!="JWM")throw new Error("Gfx3PhysicsJWM::loadFromFile(): File not valid !");this.boundingRect=new Ut(r.Min,r.Max),this.btree=new bi(e,s,this.boundingRect),this.sectors=[];for(let n=0;n<r.NumSectors;n++){const o=r.Sectors[n],a=new Or(n,o[0],o[1],o[2]);this.btree.addChild(a),this.sectors.push(a)}this.sectorColors=[];for(let n=0;n<r.NumSectorColors;n++){const o=r.SectorColors[n];this.sectorColors.push([o[0],o[1],o[2]])}this.neighborPool=[];for(const n of r.NeighborPool)this.neighborPool.push({s1:n[0],s2:n[1],s3:n[2]});this.sharedPool=[];for(const n of r.SharedPool)this.sharedPool.push({sectorIds:n})}async loadFromBinaryFile(t,e=20,s=10){const r=await(await fetch(t)).arrayBuffer(),n=new Float32Array(r);let o=0;const a=n[0],l=n[1];o+=2;const c=n[o+0],u=n[o+1],p=n[o+2],d=n[o+3];o+=4,this.boundingRect=new Ut([c,u],[p,d]),this.btree=new bi(e,s,this.boundingRect),this.sectors=[];for(let E=0;E<a;E++){const m=[n[o+E*9+0],n[o+E*9+1],n[o+E*9+2]],y=[n[o+E*9+3],n[o+E*9+4],n[o+E*9+5]],C=[n[o+E*9+6],n[o+E*9+7],n[o+E*9+8]],w=new Or(E,m,y,C);this.btree.addChild(w),this.sectors.push(w)}o+=a*9,this.sectorColors=[];for(let E=0;E<l;E++)this.sectorColors.push([n[o+E*3+0],n[o+E*3+1],n[o+E*3+2]]);o+=l*9,this.neighborPool=[];for(let E=0;E<a;E++)this.neighborPool.push({s1:n[o+E*3+0],s2:n[o+E*3+1],s3:n[o+E*3+2]});o+=a*3,this.sharedPool=[];for(let E=0;E<a;E++){const m=n[o],y=[];o+=1;for(let C=0;C<m;C++)y.push(n[o++]);this.sharedPool.push({sectorIds:y})}}update(){this.debugVertices=[],this.debugVertexCount=0;for(const t of this.sectors)this.debugVertices.push(t.v1[0],t.v1[1],t.v1[2],1,1,1),this.debugVertices.push(t.v2[0],t.v2[1],t.v2[2],1,1,1),this.debugVertices.push(t.v1[0],t.v1[1],t.v1[2],1,1,1),this.debugVertices.push(t.v3[0],t.v3[1],t.v3[2],1,1,1),this.debugVertices.push(t.v2[0],t.v2[1],t.v2[2],1,1,1),this.debugVertices.push(t.v3[0],t.v3[1],t.v3[2],1,1,1),this.debugVertexCount+=6;for(const t of this.walkers.values())this.debugVertices.push(t.points[1].x,t.points[1].y,t.points[1].z,1,1,1),this.debugVertices.push(t.points[2].x,t.points[2].y,t.points[2].z,1,1,1),this.debugVertices.push(t.points[2].x,t.points[2].y,t.points[2].z,1,1,1),this.debugVertices.push(t.points[3].x,t.points[3].y,t.points[3].z,1,1,1),this.debugVertices.push(t.points[3].x,t.points[3].y,t.points[3].z,1,1,1),this.debugVertices.push(t.points[4].x,t.points[4].y,t.points[4].z,1,1,1),this.debugVertices.push(t.points[4].x,t.points[4].y,t.points[4].z,1,1,1),this.debugVertices.push(t.points[1].x,t.points[1].y,t.points[1].z,1,1,1),this.debugVertexCount+=8}draw(){Jt.drawVertices(this.debugVertices,this.debugVertexCount);for(const t of this.points.values())Jt.drawSphere(f.MAT4_TRANSLATE(t.x,t.y,t.z),.01,2)}addPoint(t,e,s){if(this.points.has(t))throw new Error("Gfx3PhysicsJWM::addPoint: point with id "+t+" already exist.");this.points.set(t,this.#e(e,s))}removePoint(t){if(!this.points.has(t))throw new Error("Gfx3PhysicsJWM::removePoint(): point not exist !");this.points.delete(t)}getPoint(t){const e=this.points.get(t);if(!e)throw new Error("Gfx3PhysicsJWM::getPoint: point with id "+t+" not exist.");return e}movePoint(t,e,s){const i=this.#t(t.sectorIndex,t.x,t.z,e,s);return t.sectorIndex=i.sectorIndex,t.x+=i.mx,t.y=i.elevation,t.z+=i.mz,{point:t,move:[i.mx,i.elevation-t.y,i.mz],collide:e!=i.mx||s!=i.mz}}addWalker(t,e,s,i){if(this.walkers.has(t))throw new Error("Gfx3PhysicsJWM::addWalker: walker with id "+t+" already exist.");const r={id:t,points:[this.#e(e,s),this.#e(e+i,s+i),this.#e(e+i,s-i),this.#e(e-i,s-i),this.#e(e-i,s+i)]};return this.walkers.set(t,r),r}removeWalker(t){if(!this.walkers.has(t))throw new Error("Gfx3PhysicsJWM::removeWalker(): Walker not exist !");this.walkers.delete(t)}getWalker(t){if(!this.walkers.has(t))throw new Error("Gfx3PhysicsJWM::getWalker: walker with id "+t+" not exist.");return this.walkers.get(t)}moveWalker(t,e,s){let i=e,r=s,n=0,o=0,a=[],l=[],c=0;for(;c<t.points.length;){let u=!1;if(!a[c]){const p=this.#t(t.points[c].sectorIndex,t.points[c].x,t.points[c].z,i,r);if(p.mx==0&&p.mz==0){i=0,r=0,l=[];break}(p.mx!=i||p.mz!=r)&&(o++,i=p.mx,r=p.mz,u=!0,a[c]=!0),l[c]=p,n=l[0].elevation-t.points[0].y}if(o>=2){i=0,r=0,l=[];break}c=u?0:c+1}for(let u=0;u<l.length;u++)t.points[u].sectorIndex=l[u].sectorIndex,t.points[u].x+=i,t.points[u].y=l[u].elevation,t.points[u].z+=r;return{walker:t,move:[i,n,r],collide:e!=i||s!=r}}clearWalkers(){this.walkers.clear()}getSector(t){return this.sectors[t]}getSectorColor(t){return this.sectorColors[t]}getBinaryTree(){return this.btree}#t(t,e,s,i,r,n=0){if(i>-f.BIG_EPSILON&&i<+f.BIG_EPSILON&&r>-f.BIG_EPSILON&&r<+f.BIG_EPSILON)return{sectorIndex:t,mx:0,mz:0,elevation:1/0};if(n>=this.sharedPool[t].sectorIds.length)return{sectorIndex:t,mx:0,mz:0,elevation:1/0};const o=this.sharedPool[t].sectorIds[n],a=this.sectors[o].v1,l=this.sectors[o].v2,c=this.sectors[o].v3;if(f.TRI2_POINT_INSIDE([e+i,s+r],[a[0],a[2]],[l[0],l[2]],[c[0],c[2]])==1){const m=f.TRI3_POINT_ELEVATION([e+i,s+r],a,l,c);return{sectorIndex:o,mx:i,mz:r,elevation:m}}const p=[l[0]-a[0],l[2]-a[2]],d=[c[0]-l[0],c[2]-l[2]],E=[a[0]-c[0],a[2]-c[2]];return this.neighborPool[o].s1==-1&&f.COLLIDE_LINE_TO_LINE([a[0],a[2]],[l[0],l[2]],[e,s],[e+i,s+r])?([i,r]=f.VEC2_PROJECTION_COS([i,r],p),this.#t(t,e,s,i,r,0)):this.neighborPool[o].s2==-1&&f.COLLIDE_LINE_TO_LINE([l[0],l[2]],[c[0],c[2]],[e,s],[e+i,s+r])?([i,r]=f.VEC2_PROJECTION_COS([i,r],d),this.#t(t,e,s,i,r,0)):this.neighborPool[o].s3==-1&&f.COLLIDE_LINE_TO_LINE([c[0],c[2]],[a[0],a[2]],[e,s],[e+i,s+r])?([i,r]=f.VEC2_PROJECTION_COS([i,r],E),this.#t(t,e,s,i,r,0)):this.#t(t,e,s,i,r,n+1)}#e(t,e){const s=this.#s(t,e);return{sectorIndex:s.sectorIndex,x:t,y:s.elev,z:e}}#s(t,e){const s=this.btree.search(new Ut([t-1,e-1],[t+1,e+1]));for(const i of s){const r=i.v1,n=i.v2,o=i.v3;if(f.TRI2_POINT_INSIDE([t,e],[r[0],r[2]],[n[0],n[2]],[o[0],o[2]])==1)return{sectorIndex:i.index,elev:f.TRI3_POINT_ELEVATION([t,e],r,n,o)}}return{sectorIndex:-1,elev:1/0}}}class Mi extends Wn{constructor(t,e,s=new Tt([0,0,0],[0,0,0])){super(t,e,new ni(s,"x"))}}class ni{box;axis;constructor(t,e){this.box=t,this.axis=e}draw(){Jt.drawBoundingBox(f.MAT4_IDENTITY(),this.box.min,this.box.max)}search(t,e,s=[]){if(!this.box.intersectBoundingBox(e))return[];const i=t.getLeft(),r=t.getRight();if(i&&r)i.search(e,s),r.search(e,s);else{const n=t.getChildren();for(let o=0;o<n.length;o++)n[o].intersectBoundingBox(e)&&s.push(n[o])}return s}split(t){const e=[],s=[],i=this.box.getCenter();for(const l of t)this.axis==="x"?l.min[0]<=i[0]&&l.max[0]>=i[0]?(e.push(l),s.push(l)):l.max[0]<=i[0]?e.push(l):s.push(l):this.axis==="y"?l.min[1]<=i[1]&&l.max[1]>=i[1]?(e.push(l),s.push(l)):l.max[1]<=i[1]?e.push(l):s.push(l):l.min[2]<=i[2]&&l.max[2]>=i[2]?(e.push(l),s.push(l)):l.max[2]<=i[2]?e.push(l):s.push(l);let r=[],n="x";this.axis==="x"?(r=this.box.splitVertical(),n="y"):this.axis==="y"?(r=this.box.splitHorizontal(),n="z"):(r=this.box.splitDepth(),n="x");const o=new ni(r[0],n),a=new ni(r[1],n);return{left:e,right:s,leftMethod:o,rightMethod:a}}}class Dr extends Tt{index;v1;v2;v3;n;t;constructor(t,e,s,i){super(),this.index=t,this.v1=e,this.v2=s,this.v3=i,this.n=f.VEC3_NORMALIZE(f.TRI3_NORMAL(this.v1,this.v2,this.v3)),this.t=f.VEC3_NORMALIZE(f.VEC3_CROSS([0,1,0],this.n)),super.fromVertices([...this.v1,...this.v2,...this.v3],3)}}class Ds{boundingBox;frags;fragColors;btree;debugMeshEnabled;debugBspEnabled;debugVertices;debugVertexCount;constructor(){this.boundingBox=new Tt,this.frags=[],this.fragColors=[],this.btree=new Mi(0,0),this.debugBspEnabled=!0,this.debugMeshEnabled=!0,this.debugVertices=[],this.debugVertexCount=0}async loadFromFile(t,e=20,s=10){const r=await(await fetch(t)).json();if(!r.hasOwnProperty("Ident")||r.Ident!="JNM")throw new Error("Gfx3PhysicsJNM::loadFromFile(): File not valid !");this.boundingBox=new Tt(r.Min,r.Max),this.btree=new Mi(e,s,this.boundingBox),this.frags=[];for(let n=0;n<r.NumFrags;n++){const o=r.Frags[n],a=new Dr(n,o[0],o[1],o[2]);this.btree.addChild(a),this.frags.push(a)}this.fragColors=[];for(let n=0;n<r.NumFragColors;n++){const o=r.FragColors[n];this.fragColors.push([o[0],o[1],o[2]])}}async loadFromBinaryFile(t,e=20,s=10){const r=await(await fetch(t)).arrayBuffer(),n=new Float32Array(r);let o=0;const a=n[0],l=n[1];o+=2;const c=n[o+0],u=n[o+1],p=n[o+2],d=n[o+3],E=n[o+4],m=n[o+5];o+=6,this.boundingBox=new Tt([c,u,p],[d,E,m]),this.btree=new Mi(e,s,this.boundingBox),this.frags=[];for(let y=0;y<a;y++){const C=[n[o+y*9+0],n[o+y*9+1],n[o+y*9+2]],w=[n[o+y*9+3],n[o+y*9+4],n[o+y*9+5]],A=[n[o+y*9+6],n[o+y*9+7],n[o+y*9+8]],_=new Dr(y,C,w,A);this.btree.addChild(_),this.frags.push(_)}o+=a*9,this.fragColors=[];for(let y=0;y<l;y++)this.fragColors.push([n[o+y*3+0],n[o+y*3+1],n[o+y*3+2]])}update(t){this.debugVertices=[],this.debugVertexCount=0;for(const e of this.frags)this.debugVertices.push(e.v1[0],e.v1[1],e.v1[2],1,1,1),this.debugVertices.push(e.v2[0],e.v2[1],e.v2[2],1,1,1),this.debugVertices.push(e.v1[0],e.v1[1],e.v1[2],1,1,1),this.debugVertices.push(e.v3[0],e.v3[1],e.v3[2],1,1,1),this.debugVertices.push(e.v2[0],e.v2[1],e.v2[2],1,1,1),this.debugVertices.push(e.v3[0],e.v3[1],e.v3[2],1,1,1),this.debugVertexCount+=6}draw(){this.debugBspEnabled&&this.btree.draw(),this.debugMeshEnabled&&Jt.drawVertices(this.debugVertices,this.debugVertexCount)}box(t,e,s,i,r,n,o,a,l=.2,c=!0,u=1){const p=[t-i,e-r*.5,s-i],d=[t+i,e+r*.5,s+i];p[1]+=l;const E=this.btree.search(new Tt([p[0]+n,p[1]+o,p[2]+a],[d[0]+n,d[1]+o,d[2]+a]));let m=n,y=o,C=a,w=!1,A=!1,_=!1,M=0;const L=[[p[0],p[1]+l,d[2]],[p[0],p[1]+l,p[2]],[d[0],p[1]+l,p[2]],[d[0],p[1]+l,d[2]]],O=[[p[0],d[1],d[2]],[p[0],d[1],p[2]],[d[0],d[1],p[2]],[d[0],d[1],d[2]]],H=[...Lr(t,e,s,n,a,L),...Lr(t,e,s,n,a,O)];for(;M<H.length;){const b=this.#t(E,H[M],[m,C]);if(b.move[0]!=m||b.move[1]!=C){m=b.move[0],C=b.move[1],_=!0;break}M++}if(o>0){const b=this.btree.search(new Tt([t+m,p[1],s+C],[t+m,d[1]+.1,s+C])),B=this.#e(b,[t+m,p[1],s+C],[0,1,0]);(B?B.value-d[1]:1/0)<0&&B&&(A=!0,y=B.value-d[1])}p[1]-=l,u=u==0?Math.abs(o):u;const D=this.btree.search(new Tt([t+m,p[1]-u,s+C],[t+m,d[1],s+C])),W=this.#e(D,[t+m,d[1],s+C]),et=W?p[1]-W.value:1/0;return c&&et<u&&W&&(w=!0,y=W.value-p[1]),{move:[m,y,C],collideWall:_,collideTop:A,collideFloor:w,fragIndex:W?W.fragIndex:-1}}raycast(t,e,s,i){const r=this.btree.search(new Tt([t[0]-s,t[1]-i*.5,t[2]-s],[t[0]+s,t[1]+i*.5,t[2]+s]));let n=null,o=1/0,a=[0,0,0];for(const l of r){const c=[0,0,0];if(f.RAY_TRIANGLE(t,e,l.v1,l.v2,l.v3,!0,c)){const u=f.VEC3_SUBSTRACT(c,t),p=f.VEC3_LENGTH(u);p<o&&(o=p,n=l,a=c)}}return n?{hit:a,distance:o,fragIndex:n.index}:null}getElevation(t,e,s,i,r,n,o){const a=this.btree.search(new Tt([t-i,e-r*.5,s-i],[t+i,e+r*.5,s+i])),l=this.#e(a,[t+n,e+r,s+o]);return l?{hit:[t+n,l.value,s+o],distance:l.value-e,fragIndex:l?l.fragIndex:-1}:null}enableDebugBsp(t){this.debugBspEnabled=t}enableDebugMesh(t){this.debugMeshEnabled=t}isDebugBspEnabled(){return this.debugBspEnabled}isDebugMeshEnabled(){return this.debugMeshEnabled}getBinaryTree(){return this.btree}getFrag(t){return this.frags[t]}getFragColor(t){return this.fragColors[t]}#t(t,e,s,i=0){let r=null,n=1/0;for(const o of t){const a=[0,0,0];if(!f.RAY_PLAN([e[0]-s[0]*4,e[1],e[2]-s[1]*4],[s[0],0,s[1]],o.v1,o.n,!0,a))continue;const l=[a[0]-o.t[0]*100,a[2]-o.t[2]*100],c=[a[0]+o.t[0]*100,a[2]+o.t[2]*100],u=[e[0]-s[0]*4,e[2]-s[1]*4],p=[e[0]+s[0]*4,e[2]+s[1]*4];if(f.COLLIDE_LINE_TO_LINE(l,c,u,p)){const d=f.VEC2_SUBSTRACT([a[0],a[2]],[e[0]+s[0],e[2]+s[1]]),E=f.VEC2_LENGTH(d);f.VEC2_DOT(d,s)<0&&E<n&&(n=E,r=o)}}if(r){const o=f.VEC2_PROJECTION_COS([s[0],s[1]],[r.t[0],r.t[2]]);return this.#t(t,e,o,i+1)}return{move:s}}#e(t,e,s=[0,-1,0]){let i=null,r=1/0,n=[0,0,0];for(const o of t){const a=[0,0,0];if(f.RAY_TRIANGLE(e,s,o.v1,o.v2,o.v3,!0,a)){const l=f.VEC3_SUBSTRACT(a,e),c=f.VEC3_LENGTH(l);c<r&&(r=c,i=o,n=a)}}return i!=null?{value:n[1],fragIndex:i.index}:null}}function Lr(h,t,e,s,i,r){return r.sort((n,o)=>{const a=f.VEC3_SUBSTRACT(n,[h,t,e]),l=f.VEC3_SUBSTRACT(o,[h,t,e]),c=f.VEC2_ANGLE_BETWEEN([a[0],a[2]],[s,i]),u=f.VEC2_ANGLE_BETWEEN([l[0],l[2]],[s,i]);return c-u}).slice(0,2)}class oi extends qe{debugEnabled;debugVertices;debugVertexCount;constructor(){super(rr),this.debugEnabled=!0,this.debugVertices=[],this.debugVertexCount=0}async loadFromFile(t){const s=await(await fetch(t)).json();if(!s.hasOwnProperty("Ident")||s.Ident!="JSV")throw new Error("Gfx3ShadowVolume::loadFromFile(): File not valid !");this.beginVertices(s.NumVertices);for(let i=0;i<s.NumVertices;i++)this.defineVertex(s.Vertices[i*3+0],s.Vertices[i*3+1],s.Vertices[i*3+2],s.Colors[i*3+0],s.Colors[i*3+1],s.Colors[i*3+2]);this.endVertices(),this.#t(s.NumVertices,s.Vertices)}async loadFromBinaryFile(t){const s=await(await fetch(t)).arrayBuffer(),i=new Float32Array(s),r=new Int32Array(s);let n=0;const o=r[0];n+=1;const a=[];for(let c=0;c<o;c++)a.push(i[n+c*3+0],i[n+c*3+1],i[n+c*3+2]);n+=o*3;const l=[];for(let c=0;c<o;c++)l.push(i[n+c*3+0],i[n+c*3+1],i[n+c*3+2]);this.beginVertices(o);for(let c=0;c<o;c++)this.defineVertex(a[c*3+0],a[c*3+1],a[c*3+2],l[c*3+0],l[c*3+1],l[c*3+2]);this.endVertices(),this.#t(o,a)}delete(){super.delete()}draw(){this.debugEnabled&&Jt.drawVertices(this.debugVertices,this.debugVertexCount,this.getTransformMatrix()),Ve.drawShadowVolume(this)}#t(t,e){this.debugVertices=[],this.debugVertexCount=0;for(let s=0;s<t/3;s++){const i=[e[s*9+0],e[s*9+1],e[s*9+2]],r=[e[s*9+3],e[s*9+4],e[s*9+5]],n=[e[s*9+6],e[s*9+7],e[s*9+8]];this.debugVertices.push(i[0],i[1],i[2],1,1,1),this.debugVertices.push(r[0],r[1],r[2],1,1,1),this.debugVertices.push(i[0],i[1],i[2],1,1,1),this.debugVertices.push(n[0],n[1],n[2],1,1,1),this.debugVertices.push(r[0],r[1],r[2],1,1,1),this.debugVertices.push(n[0],n[1],n[2],1,1,1),this.debugVertexCount+=6}}}class mh extends _e{type;diffuse;specular;intensity;constant;linear;exp;radius;meshId;cutoff;direction;constructor(){super(),this.type="POINT",this.diffuse=[.7,.7,.7],this.specular=[1,1,1],this.intensity=1,this.constant=1,this.linear=0,this.exp=0,this.radius=10,this.meshId=0,this.cutoff=12.5,this.direction=[0,-1,0]}async loadFromFile(t){const s=await(await fetch(t)).json();if(!s.hasOwnProperty("Ident")||s.Ident!="JLT")throw new Error("Gfx3MeshLight::loadFromFile(): File not valid !");this.position=s.Position,this.type=s.Type=="POINT"?"POINT":"SPOT",this.diffuse=s.DiffuseColor,this.specular=s.SpecularColor,this.intensity=s.Intensity,this.constant=s.Constant,this.linear=s.Linear,this.exp=s.Exp,this.radius=s.Radius,this.meshId=s.MeshID,this.cutoff=s.Cutoff,this.direction=s.Direction}draw(){this.type=="POINT"?Ot.drawPointLight(this.position,this.diffuse,this.specular,this.intensity,this.meshId,this.constant,this.linear,this.exp):Ot.drawSpotLight(this.position,this.direction,this.cutoff,this.diffuse,this.specular,this.intensity,this.meshId,this.constant,this.linear,this.exp)}setType(t){this.type=t}setDiffuse(t,e,s){this.diffuse[0]=t,this.diffuse[1]=e,this.diffuse[2]=s}setSpecular(t,e,s){this.specular[0]=t,this.specular[1]=e,this.specular[2]=s}setIntensity(t){this.intensity=t}setConstant(t){this.constant=t}setLinear(t){this.linear=t}setExp(t){this.exp=t}setRadius(t){this.radius=t}setMeshId(t){this.meshId=t}setCutoff(t){this.cutoff=t}setDirection(t,e,s){this.direction[0]=t,this.direction[1]=e,this.direction[2]=s}getType(){return this.type}getDiffuse(){return this.diffuse}getSpecular(){return this.specular}getIntensity(){return this.intensity}getConstant(){return this.constant}getLinear(){return this.linear}getExp(){return this.exp}getRadius(){return this.radius}getMeshId(){return this.meshId}getCutoff(){return this.cutoff}getDirection(){return this.direction}}class Gn{nodes;groups;constructor(t=new Map){this.nodes=t,this.groups=new Map}async loadFromFile(t){const s=await(await fetch(t)).json();if(!s.hasOwnProperty("Ident")||s.Ident!="GRF")throw new Error("AIPathGraph<T>::loadFromFile(): File not valid !");this.nodes.clear();for(const i in s.Nodes)this.nodes.set(i,{pos:s.Nodes[i].Pos,children:s.Nodes[i].Children,g:0,h:0,f:0});this.groups.clear();for(const i in s.Groups)this.groups.set(i,s.Groups[i])}getNode(t){const e=this.nodes.get(t);if(!e)throw new Error("AIPathGraph::getNode(): Node not exist !");return e}getNodeGroupList(t){const e=this.groups.get(t);if(!e)throw new Error("AIPathGraph::getNodeGroups(): Node not exist !");return e}addNode(t,e,s=!0){if(this.nodes.get(t))throw new Error("AIPathGraph::addNode(): Node already exist !");if(this.nodes.set(t,e),s)for(const r of e.children){const n=this.nodes.get(r);n&&n.children.push(t)}return e}removeNode(t){const e=this.nodes.get(t);if(!e)throw new Error("AIPathGraph::removeNode(): Node not found !");this.nodes.delete(t);for(const s of e.children){const i=this.nodes.get(s);if(!i)continue;const r=i.children.indexOf(t);r!=-1&&i.children.splice(r,1)}}setNodeProperties(t,e){const s=this.nodes.get(t);if(!s)throw new Error("AIPathGraph::setNodeProperties(): Node not found !");Object.assign(s,e)}removeNodeRelation(t,e,s=!0){const i=this.nodes.get(t);if(!i)throw new Error("AIPathGraph::removeNodeRelation(): Node not found !");const r=i.children.indexOf(e);if(r==-1)throw new Error("AIPathGraph::removeNodeRelation(): Node children not found !");const n=this.nodes.get(e);if(n&&s){const o=n.children.indexOf(t);n.children.splice(o,1)}i.children.splice(r,1)}findNode(t){for(const e of this.nodes.values())if(t(e))return e;return null}findNodes(t){const e=new Array;for(const s of this.nodes.values())t(s)&&e.push(s);return e}reset(){for(const t of this.nodes.values())t.g=0,t.h=0,t.f=0}}class gh extends Gn{constructor(t=new Map){super(t)}getDistance(t,e){return f.VEC2_DISTANCE(t.pos,e.pos)}}class Eh extends Gn{constructor(t=new Map){super(t)}getDistance(t,e){return f.VEC3_DISTANCE(t.pos,e.pos)}}class zn{grid;size;constructor(t,e=new Array){this.grid=e,this.size=t}async loadFromFile(t){const s=await(await fetch(t)).json();if(!s.hasOwnProperty("Ident")||s.Ident!="GRD")throw new Error("AIPathGrid<T>::loadFromFile(): File not valid !");this.grid=s.Grid,this.size=s.Size}}class nr extends zn{constructor(t=[0,0],e=new Array){super(t,e)}getValue(t){return this.grid[this.size[0]*t[1]+t[0]]}getDirections(t,e){const s=[[0,-1],[1,0],[0,1],[-1,0]],i=e[0]-t[0],r=e[1]-t[1];return s.sort((n,o)=>{const a=Math.sqrt(Math.pow(i+n[0],2)+Math.pow(r+n[1],2)),l=Math.sqrt(Math.pow(i+o[0],2)+Math.pow(r+o[1],2));return a-l})}isInside(t){return!(t[0]<0||t[0]>=this.size[0]||t[1]<0||t[1]>=this.size[1])}isSame(t,e){return t[0]==e[0]&&t[1]==e[1]}}class Ch extends zn{constructor(t=[0,0,0],e=new Array){super(t,e)}getValue(t){return this.grid[this.size[2]*t[2]+this.size[0]*t[1]+t[0]]}getDirections(t,e){const s=[[0,0,1],[0,0,-1],[-1,0,0],[1,0,0],[0,1,0],[0,-1,0]],i=e[0]-t[0],r=e[1]-t[1],n=e[2]-t[2];return s.sort((o,a)=>{const l=Math.sqrt(Math.pow(i+o[0],2)+Math.pow(r+o[1],2)*Math.pow(n+o[2],2)),c=Math.sqrt(Math.pow(i+a[0],2)+Math.pow(r+a[1],2)*Math.pow(n+a[2],2));return l-c})}isInside(t){return!(t[0]<0||t[0]>=this.size[0]||t[1]<0||t[1]>=this.size[1]||t[2]<0||t[2]>=this.size[2])}isSame(t,e){return t[0]==e[0]&&t[1]==e[1]&&t[2]==e[2]}}class Pe{vertices;points;speed;looped;running;currentPosition;currentMove;currentPointIndex;currentSegmentTime;constructor(t=[],e=!1){this.vertices=[],this.points=t,this.speed=1,this.looped=e,this.running=!1,this.currentPosition=[0,0,0],this.currentMove=[0,0,0],this.currentPointIndex=1,this.currentSegmentTime=0}async loadFromFile(t){const s=await(await fetch(t)).json();if(!s.hasOwnProperty("Ident")||s.Ident!="JLM")throw new Error("Motion::loadFromFile(): File not valid !");this.setPoints(s.Points)}async loadFromBinaryFile(t){const s=await(await fetch(t)).arrayBuffer(),i=new Float32Array(s),r=[];for(var n=0;n<i.length;n+=3)r.push([i[n+0],i[n+1],i[n+2]]);this.setPoints(r)}update(t){if(!this.running){this.currentMove=[0,0,0];return}const e=f.VEC3_SUBSTRACT(this.points[this.currentPointIndex],this.points[this.currentPointIndex-1]),s=f.VEC3_NORMALIZE(e),i=f.VEC3_LENGTH(e),r=f.VEC3_SUBSTRACT(this.currentPosition,this.points[this.currentPointIndex-1]),n=f.VEC3_LENGTH(r);this.currentMove=f.VEC3_SCALE(s,this.speed*(t/1e3)),this.currentPosition[0]+=this.currentMove[0],this.currentPosition[1]+=this.currentMove[1],this.currentPosition[2]+=this.currentMove[2],this.currentSegmentTime=n/i,n>i&&(this.currentPointIndex==this.points.length-1?(this.currentPointIndex=this.looped?1:this.points.length-1,this.running=!!this.looped,v.emit(this,"E_FINISHED")):this.currentPointIndex=this.currentPointIndex+1)}run(){if(this.points.length<2)throw new Error("Motion::play(): points is not defined.");this.running=!0,this.currentPosition[0]=this.points[0][0],this.currentPosition[1]=this.points[0][1],this.currentPosition[2]=this.points[0][2],this.currentMove=[0,0,0],this.currentPointIndex=1,this.currentSegmentTime=0}setSpeed(t){this.speed=t}setPoints(t){this.points=t,this.looped=f.VEC3_ISEQUAL(t.at(-1),t.at(0)),this.running=!1,this.vertices=[];for(const e of t)this.vertices.push(e[0],e[0],e[2])}stop(){this.running=!1}isRunning(){return this.running}getVertices(){return this.vertices}getCurrentPosition(){return this.currentPosition}getCurrentPositionX(){return this.currentPosition[0]}getCurrentPositionY(){return this.currentPosition[1]}getCurrentPositionZ(){return this.currentPosition[2]}getCurrentMove(){return this.currentMove}getCurrentMoveX(){return this.currentMove[0]}getCurrentMoveY(){return this.currentMove[1]}getCurrentMoveZ(){return this.currentMove[2]}getCurrentRotationY(){return f.VEC2_ANGLE([this.currentMove[0],this.currentMove[2]])}getCurrentRotationZ(){return f.VEC2_ANGLE([this.currentMove[0],this.currentMove[1]])}getPrevPointIndex(){return this.currentPointIndex-1}getNextPointIndex(){return this.currentPointIndex}getPrevPoint(){return this.points[this.currentPointIndex-1]}getNextPoint(){return this.points[this.currentPointIndex]}getCurrentSegmentTime(){return this.currentSegmentTime}}class he{position;rotation;scale;flip;offset;visible;opacity;z;elevation;boundingRect;constructor(){this.position=[0,0],this.rotation=0,this.scale=[1,1],this.flip=[!1,!1],this.offset=[0,0],this.visible=!0,this.opacity=1,this.z=0,this.elevation=0,this.boundingRect=new Ut}update(t){}onRender(){}render(){if(!this.isVisible())return;const t=nt.getContext();t.save(),t.globalAlpha=this.opacity,t.translate(-this.offset[0],-this.offset[1]),t.translate(this.position[0],this.position[1]),t.rotate(this.rotation),t.scale(this.scale[0],this.scale[1]),this.onRender(),t.globalAlpha=1,t.restore()}draw(){nt.draw(this)}getPosition(){return this.position}getPositionX(){return this.position[0]}getPositionY(){return this.position[1]}setPosition(t,e){this.position[0]=t,this.position[1]=e}translate(t,e){this.position[0]+=t,this.position[1]+=e}getRotation(){return this.rotation}setRotation(t){this.rotation=t}rotate(t){this.rotation+=t}getScale(){return this.scale}getScaleX(){return this.scale[0]}getScaleY(){return this.scale[1]}setScale(t,e){this.scale[0]=t,this.scale[1]=e}zoom(t,e){this.scale[0]+=t,this.scale[1]+=e}getFlipX(){return this.flip[0]}getFlipY(){return this.flip[1]}getFlip(){return this.flip}setFlipX(t){this.flip[0]=t}setFlipY(t){this.flip[1]=t}getOffset(){return this.offset}getOffsetX(){return this.offset[0]}getOffsetY(){return this.offset[1]}setOffset(t,e){this.offset[0]=t,this.offset[1]=e}isVisible(){return this.visible}setVisible(t){this.visible=t}getOpacity(){return this.opacity}setOpacity(t){this.opacity=t}setPositionZ(t){this.z=t}getPositionZ(){return this.z}setElevation(t){this.elevation=t}getElevation(){return this.elevation}setBoundingRect(t){this.boundingRect=t}getBoundingRect(){return this.boundingRect}getWorldBoundingRect(){return this.boundingRect.transform(f.MAT3_TRANSFORM(this.position,this.offset,this.rotation,this.scale))}clone(t=new he){return t.position=[this.position[0],this.position[1]],t.rotation=this.rotation,t.scale=[this.scale[0],this.scale[1]],t.offset=[this.offset[0],this.offset[1]],t.visible=this.visible,t.opacity=this.opacity,t.z=this.z,t.elevation=this.elevation,t.boundingRect=new Ut(this.boundingRect.min,this.boundingRect.max),t}}class ne extends he{texture;textureRect;offsetFactor;constructor(){super(),this.texture=nt.getDefaultTexture(),this.textureRect=[0,0,0,0],this.offsetFactor=[0,0]}async loadFromFile(t){const s=await(await fetch(t)).json();this.textureRect[0]=s.X,this.textureRect[1]=s.Y,this.textureRect[2]=s.Width,this.textureRect[3]=s.Height,this.offset[0]=s.OffsetX??0,this.offset[1]=s.OffsetY??0,this.flip[0]=s.FlipX??!1,this.flip[1]=s.FlipY??!1,this.offsetFactor[0]=s.OffsetFactorX??0,this.offsetFactor[1]=s.OffsetFactorY??0,this.boundingRect=Ut.createFromCoord(s.X,s.Y,s.Width,s.Height)}onRender(){const t=nt.getContext();t.scale(this.flip[0]?-1:1,this.flip[1]?-1:1),this.offsetFactor[0]!=0&&t.translate(-this.textureRect[2]*this.offsetFactor[0],0),this.offsetFactor[1]!=0&&t.translate(0,-this.textureRect[3]*this.offsetFactor[1]),t.drawImage(this.texture,this.textureRect[0],this.textureRect[1],this.textureRect[2],this.textureRect[3],this.flip[0]?this.textureRect[2]*-1:0,this.flip[1]?this.textureRect[3]*-1:0,this.textureRect[2],this.textureRect[3])}getTextureRect(){return this.textureRect}getTextureRectWidth(){return this.textureRect[2]}getTextureRectHeight(){return this.textureRect[3]}setTextureRect(t,e,s,i){this.textureRect=[t,e,s,i],this.boundingRect=Ut.createFromCoord(this.textureRect[0],this.textureRect[1],this.textureRect[2],this.textureRect[3])}setOffsetNormalized(t,e){this.offsetFactor[0]=t,this.offsetFactor[1]=e}setTexture(t){this.textureRect[2]==0&&this.textureRect[3]==0&&(this.textureRect[2]=t.width,this.textureRect[3]=t.height,this.boundingRect=Ut.createFromCoord(this.textureRect[0],this.textureRect[1],this.textureRect[2],this.textureRect[3])),this.texture=t}getTexture(){return this.texture}getWorldBoundingRect(){const t=this.position[0]-this.textureRect[2]*this.offsetFactor[0],e=this.position[1]-this.textureRect[3]*this.offsetFactor[1];return this.boundingRect.transform(f.MAT3_TRANSFORM([t,e],this.offset,this.rotation,this.scale))}clone(t=new ne){return super.clone(t),t.texture=this.texture,t.textureRect=[this.textureRect[0],this.textureRect[1],this.textureRect[2],this.textureRect[3]],t.flip=[this.flip[0],this.flip[1]],t}}async function or(h){const e=await(await fetch(h)).json(),s=new Array;for(const r in e.frames)s.push(e.frames[r]);const i=new Array;for(const r of e.meta.frameTags){const n=new Array;for(let o=r.from;o<=r.to;o++)n.push({X:s[o].frame.x,Y:s[o].frame.y,Width:s[o].frame.w,Height:s[o].frame.h});i.push({Name:r.name,Frames:n,FrameDuration:s[r.from].duration})}return{Ident:"JAS",Animations:i}}class Zt extends he{animations;texture;offsetFactor;currentAnimation;currentAnimationFrameIndex;looped;frameProgress;constructor(){super(),this.animations=[],this.texture=nt.getDefaultTexture(),this.offsetFactor=[0,0],this.currentAnimation=null,this.currentAnimationFrameIndex=0,this.looped=!1,this.frameProgress=0}async loadFromFile(t){const s=await(await fetch(t)).json();this.loadFromData(s)}async loadFromAsepriteFile(t){const e=await or(t);this.loadFromData(e)}loadFromData(t){if(!t.hasOwnProperty("Ident")||t.Ident!="JAS")throw new Error("Gfx2SpriteJAS::loadFromData(): Data not valid !");this.offset[0]=t.OffsetX??0,this.offset[1]=t.OffsetY??0,this.flip[0]=t.FlipX??!1,this.flip[1]=t.FlipY??!1,this.offsetFactor[0]=t.OffsetFactorX??0,this.offsetFactor[1]=t.OffsetFactorY??0,this.animations=[];for(const e of t.Animations){const s={name:e.Name,frames:[],frameDuration:Number(e.FrameDuration),boundingRects:[]};for(const i of e.Frames)s.frames.push({x:i.X,y:i.Y,width:i.Width,height:i.Height}),s.boundingRects.push(Ut.createFromCoord(i.X,i.Y,i.Width,i.Height));this.animations.push(s)}this.boundingRect=this.animations[0].boundingRects[0],this.currentAnimation=null,this.currentAnimationFrameIndex=0,this.frameProgress=0}update(t){this.currentAnimation&&(this.frameProgress>=this.currentAnimation.frameDuration?this.currentAnimationFrameIndex==this.currentAnimation.frames.length-1?(v.emit(this,"E_FINISHED"),this.currentAnimationFrameIndex=this.looped?0:this.currentAnimation.frames.length-1,this.frameProgress=0):(this.currentAnimationFrameIndex=this.currentAnimationFrameIndex+1,this.frameProgress=0):this.frameProgress+=t)}onRender(){if(!this.currentAnimation)return;const t=nt.getContext(),e=this.currentAnimation.frames[this.currentAnimationFrameIndex];t.scale(this.flip[0]?-1:1,this.flip[1]?-1:1),this.offsetFactor[0]!=0&&t.translate(-e.width*this.offsetFactor[0],0),this.offsetFactor[1]!=0&&t.translate(0,-e.height*this.offsetFactor[1]),t.drawImage(this.texture,e.x,e.y,e.width,e.height,this.flip[0]?e.width*-1:0,this.flip[1]?e.height*-1:0,e.width,e.height)}play(t,e=!1,s=!1){if(s&&this.currentAnimation&&t==this.currentAnimation.name)return;const i=this.animations.find(r=>r.name==t);if(!i)throw new Error("Gfx2SpriteJAS::play: animation not found.");this.currentAnimation=i,this.currentAnimationFrameIndex=0,this.looped=e,this.frameProgress=0}getAnimations(){return this.animations}setAnimations(t){this.animations=t}getCurrentAnimation(){return this.currentAnimation}getCurrentAnimationFrameIndex(){return this.currentAnimationFrameIndex}getTexture(){return this.texture}setTexture(t){this.texture=t}setOffsetNormalized(t,e){this.offsetFactor[0]=t,this.offsetFactor[1]=e}getBoundingRect(t=!1){return t&&this.currentAnimation&&this.currentAnimation.boundingRects[this.currentAnimationFrameIndex],this.boundingRect}getWorldBoundingRect(t=!1){if(t&&this.currentAnimation){const e=this.currentAnimation.boundingRects[this.currentAnimationFrameIndex],s=this.position[0]-e.getWidth()*this.offsetFactor[0],i=this.position[1]-e.getHeight()*this.offsetFactor[1];return e.transform(f.MAT3_TRANSFORM([s,i],this.offset,this.rotation,this.scale))}return this.boundingRect.transform(f.MAT3_TRANSFORM(this.position,this.offset,this.rotation,this.scale))}clone(t=new Zt){return super.clone(t),t.flip=[this.flip[0],this.flip[1]],t.animations=this.animations,t.texture=this.texture,t.currentAnimation=null,t.currentAnimationFrameIndex=0,t.looped=!1,t.frameProgress=0,t}}async function Th(h,t=""){const s=await(await fetch(h)).json(),i=new Array;for(const o of s.objects){const a={};for(const l in o)["id","name","x","y","visible","h","w"].includes(l)||(a[l]=o[l]);i.push({Id:o.id??o.name,Position:[+o.x,+o.y],Name:o.name,Type:o.type??`type_${o.name}`,Visible:o.visible!=="false",Size:[+o.w,+o.h],Properties:a})}const r={};s.map.animations.forEach(o=>{r[o.idx.toString()]=o.frames});const n={};return s.map.tags.forEach(o=>{n[o.label]=o.tiles}),{Ident:"JTM",Rows:s.map.h,Columns:s.map.w,TileHeight:s.map.tile_h,TileWidth:s.map.tile_w,Layers:[{Name:`unique Tilekit layer from ${h}`,Rows:s.map.h,Columns:s.map.w,OffsetX:0,OffsetY:0,Visible:!0,FrameDuration:s.map.animations[0]?.rate??0,Grid:s.map.data,Objects:i}],Tileset:{TileWidth:s.map.tile_w,TileHeight:s.map.tile_h,TextureFile:t+s.map.image_filename,Animations:r,Properties:n}}}class yh{id;position;name;type;visible;size;properties;constructor(){this.id="",this.position=[0,0],this.name="",this.type="",this.visible=!0,this.size=[0,0],this.properties=new Map}loadFromData(t){this.id=t.Id??"",this.position=t.Position??[0,0],this.name=t.Name??"",this.type=t.Type??"",this.visible=!!t.Visible,this.size=t.Size??[0,0];for(const e in t.Properties)this.properties.set(e,t.Properties[e])}getId(){return this.id}getPosition(){return this.position}getName(){return this.name}getType(){return this.type}isVisible(){return this.visible}getSize(){return this.size}getProperties(){return this.properties}}class ar{name;rows;offsetX;offsetY;columns;visible;frameDuration;grid;objects;constructor(){this.name="",this.rows=0,this.columns=0,this.offsetX=0,this.offsetY=0,this.visible=!0,this.frameDuration=0,this.grid=[],this.objects=[]}loadFromData(t){if(this.name=t.Name,this.rows=t.Rows,this.columns=t.Columns,this.offsetX=t.OffsetX??0,this.offsetY=t.OffsetY??0,this.visible=t.Visible??!0,this.frameDuration=t.FrameDuration??0,this.grid=t.Grid,t.Objects&&t.Objects.length>0)for(const e of t.Objects){const s=new yh;s.loadFromData(e),this.objects.push(s)}}getTile(t,e){return this.grid[t+e*this.columns]}getName(){return this.name}getRows(){return this.rows}getOffsetX(){return this.offsetX}getOffsetY(){return this.offsetY}getColumns(){return this.columns}isVisible(){return this.visible}getFrameDuration(){return this.frameDuration}getGrid(){return this.grid}getObjects(){return this.objects}}class Nr{columns;tileWidth;tileHeight;texture;animations;properties;constructor(){this.columns=0,this.tileWidth=0,this.tileHeight=0,this.texture=nt.getDefaultTexture(),this.animations=new Map,this.properties=new Map}async loadFromData(t){this.tileWidth=Number(t.TileWidth),this.tileHeight=Number(t.TileHeight),this.texture=await It.loadTexture(t.TextureFile),this.columns=t.Columns?Number(t.Columns):this.texture.width/this.tileWidth,this.animations.clear();for(const e in t.Animations)this.animations.set(Number(e),t.Animations[e]??[]);this.properties.clear();for(const e in t.Properties)this.properties.set(Number(e),t.Properties[e])}async loadFromTexture(t,e,s){this.texture=await It.loadTexture(t),this.columns=this.texture.width/e,this.tileWidth=e,this.tileHeight=s}getTilePositionX(t){return(t-1)%this.columns*this.tileWidth}getTilePositionY(t){return Math.floor((t-1)/this.columns)*this.tileHeight}getTileHeight(){return this.tileHeight}getTileWidth(){return this.tileWidth}getColumns(){return this.columns}getTexture(){return this.texture}getAnimation(t){return this.animations.get(t)}getProperties(t){const e=this.properties.get(t);if(!e)throw new Error("Gfx2TileMap::getProperties(): Properties not found for this tile");return e}getProperty(t,e){const s=this.properties.get(t);if(!s)throw new Error("Gfx2TileMap::getProperty(): Properties not found for this tile");return s[e]}}class Se{rows;columns;tileHeight;tileWidth;tileLayers;tileset;constructor(){this.rows=0,this.columns=0,this.tileHeight=0,this.tileWidth=0,this.tileLayers=[],this.tileset=new Nr}async loadFromFile(t){const s=await(await fetch(t)).json();await this.loadFromData(s)}async loadFromTileKit(t,e=""){const s=await Th(t,e);await this.loadFromData(s)}async loadFromData(t){if(!t.hasOwnProperty("Ident")||t.Ident!="JTM")throw new Error("Gfx2TileMap::loadFromData(): Data not valid !");this.rows=t.Rows,this.columns=t.Columns,this.tileHeight=t.TileHeight,this.tileWidth=t.TileWidth,this.tileLayers=[];for(const e of t.Layers){const s=new ar;s.loadFromData(e),this.tileLayers.push(s)}this.tileset=new Nr,t.Tileset&&await this.tileset.loadFromData(t.Tileset)}getHeight(){return this.rows*this.tileHeight}getWidth(){return this.columns*this.tileWidth}getRows(){return this.rows}getColumns(){return this.columns}getTileHeight(){return this.tileHeight}getTileWidth(){return this.tileWidth}getTileLayer(t){return this.tileLayers[t]}getTileLayers(){return this.tileLayers}findTileLayer(t){return this.tileLayers.find(e=>e.getName()==t)}getTileset(){return this.tileset}getPositionX(t){return t*this.tileWidth}getPositionY(t){return t*this.tileHeight}getLocationCol(t){return Math.floor(t/this.tileWidth)}getLocationRow(t){return Math.floor(t/this.tileHeight)}getPositionIso(t,e){const s=Math.ceil((e-t)*(this.tileWidth*.5)),i=Math.ceil((e+t)*(this.tileHeight*.5));return[s,i]}getLocationFromIso(t,e){const s=e/this.tileHeight,i=t/this.tileWidth,r=Math.ceil(s+i),n=Math.ceil(s-i);return[r,n]}box(t,e,s,i,r,n,o,a=.01){const l=this.getLocationRow(o+e),c=this.getLocationRow(n+e),u=this.getLocationCol(r+t),p=this.getLocationCol(i+t),d={left:!1,right:!1,top:!1,bottom:!1,horizontalRow:-1,horizontalCol:-1,verticalRow:-1,verticalCol:-1,isGrounded:!1,isAgainstWall:null,mx:t,my:e},E=this.getTileLayer(s);for(let m=c;m<=l;m++){for(let _=p;_<=u;_++)if(E.getTile(_,m)!==0){const M=_*this.tileWidth,L=m*this.tileWidth,O=f.COLLIDE_RECT_TO_RECT([i+t,n],[r+t,o],[M,L],[M+this.tileWidth,L+this.tileHeight]),H=f.COLLIDE_RECT_TO_RECT([i,n+e],[r,o+e],[M,L],[M+this.tileWidth,L+this.tileHeight]);H&&m==l&&e>0?(d.bottom=!0,d.isGrounded=!0,d.verticalRow=m,d.verticalCol=_,d.my=L-o-a):H&&m==c&&e<0&&(d.top=!0,d.verticalRow=m,d.verticalCol=_,d.my=L+this.tileHeight-n+a),O&&_==p&&t<0?(d.left=!0,d.horizontalRow=m,d.horizontalCol=_,d.mx=M+this.tileWidth-i+a):O&&_==u&&t>0&&(d.right=!0,d.horizontalRow=m,d.horizontalCol=_,d.mx=M-r-a)}const y=this.getLocationCol(i-.1);E.getTile(y,m)!==0&&(d.isAgainstWall="left");const w=this.getLocationCol(r+.1);E.getTile(w,m)!==0&&(d.isAgainstWall="right")}return d}}class Ci extends qe{textureChanged;offset;offsetFactor;flip;pixelsPerUnit;billboardMode;grp1;texture;constructor(){super(Ln),this.textureChanged=!1,this.offset=[0,0],this.offsetFactor=[0,0],this.flip=[!1,!1],this.pixelsPerUnit=100,this.billboardMode=!1,this.grp1=k.createStaticGroup("SPRITE_PIPELINE",1),this.texture=this.grp1.setTexture(0,"TEXTURE",k.createTextureFromBitmap()),this.texture=this.grp1.setSampler(1,"SAMPLER",this.texture),this.grp1.allocate()}delete(){this.grp1.delete(),super.delete()}draw(){Nn.drawSprite(this)}getTransformMatrix(){const t=f.MAT4_IDENTITY();return f.MAT4_MULTIPLY(t,f.MAT4_TRANSLATE(this.position[0],this.position[1],this.position[2]),t),f.MAT4_MULTIPLY(t,f.MAT4_ROTATE_Y(this.rotation[1]),t),f.MAT4_MULTIPLY(t,f.MAT4_ROTATE_X(this.rotation[0]),t),f.MAT4_MULTIPLY(t,f.MAT4_ROTATE_Z(this.rotation[2]),t),f.MAT4_MULTIPLY(t,f.MAT4_SCALE(this.scale[0],this.scale[1],this.scale[2]),t),f.MAT4_MULTIPLY(t,f.MAT4_SCALE(1/this.pixelsPerUnit,1/this.pixelsPerUnit,1/this.pixelsPerUnit),t),f.MAT4_MULTIPLY(t,f.MAT4_TRANSLATE(-this.offset[0],-this.offset[1],0),t),t}getOffset(){return this.offset}getOffsetX(){return this.offset[0]}getOffsetY(){return this.offset[1]}setOffset(t,e){this.offset=[t,e]}setOffsetNormalized(t,e){this.offsetFactor[0]=t,this.offsetFactor[1]=e}getFlip(){return this.flip}setFlipX(t){this.flip[0]=t}setFlipY(t){this.flip[1]=t}getPixelsPerUnit(){return this.pixelsPerUnit}setPixelsPerUnit(t){this.pixelsPerUnit=t}getBillboardMode(){return this.billboardMode}setBillboardMode(t){this.billboardMode=t}setTexture(t){this.texture=t,this.textureChanged=!0}getTexture(){return this.texture}getGroup01(){return this.textureChanged&&(this.grp1.setTexture(0,"TEXTURE",this.texture),this.grp1.allocate(),this.textureChanged=!1),this.grp1}clone(t=new Ci,e=f.MAT4_IDENTITY()){return super.clone(t,e),t.textureChanged=!0,t.offset=[this.offset[0],this.offset[1]],t.flip=[this.flip[0],this.flip[1]],t.pixelsPerUnit=this.pixelsPerUnit,t.billboardMode=this.billboardMode,t.texture=this.texture,t}}class fs extends Ci{animations;currentAnimation;currentAnimationFrameIndex;looped;frameProgress;constructor(){super(),this.animations=[],this.currentAnimation=null,this.currentAnimationFrameIndex=0,this.looped=!1,this.frameProgress=0}async loadFromFile(t){const s=await(await fetch(t)).json();this.loadFromData(s)}async loadFromAsepriteFile(t){const e=await or(t);this.loadFromData(e)}loadFromData(t){if(!t.hasOwnProperty("Ident")||t.Ident!="JAS")throw new Error("Gfx3SpriteJAS::loadFromData(): Data not valid !");this.offset[0]=t.OffsetX??0,this.offset[1]=t.OffsetY??0,this.flip[0]=t.FlipX??!1,this.flip[1]=t.FlipY??!1,this.offsetFactor[0]=t.OffsetFactorX??0,this.offsetFactor[1]=t.OffsetFactorY??0,this.animations=[];for(const e of t.Animations){const s={name:e.Name,frames:[],frameDuration:Number(e.FrameDuration),boundingBoxes:[]};for(const i of e.Frames)s.frames.push({x:i.X,y:i.Y,width:i.Width,height:i.Height}),s.boundingBoxes.push(Tt.createFromCoord(i.X,i.Y,0,i.Width,i.Height,0));this.animations.push(s)}this.boundingBox=this.animations[0].boundingBoxes[0],this.currentAnimation=null,this.currentAnimationFrameIndex=0,this.frameProgress=0}update(t){if(!this.currentAnimation||!this.texture)return;const e=this.currentAnimation.frames[this.currentAnimationFrameIndex],s=0,i=0,r=e.width,n=e.height,o=e.x/this.texture.gpuTexture.width,a=e.y/this.texture.gpuTexture.height,l=(e.x+e.width)/this.texture.gpuTexture.width,c=(e.y+e.height)/this.texture.gpuTexture.height,u=this.flip[0]?1-o:o,p=this.flip[1]?1-a:a,d=this.flip[0]?1-l:l,E=this.flip[1]?1-c:c;this.offsetFactor[0]!=0&&(this.offset[0]=e.width*this.offsetFactor[0]),this.offsetFactor[1]!=0&&(this.offset[1]=e.height*this.offsetFactor[1]),this.beginVertices(6),this.defineVertex(s,n,0,u,p),this.defineVertex(s,i,0,u,E),this.defineVertex(r,i,0,d,E),this.defineVertex(r,i,0,d,E),this.defineVertex(r,n,0,d,p),this.defineVertex(s,n,0,u,p),this.endVertices(),this.frameProgress>=this.currentAnimation.frameDuration?this.currentAnimationFrameIndex==this.currentAnimation.frames.length-1?(v.emit(this,"E_FINISHED"),this.currentAnimationFrameIndex=this.looped?0:this.currentAnimation.frames.length-1,this.frameProgress=0):(this.currentAnimationFrameIndex=this.currentAnimationFrameIndex+1,this.frameProgress=0):this.frameProgress+=t}play(t,e=!1,s=!1){if(s&&this.currentAnimation&&t==this.currentAnimation.name)return;const i=this.animations.find(r=>r.name==t);if(!i)throw new Error("Gfx3SpriteJAS::play: animation not found.");this.currentAnimation=i,this.currentAnimationFrameIndex=0,this.looped=e,this.frameProgress=0}getAnimations(){return this.animations}setAnimations(t){this.animations=t}getCurrentAnimation(){return this.currentAnimation}getCurrentAnimationFrameIndex(){return this.currentAnimationFrameIndex}getBoundingRect(t=!1){return t&&this.currentAnimation&&this.currentAnimation.boundingBoxes[this.currentAnimationFrameIndex],this.boundingBox}getWorldBoundingRect(t=!1){return t&&this.currentAnimation?this.currentAnimation.boundingBoxes[this.currentAnimationFrameIndex].transform(this.getTransformMatrix()):this.boundingBox.transform(this.getTransformMatrix())}clone(t=new fs,e=f.MAT4_IDENTITY()){return super.clone(t,e),t.animations=this.animations,t.currentAnimation=null,t.currentAnimationFrameIndex=0,t.looped=!1,t.frameProgress=0,t.offsetFactor[0]=this.offsetFactor[0],t.offsetFactor[1]=this.offsetFactor[1],t}}class hr extends Ci{textureRect;constructor(){super(),this.textureRect=[0,0,1,1]}async loadFromFile(t){const s=await(await fetch(t)).json();this.textureRect[0]=s.X,this.textureRect[1]=s.Y,this.textureRect[2]=s.Width,this.textureRect[3]=s.Height,this.offset[0]=s.OffsetX??0,this.offset[1]=s.OffsetY??0,this.flip[0]=s.FlipX??!1,this.flip[1]=s.FlipY??!1,this.offsetFactor[0]=s.OffsetFactorX??0,this.offsetFactor[1]=s.OffsetFactorY??0,this.boundingBox=Tt.createFromCoord(s.X,s.Y,0,s.Width,s.Height,0)}update(){if(!this.texture)return;const t=0,e=0,s=this.textureRect[2],i=this.textureRect[3],r=this.textureRect[0]/this.texture.gpuTexture.width,n=this.textureRect[1]/this.texture.gpuTexture.height,o=(this.textureRect[0]+this.textureRect[2])/this.texture.gpuTexture.width,a=(this.textureRect[1]+this.textureRect[3])/this.texture.gpuTexture.height,l=this.flip[0]?1-r:r,c=this.flip[1]?1-n:n,u=this.flip[0]?1-o:o,p=this.flip[1]?1-a:a;this.offsetFactor[0]!=0&&(this.offset[0]=this.textureRect[2]*this.offsetFactor[0]),this.offsetFactor[1]!=0&&(this.offset[1]=this.textureRect[3]*this.offsetFactor[1]),this.beginVertices(6),this.defineVertex(t,i,0,l,c),this.defineVertex(t,e,0,l,p),this.defineVertex(s,e,0,u,p),this.defineVertex(s,e,0,u,p),this.defineVertex(s,i,0,u,c),this.defineVertex(t,i,0,l,c),this.endVertices()}getTextureRect(){return this.textureRect}getTextureRectWidth(){return this.textureRect[2]}getTextureRectHeight(){return this.textureRect[3]}setTextureRect(t,e,s,i){this.textureRect=[t,e,s,i]}setTexture(t){this.textureRect[2]==0&&this.textureRect[3]==0&&(this.textureRect[2]=t.gpuTexture.width,this.textureRect[3]=t.gpuTexture.height,this.boundingBox=Tt.createFromCoord(this.textureRect[0],this.textureRect[1],0,this.textureRect[2],this.textureRect[3],0)),this.texture=t}clone(t=new hr,e=f.MAT4_IDENTITY()){return super.clone(t,e),this.textureRect=[t.textureRect[0],t.textureRect[1],t.textureRect[2],t.textureRect[3]],t}}class Ls{variants;blocks;commandRegister;enabled;currentBlockId;currentCallIndex;onBeforeBlockExec;onAfterBlockExec;onBeforeCommandExec;onAfterCommandExec;constructor(){this.variants={},this.blocks=[],this.commandRegister=new Map,this.enabled=!0,this.currentBlockId="",this.currentCallIndex=0,this.onBeforeBlockExec=()=>{},this.onAfterBlockExec=()=>{},this.onBeforeCommandExec=()=>{},this.onAfterCommandExec=()=>{},this.registerCommand("WAITPAD",this.#t.bind(this)),this.registerCommand("GOTO",this.#e.bind(this)),this.registerCommand("GOTO_IF",this.#s.bind(this)),this.registerCommand("EXEC_IF",this.#i.bind(this)),this.registerCommand("VAR_SET",this.#r.bind(this)),this.registerCommand("VAR_ADD",this.#n.bind(this)),this.registerCommand("VAR_SUB",this.#o.bind(this)),this.registerCommand("DELAY",this.#a.bind(this))}async loadFromFile(t){const s=await(await fetch(t)).json();this.blocks=[];for(const i of s){const r={id:i.Id,description:i.Description,calls:[]};for(const n of i.Calls)r.calls.push({commandName:n.Name,commandArgs:n.Args});this.blocks.push(r)}}async loadVariantFromFile(t){const s=await(await fetch(t)).json();for(const i in s)this.addVariant(i,s[i])}loadVariantFromData(t){for(const e in t)this.addVariant(e,t[e])}update(t){if(!this.enabled)return;const e=this.blocks.find(r=>r.id==this.currentBlockId);if(!e)return;if(this.currentCallIndex==e.calls.length){this.onAfterBlockExec(e),this.currentBlockId="",this.currentCallIndex=0;return}this.currentCallIndex==0&&this.onBeforeBlockExec(e);const s=e.calls[this.currentCallIndex],i=this.runCommand(s.commandName,s.commandArgs);if(typeof i=="string"){this.currentBlockId=i,this.currentCallIndex=0;return}this.currentCallIndex<e.calls.length&&this.currentCallIndex++}runCommand(t,e=[]){const s=this.commandRegister.get(t);if(!s)throw new Error("ScriptMachine::runCommand: try to call an not existant command "+t+" !");this.onBeforeCommandExec(s);const i=s.call(this,...e);return this.onAfterCommandExec(s),i}registerCommand(t,e){if(this.commandRegister.has(t))throw new Error("ScriptMachine::registerCommand: key already exist !");this.commandRegister.set(t,e)}clearCommandRegister(){this.commandRegister.clear()}jump(t){this.currentBlockId=t,this.currentCallIndex=0}isEnabled(){return this.enabled}setEnabled(t){this.enabled=t}addVariant(t,e){if(this.variants.hasOwnProperty(t))throw new Error("ScriptMachine::addVariant: varloc already exist in variants dictionnary");this.variants[t]=e}removeVariant(t){if(!this.variants.hasOwnProperty(t))throw new Error("ScriptMachine::removeVariant: varloc not exist in variants dictionnary");delete this.variants[t]}setVariant(t,e){if(!this.variants.hasOwnProperty(t))throw new Error("ScriptMachine::setVariant: varloc not exist in variants dictionnary");this.variants[t]=e}hasVariant(t){return this.variants.hasOwnProperty(t)}getVariant(t){if(!this.variants.hasOwnProperty(t))throw new Error("ScriptMachine::getVariant: varloc not exist in variants dictionnary");return this.variants[t]}#t(){this.setEnabled(!1),document.addEventListener("keydown",t=>t.key=="Enter"?this.setEnabled(!0):"",{once:!0})}#e(t){return t}#s(t,e,s,i){return Fr(this.getVariant(t),e,s)?i:null}#i(t,e,s,i={CommandName:"",CommandArgs:[]}){Fr(this.getVariant(t),e,s)&&this.runCommand(i.CommandName,i.CommandArgs)}#r(t,e){this.setVariant(t,e)}#n(t,e){const s=this.getVariant(t);this.setVariant(t,s+e)}#o(t,e){const s=this.getVariant(t);this.setVariant(t,s-e)}#a(t){this.setEnabled(!1),window.setTimeout(()=>this.setEnabled(!0),t)}}function Fr(h,t,e){return t=="not equal"&&h!=e||t=="equal"&&h==e||t=="is less than"&&h<e||t=="is greater than"&&h>e}class Rt extends Array{constructor(){super()}get(t){const e=this.find(s=>s.name==t);if(!e)throw new Error("EngineManager::PackItemList::get(): item not found !");return e.object}}class qn{jsc;snd;constructor(){this.jsc=new Rt,this.snd=new Rt}}class Xn extends qn{tex;mat;jam;jsm;obj;jas;jss;jwm;jnm;jlm;jsv;jlt;grf;grd;any;constructor(){super(),this.tex=new Rt,this.mat=new Rt,this.jam=new Rt,this.jsm=new Rt,this.obj=new Rt,this.jas=new Rt,this.jss=new Rt,this.jwm=new Rt,this.jnm=new Rt,this.jlm=new Rt,this.jsv=new Rt,this.jlt=new Rt,this.grf=new Rt,this.grd=new Rt,this.any=new Rt}}class Ah extends qn{tex;jss;jas;jtm;jlm;grf;grd;any;constructor(){super(),this.tex=new Rt,this.jss=new Rt,this.jas=new Rt,this.jtm=new Rt,this.jlm=new Rt,this.grf=new Rt,this.grd=new Rt,this.any=new Rt}}class wh{then;elapsedTime;frameRateFixed;frameRateValue;textureExts;constructor(){this.then=0,this.elapsedTime=0,this.frameRateFixed=!1,this.frameRateValue=60,this.textureExts=["jpg","jpeg","png","bmp"]}startup(t=!0,e=!0){Cs.enableScanlines(t),Jt.setShowDebug(e),this.run(0)}run(t){const e=t-this.then;this.then=t,(!this.frameRateFixed||this.elapsedTime>1e3/this.frameRateValue)&&(Q.update(e),nt.update(e),P.update(e),ut.update(e),this.elapsedTime=0),this.elapsedTime+=e,k.beginDrawing(),ut.draw(),k.endDrawing(),nt.beginRender(),nt.render(),nt.endRender(),k.beginRender(),Ps.render(),Ve.render(),k.setDestinationTexture(os.getSourceTexture()),k.beginPassRender(0),Un.render(),Jt.render(),Ot.render(e),Nn.render(),jn.render(),Vn.render(),k.endPassRender(),os.render(e,k.getCurrentRenderingTexture()),k.endRender();const s=document.getElementById("fps");s&&(s.textContent=(1e3/e).toFixed(2));const i=document.getElementById("rt");i&&(i.textContent=(1e3/k.getLastRenderTime()).toFixed(2)),requestAnimationFrame(r=>this.run(r))}async loadPack3D(t){const e=await fetch(t),s=await Sr.loadAsync(await e.blob()),i=new Xn;for(const r of s.file(/\.(jpg|jpeg|png|bmp)/)){const n=this.#t(r.name),o=s.file(r.name);if(o!=null){const a=URL.createObjectURL(await o.async("blob")),l={};let c="",u=!1;const p=s.file(n.name+".tex");if(p!=null){const d=JSON.parse(await p.async("string"));l.addressModeU=d.AddressModeU,l.addressModeV=d.AddressMoveV,l.addressModeW=d.AddressMoveW,l.magFilter=d.MagFilter,l.minFilter=d.MinFilter,l.mipmapFilter=d.MipMapFilter,l.lodMinClamp=d.LodMinClamp,l.lodMaxClamp=d.LodMaxClamp,l.compare=d.Compare,l.maxAnisotropy=d.MaxAnisotropy,c=d.Type,u=d.Is8Bit}if(c=="Mips"){const d=await st.loadTextureMips(a,l,u,r.name);i.tex.push({name:n.name,ext:"bitmap",object:d,blobUrl:a})}else if(c=="Cubemap"){const d=await st.loadCubemapTexture(a,n.ext,r.name);i.tex.push({name:n.name,ext:"bitmap",object:d,blobUrl:a})}else{const d=await st.loadTexture(a,l,u,r.name);i.tex.push({name:n.name,ext:"bitmap",object:d,blobUrl:a})}}}for(const r of s.file(/.*/)){const n=this.#t(r.name),o=s.file(r.name);if(o!=null&&n.ext=="mp3"){const a=URL.createObjectURL(await o.async("blob")),l=await ki.loadSound(a,r.name);i.snd.push({name:n.name,ext:"mp3",object:l,blobUrl:a})}if(o!=null&&n.ext=="jsc"){const a=URL.createObjectURL(await o.async("blob")),l=new Ls;await l.loadFromFile(a),i.jsc.push({name:n.name,ext:"jsc",object:l,blobUrl:a})}if(o!=null&&n.ext=="mat"){const a=URL.createObjectURL(await o.async("blob")),l=await vt.createFromFile(a);i.mat.push({name:n.name,ext:"mat",object:l,blobUrl:a})}if(o!=null&&n.ext=="jam"){const a=URL.createObjectURL(await o.async("blob")),l=new ke;await l.loadFromFile(a),i.jam.push({name:n.name,ext:"jam",object:l,blobUrl:a})}if(o!=null&&n.ext=="bam"){const a=URL.createObjectURL(await o.async("blob")),l=new ke;await l.loadFromBinaryFile(a),i.jam.push({name:n.name,ext:"bam",object:l,blobUrl:a})}if(o!=null&&n.ext=="jsm"){const a=URL.createObjectURL(await o.async("blob")),l=new ft;await l.loadFromFile(a),i.jsm.push({name:n.name,ext:"jsm",object:l,blobUrl:a})}if(o!=null&&n.ext=="bsm"){const a=URL.createObjectURL(await o.async("blob")),l=new ft;await l.loadFromBinaryFile(a),i.jsm.push({name:n.name,ext:"bsm",object:l,blobUrl:a})}if(o!=null&&n.ext=="obj"){const a=URL.createObjectURL(await o.async("blob")),l=s.file(n.name+".mtl");if(l!=null){const c=URL.createObjectURL(await l.async("blob")),u=new Hs;await u.loadFromFile(a,c),i.obj.push({name:n.name,ext:"obj",object:u,blobUrl:a})}}if(o!=null&&n.ext=="jas"){const a=URL.createObjectURL(await o.async("blob")),l=new fs;await l.loadFromFile(a),i.jas.push({name:n.name,ext:"jas",object:l,blobUrl:a})}if(o!=null&&n.ext=="jss"){const a=URL.createObjectURL(await o.async("blob")),l=new hr;await l.loadFromFile(a),i.jss.push({name:n.name,ext:"jss",object:l,blobUrl:a})}if(o!=null&&n.ext=="jwm"){const a=URL.createObjectURL(await o.async("blob")),l=new ps;await l.loadFromFile(a),i.jwm.push({name:n.name,ext:"jwm",object:l,blobUrl:a})}if(o!=null&&n.ext=="bwm"){const a=URL.createObjectURL(await o.async("blob")),l=new ps;await l.loadFromBinaryFile(a),i.jwm.push({name:n.name,ext:"bwm",object:l,blobUrl:a})}if(o!=null&&n.ext=="jnm"){const a=URL.createObjectURL(await o.async("blob")),l=new Ds;await l.loadFromFile(a),i.jnm.push({name:n.name,ext:"jnm",object:l,blobUrl:a})}if(o!=null&&n.ext=="bnm"){const a=URL.createObjectURL(await o.async("blob")),l=new Ds;await l.loadFromBinaryFile(a),i.jnm.push({name:n.name,ext:"bnm",object:l,blobUrl:a})}if(o!=null&&n.ext=="jlm"){const a=URL.createObjectURL(await o.async("blob")),l=new Pe;await l.loadFromFile(a),i.jlm.push({name:n.name,ext:"jlm",object:l,blobUrl:a})}if(o!=null&&n.ext=="blm"){const a=URL.createObjectURL(await o.async("blob")),l=new Pe;await l.loadFromBinaryFile(a),i.jlm.push({name:n.name,ext:"blm",object:l,blobUrl:a})}if(o!=null&&n.ext=="jsv"){const a=URL.createObjectURL(await o.async("blob")),l=new oi;await l.loadFromFile(a),i.jsv.push({name:n.name,ext:"jsv",object:l,blobUrl:a})}if(o!=null&&n.ext=="bsv"){const a=URL.createObjectURL(await o.async("blob")),l=new oi;await l.loadFromBinaryFile(a),i.jsv.push({name:n.name,ext:"bsv",object:l,blobUrl:a})}if(o!=null&&n.ext=="jlt"){const a=URL.createObjectURL(await o.async("blob")),l=new mh;await l.loadFromFile(a),i.jlt.push({name:n.name,ext:"jlt",object:l,blobUrl:a})}if(o!=null&&n.ext=="grf"){const a=URL.createObjectURL(await o.async("blob")),l=new Eh;await l.loadFromFile(a),i.grf.push({name:n.name,ext:"grf",object:l,blobUrl:a})}if(o!=null&&n.ext=="grd"){const a=URL.createObjectURL(await o.async("blob")),l=new Ch;await l.loadFromFile(a),i.grd.push({name:n.name,ext:"grd",object:l,blobUrl:a})}if(o!=null&&n.ext=="any"){const a=JSON.parse(await o.async("string"));i.any.push({name:n.name,ext:"any",object:a,blobUrl:""})}}for(const r of[...i.jsm,...i.jam])r.object.setMaterial(i.mat.get(r.name));return i}async loadPack2D(t){const e=await fetch(t),s=await Sr.loadAsync(await e.blob()),i=new Ah;for(const r of s.file(/\.(jpg|jpeg|png|bmp)/)){const n=this.#t(r.name),o=s.file(r.name);if(o!=null){const a=URL.createObjectURL(await o.async("blob")),l=await It.loadTexture(a);i.tex.push({name:n.name,ext:"bitmap",object:l,blobUrl:a})}}for(const r of s.file(/.*/)){const n=this.#t(r.name),o=s.file(r.name);if(o!=null&&n.ext=="mp3"){const a=URL.createObjectURL(await o.async("blob")),l=await ki.loadSound(a,r.name);i.snd.push({name:n.name,ext:"mp3",object:l,blobUrl:a})}if(o!=null&&n.ext=="jsc"){const a=URL.createObjectURL(await o.async("blob")),l=new Ls;await l.loadFromFile(a),i.jsc.push({name:n.name,ext:"jsc",object:l,blobUrl:a})}if(o!=null&&n.ext=="jss"){const a=URL.createObjectURL(await o.async("blob")),l=new ne;await l.loadFromFile(a),i.jss.push({name:n.name,ext:"jss",object:l,blobUrl:a})}if(o!=null&&n.ext=="jas"){const a=URL.createObjectURL(await o.async("blob")),l=new Zt;await l.loadFromFile(a),i.jas.push({name:n.name,ext:"jas",object:l,blobUrl:a})}if(o!=null&&n.ext=="jtm"){const a=URL.createObjectURL(await o.async("blob")),l=new Se;await l.loadFromFile(a),i.jtm.push({name:n.name,ext:"jtm",object:l,blobUrl:a})}if(o!=null&&n.ext=="jlm"){const a=URL.createObjectURL(await o.async("blob")),l=new Pe;await l.loadFromFile(a),i.jlm.push({name:n.name,ext:"jlm",object:l,blobUrl:a})}if(o!=null&&n.ext=="blm"){const a=URL.createObjectURL(await o.async("blob")),l=new Pe;await l.loadFromBinaryFile(a),i.jlm.push({name:n.name,ext:"blm",object:l,blobUrl:a})}if(o!=null&&n.ext=="grf"){const a=URL.createObjectURL(await o.async("blob")),l=new gh;await l.loadFromFile(a),i.grf.push({name:n.name,ext:"grf",object:l,blobUrl:a})}if(o!=null&&n.ext=="grd"){const a=URL.createObjectURL(await o.async("blob")),l=new nr;await l.loadFromFile(a),i.grd.push({name:n.name,ext:"grd",object:l,blobUrl:a})}if(o!=null&&n.ext=="any"){const a=JSON.parse(await o.async("string"));i.any.push({name:n.name,ext:"any",object:a,blobUrl:""})}}return i}setFrameRateFixed(t){this.frameRateFixed=t}setFrameRateValue(t){this.frameRateValue=t}#t(t){const e=t.split(".");return{name:e.slice(0,-1).join(),ext:e.at(-1)??""}}}const Yn=new wh;class yt{blocking;constructor(){this.blocking=!1}setBlocking(t){this.blocking=t}isBlocking(){return this.blocking}update(t){}draw(){}async onEnter(t){}onExit(){}onBringToFront(t){}onBringToBack(t){}}class xt{id;className;template;node;constructor(t={}){this.id=t.id??"",this.className=t.className??"",this.template=t.template??"",this.node=document.createElement("div"),this.node.className=this.className,this.node.innerHTML=this.template,this.node.addEventListener("animationend",()=>v.emit(this,"E_ANIMATION_FINISHED"))}update(t){}delete(){this.node.remove(),v.unsubscribe(Q,"E_ACTION",this)}getId(){return this.id}setId(t){this.id=t,this.node.id=t}getNode(){return this.node}appendChild(t){this.node.appendChild(t)}removeChild(t){this.node.removeChild(this.node.children[t])}appendStyles(t){this.node.style.cssText+=t}focus(){this.node.classList.add("u-focused"),v.emit(this,"E_FOCUSED"),v.subscribe(Q,"E_ACTION",this,t=>this.onAction(t.actionId))}unfocus(){this.node.classList.remove("u-focused"),v.emit(this,"E_UNFOCUSED"),v.unsubscribe(Q,"E_ACTION",this)}isFocused(){return this.node.classList.contains("u-focused")}setVisible(t){t?this.node.classList.remove("u-hidden"):this.node.classList.add("u-hidden")}isVisible(){return!this.node.classList.contains("u-hidden")}setEnabled(t){t?this.node.classList.remove("u-disabled"):this.node.classList.add("u-disabled")}isEnabled(){return!this.node.classList.contains("u-disabled")}setSelected(t){t?this.node.classList.add("u-selected"):this.node.classList.remove("u-selected")}isSelected(){return this.node.classList.contains("u-selected")}getScreenPosition(){let t=this.node.getBoundingClientRect();return[t.left,t.top]}getPosition(){const t=parseInt(this.node.style.left),e=parseInt(this.node.style.top);return[t,e]}setPosition(t,e){this.node.style.left=t+"px",this.node.style.top=e+"px"}animate(t){this.node.style.animation=t}onAction(t){}}var Ts=(h=>(h[h.X=0]="X",h[h.Y=1]="Y",h[h.XY=2]="XY",h))(Ts||{});class ms extends xt{axis;rows;columns;multiple;selectable;togglable;widgets;focusedWidget;selectedWidgets;constructor(t={}){super({className:t.className??"UIMenu"}),this.axis=t.axis??1,this.rows=t.rows??0,this.columns=t.columns??0,this.multiple=t.multiple??!1,this.selectable=t.selectable??!0,this.togglable=t.togglable??!0,this.widgets=[],this.selectedWidgets=[],this.axis==0?(this.rows=1,this.columns=1/0,this.node.style.display="flex",this.node.style.flexDirection="row"):this.axis==1?(this.rows=1/0,this.columns=1,this.node.style.display="flex",this.node.style.flexDirection="column"):(this.node.style.display="grid",this.node.style.grid="repeat("+this.rows+", auto) / repeat("+this.columns+", auto)")}delete(){for(const t of this.widgets)t.delete();super.delete()}update(t){for(const e of this.widgets)e.update(t)}focus(t=0){if(this.widgets.length>0&&t==0){const e=this.focusedWidget?this.widgets.indexOf(this.focusedWidget):0;this.focusWidget(e,!0)}super.focus()}addWidget(t,e=-1){const s=t.getNode();e==-1?(this.widgets.push(t),this.node.appendChild(s)):(this.widgets.splice(e+1,0,t),this.node.insertBefore(s,this.node.children[e])),s.addEventListener("click",()=>this.#t(t)),s.addEventListener("mousemove",()=>this.#e(t))}removeWidget(t){const e=this.widgets[t];if(!e)throw new Error("UIMenu::removeWidget(): widget not found !");this.selectedWidgets.indexOf(e)!=-1&&this.selectedWidgets.splice(this.selectedWidgets.indexOf(e),1),this.focusedWidget==e&&(this.focusedWidget=void 0),this.widgets.splice(this.widgets.indexOf(e),1),e.delete()}focusWidget(t,e=!1,s=!0){const i=this.widgets[t];if(!i)throw new Error("UIMenu::focusWidget(): widget not found !");if(!e){const r=this.#s(t);r.top<0&&(this.node.scrollTop+=r.top),r.bottom>this.node.clientHeight&&(this.node.scrollTop+=r.bottom-this.node.clientHeight)}this.widgets.forEach(r=>r.unfocus()),i.focus(),this.focusedWidget=i,s&&v.emit(this,"E_ITEM_FOCUSED",{id:i.getId(),index:t})}unfocusWidget(t=!0){this.widgets.forEach(e=>e.unfocus()),this.focusedWidget=void 0,t&&v.emit(this,"E_ITEM_UNFOCUSED")}selectWidget(t,e=!0){const s=this.widgets[t];if(!s)throw new Error("UIMenu::selectWidget(): widget not found !");if(s.isEnabled()){if(this.multiple&&this.togglable&&s.isSelected()){s.setSelected(!1),this.selectedWidgets.splice(this.selectedWidgets.indexOf(s),1);return}this.multiple||(this.widgets.forEach(i=>i.setSelected(!1)),this.selectedWidgets=[]),s.setSelected(!0),this.selectedWidgets.push(s),e&&v.emit(this,"E_ITEM_SELECTED",{id:s.getId(),index:t})}}unselectWidget(t,e=!0){const s=this.widgets[t];if(!s)throw new Error("UIMenu::unselectWidget(): widget not found !");s.isSelected()&&(s.setSelected(!1),this.selectedWidgets.splice(this.selectedWidgets.indexOf(s),1),e&&v.emit(this,"E_ITEM_UNSELECTED",{id:s.getId(),index:t}))}unselectWidgets(t=!0){this.widgets.forEach(e=>e.setSelected(!1)),this.selectedWidgets=[],t&&v.emit(this,"E_UNSELECTED")}setEnabledWidget(t,e){const s=this.widgets[t];if(!s)throw new Error("UIMenu::setEnabledWidget(): widget not found !");s.setEnabled(e)}setEnabledWidgets(t){this.widgets.forEach(e=>e.setEnabled(t))}clear(){this.widgets.forEach(t=>t.delete()),this.widgets=[],this.focusedWidget=void 0,this.selectedWidgets=[],this.node.innerHTML=""}getFocusedWidgetId(){return this.focusedWidget?this.focusedWidget.getId():null}getFocusedWidgetIndex(){return this.focusedWidget?this.widgets.indexOf(this.focusedWidget):-1}getSelectedWidgetId(){return this.selectedWidgets[0]?this.selectedWidgets[0].getId():null}getSelectedWidgetIndex(){return this.selectedWidgets[0]?this.widgets.indexOf(this.selectedWidgets[0]):-1}getSelectedWidgetIds(){return this.selectedWidgets.map(t=>t.getId())}getSelectedWidgetIndexes(){return this.selectedWidgets.map(t=>this.widgets.indexOf(t))}getWidgets(){return this.widgets}getWidget(t){return this.widgets[t]}onAction(t){if(t=="BACK")v.emit(this,"E_CLOSED");else if(t=="OK"){const e=this.getFocusedWidgetIndex();this.selectWidget(e)}else if(t=="LEFT"){const e=this.getFocusedWidgetIndex(),s=e-1<0?this.widgets.length-1:e-1;this.focusWidget(s)}else if(t=="RIGHT"){const e=this.getFocusedWidgetIndex(),s=e+1>this.widgets.length-1?0:e+1;this.focusWidget(s)}else if(t=="UP"){const e=this.getFocusedWidgetIndex(),s=e-this.columns<0?this.widgets.length-1:e-this.columns;this.focusWidget(s)}else if(t=="DOWN"){const e=this.getFocusedWidgetIndex(),s=e+this.columns>this.widgets.length-1?0:e+this.columns;this.focusWidget(s)}}#t(t){this.isFocused()&&this.selectWidget(this.widgets.indexOf(t),!0)}#e(t){this.isFocused()&&this.focusWidget(this.widgets.indexOf(t),!1,!0)}#s(t){const e=this.node.children[t],s=e.offsetTop-this.node.scrollTop,i=s+e.offsetHeight;return{top:s,bottom:i}}}class xh extends xt{constructor(){super({className:"UIMenuTextItem"})}setText(t){this.node.textContent=t}}class Yt extends ms{constructor(t={}){super(Object.assign(t,{className:t.className??"UIMenuText"}))}add(t,e){const s=new xh;s.setId(t),s.setText(e),this.addWidget(s)}set(t,e){const s=this.widgets.find(i=>i.getId()==t);if(!s)throw new Error("UIMenuText::set(): item not found !");s.setText(e)}remove(t){const e=this.widgets.findIndex(s=>s.getId()==t);if(e==-1)throw new Error("UIMenuText::remove(): item not found !");this.removeWidget(e)}getSelectedId(){return this.getSelectedWidgetId()}}class vh extends he{texture;animation;col;row;sx;sy;sw;sh;dw;dh;constructor(t){super(),this.texture=t.texture,this.animation=t.animation,this.elevation=t.elevation,this.position[0]=t.dx,this.position[1]=t.dy,this.offset[0]=t.ox,this.offset[1]=t.oy,this.col=t.col,this.row=t.row,this.sx=t.sx,this.sy=t.sy,this.sw=t.sw,this.sh=t.sh,this.dw=t.dw,this.dh=t.dh}onRender(){if(!this.texture)return;const t=nt.getContext();t.save(),t.translate(-this.dw*.5,-this.dh),t.drawImage(this.texture,this.sx,this.sy,this.sw,this.sh,0,0,this.dw,this.dh),t.restore()}}class _s extends he{tilemap;layerIndex;tiles;frameIndex;frameProgress;showDebug;colorDebug;lineWidthDebug;constructor(){super(),this.tilemap=new Se,this.layerIndex=0,this.tiles=[],this.frameIndex=0,this.frameProgress=0,this.showDebug=!1,this.colorDebug="blue",this.lineWidthDebug=.5}loadFromTileMap(t,e){this.tilemap=t,this.layerIndex=e,this.tiles=[],this.frameIndex=0,this.frameProgress=0;const s=t.getTileLayer(e);this.offset[0]=s.getOffsetX(),this.offset[1]=s.getOffsetY();for(let i=0;i<s.getRows();i++)for(let r=0;r<s.getColumns();r++){const n=s.getTile(r,i);n<0||this.placeTile(n,i,r)}}update(t){const e=this.tilemap.getTileset(),s=this.tilemap.getTileLayer(this.layerIndex);if(!(!e||!s)){this.frameProgress>s.getFrameDuration()&&(this.frameIndex=this.frameIndex+1,this.frameProgress=0);for(const i of this.tiles)if(i.animation.length>0){const r=i.animation[this.frameIndex%i.animation.length];i.sx=e.getTilePositionX(r),i.sy=e.getTilePositionY(r)}this.frameProgress+=t}}onRender(){const t=this.tilemap.getTileLayer(this.layerIndex);if(!t)return;const e=nt.getContext();if(t.isVisible()){const s=this.tilemap.getTileset(),i=this.tilemap.getTileWidth()/s.getTileWidth();for(let r=0;r<t.getRows();r++)for(let n=0;n<t.getColumns();n++){let o=t.getTile(n,r);if(o<0)continue;const a=this.tilemap.getPositionIso(r,n),l=s.getAnimation(o);l&&(o=l[this.frameIndex%l.length]),e.drawImage(s.getTexture(),s.getTilePositionX(o),s.getTilePositionY(o),s.getTileWidth(),s.getTileHeight(),a[0]-this.tilemap.getTileWidth()/2,a[1]-this.tilemap.getTileHeight(),this.tilemap.getTileWidth(),s.getTileHeight()*i)}}if(this.showDebug)for(let s=0;s<t.getRows();s++)for(let i=0;i<t.getColumns();i++){const r=this.tilemap.getPositionIso(s,i);e.save(),e.translate(r[0],r[1]),e.strokeStyle=this.colorDebug,e.lineWidth=this.lineWidthDebug,e.beginPath(),e.moveTo(0,0),e.lineTo(this.tilemap.getTileWidth()/2,-this.tilemap.getTileHeight()/2),e.lineTo(0,-this.tilemap.getTileHeight()),e.lineTo(-this.tilemap.getTileWidth()/2,-this.tilemap.getTileHeight()/2),e.lineTo(0,0),e.stroke(),e.closePath(),e.restore()}}placeTile(t,e,s){const i=this.tilemap.getTileLayer(this.layerIndex),r=this.tilemap.getTileset(),n=this.tilemap.getTileWidth()/r.getTileWidth(),o=r.getAnimation(t),a=this.tilemap.getPositionIso(e,s);this.tiles.push(new vh({texture:r.getTexture(),animation:o??[],elevation:this.layerIndex,col:s,row:e,sx:r.getTilePositionX(t),sy:r.getTilePositionY(t),sw:r.getTileWidth(),sh:r.getTileHeight(),dx:a[0],dy:a[1],ox:i.getOffsetX(),oy:i.getOffsetY(),dw:this.tilemap.getTileWidth(),dh:r.getTileHeight()*n}))}removeTileAt(t,e){const s=this.tiles.findIndex(i=>i.col==e&&i.row==t);s!=-1&&this.tiles.splice(s,1)}getTiles(){return this.tiles}isShowDebug(){return this.showDebug}setShowDebug(t){this.showDebug=t}getColorDebug(){return this.colorDebug}setColorDebug(t){this.colorDebug=t}getLineWidthDebug(){return this.lineWidthDebug}setLineWidthDebug(t){this.lineWidthDebug=t}}class Zn{solve(t,e,s){const i=new Map,r=[];let n=!1;for(r.push(e),i.set(e.join(";"),{pos:e,origin:null});!n;){const l=r.shift();if(!l)return null;const c=this.heuristic(t,l,s);for(const u of c){const p=u.map((E,m)=>l[m]+E),d=p.join(";");if(!(!t.isInside(p)||t.getValue(p)==1||i.get(d))&&(r.push(p),i.set(d,{pos:p,origin:l}),t.isSame(p,s))){n=!0;break}}}const o=[];let a=i.get(s.join(";"));for(;a;)o.unshift(a.pos),a=i.get(a.origin?a.origin.join(";"):"");return o}heuristic(t,e,s){return t.getDirections(e,s)}}const Ih=16;let Sh=class extends he{constructor(){super(),this.sprite=new Zt,this.direction="FORWARD",this.speed=40,this.motion=new Pe,this.pathElevation=[],this.onRunning=(t,e)=>{}}update(t){if(this.motion.isRunning()){const e=this.pathElevation[this.motion.getPrevPointIndex()],s=this.pathElevation[this.motion.getNextPointIndex()],i=this.motion.getCurrentSegmentTime(),r=e!=s,n=e+(s-e)*i;this.position[0]=this.motion.getCurrentPositionX(),this.position[1]=this.motion.getCurrentPositionZ()-n;const o=this.motion.getPrevPoint(),a=this.motion.getNextPoint();o[0]>a[0]&&o[2]<a[2]?this.direction="LEFT":o[0]<a[0]&&o[2]>a[2]?this.direction="RIGHT":o[0]>a[0]&&o[2]>a[2]?this.direction="FORWARD":o[0]<a[0]&&o[2]<a[2]&&(this.direction="BACKWARD"),r?(this.position[1]-=_h(i)*Ih,this.sprite.play("JUMP_"+this.direction,!1,!0)):this.sprite.play("RUN_"+this.direction,!0,!0),this.onRunning(this.motion.getPrevPointIndex(),i)}else this.sprite.play("IDLE_"+this.direction,!0,!0);this.sprite.update(t),this.motion.update(t)}onRender(){nt.getContext().translate(-8,-32-4),this.sprite.render()}play(t,e){this.sprite.play(t,e,!0)}getDirection(){return this.direction}setDirection(t){this.direction=t}setSprite(t){this.sprite=t}moveAlong(t,e,s){this.pathElevation=e,this.motion=new Pe,this.motion.setPoints(t),this.motion.setSpeed(this.speed),this.motion.run(),this.onRunning=s}isJumping(){const t=this.motion.getPrevPointIndex(),e=this.motion.getNextPointIndex(),s=this.pathElevation[t],i=this.pathElevation[e];return s!=i}};function _h(h){return-4*h*h+4*h+0}const Ur=150,Br=20;class bh extends yt{constructor(){super(),this.bg0=new ne,this.bg1=new ne,this.cursor=new ne,this.cursorRow=0,this.cursorCol=0,this.tilemap=new Se,this.layer1=new _s,this.gridIds=[],this.gridCollisions=[],this.gridLayers=[],this.gridSubSprites=[],this.controller=new Sh,this.controllerRow=0,this.controllerCol=0,v.subscribe(Q,"E_ACTION_ONCE",this,this.handleActionOnce)}async onEnter(){await this.tilemap.loadFromFile("./templates/bg-iso/tilemap.json"),this.layer1.loadFromTileMap(this.tilemap,0),this.layer1.setShowDebug(!0),this.bg0.setTexture(await It.loadTexture("./templates/bg-iso/background.png")),this.bg0.setOffset(this.tilemap.getWidth()/2,0),this.bg0.setPositionZ(0),this.bg1.setTexture(await It.loadTexture("./templates/bg-iso/foreground.png")),this.bg1.setOffset(this.tilemap.getWidth()/2,0),this.bg1.setPositionZ(2),this.cursor.setTexture(await It.loadTexture("./templates/bg-iso/control.png")),this.cursor.setOffset(16,16),this.cursor.setPositionZ(1),this.buildMap(),this.locateCursor(19,1);const t=new Zt;await t.loadFromFile("./templates/bg-iso/controller.jas"),t.setTexture(await It.loadTexture("./templates/bg-iso/controller.png")),this.controller.setSprite(t),this.locatePlayer(19,1)}update(t){this.controller.update(t),this.moveCamera(this.controller.getPosition())}draw(){this.bg0.draw(),this.bg1.draw(),this.cursor.draw(),this.controller.draw(),this.layer1.draw()}locateCursor(t,e){const s=this.gridCollisions[t*this.tilemap.getColumns()+e],i=this.gridLayers[t][e];if(s==1)return;const r=this.tilemap.getTileLayer(i),n=this.tilemap.getPositionIso(t,e);this.cursor.setPosition(n[0],n[1]-r.getOffsetY()),this.cursorRow=t,this.cursorCol=e}locatePlayer(t,e){const s=this.gridLayers[t][e],i=this.tilemap.getTileLayer(s),r=this.tilemap.getPositionIso(t,e);this.controller.setPosition(r[0],r[1]-i.getOffsetY()),this.controllerRow=t,this.controllerCol=e}moveCamera(t){const e=nt.getCameraPosition();t[0]-e[0]>Ur?nt.moveCamera(1,0):t[0]-e[0]<-Ur&&nt.moveCamera(-1,0),t[1]-e[1]>Br?nt.moveCamera(0,1):t[1]-e[1]<-Br&&nt.moveCamera(0,-1)}movePlayer(t,e){const s=this.controllerRow,i=this.controllerCol,r=new nr([this.tilemap.getColumns(),this.tilemap.getRows()],this.gridCollisions),o=new Zn().solve(r,[i,s],[e,t]);if(!o)return;const a=o.map(([c,u])=>{const p=this.tilemap.getPositionIso(u,c);return[p[0],0,p[1]]}),l=o.map(([c,u])=>{const p=this.gridLayers[u][c];return this.tilemap.getTileLayer(p).getOffsetY()});this.controller.moveAlong(a,l,(c,u)=>{const p=u>.5?Math.min(c+1,o.length-1):c,d=this.gridIds[o[p][1]][o[p][0]];this.controller.setPositionZ(d==2?1:3),this.controllerRow=o[p][1],this.controllerCol=o[p][0]})}buildMap(){for(let t=0;t<this.tilemap.getRows();t++){this.gridIds[t]=[],this.gridLayers[t]=[];for(let e=0;e<this.tilemap.getColumns();e++)this.gridIds[t][e]=0,this.gridLayers[t][e]=0,this.gridCollisions[t*this.tilemap.getColumns()+e]=1}for(let t=0;t<this.tilemap.getRows();t++)for(let e=0;e<this.tilemap.getColumns();e++)for(let s=0;s<this.tilemap.getTileLayers().length;s++){const r=this.tilemap.getTileLayer(s).getTile(e,t);r>0&&(this.gridIds[t][e]=r,this.gridLayers[t][e]=s,this.gridCollisions[t*this.tilemap.getColumns()+e]=0)}}handleActionOnce({actionId:t}){if(t=="RIGHT"){const e=f.CLAMP(this.cursorCol+1,0,this.tilemap.getColumns()-1);this.locateCursor(this.cursorRow,e)}else if(t=="LEFT"){const e=f.CLAMP(this.cursorCol-1,0,this.tilemap.getColumns()-1);this.locateCursor(this.cursorRow,e)}else if(t=="UP"){const e=f.CLAMP(this.cursorRow-1,0,this.tilemap.getRows()-1);this.locateCursor(e,this.cursorCol)}else if(t=="DOWN"){const e=f.CLAMP(this.cursorRow+1,0,this.tilemap.getRows()-1);this.locateCursor(e,this.cursorCol)}else t=="OK"&&this.movePlayer(this.cursorRow,this.cursorCol)}}let Ht={BLACK:"BLACK",WHITE:"WHITE"},He={PAWN:"PAWN",QUEEN:"QUEEN"},lr={DARK:"DARK",LIGHT:"LIGHT",WATER:"WATER",FIRE:"FIRE"},gs={DOUBLE_MOVE:"DOUBLE_MOVE",KILL:"KILL"};class ie{constructor(t={}){this.path=t.path??[[1,0]],this.numCapture=t.numCapture??0,this.mustCapture=t.mustCapture??!0,this.chainable=t.chainable??!0,this.collateCapturable=t.collateCapturable??!1}getPath(){return this.path}hasVector(t){return this.path.find(e=>t[0]==e[0]&&t[1]==e[1])}getVector(t){return this.path[t]}getPathLength(){return this.path.length}getNumCapture(){return this.numCapture}isForceCapture(){return this.mustCapture}isChainable(){return this.chainable}isCollateCapturable(){return this.collateCapturable}}let Mh=[[1,1]],Ph=[[-1,1]],Rh=[[1,-1]],Oh=[[-1,-1]],Dh=[[1,1],[2,2]],Lh=[[-1,1],[-2,2]],Nh=[[1,-1],[2,-2]],Fh=[[-1,-1],[-2,-2]],Vr=[[1,1],[2,2],[3,3],[4,4],[5,5],[6,6],[7,7],[8,8],[9,9]],Hr=[[-1,1],[-2,2],[-3,3],[-4,4],[-5,5],[-6,6],[-7,7],[-8,8],[-9,9]],jr=[[1,-1],[2,-2],[3,-3],[4,-4],[5,-5],[6,-6],[7,-7],[8,-8],[9,-9]],kr=[[-1,-1],[-2,-2],[-3,-3],[-4,-4],[-5,-5],[-6,-6],[-7,-7],[-8,-8],[-9,-9]];class Ti{constructor(t={}){this.color=t.color??Ht.BLACK,this.type=t.type??He.PAWN,this.element=t.element??lr.WATER,this.powerupId=t.powerupId??"",this.moves=t.moves??[]}clone(){return new Ti({color:this.color,type:this.type,element:this.element,powerupId:this.powerupId,moves:this.moves})}getColor(){return this.color}setColor(t){this.color=t}getType(){return this.type}setType(t){this.type=t}getElement(){return this.element}setElement(t){this.element=t}getPowerupId(){return this.powerupId}setPowerupId(t){this.powerupId=t}getMoves(){return this.moves}}class Wr extends Ti{constructor(t){super({color:t,type:He.PAWN,element:lr.DARK,powerupId:gs.KILL,moves:[new ie({path:t==Ht.BLACK?Mh:Rh,numCapture:0,mustCapture:!1,chainable:!1}),new ie({path:t==Ht.BLACK?Ph:Oh,numCapture:0,mustCapture:!1,chainable:!1}),new ie({path:Dh,numCapture:1,mustCapture:!0,chainable:!0}),new ie({path:Lh,numCapture:1,mustCapture:!0,chainable:!0}),new ie({path:Nh,numCapture:1,mustCapture:!0,chainable:!0}),new ie({path:Fh,numCapture:1,mustCapture:!0,chainable:!0})]})}}class Uh extends Ti{constructor(t){super({color:t,type:He.QUEEN,element:lr.DARK,powerupId:gs.DOUBLE_MOVE,moves:[new ie({path:Vr,numCapture:0,mustCapture:!1,chainable:!1}),new ie({path:Hr,numCapture:0,mustCapture:!1,chainable:!1}),new ie({path:jr,numCapture:0,mustCapture:!1,chainable:!1}),new ie({path:kr,numCapture:0,mustCapture:!1,chainable:!1}),new ie({path:Vr,numCapture:1,mustCapture:!0,chainable:!0}),new ie({path:Hr,numCapture:1,mustCapture:!0,chainable:!0}),new ie({path:jr,numCapture:1,mustCapture:!0,chainable:!0}),new ie({path:kr,numCapture:1,mustCapture:!0,chainable:!0})]})}}class Rs{constructor(t=null,e=null){this.piece=t,this.element=e}clone(){let t=this.piece?this.piece.clone():null;return new Rs(t,this.element)}getPiece(){return this.piece}setPiece(t){this.piece=t}getElement(){return this.element}setElement(t){this.element=t}}class Kn{constructor(){this.coord=[],this.parent=null,this.children=[]}}class cr{constructor(){this.rows=10,this.cols=10,this.tiles=[],this.mustCapture=!0;for(let t=0;t<this.rows;t++){this.tiles[t]=[];for(let e=0;e<this.cols;e++)t<4&&(e+t)%2?this.tiles[t][e]=new Rs(new Wr(Ht.BLACK)):t>5&&(e+t)%2?this.tiles[t][e]=new Rs(new Wr(Ht.WHITE)):this.tiles[t][e]=new Rs}}clone(){let t=new cr;t.rows=this.rows,t.cols=this.cols;for(let e=0;e<this.rows;e++){t.tiles[e]=[];for(let s=0;s<this.cols;s++)t.tiles[e][s]=this.tiles[e][s].clone()}return t.mustCapture=this.mustCapture,t}getRows(){return this.rows}getCols(){return this.cols}getTile(t){return this.tiles[t[1]][t[0]]}getPiece(t){return this.tiles[t[1]][t[0]].getPiece()}isValidCoord(t){return t[0]<this.cols&&t[0]>=0&&t[1]<this.rows&&t[1]>=0}getNumPieces(t=null,e=null){let s=0;for(let i=0;i<this.rows;i++)for(let r=0;r<this.cols;r++){let n=this.tiles[i][r].getPiece();n&&(t==null||t==n.getColor())&&(e==null||e==n.getType())&&s++}return s}getWinner(){let t=this.getNumPieces(Ht.BLACK),e=this.getNumPieces(Ht.WHITE);return t!=0&&e!=0?null:t==0?Ht.WHITE:Ht.BLACK}getPaths(t){let e=[],s=[],i=new Kn;i.coord=[t[0],t[1]],$n(this,i,t,e);for(let r of e){let n=[],o=r;for(;o;)n.unshift(o.coord),o=o.parent;s.push(n)}return s}findPossiblePoints(t,e=!1){let s=[],i=this.tiles[t[1]][t[0]].getPiece();if(!i)return[];for(let n of i.getMoves()){if(e&&!n.isChainable())continue;let o=0,a=null;for(let l of n.getPath()){let c=t[0]+l[0],u=t[1]+l[1];if(!this.isValidCoord([c,u]))break;let p=this.tiles[u][c].getPiece(),d=this.tiles[u][c].getElement(),E=d&&d!=i.getElement(),m=p&&p.getColor()!=i.getColor()&&a&&a.getColor()!=i.getColor()&&!n.isCollateCapturable(),y=p&&p.getColor()==i.getColor();if(E||m||y)break;p&&p.getColor()!=i.getColor()&&o++,!p&&n.getNumCapture()==o&&s.push({x:c,y:u,mustCapture:n.isForceCapture()}),a=p}}let r=!!s.find(n=>n.mustCapture);return s.filter(n=>r==n.mustCapture)}findMovables(t){let e=[],s=[];for(let i=0;i<this.rows;i++)for(let r=0;r<this.cols;r++){let n=this.tiles[i][r].getPiece();if(!n||n.getColor()!=t)continue;let o=this.findPossiblePoints([r,i]);o.length!=0&&(o.find(a=>a.mustCapture)?e.push([r,i]):s.push([r,i]))}return this.mustCapture&&e.length>0?e:[...s,...e]}move(t,e){let s=0,i=this.getTile(t),r=this.getTile(e),n=i.getPiece(),o=n.getMoves();i.setPiece(null),r.setPiece(n);let a=o.find(l=>l.hasVector(f.VEC2_SUBSTRACT(e,t)));for(let l of a.getPath()){let c=f.VEC2_ADD(t,l);if(f.VEC2_ISEQUAL(c,e))break;let u=this.getTile(c),p=u.getPiece();p&&p.getColor()!=n.getColor()&&(s++,u.setPiece(null))}return s}}function $n(h,t,e,s,i=!1){let r=h.findPossiblePoints(e,i);if(r.length==0)return s.push(t);for(let n of r){let o=h.clone(),a=o.move(e,[n.x,n.y]),l=new Kn;l.coord=[n.x,n.y],l.parent=t,t.children.push(l),a==0?s.push(l):$n(o,l,[n.x,n.y],s,!0)}return t}class Jn{constructor(t,e=""){this.game=t,this.id=e}getId(){return this.id}async onActive(){}}class Bh extends Jn{constructor(t){super(t,gs.DOUBLE_MOVE),this.board=this.game.getBoard()}async onActive(){let t=await this.game.operationRequestTileLocation(!0,(i,r)=>{let n=this.board.getPiece([i,r]);return n&&n.getColor()==this.game.getCurrentPlayer()}),e=this.board.findPossiblePoints([t.x,t.y]),s=await this.game.operationRequestTileLocation(!1,(i,r)=>e.find(n=>n.x==i&&n.y==r));await this.game.operationMove([t.x,t.y],[s.x,s.y]),this.game.operationRequestTileAction()}}class Vh extends Jn{constructor(t){super(t,gs.KILL),this.board=this.game.getBoard()}async onActive(){let t=await this.game.operationRequestTileLocation(!0,(e,s)=>{let i=this.board.getPiece([e,s]);return i&&i.getColor()!=this.game.getCurrentPlayer()});await this.game.operationKill([t.x,t.y]),this.game.operationNewTurn()}}class Hh{static create(t,e){if(e==gs.DOUBLE_MOVE)return new Bh(t);if(e==gs.KILL)return new Vh(t)}}class Qn{visited;data;value;constructor(){this.visited=!1,this.data={},this.value=-1/0}setVisited(t){this.visited=t}isVisited(){return this.visited}setData(t){this.data=t}getData(){return this.data}setValue(t){this.value=t}getValue(){return this.value}}class Wi extends Qn{constructor(t){super(),this.value=t}}class Gr extends Qn{children;constructor(t=[]){super(),this.children=t}addChild(t){this.children.push(t)}getChildren(){return this.children}}class jh{solve(t){this.#t(t,!0);let s=t.getChildren()[0];for(let i of t.getChildren())i.getValue()>s.getValue()&&(s=i);return s}#t(t,e,s=-1/0,i=1/0){if(t instanceof Wi)return t;t.setValue(e?-1/0:1/0);for(let r of t.children){const o=this.#t(r,!e,s,i).getValue();if(e){if(o>t.getValue()&&t.setValue(o),o>=i)break;o>s&&(s=o)}else{if(o<t.getValue()&&t.setValue(o),o<=s)break;o<i&&(i=o)}}return t}}class to{constructor(){this.color=Ht.WHITE}setColor(t){this.color=t}getColor(){return this.color}}class eo extends to{constructor(){super()}async play(t){return t.operationRequestTileAction()}}class so extends to{constructor(){super(),this.solver=new jh,this.maxDepth=3}play(t){let e=t.getBoard(),s=new Gr;this.generateMinMaxTree(s,e,this.maxDepth,this.color);let r=this.solver.solve(s).data.path;for(let n=0;n<r.length-1;n++)e.move(r[n],r[n+1]);t.operationNewTurn()}evaluate(t){let e=t.getWinner();if(!e){let s=t.getNumPieces(this.color,He.PAWN),i=t.getNumPieces(this.color,He.QUEEN),r=this.color==Ht.BLACK?Ht.WHITE:Ht.BLACK,n=t.getNumPieces(r,He.PAWN),o=t.getNumPieces(r,He.QUEEN);return s+i*3-(n+o*3)}return e==this.color?1e3-t.getNumPieces():-1e3+t.getNumPieces()}generateMinMaxTree(t,e,s,i){if(s==0){let r=new Wi(this.evaluate(e));return t.addChild(r)}if(e.getWinner()){let r=new Wi(this.evaluate(e));return t.addChild(r)}for(let r of e.findMovables(i))for(let n of e.getPaths(r)){let o=e.clone();for(let c=0;c<n.length-1;c++)o.move(n[c],n[c+1]);let a=new Gr;a.setData({path:n}),t.addChild(a);let l=i==Ht.WHITE?Ht.BLACK:Ht.WHITE;this.generateMinMaxTree(a,o,s-1,l)}return t}}class kh{constructor(t,e){this.board=new cr,this.players=[t,e],this.currentPlayer=t,t.setColor(Ht.WHITE),e.setColor(Ht.BLACK)}getBoard(){return this.board}getCurrentPlayer(){return this.currentPlayer}startup(){this.operationNewTurn(this.currentPlayer)}async operationNewTurn(t){if(this.board.getWinner()){v.emit(this,"E_END");return}let e=this.currentPlayer.getColor()==Ht.BLACK?this.board.getRows()-1:0;for(let s=0;s<this.board.getCols();s++){let i=this.board.getTile([s,e]),r=i.getPiece();r&&r.getColor()==this.currentPlayer.getColor()&&r.getType()==He.PAWN&&i.setPiece(new Uh(r.getColor()))}t?this.currentPlayer=t:this.currentPlayer=this.currentPlayer==this.players[0]?this.players[1]:this.players[0],this.currentPlayer instanceof eo?await this.currentPlayer.play(this):this.currentPlayer instanceof so&&this.currentPlayer.play(this)}async operationRequestTileAction(){let t={};return t.x=0,t.y=0,t.action="",await v.emitAsync(this,"E_REQUEST_TILE_ACTION",{response:t}),t}async operationRequestTileLocation(t=!1,e=()=>!0){let s={};return s.x=0,s.y=0,s.canceled=!1,await v.emitAsync(this,"E_REQUEST_TILE_LOCATION",{required:t,predicateTile:e,response:s}),s}operationKill(t){this.board.getTile(t).setPiece(null)}async operationPowerup(t){let e=this.board.getPiece(t);await Hh.create(this,e.getPowerupId()).onActive(),e.setPowerupId("")}async operationMove(t,e){if(this.board.move(t,e)==0)return;let i=this.board.findPossiblePoints(e,!0);if(i.length>0){let r=await this.operationRequestTileLocation(!0,(n,o)=>i.find(a=>a.x==n&&a.y==o));await this.operationMove(e,[r.x,r.y]);return}}}let io=class{constructor(t,e){this.game=t,this.coordFrom=e}async exec(){return!0}isConditionCheck(){return!0}};class Wh extends io{constructor(t,e){super(t,e),this.board=this.game.getBoard()}async exec(){let t=this.board.findPossiblePoints(this.coordFrom),e=await this.game.operationRequestTileLocation(!1,(s,i)=>t.find(r=>r.x==s&&r.y==i));if(e.canceled)return await this.game.operationRequestTileAction(),!1;await this.game.operationMove(this.coordFrom,[e.x,e.y]),this.game.operationNewTurn()}isConditionCheck(){let t=this.game.getCurrentPlayer();return this.board.findMovables(t.getColor()).find(s=>s[0]==this.coordFrom[0]&&s[1]==this.coordFrom[1])}}class Gh extends io{constructor(t,e){super(t,e),this.board=this.game.getBoard()}async exec(){await this.game.operationPowerup(this.coordFrom)}isConditionCheck(){let t=this.board.getPiece(this.coordFrom),e=this.game.getCurrentPlayer();return!(!t||t.getColor()!=e.getColor()||!t.getPowerupId())}}class Pi{static create(t,e,s){if(t=="MOVE")return new Wh(e,s);if(t=="POWERUP")return new Gh(e,s)}}let zh={BLACK_PAWN:"./templates/checker/black_pawn.png",BLACK_QUEEN:"./templates/checker/black_queen.png",WHITE_PAWN:"./templates/checker/white_pawn.png",WHITE_QUEEN:"./templates/checker/white_queen.png"};class qh extends xt{constructor(){super({className:"UIPiece",template:`
      <div class="UIPiece-bg js-bg"></div>`}),this.piece=null}update(){this.piece?this.node.querySelector(".js-bg").style.backgroundImage=`url(${zh[this.piece.getColor()+"_"+this.piece.getType()]})`:this.node.querySelector(".js-bg").style.backgroundImage=""}setPiece(t){this.piece=t||null}}let Xh={DARK:"./assets/textures/tile_dark.png",LIGHT:"./assets/textures/tile_light.png",FIRE:"./assets/textures/tile_fire.png",WATER:"./assets/textures/tile_water.png"};class Yh extends xt{constructor(t={}){super({className:"UITile",template:`
      <div class="UITile-bg js-bg"></div>
      <div class="UITile-piece js-piece"></div>
      <div class="UITile-actions js-actions"></div>`}),this.tile=null,this.selectable=!1,this.uiPiece=new qh,this.node.classList.add(t.color=="white"?"UITile--white":"UITile--black"),this.node.querySelector(".js-piece").replaceWith(this.uiPiece.node),this.node.addEventListener("click",e=>{e.stopPropagation(),this.handleClicked()})}update(t){this.tile?(this.node.querySelector(".js-bg").style.backgroundImage=`url(${Xh[this.tile.getElement()]??""})`,this.uiPiece.setPiece(this.tile.getPiece())):this.node.querySelector(".js-bg").style.backgroundImage="",this.uiPiece.update(t)}delete(){this.uiPiece.delete(),super.delete()}setTile(t){this.tile=t||null}isSelectable(){return this.selectable}setSelectable(t){this.node.classList.toggle("u-selectable",t),this.selectable=t}addAction(t){let e=document.createElement("div");e.className="UITile-actions-item",e.textContent=t,e.id=t,this.node.querySelector(".js-actions").appendChild(e),e.addEventListener("click",s=>{s.stopPropagation(),this.handleActionClicked(t)})}clearActions(){let t=this.node.querySelector(".js-actions");for(;t.firstChild;)t.removeChild(t.firstChild)}handleClicked(){v.emit(this,"E_CLICKED")}handleActionClicked(t){v.emit(this,"E_ACTION",{action:t})}}let Zh=class extends xt{constructor(){super({className:"UICheckerBoard"}),this.board=null,this.uiTiles=[]}update(t){for(let e of this.uiTiles)e.update(t)}delete(){for(let t of this.uiTiles)v.unsubscribe(t,"E_CLICKED",this),v.unsubscribe(t,"E_ACTION",this),t.delete();super.delete()}setBoard(t){for(let e of this.uiTiles)v.unsubscribe(e,"E_CLICKED",this),v.unsubscribe(e,"E_ACTION",this),e.delete();if(this.uiTiles=[],t){for(let e=0;e<t.getRows();e++)for(let s=0;s<t.getCols();s++){let i=new Yh({color:(s+e)%2==0?"white":"black"});v.subscribe(i,"E_CLICKED",this,r=>this.handleTileClicked(s,e)),v.subscribe(i,"E_ACTION",this,r=>this.handleTileAction(s,e,r.action)),i.setTile(t.getTile([s,e])),this.node.appendChild(i.node),this.uiTiles.push(i)}this.board=t}else this.board=null}getUITiles(){return this.uiTiles}getUITile(t){return this.uiTiles[t[0]+t[1]*this.board.getCols()]}clearActions(){for(let t of this.uiTiles)t.setSelectable(!1),t.clearActions()}clearSelectable(){for(let t of this.uiTiles)t.setSelectable(!1)}handleTileClicked(t,e){v.emit(this,"E_TILE_CLICKED",{coord:[t,e]})}handleTileAction(t,e,s){v.emit(this,"E_TILE_ACTION",{coord:[t,e],action:s})}onKeyDownOnce(t){t.key==GWE.InputKeyEnum.CANCEL&&v.emit(this,"E_ECHAP_PRESSED")}};class Kh extends yt{constructor(){super(),this.human=null,this.ia=null,this.game=null,this.board=null,this.uiTitle=null,this.uiBoard=null}update(){let t=this.game.getCurrentPlayer();this.uiTitle.textContent=`AU TOUR DES ${t.getColor()==Ht.BLACK?"NOIRS":"BLANCS"} DE JOUER`}async onEnter(){this.human=new eo,this.ai=new so,this.game=new kh(this.human,this.ai),this.board=this.game.getBoard(),this.uiTitle=document.createElement("div"),P.addNode(this.uiTitle,"position:absolute; top:10%; left:50%; transform:translateX(-50%)"),this.uiBoard=new Zh,this.uiBoard.setBoard(this.board),P.addWidget(this.uiBoard,"position:absolute; inset:0px; top:50%; left:50%; width:400px; height:400px; transform:translate(-50%, -50%)"),P.focus(this.uiBoard),v.subscribe(this.game,"E_REQUEST_TILE_ACTION",this,this.handleGameRequestTileAction),v.subscribe(this.game,"E_REQUEST_TILE_LOCATION",this,this.handleGameRequestTileLocation),this.game.startup()}handleGameRequestTileAction(t){return new Promise(e=>{v.subscribe(this.uiBoard,"E_TILE_CLICKED",this,s=>{this.uiBoard.clearActions();let i=this.uiBoard.getUITile(s.coord);Pi.create("MOVE",this.game,s.coord).isConditionCheck()&&i.addAction("MOVE"),Pi.create("POWERUP",this.game,s.coord).isConditionCheck()&&i.addAction("POWERUP")}),v.subscribe(this.uiBoard,"E_TILE_ACTION",this,async s=>{v.unsubscribe(this.uiBoard,"E_TILE_CLICKED",this),v.unsubscribe(this.uiBoard,"E_TILE_ACTION",this),this.uiBoard.getUITile(s.coord).clearActions(),Pi.create(s.action,this.game,s.coord).exec().then(()=>e())})})}handleGameRequestTileLocation({required:t,predicateTile:e,response:s}){return new Promise(i=>{for(let r=0;r<this.board.getRows();r++)for(let n=0;n<this.board.getCols();n++)e(n,r)&&this.uiBoard.getUITile([n,r]).setSelectable(!0);t||v.subscribe(this.uiBoard,"E_ECHAP_PRESSED",this,()=>{v.unsubscribe(this.uiBoard,"E_ECHAP_PRESSED",this),v.unsubscribe(this.uiBoard,"E_TILE_CLICKED",this),this.uiBoard.clearSelectable(),s.canceled=!0,i()}),v.subscribe(this.uiBoard,"E_TILE_CLICKED",this,r=>{this.uiBoard.getUITile(r.coord).isSelectable()&&(v.unsubscribe(this.uiBoard,"E_ECHAP_PRESSED",this),v.unsubscribe(this.uiBoard,"E_TILE_CLICKED",this),this.uiBoard.clearSelectable(),s.canceled=!1,s.x=r.coord[0],s.y=r.coord[1],i())})})}}class $h{count;entities;entitiesSet;systems;constructor(){this.count=0,this.entities=new Map,this.entitiesSet=new Map,this.systems=[],v.subscribe(Q,"E_ACTION",this,t=>{for(let e of this.systems)e.action(t.actionId)}),v.subscribe(Q,"E_ACTION_ONCE",this,t=>{for(let e of this.systems)e.actionOnce(t.actionId)})}update(t){for(const e of this.systems)e.update(t)}draw(){for(const t of this.systems)t.draw()}setup(t){this.count=0,this.entities.clear(),this.entitiesSet.clear(),this.systems=t}reset(){this.count=0,this.entities.clear(),this.entitiesSet.clear(),this.systems=[]}createEntity(){return this.entities.set(this.count,new Map),this.entitiesSet.set(this.count,new Set),this.count++}createEntityWith(t){this.entities.set(this.count,new Map),this.entitiesSet.set(this.count,new Set);for(const e of t)this.addComponent(this.count,e);return this.count++}removeEntity(t){if(!this.entities.get(t))throw new Error("DNAManager::removeEntity(): Entity not found");this.entities.delete(t),this.entitiesSet.delete(t);for(const s of this.systems)s.hasEntity(t)&&s.unbindEntity(t)}hasEntity(t){return this.entities.has(t)}query(t){const e=Array();for(let[s,i]of this.entitiesSet){let r=!0;for(const n of t)if(!i.has(n)){r=!1;break}r&&e.push(s)}return e}findEntities(t){const e=Array();for(let[s,i]of this.entitiesSet)i.has(t.name)&&e.push(s);return e}findEntity(t){for(let[e,s]of this.entitiesSet)if(s.has(t.name))return e;return-1}addComponent(t,e){const s=this.entities.get(t),i=this.entitiesSet.get(t);if(!s||!i)throw new Error("DNAManager::addComponent(): Entity not found");if(s.has(e.constructor.name))throw new Error("DNAManager::addComponent(): Entity already has "+e.constructor.name);s.set(e.constructor.name,e),i.add(e.constructor.name);for(const n of this.systems)n.isMatchingComponentRequirements(s.values())&&!n.hasEntity(t)&&n.bindEntity(t)}removeComponent(t,e){const s=this.entities.get(t),i=this.entitiesSet.get(t);if(!s||!i)throw new Error("DNAManager::removeComponent(): Entity not found");if(!s.has(e.name))throw new Error("DNAManager::removeComponent(): Entity has not "+e.name);s.delete(e.name),i.delete(e.name);for(const n of this.systems)!n.isMatchingComponentRequirements(s.values())&&n.hasEntity(t)&&n.unbindEntity(t)}getComponent(t,e){const s=this.entities.get(t);if(!s)throw new Error("DNAManager::getComponent(): Entity not found");const i=s.get(e.name);if(!i)throw new Error("DNAManager::getComponent(): Entity has not "+e.name);return i}getComponents(t){const e=this.entities.get(t);if(!e)throw new Error("DNAManager::getEntity(): Entity not found");return e.values()}getAllComponents(t){const e=new Map;for(const[s,i]of this.entities.entries()){const r=i.get(t.name);r&&e.set(s,r)}return e}hasComponent(t,e){const s=this.entitiesSet.get(t);if(!s)throw new Error("DNAManager::hasComponent(): Entity not found");return s.has(e.name)}getSystems(){return this.systems}findSystems(t){return this.systems.filter(e=>e.hasTag(t))}replaceComponent(t,e,s){this.removeComponentIfExist(t,e),this.addComponent(t,s)}removeComponentIfExist(t,e){return this.hasComponent(t,e)?(this.removeComponent(t,e),!0):!1}}const x=new $h;class mt{eids;requiredComponentTypenames;paused;tags;constructor(t=[]){this.eids=new Array,this.requiredComponentTypenames=new Set,this.paused=!1,this.tags=t}update(t){if(!this.paused){this.onBeforeUpdate(t);for(const e of this.eids)this.onEntityUpdate(t,e);this.onAfterUpdate(t)}}draw(){this.onBeforeDraw();for(const t of this.eids)this.onEntityDraw(t);this.onAfterDraw()}action(t){for(const e of this.eids)this.onAction(t,e)}actionOnce(t){for(const e of this.eids)this.onActionOnce(t,e)}bindEntity(t){if(this.eids.indexOf(t)!=-1)throw new Error("DNASystem::bindEntity(): Entity already exist in this system");this.eids.push(t),this.onEntityBind(t)}unbindEntity(t){if(this.eids.indexOf(t)==-1)throw new Error("DNASystem::unbindEntity(): Entity not exist in this system");this.eids.splice(this.eids.indexOf(t),1),this.onEntityUnbind(t)}hasEntity(t){return this.eids.indexOf(t)!=-1}addRequiredComponentTypename(t){if(this.requiredComponentTypenames.has(t))throw new Error("DNASystem::addRequiredComponentTypename(): Required typename already set in this system");this.requiredComponentTypenames.add(t)}isMatchingComponentRequirements(t){let e=this.requiredComponentTypenames.size,s=0;for(const i of t)this.requiredComponentTypenames.has(i.getTypename())&&s++;return s==e}pause(){this.paused=!0}resume(){this.paused=!1}getTags(){return this.tags}hasTag(t){return this.tags.indexOf(t)!=-1}onAction(t,e){}onActionOnce(t,e){}onBeforeUpdate(t){}onEntityUpdate(t,e){}onAfterUpdate(t){}onBeforeDraw(){}onEntityDraw(t){}onAfterDraw(){}onEntityBind(t){}onEntityUnbind(t){}}class dt{typename;constructor(t){this.typename=t}getTypename(){return this.typename}}class jt extends dt{constructor(t,e){super("Position"),this.x=t,this.y=e}}class Ce extends dt{constructor(t,e){super("Collider"),this.width=t,this.height=e,this.min=[-t/2,-e/2],this.max=[+t/2,+e/2]}getBounds(t,e){return{left:t+this.min[0],right:t+this.max[0],bottom:e+this.max[1],top:e+this.min[1]}}static isCollide(t,e,s,i){const r=e.getBounds(t.x,t.y),n=i.getBounds(s.x,s.y);return f.COLLIDE_RECT_TO_RECT([r.left,r.top],[r.right,r.bottom],[n.left,n.top],[n.right,n.bottom])}}class De extends dt{constructor(t,e,s){super("Fighter"),this.id=t,this.health=e,this.dmgSprite=s}}class Jh extends mt{constructor(){super(),super.addRequiredComponentTypename("Fighter"),super.addRequiredComponentTypename("Position"),super.addRequiredComponentTypename("Velocity"),super.addRequiredComponentTypename("Collider")}onEntityDraw(t){const e=x.getComponent(t,jt),s=x.getComponent(t,Ce),i=s.getBounds(e.x,e.y),r=nt.getContext();r.globalAlpha=.2,r.fillStyle="#000",r.fillRect(i.left,i.top,s.width,s.height),r.globalAlpha=1}}let Qh=class extends dt{constructor(){super("Camera")}},tl=class extends mt{constructor(t,e){super(),this.bgWidth=t,this.bgHeight=e,super.addRequiredComponentTypename("Camera")}onEntityUpdate(t,e){const s=x.findEntities(De);let i=1/0,r=1/0,n=0,o=0;for(let C of s){const w=x.getComponent(C,jt);i>w.x&&(i=w.x),n<w.x&&(n=w.x),r>w.y&&(r=w.y),o<w.y&&(o=w.y)}const a=n-i+88*2,l=o-r+88*2,c=nt.getWidth()*.5,u=nt.getHeight()*.5,p=f.CLAMP(nt.getWidth()/a,1,1.3),d=f.CLAMP(nt.getHeight()/l,1,1.3),E=Math.min(p,d);let m=i+(n-i)/2,y=r+(o-r)/2;m<c/E?m=c/E:m>this.bgWidth-c/E&&(m=this.bgWidth-c/E),y<u/E?y=u/E:y>this.bgHeight-u/E&&(y=this.bgHeight-u/E),nt.setCameraScale(E,E),nt.setCameraPosition(m,y)}};class Wt extends dt{constructor(t=0,e=0){super("Velocity"),this.x=t,this.y=e}}class Gt extends dt{constructor(t={jas:null,jss:null,zIndex:0}){super("Drawable"),this.jas=t.jas,this.jss=t.jss,this.zIndex=t.zIndex,this.lastAnimationFrameIndex=-1}}let el=class extends mt{constructor(){super(),super.addRequiredComponentTypename("Position"),super.addRequiredComponentTypename("Drawable"),this.onlySpecialAttack=!1}onEntityUpdate(t,e){const s=x.getComponent(e,jt),i=x.getComponent(e,Gt),r=i.jss??i.jas;if(x.hasComponent(e,Wt)){const n=x.getComponent(e,Wt);n.x>.01&&r.setFlipX(!1),n.x<-.01&&r.setFlipX(!0)}r.setPosition(s.x,s.y),r.update(t)}onEntityDraw(t){const e=x.getComponent(t,Gt);(e.jss??e.jas).draw()}};class ro extends dt{constructor(t,e,s){super("Platform"),this.elevation=t,this.w=e,this.h=s}}async function sl(h){const t=x.createEntity(),e=new ne;e.setTexture(await It.loadTexture("templates/fight/backgrounds/"+h+"/layer.png")),e.setTextureRect(0,0,800,600),x.addComponent(t,new Gt({jss:e,zIndex:0})),x.addComponent(t,new jt(0,0));const s=x.createEntity();x.addComponent(s,new Qh);const i=new Zt;await i.loadFromFile("templates/fight/backgrounds/"+h+"/floating-rock.jas"),i.setTexture(await It.loadTexture("templates/fight/backgrounds/"+h+"/floating-rock.png")),i.setOffset(52,18),i.play("DEFAULT",!1,!0);const r=x.createEntity();x.addComponent(r,new jt(220,400)),x.addComponent(r,new ro(395)),x.addComponent(r,new Ce(104,37)),x.addComponent(r,new Gt({jas:i,zIndex:1}))}const il=160;class Ns extends dt{constructor(){super("Move"),this.onFloor=!0}}class rl extends mt{constructor(t,e,s=540){super(),super.addRequiredComponentTypename("Move"),super.addRequiredComponentTypename("Position"),super.addRequiredComponentTypename("Velocity"),super.addRequiredComponentTypename("Fighter"),super.addRequiredComponentTypename("Drawable"),super.addRequiredComponentTypename("Collider"),this.bgWidth=t,this.bgHeight=e,this.floorElevation=s}onEntityUpdate(t,e){const s=x.getComponent(e,Ns),i=x.getComponent(e,jt),r=x.getComponent(e,Wt),n=x.getComponent(e,Gt),o=x.getComponent(e,Ce),a=o.width*.5,l=o.height*.5;r.y=f.LERP(r.y,il,t/1e3),i.x+=r.x*(t/100),i.y+=r.y*(t/100),s.onFloor=!1;const c=o.getBounds(i.x,i.y);for(const u of x.findEntities(ro)){const p=x.getComponent(u,jt),E=x.getComponent(u,Ce).getBounds(p.x,p.y),m=i.y<E.top,y=i.x>=E.left&&i.x<=E.right,C=E.top<c.bottom&&c.bottom<E.bottom;if(r.y>0&&m&&y&&C){i.y=E.top-l,r.y=0,s.onFloor=!0;break}}r.y>=0&&c.bottom>=this.floorElevation&&(i.y=this.floorElevation-l,r.y=0,s.onFloor=!0),r.y>0&&n.jas.play("FALLOF",!1,!0),c.left<0?i.x=a:c.right>this.bgWidth&&(i.x=this.bgWidth-a)}}class nl extends dt{constructor(){super("JumpControls")}}class ve extends dt{constructor(t=-100,e=10,s=1){super("Jump"),this.doubleJumpGapTime=e,this.numJump=s,this.accelerationY=t,this.createdAt=Date.now()}}class ol extends mt{constructor(){super(),super.addRequiredComponentTypename("JumpControls"),super.addRequiredComponentTypename("Jump"),super.addRequiredComponentTypename("Velocity")}onEntityUpdate(t,e){const s=x.getComponent(e,Wt);Q.isActiveAction("LEFT")?s.direction=-1:Q.isActiveAction("RIGHT")&&(s.direction=1)}onActionOnce(t,e){const s=x.getComponent(e,ve),i=x.getComponent(e,Wt),r=Date.now()-s.createdAt;t=="UP"&&r>s.doubleJumpGapTime&&i.y<0&&s.numJump<=1&&(i.y=0,x.removeComponent(e,ve),x.addComponent(e,new ve(-90,3,2)))}}class al extends mt{constructor(){super(),super.addRequiredComponentTypename("Jump"),super.addRequiredComponentTypename("Velocity"),super.addRequiredComponentTypename("Drawable"),super.addRequiredComponentTypename("Move")}onEntityBind(t){const e=x.getComponent(t,ve),s=x.getComponent(t,Wt),i=x.getComponent(t,Gt),r=x.getComponent(t,Ns);r.onFloor=!1,s.y+=e.accelerationY,i.jas.play("JUMP",!1,!0)}onEntityUpdate(t,e){const s=x.getComponent(e,Wt),i=x.getComponent(e,Gt),r=x.getComponent(e,Ns);s.y>0&&i.jas.play("FALLOF",!1,!0),r.onFloor&&(x.removeComponent(e,ve),x.addComponent(e,new Bt))}}class hl extends dt{constructor(){super("RunControls")}}class Xt extends dt{constructor(t=20){super("Run"),this.speed=t}}class ll extends mt{constructor(){super(),super.addRequiredComponentTypename("RunControls"),super.addRequiredComponentTypename("Run"),super.addRequiredComponentTypename("Velocity")}onEntityUpdate(t,e){const s=x.getComponent(e,Wt),i=Q.isActiveAction("LEFT"),r=Q.isActiveAction("RIGHT"),n=Q.isJustActiveAction("UP");i?s.direction=-1:r&&(s.direction=1),n&&(x.removeComponent(e,Xt),x.addComponent(e,new ve)),!i&&!r&&!n&&(x.removeComponent(e,Xt),x.addComponent(e,new Bt))}}class cl extends mt{constructor(){super(),super.addRequiredComponentTypename("Run"),super.addRequiredComponentTypename("Drawable"),super.addRequiredComponentTypename("Velocity")}onEntityBind(t){x.getComponent(t,Gt).jas.play("RUN",!0,!0)}onEntityUpdate(t,e){const s=x.getComponent(e,Xt),i=x.getComponent(e,Wt);x.getComponent(e,Gt).jas.play("RUN",!0,!0),i.x=s.speed*i.direction}}class ul extends dt{constructor(){super("IdleControls")}}class Bt extends dt{constructor(){super("Idle")}}class dl extends mt{constructor(){super(),super.addRequiredComponentTypename("IdleControls"),super.addRequiredComponentTypename("Idle")}onEntityUpdate(t,e){(Q.isActiveAction("LEFT")||Q.isActiveAction("RIGHT"))&&(x.removeComponent(e,Bt),x.addComponent(e,new Xt))}onActionOnce(t,e){t=="UP"&&(x.removeComponent(e,Bt),x.addComponent(e,new ve))}}class pl extends mt{constructor(){super(),super.addRequiredComponentTypename("Idle"),super.addRequiredComponentTypename("Velocity"),super.addRequiredComponentTypename("Drawable")}onEntityUpdate(t,e){const s=x.getComponent(e,Wt),i=x.getComponent(e,Gt);s.x=0,i.jas.play("IDLE",!0,!0)}}class fl extends dt{constructor(){super("DownControls")}}class cs extends dt{constructor(){super("Down")}}class ml extends mt{constructor(){super(),super.addRequiredComponentTypename("DownControls"),super.addRequiredComponentTypename("Down")}onActionOnce(t,e){t=="UP"&&(x.removeComponent(e,cs),x.addComponent(e,new Bt))}}class gl extends mt{constructor(){super(),super.addRequiredComponentTypename("Down"),super.addRequiredComponentTypename("Velocity"),super.addRequiredComponentTypename("Drawable")}onEntityBind(t){const e=x.getComponent(t,Wt),s=x.getComponent(t,Gt);x.removeComponentIfExist(t,Bt),x.removeComponentIfExist(t,Xt),x.removeComponentIfExist(t,ve),s.jas.play("PAIN_GROUND",!1,!0),e.x=0,e.y=0}}class je extends dt{constructor(t=null,e=1,s=1,i=null,r=[0,0]){super("Damage"),this.velocityImpact=t,this.damageHP=e,this.maxAge=s,this.spriteAnimation=i,this.spriteOffset=r,this.airDropped=!1,this.age=0}}class El extends mt{constructor(){super(),super.addRequiredComponentTypename("Damage"),super.addRequiredComponentTypename("Position"),super.addRequiredComponentTypename("Velocity"),super.addRequiredComponentTypename("Drawable"),this.paused=!1,this.frictionX=.5}onEntityBind(t){const e=x.getComponent(t,je),s=x.getComponent(t,De),i=x.getComponent(t,Wt);e.velocityImpact&&(i.x=e.velocityImpact[0],i.y=e.velocityImpact[1]),s.health-=e.damageHP,e.spriteAnimation&&(s.dmgSprite.setOffset(e.spriteOffset[0],e.spriteOffset[1]),s.dmgSprite.play(e.spriteAnimation,!0,!0))}async onEntityUpdate(t,e){if(this.paused)return;const s=x.getComponent(e,je),i=x.getComponent(e,Wt),r=x.getComponent(e,Gt);if(s.age>s.maxAge){x.removeComponent(e,je),s.airDropped?x.addComponent(e,new cs):x.addComponent(e,new Bt);return}i.y<0?(s.airDropped=!0,r.jas.play("PAIN_UP",!1,!0)):i.y>0&&(s.airDropped=!0,r.jas.play("PAIN_DOWN",!1,!0)),i.y==0&&s.airDropped?r.jas.play("PAIN_GROUND",!1,!0):i.y==0&&r.jas.play("PAIN",!1,!1),i.x>0&&(i.x=Math.max(i.x-this.frictionX,0)),i.x<0&&(i.x=Math.min(i.x+this.frictionX,0)),s.age+=t/1e3}onEntityDraw(t){const e=x.getComponent(t,je),s=x.getComponent(t,De),i=x.getComponent(t,jt);e.spriteAnimation&&(s.dmgSprite.setPosition(i.x,i.y),s.dmgSprite.draw())}}class Gi extends dt{constructor(t={}){super("Hit"),this.frameIndex=t.frameIndex,this.maxAge=t.maxAge,this.relativeX=t.relativeX,this.relativeY=t.relativeY,this.velocityTween=t.velocityTween??null,this.isCollide=t.isCollide??!0,this.damageHP=t.damageHP??1,this.damageMaxAge=t.damageMaxAge??1,this.damageSpriteAnimation=t.damageSpriteAnimation??null,this.damageSpriteOffset=t.damageSpriteOffset??[0,0],this.spriteAnimationOnLaunch=t.spriteAnimationOnLaunch??null,this.spriteAnimationOnImpact=t.spriteAnimationOnImpact??null,this.spriteOffsetX=t.spriteOffsetX??0,this.spriteOffsetY=t.spriteOffsetY??0,this.owner=t.owner??-1,this.direction=t.direction??0,this.velocityImpact=t.velocityImpact??null,this.marked=!1,this.age=0}}class Cl extends mt{constructor(){super(),super.addRequiredComponentTypename("Hit"),super.addRequiredComponentTypename("Position"),super.addRequiredComponentTypename("Drawable"),super.addRequiredComponentTypename("Collider")}onEntityBind(t){const e=x.getComponent(t,Gi),s=x.getComponent(t,jt);if(s.x+=e.relativeX*e.direction,s.y+=e.relativeY,e.spriteAnimationOnLaunch){const i=x.getComponent(t,Gt);i.jas.setVisible(!0),i.jas.setOffset(e.spriteOffsetX,e.spriteOffsetY),i.jas.play(e.spriteAnimationOnLaunch,!1,!1)}}async onEntityUpdate(t,e){const s=x.getComponent(e,Gi);if(s.marked)return;const i=x.getComponent(e,jt),r=x.getComponent(e,Gt),n=x.getComponent(e,Ce);if(s.isCollide){const a=x.findEntities(De).filter(l=>l!=s.owner);for(let l of a){const c=x.getComponent(l,jt),u=x.getComponent(l,Ce);if(Ce.isCollide(i,n,c,u)){s.marked=!0,x.removeComponentIfExist(l,je),x.removeComponentIfExist(l,Xt),x.removeComponentIfExist(l,Bt),x.removeComponentIfExist(l,ve),x.addComponent(l,new je([s.velocityImpact[0]*s.direction,s.velocityImpact[1]],s.damageHP,s.damageMaxAge,s.damageSpriteAnimation,s.damageSpriteOffset)),s.spriteAnimationOnImpact&&(r.jas.setVisible(!0),r.jas.setOffset(s.spriteOffsetX,s.spriteOffsetY),r.jas.play(s.spriteAnimationOnImpact,!1,!1),await v.wait(r.jas,"E_FINISHED"),r.jas.setVisible(!1)),x.removeEntity(e);return}}}if(s.age>s.maxAge){x.removeEntity(e);return}if(s.velocityTween){const o=s.velocityTween.interpolate(s.age);i.x+=o[0]*s.direction*(t/100),i.y+=o[1]*(t/100)}s.age+=t/1e3}onEntityDraw(t){const e=x.getComponent(t,jt),s=x.getComponent(t,Ce),i=s.getBounds(e.x,e.y),r=nt.getContext();r.fillStyle="red",r.fillRect(i.left,i.top,s.width,s.height)}}async function Tl(h,t,e,s,i,r){const n=x.createEntity();x.addComponent(n,new jt(t,e)),x.addComponent(n,new Gt({jas:s})),x.addComponent(n,new Ce(h.w,h.h)),x.addComponent(n,new Gi(Object.assign(h,{owner:i,direction:r})))}class ts extends dt{constructor(t,e,s=[]){super("CAS"),this.animations=t,this.texture=e,this.comboComponents=s,this.currentAction="",this.currentActionAge=0}}class us extends dt{constructor(t="",e=null,s="",i="",r=null,n=[]){super("Combo"),this.name=t,this.requiredComponent=e,this.actions=s,this.animationName=i,this.specialAttack=r,this.hits=n,this.currentAttack=null}}class yl extends mt{constructor(){super(),super.addRequiredComponentTypename("CAS")}onEntityUpdate(t,e){const s=x.getComponent(e,ts);if(!x.hasComponent(e,us)){s.currentActionAge>1e3&&(s.currentActionAge=0,s.currentAction="");for(const i of s.comboComponents){if(s.currentAction.indexOf(i.actions)==-1)continue;if(s.currentAction.endsWith(i.actions)&&x.hasComponent(e,i.requiredComponent)){x.removeComponentIfExist(e,Bt),x.removeComponentIfExist(e,Xt);const o=x.getComponent(e,Wt);o.x=0,s.currentActionAge=0,s.currentAction="",x.addComponent(e,i)}}s.currentActionAge+=t}}onActionOnce(t,e){const s=x.getComponent(e,ts);s.currentAction+=t,s.currentActionAge=0}}class Al extends mt{constructor(){super(),super.addRequiredComponentTypename("CAS"),super.addRequiredComponentTypename("Combo"),super.addRequiredComponentTypename("Drawable"),super.addRequiredComponentTypename("Position"),super.addRequiredComponentTypename("Move")}async onEntityBind(t){const e=x.getComponent(t,us),s=x.getComponent(t,Gt);e.specialAttack&&x.addComponent(t,e.specialAttack),s.jas.play(e.animationName,!1,!0),await v.wait(s.jas,"E_FINISHED"),x.removeComponent(t,us),x.addComponent(t,new Bt)}onEntityUpdate(t,e){const s=x.getComponent(e,ts),i=x.getComponent(e,us),r=x.getComponent(e,Gt),n=x.getComponent(e,jt),o=x.getComponent(e,Wt);if(r.jas.getCurrentAnimationFrameIndex()==r.lastAnimationFrameIndex)return;r.lastAnimationFrameIndex=r.jas.getCurrentAnimationFrameIndex();const a=i.hits.filter(l=>l.frameIndex==r.jas.getCurrentAnimationFrameIndex());if(a.length!=0)for(const l of a){const c=new Zt;c.setAnimations(s.animations),c.setTexture(s.texture),Tl(l,n.x,n.y,c,e,o.direction)}}}class St{times;values;fns;defaultFn;timeElapsed;looped;currentValue;constructor(t=[],e=[],s=f.LINEAR,i=[]){this.times=t,this.values=e,this.fns=i,this.defaultFn=s,this.timeElapsed=0,this.looped=!1,this.currentValue=this.values[0]}update(t){this.times.length!=0&&(this.looped&&this.timeElapsed>this.times[this.times.length-1]&&(this.timeElapsed=0),this.currentValue=this.interpolate(this.timeElapsed),this.timeElapsed+=t/1e3)}interpolate(t){let e=0,s=this.times.length;for(;e<s&&t>this.times[e];)e++;if(e==0)return this.values[0];if(e==s)return this.values[s-1];const i=this.values[e-1],r=this.values[e],n=t-this.times[e-1],o=this.times[e]-this.times[e-1],a=this.fns[e]?this.fns[e]:this.defaultFn;if(Array.isArray(i)&&Array.isArray(r)){const l=[];for(let c=0;c<i.length;c++)l.push(a(n,i[c],r[c],o));return l}return a(n,i,r,o)}setLooped(t){this.looped=t}getCurrentValue(){return this.currentValue}get(t=0){if(!Array.isArray(this.currentValue))throw new Error("Tween::get(): You cannot call get on a non-array values based");return this.currentValue[t]}isEmpty(){return this.times.length==0||this.values.length==0}}class bs extends dt{constructor(t,e,s,i=3){super("SpecialAttack"),this.gfx=new xl(e,s,t,i),this.duration=i}}class wl extends mt{constructor(t){super(),super.addRequiredComponentTypename("SpecialAttack"),this.gameScreen=t}async onEntityBind(t){const e=document.querySelector("#UI_ROOT");e.style.display="none";for(const i of x.getSystems())i!=this&&i.pause();const s=x.getComponent(t,bs);s.gfx.reset(),setTimeout(()=>this.handleTimeout(t),s.duration*1e3)}onEntityUpdate(t,e){x.getComponent(e,bs).gfx.update(t)}onEntityDraw(t){x.getComponent(t,bs).gfx.draw()}handleTimeout(t){const e=document.querySelector("#UI_ROOT");e.style.display="block";for(const s of x.getSystems())s!=this&&s.resume();x.removeComponent(t,bs)}}class xl extends he{constructor(t,e,s,i){super(),this.bgJSS=t,this.avatarJSS=e,this.text=s,this.duration=i,this.textX=0,this.opacity=0,this.age=0,this.tweenOpacity=new St([0,.5,this.duration-.5,this.duration],[0,1,1,0]),this.textTweenX=new St([0,.5],[-300,300]),this.avatarTweenX=new St([0,.5],[600,0],f.EASE_OUT_QUAD)}update(t){this.opacity=this.tweenOpacity.interpolate(this.age),this.bgJSS.setOpacity(this.opacity);const e=this.avatarTweenX.interpolate(this.age);this.avatarJSS.setPosition(e,0),this.avatarJSS.setOpacity(this.opacity),this.textX=this.textTweenX.interpolate(this.age),this.age+=t/1e3}onRender(){const t=nt.getContext();t.setTransform(1,0,0,1,0,0),this.bgJSS.render(),this.avatarJSS.render(),t.globalAlpha=this.opacity,t.font="48px Ninja Naruto",t.textAlign="center",t.fillStyle="orange",t.fillText(this.text,this.textX,60,600),t.globalAlpha=1}reset(){this.textX=0,this.opacity=0,this.age=0}}const zi={PUNCH:async h=>new us("PUNCH",Xt,"OKOK","PUNCH1",null,[{spriteAnimationOnImpact:"HIT",frameIndex:0,w:10,h:10,damageHP:10,damageMaxAge:1,damageSpriteAnimation:"HIT",damageSpriteOffset:[21,29],maxAge:.2,relativeX:44,relativeY:0,velocityImpact:[30,-10]}]),SPECIAL:async h=>{const t=new ne;t.setTexture(await It.loadTexture("templates/fight/chars/"+h+"/bg-special-attack.png"));const e=new ne;return e.setTexture(await It.loadTexture("templates/fight/chars/"+h+"/avatar-special-attack.png")),new us("SPECIAL",Xt,"OKOK","PUNCH1",new bs("Special Attack 1",t,e),[{spriteAnimationOnImpact:"HIT",frameIndex:0,w:10,h:10,damageHP:10,damageMaxAge:1,damageSpriteAnimation:"HIT",damageSpriteOffset:[21,29],maxAge:.2,relativeX:44,relativeY:0,velocityImpact:[30,-10]}])}};async function vl(h){const t=new Zt;await t.loadFromFile("templates/fight/chars/"+h+"/sprite.jas"),t.setTexture(await It.loadTexture("templates/fight/chars/"+h+"/sprite.png")),t.setOffset(44,44);const e=new Zt;await e.loadFromFile("templates/fight/chars/"+h+"/sprite.jas"),e.setTexture(await It.loadTexture("templates/fight/chars/"+h+"/sprite.png")),e.setOffset(44,44);const s=x.createEntity();return x.addComponent(s,new De(1,100,e,88,88)),x.addComponent(s,new Ce(88,88)),x.addComponent(s,new jt(190,490)),x.addComponent(s,new Wt),x.addComponent(s,new Gt({jas:t,zIndex:2})),x.addComponent(s,new Ns),x.addComponent(s,new ul),x.addComponent(s,new hl),x.addComponent(s,new nl),x.addComponent(s,new fl),x.addComponent(s,new Bt),x.addComponent(s,new ts(t.animations,t.texture,[await zi.PUNCH(h)])),s}class no extends dt{constructor(t=100,e=[]){super("AI"),this.patterns=e.sort((s,i)=>i.tick-s.tick),this.tick=t,this.then=0}}class Il extends mt{constructor(){super(),super.addRequiredComponentTypename("AI"),this.commandRegister={},this.conditionRegister={},this.commandRegister.CMD_WAKEUP=function(t){return x.hasComponent(t,cs)?(x.removeComponentIfExist(t,cs),x.removeComponentIfExist(t,Bt),x.addComponent(t,new Bt),!0):!1},this.commandRegister.CMD_JUMP=function(t){return x.hasComponent(t,Bt)||x.hasComponent(t,Xt)?(x.removeComponentIfExist(t,Bt),x.removeComponentIfExist(t,Xt),x.addComponent(t,new ve),!0):!1},this.commandRegister.CMD_RUN=function(t,e){if(x.hasComponent(t,Bt)||x.hasComponent(t,Xt)){const s=x.getComponent(t,jt),i=x.getComponent(t,Wt),n=x.getComponent(e,jt).x-s.x;return n>0?i.direction=1:n<0&&(i.direction=-1),x.removeComponentIfExist(t,Bt),x.removeComponentIfExist(t,Xt),x.addComponent(t,new Xt),!0}return!1},this.commandRegister.CMD_IDLE=function(t){return x.hasComponent(t,Xt)?(x.removeComponentIfExist(t,Xt),x.removeComponentIfExist(t,Bt),x.addComponent(t,new Bt),!0):!1},this.commandRegister.CMD_COMBO=function(t,e,s){if(x.hasComponent(e,cs)||x.hasComponent(e,je))return!1;if(x.hasComponent(t,Bt)||x.hasComponent(t,Xt)){const i=x.getComponent(t,Wt),r=x.getComponent(t,ts),n=r.comboComponents.find(o=>o.name==s);return n&&(i.x=0,r.currentActionAge=0,r.currentAction="",x.removeComponentIfExist(t,Bt),x.removeComponentIfExist(t,Xt),x.addComponent(t,n)),!0}return!1},this.conditionRegister.COND_HEALTH_LESS_THAN=function(t,e,s){return x.getComponent(t,De).health<s}}onEntityUpdate(t,e){const s=x.getComponent(e,no),i=x.getComponent(e,jt);let r=null,n=1/0;for(const o of x.findEntities(De)){if(e==o)continue;const a=x.getComponent(o,jt),l=f.VEC2_DISTANCE([a.x,a.y],[i.x,i.y]);l<n&&(n=l,r=o)}for(const o of s.patterns){if(o.then<o.tick||o.agentHasComponent&&!x.hasComponent(e,o.agentHasComponent)||o.enemyMinDistance&&o.enemyMinDistance>n||o.enemyMaxDistance&&o.enemyMaxDistance<n)continue;const a=this.conditionRegister[o.conditionName];if(a&&!a.apply(this,[e,r,...o.conditionArgs]))continue;const l=x.getComponent(r,ts);if(o.enemyAction&&l.currentAction.search(new RegExp(o.enemyAction+"$"))==-1||Math.random()>o.percentSuccess/100)continue;const u=this.commandRegister[o.commandName];if(u&&u.apply(this,[e,r,...o.commandArgs])){o.then=0;break}}for(const o of s.patterns)o.then>=o.tick?o.then=0:o.then+=t}}const Sl={BASE:()=>[{name:"WAKE_UP",agentHasComponent:cs,enemyAction:null,enemyMinDistance:0,enemyMaxDistance:1/0,tick:100,then:0,percentSuccess:100,commandName:"CMD_WAKEUP",commandArgs:[],conditionName:null,conditionArgs:[]},{name:"PUNCH",agentHasComponent:null,enemyAction:null,enemyMinDistance:0,enemyMaxDistance:90,tick:500,then:0,percentSuccess:50,commandName:"CMD_COMBO",commandArgs:["PUNCH"],conditionName:null,conditionArgs:[]},{name:"SPECIAL",agentHasComponent:null,enemyAction:null,enemyMinDistance:10,enemyMaxDistance:90,tick:1e3,then:0,percentSuccess:50,commandName:"CMD_COMBO",commandArgs:["SPECIAL"],conditionName:null,conditionArgs:[]},{name:"IDLE",agentHasComponent:null,enemyAction:null,enemyMinDistance:0,enemyMaxDistance:90,tick:50,then:0,percentSuccess:100,commandName:"CMD_IDLE",commandArgs:[],conditionName:null,conditionArgs:[]},{name:"RUN",agentHasComponent:null,enemyAction:null,enemyMinDistance:80,enemyMaxDistance:1/0,tick:1500,then:0,percentSuccess:100,commandName:"CMD_RUN",commandArgs:[],conditionName:null,conditionArgs:[]}]};async function _l(h){const t=new Zt;await t.loadFromFile("templates/fight/chars/"+h+"/sprite.jas"),t.setTexture(await It.loadTexture("templates/fight/chars/"+h+"/sprite.png")),t.setOffset(44,44);const e=new Zt;await e.loadFromFile("templates/fight/chars/"+h+"/sprite.jas"),e.setTexture(await It.loadTexture("templates/fight/chars/"+h+"/sprite.png")),e.setOffset(44,44);const s=x.createEntity();return x.addComponent(s,new De(2,100,e)),x.addComponent(s,new Ce(88,88)),x.addComponent(s,new jt(490,490)),x.addComponent(s,new Wt),x.addComponent(s,new Gt({jas:t,zIndex:2})),x.addComponent(s,new Bt),x.addComponent(s,new Ns),x.addComponent(s,new no(60,Sl.BASE())),x.addComponent(s,new ts(t.animations,t.texture,[await zi.PUNCH(h),await zi.SPECIAL(h)])),s}const qi=100,ns=["naruto","kakashi","sasuke","sakura","deidara","pain","jugo","suigetsu","karin","sai"];class zr extends xt{constructor(){super({className:"UIHealthBar",template:`
      <img class="UIHealthBar-picture js-picture"/>
      <div class="UIHealthBar-content">
        <div class="UIHealthBar-bar js-bar">
          <div class="UIHealthBar-bar-progress js-progress">
            <div class="UIHealthBar-bar-progress-life js-progress-life"></div>
          </div>
        </div>
        <div class="UIHealthBar-name js-name"></div>
      </div>`})}setHealth(t){const e=this.node.querySelector(".js-progress"),s=this.node.querySelector(".js-progress-life"),i=t/qi;s.style.width=e.clientWidth*i+"px"}setPicture(t){const e=this.node.querySelector(".js-picture");e.src=t}setName(t){this.node.querySelector(".js-name").textContent=t}}class bl extends mt{constructor(t){super(),super.addRequiredComponentTypename("Damage"),super.addRequiredComponentTypename("Fighter"),this.healthBar1=new zr,P.addWidget(this.healthBar1,"position: absolute; left: 0;"),this.healthBar1.setName("Player 1"),this.healthBar1.setPicture("templates/fight/chars/"+t[0]+"/avatar.jpg"),this.healthBar1.setHealth(qi),this.healthBar2=new zr,P.addWidget(this.healthBar2,"position: absolute; right: 0; flex-direction: row-reverse;"),this.healthBar2.setName("Player 2"),this.healthBar2.setPicture("templates/fight/chars/"+t[1]+"/avatar.jpg"),this.healthBar2.setHealth(qi)}onEntityBind(t){const e=x.getComponent(t,je),s=x.getComponent(t,De);s.id==1?this.healthBar1.setHealth(s.health-e.damageHP):s.id==2&&this.healthBar2.setHealth(s.health-e.damageHP)}}class Ml extends yt{constructor(){super(),this.systems={}}async onEnter(t={map,characters}){x.setup([new bl(t.characters),new tl(800,600),new dl,new pl,new ll,new cl,new ol,new al,new ml,new gl,new yl,new Al,new Jh,new rl(800,600),new Cl,new El,new el,new wl(this),new Il]),await sl(t.map),await vl(t.characters[0]),await _l(t.characters[1])}update(t){x.update(t)}draw(){x.draw()}}class Pl extends yt{constructor(){super(),this.map=0,this.numPlayers=2,this.selectionPlayerOrder=[0,1],this.selectionPlayerIndex=0,this.selectedCharacters=["",""],this.uiBackground=document.createElement("img"),this.uiTitle=document.createElement("div"),this.uiMenu=new ms,this.uiAvatars=[],this.uiLabels=[]}async onEnter(t={map}){this.map=t.map,this.uiBackground=document.createElement("img"),this.uiBackground.className="CharacterScreen-background",this.uiBackground.src="./templates/fight/ui/bg-map-screen.jpg",P.addNode(this.uiBackground,"position:absolute; left:0; right:0; top:0; right:0;"),this.uiTitle=document.createElement("div"),this.uiTitle.className="CharacterScreen-title",this.uiTitle.textContent="SELECT PLAYERS",P.addNode(this.uiTitle,"position: absolute; left:0; right:0; top:100px;"),this.uiMenu=new ms({className:"UICharacter-menu",axis:Ts.XY,rows:3,columns:4,multiple:!0,togglable:!1}),P.addWidget(this.uiMenu,"position:absolute; left:100px; top:170px");for(let e=0;e<this.numPlayers;e++){const s=e==0||e==1?"top:10px":"bottom:10px",i=e==0||e==2?"left:10px":"right:10px";this.uiAvatars[e]=document.createElement("img"),this.uiAvatars[e].className="CharacterScreen-avatar",this.uiAvatars[e].src="templates/fight/chars/default-avatar.png",P.addNode(this.uiAvatars[e],"position:absolute; "+s+";"+i);const r=e==0||e==1?"top:75px":"bottom:75px",n=e==0||e==2?"left:10px":"right:10px";this.uiLabels[e]=document.createElement("div"),this.uiLabels[e].className="CharacterScreen-label",this.uiLabels[e].textContent="Player "+e,P.addNode(this.uiLabels[e],"position:absolute; "+r+";"+n)}for(let e=0;e<ns.length;e++)this.uiMenu.addWidget(new xt({className:"UICharacter",template:`
        <div class="UICharacter-container">
          <img class="UICharacter-container-char-icon js-icon" alt="icon" src="${"templates/fight/chars/"+ns[e]}/avatar.jpg"/>
        </div>`}));v.subscribe(this.uiMenu,"E_ITEM_SELECTED",this,this.handleMenuItemSelected),v.subscribe(this.uiMenu,"E_ITEM_FOCUSED",this,this.handleMenuItemFocused),v.subscribe(this.uiMenu,"E_CLOSED",this,this.handleMenuBack),P.focus(this.uiMenu)}onExit(){P.clear()}async handleMenuBack(){this.selectionPlayerIndex==0&&ut.requestSetScreen(new oo);const t=this.selectionPlayerOrder[this.selectionPlayerIndex-1],e=this.selectedCharacters[t];this.selectedCharacters.filter(i=>i==e).length==1&&this.uiMenu.unselectWidget(ns.indexOf(e)),this.selectionPlayerIndex--}async handleMenuItemFocused(t){this.uiAvatars[this.selectionPlayerIndex].src="templates/fight/chars/"+ns[t.index]+"/avatar.jpg"}async handleMenuItemSelected(t){const e=this.selectionPlayerOrder[this.selectionPlayerIndex];if(this.selectedCharacters[e]=ns[t.index],this.selectionPlayerIndex++,this.selectionPlayerIndex==this.numPlayers)ut.requestSetScreen(new Ml,{map:this.map,characters:this.selectedCharacters});else{const s=this.uiMenu.getFocusedWidgetIndex();this.uiAvatars[this.selectionPlayerIndex].src="templates/fight/chars/"+ns[s]+"/avatar.jpg"}}}class oo extends yt{constructor(){super(),this.uiBackground=document.createElement("img"),this.uiTitle=document.createElement("div"),this.uiMenu=new ms}async onEnter(){await ki.loadSound("./templates/fight/musics/intro.mp3"),this.uiBackground=document.createElement("img"),this.uiBackground.className="MapScreen-background",this.uiBackground.src="./templates/fight/ui/bg-map-screen.jpg",P.addNode(this.uiBackground,"position:absolute; left:0; right:0; top:0; right:0;"),this.uiTitle=document.createElement("div"),this.uiTitle.className="MapScreen-title",this.uiTitle.textContent="SELECT ARENA",P.addNode(this.uiTitle,"position: absolute; left:0; right:0; top:100px;"),this.uiMenu=new ms({className:"UIMap-menu",axis:Ts.XY,rows:2,columns:2}),P.addWidget(this.uiMenu,"position:absolute; left:100px; top:170px");for(let t=0;t<4;t++)this.uiMenu.addWidget(new xt({className:"UIMap",template:`
        <div class="UIMap-container">
          <img class="UIMap-container-char-icon js-icon" alt="icon" src="${"templates/fight/backgrounds/"+t}/icon.png"/>
        </div>`}));v.subscribe(this.uiMenu,"E_ITEM_SELECTED",this,this.handleMenuItemSelected),v.subscribe(this.uiMenu,"E_CLOSED",this,this.handleMenuBack),P.focus(this.uiMenu)}async handleMenuBack(){P.focus(this.uiMenu)}async handleMenuItemSelected(t){P.unfocus(),P.clear(),ut.requestSetScreen(new Pl,{map:t.index})}}class Xe extends _e{view;constructor(t){super(),this.view=k.getView(t)}setPosition(t,e,s){super.setPosition(t,e,s),this.view.setCameraMatrix(this.getTransformMatrix())}translate(t,e,s){super.translate(t,e,s),this.view.setCameraMatrix(this.getTransformMatrix())}setRotation(t,e,s){super.setRotation(t,e,s),this.view.setCameraMatrix(this.getTransformMatrix())}rotate(t,e,s){super.rotate(t,e,s),this.view.setCameraMatrix(this.getTransformMatrix())}setQuaternion(t){super.setQuaternion(t),this.view.setCameraMatrix(this.getTransformMatrix())}setScale(t,e,s){super.setScale(t,e,s),this.view.setCameraMatrix(this.getTransformMatrix())}zoom(t,e,s){super.zoom(t,e,s),this.view.setCameraMatrix(this.getTransformMatrix())}changeView(t){this.view=k.getView(t)}lookAt(t,e,s,i=[0,1,0]){super.lookAt(t,e,s,i),this.view.setCameraMatrix(this.getTransformMatrix())}getCameraMatrix(){return this.view.getCameraMatrix()}}class Rl{constructor(t,e){this.player=t,this.camera=e,v.subscribe(Q,"E_MOUSE_MOVE",this,this.handleMouseMove),v.subscribe(Q,"E_ACTION_ONCE",this,this.handleActionOnce),v.subscribe(Q,"E_MOUSE_DOWN",this,this.handleMouseDown)}delete(){v.unsubscribe(Q,"E_MOUSE_MOVE",this.handleMouseMove),v.unsubscribe(Q,"E_ACTION_ONCE",this.handleActionOnce)}update(t){const e=this.camera.getAxies();let s=!1;this.player.dir=[0,0,0],Q.isActiveAction("LEFT")&&(this.player.dir[0]+=e[0][0]*-1,this.player.dir[2]+=e[0][2]*-1,s=!0),Q.isActiveAction("RIGHT")&&(this.player.dir[0]+=e[0][0],this.player.dir[2]+=e[0][2],s=!0),Q.isActiveAction("UP")&&(this.player.dir[0]+=e[2][0]*-1,this.player.dir[2]+=e[2][2]*-1,s=!0),Q.isActiveAction("DOWN")&&(this.player.dir[0]+=e[2][0],this.player.dir[2]+=e[2][2],s=!0),s&&(this.player.dir=f.VEC3_NORMALIZE(this.player.dir))}handleMouseMove(t){this.player.rotation[0]+=t.movementY*this.player.rotationSpeed/1e3,this.player.rotation[1]+=t.movementX*this.player.rotationSpeed/1e3,this.player.rotation[0]>Math.PI/2?this.player.rotation[0]=Math.PI/2:this.player.rotation[0]<-Math.PI/2&&(this.player.rotation[0]=-Math.PI/2),this.player.rotation[1]>=Math.PI*2?this.player.rotation[1]-=Math.PI*2:this.player.rotation[1]<=-Math.PI*2&&(this.player.rotation[1]+=Math.PI*2)}handleActionOnce(t){t.actionId=="SELECT"&&(this.player.jump=!0)}handleMouseDown(){this.player.shoot()}}class Ol{constructor(t,e){this.player=t,this.rec=e,this.crosshair=document.createElement("img"),this.crosshair.src="templates/fps/crosshair.png",P.addNode(this.crosshair,"position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);")}delete(){P.removeNode(this.crosshair)}update(t){this.rec.setPosition(this.player.x,this.player.y+this.player.height/2,this.player.z),this.rec.setRotation(this.player.rotation[0],this.player.rotation[1],this.player.rotation[2])}}class Dl{constructor(t,e){this.player=t,this.jnm=e,this.lift=.3,this.radius=.5,this.frictionCoefficient=.999999999,this.gravity=32}update(t){const e=f.VEC3_SCALE(this.player.dir,this.player.maxSpeed);this.player.velocity[0]=e[0],this.player.velocity[2]=e[2],this.player.jump&&(this.player.velocity[1]=this.player.jumpStrength,this.player.jump=!1);const s=this.player.velocity[0]*(t/1e3),i=this.player.velocity[1]*(t/1e3),r=this.player.velocity[2]*(t/1e3),n=i<=0,o=i<=0?.1:.01;if(f.VEC3_LENGTH(this.player.velocity)>0){const a=this.jnm.box(this.player.x,this.player.y,this.player.z,this.radius,this.player.height,s,i,r,this.lift,n,o);this.player.x+=a.move[0],this.player.y+=a.move[1],this.player.z+=a.move[2],this.player.velocity[1]<0&&a.collideFloor&&(this.player.velocity[1]=0),this.player.velocity[1]>0&&a.collideTop&&(this.player.velocity[1]=0),a.collideFloor||(this.player.velocity[1]=f.LERP(this.player.velocity[1],-this.gravity,t/1e3))}}}let Ll=class{constructor(){this.x=0,this.y=0,this.z=0,this.mx=0,this.my=0,this.mz=0,this.age=0}};class ai{static OSCILLATION_LENGTH=.05;static OSCILLATION_RATE=7;constructor(t,e){this.player=t,this.jnm=e,this.mesh=new ft,this.bulletMesh=new ft,this.oscillation=0,this.bullets=[],this.bulletSpeed=25,this.bulletMaxAge=5}async load(){this.mesh=new ft,await this.mesh.loadFromFile("./templates/fps/weapon.jsm"),this.mesh.setMaterial(new vt({texture:await st.loadTexture("./templates/fps/weapon.png")})),this.bulletMesh=new ft,await this.bulletMesh.loadFromFile("./templates/fps/bullet.jsm"),this.bulletMesh.setMaterial(new vt({texture:await st.loadTexture("./templates/fps/bullet.png")}))}delete(){this.mesh.delete(),this.bulletMesh.delete()}update(t){(this.player.dir[0]!=0||this.player.dir[2]!=0)&&(this.oscillation+=ai.OSCILLATION_RATE*(t/1e3));const e=Math.sin(this.oscillation)*ai.OSCILLATION_LENGTH*.5;this.mesh.setPosition(this.player.x,this.player.y+.5+e,this.player.z),this.mesh.setRotation(this.player.rotation[0],this.player.rotation[1],this.player.rotation[2]),this.mesh.update(t),this.bulletMesh.update(t);for(const s of this.bullets)s.x+=s.mx*(t/1e3),s.y+=s.my*(t/1e3),s.z+=s.mz*(t/1e3),s.age+=t/1e3;this.bullets.filter(s=>s.age>=this.bulletMaxAge)}draw(){this.mesh.draw();for(const t of this.bullets)Ot.drawMesh(this.bulletMesh,f.MAT4_TRANSLATE(t.x,t.y,t.z))}shoot(){const t=this.player.camera.rec.getAxis("FORWARD"),e=this.player.camera.rec.getPosition(),s=this.jnm.raycast(e,t,100,100),i=this.player.camera.rec.getTransformMatrix(),r=f.MAT4_MULTIPLY_BY_VEC4(i,[.5,-.2,0,1]);let n=[0,0,0];if(s){const a=f.VEC3_SUBSTRACT(s.hit,r);n=f.VEC3_NORMALIZE(a)}else{const a=f.MAT4_MULTIPLY_BY_VEC4(i,[0,0,-100,1]),l=f.VEC3_SUBSTRACT(a,r);n=f.VEC3_NORMALIZE(l)}const o=new Ll;o.x=r[0],o.y=r[1],o.z=r[2],o.mx=n[0]*this.bulletSpeed,o.my=n[1]*this.bulletSpeed,o.mz=n[2]*this.bulletSpeed,this.bullets.push(o)}}let Nl=class{constructor(t,e){this.input=new Rl(this,e),this.camera=new Ol(this,e),this.physics=new Dl(this,t),this.weapon=new ai(this,t),this.x=0,this.y=1,this.z=1,this.height=1.3,this.dir=[0,0,0],this.velocity=[0,0,0],this.rotation=[0,0,0],this.maxSpeed=7,this.rotationSpeed=1,this.jump=!1,this.jumpStrength=10}async load(){await this.weapon.load()}update(t){this.input.update(t),this.physics.update(t),this.camera.update(t),this.weapon.update(t)}draw(){this.weapon.draw()}shoot(){this.weapon.shoot()}};class Fl extends yt{constructor(){super(),this.map={},this.player=null,this.camera=new Xe(0)}async onEnter(){Q.setPointerLockEnabled(!0),this.map=await this.createMap(),this.player=new Nl(this.map.jnm,this.camera),await this.player.load()}update(t){this.map.mesh.update(t),this.player.update(t)}draw(){Ot.setAmbientColor([.5,.5,.5]),Ot.drawDirLight([0,-1,0],[1,1,1],[0,0,0]),this.map.mesh.draw(),this.player.draw()}async createMap(){const t=new ft;await t.loadFromFile("./templates/fps/map.jsm"),t.setMaterial(new vt({lightning:!0,texture:await st.loadTextureMips("./templates/fps/map.png",{magFilter:"nearest",minFilter:"nearest",mipmapFilter:"linear"})}));const e=new Ds;return await e.loadFromFile("./templates/fps/map.jnm"),{mesh:t,jnm:e}}}class Ul extends xt{uiMenu;text;actions;stepDuration;currentTextOffset;currentActionTextOffset;currentActionIndex;timeElapsed;finished;constructor(){super({className:"UIBubble",template:`
      <img class="UIBubble-picture js-picture" src=""/>
      <div class="UIBubble-content">
        <div class="UIBubble-author js-author"></div>
        <div class="UIBubble-text js-text"></div>
        <div class="UIBubble-menu js-menu"></div>
      </div>`}),this.uiMenu=new Yt,this.text="",this.actions=[],this.stepDuration=0,this.currentTextOffset=0,this.currentActionTextOffset=0,this.currentActionIndex=0,this.timeElapsed=0,this.finished=!1,this.node.querySelector(".js-menu").replaceWith(this.uiMenu.getNode()),v.subscribe(this.uiMenu,"E_ITEM_SELECTED",this,this.#t)}update(t){if(this.uiMenu.update(t),this.currentTextOffset==this.text.length&&this.currentActionIndex==this.actions.length){this.finished=!0,v.emit(this,"E_PRINT_FINISHED");return}this.timeElapsed>=this.stepDuration?(this.currentTextOffset<this.text.length?(this.node.querySelector(".js-text").textContent=this.text.substring(0,this.currentTextOffset+1),this.currentTextOffset++):this.currentActionIndex<this.actions.length&&(this.currentActionTextOffset==0&&this.uiMenu.add(this.currentActionIndex.toString(),""),this.currentActionTextOffset<this.actions[this.currentActionIndex].length?(this.uiMenu.set(this.currentActionIndex.toString(),this.actions[this.currentActionIndex].substring(0,this.currentActionTextOffset+1)),this.currentActionTextOffset++):(this.currentActionIndex++,this.currentActionTextOffset=0)),this.timeElapsed=0):this.timeElapsed+=t}delete(){v.unsubscribe(this.uiMenu,"E_ITEM_SELECTED",this),this.uiMenu.delete(),super.delete()}focus(){this.actions.length>0&&this.uiMenu.focus(),super.focus()}unfocus(){this.actions.length>0&&this.uiMenu.unfocus(),super.unfocus()}setPicture(t){this.node.querySelector(".js-picture").src=t}setAuthor(t){this.node.querySelector(".js-author").textContent=t}setWidth(t){this.node.style.width=t+"px"}setText(t){this.text=t,this.currentTextOffset=0,this.finished=!1}setActions(t){this.actions=t,this.currentActionIndex=0,this.currentActionTextOffset=0,this.finished=!1,this.uiMenu.clear()}setStepDuration(t){this.stepDuration=t}onAction(t){t=="OK"&&this.finished&&v.emit(this,"E_OK")}#t(t){v.emit(this,"E_MENU_ITEM_SELECTED",t)}}const Ke={LEFT:"LEFT",RIGHT:"RIGHT",FORWARD:"FORWARD",BACKWARD:"BACKWARD"},hi={LEFT:f.VEC3_LEFT,RIGHT:f.VEC3_RIGHT,FORWARD:f.VEC3_FORWARD,BACKWARD:f.VEC3_BACKWARD},qr=48,Bl=8.4,Vl=100,Hl=[.7071,0,.7071,0,.3546,.8652,-.3546,0,-.6118,.5015,.6118,0,-7.3046,4.9583,5.6356,1];let jl=class extends _e{constructor(){super(),this.name="",this.direction=Ke.FORWARD,this.radius=.2}async loadFromData(t){this.name=t.Name,this.position[0]=t.PositionX,this.position[1]=t.PositionY,this.position[2]=t.PositionZ,this.direction=t.Direction}draw(){Jt.drawSphere(this.getTransformMatrix(),this.radius,2)}getName(){return this.name}getDirection(){return this.direction}getRadius(){return this.radius}},Xr=class extends _e{constructor(){super(),this.jas=new fs,this.radius=0,this.height=1,this.direction=Ke.FORWARD,this.onActionBlockId="",this.jas.setPixelsPerUnit(qr),this.jas.setBillboardMode(!0)}async loadFromData(t){await this.jas.loadFromFile(t.JASFile),this.jas.setTexture(await st.loadTexture(t.TextureFile)),this.jas.setOffset(t.OffsetX,t.OffsetY),this.position[0]=t.PositionX,this.position[1]=t.PositionY,this.position[2]=t.PositionZ,this.radius=t.Radius,this.height=t.Height,this.direction=t.Direction,this.onActionBlockId=t.OnActionBlockId}delete(){this.jas.delete()}update(t){let e=this.jas.getOffsetY()/qr;this.jas.setPosition(this.position[0],this.position[1]+e,this.position[2]),this.jas.update(t)}draw(){this.jas.draw()}move(t,e,s=null){const i=this.position.slice();this.position[0]+=t,this.position[2]+=e,this.direction=s,v.emit(this,"E_MOVED",{old:i,moveX:t,moveZ:e})}play(t,e=!1){this.jas.play(t,e,!0)}getDirection(){return this.direction}setDirection(t){this.direction=t}getRadius(){return this.radius}getHeight(){return this.height}getOnActionBlockId(){return this.onActionBlockId}getHandPosition(){return[this.position[0]+hi[this.direction][0]*this.radius*1.2,this.position[1],this.position[2]+hi[this.direction][2]*this.radius*1.2]}isCollideLayerZone(t){const e=[this.position[0]-this.radius,this.position[2]-this.radius],s=[this.position[0]+this.radius,this.position[2]+this.radius];return f.COLLIDE_RECT_TO_RECT(e,s,t.getMin(),t.getMax())}isCollideTrigger(t){return f.COLLIDE_CYLINDER_TO_CYLINDER(this.position,this.radius,this.height,t.getPosition(),t.getRadius(),t.getHeight())}isCollideModel(t){return f.COLLIDE_CYLINDER_TO_CYLINDER(this.position,this.radius,this.height,t.getPosition(),t.getRadius(),t.getHeight())}isHandCollide(t){return f.COLLIDE_CYLINDER_TO_CYLINDER(this.getHandPosition(),0,this.height,t.getPosition(),t.getRadius(),t.getHeight())}},kl=class extends _e{constructor(){super(),this.radius=0,this.height=1,this.hovered=!1,this.onEnterBlockId="",this.onLeaveBlockId="",this.onActionBlockId=""}async loadFromData(t){this.position[0]=t.PositionX,this.position[1]=t.PositionY,this.position[2]=t.PositionZ,this.radius=t.Radius,this.onEnterBlockId=t.OnEnterBlockId,this.onLeaveBlockId=t.OnLeaveBlockId,this.onActionBlockId=t.OnActionBlockId}draw(){Jt.drawSphere(this.getTransformMatrix(),this.radius,2)}getRadius(){return this.radius}getHeight(){return this.height}isHovered(){return this.hovered}setHovered(t){this.hovered=t}getOnEnterBlockId(){return this.onEnterBlockId}getOnLeaveBlockId(){return this.onLeaveBlockId}getOnActionBlockId(){return this.onActionBlockId}},Yr=class{constructor(t){this.target=null,this.minClipOffset=[0,0],this.maxClipOffset=[0,0],this.view=k.getView(t),this.view.setProjectionMode(ir.ORTHOGRAPHIC),this.view.setOrthographicSize(Bl),this.view.setOrthographicDepth(Vl),this.view.setCameraMatrix(Hl)}async loadFromData(t){this.minClipOffset[0]=t.MinClipOffsetX,this.minClipOffset[1]=t.MinClipOffsetY,this.maxClipOffset[0]=t.MaxClipOffsetX,this.maxClipOffset[1]=t.MaxClipOffsetY}update(t){if(!this.target)return;let e=this.view.getClipOffset(),s=this.target.getPosition(),i=this.view.getScreenNormalizedPosition(0,s[0],s[1],s[2]);this.view.setClipOffset(f.CLAMP(i[0]+e[0],this.minClipOffset[0],this.maxClipOffset[0]),f.CLAMP(i[1]+e[1],this.minClipOffset[1],this.maxClipOffset[1]))}setTarget(t){this.target=t}};const Zr=1;let Wl=class{constructor(){this.name="",this.description="",this.map=new ft,this.walkmesh=new ps,this.controller=new Xr,this.controllerWalker={},this.camera=new Yr(0),this.scriptMachine=new Ls,this.spawns=[],this.models=[],this.triggers=[],this.pause=!1,this.scriptMachine.registerCommand("LOAD_ROOM",this.#t.bind(this)),this.scriptMachine.registerCommand("CONTINUE",this.#e.bind(this)),this.scriptMachine.registerCommand("STOP",this.#s.bind(this)),this.scriptMachine.registerCommand("UI_CREATE_DIALOG",this.#i.bind(this)),this.scriptMachine.registerCommand("MODEL_PLAY_ANIMATION",this.#r.bind(this)),v.subscribe(Q,"E_ACTION_ONCE",this,this.handleActionOnce),v.subscribe(this.controller,"E_MOVED",this,this.handleControllerMoved)}async loadFromFile(t,e){let i=await(await fetch(t)).json();this.map=new ft,await this.map.loadFromFile(i.MapFile),this.map.setMaterial(new vt({texture:await st.loadTexture(i.MapTextureFile,{magFilter:"nearest"})})),this.walkmesh=new ps,await this.walkmesh.loadFromFile(i.WalkmeshFile),await this.controller.loadFromData(i.Controller),this.camera=new Yr(0),await this.camera.loadFromData(i.Camera),this.camera.setTarget(this.controller),this.spawns=[];for(let n of i.Spawns){let o=new jl;await o.loadFromData(n),this.spawns.push(o)}this.models=[];for(let n of i.Models){let o=new Xr;await o.loadFromData(n),this.models.push(o)}this.triggers=[];for(let n of i.Triggers){let o=new kl;await o.loadFromData(n),this.triggers.push(o)}let r=this.spawns.find(n=>n.getName()==e);this.controller.setPosition(r.getPositionX(),r.getPositionY(),r.getPositionZ()),this.controller.setDirection(r.getDirection()),this.controller.play("IDLE_"+r.getDirection(),!0,!0),this.controllerWalker=this.walkmesh.addWalker("CONTROLLER",this.controller.getPositionX(),this.controller.getPositionZ(),this.controller.getRadius()),await this.scriptMachine.loadFromFile(i.ScriptFile),this.scriptMachine.jump("ON_INIT"),this.scriptMachine.setEnabled(!0)}delete(){for(const t of this.models)t.delete();this.map.delete(),v.unsubscribe(Q,"E_ACTION_ONCE",this),v.unsubscribe(this.controller,"E_MOVED",this)}update(t){let e=Ke.FORWARD,s=!1;if(Q.isActiveAction("LEFT")?(s=!0,e=Ke.LEFT):Q.isActiveAction("RIGHT")?(s=!0,e=Ke.RIGHT):Q.isActiveAction("UP")?(s=!0,e=Ke.FORWARD):Q.isActiveAction("DOWN")&&(s=!0,e=Ke.BACKWARD),s&&!this.pause){const i=hi[e][0]*Zr*(t/1e3),r=hi[e][2]*Zr*(t/1e3);this.controller.move(i,r,e),this.controller.play("RUN_"+e,!0)}else this.controller.play("IDLE_"+this.controller.getDirection(),!0);this.walkmesh.update(t),this.controller.update(t),this.camera.update(t),this.scriptMachine.update(t);for(let i of this.models)i.update(t)}draw(){for(let t of this.spawns)t.draw();for(let t of this.models)t.draw();for(let t of this.triggers)t.draw();this.map.draw(),this.walkmesh.draw(),this.controller.draw()}handleActionOnce(t){if(!(t.actionId!="OK"||this.pause)){for(let e of this.triggers)if(this.controller.isCollideTrigger(e)&&e.getOnActionBlockId()){this.scriptMachine.jump(e.getOnActionBlockId());return}for(let e of this.models)if(this.controller.isHandCollide(e)&&e.getOnActionBlockId()){this.scriptMachine.jump(e.getOnActionBlockId());return}}}handleControllerMoved({old:t,moveX:e,moveZ:s}){for(let n of this.models)if(this.controller.isCollideModel(n)){this.controller.setPosition(t[0],t[1],t[2]);return}let i=this.walkmesh.moveWalker(this.controllerWalker,e,s),r=f.VEC3_ADD(t,i.move);this.controller.setPosition(r[0],r[1],r[2]);for(let n of this.triggers){let o=this.controller.isCollideTrigger(n);n.getOnEnterBlockId()&&!n.isHovered()&&o?(this.scriptMachine.jump(n.getOnEnterBlockId()),n.setHovered(!0)):n.getOnLeaveBlockId()&&n.isHovered()&&!o&&(this.scriptMachine.jump(n.getOnLeaveBlockId()),n.setHovered(!1))}}async#t(t,e){this.controller.setControllable(!1),await this.loadFromFile(t,e),this.controller.setControllable(!0)}#e(){this.pause=!1}#s(){this.pause=!0}async#i(t,e,s,i,r,n){this.scriptMachine.setEnabled(!1);let o=new Ul;o.setAuthor(t),o.setPicture(e),o.setText(s),o.setWidth(i),P.addWidget(o,`position:absolute; top:${n}; left:${r}`),P.focus(o),await v.wait(o,"E_OK"),P.removeWidget(o),this.scriptMachine.setEnabled(!0)}#r(t,e,s){this.models[t].play(e,s)}};class Gl extends yt{constructor(){super(),this.room=new Wl}async onEnter(){await this.room.loadFromFile("./templates/iso/scene.room","Spawn0000")}update(t){this.room.update(t)}draw(){this.room.draw()}}class Oe extends he{tilemap;layerIndex;frameIndex;frameProgress;constructor(){super(),this.tilemap=new Se,this.layerIndex=0,this.frameIndex=0,this.frameProgress=0}loadFromTileMap(t,e){this.tilemap=t,this.layerIndex=e,this.frameIndex=0,this.frameProgress=0;const s=t.getTileLayer(e);this.offset[0]=s.getOffsetX(),this.offset[1]=s.getOffsetY()}update(t){const e=this.tilemap.getTileLayer(this.layerIndex);e&&(this.frameProgress>e.getFrameDuration()&&(this.frameIndex=this.frameIndex+1,this.frameProgress=0),this.frameProgress+=t)}onRender(){const t=this.tilemap.getTileLayer(this.layerIndex);if(!t||!t.isVisible())return;const e=nt.getContext(),s=this.tilemap.getTileset();for(let i=0;i<t.getRows();i++)for(let r=0;r<t.getColumns();r++){let n=t.getTile(r,i);if(n<=0)continue;const o=s.getAnimation(n);o&&(n=o[this.frameIndex%o.length]),e.drawImage(s.getTexture(),s.getTilePositionX(n),s.getTilePositionY(n),s.getTileWidth(),s.getTileHeight(),r*this.tilemap.getTileWidth(),i*this.tilemap.getTileHeight(),this.tilemap.getTileWidth(),this.tilemap.getTileHeight())}}}class zl extends he{sprites;move;constructor(){super(),this.sprites=[],this.move=[0,0]}update(){for(const o of this.sprites){const a=o.position[0]+this.move[0],l=o.position[1]+this.move[1];o.setPosition(a,l)}const t=nt.getWidth()*.5,e=nt.getHeight()*.5,s=Math.max(...this.sprites.map(o=>o.position[0])),i=Math.min(...this.sprites.map(o=>o.position[1])),r=Math.max(...this.sprites.map(o=>o.position[1])),n=Math.min(...this.sprites.map(o=>o.position[0]));for(const o of this.sprites){const a=o.getWorldBoundingRect();let l=o.getPositionX(),c=o.getPositionY();a.max[0]<-t&&(l=s+a.getWidth()),a.min[0]>t&&(l=n-a.getWidth()),a.min[1]>e&&(c=i-a.getHeight()),a.max[1]<-e&&(c=r+a.getHeight()),o.setPosition(l,c)}}onRender(){nt.getContext().translate(nt.getCameraPositionX(),nt.getCameraPositionY());for(const e of this.sprites)e.render()}setSprite(t){const e=t.getBoundingRect(),s=Math.ceil(nt.getWidth()/e.getWidth())+1,i=Math.ceil(nt.getHeight()/e.getHeight())+1,r=-nt.getWidth()*.5,n=-nt.getHeight()*.5;this.sprites=[];for(let o=0;o<s;o++)for(let a=0;a<i;a++){const l=t.clone();l.setOffsetNormalized(.5,.5),l.setPosition(r+o*e.getWidth(),n+a*e.getHeight()),this.sprites.push(l)}}setMove(t,e){this.move[0]=t,this.move[1]=e}}class ao extends dt{constructor(){super("Enemy")}}class oe extends dt{min;max;constructor(t,e){super("Collider"),this.min=t,this.max=e}getBounds(t){return{left:t[0]-this.min[0],right:t[0]+this.max[0],bottom:t[1]+this.max[1],top:t[1]-this.min[1]}}static isCollide(t,e,s,i){const r=e.getBounds(t),n=i.getBounds(s);return f.COLLIDE_RECT_TO_RECT([r.left,r.top],[r.right,r.bottom],[n.left,n.top],[n.right,n.bottom])}}class ye extends dt{x;y;constructor(t=0,e=0){super("Velocity"),this.x=t,this.y=e}}class $t extends dt{x;y;constructor(t,e){super("Position"),this.x=t,this.y=e}}class Le extends dt{sprite;constructor(t){super("Drawable"),this.sprite=t}}const vs=async(h,t)=>{const e=new Zt;await e.loadFromFile("templates/platformer/enemy.jas"),e.setTexture(await It.loadTexture("templates/platformer/enemy.png")),e.play("walk",!0),e.setOffset(16,16),x.createEntityWith([new Le(e),new $t(h,t),new ye(-.8,0),new ao,new oe([14,14],[14,14])])},ql=async(h,t)=>{const e=new Zt;await e.loadFromFile("templates/platformer/explosion.jas"),e.setTexture(await It.loadTexture("templates/platformer/explosion.png")),e.play("explode",!1),e.setOffset(24,24);const s=x.createEntityWith([new $t(h,t),new Le(e)]);setTimeout(()=>x.removeEntity(s),300)};class ur extends dt{maxHealth;currentHealth;lastDamage;constructor(t){super("Health"),this.maxHealth=t,this.currentHealth=t,this.lastDamage=null}takeDamage(){(!this.lastDamage||this.lastDamage+1e3<Date.now())&&(this.currentHealth=Math.max(0,this.currentHealth-1),this.lastDamage=Date.now(),v.emit(this,"E_DAMAGE",this))}}class ho extends dt{jumping;wallJumping;isGrounded;platform;dropDown;constructor(){super("Jump"),this.jumping=!1,this.wallJumping=!1,this.isGrounded=!1,this.platform=-1,this.dropDown=-1}}let dr=class extends dt{shooting;shootingDuration;lastShot;accel;maxSpeed;jumpStrenght;wallJumpStrenght;gravity;constructor(){super("Player"),this.shooting=!1,this.shootingDuration=300,this.lastShot=null,this.accel=16,this.maxSpeed=32,this.jumpStrenght=80,this.wallJumpStrenght=80,this.gravity=12}};const Xl=async(h,t)=>{const e=new Zt;await e.loadFromFile("templates/platformer/player.jas"),e.setTexture(await It.loadTexture("templates/platformer/player.png")),e.setOffset(16,16),x.createEntityWith([new $t(h,t),new Le(e),new dr,new ye,new oe([8,16],[8,16]),new ho,new ur(5)])};class pr extends dt{from;to;direction;speed;constructor(t,e,s,i=3){super("Platform"),this.from=t,this.to=e,this.direction=s,this.speed=i}}const Yl=async(h,t,e,s)=>{const i=new ne;i.setTexture(await It.loadTexture("templates/platformer/platform.png")),i.setOffsetNormalized(.5,.5);const r=i.getTextureRectWidth()/2,n=i.getTextureRectHeight()/2;x.createEntityWith([new Le(i),new pr([h+e[0],t+e[1]],[h+s[0],t+s[1]],!1),new $t(h,t),new ye,new oe([r,n],[r,n])])};class Zl extends mt{constructor(){super(),this.addRequiredComponentTypename("Drawable"),this.addRequiredComponentTypename("Position")}onEntityUpdate(t,e){const s=x.getComponent(e,Le),i=x.getComponent(e,$t);if(x.hasComponent(e,ye)){const r=x.getComponent(e,ye);r.x>.01&&s.sprite.setFlipX(!1),r.x<-.01&&s.sprite.setFlipX(!0)}s.sprite.setPosition(i.x,i.y),s.sprite.update(t)}draw(){for(const t of this.eids)x.getComponent(t,Le).sprite.draw()}}class Kl extends mt{ui;constructor(){super(),this.addRequiredComponentTypename("Health"),this.addRequiredComponentTypename("Player"),this.ui=new $l,P.addWidget(this.ui)}onEntityBind(t){const e=x.getComponent(t,ur);this.ui.setNumberLives(e.currentHealth,e.maxHealth),v.subscribe(e,"E_DAMAGE",this,this.handleDamage)}handleDamage(t){this.ui.setNumberLives(t.currentHealth,t.maxHealth)}}class $l extends xt{constructor(){super({className:"UIHealth",template:'<div style="display:flex; gap:10px; margin:10px;" class="js-container"></div>'})}setNumberLives(t,e){const s=this.node.querySelector(".js-container");s.innerHTML="";for(let i=0;i<t;i++){const r=document.createElement("img");r.src="templates/platformer/heart-full.png",r.style.width="20px",r.style.imageRendering="pixelated",s.appendChild(r)}for(let i=0;i<e-t;i++){const r=document.createElement("img");r.src="templates/platformer/heart-empty.png",r.style.width="20px",r.style.imageRendering="pixelated",s.appendChild(r)}}}class lo extends dt{constructor(){super("Bullet")}}class Jl extends mt{constructor(){super(),this.addRequiredComponentTypename("Enemy")}onEntityUpdate(t,e){const s=x.getComponent(e,$t),i=x.getComponent(e,oe),r=x.getAllComponents(lo);for(const n of r.keys()){const o=x.getComponent(n,$t),a=x.getComponent(n,oe);oe.isCollide([o.x,o.y],a,[s.x,s.y],i)&&(x.removeEntity(e),x.removeEntity(n),ql(s.x,s.y))}}}class Ql extends mt{constructor(){super(),this.addRequiredComponentTypename("Bullet"),this.addRequiredComponentTypename("Velocity"),this.addRequiredComponentTypename("Position")}onEntityUpdate(t,e){const s=x.getComponent(e,$t),i=x.getComponent(e,ye);s.x+=i.x*t,s.y+=i.y*t}}class tc extends mt{map;layerIndex;constructor(t,e){super(),this.addRequiredComponentTypename("Enemy"),this.map=t,this.layerIndex=e}onEntityUpdate(t,e){const s=x.getComponent(e,$t),i=x.getComponent(e,ye),n=x.getComponent(e,oe).getBounds([s.x,s.y]),o=this.map.getLocationCol(n.left),a=this.map.getLocationCol(n.right),l=this.map.getLocationRow(n.bottom)+1,c=this.map.getLocationRow(s.y),u=this.map.getTileLayer(this.layerIndex),p=u.getTile(o,l)===0,d=u.getTile(a,l)===0,E=u.getTile(o,c)!==0,m=u.getTile(a,c)!==0;(p||d||E||m)&&(i.x*=-1),s.x+=i.x}}class ec extends mt{constructor(){super(),this.addRequiredComponentTypename("Platform"),this.addRequiredComponentTypename("Position"),this.addRequiredComponentTypename("Velocity")}onEntityUpdate(t,e){const s=x.getComponent(e,$t),i=x.getComponent(e,ye),r=x.getComponent(e,pr),n=r.direction?r.from:r.to,o=n[0]-s.x,a=n[1]-s.y;Math.sqrt(o*o+a*a)<=.2?(r.direction=!r.direction,i.y=0,i.x=0):(i.x=Math.sign(o)*r.speed,i.y=Math.sign(a)*r.speed,s.x+=i.x*(t/100),s.y+=i.y*(t/100))}}class sc extends mt{map;collisionLayerIndex;constructor(t,e){super(),this.addRequiredComponentTypename("Position"),this.addRequiredComponentTypename("Player"),this.addRequiredComponentTypename("Drawable"),this.addRequiredComponentTypename("Velocity"),this.map=t,this.collisionLayerIndex=e,Q.registerAction("keyboard","KeyA","LEFT"),Q.registerAction("keyboard","KeyD","RIGHT"),Q.registerAction("keyboard","KeyW","UP"),Q.registerAction("keyboard","KeyS","DOWN"),Q.registerAction("keyboard","Space","JUMP")}onEntityUpdate(t,e){const s=x.getComponent(e,$t),i=x.getComponent(e,ye),r=x.getComponent(e,Le),n=x.getComponent(e,oe),o=x.getComponent(e,dr),a=x.getComponent(e,ho);this.updateInput(t,s,n,r,a,i,o),this.updateGravity(t,a,i,o),this.updatePosition(t,s,n,i,a),this.updatePlatforms(t,s,i,n,a),this.updateCamera(t,s,a)}updateInput(t,e,s,i,r,n,o){const a=s.getBounds([e.x,e.y]),l=this.map.box(0,.1,this.collisionLayerIndex,a.left,a.right,a.top,a.bottom);let c=0,u=0;Q.isActiveAction("LEFT")&&(c-=o.accel),Q.isActiveAction("RIGHT")&&(c+=o.accel),Q.isJustActiveAction("JUMP")&&(r.isGrounded||r.platform!==-1)&&(n.y=o.jumpStrenght*-1,r.jumping=!0),Q.isJustActiveAction("JUMP")&&l.isAgainstWall&&r.jumping&&!r.isGrounded&&(n.y=o.wallJumpStrenght*-1,c=(l.isAgainstWall==="right"?-o.maxSpeed:o.maxSpeed)*10,r.wallJumping=!0),(r.jumping||r.wallJumping)&&i.sprite.play("jump",!1),c!==0&&!r.jumping&&i.sprite.play("walk",!0,!0),c===0&&!r.jumping&&!o.shooting&&i.sprite.play("idle",!0,!0),c===0&&Q.isActiveAction("DOWN")&&i.sprite.play("crouch",!0,!0),n.x+=c*(t/100),n.x=f.CLAMP(n.x,-o.maxSpeed,o.maxSpeed),n.y+=u*(t/100),c===0&&(n.x=f.LERP(n.x,0,t/100))}updateGravity(t,e,s,i){const r=e.jumping&&Q.isActiveAction("JUMP")?1:3;s.y+=i.gravity*r*(t/100)}updatePosition(t,e,s,i,r){i.y=Math.min(i.y,60),i.x=Math.min(i.x,60);const n=s.getBounds([e.x,e.y]),o=i.x*(t/100),a=i.y*(t/100),l=this.map.box(o,a,this.collisionLayerIndex,n.left,n.right,n.top,n.bottom);l.isGrounded?(r.jumping=!1,r.dropDown=-1,r.wallJumping=!1,r.isGrounded=!0):r.isGrounded=!1,(l.top||l.bottom)&&(i.y=0),(l.left||l.right)&&(i.x=0),e.x+=l.mx,e.y+=l.my}updatePlatforms(t,e,s,i,r){if(s.y<0&&r.platform==-1)return;const n=this.collideWithPlatform(e,i);if(n!==-1){if(Q.isActiveAction("DOWN")&&(r.dropDown=n),n!==r.dropDown){const o=x.getComponent(n,$t),a=x.getComponent(n,ye),c=x.getComponent(n,oe).getBounds([o.x,o.y]);e.y=c.top-i.min[1],e.x+=a.x,r.platform=n,r.jumping=!1}}else r.platform=-1}updateCamera(t,e,s){if(!s.wallJumping){const i=f.LERP(nt.getCameraPositionX(),e.x,t/100);nt.setCameraPosition(i,250)}}collideWithPlatform(t,e){const s=x.getAllComponents(pr),i=e.getBounds([t.x,t.y]);for(const r of s.keys()){const n=x.getComponent(r,$t),a=x.getComponent(r,oe).getBounds([n.x,n.y]),l=[i.left,i.right].some(p=>a.left<p&&p<a.right),c=a.top>i.top&&i.bottom>a.top;if(a.top-i.top>e.min[1]&&l&&c)return r}return-1}}const ic=async(h,t,e)=>{const s=new Zt;await s.loadFromFile("templates/platformer/bullet.jas"),s.setTexture(await It.loadTexture("templates/platformer/player.png")),s.play("shoot",!1),s.setFlipX(e),s.setOffset(16,16);const i=e?-1:1;x.createEntityWith([new $t(h+i*6,t),new Le(s),new ye(i*.5,0),new lo,new oe([16,12],[-4,-4])])};class rc extends mt{constructor(){super(),this.addRequiredComponentTypename("Player")}onEntityUpdate(t,e){const s=x.getComponent(e,$t),i=x.getComponent(e,Le),r=x.getComponent(e,dr),n=r.lastShot===null||Date.now()>=r.lastShot+r.shootingDuration,o=i.sprite.getCurrentAnimation();if(n&&(r.shooting=!1),n&&Q.isJustActiveAction("OK")){o?.name==="idle"&&i.sprite.play("shoot",!1);const l=o?.name==="crouch"?s.y+2:s.y;ic(s.x,l,i.sprite.getFlipX()),r.shooting=!0,r.lastShot=Date.now()}}}class nc extends mt{map;layerIndex;constructor(t,e){super(),this.addRequiredComponentTypename("Player"),this.addRequiredComponentTypename("Health"),this.map=t,this.layerIndex=e}onEntityUpdate(t,e){const s=x.getComponent(e,$t),i=x.getComponent(e,oe),r=x.getComponent(e,ur),n=x.getAllComponents(ao),o=this.map.getLocationRow(s.y),a=this.map.getLocationRow(s.x);this.map.getTileLayer(this.layerIndex).getTile(a,o)!==0&&r.takeDamage();for(const c of n.keys()){const u=x.getComponent(c,$t),p=x.getComponent(c,oe);oe.isCollide([s.x,s.y],i,[u.x,u.y],p)&&r.takeDamage()}r.currentHealth===0&&console.log("You are dead !")}}class oc extends yt{tileMap;backgroundLayer;middleLayer;foregroundLayer;scrolling;constructor(){super(),this.tileMap=new Se,this.backgroundLayer=new Oe,this.middleLayer=new Oe,this.foregroundLayer=new Oe,this.scrolling=new zl}async onEnter(){await this.tileMap.loadFromFile("templates/platformer/map.jtm"),this.backgroundLayer.loadFromTileMap(this.tileMap,3),this.middleLayer.loadFromTileMap(this.tileMap,4),this.foregroundLayer.loadFromTileMap(this.tileMap,2);const t=new ne;t.setTexture(await It.loadTexture("templates/platformer/background.png")),this.scrolling.setSprite(t),x.setup([new Zl,new Kl,new ec,new sc(this.tileMap,0),new rc,new Ql,new tc(this.tileMap,0),new Jl,new nc(this.tileMap,1)]),await Promise.all([Xl(170,350),vs(640,272),vs(720,272),vs(1080,400),vs(1200,400),vs(1320,400),Yl(1e3,280,[0,-80],[0,80])]),nt.setCameraPosition(170,350)}update(t){const e=nt.getCameraPositionX(),s=nt.getCameraPositionY();x.update(t);const i=nt.getCameraPositionX()-e,r=nt.getCameraPositionY()-s;this.scrolling.setMove(-i,-r),this.scrolling.update()}draw(){this.scrolling.draw(),this.backgroundLayer.draw(),this.middleLayer.draw(),x.draw(),this.foregroundLayer.draw()}}class li extends xt{text;stepDuration;currentTextOffset;timeElapsed;finished;constructor(){super({className:"UIDialog",template:`
      <div class="UIDialog-author js-author"></div>
      <div class="UIDialog-textbox">
        <div class="UIDialog-textbox-text js-text"></div>
        <div class="UIDialog-textbox-next js-next"></div>
      </div>`}),this.text="",this.stepDuration=0,this.currentTextOffset=0,this.timeElapsed=0,this.finished=!1,this.node.addEventListener("click",()=>this.#t())}update(t){if(!this.finished){if(this.currentTextOffset==this.text.length){this.finished=!0,this.node.querySelector(".js-next").style.display="block",v.emit(this,"E_PRINT_FINISHED");return}this.timeElapsed>=this.stepDuration?(this.currentTextOffset<this.text.length&&(this.node.querySelector(".js-text").textContent=this.text.substring(0,this.currentTextOffset+1),this.currentTextOffset++),this.timeElapsed=0):this.timeElapsed+=t}}setAuthor(t){this.node.querySelector(".UIDialog-author").textContent=t}setText(t){this.text=t,this.currentTextOffset=0,this.finished=!1,this.node.querySelector(".js-next").style.display="none"}setStepDuration(t){this.stepDuration=t}onAction(t){t=="OK"&&this.finished&&v.emit(this,"E_OK")}#t(){this.isFocused()&&this.finished&&v.emit(this,"E_OK")}}class ac extends _e{constructor(){super(),this.name="",this.direction=[0,0],this.radius=.2}async loadFromData(t){this.name=t.Name,this.position[0]=t.PositionX,this.position[1]=t.PositionY,this.position[2]=t.PositionZ,this.direction[0]=t.DirectionX,this.direction[1]=t.DirectionZ}draw(){Jt.drawSphere(this.getTransformMatrix(),this.radius,2)}getName(){return this.name}getDirection(){return this.direction}getRadius(){return this.radius}}class Kr extends _e{constructor(){super(),this.jam=new ke,this.radius=0,this.height=1,this.onActionBlockId=""}async loadFromData(t){await this.jam.loadFromFile(t.JAMFile),this.jam.setMaterial(new vt({texture:await st.loadTexture(t.TextureFile)})),this.jam.play("IDLE",!0),this.position[0]=t.PositionX,this.position[1]=t.PositionY,this.position[2]=t.PositionZ,this.rotation[0]=t.RotationX,this.rotation[1]=t.RotationY,this.rotation[2]=t.RotationZ,this.radius=t.Radius,this.height=t.Height,this.onActionBlockId=t.OnActionBlockId}delete(){this.jam.delete()}update(t){this.jam.setPosition(this.position[0],this.position[1],this.position[2]),this.jam.setRotation(this.rotation[0],this.rotation[1],this.rotation[2]),this.jam.update(t)}draw(){this.jam.draw()}move(t,e){const s=this.position.slice();this.position[0]+=t,this.position[2]+=e,this.rotation[1]=f.VEC2_ANGLE([t,e]),v.emit(this,"E_MOVED",{old:s,moveX:t,moveZ:e})}play(t){this.jam.play(t,!0,!0)}getRadius(){return this.radius}getHeight(){return this.height}getHandPosition(){return[this.position[0]+Math.cos(this.rotation[1])*this.radius*1.5,this.position[1],this.position[2]+Math.sin(this.rotation[1])*this.radius*1.5]}getOnActionBlockId(){return this.onActionBlockId}isCollide(t,e){return f.COLLIDE_CYLINDER_TO_CYLINDER(this.position,this.radius,this.height,t.getPosition(),t.getRadius(),t.getHeight(),e)}isHandCollide(t){return f.COLLIDE_CYLINDER_TO_CYLINDER(this.getHandPosition(),0,this.height,t.getPosition(),t.getRadius(),t.getHeight())}}class hc extends _e{constructor(){super(),this.radius=0,this.height=1,this.hovered=!1,this.onEnterBlockId="",this.onLeaveBlockId="",this.onActionBlockId=""}async loadFromData(t){this.position[0]=t.PositionX,this.position[1]=t.PositionY,this.position[2]=t.PositionZ,this.radius=t.Radius,this.onEnterBlockId=t.OnEnterBlockId,this.onLeaveBlockId=t.OnLeaveBlockId,this.onActionBlockId=t.OnActionBlockId}draw(){Jt.drawSphere(this.getTransformMatrix(),this.radius,2)}getRadius(){return this.radius}getHeight(){return this.height}isHovered(){return this.hovered}setHovered(t){this.hovered=t}getOnEnterBlockId(){return this.onEnterBlockId}getOnLeaveBlockId(){return this.onLeaveBlockId}getOnActionBlockId(){return this.onActionBlockId}}class $r{constructor(t){this.target=null,this.minClipOffset=[0,0],this.maxClipOffset=[0,0],this.view=k.getView(t),this.view.setProjectionMode(ir.PERSPECTIVE)}async loadFromData(t){this.minClipOffset[0]=t.MinClipOffsetX,this.minClipOffset[1]=t.MinClipOffsetY,this.maxClipOffset[0]=t.MaxClipOffsetX,this.maxClipOffset[1]=t.MaxClipOffsetY,this.view.setCameraMatrix(t.Matrix),this.view.setPerspectiveFovy(f.DEG_TO_RAD(parseInt(t.Fovy)))}update(t){if(!this.target)return;let e=this.view.getClipOffset(),s=this.target.getPosition(),i=this.view.getScreenNormalizedPosition(s[0],s[1],s[2]);this.view.setClipOffset(f.CLAMP(i[0]+e[0],this.minClipOffset[0],this.maxClipOffset[0]),f.CLAMP(i[1]+e[1],this.minClipOffset[1],this.maxClipOffset[1]))}setTarget(t){this.target=t}}const Ri=3;class lc{constructor(){this.name="",this.description="",this.map=new ft,this.walkmesh=new ps,this.controller=new Kr,this.controllerWalker={},this.camera=new $r(0),this.scriptMachine=new Ls,this.spawns=[],this.models=[],this.motions=[],this.triggers=[],this.pause=!1,this.motionModelMapping=new Map,this.scriptMachine.registerCommand("LOAD_ROOM",this.#t.bind(this)),this.scriptMachine.registerCommand("CONTINUE",this.#e.bind(this)),this.scriptMachine.registerCommand("STOP",this.#s.bind(this)),this.scriptMachine.registerCommand("UI_CREATE_CHOICES",this.#i.bind(this)),this.scriptMachine.registerCommand("UI_CREATE_DIALOG",this.#r.bind(this)),this.scriptMachine.registerCommand("MODEL_PLAY_MOTION",this.#n.bind(this)),this.scriptMachine.registerCommand("MODEL_PLAY_ANIMATION",this.#o.bind(this)),v.subscribe(Q,"E_ACTION_ONCE",this,this.handleActionOnce),v.subscribe(this.controller,"E_MOVED",this,this.handleControllerMoved)}async loadFromFile(t,e){let i=await(await fetch(t)).json();this.name=i.Name,this.description=i.Description,this.map=new ft,await this.map.loadFromFile(i.MapFile),this.map.setMaterial(new vt({texture:await st.loadTexture(i.MapTextureFile,{minFilter:"nearest",magFilter:"nearest"})})),this.walkmesh=new ps,await this.walkmesh.loadFromFile(i.WalkmeshFile),await this.controller.loadFromData(i.Controller),this.camera=new $r(0),await this.camera.loadFromData(i.Camera),this.camera.setTarget(this.controller),this.spawns=[];for(let n of i.Spawns){let o=new ac;await o.loadFromData(n),this.spawns.push(o)}this.models=[];for(let n of i.Models){let o=new Kr;await o.loadFromData(n),this.models.push(o)}this.motions=[];for(let n of i.Motions){const o=new Pe;o.setSpeed(Ri),o.setPoints(n.Points),this.motions.push(o)}this.triggers=[];for(let n of i.Triggers){let o=new hc;await o.loadFromData(n),this.triggers.push(o)}let r=this.spawns.find(n=>n.getName()==e);this.controller.setPosition(r.getPositionX(),r.getPositionY(),r.getPositionZ()),this.controller.setRotation(0,f.VEC2_ANGLE(r.getDirection()),0),this.controllerWalker=this.walkmesh.addWalker("CONTROLLER",this.controller.getPositionX(),this.controller.getPositionZ(),this.controller.getRadius()),await this.scriptMachine.loadFromFile(i.ScriptFile),this.scriptMachine.jump("ON_INIT"),this.scriptMachine.setEnabled(!0),this.motionModelMapping.clear()}delete(){for(const t of this.models)t.delete();v.unsubscribe(Q,"E_ACTION_ONCE",this),v.unsubscribe(this.controller,"E_MOVED",this)}update(t){let e=!1,s=f.VEC3_ZERO;if(Q.isActiveAction("LEFT")&&(s=f.VEC3_ADD(s,f.VEC3_LEFT),e=!0),Q.isActiveAction("RIGHT")&&(s=f.VEC3_ADD(s,f.VEC3_RIGHT),e=!0),Q.isActiveAction("UP")&&(s=f.VEC3_ADD(s,f.VEC3_FORWARD),e=!0),Q.isActiveAction("DOWN")&&(s=f.VEC3_ADD(s,f.VEC3_BACKWARD),e=!0),e&&!this.pause){s=f.VEC3_NORMALIZE(s);const i=s[0]*Ri*(t/1e3),r=s[2]*Ri*(t/1e3);this.controller.move(i,r,!0),this.controller.play("RUN")}else this.controller.play("IDLE");this.map.update(t),this.walkmesh.update(t),this.controller.update(t),this.camera.update(t),this.scriptMachine.update(t);for(let i of this.models)i.update(t);for(const[i,r]of this.motionModelMapping.entries()){let n=this.motions[i],o=this.models[r];o.setPosition(n.getCurrentPositionX(),n.getCurrentPositionY(),n.getCurrentPositionZ()),o.setRotation(0,n.getCurrentRotationY(),0),n.update(t)}}draw(){this.map.draw(),this.walkmesh.draw(),this.controller.draw();for(let t of this.spawns)t.draw();for(let t of this.models)t.draw();for(let t of this.triggers)t.draw()}handleActionOnce(t){if(!(t.actionId!="OK"||this.pause)){for(let e of this.triggers)if(this.controller.isCollide(e)&&e.getOnActionBlockId()){this.scriptMachine.jump(e.getOnActionBlockId());return}for(let e of this.models)if(this.controller.isHandCollide(e)&&e.getOnActionBlockId()){this.scriptMachine.jump(e.getOnActionBlockId());return}}}handleControllerMoved({old:t,moveX:e,moveZ:s}){for(let n of this.models){let o=[];if(this.controller.isCollide(n,o)){e+=o[0],s+=o[1];break}}let i=this.walkmesh.moveWalker(this.controllerWalker,e,s),r=f.VEC3_ADD(t,i.move);this.controller.setPosition(r[0],r[1],r[2]);for(let n of this.triggers){let o=this.controller.isCollide(n);n.getOnEnterBlockId()&&!n.isHovered()&&o?(this.scriptMachine.jump(n.getOnEnterBlockId()),n.setHovered(!0)):n.getOnLeaveBlockId()&&n.isHovered()&&!o&&(this.scriptMachine.jump(n.getOnLeaveBlockId()),n.setHovered(!1))}}async#t(t,e){this.pause=!0,await this.loadFromFile(t,e),this.pause=!1}#e(){this.pause=!1}#s(){this.pause=!0}async#i(t,e,s=[]){this.scriptMachine.setEnabled(!1);let i=new li;i.setAuthor(t),i.setText(e),P.addWidget(i),await v.wait(i,"E_PRINT_FINISHED");let r=new Yt;P.addWidget(r,"position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); z-index:12");for(let o of s)r.add(0,o.Text);P.focus(r);let n=await v.wait(r,"E_ITEM_SELECTED");P.removeWidget(i),P.removeWidget(r),this.scriptMachine.jump(s[n.index].Jumpto),this.scriptMachine.setEnabled(!0)}async#r(t,e){this.scriptMachine.setEnabled(!1);let s=new li;s.setAuthor(t),s.setText(e),P.addWidget(s),P.focus(s),await v.wait(s,"E_OK"),P.removeWidget(s),this.scriptMachine.setEnabled(!0)}async#n(t,e){this.scriptMachine.setEnabled(!1),this.motionModelMapping.set(t,e),this.motions[t].run(),await v.wait(this.motions[t],"E_FINISHED"),this.motionModelMapping.delete(t),this.scriptMachine.setEnabled(!0)}#o(t,e,s){this.models[t].play(e)}}class cc extends yt{constructor(){super(),this.room=new lc}async onEnter(){await this.room.loadFromFile("./templates/prerendered/scene.room","Spawn0000")}update(t){this.room.update(t)}draw(){this.room.draw()}}let uc=class{constructor(t){this.map=t,this.modifiers=[]}get(t){if(!this.map.hasOwnProperty(t))return;let e=this.map[t];for(let s of this.modifiers)s.getAttributeKey()==t&&s.getType()=="MUL"&&(e*=s.getValue());for(let s of this.modifiers)s.getAttributeKey()==t&&s.getType()=="ADD"&&(e+=s.getValue());for(let s of this.modifiers)s.getAttributeKey()==t&&s.getType()=="SUB"&&(e-=s.getValue());for(let s of this.modifiers)s.getAttributeKey()==t&&s.getType()=="SET"&&(e=s.getValue());for(let s of this.modifiers)s.getAttributeKey()==t&&s.getType()=="FIN"&&(e=s.getValue());return e<0&&(e=0),this.map.hasOwnProperty(t+"_MIN")&&(e=Math.max(e,this.map[t+"_MIN"])),this.map.hasOwnProperty(t+"_MAX")&&(e=Math.min(e,this.map[t+"_MAX"])),e}getBase(t){if(this.map.hasOwnProperty(t))return this.map[t]}set(t,e){this.map.hasOwnProperty(t)&&(e<0&&(e=0),this.map.hasOwnProperty(t+"_MIN")&&(e=Math.max(e,this.map[t+"_MIN"])),this.map.hasOwnProperty(t+"_MAX")&&(e=Math.min(e,this.map[t+"_MAX"])),this.map[t]=e)}add(t,e){this.set(t,this.getBase(t)+e)}has(t){return this.map.hasOwnProperty(t)}addModifier(t){this.modifiers.push(t)}removeModifier(t){this.modifiers.splice(this.modifiers.indexOf(t),1)}addModifiers(t){for(let e of t)this.modifiers.push(e)}removeModifiers(t){for(let e of t)this.modifiers.splice(this.modifiers.indexOf(e),1)}clearModifiers(){for(;this.modifiers.length;)this.modifiers.pop()}},es={};es.IS_ALL=function(h,t,e){return!0};es.IS_SELF=function(h,t,e){return h==t};es.IS_ALLY=function(h,t,e){return h.constructor.name==t.constructor.name};es.IS_ALIVE_ALLY=function(h,t,e){return t.getAttribute("HP")>0&&h.constructor.name==t.constructor.name};es.IS_OPPONENT=function(h,t,e){return h.constructor.name!=t.constructor.name};es.IS_ALIVE_OPPONENT=function(h,t,e){return t.getAttribute("HP")>0&&h.constructor.name!=t.constructor.name};function dc(h,t,e,s={}){return h==""?!0:es[h](t,e,s)}let co=class{constructor(t){this.type="",this.attributeKey="",this.value=0,t.hasOwnProperty("Type")&&(t.Type=="MUL"||t.Type=="ADD"||t.Type=="SUB"||t.Type=="SET"||t.Type=="FIN")&&t.hasOwnProperty("AttributeKey")&&t.hasOwnProperty("Value")&&(this.type=t.Type,this.attributeKey=t.AttributeKey,this.value=t.Value)}getType(){return this.type}getAttributeKey(){return this.attributeKey}getValue(){return this.value}};class pc{constructor(){this.id="",this.name="",this.description="",this.iconFile="",this.stackable=!1,this.numTurns=0,this.onTurnEffect=null,this.modifiers=[],this.turnCount=0,this.fromChar=null}async loadFromData(t){this.id=t.Id,this.name=t.Name,this.description=t.Description,this.iconFile=t.IconFile,this.stackable=t.Stackable,this.numTurns=t.NumTurns,t.OnTurnEffect&&(this.onTurnEffect=new Fs,this.onTurnEffect.loadFromData(t.OnTurnEffect));for(let e of t.Modifiers)this.modifiers.push(new co(e))}async loadFromFile(t){let e=await fetch(t);await this.loadFromData(await e.json())}getId(){return this.id}getName(){return this.name}getDescription(){return this.description}getIconFile(){return this.iconFile}getStackable(){return this.stackable}getNumTurns(){return this.numTurns}getOnTurnEffect(){return this.onTurnEffect}getModifiers(){return this.modifiers}getTurnCount(){return this.turnCount}incTurnCount(){this.turnCount++}getFromChar(){return this.fromChar}}let ss={};ss.RESTORE=async function(h,t,e={amount,element}){await t.increaseHP(e.amount,e.element)};ss.DAMAGE=async function(h,t,e={amount,element}){await t.decreaseHP(e.amount,e.element)};ss.INCREASE_MANA=async function(h,t,e={amount}){await t.increaseHP(e.amount)};ss.DECREASE_MANA=async function(h,t,e={amount}){await t.decreaseHP(e.amount)};ss.ADD_SEAL=async function(h,t,e={sealId}){let s=pc.createFromFile("templates/rpg/data/"+e.sealId+"/data.json");s.fromChar=h,await t.addSeal(s)};ss.REMOVE_SEAL=async function(h,t,e={sealId}){for(let s of t.getActiveSeals())s.getId()==sealId&&await t.removeSeal(s)};function fc(h,t,e,s={}){return h==""?!0:ss[h](t,e,s)}let Xs={ALL:"ALL",MENU:"MENU",BATTLE:"BATTLE"},Te={POTION:"POTION",FOOD:"FOOD",WEAPON:"WEAPON",HELMET:"HELMET",ARMOR:"ARMOR",RELIC:"RELIC",OTHER:"OTHER"};let Fe={RED:"RED",BLUE:"BLUE",BLACK:"BLACK",WHITE:"WHITE"},Fs=class{constructor(){this.id="",this.name="",this.description="",this.cost=0,this.spriteAnimationName="",this.availabilityType="",this.mechanicId="",this.mechanicOpts={},this.targetCharConditionId="",this.targetCharConditionOpts={}}async loadFromData(t){this.id=t.Id,this.name=t.Name,this.description=t.Description,this.cost=t.Cost,this.spriteAnimationName=t.SpriteAnimationName,this.availabilityType=t.AvailabilityType,this.mechanicId=t.MechanicId,this.mechanicOpts=t.MechanicOpts,this.targetCharConditionId=t.TargetCharConditionId,this.targetCharConditionOpts=t.TargetCharConditionOpts}async loadFromFile(t){let e=await fetch(t);await this.loadFromData(await e.json())}isMenuAvailable(){return this.availabilityType==Xs.ALL||this.availabilityType==Xs.MENU}isBattleAvailable(){return this.availabilityType==Xs.ALL||this.availabilityType==Xs.BATTLE}isUsable(t){return this.cost<=t.getAttribute("MP")}isTargetCharConditionCheck(t,e){return dc(this.targetCharConditionId,t,e,this.targetCharConditionOpts)}async apply(t,e){await v.emitAsync(e,"E_EFFECT_INFLICT",{effect:this}),await fc(this.mechanicId,t,e,this.mechanicOpts)}getId(){return this.id}getName(){return this.name}getDescription(){return this.description}getCost(){return this.cost}getSpriteAnimationName(){return this.spriteAnimationName}getAvailabilityType(){return this.availabilityType}getMechanicId(){return this.mechanicId}getMechanicOpts(){return this.mechanicOpts}getTargetCharConditionId(){return this.targetCharConditionId}getTargetCharConditionOpts(){return this.targetCharConditionOpts}};class uo{constructor(){this.id="",this.type="",this.name="",this.description="",this.pictureFile="",this.jasFile="",this.jasImageFile="",this.attributes,this.attackEffects=[],this.magicEffects=[],this.activeSeals=[],this.ready=!1}async loadFromData(t){this.id=t.Id,this.type=t.Type,this.name=t.Name,this.description=t.Description,this.pictureFile=t.PictureFile,this.jamFile=t.JAMFile,this.jamTextureFile=t.JAMTextureFile,this.attributes=new uc(t.Attributes);for(let e of t.AttackEffectIds){let s=new Fs;await s.loadFromFile("templates/rpg/data/effect_"+e+"/data.json"),this.attackEffects.push(s)}for(let e of t.MagicEffectIds){let s=new Fs;await s.loadFromFile("templates/rpg/data/effect_"+e+"/data.json"),this.magicEffects.push(s)}}async addSeal(t){if(!t.stackable&&this.activeSeals.find(e=>e.id==t.id))return v.emit(this,"E_SEAL_ADD_FAILED");this.attributes.addModifiers(t.modifiers),this.activeSeals.push(t),await v.emitAsync(this,"E_SEAL_ADDED")}async removeSeal(t){if(!this.activeSeals.find(e=>e==t))return v.emit(this,"E_SEAL_REMOVE_FAILED");this.attributes.removeModifiers(t.modifiers),this.activeSeals.splice(this.activeSeals.indexOf(t),1),await v.emitAsync(this,"E_SEAL_REMOVED")}async increaseHP(t,e=null){let s=Jr(e,this.attributes.get("ELEMENT"));t=e?t*s:t,this.attributes.add("HP",+t),await v.emitAsync(this,"E_INCREASE_HP",{amount:t})}async decreaseHP(t,e=null){let s=Jr(e,this.attributes.get("ELEMENT"));t=e?t*s:t,this.attributes.add("HP",-t),await v.emitAsync(this,"E_DECREASE_HP",{amount:t})}async increaseMP(t){this.attributes.add("MP",+t),await v.emitAsync(this,"E_INCREASE_MP",{amount:t})}async decreaseMP(t){this.attributes.add("MP",-t),await v.emitAsync(this,"E_DECREASE_MP",{amount:t})}getId(){return this.id}getType(){return this.type}getName(){return this.name}getDescription(){return this.description}getPictureFile(){return this.pictureFile}getJAMFile(){return this.jamFile}getJAMTextureFile(){return this.jamTextureFile}getAttributes(){return this.attributes}getAttribute(t){return this.attributes.get(t)}getAttackEffects(){return this.attackEffects}getMagicEffects(){return this.magicEffects}getActiveSeals(){return this.activeSeals}setReady(t){this.ready=t}isReady(){return this.ready}}function Jr(h,t){return h==Fe.RED&&t==Fe.BLUE||h==Fe.BLUE&&t==Fe.RED||h==Fe.BLACK&&t==Fe.WHITE||h==Fe.WHITE&&t==Fe.BLACK?2:1}class mc{constructor(){this.level=1,this.attributeMap={}}}class gc{constructor(){this.id="",this.name="",this.promotions=[]}async loadFromData(t){t.hasOwnProperty("Effect")&&(this.effect=new Effect,await this.effect.loadFromData(t.Effect)),this.id=t.Id,this.name=t.Name,this.promotions=[];for(let e of t.Promotions){let s=new mc;s.level=e.Level,s.attributeMap=e.AttributeMap,this.promotions.push(s)}}async loadFromFile(t){let e=await fetch(t);await this.loadFromData(await e.json())}applyPromotion(t,e){let s=this.promotions.find(r=>r.level==e);if(!s)throw new Error("Cast::applyPromotion(): Level not exist !");let i=t.getAttributes();for(let r in s.attributeMap)i.add(r,s.attributeMap[r])}}class po{constructor(){this.id="",this.type="",this.name="",this.description="",this.pictureFile="",this.soldable=!0,this.price=0,this.quantity=1}async loadFromData(t){this.id=t.Id,this.type=t.Type,this.name=t.Name,this.description=t.Description,this.pictureFile=t.PictureFile,this.soldable=t.Soldable,this.price=t.Price}getId(){return this.id}getType(){return this.type}getName(){return this.name}getDescription(){return this.description}getPictureFile(){return this.pictureFile}getSoldable(){return this.soldable}getPrice(){return this.price}getQuantity(){return this.quantity}setQuantity(t){this.quantity=t}}class ce extends po{constructor(){super(),this.subType="",this.modifiers=[]}async loadFromData(t){this.subType=t.SubType;for(let e of t.Modifiers)this.modifiers.push(new co(e));super.loadFromData(t)}async loadFromFile(t){let e=await fetch(t);await this.loadFromData(await e.json())}getSubType(){return this.subType}getModifiers(){return this.modifiers}}class Xi extends uo{constructor(){super(),this.weapon=null,this.helmet=null,this.armor=null,this.relic=null,this.allowedEquipmentItemSubTypes=[],this.cast=new gc}async loadFromData(t){if(t.WeaponId){let e=new ce;await e.loadFromFile("templates/rpg/data/"+t.WeaponId+"/data.json"),this.setEquipment(e)}if(t.HelmetId){let e=new ce;await e.loadFromFile("templates/rpg/data/"+t.HelmetId+"/data.json"),this.setEquipment(e)}if(t.ArmorId){let e=new ce;await e.loadFromFile("templates/rpg/data/"+t.ArmorId+"/data.json"),this.setEquipment(e)}if(t.RelicId){let e=new ce;await e.loadFromFile("templates/rpg/data/"+t.RelicId+"/data.json"),this.setEquipment(e)}for(let e of t.AllowedEquipmentItemSubTypes)this.allowedEquipmentItemSubTypes.push(e);this.cast.loadFromFile("templates/rpg/data/cast_"+t.CastId+"/data.json"),super.loadFromData(t)}async loadFromFile(t){let e=await fetch(t);await this.loadFromData(await e.json())}getWeapon(){return this.weapon}getHelmet(){return this.helmet}getArmor(){return this.armor}getRelic(){return this.relic}getAllowedEquipmentItemSubTypes(){return this.allowedEquipmentItemSubTypes}getCast(){return this.cast}isEquipableItem(t){return t instanceof ce&&this.allowedEquipmentItemSubTypes.includes(t.getSubType())}getAttributesWith(t){let e={},s=this.setEquipment(t);for(let i in this.attributes.map)e[i]=this.attributes.get(i);return s?this.setEquipment(s):this.removeEquipment(t),e}setEquipment(t){let e=null;return t.type==Te.WEAPON?(e=this.weapon,this.weapon=t):t.type==Te.HELMET?(e=this.helmet,this.helmet=t):t.type==Te.ARMOR?(e=this.armor,this.armor=t):t.type==Te.RELIC&&(e=this.relic,this.relic=t),e&&this.attributes.removeModifiers(e.getModifiers()),this.attributes.addModifiers(t.getModifiers()),e}removeEquipment(t){return t==this.weapon?(this.attributes.removeModifiers(this.weapon.getModifiers()),this.weapon=null,!0):t==this.helmet?(this.attributes.removeModifiers(this.helmet.getModifiers()),this.helmet=null,!0):t==this.armor?(this.attributes.removeModifiers(this.armor.getModifiers()),this.armor=null,!0):t==this.relic?(this.attributes.removeModifiers(this.relic.getModifiers()),this.relic=null,!0):!1}}class Ie{items;constructor(t=[]){this.items=t}getItems(){return this.items}push(t,e=!1){const s=this.items.push(t);return e&&v.emit(this,"E_ITEM_ADDED",{item:t,index:this.items.indexOf(t)}),s}pop(t=!1){const e=this.items.pop();return t&&v.emit(this,"E_ITEM_REMOVED",{item:e,index:this.items.length}),e}remove(t,e=!1){const s=this.items.indexOf(t);return this.items.splice(s,1),e&&v.emit(this,"E_ITEM_REMOVED",{item:t,index:s}),s}removeAt(t,e=!1){const s=this.items.splice(t,1);return e&&v.emit(this,"E_ITEM_REMOVED",{item:s,index:t}),s}has(t){return this.items.indexOf(t)!=-1}clear(){for(;this.items.length;)this.items.pop()}}class Me extends po{constructor(){super(),this.effect=null}async loadFromData(t){t.hasOwnProperty("Effect")&&(this.effect=new Fs,await this.effect.loadFromData(t.Effect)),super.loadFromData(t)}async loadFromFile(t){let e=await fetch(t);await this.loadFromData(await e.json())}apply(t,e){this.effect.apply(t,e)}isMenuAvailable(){return this.effect&&this.effect.isMenuAvailable()}isTarget(t,e){return this.effect&&this.effect.isTargetCharConditionCheck(t,e)}hasEffect(){return!!this.effect}getEffect(){return this.effect}}const Ec=99;class fo extends Ie{constructor(){super()}async loadFromData(t){for(let e of t)if(e.ItemTypeName=="CommonItem"){let s=new Me;await s.loadFromFile("templates/rpg/data/"+e.ItemId+"/data.json"),s.setQuantity(e.Quantity),this.items.push(s)}else if(e.ItemTypeName=="EquipmentItem"){let s=new ce;await s.loadFromFile("templates/rpg/data/"+e.ItemId+"/data.json"),s.setQuantity(e.Quantity),this.items.push(s)}}async loadFromFile(t){let e=await fetch(t);await this.loadFromData(await e.json())}getItemById(t){return this.items.find(e=>e.getId()==t)}findItemById(t){return this.items.findIndex(e=>e.getId()==t)}addItem(t){let e=this.items.findIndex(s=>s.getId()==t.getId());if(e!=-1){let s=this.items[e];if(s.getQuantity()+t.getQuantity()>Ec)return;s.setQuantity(s.getQuantity()+t.getQuantity())}else this.items.push(t),v.emit(this,"E_ITEM_ADDED",{item:t,index:this.items.indexOf(t)})}removeItemById(t,e=1){let s=this.items.findIndex(n=>n.getId()==t);if(s==-1)return;let i=this.items[s],r=i.getQuantity()-e;if(r==0)this.items.splice(this.items.indexOf(i),1),v.emit(this,"E_ITEM_REMOVED",{item:i,index:s});else if(r>0)i.setQuantity(r);else return;return r}hasMenuAvailableItems(){return this.items.filter(e=>e instanceof Me&&e.isMenuAvailable()).length>0}hasCommonItems(){return this.items.filter(e=>e instanceof Me).length>0}hasEquipmentItems(){return this.items.filter(e=>e instanceof ce).length>0}isEmpty(){return this.items.length==0}}let Cc=class{constructor(){this.gils=0,this.inventory=null,this.heroes=[],this.variants={}}async loadFromData(t){this.gils=t.Gils,this.inventory=new fo,this.inventory.loadFromData(t.Inventory);for(let e of t.Heroes){let s=new Xi;s.loadFromData(e),this.heroes.push(s)}for(let e in t.Variants)this.addVariant(e,t.Variants[e])}async loadFromFile(t){let e=await fetch(t);await this.loadFromData(await e.json())}increaseGils(t){this.gils+=t,v.emit(this,"E_GILS_CHANGED",{gils:this.gils})}decreaseGils(t){if(this.gils-t<0)throw new Error("Player::decreaseGils(): gils cannot be negative !");this.gils-=t,v.emit(this,"E_GILS_CHANGED",{gils:this.gils})}addVariant(t,e){if(this.variants.hasOwnProperty(t))throw new Error("Player::addVariant: varloc already exist in variants dictionnary");this.variants[t]=e}removeVariant(t){if(!this.variants.hasOwnProperty(t))throw new Error("Player::removeVariant: varloc not exist in variants dictionnary");delete this.variants[t]}setVariant(t,e){if(!this.variants.hasOwnProperty(t))throw new Error("Player::setVariant: varloc not exist in variants dictionnary");this.variants[t]=e}hasVariant(t){return this.variants.hasOwnProperty(t)}getVariant(t){if(!this.variants.hasOwnProperty(t))throw new Error("Player::getVariant: varloc not exist in variants dictionnary");return this.variants[t]}getGils(){return this.gils}getInventory(){return this.inventory}getHeroes(){return this.heroes}};class Tc{constructor(){this.then=0,this.player=new Cc}async init(){await this.player.loadFromFile("templates/rpg/data/player.json")}getPlayer(){return this.player}}const is=new Tc;class ae extends xt{constructor(){super({className:"UIText",template:'<span class="UIText-text js-text"></span>'})}setText(t){this.node.querySelector(".js-text").textContent=t}}let fr={};fr.SELF_HAS_LOWER_HP=function(h,t,e){return t.getAttribute("HP")/t.getAttribute("HP_MAX")*100<e.number};fr.ALLY_HAS_LOWER_HP=function(h,t,e){for(let s of h.getEnemies()){let i=s.getAttribute("HP")/s.getAttribute("HP_MAX")*100;if(s!=t&&i!=0&&i<e.number)return!0}return!1};function yc(h,t,e,s={}){return h==""?!0:fr[h](t,e,s)}let mr={};mr.LOWEST_HP=function(h,t){return h.getAttribute("HP")-t.getAttribute("HP")};mr.HIGHEST_HP=function(h,t){return t.getAttribute("HP")-h.getAttribute("HP")};function Ac(h,t){return h==""?t.sort((e,s)=>e.getId()-s.getId()):t.sort((e,s)=>mr[h](e,s))}class Qr extends uo{constructor(){super(),this.gils=0,this.patterns=[],this.position=[0,0,0]}async loadFromData(t){this.gils=t.Gils;for(let e of t.Patterns){let s=new wc;await s.loadFromData(e),this.patterns.push(s)}await super.loadFromData(t)}async loadFromFile(t){let e=await fetch(t);await this.loadFromData(await e.json())}getGils(){return this.gils}getPatterns(){return this.patterns}getPosition(){return this.position}setPosition(t){this.position=t}}class wc{constructor(){this.name="",this.effect=null,this.priority=0,this.conditionId="",this.conditionOpts={},this.targetCharSortId=""}async loadFromData(t){this.name=t.Name,this.effect=new Fs,await this.effect.loadFromFile("templates/rpg/data/effect_"+t.EffectId+"/data.json"),this.priority=t.Priority,this.conditionId=t.ConditionId,this.conditionOpts=t.ConditionOpts,this.targetCharSortId=t.TargetCharSortId}isConditionCheck(t,e){return yc(this.conditionId,t,e,this.conditionOpts)}targetCharSort(t){return Ac(this.targetCharSortId,t)}}let yi=class{constructor(t){this.battle=t}async exec(){}};class ti extends yi{constructor(t,e){super(t),this.fromChar=e}async exec(){await this.battle.operationLet(this.fromChar)}}class mo extends yi{constructor(t,e,s,i){super(t),this.effect=e,this.fromChar=s,this.toChar=i}async exec(){await this.battle.operationApplyEffect(this.effect,this.fromChar,this.toChar)}}class xc extends yi{constructor(t,e,s,i){super(t),this.item=e,this.fromChar=s,this.toChar=i}async exec(){await this.battle.operationApplyItem(this.item,this.fromChar,this.toChar)}}class ci extends yi{constructor(t){super(t)}async exec(){await this.battle.operationNewTurn()}}let vc={NORMAL:"N",A_FIRST:"A",E_FIRST:"E",E_TRAP:"T"};class Ic{constructor(){this.backgroundImage="",this.jsmFile="",this.jsmTextureFile="",this.cameraPosition=[0,0,0],this.cameraLookAt=[0,0,0],this.enemies=[],this.player=is.getPlayer(),this.heroes=this.player.getHeroes(),this.formationType=vc.NORMAL,this.numTurns=0,this.characterQueue=[]}async loadFromData(t){this.backgroundImage=t.BackgroundImage,this.jsmFile=t.JSMFile,this.jsmTextureFile=t.JSMTextureFile,this.cameraPosition=t.CameraPosition,this.cameraLookAt=t.CameraLookAt;for(let e of t.Enemies){let s=new Qr;await s.loadFromFile("templates/rpg/data/enemy_"+e.EnemyId+"/data.json"),s.setPosition(e.Position),this.enemies.push(s)}}async loadFromFile(t){let e=await fetch(t);await this.loadFromData(await e.json())}startup(){this.runAction(new ci(this))}async runAction(t){await v.emitAsync(this,"E_ACTION_BEFORE",{action:t}),await t.exec(),await v.emitAsync(this,"E_ACTION_AFTER",{action:t});for(let r of this.characterQueue)r.getAttribute("HP")==0&&this.characterQueue.splice(this.characterQueue.indexOf(r),1);if(this.heroes.reduce((r,n)=>r+n.getAttribute("HP"),0)==0)return v.emit(this,"E_LOST");if(this.enemies.reduce((r,n)=>r+n.getAttribute("HP"),0)==0)return v.emit(this,"E_WIN");if(this.characterQueue.length==0)return this.runAction(new ci(this));let i=this.characterQueue.filter(r=>r.isReady());if(i.length==0){let r=0;for(;r<this.characterQueue.length&&this.characterQueue[0].getType()==this.characterQueue[r].getType();)i.push(this.characterQueue[r]),this.characterQueue[r].setReady(!0),r++}await v.emitAsync(this,"E_CHAR_READY",{char:i[0]}),i[0]instanceof Qr&&this.handleAI()}async operationNewTurn(){let t=[...this.heroes,...this.enemies];t=t.sort((e,s)=>s.getAttribute("AGILITY")-e.getAttribute("AGILITY")),t=t.filter(e=>e.getAttribute("HP")>0);for(let e of t){for(let s of e.getActiveSeals())s.incTurnCount(),s.getOnTurnEffect()&&await s.getOnTurnEffect().apply(s.getFromChar(),e),s.getTurnCount()==s.getNumTurns()&&e.removeSeal(s);e.setReady(!1)}this.numTurns++,this.characterQueue=t,v.emit(this,"E_NEW_TURN")}async operationLet(t){t.setReady(!1),this.characterQueue.splice(this.characterQueue.indexOf(t),1)}async operationApplyEffect(t,e,s){await t.apply(e,s),e.getAttributes().add("MP",-t.getCost()),e.setReady(!1),this.characterQueue.splice(this.characterQueue.indexOf(e),1)}async operationApplyItem(t,e,s){let i=this.player.getInventory();await t.getEffect().apply(e,s),i.removeItemById(t.getId()),e.setReady(!1),this.characterQueue.splice(this.characterQueue.indexOf(e),1)}handleAI(){let t=this.characterQueue[0],e=[...this.heroes,...this.enemies],i=t.patterns.sort((o,a)=>o.priority-a.priority).filter(o=>o.isConditionCheck(this,t)),r=null,n=null;i.length==0&&(i=t.patterns);for(let o of i){let a=e.filter(l=>o.effect.isTargetCharConditionCheck(t,l));if(a.length>0){r=o.effect,n=o.targetCharSort(a)[0];break}}r&&n?this.runAction(new mo(this,r,t,n)):this.runAction(new ti(this,t))}getBackgroundImage(){return this.backgroundImage}getJSMFile(){return this.jsmFile}getJSMTextureFile(){return this.jsmTextureFile}getCameraPosition(){return this.cameraPosition}getCameraLookAt(){return this.cameraLookAt}getEnemies(){return this.enemies}getHeroes(){return this.heroes}getFormationType(){return this.formationType}getNumTurns(){return this.numTurns}getCharacterQueue(){return this.characterQueue}}class js extends ms{collection;views;sortPredicate;filterPredicate;enablePredicate;constructor(t={}){super(t),this.collection=new Ie,this.views=[],this.sortPredicate=()=>1,this.filterPredicate=()=>!0,this.enablePredicate=()=>!0}delete(){v.unsubscribe(this.collection,"E_ITEM_ADDED",this),v.unsubscribe(this.collection,"E_ITEM_REMOVED",this),super.delete()}setCollection(t){if(v.unsubscribe(this.collection,"E_ITEM_ADDED",this),v.unsubscribe(this.collection,"E_ITEM_REMOVED",this),this.clear(),t){const s=t.getItems().sort(this.sortPredicate).filter(this.filterPredicate);s.forEach(i=>this.addItem(i,this.enablePredicate(i))),v.subscribe(t,"E_ITEM_ADDED",this,this.#t),v.subscribe(t,"E_ITEM_REMOVED",this,this.#e),this.collection=t,this.views=s}else this.collection=new Ie,this.views=[]}addItem(t,e=!0,s=-1){}getFocusedItem(){return this.views[this.getFocusedWidgetIndex()]}getSelectedItem(){return this.views[this.getSelectedWidgetIndex()]}setSortPredicate(t){if(this.collection){const e=this.collection.getItems();this.views=e.sort(t).filter(this.filterPredicate),this.clear(),this.views.forEach(s=>this.addItem(s,this.enablePredicate(s)))}this.sortPredicate=t}setFilterPredicate(t){if(this.collection){const e=this.collection.getItems();this.views=e.sort(this.sortPredicate).filter(t),this.clear(),this.views.forEach(s=>this.addItem(s,this.enablePredicate(s)))}this.filterPredicate=t}setEnablePredicate(t){if(this.collection){const e=this.collection.getItems();this.views=e.sort(this.sortPredicate).filter(this.filterPredicate),this.clear(),this.views.forEach(s=>this.addItem(s,t(s)))}this.enablePredicate=t}getViews(){return this.views}#t(t){const e=this.collection.getItems();this.views=e.sort(this.sortPredicate).filter(this.filterPredicate);const s=this.views.indexOf(t.item);this.addItem(t.item,this.enablePredicate(t.item),s)}#e(t){const e=this.views.indexOf(t.item);this.removeWidget(e);const s=this.collection.getItems();this.views=s.sort(this.sortPredicate).filter(this.filterPredicate)}}class Ai extends js{constructor(t={}){super(),this.showPrice=t.showPrice??!0,this.showQuantity=t.showQuantity??!0}addItem(t,e=!0,s=-1){let i=new Sc;i.setShowPrice(this.showPrice),i.setShowQuantity(this.showQuantity),i.setItem(t),this.addWidget(i,e,s)}}class Sc extends xt{constructor(){super({className:"UIInventoryItem",template:`
      <span class="UIInventoryItem-name js-name"></span>
      <span class="UIInventoryItem-quantity js-quantity"></span>
      <span class="UIInventoryItem-price js-price"></span>`}),this.item=null,this.showPrice=!0,this.showQuantity=!0}update(t){this.item?(this.node.querySelector(".js-name").textContent=this.item.getName(),this.node.querySelector(".js-price").style.display=this.showPrice?"block":"none",this.node.querySelector(".js-price").textContent=this.item.price,this.node.querySelector(".js-quantity").style.display=this.showQuantity?"block":"none",this.node.querySelector(".js-quantity").textContent=this.item.quantity):(this.node.querySelector(".js-name").textContent="--",this.node.querySelector(".js-price").textContent="--",this.node.querySelector(".js-quantity").textContent="--")}getItem(){return this.item}setItem(t){this.item=t||null}setShowPrice(t){this.showPrice=t}setShowQuantity(t){this.showQuantity=t}}class _c extends js{constructor(){super()}addItem(t,e=!0,s=-1){let i=new bc;i.setEffect(t),this.addWidget(i,e,s)}}class bc extends xt{constructor(){super({className:"UIEffectsItem",template:`
      <span class="UIEffectsItem-name js-name"></span>`}),this.effect=null}update(t){this.effect?this.node.querySelector(".js-name").textContent=this.effect.getName():this.node.querySelector(".js-name").textContent="--"}getEffect(){return this.effect}setEffect(t){this.effect=t||null}}class Mc extends js{constructor(){super({axis:Ts.X})}addItem(t,e=!0,s=-1){let i=new Pc;i.setHero(t),this.addWidget(i,e,s)}}class Pc extends xt{constructor(){super({className:"UIBattleHeroesItem",template:`
      <div class="UIBattleHeroesItem-body">
        <div class="UIBattleHeroesItem-body-name js-name"></div>
        <div class="UIBattleHeroesItem-body-stats">
          <div class="UIBattleHeroesItem-body-stats-item">
            <span class="UIBattleHeroesItem-body-stats-item-name">HP</span>
            <span class="UIBattleHeroesItem-body-stats-item-bar">
              <span class="UIBattleHeroesItem-body-stats-item-bar-value js-hp-value"></span>
              <span class="UIBattleHeroesItem-body-stats-item-bar-progress js-hp-bar"></span>
            </span>
          </div>
          <div class="UIBattleHeroesItem-body-stats-item">
            <span class="UIBattleHeroesItem-body-stats-item-name">MP</span>
            <span class="UIBattleHeroesItem-body-stats-item-bar">
              <span class="UIBattleHeroesItem-body-stats-item-bar-value js-mp-value"></span>
              <span class="UIBattleHeroesItem-body-stats-item-bar-progress js-mp-bar"></span>
            </span>
          </div>
        </div>
      </div>`}),this.hero=null}update(t){this.hero?(this.setEnabled(this.hero.isReady()),this.node.querySelector(".js-name").textContent=this.hero.getName(),this.node.querySelector(".js-hp-value").textContent=this.hero.getAttribute("HP")+"/"+this.hero.getAttribute("HP_MAX"),this.node.querySelector(".js-hp-bar").style.width=parseInt(this.hero.getAttribute("HP")/this.hero.getAttribute("HP_MAX")*100)+"%",this.node.querySelector(".js-mp-value").textContent=this.hero.getAttribute("MP")+"/"+this.hero.getAttribute("MP_MAX"),this.node.querySelector(".js-mp-bar").style.width=parseInt(this.hero.getAttribute("MP")/this.hero.getAttribute("MP_MAX")*100)+"%"):(this.disable(),this.node.querySelector(".js-name").textContent="--",this.node.querySelector(".js-hp-value").textContent="--/--",this.node.querySelector(".js-hp-bar").style.width="0%",this.node.querySelector(".js-mp-value").textContent="--/--",this.node.querySelector(".js-mp-bar").style.width="0%")}getHero(){return this.hero}setHero(t){this.hero=t||null}}class Rc extends xt{constructor(){super({className:"UIBattleStatus",template:`
      <div class="UIBattleStatus-numTurns">
        <div class="UIBattleStatus-numTurns-label">Turn: </div>
        <div class="UIBattleStatus-numTurns-value js-num-turns-value"></div>
      </div>
      <div class="UIBattleStatus-pictures js-pictures">
        <img class="UIBattleStatus-pictures-item js-p0" src=""/>
        <img class="UIBattleStatus-pictures-item js-p1" src=""/>
        <img class="UIBattleStatus-pictures-item js-p2" src=""/>
        <img class="UIBattleStatus-pictures-item js-p3" src=""/>
      </div>`}),this.battle=null}update(t){this.battle?this.node.querySelector(".js-num-turns-value").textContent=this.battle.getNumTurns():(this.node.querySelector(".js-num-turns-value").textContent="0",this.node.querySelector(".js-pictures").innerHTML="")}setBattle(t){t?(v.subscribe(t,"E_CHAR_READY",this,this.handleCharReady),this.battle=t):(v.unsubscribe(this.battle,"E_NEW_TURN",this),this.battle=null)}handleCharReady(){this.node.querySelector(".js-pictures").innerHTML="";for(const t of this.battle.getCharacterQueue())this.node.querySelector(".js-pictures").innerHTML+=`<img class="UIBattleStatus-pictures-item" src="${t.getPictureFile()}"/>`}}class tn extends _e{constructor(){super(),this.character=null,this.effectSprite=new fs,this.effectVisible=!1,this.mesh=new ke}delete(){this.effectSprite.delete(),this.mesh.delete()}update(t){const s=this.mesh.getBoundingBox().getSize();this.effectSprite.setPosition(this.position[0],this.position[1]+s[1]*.5,this.position[2]),this.effectSprite.update(t),this.mesh.setPosition(this.position[0],this.position[1],this.position[2]),this.mesh.setRotation(this.rotation[0],this.rotation[1],this.rotation[2]),this.mesh.update(t)}draw(){this.effectVisible&&this.effectSprite.draw(),this.mesh.draw()}async loadFromCharacter(t){v.unsubscribe(this.character,"E_EFFECT_INFLICT",this),v.unsubscribe(this.character,"E_INCREASE_HP",this),v.unsubscribe(this.character,"E_DECREASE_HP",this),v.unsubscribe(this.character,"E_INCREASE_MP",this),v.unsubscribe(this.character,"E_DECREASE_MP",this),v.unsubscribe(this.character,"E_SEAL_ADD_FAILED",this),v.unsubscribe(this.character,"E_SEAL_ADDED",this),v.unsubscribe(this.character,"E_SEAL_REMOVE_FAILED",this),v.unsubscribe(this.character,"E_SEAL_REMOVED",this),t?(v.subscribe(t,"E_EFFECT_INFLICT",this,this.handleEffectInflict),v.subscribe(t,"E_INCREASE_HP",this,this.handleCharacterIncreaseHP),v.subscribe(t,"E_DECREASE_HP",this,this.handleCharacterDecreaseHP),v.subscribe(t,"E_INCREASE_MP",this,this.handleCharacterIncreaseMP),v.subscribe(t,"E_DECREASE_MP",this,this.handleCharacterDecreaseMP),v.subscribe(t,"E_SEAL_ADD_FAILED",this,this.handleCharacterSealAddFailed),v.subscribe(t,"E_SEAL_ADDED",this,this.handleCharacterSealAdded),v.subscribe(t,"E_SEAL_REMOVE_FAILED",this,this.handleCharacterSealRemoveFailed),v.subscribe(t,"E_SEAL_REMOVED",this,this.handleCharacterSealRemoved),this.effectSprite=new fs,this.effectSprite.loadFromFile("templates/rpg/sprites/effects.jas"),this.effectSprite.setTexture(await st.loadTexture("templates/rpg/sprites/effects.png")),this.mesh=new ke,await this.mesh.loadFromFile(t.getJAMFile()),this.mesh.setMaterial(new vt({texture:await st.loadTexture(t.getJAMTextureFile())})),this.mesh.play("IDLE",!0,!0),this.character=t):this.character=null}getCharacter(){return this.character}getSize(){return this.mesh.getBoundingBox().getSize()}async handleEffectInflict(t){this.effectVisible=!0,this.effectSprite.play(t.effect.getSpriteAnimationName()),this.effectSprite.setOffsetNormalized(.5,.5),await v.wait(this.effectSprite,"E_FINISHED"),this.effectVisible=!1}async handleCharacterIncreaseHP(t){await this.DRAW_TOAST(t.amount,"#5ef500",300)}async handleCharacterDecreaseHP(t){await this.DRAW_TOAST(t.amount,"#f50000",1e3)}async handleCharacterIncreaseMP(t){await this.DRAW_TOAST("MP + "+t.amount,"#fff",300)}async handleCharacterDecreaseMP(t){await this.DRAW_TOAST("MP - "+t.amount,"#fff",300)}async handleCharacterSealAddFailed(t){await this.DRAW_TOAST("Seal add failed !","#fff",300)}async handleCharacterSealAdded(t){await this.DRAW_TOAST("Seal added !","#fff",300)}async handleCharacterSealRemoveFailed(t){await this.DRAW_TOAST("Seal remove failed !","#fff",300)}async handleCharacterSealRemoved(t){await this.DRAW_TOAST("Seal removed !","#fff",300)}DRAW_TOAST(t,e,s){return new Promise(i=>{const r=document.createElement("div");r.className="BattleAreaFighter-toast",r.textContent=t,r.style.color=e;const n=this.mesh.getPosition(),a=k.getCurrentView().getClientScreenPosition(n[0],n[1]+.8,n[2]);r.style.top=a[1]+"px",r.style.left=a[0]+"px",P.addNode(r),setTimeout(()=>{r.remove(),i()},s)})}}class Oc extends Xe{constructor(){super(0),this.timeElapsed=0,this.originPos=[0,0,0],this.originLookAt=[0,0,0],this.animationFromPos=[0,0,0],this.animationFromLookAt=[0,0,0],this.animationDestPos=[0,0,0],this.animationDestLookAt=[0,0,0],this.animationDuration=1,this.playing=!1}update(t){if(this.playing&&!f.VEC3_ISEQUAL(this.animationDestPos,this.animationFromPos))if(this.timeElapsed<this.animationDuration){const e=this.timeElapsed/this.animationDuration,s=f.VEC3_SUBSTRACT(this.animationDestPos,this.animationFromPos),i=f.VEC3_SCALE(s,.5),r=f.VEC3_ADD(this.animationFromPos,i),n=f.VEC3_CREATE(-i[2],i[1],i[0]),o=f.VEC3_ADD(r,n),a=f.VEC3_QUADRATIC_BEZIER(this.animationFromPos,o,this.animationDestPos,e),l=f.VEC3_SUBSTRACT(this.animationDestLookAt,this.animationFromLookAt),c=f.VEC3_ADD(this.animationFromLookAt,f.VEC3_SCALE(l,e));super.setPosition(a[0],a[1],a[2]),super.lookAt(c[0],c[1],c[2]),this.timeElapsed+=t}else v.emit(this,"E_FINISHED"),this.playing=!1,this.timeElapsed=0}play(t,e,s){f.VEC3_ISEQUAL(t,this.originPos)||(this.animationFromPos=this.originPos,this.animationFromLookAt=this.originLookAt,this.animationDestPos=t,this.animationDestLookAt=e,this.animationDuration=s,this.playing=!0)}playBack(t=this.animationDuration){if(f.VEC3_ISEQUAL(this.animationFromPos,this.animationDestPos))return;const e=this.animationFromPos,s=this.animationFromLookAt;this.animationFromPos=this.animationDestPos,this.animationFromLookAt=this.animationDestLookAt,this.animationDestPos=e,this.animationDestLookAt=s,this.animationDuration=t,this.playing=!0}setPosition(t,e,s){this.originPos=[t,e,s],super.setPosition(t,e,s)}setLookAt(t,e,s){this.originLookAt=[t,e,s],super.lookAt(t,e,s)}}const Dc={"1N":[[-3,0,0,0]],"2N":[[-3,0,1,0],[-3,0,-1,0]],"3N":[[-3,0,2,0],[-3,0,0,0],[-3,0,-2,0]],"4N":[[-3,0,3,0],[-3,0,1,0],[-3,0,-1,0],[-3,0,-3,0]]},Lc={"1N":[[3,0,0,Math.PI]],"2N":[[3,0,1,Math.PI],[-3,0,-1,Math.PI]],"3N":[[3,0,2,Math.PI],[-3,0,0,Math.PI],[-3,0,-2,Math.PI]],"4N":[[3,0,3,Math.PI],[-3,0,1,Math.PI],[-3,0,-1,Math.PI],[-3,0,-3,Math.PI]]},Nc=[-5,5,9],Fc=[-3,0,0],Uc=[5,5,9],Bc=[3,0,0];class Vc{constructor(){this.battle=null,this.fighters=[],this.focusableFighterPredicate=()=>!0,this.focusedFighter=null,this.camera=new Oc,this.map=new ft,this.focusIcon=new ft,this.handleKeyDownCb=t=>this.handleKeyDown(t)}async loadFromBattle(t){for(let e of this.fighters)e.delete();if(this.focusIcon=new ft,await this.focusIcon.loadFromFile("templates/rpg/jsms/focus.jsm"),this.focusIcon.setMaterial(new vt({texture:await st.loadTexture("templates/rpg/jsms/focus.png")})),t){const e=t.getCameraPosition();this.camera.setPosition(e[0],e[1],e[2]);const s=t.getCameraLookAt();this.camera.setLookAt(s[0],s[1],s[2]),this.map=new ft,await this.map.loadFromFile(t.getJSMFile()),this.map.setMaterial(new vt({texture:await st.loadTexture(t.getJSMTextureFile())}));let i=t.getHeroes();for(let n=0;n<i.length;n++){let o=new tn,a=Dc[i.length+t.getFormationType()][n];await o.loadFromCharacter(i[n]),o.setPosition(a[0],a[1],a[2]),o.setRotation(0,a[3],0),this.fighters.push(o)}let r=t.getEnemies();for(let n=0;n<r.length;n++){let o=new tn,a=Lc[r.length+t.getFormationType()][n];await o.loadFromCharacter(r[n]),o.setPosition(a[0],a[1],a[2]),o.setRotation(0,a[3],0),this.fighters.push(o)}this.battle=t}else this.battle=null}delete(){for(let t of this.fighters)t.delete();this.map.delete(),this.focusIcon.delete()}update(t){for(let e of this.fighters)e.update(t);if(this.focusedFighter){let e=this.focusedFighter.getPosition(),s=this.focusedFighter.getSize();this.focusIcon.setPosition(e[0],e[1]+s[1]+.5,e[2]),this.focusIcon.rotate(0,.05,0),this.focusIcon.update(t)}this.camera.update(t),this.map.update(t)}draw(){for(let t of this.getFighters())t.draw();this.focusedFighter&&this.focusIcon.draw(),this.map.draw()}setFocusableFighterPredicate(t){for(let e=0;e<this.fighters.length;e++){let s=this.fighters[e];if(t(s)){this.focusFighter(e,!0);break}}this.focusableFighterPredicate=t}focusFighter(t,e=!1){let s=this.fighters[t];if(!s)throw new Error("UIBattleArea::focusFighter(): fighter not found !");this.focusedFighter=s,e&&v.emit(this,"E_FIGHTER_FOCUSED",{fighter:s,index:t})}unfocusFighter(t=!1){this.focusedFighter&&(this.focusedFighter=null,t&&v.emit(this,"E_FIGHTER_UNFOCUSED"))}prevFocus(){let t=this.fighters.indexOf(this.focusedFighter),e=0;for(;e<this.fighters.length;){if(t=t-1<0?this.fighters.length-1:t-1,this.focusableFighterPredicate(this.fighters[t])){this.focusFighter(t,!0);break}e++}}nextFocus(){let t=this.fighters.indexOf(this.focusedFighter),e=0;for(;e<this.fighters.length;){if(t=t+1>this.fighters.length-1?0:t+1,this.focusableFighterPredicate(this.fighters[t])){this.focusFighter(t,!0);break}e++}}async cameraOnAlly(){this.camera.play(Nc,Fc,1500),await v.wait(this.camera,"E_FINISHED")}async cameraOnEnemy(){this.camera.play(Uc,Bc,1500),await v.wait(this.camera,"E_FINISHED")}async cameraOnDefault(){this.camera.playBack(1500),await v.wait(this.camera,"E_FINISHED")}requestSelection(){document.addEventListener("keydown",this.handleKeyDownCb)}getFighters(){return this.fighters}getFocusedFighter(){return this.focusedFighter}handleKeyDown(t){t.key=="Escape"?(document.removeEventListener("keydown",this.handleKeyDownCb),v.emit(this,"E_CLOSED")):t.key=="Enter"?(document.removeEventListener("keydown",this.handleKeyDownCb),v.emit(this,"E_ENTER_PRESSED")):t.key=="ArrowLeft"?this.prevFocus():t.key=="ArrowRight"&&this.nextFocus()}}class Hc extends yt{constructor(){super(),this.player=is.getPlayer(),this.inventory=this.player.getInventory(),this.battle=new Ic,this.uiTitle=new ae,this.uiActionMenu=new Yt,this.uiEffects=new _c,this.uiInventory=new Ai({showPrice:!1,showQuantity:!0}),this.uiHeroes=new Mc,this.uiStatus=new Rc,this.area=new Vc}async onEnter(t={battleId}){await this.battle.loadFromFile("templates/rpg/data/battle_"+t.battleId+"/data.json"),this.uiTitle.setVisible(!1),P.addWidget(this.uiTitle,"position:absolute; top:0; left:0; right:0; height:50px; z-index:2;"),this.uiActionMenu.add("ATTACK","Attaques"),this.uiActionMenu.add("MAGIC","Magies"),this.uiActionMenu.add("ITEMS","Objets"),this.uiActionMenu.add("LET","Passer"),P.addWidget(this.uiActionMenu,"position:absolute; bottom:0; left:0; width:20%; height:150px; z-index:1;"),this.uiEffects.setVisible(!1),P.addWidget(this.uiEffects,"position:absolute; top:50px; bottom:150px; left:0; right:0; z-index:2;"),this.uiInventory.setVisible(!1),this.uiInventory.setFilterPredicate(e=>e instanceof Me),P.addWidget(this.uiInventory,"position:absolute; top:50px; bottom:150px; left:0; right:0; z-index:2;"),this.uiHeroes.setCollection(new Ie(this.player.getHeroes())),P.addWidget(this.uiHeroes,"position:absolute; bottom:0; left:20%; right:0; height:150px; z-index:1;"),this.uiStatus.setBattle(this.battle),P.addWidget(this.uiStatus,"position:absolute; top:0; left:0; right:0; height:50px; z-index:1;"),await this.area.loadFromBattle(this.battle),v.subscribe(this.battle,"E_CHAR_READY",this,this.handleBattleCharReady),v.subscribe(this.battle,"E_ACTION_BEFORE",this,this.handleBattleActionBefore),v.subscribe(this.battle,"E_ACTION_AFTER",this,this.handleBattleActionAfter),v.subscribe(this.battle,"E_WIN",this,this.handleBattleWin),v.subscribe(this.battle,"E_LOST",this,this.handleBattleLost),v.subscribe(this.uiHeroes,"E_ITEM_FOCUSED",this,this.handleHeroesItemFocused),v.subscribe(this.uiHeroes,"E_ITEM_SELECTED",this,this.handleHeroesItemSelected),v.subscribe(this.uiActionMenu,"E_CLOSED",this,this.handleActionMenuClosed),v.subscribe(this.uiActionMenu,"E_ITEM_SELECTED",this,this.handleActionMenuItemSelected),v.subscribe(this.uiEffects,"E_CLOSED",this,this.handleEffectsClosed),v.subscribe(this.uiEffects,"E_ITEM_SELECTED",this,this.handleEffectsItemSelected),v.subscribe(this.uiInventory,"E_CLOSED",this,this.handleItemsMenuClosed),v.subscribe(this.uiInventory,"E_ITEM_SELECTED",this,this.handleItemsMenuItemSelected),v.subscribe(this.area,"E_CLOSED",this,this.handleAreaClosed),v.subscribe(this.area,"E_ENTER_PRESSED",this,this.handleAreaEnterPressed),this.battle.startup()}async onExit(){P.removeWidget(this.uiTitle),P.removeWidget(this.uiActionMenu),P.removeWidget(this.uiEffects),P.removeWidget(this.uiInventory),P.removeWidget(this.uiHeroes),P.removeWidget(this.uiStatus),this.area.delete()}update(t){this.area.update(t)}draw(){this.area.draw()}handleBattleCharReady(t){t.char instanceof Xi&&P.focus(this.uiHeroes)}async handleBattleActionBefore(t){t.action instanceof ci||t.action instanceof ti||(t.action.toChar instanceof Xi?await this.area.cameraOnAlly():await this.area.cameraOnEnemy())}async handleBattleActionAfter(t){t.action instanceof ci||t.action instanceof ti||await this.area.cameraOnDefault()}handleBattleWin(){ut.requestPopScreen()}handleBattleLost(){ut.requestPopScreen()}handleHeroesItemFocused(t){let s=this.area.getFighters().findIndex(i=>i.getCharacter()==this.uiHeroes.getFocusedItem());this.area.focusFighter(s)}handleHeroesItemSelected(){P.focus(this.uiActionMenu)}handleActionMenuClosed(){this.uiHeroes.unselectWidgets(),P.focus(this.uiHeroes)}handleActionMenuItemSelected(t){let e=this.uiHeroes.getSelectedItem();t.id=="ATTACK"?(this.uiTitle.setText("Attaques"),this.uiEffects.setCollection(new Ie(e.getAttackEffects())),this.uiEffects.setEnablePredicate(s=>s.isUsable(e)),this.uiTitle.setVisible(!0),this.uiEffects.setVisible(!0),P.focus(this.uiEffects)):t.id=="MAGIC"?(this.uiTitle.setText("Magies"),this.uiEffects.setCollection(new Ie(e.getMagicEffects())),this.uiEffects.setEnablePredicate(s=>s.isUsable(e)),this.uiTitle.setVisible(!0),this.uiEffects.setVisible(!0),P.focus(this.uiEffects)):t.id=="ITEMS"?(this.uiTitle.setText("Objets"),this.uiInventory.setCollection(this.inventory),this.uiTitle.setVisible(!0),this.uiInventory.setVisible(!0),P.focus(this.uiInventory)):t.id=="LET"&&(this.battle.runAction(new ti(this.battle,e)),this.uiActionMenu.unselectWidgets(),this.uiHeroes.unselectWidgets())}handleEffectsClosed(){this.uiTitle.setVisible(!1),this.uiEffects.setVisible(!1),this.uiActionMenu.unselectWidgets(),P.focus(this.uiActionMenu)}handleEffectsItemSelected(){let t=this.uiHeroes.getSelectedItem(),e=this.uiEffects.getSelectedItem();this.uiTitle.setVisible(!1),this.uiEffects.setVisible(!1),this.area.setFocusableFighterPredicate(s=>e.isTargetCharConditionCheck(t,s.getCharacter())),this.area.requestSelection(),P.unfocus()}handleItemsMenuClosed(){this.uiTitle.setVisible(!1),this.uiInventory.setVisible(!1),this.uiActionMenu.unselectWidgets(),P.focus(this.uiActionMenu)}handleItemsMenuItemSelected(){let t=this.uiHeroes.getSelectedItem(),e=this.uiInventory.getSelectedItem();this.uiTitle.setVisible(!1),this.uiInventory.setVisible(!1),this.area.setFocusableFighterPredicate(s=>e.isTarget(t,s.getCharacter())),this.area.requestSelection(),P.unfocus()}handleAreaClosed(){let t=this.uiActionMenu.getSelectedId();t=="ATTACK"||t=="MAGIC"?(this.uiTitle.setVisible(!0),this.uiEffects.setVisible(!0),this.uiEffects.unselectWidgets(),P.focus(this.uiEffects)):t=="ITEMS"&&(this.uiTitle.setVisible(!0),this.uiInventory.setVisible(!0),this.uiInventory.unselectWidgets(),P.focus(this.uiInventory))}async handleAreaEnterPressed(){let t=this.uiActionMenu.getSelectedId(),e=this.uiHeroes.getSelectedItem(),s=this.area.getFocusedFighter().getCharacter();if(t=="ATTACK"||t=="MAGIC"){let i=this.uiEffects.getSelectedItem();await this.battle.runAction(new mo(this.battle,i,e,s))}else if(t=="ITEMS"){let i=this.uiInventory.getSelectedItem();await this.battle.runAction(new xc(this.battle,i,e,s))}this.uiActionMenu.unselectWidgets(),this.uiHeroes.unselectWidgets()}}class gr extends js{constructor(){super()}addItem(t,e=!0,s=-1){let i=new jc;i.setHero(t),this.addWidget(i,e,s)}}class jc extends xt{constructor(){super({className:"UIHeroesItem",template:`
      <img class="UIHeroesItem-picture js-picture" src="#">
      <div class="UIHeroesItem-body">
        <div class="UIHeroesItem-body-name js-name"></div>
        <div class="UIHeroesItem-body-stats">
          <div class="UIHeroesItem-body-stats-item">
            <span class="UIHeroesItem-body-stats-item-name">HP</span>
            <span class="UIHeroesItem-body-stats-item-separator"></span>
            <span class="UIHeroesItem-body-stats-item-value js-hp-value"></span>
          </div>
          <div class="UIHeroesItem-body-stats-item">
            <span class="UIHeroesItem-body-stats-item-name">MP</span>
            <span class="UIHeroesItem-body-stats-item-separator"></span>
            <span class="UIHeroesItem-body-stats-item-value js-mp-value"></span>
          </div>
        </div>
      </div>`}),this.hero=null}update(t){this.hero?(this.node.querySelector(".js-picture").src=this.hero.getPictureFile(),this.node.querySelector(".js-name").textContent=this.hero.getName(),this.node.querySelector(".js-hp-value").textContent=this.hero.getAttribute("HP")+"/"+this.hero.getAttribute("HP_MAX"),this.node.querySelector(".js-mp-value").textContent=this.hero.getAttribute("MP")+"/"+this.hero.getAttribute("HP_MAX")):(this.node.querySelector(".js-picture").src="#",this.node.querySelector(".js-name").textContent="--",this.node.querySelector(".js-hp-value").textContent="--/--",this.node.querySelector(".js-mp-value").textContent="--/--")}getHero(){return this.hero}setHero(t){this.hero=t||null}}class go extends js{constructor(){super()}addItem(t,e=!0,s=-1){let i=new kc;i.setHero(t),this.addWidget(i,e,s)}}class kc extends xt{constructor(){super({className:"UIHeroesEquipmentItem",template:`
      <img class="UIHeroesEquipmentItem-picture js-picture" src="#">
      <div class="UIHeroesEquipmentItem-body">
        <div class="UIHeroesEquipmentItem-body-name js-name"></div>
        <div class="UIHeroesEquipmentItem-body-stats">
          <div class="UIHeroesEquipmentItem-body-stats-item">
            <span class="UIHeroesEquipmentItem-body-stats-item-name">HP MAX</span>
            <span class="UIHeroesEquipmentItem-body-stats-item-separator"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-value1 js-hp-max-value1"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-arrow"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-value2 js-hp-max-value2"></span>
          </div>
          <div class="UIHeroesEquipmentItem-body-stats-item">
            <span class="UIHeroesEquipmentItem-body-stats-item-name">MP MAX</span>
            <span class="UIHeroesEquipmentItem-body-stats-item-separator"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-value1 js-mp-max-value1"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-arrow"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-value2 js-mp-max-value2"></span>
          </div>
          <div class="UIHeroesEquipmentItem-body-stats-item">
            <span class="UIHeroesEquipmentItem-body-stats-item-name">ATK</span>
            <span class="UIHeroesEquipmentItem-body-stats-item-separator"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-value1 js-atk-value1"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-arrow"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-value2 js-atk-value2"></span>
          </div>
          <div class="UIHeroesEquipmentItem-body-stats-item">
            <span class="UIHeroesEquipmentItem-body-stats-item-name">DEF</span>
            <span class="UIHeroesEquipmentItem-body-stats-item-separator"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-value1 js-def-value1"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-arrow"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-value2 js-def-value2"></span>
          </div>
          <div class="UIHeroesEquipmentItem-body-stats-item">
            <span class="UIHeroesEquipmentItem-body-stats-item-name">M-ATK</span>
            <span class="UIHeroesEquipmentItem-body-stats-item-separator"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-value1 js-magic-atk-value1"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-arrow"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-value2 js-magic-atk-value2"></span>
          </div>
          <div class="UIHeroesEquipmentItem-body-stats-item">
            <span class="UIHeroesEquipmentItem-body-stats-item-name">M-DEF</span>
            <span class="UIHeroesEquipmentItem-body-stats-item-separator"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-value1 js-magic-def-value1"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-arrow"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-value2 js-magic-def-value2"></span>
          </div>
          <div class="UIHeroesEquipmentItem-body-stats-item">
            <span class="UIHeroesEquipmentItem-body-stats-item-name">AGI</span>
            <span class="UIHeroesEquipmentItem-body-stats-item-separator"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-value1 js-agility-value1"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-arrow"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-value2 js-agility-value2"></span>
          </div>
        </div>
      </div>`}),this.hero=null,this.equipmentItem=null}update(t){if(this.hero){let e=this.hero.getAttributes(),s=this.hero.isEquipableItem(this.equipmentItem)?this.hero.getAttributesWith(this.equipmentItem):{};this.node.querySelector(".js-picture").src=this.hero.getPictureFile(),this.node.querySelector(".js-name").textContent=this.hero.getName(),this.displayStat("hp-max",e.get("HP_MAX"),s.HP_MAX),this.displayStat("mp-max",e.get("MP_MAX"),s.MP_MAX),this.displayStat("atk",e.get("ATK"),s.ATK),this.displayStat("def",e.get("DEF"),s.DEF),this.displayStat("magic-atk",e.get("MAGIC_ATK"),s.MAGIC_ATK),this.displayStat("magic-def",e.get("MAGIC_DEF"),s.MAGIC_DEF),this.displayStat("agility",e.get("AGILITY"),s.AGILITY)}else this.node.querySelector(".js-picture").src="#",this.node.querySelector(".js-name").textContent="--",this.displayStat("hp-max","--"),this.displayStat("mp-max","--"),this.displayStat("atk","--"),this.displayStat("def","--"),this.displayStat("magic-atk","--"),this.displayStat("magic-def","--"),this.displayStat("agility","--")}getHero(){return this.hero}setHero(t){this.hero=t||null}setEquipmentItem(t){this.equipmentItem=t||null}displayStat(t,e,s){this.node.querySelector(".js-"+t+"-value1").textContent=e||"",this.node.querySelector(".js-"+t+"-value2").textContent=s||"",this.node.querySelector(".js-"+t+"-value2").style.display=s?"block":"none",this.node.querySelector(".js-"+t+"-value2").style.color=s>e?"#00d600":s<e?"#ff2929":"#fff"}}class Wc extends yt{constructor(){super(),this.player=is.getPlayer(),this.inventory=this.player.getInventory(),this.uiTopMenu=new Yt({axis:Ts.X}),this.uiTitle=new ae,this.uiDescription=new ae,this.uiInventory=new Ai({showPrice:!1,showQuantity:!0}),this.uiHeroes=new go,this.uiSortMenu=new Yt,this.uiFilterMenu=new Yt}async onEnter(){this.uiTopMenu.add("APPLY","Equiper"),this.uiTopMenu.add("DELETE","Supprimer"),this.uiTopMenu.add("SORT","Trier"),this.uiTopMenu.add("FILTER","Filtrer"),P.addWidget(this.uiTopMenu,"position:absolute; top:0; left:0; width:70%; height:50px;"),this.uiTitle.setText("Objets"),P.addWidget(this.uiTitle,"position:absolute; top:0; left:70%; width:30%; height:50px;"),this.uiDescription.setText("Description..."),P.addWidget(this.uiDescription,"position:absolute; top:50px; left:0; width:100%; height:50px;"),this.uiInventory.setFilterPredicate(t=>t instanceof ce),this.uiInventory.setCollection(this.player.getInventory()),P.addWidget(this.uiInventory,"position:absolute; top:100px; left:0; bottom:0; width:40%;"),this.uiHeroes.setCollection(new Ie(this.player.getHeroes())),P.addWidget(this.uiHeroes,"position:absolute; top:100px; left:40%; bottom:0; width:60%;"),this.uiSortMenu.setVisible(!1),this.uiSortMenu.add("NONE","Aucun"),this.uiSortMenu.add("ALPHA","Alphabtique"),this.uiSortMenu.add("QUANTITY","Quantit"),P.addWidget(this.uiSortMenu,"position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);"),this.uiFilterMenu.setVisible(!1),this.uiFilterMenu.add("NONE","Aucun"),this.uiFilterMenu.add("WEAPON","Arme"),this.uiFilterMenu.add("HELMET","Haume"),this.uiFilterMenu.add("ARMOR","Armure"),this.uiFilterMenu.add("RELIC","Relique"),P.addWidget(this.uiFilterMenu,"position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);"),v.subscribe(this.uiTopMenu,"E_CLOSED",this,this.handleTopMenuClosed),v.subscribe(this.uiTopMenu,"E_FOCUSED",this,this.handleTopMenuFocused),v.subscribe(this.uiTopMenu,"E_ITEM_SELECTED",this,this.handleTopMenuItemSelected),v.subscribe(this.uiInventory,"E_CLOSED",this,this.handleInventoryClosed),v.subscribe(this.uiInventory,"E_ITEM_FOCUSED",this,this.handleInventoryItemFocused),v.subscribe(this.uiInventory,"E_ITEM_SELECTED",this,this.handleInventoryItemSelected),v.subscribe(this.uiHeroes,"E_CLOSED",this,this.handleHeroesClosed),v.subscribe(this.uiHeroes,"E_ITEM_SELECTED",this,this.handleHeroesItemSelected),v.subscribe(this.uiSortMenu,"E_ITEM_SELECTED",this,this.handleSortMenuItemSelected),v.subscribe(this.uiFilterMenu,"E_ITEM_SELECTED",this,this.handleFilterMenuItemSelected),P.focus(this.uiTopMenu)}async onExit(){P.removeWidget(this.uiTopMenu),P.removeWidget(this.uiTitle),P.removeWidget(this.uiDescription),P.removeWidget(this.uiInventory),P.removeWidget(this.uiHeroes),P.removeWidget(this.uiSortMenu),P.removeWidget(this.uiFilterMenu)}handleTopMenuClosed(){ut.requestPopScreen()}handleTopMenuFocused(){this.uiTopMenu.setEnabledWidget(0,this.inventory.hasEquipmentItems()),this.uiTopMenu.setEnabledWidget(1,this.inventory.hasEquipmentItems()),this.uiDescription.setText("Description...");for(let t of this.uiHeroes.getWidgets())t.setEquipmentItem(null),t.setEnabled(!0)}handleTopMenuItemSelected(t){t.id=="APPLY"?P.focus(this.uiInventory):t.id=="DELETE"?P.focus(this.uiInventory):t.id=="SORT"?(this.uiSortMenu.setVisible(!0),P.focus(this.uiSortMenu)):t.id=="FILTER"&&(this.uiFilterMenu.setVisible(!0),P.focus(this.uiFilterMenu))}handleInventoryClosed(){this.uiInventory.unselectWidgets(),this.uiTopMenu.unselectWidgets(),P.focus(this.uiTopMenu)}handleInventoryItemFocused(t){let e=this.uiInventory.getFocusedItem();this.uiDescription.setText(e.getDescription());for(let s of this.uiHeroes.getWidgets()){let i=s.getHero();s.setEquipmentItem(e),s.setEnabled(i.isEquipableItem(e))}}handleInventoryItemSelected(t){let e=this.uiTopMenu.getSelectedId();if(e=="APPLY")P.focus(this.uiHeroes);else if(e=="DELETE"){let s=this.uiInventory.getSelectedItem();this.inventory.removeItemById(s.getId()),this.uiInventory.unselectWidgets(),this.uiTopMenu.unselectWidgets(),P.focus(this.uiTopMenu)}}handleHeroesClosed(){this.uiHeroes.unselectWidgets(),this.uiInventory.unselectWidgets(),P.focus(this.uiInventory)}handleHeroesItemSelected(){let t=this.uiInventory.getSelectedItem(),s=this.uiHeroes.getSelectedItem().setEquipment(t);s&&this.inventory.addItem(s),this.inventory.removeItemById(t.getId()),this.uiHeroes.unselectWidgets(),this.uiInventory.unselectWidgets(),this.uiTopMenu.unselectWidgets(),P.focus(this.uiTopMenu)}handleSortMenuItemSelected(t){t.id=="NONE"?this.uiInventory.setSortPredicate(()=>!0):t.id=="ALPHA"?this.uiInventory.setSortPredicate((e,s)=>e.getName().localeCompare(s.getName())):t.id=="QUANTITY"&&this.uiInventory.setSortPredicate((e,s)=>e.getQuantity()-s.getQuantity()),this.uiSortMenu.setVisible(!1),this.uiTopMenu.unselectWidgets(),P.focus(this.uiTopMenu)}handleFilterMenuItemSelected(t){t.id=="NONE"?this.uiInventory.setFilterPredicate(e=>e instanceof ce):t.id=="WEAPON"?this.uiInventory.setFilterPredicate(e=>e instanceof ce&&e.getType()==Te.WEAPON):t.id=="HELMET"?this.uiInventory.setFilterPredicate(e=>e instanceof ce&&e.getType()==Te.HELMET):t.id=="ARMOR"?this.uiInventory.setFilterPredicate(e=>e instanceof ce&&e.getType()==Te.ARMOR):t.id=="RELIC"&&this.uiInventory.setFilterPredicate(e=>e instanceof ce&&e.getType()==Te.RELIC),this.uiFilterMenu.setVisible(!1),this.uiTopMenu.unselectWidgets(),P.focus(this.uiTopMenu)}}class Gc extends yt{constructor(){super(),this.player=is.getPlayer(),this.inventory=this.player.getInventory(),this.uiTopMenu=new Yt({axis:Ts.X}),this.uiTitle=new ae,this.uiDescription=new ae,this.uiInventory=new Ai({showPrice:!1,showQuantity:!0}),this.uiHeroes=new gr,this.uiSortMenu=new Yt,this.uiFilterMenu=new Yt}async onEnter(){this.uiTopMenu.add("APPLY","Utiliser"),this.uiTopMenu.add("DELETE","Supprimer"),this.uiTopMenu.add("SORT","Trier"),this.uiTopMenu.add("FILTER","Filtrer"),P.addWidget(this.uiTopMenu,"position:absolute; top:0; left:0; width:70%; height:50px;"),this.uiTitle.setText("Objets"),P.addWidget(this.uiTitle,"position:absolute; top:0; left:70%; width:30%; height:50px;"),this.uiDescription.setText("Description..."),P.addWidget(this.uiDescription,"position:absolute; top:50px; left:0; width:100%; height:50px;"),this.uiInventory.setFilterPredicate(t=>t instanceof Me),this.uiInventory.setCollection(this.inventory),P.addWidget(this.uiInventory,"position:absolute; top:100px; left:0; bottom:0; width:40%;"),this.uiHeroes.setCollection(new Ie(this.player.getHeroes())),P.addWidget(this.uiHeroes,"position:absolute; top:100px; left:40%; bottom:0; width:60%;"),this.uiSortMenu.setVisible(!1),this.uiSortMenu.add("NONE","Aucun"),this.uiSortMenu.add("ALPHA","Alphabtique"),this.uiSortMenu.add("QUANTITY","Quantit"),P.addWidget(this.uiSortMenu,"position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);"),this.uiFilterMenu.setVisible(!1),this.uiFilterMenu.add("NONE","Aucun"),this.uiFilterMenu.add("POTION","Potion"),this.uiFilterMenu.add("FOOD","Nourriture"),this.uiFilterMenu.add("OTHER","Autre"),P.addWidget(this.uiFilterMenu,"position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);"),v.subscribe(this.uiTopMenu,"E_CLOSED",this,this.handleTopMenuClosed),v.subscribe(this.uiTopMenu,"E_FOCUSED",this,this.handleTopMenuFocused),v.subscribe(this.uiTopMenu,"E_ITEM_SELECTED",this,this.handleTopMenuItemSelected),v.subscribe(this.uiInventory,"E_CLOSED",this,this.handleInventoryClosed),v.subscribe(this.uiInventory,"E_ITEM_FOCUSED",this,this.handleInventoryItemFocused),v.subscribe(this.uiInventory,"E_ITEM_SELECTED",this,this.handleInventoryItemSelected),v.subscribe(this.uiHeroes,"E_CLOSED",this,this.handleHeroesClosed),v.subscribe(this.uiHeroes,"E_ITEM_SELECTED",this,this.handleHeroesItemSelected),v.subscribe(this.uiSortMenu,"E_ITEM_SELECTED",this,this.handleSortMenuItemSelected),v.subscribe(this.uiFilterMenu,"E_ITEM_SELECTED",this,this.handleFilterMenuItemSelected),P.focus(this.uiTopMenu)}async onExit(){P.removeWidget(this.uiTopMenu),P.removeWidget(this.uiTitle),P.removeWidget(this.uiDescription),P.removeWidget(this.uiInventory),P.removeWidget(this.uiHeroes),P.removeWidget(this.uiSortMenu),P.removeWidget(this.uiFilterMenu)}handleTopMenuClosed(){ut.requestPopScreen()}handleTopMenuFocused(){this.uiTopMenu.setEnabledWidget(0,this.inventory.hasMenuAvailableItems()),this.uiTopMenu.setEnabledWidget(1,this.inventory.hasCommonItems()),this.uiDescription.setText("Description...");for(let t of this.uiHeroes.getWidgets())t.setEnabled(!0)}handleTopMenuItemSelected(t){t.id=="APPLY"?(this.uiInventory.setEnablePredicate(e=>e.isMenuAvailable()),P.focus(this.uiInventory)):t.id=="DELETE"?(this.uiInventory.setEnablePredicate(e=>!0),P.focus(this.uiInventory)):t.id=="SORT"?(this.uiSortMenu.setVisible(!0),P.focus(this.uiSortMenu)):t.id=="FILTER"&&(this.uiFilterMenu.setVisible(!0),P.focus(this.uiFilterMenu))}handleInventoryClosed(){this.uiInventory.unselectWidgets(),this.uiTopMenu.unselectWidgets(),P.focus(this.uiTopMenu)}handleInventoryItemFocused(t){let e=this.uiInventory.getFocusedItem();this.uiDescription.setText(e.description);for(let s of this.uiHeroes.getWidgets()){let i=s.getHero();s.setEnabled(e.isTarget(i,i))}}handleInventoryItemSelected(t){let e=this.uiTopMenu.getSelectedId();if(e=="APPLY")P.focus(this.uiHeroes);else if(e=="DELETE"){let s=this.uiInventory.getSelectedItem();this.inventory.removeItemById(s.getId()),this.uiInventory.unselectWidgets(),this.uiTopMenu.unselectWidgets(),P.focus(this.uiTopMenu)}}handleHeroesClosed(){this.uiHeroes.unselectWidgets(),this.uiInventory.unselectWidgets(),P.focus(this.uiInventory)}handleHeroesItemSelected(){let t=this.uiInventory.getSelectedItem(),e=this.uiHeroes.getSelectedItem();t.getEffect().apply(e,e),this.inventory.removeItemById(t.getId()),this.uiHeroes.unselectWidgets(),this.uiInventory.unselectWidgets(),this.uiTopMenu.unselectWidgets(),P.focus(this.uiTopMenu)}handleSortMenuItemSelected(t){t.id=="NONE"?this.uiInventory.setSortPredicate(()=>!0):t.id=="ALPHA"?this.uiInventory.setSortPredicate((e,s)=>e.getName().localeCompare(s.getName())):t.id=="QUANTITY"&&this.uiInventory.setSortPredicate((e,s)=>e.getQuantity()-s.getQuantity()),this.uiSortMenu.setVisible(!1),this.uiTopMenu.unselectWidgets(),P.focus(this.uiTopMenu)}handleFilterMenuItemSelected(t){t.id=="NONE"?this.uiInventory.setFilterPredicate(e=>e instanceof Me):t.id=="POTION"?this.uiInventory.setFilterPredicate(e=>e instanceof Me&&e.getType()==Te.POTION):t.id=="FOOD"?this.uiInventory.setFilterPredicate(e=>e instanceof Me&&e.getType()==Te.FOOD):t.id=="OTHER"&&this.uiInventory.setFilterPredicate(e=>e instanceof Me&&e.getType()==Te.OTHER),this.uiFilterMenu.setVisible(!1),this.uiTopMenu.unselectWidgets(),P.focus(this.uiTopMenu)}}class zc extends xt{constructor(){super({className:"UIStatus",template:`
      <div class="UIStatus-avatar">
        <img class="UIStatus-avatar-picture js-picture" src="#">
        <div class="UIStatus-avatar-name js-name"></div>
      </div>
      <div class="UIStatus-title">STATS</div>
      <div class="UIStatus-section">
        <div class="UIStatus-stats">
          <div class="UIStatus-stats-item">
            <span class="UIStatus-stats-item-name">LV</span>
            <span class="UIStatus-stats-item-separator"></span>
            <span class="UIStatus-stats-item-value js-lv-value"></span>
          </div>
          <div class="UIStatus-stats-item">
            <span class="UIStatus-stats-item-name">XP</span>
            <span class="UIStatus-stats-item-separator"></span>
            <span class="UIStatus-stats-item-value js-xp-value"></span>
          </div>
          <div class="UIStatus-stats-item">
            <span class="UIStatus-stats-item-name">HP</span>
            <span class="UIStatus-stats-item-separator"></span>
            <span class="UIStatus-stats-item-value js-hp-value"></span>
          </div>
          <div class="UIStatus-stats-item">
            <span class="UIStatus-stats-item-name">MP</span>
            <span class="UIStatus-stats-item-separator"></span>
            <span class="UIStatus-stats-item-value js-mp-value"></span>
          </div>
          <div class="UIStatus-stats-item">
            <span class="UIStatus-stats-item-name">ATK</span>
            <span class="UIStatus-stats-item-separator"></span>
            <span class="UIStatus-stats-item-value js-atk-value"></span>
          </div>
          <div class="UIStatus-stats-item">
            <span class="UIStatus-stats-item-name">DEF</span>
            <span class="UIStatus-stats-item-separator"></span>
            <span class="UIStatus-stats-item-value js-def-value"></span>
          </div>
          <div class="UIStatus-stats-item">
            <span class="UIStatus-stats-item-name">M-ATK</span>
            <span class="UIStatus-stats-item-separator"></span>
            <span class="UIStatus-stats-item-value js-matk-value"></span>
          </div>
          <div class="UIStatus-stats-item">
            <span class="UIStatus-stats-item-name">M-DEF</span>
            <span class="UIStatus-stats-item-separator"></span>
            <span class="UIStatus-stats-item-value js-mdef-value"></span>
          </div>
          <div class="UIStatus-stats-item">
            <span class="UIStatus-stats-item-name">AGILITE</span>
            <span class="UIStatus-stats-item-separator"></span>
            <span class="UIStatus-stats-item-value js-agility-value"></span>
          </div>
          <div class="UIStatus-stats-item">
            <span class="UIStatus-stats-item-name">ELEMENT</span>
            <span class="UIStatus-stats-item-separator"></span>
            <span class="UIStatus-stats-item-value js-element-value"></span>
          </div>
        </div>
      </div>
      <div class="UIStatus-title">EQUIPEMENTS</div>
      <div class="UIStatus-section">
        <div class="UIStatus-stuffs">
          <div class="UIStatus-stuffs-item">
            <span class="UIStatus-stuffs-item-name">ARME</span>
            <span class="UIStatus-stuffs-item-separator"></span>
            <span class="UIStatus-stuffs-item-value js-weapon-value"></span>
          </div>
          <div class="UIStatus-stuffs-item">
            <span class="UIStatus-stuffs-item-name">CASQUE</span>
            <span class="UIStatus-stuffs-item-separator"></span>
            <span class="UIStatus-stuffs-item-value js-helmet-value"></span>
          </div>
          <div class="UIStatus-stuffs-item">
            <span class="UIStatus-stuffs-item-name">ARMURE</span>
            <span class="UIStatus-stuffs-item-separator"></span>
            <span class="UIStatus-stuffs-item-value js-armor-value"></span>
          </div>
          <div class="UIStatus-stuffs-item">
            <span class="UIStatus-stuffs-item-name">RELIQUE</span>
            <span class="UIStatus-stuffs-item-separator"></span>
            <span class="UIStatus-stuffs-item-value js-relic-value"></span>
          </div>
        </div>
      </div>
      <div class="UIStatus-title">DESCRIPTION</div>
      <div class="UIStatus-section">
        <div class="UIStatus-description js-description"></div>
      </div>`}),this.hero=null}update(){if(this.hero){let t=this.hero.getWeapon(),e=this.hero.getHelmet(),s=this.hero.getArmor(),i=this.hero.getRelic();this.node.querySelector(".js-picture").src=this.hero.getPictureFile(),this.node.querySelector(".js-name").textContent=this.hero.getName(),this.node.querySelector(".js-lv-value").textContent=this.hero.getAttribute("LV")+"/"+this.hero.getAttribute("LV_MAX"),this.node.querySelector(".js-xp-value").textContent=this.hero.getAttribute("XP")+"/"+this.hero.getAttribute("XP_MAX"),this.node.querySelector(".js-hp-value").textContent=this.hero.getAttribute("HP")+"/"+this.hero.getAttribute("HP_MAX"),this.node.querySelector(".js-mp-value").textContent=this.hero.getAttribute("MP")+"/"+this.hero.getAttribute("MP_MAX"),this.node.querySelector(".js-atk-value").textContent=this.hero.getAttribute("ATK"),this.node.querySelector(".js-def-value").textContent=this.hero.getAttribute("DEF"),this.node.querySelector(".js-matk-value").textContent=this.hero.getAttribute("MAGIC_ATK"),this.node.querySelector(".js-mdef-value").textContent=this.hero.getAttribute("MAGIC_DEF"),this.node.querySelector(".js-agility-value").textContent=this.hero.getAttribute("AGILITY"),this.node.querySelector(".js-element-value").textContent=this.hero.getAttribute("ELEMENT"),this.node.querySelector(".js-weapon-value").textContent=t?t.getName():"Vide",this.node.querySelector(".js-helmet-value").textContent=e?e.getName():"Vide",this.node.querySelector(".js-armor-value").textContent=s?s.getName():"Vide",this.node.querySelector(".js-relic-value").textContent=i?i.getName():"Vide"}else this.node.querySelector(".js-picture").src="#",this.node.querySelector(".js-name").textContent="",this.node.querySelector(".js-lv-value").textContent="--/--",this.node.querySelector(".js-xp-value").textContent="--/--",this.node.querySelector(".js-hp-value").textContent="--/--",this.node.querySelector(".js-mp-value").textContent="--/--",this.node.querySelector(".js-atk-value").textContent="--",this.node.querySelector(".js-def-value").textContent="--",this.node.querySelector(".js-matk-value").textContent="--",this.node.querySelector(".js-mdef-value").textContent="--",this.node.querySelector(".js-agility-value").textContent="--",this.node.querySelector(".js-element-value").textContent="--",this.node.querySelector(".js-weapon-value").textContent="Vide",this.node.querySelector(".js-helmet-value").textContent="Vide",this.node.querySelector(".js-armor-value").textContent="Vide",this.node.querySelector(".js-relic-value").textContent="Vide"}setHero(t){this.hero=t||null}}class en extends yt{constructor(t){super(),this.hero=t,this.uiTitle=new ae,this.uiStatus=new zc,this.handleKeyDownCb=e=>this.handleKeyDown(e)}async onEnter(){this.uiTitle.setText("Status"),P.addWidget(this.uiTitle,"position:absolute; top:0; left:0; width:100%; height:50px"),this.uiStatus.setHero(this.hero),P.addWidget(this.uiStatus,"position:absolute; top:50px; left:0; bottom:0; width:100%"),document.addEventListener("keydown",this.handleKeyDownCb)}onExit(){document.removeEventListener("keydown",this.handleKeyDownCb),P.removeWidget(this.uiTitle),P.removeWidget(this.uiStatus)}handleKeyDown(t){t.key=="Escape"&&ut.requestPopScreen()}}class qc extends yt{constructor(){super(),this.player=is.getPlayer(),this.uiTitle=new ae,this.uiMainMenu=new Yt,this.uiHeroes=new gr}async onEnter(){this.uiTitle.setText("Menu"),P.addWidget(this.uiTitle,"position:absolute; top:0; left:0; right:0; height:50px"),this.uiMainMenu.add("ITEMS","Objets"),this.uiMainMenu.add("STUFFS","Equipements"),this.uiMainMenu.add("STATUS","Status"),P.addWidget(this.uiMainMenu,"position:absolute; top:50px; left:0; bottom:0; width:40%"),this.uiHeroes.setCollection(new Ie(this.player.getHeroes())),P.addWidget(this.uiHeroes,"position:absolute; top:50px; left:40%; bottom:0; width:60%"),v.subscribe(this.uiMainMenu,"E_CLOSED",this,this.handleMainMenuClosed),v.subscribe(this.uiMainMenu,"E_ITEM_SELECTED",this,this.handleMainMenuItemSelected),v.subscribe(this.uiHeroes,"E_CLOSED",this,this.handleHeroesClosed),v.subscribe(this.uiHeroes,"E_ITEM_SELECTED",this,this.handleHeroesItemSelected),P.focus(this.uiMainMenu)}async onExit(){P.removeWidget(this.uiTitle),P.removeWidget(this.uiMainMenu),P.removeWidget(this.uiHeroes)}onBringToFront(t){P.focus(t instanceof en?this.uiHeroes:this.uiMainMenu)}onBringToBack(){P.unfocus(),this.uiMainMenu.unselectWidgets(),this.uiHeroes.unselectWidgets()}handleMainMenuClosed(){ut.requestPopScreen()}handleMainMenuItemSelected(t){t.id=="ITEMS"?ut.requestPushScreen(new Gc):t.id=="STUFFS"?ut.requestPushScreen(new Wc):t.id=="STATUS"&&P.focus(this.uiHeroes)}handleHeroesClosed(){this.uiMainMenu.unselectWidgets(),P.focus(this.uiMainMenu)}handleHeroesItemSelected(t){let e=this.uiHeroes.getSelectedItem();ut.requestPushScreen(new en(e))}}class sn extends xt{constructor(){super({className:"UIDescriptionList"})}addItem(t,e,s){const i=document.createElement("template");i.innerHTML=`
    <span class="UIDescriptionList-item js-${t}">
      <span class="UIDescriptionList-item-label js-label">${e}</span>
      <span class="UIDescriptionList-item-value js-value">${s}</span>
    </span>`,this.node.appendChild(i.content)}removeItem(t){const e=this.node.querySelector(".js-"+t);if(!e)throw new Error("UIDescriptionList::removeItem(): item not found !");this.node.removeChild(e)}setItem(t,e){const s=this.node.querySelector(".js-"+t);if(!s)throw new Error("UIDescriptionList::setItem(): item not found !");s.querySelector(".js-value").textContent=e}getItemValue(t){const e=this.node.querySelector(".js-"+t);if(!e)throw new Error("UIDescriptionList::getItemValue(): item not found !");const s=e.querySelector(".js-value").textContent;return s||""}isItemVisible(t){const e=this.node.querySelector(".js-"+t);if(!e)throw new Error("UIDescriptionList::getItemVisible(): item not found !");return!e.classList.contains("u-hidden")}setItemVisible(t,e){const s=this.node.querySelector(".js-"+t);if(!s)throw new Error("UIDescriptionList::setItemVisible(): item not found !");e?s.classList.remove("u-hidden"):s.classList.add("u-hidden")}clear(){this.node.innerHTML=""}}let ui={COMMON_STORE:"COMMON_STORE",EQUIPMENT_STORE:"EQUIPMENT_STORE"},me={QUANTITY:0,TOTAL:1},Ys={GILS:0,INVENTORY:1};class rn extends yt{constructor(t){super(),this.mode=t,this.player=is.getPlayer(),this.inventory=this.player.getInventory(),this.shopInventory=new fo,this.uiText=new ae,this.uiTitle=new ae,this.uiDescription=new ae,this.uiInventory=new Ai({showPrice:!0,showQuantity:!1}),this.uiPlayerDesc=new sn,this.uiCheckoutDesc=new sn,this.uiHeroes=t==ui.COMMON_STORE?new gr:new go,this.handleKeyDownCb=e=>this.handleKeyDown(e)}async onEnter(t={inventoryId}){await this.shopInventory.loadFromFile("templates/rpg/data/inventory_"+t.inventoryId+"/data.json"),this.uiText.setText("Que voulez-vous acheter ?"),P.addWidget(this.uiText,"position:absolute; top:0px; left:0; width:70%; height:50px;"),this.uiTitle.setText("Magasin"),P.addWidget(this.uiTitle,"position:absolute; top:0; left:70%; width:30%; height:50px;"),this.uiDescription.setText("Description..."),P.addWidget(this.uiDescription,"position:absolute; top:50px; left:0; width:100%; height:50px;"),this.uiInventory.setCollection(this.shopInventory),P.addWidget(this.uiInventory,"position:absolute; top:100px; left:0; bottom:0; width:50%;"),this.uiPlayerDesc.addItem(Ys.GILS,"Gils",this.player.getGils()),this.uiPlayerDesc.addItem(Ys.INVENTORY,"Inventaire",0),P.addWidget(this.uiPlayerDesc,"position:absolute; top:100px; left:50%; width:50%; height:84px"),this.uiCheckoutDesc.setVisible(!1),this.uiCheckoutDesc.addItem(me.QUANTITY,"Quantite",0),this.uiCheckoutDesc.addItem(me.TOTAL,"Total",0),P.addWidget(this.uiCheckoutDesc,"position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); z-index:10;"),this.uiHeroes.setCollection(new Ie(this.player.getHeroes())),P.addWidget(this.uiHeroes,"position:absolute; top:184px; left:50%; bottom:0; width:50%;"),v.subscribe(this.uiInventory,"E_CLOSED",this,this.handleInventoryClosed),v.subscribe(this.uiInventory,"E_ITEM_FOCUSED",this,this.handleInventoryItemFocused),v.subscribe(this.uiInventory,"E_ITEM_SELECTED",this,this.handleInventoryItemSelected),P.focus(this.uiInventory)}async onExit(){document.removeEventListener("keydown",this.handleKeyDownCb),P.removeWidget(this.uiText),P.removeWidget(this.uiTitle),P.removeWidget(this.uiDescription),P.removeWidget(this.uiInventory),P.removeWidget(this.uiPlayerDesc),P.removeWidget(this.uiCheckoutDesc),P.removeWidget(this.uiHeroes)}handleInventoryClosed(){ut.requestPopScreen()}handleInventoryItemFocused(t){let e=this.uiInventory.getFocusedItem(),i=this.inventory.getItems().find(r=>r.getId()==e.getId());if(this.uiDescription.setText(e.description),this.uiPlayerDesc.setItem(Ys.INVENTORY,i?i.quantity:"0"),this.mode==ui.COMMON_STORE)for(let r of this.uiHeroes.getWidgets()){let n=r.getHero();r.setEnabled(e.isTarget(n,n))}else for(let r of this.uiHeroes.getWidgets()){let n=r.getHero();r.setEquipmentItem(e),r.setEnabled(n.isEquipableItem(e))}}handleInventoryItemSelected(){this.uiCheckoutDesc.setVisible(!0),P.focus(this.uiCheckoutDesc),document.addEventListener("keydown",this.handleKeyDownCb)}handleKeyDown(t){let e=this.uiInventory.getSelectedItem(),s=parseInt(this.uiCheckoutDesc.getItemValue(me.QUANTITY));if(t.key=="ArrowUp"){let i=s+1;this.uiCheckoutDesc.setItem(me.QUANTITY,i),this.uiCheckoutDesc.setItem(me.TOTAL,i*e.getPrice())}else if(t.key=="ArrowDown"&&s>0){let i=s-1;this.uiCheckoutDesc.setItem(me.QUANTITY,i),this.uiCheckoutDesc.setItem(me.TOTAL,i*e.getPrice())}else if(t.key=="Enter"){let i=s*e.getPrice();if(this.player.getGils()-i<0)return;e.setQuantity(s),this.player.decreaseGils(i),this.inventory.addItem(e),this.uiPlayerDesc.setItem(Ys.GILS,this.player.getGils()),this.uiCheckoutDesc.setItem(me.QUANTITY,0),this.uiCheckoutDesc.setItem(me.TOTAL,0),this.uiCheckoutDesc.setVisible(!1),this.uiInventory.unselectWidgets(),P.focus(this.uiInventory),document.removeEventListener("keydown",this.handleKeyDownCb)}else t.key=="Escape"&&(this.uiCheckoutDesc.setItem(me.QUANTITY,0),this.uiCheckoutDesc.setItem(me.TOTAL,0),this.uiCheckoutDesc.setVisible(!1),this.uiInventory.unselectWidgets(),P.focus(this.uiInventory),document.removeEventListener("keydown",this.handleKeyDownCb))}}class Xc extends yt{constructor(){super(),this.uiMenu=new Yt}async onEnter(){await is.init(),this.uiMenu.add("0","Battle"),this.uiMenu.add("1","Menu"),this.uiMenu.add("2","Shop items"),this.uiMenu.add("3","Shop stuff"),P.addWidget(this.uiMenu,"position:absolute; top:50%; left:50%; width:60%; transform:translate(-50%,-50%);"),v.subscribe(this.uiMenu,"E_ITEM_SELECTED",this,this.handleMenuItemSelected),P.focus(this.uiMenu)}onExit(){P.removeWidget(this.uiMenu)}onBringToFront(){this.uiMenu.setVisible(!0),P.focus(this.uiMenu)}onBringToBack(){this.uiMenu.setVisible(!1),this.uiMenu.unselectWidgets()}handleMenuItemSelected(t){t.id==0?ut.requestPushScreen(new Hc,{battleId:"0000"}):t.id==1?ut.requestPushScreen(new qc):t.id==2?ut.requestPushScreen(new rn(ui.COMMON_STORE),{inventoryId:"0000"}):t.id==3&&ut.requestPushScreen(new rn(ui.EQUIPMENT_STORE),{inventoryId:"0001"})}}class di extends dt{jss;constructor(){super("Bullet"),this.jss=new ne,this.jss.setTexture(It.getTexture("./templates/shootemup/bullet.png"))}}class Yc extends mt{constructor(){super(),super.addRequiredComponentTypename("Bullet")}onEntityUpdate(t,e){const s=x.getComponent(e,di);if(s.jss.translate(0,-6*(t/100)),s.jss.getPositionY()<-300){x.removeEntity(e);return}for(const i of x.findEntities(Us)){const r=x.getComponent(i,Us),n=s.jss.getWorldBoundingRect(),o=r.jss.getWorldBoundingRect();n.intersectBoundingRect(o)&&(x.hasEntity(e)&&x.removeEntity(e),x.removeEntity(i),v.emit(this,"E_ASTEROID_DESTROYED"))}s.jss.update(t)}onEntityDraw(t){x.getComponent(t,di).jss.draw()}}async function Zc(h,t){await It.loadTexture("./templates/shootemup/bullet.png");const e=x.createEntity(),s=new di;s.jss.setOffsetNormalized(.5,0),s.jss.setPosition(h,t),x.addComponent(e,s)}const Kc=5;class ds extends dt{speed;jss;constructor(){super("Ship"),this.speed=25,this.jss=new ne,this.jss.setPosition(0,280-32),this.jss.setTexture(It.getTexture("./templates/shootemup/ship.png"))}}class $c extends mt{constructor(){super(),super.addRequiredComponentTypename("Ship")}onEntityUpdate(t,e){const s=x.getComponent(e,ds);let i=0;Q.isActiveAction("LEFT")?i-=s.speed:Q.isActiveAction("RIGHT")&&(i+=s.speed),i!=0&&s.jss.getPositionX()+i>=-300&&s.jss.getPositionX()+i<=300-32&&s.jss.translate(i*(t/100),0),s.jss.update(t)}onEntityDraw(t){x.getComponent(t,ds).jss.draw()}onActionOnce(t,e){if(t!="UP")return;const s=x.getComponent(e,ds);if(x.findEntities(di).length>=Kc)return;const r=s.jss.getPositionX()+s.jss.getTextureRectWidth()/2,n=s.jss.getPositionY()-64;Zc(r,n)}}class Us extends dt{jss;constructor(t,e){super("Asteroid"),this.jss=new ne,this.jss.setPosition(t,e),this.jss.setTexture(It.getTexture("./templates/shootemup/asteroid.png"))}}class Jc extends mt{constructor(){super(),super.addRequiredComponentTypename("Asteroid")}onEntityUpdate(t,e){const s=x.getComponent(e,Us);if(s.jss.translate(0,7*(t/100)),s.jss.getPositionY()>300){x.removeEntity(e);return}const i=x.findEntity(ds),n=x.getComponent(i,ds).jss.getWorldBoundingRect(),o=s.jss.getWorldBoundingRect();if(n.intersectBoundingRect(o)){v.emit(this,"E_PLAYER_DESTROYED");return}s.jss.update(t)}onEntityDraw(t){x.getComponent(t,Us).jss.draw()}}async function Qc(h,t){await It.loadTexture("./templates/shootemup/asteroid.png");const e=x.createEntity();x.addComponent(e,new Us(h,t))}async function nn(h,t,e,s,i){for(let r=0;r<h;r++)for(let n=0;n<t;n++)if(e[r]!=n){const o=n*60-300+s,a=r*60-300+i;await Qc(o,a-300)}}async function tu(){await It.loadTexture("./templates/shootemup/ship.png");const h=x.createEntity();x.addComponent(h,new ds)}class eu extends yt{uiTitle;uiText;constructor(){super(),this.uiTitle=new ae,this.uiText=new ae}async onEnter(t){this.uiTitle.setText("You loose biatch !"),this.uiText.setText(`Score: ${t.score}`),P.addWidget(this.uiTitle,"display:flex; justify-content:center; align-items:center; margin-top:80px; margin-left:50px; margin-right:50px;"),P.addWidget(this.uiText,"display:flex; justify-content:center; align-items:center; margin-top:80px; margin-left:50px; margin-right:50px;")}onExit(){P.removeWidget(this.uiTitle),P.removeWidget(this.uiText)}}const on=100,an=75,hn=5,ln=8,cn=[1,2,3,4,3],su=1e4;class iu extends yt{shipSystem;asteroidSystem;bulletSystem;uiScore;score;waveAge;constructor(){super(),this.shipSystem=new $c,this.asteroidSystem=new Jc,this.bulletSystem=new Yc,this.uiScore=new ae,this.score=0,this.waveAge=0}async onEnter(){x.setup([this.shipSystem,this.asteroidSystem,this.bulletSystem]),this.uiScore.setText("Score: "+this.score),P.addWidget(this.uiScore),await tu(),await nn(hn,ln,cn,an,on),v.subscribe(this.bulletSystem,"E_ASTEROID_DESTROYED",this,this.handleAsteroidDestroyed),v.subscribe(this.asteroidSystem,"E_PLAYER_DESTROYED",this,this.handlePlayerDestroyed)}onExit(){P.removeWidget(this.uiScore)}update(t){this.waveAge>su?(nn(hn,ln,cn,an,on),this.waveAge=0):this.waveAge+=t,x.update(t)}draw(){x.draw()}handleAsteroidDestroyed(){this.score+=10,this.uiScore.setText("Score: "+this.score)}handlePlayerDestroyed(){ut.requestSetScreen(new eu,{score:this.score})}}const un=6;let Ee={DRAW:"DRAW",MAIN:"MAIN",BATTLE:"BATTLE",END:"END"},z={ONFIELD:"ONFIELD",FZONE:"FZONE",MZONE:"MZONE",SZONE:"SZONE",GRAVEYARD:"GRAVEYARD",BANNISHED:"BANNISHED",DECK:"DECK",HAND:"HAND"},wt={MONSTER:"MONSTER",SPELL:"SPELL"},ee={ATTACK:"ATTACK",DEFENSE:"DEFENSE",FACEUP:"FACEUP",FACEDOWN:"FACEDOWN"},Ye={DARK:"DARK",LIGHT:"LIGHT",EARTH:"EARTH",WIND:"WIND",FIRE:"FIRE",WATER:"WATER",DIVINE:"DIVINE"},Lt={AQUA:"AQUA",BEAST:"BEAST",BEAST_WARRIOR:"BEAST_WARRIOR",DINOSAUR:"DINOSAUR",FAIRY:"FAIRY",FIEND:"FIEND",FISH:"FISH",INSECT:"INSECT",MACHINE:"MACHINE",PLANT:"PLANT",PSYCHIC:"PSYCHIC",PYRO:"PYRO",REPTILE:"REPTILE",SEASERPENT:"SEASERPENT",SPELLCASTER:"SPELLCASTER",THUNDER:"THUNDER",WARRIOR:"WARRIOR",WINGEDBEAST:"WINGEDBEAST",ZOMBIE:"ZOMBIE",WYRM:"WYRM",DRAGON:"DRAGON",DIVINEBEAST:"DIVINEBEAST",CREATORGOD:"CREATORGOD",CYBERSE:"CYBERSE"},pi={ACTIVATE:"ACTIVATE",TRIGGER:"TRIGGER"},Bs={NORMAL:"NORMAL",CONTINUOUS:"CONTINUOUS"},Is={SINGLE:"SINGLE",FIELD:"FIELD",NONE:"NONE"};class Eo{constructor(t){this.map=t,this.modifiers=[]}get(t){if(!this.map.hasOwnProperty(t))return;let e=this.map[t];for(let s of this.modifiers)s.getAttributeKey()==t&&s.getType()=="MUL"&&(e*=s.getValue());for(let s of this.modifiers)s.getAttributeKey()==t&&s.getType()=="ADD"&&(e+=s.getValue());for(let s of this.modifiers)s.getAttributeKey()==t&&s.getType()=="SUB"&&(e-=s.getValue());for(let s of this.modifiers)s.getAttributeKey()==t&&s.getType()=="SET"&&(e=s.getValue());for(let s of this.modifiers)s.getAttributeKey()==t&&s.getType()=="FIN"&&(e=s.getValue());return e<0&&(e=0),this.map.hasOwnProperty(t+"_MIN")&&(e=Math.max(e,this.map[t+"_MIN"])),this.map.hasOwnProperty(t+"_MAX")&&(e=Math.min(e,this.map[t+"_MAX"])),e}getBase(t){if(this.map.hasOwnProperty(t))return this.map[t]}set(t,e){this.map.hasOwnProperty(t)&&(e<0&&(e=0),this.map.hasOwnProperty(t+"_MIN")&&(e=Math.max(e,this.map[t+"_MIN"])),this.map.hasOwnProperty(t+"_MAX")&&(e=Math.min(e,this.map[t+"_MAX"])),this.map[t]=e)}add(t,e){this.set(t,this.getBase(t)+e)}has(t){return this.map.hasOwnProperty(t)}addModifier(t){if(!t.isStackable()&&this.modifiers.find(e=>e.getId()==t.getId()))return!1;this.modifiers.push(t)}removeModifier(t){this.modifiers.splice(this.modifiers.indexOf(t),1)}removeModifierIf(t){for(let e of this.modifiers)t(e)&&this.modifiers.splice(this.modifiers.indexOf(e),1)}clearModifiers(){for(;this.modifiers.length;)this.modifiers.pop()}}class Co{constructor(){this.id="",this.type="",this.name="",this.text="",this.coverFile="",this.attributes,this.owner=0,this.controler=0,this.position="",this.location=z.DECK,this.turnCounter=0}async loadFromData(t){this.id=t.Id,this.type=t.Type,this.name=t.Name,this.text=t.Text,this.coverFile=t.CoverFile,this.attributes=new Eo(t.Attributes)}getId(){return this.id}getType(){return this.type}getName(){return this.name}getText(){return this.text}getCoverFile(){return this.coverFile}getAttributes(){return this.attributes}getAttribute(t){return this.attributes.get(t)}getOwner(){return this.owner}setOwner(t){this.owner=t}getControler(){return this.controler}setControler(t){this.controler=t}getPosition(){return this.position}setPosition(t){this.position=t}getLocation(){return this.location}setLocation(t){this.location=t}getTurnCounter(){return this.turnCounter}incTurnCounter(){this.turnCounter++}setAttribute(t,e){this.attributes.set(t,e)}incAttribute(t){this.attributes.set(t,this.attributes.get(t)+1)}isSummonable(t){return!1}isSetable(t){return!1}isCapableAttack(t){return!1}isCapableChangePosition(t){return!1}isActiveatable(t){return!1}isTriggerable(t,e){return!1}}class ru extends Co{constructor(){super()}async loadFromFile(t){let e=await fetch(t);await this.loadFromData(await e.json())}isSummonable(){return this.location==z.HAND}isCapableAttack(){return!(this.location!=z.MZONE||this.position!=ee.ATTACK||this.attributes.get("ATK_COUNT")>=this.attributes.get("ATK_COUNT_LIMIT"))}isCapableChangePosition(){return this.attributes.get("STATE_FREEZE")!=1}}let wi={};wi.IS_ENDLESS=function(h,t={}){return!1};wi.HAS_CARD_ID=function(h,t={targetRange,cardId}){let e=h.utilsQuery(h.getCurrentDuelistIndex(),t.targetRange,s=>s);for(let s of e)if(s.getId()==t.cardId)return!0;return!1};wi.HAS_CARD_TYPE=function(h,t={targetRange,cardType}){let e=h.utilsQuery(h.getCurrentDuelistIndex(),t.targetRange,s=>s);for(let s of e)if(s.getType()==t.cardType)return!0;return!1};function Yi(h,t,e={}){return h==""?!0:wi[h](t,e)}let To={};To.IS_EFFECT_CARD_MODIFIER_SET_STATE_FREEZE=function(h,t,e,s={}){return e instanceof ActivateEffectInternalAction&&e.effect.mechanicId=="ADD_CARD_MODIFIER"&&e.effect.mechanicOpts.modifierData.Type=="SET"&&e.effect.mechanicOpts.modifierData.AttributeKey=="STATE_FREEZE"&&e.effect.mechanicOpts.modifierData.Value==1};function nu(h,t,e,s,i={}){return h==""?!0:To[h](t,e,s,i)}class yo{constructor(){this.id="",this.type="",this.attributeKey="",this.value=0,this.stackable=!1,this.linked=!1,this.linkedEffect=null}async loadFromData(t){this.id=t.Type+"_"+t.AttributeKey,this.type=t.Type,this.attributeKey=t.AttributeKey,this.value=t.Value,this.stackable=t.Stackable,this.linked=t.Linked}getId(){return this.id}getType(){return this.type}getAttributeKey(){return this.attributeKey}getValue(){return this.value}isStackable(){return this.stackable}isLinked(){return this.linked}getLinkedEffect(){return this.linkedEffect}setLinkedEffect(t){this.linkedEffect=t}}let Ae={};Ae.NEW_TURN=async function(h,t,e,s,i={}){await h.operationNewTurn()};Ae.DRAW=async function(h,t,e,s,i={numCards}){await h.operationDraw(t.getControler(),i.numCards)};Ae.CHANGE_PHASE=async function(h,t,e,s,i={phaseId}){await h.operationChangePhase(i.phaseId)};Ae.DAMAGE_SELF=async function(h,t,e,s,i={amount}){await h.operationDamage(t.getControler(),i.amount)};Ae.DAMAGE_OPPONENT=async function(h,t,e,s,i={amount}){await h.operationDamage(Ao(t.getControler()),i.amount)};Ae.RESTORE_SELF=async function(h,t,e,s,i={amount}){await h.operationRestore(t.getControler(),i.amount)};Ae.RESTORE_OPPONENT=async function(h,t,e,s,i={amount}){await h.operationRestore(Ao(t.getControler()),i.amount)};Ae.DESTROY=async function(h,t,e,s,i={}){await h.operationDestroy(s)};Ae.ADD_MODIFIER_TO_SELF=async function(h,t,e,s,i={modifierData}){let r=new yo;await r.loadFromData(i.modifierData),r.setLinkedEffect(r.isLinked()?e:null),await h.operationAddDuelistModifier(t.getControler(),r)};Ae.ADD_CARD_MODIFIER=async function(h,t,e,s,i={modifierData}){let r=new yo;await r.loadFromData(i.modifierData),r.setLinkedEffect(r.isLinked()?e:null),await h.operationAddCardModifier(s,r)};const Ao=h=>h==0?1:0;let xi={};xi.IS_RACE=function(h,t={race}){return h.getAttribute("RACE")==t.race};xi.IS_TYPE=function(h,t={type}){return h.getType()==t.type};xi.IS_ID=function(h,t={id}){return h.getId()==t.id};function We(h,t,e={}){return h==""?!0:xi[h](t,e)}let ou=class{constructor(t){this.card=t,this.targetType="",this.targetRange="",this.targetCardConditionId="",this.targetCardConditionOpts={},this.mechanicId="",this.mechanicOpts={},this.targetCards=[]}async loadFromData(t){this.targetType=t.TargetType,this.targetRange=t.TargetRange,this.targetCardConditionId=t.TargetCardConditionId,this.targetCardConditionOpts=t.TargetCardConditionOpts,this.mechanicId=t.MechanicId,this.mechanicOpts=t.MechanicOpts}getTargetType(){return this.targetType}getTargetRange(){return this.targetRange}getTargetCards(){return this.targetCards}isPresentTarget(t){return t.utilsQuery(this.card.getControler(),this.targetRange,s=>s&&We(this.targetCardConditionId,s,this.targetCardConditionOpts)).length!=0}isTarget(t,e){let s=t.utilsQuery(this.card.getControler(),this.targetRange,i=>i&&We(this.targetCardConditionId,i,this.targetCardConditionOpts));return s.length==0?!1:s.includes(e)}hasTargetCard(t){return this.targetCards.indexOf(t)!=-1}addTargetCard(t){this.targetCards.push(t)}removeTargetCard(t){this.targetCards.splice(this.targetCards.indexOf(t),1)}apply(t,e,s){let i=Ae[this.mechanicId];i(t,e,this,s,this.mechanicOpts)}};class au extends Co{constructor(){super(),this.mode="",this.nature="",this.activateConditionId="",this.activateConditionOpts={},this.triggerConditionId="",this.triggerConditionOpts={},this.releaseConditionId="",this.releaseConditionOpts={},this.effects=[]}async loadFromData(t){this.mode=t.Mode,this.nature=t.Nature,t.hasOwnProperty("ActivateConditionId")&&(this.activateConditionId=t.ActivateConditionId,this.activateConditionOpts=t.ActivateConditionOpts),t.hasOwnProperty("TriggerConditionId")&&(this.triggerConditionId=t.TriggerConditionId,this.triggerConditionOpts=t.TriggerConditionOpts),t.hasOwnProperty("ReleaseConditionId")&&(this.releaseConditionId=t.ReleaseConditionId,this.releaseConditionOpts=t.ReleaseConditionOpts);for(let e of t.Effects){let s=new ou(this);await s.loadFromData(e),this.effects.push(s)}super.loadFromData(t)}async loadFromFile(t){let e=await fetch(t);await this.loadFromData(await e.json())}getMode(){return this.mode}getNature(){return this.nature}getEffects(){return this.effects}isSetable(){return this.location==z.HAND}isActiveatable(t){if(this.mode!=pi.ACTIVATE||this.location!=z.SZONE||this.position!=ee.FACEDOWN)return!1;for(let e of this.effects)if(!e.isPresentTarget(t))return!1;return Yi(this.activateConditionId,t,this.activateConditionOpts)}isTriggerable(t,e){if(this.mode!=pi.TRIGGER||this.location!=z.SZONE||this.position!=ee.FACEDOWN)return!1;for(let s of this.effects)if(!s.isPresentTarget(t))return!1;return nu(this.triggerConditionId,t,this,e,this.triggerConditionOpts)}isReleasable(t){return this.nature!=Bs.CONTINUOUS||this.location!=z.SZONE||this.position!=ee.FACEUP?!1:Yi(this.releaseConditionId,t,this.releaseConditionOpts)}}class hu{constructor(){this.cards=[]}async loadFromData(t){for(let e of t)if(e.startsWith("monster")){let s=new ru;await s.loadFromFile("templates/tcg/data/cards/"+e+"/data.json"),this.cards.push(s)}else if(e.startsWith("spell")){let s=new au;await s.loadFromFile("templates/tcg/data/cards/"+e+"/data.json"),this.cards.push(s)}}getCards(){return this.cards}}class Ze extends Array{constructor(t){super(),this.location=t}getLocation(){return this.location}}class wo{constructor(){this.name="",this.pictureFile="",this.deck,this.attributes,this.zones=[];let t=new Ze(z.MZONE);t.push(null,null,null),this.zones.push(t);let e=new Ze(z.SZONE);e.push(null,null,null),this.zones.push(e);let s=new Ze(z.FZONE);s.push(null),this.zones.push(s),this.zones.push(new Ze(z.DECK)),this.zones.push(new Ze(z.GRAVEYARD)),this.zones.push(new Ze(z.BANNISHED)),this.zones.push(new Ze(z.HAND))}async loadFromData(t){this.name=t.Name,this.pictureFile=t.PictureFile,this.deck=new hu,await this.deck.loadFromData(t.Deck),this.attributes=new Eo(t.Attributes)}getName(){return this.name}getPictureFile(){return this.pictureFile}getDeck(){return this.deck}getAttributes(){return this.attributes}getAttribute(t){return this.attributes.get(t)}setAttribute(t,e){this.attributes.set(t,e)}incAttribute(t){this.attributes.set(t,this.attributes.get(t)+1)}getZone(t){return this.zones.find(e=>e.getLocation()==t)}getCard(t,e){return this.zones.find(i=>i.getLocation()==t)[e]}insertCard(t,e,s){let i=this.zones.find(r=>r.getLocation()==t);i[e]=s}removeCard(t,e){let s=this.zones.find(i=>i.getLocation()==t);s.splice(s.indexOf(e),1)}pushCard(t,e){this.zones.find(i=>i.getLocation()==t).push(e)}popCard(t){return this.zones.find(s=>s.getLocation()==t).pop()}isCapableDraw(t){return!(t.getCurrentTurn().getCurrentPhase().getId()!=Ee.DRAW||this.attributes.get("DRAW_COUNT")>=this.attributes.get("DRAW_COUNT_LIMIT"))}isCapableSummon(t){let s=t.getCurrentTurn().getCurrentPhase(),r=t.getDuelists().indexOf(this);return!(s.getId()!=Ee.MAIN||this.attributes.get("STATE_CANNOT_SUMMON")==1||this.attributes.get("SUMMON_COUNT")>=this.attributes.get("SUMMON_COUNT_LIMIT")||t.utilsQuery(r,[[z.HAND],0],a=>a&&a.isSummonable()).length==0||t.utilsQuery(r,[[z.MZONE],0],a=>a==null).length==0)}isCapableSet(t){let s=t.getCurrentTurn().getCurrentPhase(),r=t.getDuelists().indexOf(this);return!(s.getId()!=Ee.MAIN||this.attributes.get("STATE_CANNOT_SET")==1||t.utilsQuery(r,[[z.HAND],0],a=>a&&a.isSetable()).length==0||t.utilsQuery(r,[[z.SZONE],0],a=>a==null).length==0)}isCapableChangePosition(t){let s=t.getCurrentTurn().getCurrentPhase(),r=t.getDuelists().indexOf(this);return!(s.getId()!=Ee.MAIN||t.utilsQuery(r,[[z.MZONE],[z.MZONE]],o=>o&&o.getControler()==r&&o.isCapableChangePosition()).length==0)}isCapableBattle(t){let s=t.getCurrentTurn().getCurrentPhase(),r=t.getDuelists().indexOf(this);return!(s.getId()!=Ee.BATTLE||t.utilsQuery(r,[[z.MZONE],[z.MZONE]],o=>o&&o.getControler()==r&&o.isCapableAttack()).length==0)}isCapableActivate(t){let s=t.getCurrentTurn().getCurrentPhase(),r=t.getDuelists().indexOf(this);return!(s.getId()!=Ee.MAIN||t.utilsQuery(r,[[z.SZONE],[z.SZONE]],o=>o&&o.getControler()==r&&o.isActiveatable(t)).length==0)}async selectLocation(t,e=()=>!0){}async selectRequiredLocation(t,e=()=>!0){}}class Ne{constructor(t){this.duel=t,this.negate=!1}isNegate(){return this.negate}setNegate(t){this.negate=t}async exec(){return!0}}class Er extends Ne{constructor(t,e){super(t),this.attackerCard=e}async exec(){await this.duel.operationDamage(this.duel.getOpponentDuelistIndex(),this.attackerCard.getAttribute("ATK")),await this.duel.operationIncCardAttribute(this.attackerCard,"ATK_COUNT")}}class xo extends Ne{constructor(t){super(t)}async exec(){await this.duel.operationDraw(this.duel.getCurrentDuelistIndex(),1),await this.duel.operationIncDuelistAttribute(this.duel.getCurrentDuelistIndex(),"DRAW_COUNT")}}class vo extends Ne{constructor(t,e,s){super(t),this.monsterCard=e,this.index=s}async exec(){await this.duel.operationSummon(this.monsterCard,this.index),await this.duel.operationIncDuelistAttribute(this.duel.getCurrentDuelistIndex(),"SUMMON_COUNT")}}class Io extends Ne{constructor(t,e,s){super(t),this.spellCard=e,this.index=s}async exec(){await this.duel.operationSet(this.spellCard,this.index)}}class So extends Ne{constructor(t,e){super(t),this.monsterCard=e}async exec(){let t=this.monsterCard.getPosition()==ee.ATTACK?ee.DEFENSE:ee.ATTACK;this.duel.operationChangePosition(this.monsterCard,t)}}class _o extends Ne{constructor(t,e,s){super(t),this.attackerCard=e,this.targetCard=s}async exec(){this.targetCard?(await this.duel.operationBattle(this.attackerCard,this.targetCard),await this.duel.operationIncCardAttribute(this.attackerCard,"ATK_COUNT")):await this.duel.runAction(new Er(this.duel,this.attackerCard))}}class bo extends Ne{constructor(t){super(t)}async exec(){await this.duel.operationNextPhase()}}class Cr extends Ne{constructor(t,e){super(t),this.spellCard=e}async exec(){await this.duel.operationChangePosition(this.spellCard,ee.FACEUP);for(let t=0;t<this.spellCard.getEffects().length;t++)await this.duel.runAction(new lu(this.duel,this.spellCard,t));this.spellCard.getNature()==Bs.NORMAL&&await this.duel.operationDestroy(this.spellCard)}}class lu extends Ne{constructor(t,e,s){super(t),this.spellCard=e,this.effectIndex=s}async exec(){await this.duel.operationActivateCardEffect(this.spellCard,this.effectIndex)}}class Mo extends wo{constructor(){super()}async loadFromFile(t){let e=await fetch(t);await this.loadFromData(await e.json())}async selectLocation(t,e=()=>!0){let s={};return s.state=!1,s.location="",s.index=0,s.card=null,await v.emitAsync(this,"E_SELECT_LOCATION",{range:t,predicateCard:e,response:s,required:!1}),s.state?s:null}async selectRequiredLocation(t,e=()=>!0){let s={};return s.state=!1,s.location="",s.index=0,s.card=null,await v.emitAsync(this,"E_SELECT_LOCATION",{range:t,predicateCard:e,response:s,required:!0}),s.state?s:null}}class rs{async exec(t){}}class cu extends rs{constructor(){super()}async exec(t){await t.runAction(new xo(t))}}class uu extends rs{constructor(){super()}async exec(t){let e=t.getCurrentDuelist(),s=await e.selectLocation([[z.HAND],0],r=>r&&r.isSummonable());if(s==null)return!1;let i=await e.selectLocation([[z.MZONE],0],r=>r==null);if(i==null)return!1;await t.runAction(new vo(t,s.card,i.index))}}class du extends rs{constructor(){super()}async exec(t){let e=t.getCurrentDuelist(),s=await e.selectLocation([[z.HAND],0],r=>r&&r.isSetable());if(s==null)return!1;let i=await e.selectLocation([[z.SZONE],0],r=>r==null);if(i==null)return!1;await t.runAction(new Io(t,s.card,i.index))}}class pu extends rs{constructor(){super()}async exec(t){let s=await t.getCurrentDuelist().selectLocation([[z.MZONE],[z.MZONE]],i=>i&&i.getControler()==t.getCurrentDuelistIndex()&&i.isCapableChangePosition());if(s==null)return!1;await t.runAction(new So(t,s.card))}}class fu extends rs{constructor(){super()}async exec(t){let e=t.getCurrentDuelist(),s=await e.selectLocation([[z.MZONE],[z.MZONE]],n=>n&&n.getControler()==t.getCurrentDuelistIndex()&&n.isCapableAttack());if(s==null)return!1;if(t.utilsQuery(t.getCurrentDuelistIndex(),[[z.MZONE],[z.MZONE]],n=>n&&n.getControler()==t.getOpponentDuelistIndex()).length==0)return await t.runAction(new Er(t,s.card)),!0;let r=await e.selectLocation([[z.MZONE],[z.MZONE]],n=>n&&n.getControler()==t.getOpponentDuelistIndex());if(r==null)return!1;await t.runAction(new _o(t,s.card,r.card))}}class mu extends rs{constructor(){super()}async exec(t){await t.runAction(new bo(t))}}class gu extends rs{constructor(){super()}async exec(t){let s=await t.getCurrentDuelist().selectLocation([[z.SZONE],[z.SZONE]],i=>i&&i.getControler()==t.getCurrentDuelistIndex()&&i.isActiveatable(t));if(s==null)return!1;await t.runAction(new Cr(t,s.card))}}function Eu(h){if(h=="DRAW")return new cu;if(h=="SUMMON")return new uu;if(h=="SET")return new du;if(h=="BATTLE")return new fu;if(h=="ACTIVATE")return new gu;if(h=="CHANGE_POSITION")return new pu;if(h=="NEXT_PHASE")return new mu;throw new Error("CREATE_COMMAND: Command name unknown !")}let Tr={};Tr.LOWEST_ATK=function(h,t){return h.getAttribute("ATK")-t.getAttribute("ATK")};Tr.HIGHEST_ATK=function(h,t){return t.getAttribute("ATK")-h.getAttribute("ATK")};function Je(h,t){return h==""?t.sort((e,s)=>e.getId()-s.getId()):t.sort((e,s)=>Tr[h](e,s))}class dn extends wo{constructor(){super(),this.behaviors=[]}async loadFromData(t){for(let e of t.OverBehaviors){let s=pn(e.Id);await s.loadFromData(e),this.behaviors.push(s)}for(let e of t.Behaviors){let s=pn(e.Id);await s.loadFromData(e),this.behaviors.push(s)}await super.loadFromData(t)}async loadFromFile(t){let e=await fetch(t);await this.loadFromData(await e.json())}async selectLocation(t,e,s=()=>!0){let r=t.getDuelists().indexOf(this),n=t.utilsQuery(r,e,a=>s(a));if(n.length==0)return!1;let o={};return o.state=!0,o.location="",o.index=-1,o.card=n[0],o}async selectRequiredLocation(t,e,s=()=>!0){let r=t.getDuelists().indexOf(this),n=t.utilsQuery(r,e,a=>s(a));if(n.length==0)return!1;let o={};return o.state=!0,o.location="",o.index=-1,o.card=n[0],o}async handleNewTurn(t){for(;t.getCurrentDuelist()==this;){for(let e of this.behaviors)await e.process(t);await t.runAction(new bo(t)),await f.WAIT(2e3)}}}class ys{constructor(){this.id="",this.opts={},this.repeat=1,this.probability=1,this.conditionId="",this.conditionOpts={},this.cardConditionId="",this.cardConditionOpts={},this.cardSortId="",this.targetCardConditionId="",this.targetCardConditionOpts={},this.targetCardSortId=""}async loadFromData(t){this.id=t.Id,t.hasOwnProperty("Opts")&&(this.opts=t.Opts),t.hasOwnProperty("Repeat")&&(this.repeat=t.Repeat=="X"?99:t.Repeat),t.hasOwnProperty("Probability")&&(this.probability=t.Probability),t.hasOwnProperty("ConditionId")&&(this.conditionId=t.ConditionId,this.conditionOpts=t.ConditionOpts),t.hasOwnProperty("CardConditionId")&&(this.cardConditionId=t.CardConditionId,this.cardConditionOpts=t.CardConditionOpts),t.hasOwnProperty("CardSortId")&&(this.cardSortId=t.CardSortId),t.hasOwnProperty("TargetCardConditionId")&&(this.targetCardConditionId=t.TargetCardConditionId,this.targetCardConditionOpts=t.TargetCardConditionOpts),t.hasOwnProperty("TargetCardSortId")&&(this.targetCardSortId=t.TargetCardSortId)}async process(t){if(Yi(this.conditionId,t,this.conditionOpts)&&!(Math.random()>this.probability))for(let e=0;e<this.repeat;e++)await this.onProcess(t)}async onProcess(t){}}class Cu extends ys{constructor(){super()}async onProcess(t){let e=t.getCurrentDuelist();for(;e.isCapableDraw(t);)await t.runAction(new xo(t))}}class Tu extends ys{constructor(){super()}async onProcess(t){let e=t.getCurrentDuelist(),s=t.getCurrentDuelistIndex();if(!e.isCapableSummon(t))return;let i=t.utilsQuery(s,[[z.HAND],0],n=>n&&n.isSummonable()&&We(this.cardConditionId,n,this.cardConditionOpts));if(i.length==0)return;i=Je(this.cardSortId,i);let r=e.getZone(z.MZONE).findIndex(n=>n==null);await t.runAction(new vo(t,i[0],r))}}class yu extends ys{constructor(){super()}async onProcess(t){let e=t.getCurrentDuelist(),s=t.getCurrentDuelistIndex();if(!e.isCapableSet(t))return;let i=t.utilsQuery(s,[[z.HAND],0],n=>n&&n.isSetable()&&We(this.cardConditionId,n,this.cardConditionOpts));if(i.length==0)return;i=Je(this.cardSortId,i);let r=e.getZone(z.SZONE).findIndex(n=>n==null);await t.runAction(new Io(t,i[0],r))}}class Au extends ys{constructor(){super()}async onProcess(t){let e=t.getCurrentDuelist(),s=t.getCurrentDuelistIndex();if(!e.isCapableChangePosition(t))return;let i=t.utilsQuery(s,[[z.MZONE],[z.MZONE]],r=>r&&r.getControler()==s&&r.isCapableChangePosition()&&We(this.cardConditionId,r,this.cardConditionOpts));i.length!=0&&(i=Je(this.cardSortId,i),await t.runAction(new So(t,i[0])))}}class wu extends ys{constructor(){super()}async onProcess(t){let e=t.getCurrentDuelist(),s=t.getCurrentDuelistIndex();if(!e.isCapableBattle(t))return;let i=t.utilsQuery(s,[[z.MZONE],[z.MZONE]],n=>n&&n.getControler()==s&&n.isCapableAttack()&&We(this.cardConditionId,n,this.cardConditionOpts));if(i.length==0)return;let r=t.utilsQuery(s,[[z.MZONE],[z.MZONE]],n=>n&&n.getControler()!=s&&We(this.targetCardConditionId,n,this.targetCardConditionOpts));r.length==0?(i=Je(this.cardSortId,i),await t.runAction(new Er(t,i[0]))):(i=Je(this.cardSortId,i),r=Je(this.targetCardSortId,r),await t.runAction(new _o(t,i[0],r[0])))}}class xu extends ys{constructor(){super()}async onProcess(t){let e=t.getCurrentDuelist(),s=t.getCurrentDuelistIndex();if(!e.isCapableActivate(t))return;let i=t.utilsQuery(s,[[z.MZONE],[z.MZONE]],r=>r&&r.getControler()==s&&r.isActiveatable(t)&&We(this.cardConditionId,r,this.cardConditionOpts));i.length!=0&&(i=Je(this.cardSortId,i),await t.runAction(new Cr(t,i[0])))}}function pn(h){if(h=="DRAW")return new Cu;if(h=="SUMMON")return new Tu;if(h=="SET")return new yu;if(h=="CHANGE_POSITION")return new Au;if(h=="BATTLE")return new wu;if(h=="ACTIVATE_CARD")return new xu;throw new Error("AIDuelist::CREATE_BEHAVIOR(): Behavior name unknown !")}class fn{constructor(){this.phases=[],this.currentPhase=null}getPhases(){return this.phases}getPhase(t){return this.phases.find(e=>e.id==t)}addPhase(t){this.phases.push(t)}getCurrentPhase(){return this.currentPhase}setCurrentPhase(t){this.currentPhase=t}}class vi{constructor(t,e,s=!1){this.id=t,this.name=e,this.disabled=s}getId(){return this.id}getName(){return this.name}isDisabled(){return this.disabled}setDisabled(t){this.disabled=t}}class vu{constructor(){this.duelists=[],this.turns=[],this.currentTurn=null,this.currentDuelistIndex=-1,this.opponentDuelistIndex=-1}async loadFromData(t){for(let e=0;e<2;e++){let s=t.DuelistIds[e],i=s.TypeName=="AIDuelist"?new dn:new Mo;await i.loadFromFile("templates/tcg/data/duelist_"+s.Id+"/data.json");let r=i.getDeck();for(let n of r.getCards())n.setOwner(e),n.setControler(e),i.pushCard(z.DECK,n);this.duelists.push(i)}}async loadFromFile(t){let e=await fetch(t);await this.loadFromData(await e.json())}startup(){this.operationDraw(0,4),this.operationDraw(1,4),this.operationNewTurn()}async runAction(t){let e=this.utilsQuery(this.currentDuelistIndex,[[z.SZONE],[z.SZONE]],r=>r),s=this.utilsQuery(this.currentDuelistIndex,[[z.MZONE,z.SZONE,z.FZONE],[z.MZONE,z.SZONE,z.FZONE]],r=>r);for(let r of e)r.isTriggerable(this,t)&&await this.runAction(new Cr(this,r));if(!t.isNegate())await t.exec();else return;for(let r of e)r.isReleasable(this)&&await this.operationDestroy(r);for(let r of e)if(r.getPosition()==ee.FACEUP&&r.getNature()==Bs.CONTINUOUS){for(let n of s)for(let o of r.getEffects())o.getTargetType()==Is.FIELD&&(o.hasTargetCard(n)&&!o.isTarget(this,n)?(o.removeTargetCard(n),n.getAttributes().removeModifierIf(l=>l.isLinked()&&l.getLinkedEffect()==o)):!o.hasTargetCard(n)&&o.isTarget(this,n)&&(o.addTargetCard(n),o.apply(this,r,n)));for(let n of r.getEffects())if(n.getTargetType()==Is.SINGLE)for(let o of n.getTargetCards())(o==null||!n.isTargetConditionCheck(o))&&await this.operationDestroy(r)}if(this.duelists[0].getAttribute("LIFEPOINTS")==0)return"WIN";if(this.duelists[1].getAttribute("LIFEPOINTS")==0)return"LOST";if(this.currentTurn.getCurrentPhase().getId()==Ee.END)return this.operationNewTurn()}getDuelists(){return this.duelists}getDuelist(t){return this.duelists[t]}getCurrentDuelist(){return this.duelists[this.currentDuelistIndex]}getOpponentDuelist(){return this.duelists[this.opponentDuelistIndex]}getCurrentTurn(){return this.currentTurn}getCurrentDuelistIndex(){return this.currentDuelistIndex}getOpponentDuelistIndex(){return this.opponentDuelistIndex}async operationNewTurn(){if(this.currentDuelistIndex==-1?(this.currentDuelistIndex=1,this.opponentDuelistIndex=0):this.currentDuelistIndex==0?(this.currentDuelistIndex=1,this.opponentDuelistIndex=0):(this.currentDuelistIndex=0,this.opponentDuelistIndex=1),this.turns.length<2){let t=new fn,e=t.getPhases();t.addPhase(mn()),t.addPhase(gn()),t.addPhase(En()),t.setCurrentPhase(e[0]),this.turns.push(t),this.currentTurn=t}else{let t=new fn,e=t.getPhases();t.addPhase(mn()),t.addPhase(gn()),t.addPhase(Iu()),t.addPhase(En()),t.setCurrentPhase(e[0]),this.turns.push(t),this.currentTurn=t}for(let t of this.duelists)t.setAttribute("DRAW_COUNT",0),t.setAttribute("SUMMON_COUNT",0);for(let t of this.utilsQuery(this.currentDuelistIndex,[[z.SZONE,z.MZONE,z.FZONE],[z.SZONE,z.MZONE,z.FZONE]],e=>e))t.getType()==wt.MONSTER?(t.setAttribute("ATK_COUNT",0),t.incTurnCounter()):t.getType()==wt.SPELL&&t.getPosition()==ee.FACEUP&&t.incTurnCounter();this.duelists[this.currentDuelistIndex]instanceof dn&&this.duelists[this.currentDuelistIndex].handleNewTurn(this),v.emit(this,"E_NEW_TURN")}async operationDraw(t,e){let s=this.duelists[t].getZone(z.HAND);if(s.length+e>un)for(let i=0;i<s.length+e-un;i++){let r=await this.operationSelectLocation([[z.HAND],0],n=>n);this.duelists[t].removeCard(z.HAND,r.card)}for(;e-- >0;){let i=this.duelists[t].popCard(z.DECK);this.duelists[t].pushCard(z.HAND,i),i.setLocation(z.HAND)}}async operationRestore(t,e){this.duelists[t].getAttributes().add("LIFEPOINTS",+e),v.emit(this.duelists[t],"E_RESTORE",{amount:e})}async operationDamage(t,e){this.duelists[t].getAttributes().add("LIFEPOINTS",-e),v.emit(this.duelists[t],"E_DAMAGE",{amount:e})}async operationSummon(t,e){this.duelists[t.getControler()].removeCard(z.HAND,t),this.duelists[t.getControler()].insertCard(z.MZONE,e,t),t.setPosition(ee.ATTACK),t.setLocation(z.MZONE)}async operationSet(t,e){this.duelists[t.getControler()].removeCard(z.HAND,t),this.duelists[t.getControler()].insertCard(z.SZONE,e,t),t.setPosition(ee.FACEDOWN),t.setLocation(z.SZONE)}async operationChangePosition(t,e){t.setPosition(e)}async operationBattle(t,e){let s=e.getPosition()==ee.ATTACK?e.getAttribute("ATK"):e.getAttribute("DEF"),i=t.getAttribute("ATK")-s;i>0?(this.operationDestroy(e),this.operationDamage(e.getControler(),Math.abs(i))):i<0?(this.operationDestroy(t),this.operationDamage(t.getControler(),Math.abs(i))):(this.operationDestroy(e),this.operationDestroy(t))}async operationNextPhase(){let t=this.currentTurn.getPhases(),e=t.indexOf(this.currentTurn.getCurrentPhase())+1;for(;t[e].isDisabled()&&e<t.length;)e++;this.currentTurn.setCurrentPhase(t[e])}async operationChangePhase(t){let e=this.currentTurn.getPhase(t);if(!e)throw new Error("Duel::operationChangePhase : phase not found !");if(e.isDisabled())throw new Error("Duel::operationChangePhase : phase is disabled !");this.currentTurn.setCurrentPhase(e)}async operationIncDuelistAttribute(t,e){this.duelists[t].incAttribute(e)}async operationAddDuelistModifier(t,e){this.duelists[t].getAttributes().addModifier(e)}async operationIncCardAttribute(t,e){t.incAttribute(e)}async operationAddCardModifier(t,e){t.getAttributes().addModifier(e)}async operationDestroy(t){if(t.getType()==wt.SPELL)for(let e of t.getEffects()){for(let s of e.getTargetCards())s.getAttributes().removeModifierIf(r=>r.isLinked()&&r.getLinkedEffect()==e);for(let s of this.duelists)s.getAttributes().removeModifierIf(r=>r.isLinked()&&r.getLinkedEffect()==e)}this.utilsRemoveCard(t),this.duelists[t.getControler()].pushCard(z.GRAVEYARD,t),t.setPosition(ee.FACEDOWN),t.setLocation(z.GRAVEYARD)}async operationActivateCardEffect(t,e){let s=[],r=t.getEffects()[e],n=t.getControler();if(r.getTargetType()==Is.SINGLE){let o=await this.duelists[n].selectRequiredLocation(r.getTargetRange(),a=>a&&r.isTarget(this,a));s.push(o.card)}else r.getTargetType()==Is.FIELD?s=this.utilsQuery(n,r.getTargetRange(),o=>o&&r.isTarget(this,o)):r.getTargetType()==Is.NONE&&(s=[null]);for(let o of s)r.apply(this,t,o),r.addTargetCard(o)}utilsRemoveCard(t){let e=this.duelists[t.getOwner()];if(t.getLocation()==z.MZONE||t.getLocation()==z.SZONE||t.getLocation()==z.FZONE){let i=e.getZone(t.getLocation()).indexOf(t);e.insertCard(t.getLocation(),i,null)}else e.removeCard(t.getLocation(),t)}utilsQuery(t,e,s=i=>!0){let i=[],r=t,n=t==0?1:0;for(let o=0;o<2;o++){if(e[o]==0)continue;let a=o==0?r:n;for(let l=0;l<e[o].length;l++){let c=this.duelists[a].getZone(e[o][l]);i=i.concat(c.filter(s))}}return i}}function mn(){return new vi(Ee.DRAW,"Draw Phase",!1)}function gn(){return new vi(Ee.MAIN,"Main Phase",!1)}function Iu(){return new vi(Ee.BATTLE,"Battle Phase",!1)}function En(){return new vi(Ee.END,"End Phase",!1)}class Su extends xt{constructor(){super({className:"UITurn"}),this.duel=null}update(){if(this.node.innerHTML="",this.duel&&this.duel.getCurrentTurn()){let t=this.duel.getCurrentTurn();for(let e of t.getPhases())this.node.innerHTML+=`<div class="UITurn-phase ${t.getCurrentPhase()==e?"u-active":""}">${e.getName()}</div>`}}setDuel(t){this.duel=t||null}}class Cn extends xt{constructor(){super({className:"UIDuelist",template:`
      <div class="UIDuelist-picture js-picture"></div>
      <div class="UIDuelist-infos">
        <div class="UIDuelist-infos-name js-name"></div>
        <div class="UIDuelist-infos-lifepoints js-lifepoints"></div>
      </div>`}),this.duelist=null}update(){this.duelist?(this.node.querySelector(".js-picture").style.backgroundImage=`url(${this.duelist.getPictureFile()})`,this.node.querySelector(".js-name").textContent=this.duelist.getName(),this.node.querySelector(".js-lifepoints").textContent=this.duelist.getAttribute("LIFEPOINTS")):(this.node.querySelector(".js-picture").style.backgroundImage="url()",this.node.querySelector(".js-name").textContent="--",this.node.querySelector(".js-lifepoints").textContent="0")}setDuelist(t){v.unsubscribe(this.duelist,"E_DAMAGE",this),v.unsubscribe(this.duelist,"E_RESTORE",this),t?(v.subscribe(t,"E_DAMAGE",this,this.handleDuelistDamage),v.subscribe(t,"E_RESTORE",this,this.handleDuelistRestore),this.duelist=t):this.duelist=null}showSelection(){this.node.classList.add("u-showSelection")}hideSelection(){this.node.classList.remove("u-showSelection")}handleDuelistDamage(t){Tn(this.node,"-"+t.amount,"#fff",1e3),_u(this.node,300)}handleDuelistRestore(t){Tn(this.node,"+"+t.amount,"#fff",1e3)}}function _u(h,t){return new Promise(e=>{setTimeout(()=>{h.classList.add("u-shake")},0),setTimeout(()=>{h.classList.remove("u-shake"),e()},t)})}function Tn(h,t,e,s){return new Promise(i=>{let r=document.createElement("div");r.className="UIDuelist-toast",r.textContent=t,r.style.color=e,h.appendChild(r),setTimeout(()=>{r.remove(),i()},s)})}class bu extends xt{constructor(){super({className:"UICardDetail",template:`
      <div class="UICardDetail-title js-title"></div>
      <div class="UICardDetail-body">
        <img class="UICardDetail-body-coverImg js-cover-img">
        <div class="UICardDetail-body-infos js-infos"></div>
      </div>`}),this.card=null}update(){this.card?(this.node.querySelector(".js-title").textContent=this.card.getName(),this.node.querySelector(".js-cover-img").src=this.card.getCoverFile(),this.node.querySelector(".js-infos").textContent="",this.card.getType()==wt.MONSTER?this.node.querySelector(".js-infos").textContent+=`Type: MONSTRE
`:this.card.getType()==wt.SPELL&&(this.node.querySelector(".js-infos").textContent+=`Type: MAGIE
`),this.card.getAttribute("ELEMENT")==Ye.DARK?this.node.querySelector(".js-infos").textContent+=`Element: TENEBRE
`:this.card.getAttribute("ELEMENT")==Ye.LIGHT?this.node.querySelector(".js-infos").textContent+=`Element: LUMIERE
`:this.card.getAttribute("ELEMENT")==Ye.EARTH?this.node.querySelector(".js-infos").textContent+=`Element: TERRE
`:this.card.getAttribute("ELEMENT")==Ye.WIND?this.node.querySelector(".js-infos").textContent+=`Element: VENT
`:this.card.getAttribute("ELEMENT")==Ye.FIRE?this.node.querySelector(".js-infos").textContent+=`Element: FEU
`:this.card.getAttribute("ELEMENT")==Ye.WATER?this.node.querySelector(".js-infos").textContent+=`Element: EAU
`:this.card.getAttribute("ELEMENT")==Ye.DIVINE&&(this.node.querySelector(".js-infos").textContent+=`Element: DIVIN
`),this.card.getType()==wt.SPELL&&this.card.getNature()==Bs.NORMAL?this.node.querySelector(".js-infos").textContent+=`Nature: NORMAL
`:this.card.getType()==wt.SPELL&&this.card.getNature()==Bs.CONTINUOUS&&(this.node.querySelector(".js-infos").textContent+=`Nature: CONTINUE
`),this.card.getType()==wt.SPELL&&this.card.getMode()==pi.ACTIVATE?this.node.querySelector(".js-infos").textContent+=`Mode: ACTIVATION
`:this.card.getType()==wt.SPELL&&this.card.getMode()==pi.TRIGGER&&(this.node.querySelector(".js-infos").textContent+=`Mode: PIEGE
`),this.card.getType()==wt.MONSTER&&this.card.getAttribute("RACE")==Lt.AQUA?this.node.querySelector(".js-infos").textContent+=`Race: AQUA
`:this.card.getType()==wt.MONSTER&&this.card.getAttribute("RACE")==Lt.BEAST?this.node.querySelector(".js-infos").textContent+=`Race: BETE
`:this.card.getType()==wt.MONSTER&&this.card.getAttribute("RACE")==Lt.BEAST_WARRIOR?this.node.querySelector(".js-infos").textContent+=`Race: BETE GUERRIERE
`:this.card.getType()==wt.MONSTER&&this.card.getAttribute("RACE")==Lt.DINOSAUR?this.node.querySelector(".js-infos").textContent+=`Race: DINOSAURE
`:this.card.getType()==wt.MONSTER&&this.card.getAttribute("RACE")==Lt.FAIRY?this.node.querySelector(".js-infos").textContent+=`Race: FEE
`:this.card.getType()==wt.MONSTER&&this.card.getAttribute("RACE")==Lt.FIEND?this.node.querySelector(".js-infos").textContent+=`Race: DEMON
`:this.card.getType()==wt.MONSTER&&this.card.getAttribute("RACE")==Lt.FISH?this.node.querySelector(".js-infos").textContent+=`Race: POISSON
`:this.card.getType()==wt.MONSTER&&this.card.getAttribute("RACE")==Lt.INSECT?this.node.querySelector(".js-infos").textContent+=`Race: INSECTE
`:this.card.getType()==wt.MONSTER&&this.card.getAttribute("RACE")==Lt.MACHINE?this.node.querySelector(".js-infos").textContent+=`Race: MACHINE
`:this.card.getType()==wt.MONSTER&&this.card.getAttribute("RACE")==Lt.PLANT?this.node.querySelector(".js-infos").textContent+=`Race: PLANTE
`:this.card.getType()==wt.MONSTER&&this.card.getAttribute("RACE")==Lt.PSYCHIC?this.node.querySelector(".js-infos").textContent+=`Race: PSYCHIQUE
`:this.card.getType()==wt.MONSTER&&this.card.getAttribute("RACE")==Lt.PYRO?this.node.querySelector(".js-infos").textContent+=`Race: PYRO
`:this.card.getType()==wt.MONSTER&&this.card.getAttribute("RACE")==Lt.REPTILE?this.node.querySelector(".js-infos").textContent+=`Race: REPTILE
`:this.card.getType()==wt.MONSTER&&this.card.getAttribute("RACE")==Lt.SEASERPENT?this.node.querySelector(".js-infos").textContent+=`Race: SERPENT DE MER
`:this.card.getType()==wt.MONSTER&&this.card.getAttribute("RACE")==Lt.SPELLCASTER?this.node.querySelector(".js-infos").textContent+=`Race: MAGICIEN
`:this.card.getType()==wt.MONSTER&&this.card.getAttribute("RACE")==Lt.THUNDER?this.node.querySelector(".js-infos").textContent+=`Race: ECLAIR
`:this.card.getType()==wt.MONSTER&&this.card.getAttribute("RACE")==Lt.WARRIOR?this.node.querySelector(".js-infos").textContent+=`Race: GUERRIER
`:this.card.getType()==wt.MONSTER&&this.card.getAttribute("RACE")==Lt.WINGEDBEAST?this.node.querySelector(".js-infos").textContent+=`Race: BETE AILEE
`:this.card.getType()==wt.MONSTER&&this.card.getAttribute("RACE")==Lt.ZOMBIE?this.node.querySelector(".js-infos").textContent+=`Race: ZOMBIE
`:this.card.getType()==wt.MONSTER&&this.card.getAttribute("RACE")==Lt.WYRM?this.node.querySelector(".js-infos").textContent+=`Race: WYRM
`:this.card.getType()==wt.MONSTER&&this.card.getAttribute("RACE")==Lt.DRAGON?this.node.querySelector(".js-infos").textContent+=`Race: DRAGON
`:this.card.getType()==wt.MONSTER&&this.card.getAttribute("RACE")==Lt.DIVINEBEAST?this.node.querySelector(".js-infos").textContent+=`Race: DIVINITE
`:this.card.getType()==wt.MONSTER&&this.card.getAttribute("RACE")==Lt.CREATORGOD?this.node.querySelector(".js-infos").textContent+=`Race: DIEU CREATEUR
`:this.card.getType()==wt.MONSTER&&this.card.getAttribute("RACE")==Lt.CYBERSE&&(this.node.querySelector(".js-infos").textContent+=`Race: CYBORG
`),this.node.querySelector(".js-infos").textContent+="Description: "+this.card.getText()+`
`,this.card.getType()==wt.MONSTER&&(this.node.querySelector(".js-infos").innerHTML+=`
        <div class="UICardDetail-body-infos-stats">
          <div class="UICardDetail-body-infos-stats-item">ATK ${this.card.getAttribute("ATK")}</div>
          <div class="UICardDetail-body-infos-stats-item">DEF ${this.card.getAttribute("DEF")}</div>
        </div>`)):(this.node.querySelector(".js-title").textContent="--",this.node.querySelector(".js-cover-img").src="",this.node.querySelector(".js-infos").textContent="")}setCard(t){this.card=t||null}}class fi extends xt{constructor(){super({className:"UICardSlot",template:`
      <div class="UICardSlot-bg js-bg"></div>`}),this.card=null,this.duelistIndex=0,this.location="",this.index=0,this.hidden=!1,this.selectable=!1}update(){this.card?(this.node.style.transform=`rotate(${this.card.getPosition()==ee.DEFENSE?"90deg":"0deg"})`,this.node.querySelector(".js-bg").style.backgroundImage=this.hidden?"url(templates/tcg/card_back.png)":"url("+this.card.getCoverFile()+")"):(this.node.style.transform="rotate(0deg)",this.node.querySelector(".js-bg").style.backgroundImage="url()")}getCard(){return this.card}setCard(t){this.card=t||null}getDuelistIndex(){return this.duelistIndex}setDuelistIndex(t){this.duelistIndex=t}getLocation(){return this.location}setLocation(t){this.location=t}getIndex(){return this.index}setIndex(t){this.index=t}isHidden(){return this.hidden}setHidden(t){this.hidden=t}isSelectable(){return this.node.classList.contains("u-selectable")}setSelectable(t){this.node.classList.toggle("u-selectable",t)}}class Po extends xt{constructor(){super({className:"UIStackSlot",template:`
        <div class="UIStackSlot-bg js-bg"></div>
        <div class="UIStackSlot-numCards js-num-cards"></div>`}),this.cards=[],this.duelistIndex=0,this.location="",this.hidden=!1,this.selectable=!1}update(){if(this.cards.length>0){let t=this.cards[this.cards.length-1];this.node.querySelector(".js-bg").style.backgroundImage=this.hidden?"url(templates/tcg/card_back.png)":"url("+t.getCoverFile()+")",this.node.querySelector(".js-num-cards").textContent=this.cards.length}else this.node.querySelector(".js-bg").style.backgroundImage="url()",this.node.querySelector(".js-num-cards").textContent=0}setCards(t){this.cards=t||[]}getDuelistIndex(){return this.duelistIndex}setDuelistIndex(t){this.duelistIndex=t}getLocation(){return this.location}setLocation(t){this.location=t}isHidden(){return this.hidden}setHidden(t){this.hidden=t}isSelectable(){return this.node.classList.contains("u-selectable")}setSelectable(t){this.node.classList.toggle("u-selectable",t)}}class Mu extends xt{constructor(){super({className:"UIBoard",template:`
      <div class="UIBoard-fields">
        <div class="UIBoard-field" data-duelist-index="0">
          <div class="UIBoard-field-zone js-zone" data-duelist-index="0" data-location="MZONE" style="top:80px; left:127px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="0" data-location="MZONE" style="top:80px; left:177px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="0" data-location="MZONE" style="top:80px; left:227px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="0" data-location="SZONE" style="top:10px; left:127px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="0" data-location="SZONE" style="top:10px; left:177px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="0" data-location="SZONE" style="top:10px; left:227px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="0" data-location="FZONE" style="top:150px; left:10px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="0" data-location="GRAVEYARD" style="top:80px; left:10px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="0" data-location="DECK" style="top:10px; left:10px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="0" data-location="HAND" style="top:10px; right:10px;"></div>
        </div>
        <div class="UIBoard-field" data-duelist-index="1">
          <div class="UIBoard-field-zone js-zone" data-duelist-index="1" data-location="MZONE" style="bottom:80px; right:127px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="1" data-location="MZONE" style="bottom:80px; right:177px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="1" data-location="MZONE" style="bottom:80px; right:227px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="1" data-location="SZONE" style="bottom:10px; right:127px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="1" data-location="SZONE" style="bottom:10px; right:177px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="1" data-location="SZONE" style="bottom:10px; right:227px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="1" data-location="FZONE" style="bottom:150px; right:10px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="1" data-location="GRAVEYARD" style="bottom:80px; right:10px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="1" data-location="DECK" style="bottom:10px; right:10px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="1" data-location="HAND" style="bottom:10px; left:10px;"></div>
        </div>
      </div>`}),this.duel=null,this.slots=[],this.focusedSlot=null;let t=Pt(0,z.SZONE,0,!1);this.node.querySelectorAll('.js-zone[data-duelist-index="0"][data-location="SZONE"]')[0].appendChild(t.getNode()),this.slots.push(t);let s=Pt(0,z.SZONE,1,!1);this.node.querySelectorAll('.js-zone[data-duelist-index="0"][data-location="SZONE"]')[1].appendChild(s.getNode()),this.slots.push(s);let r=Pt(0,z.SZONE,2,!1);this.node.querySelectorAll('.js-zone[data-duelist-index="0"][data-location="SZONE"]')[2].appendChild(r.getNode()),this.slots.push(r);let o=Pt(0,z.MZONE,0,!1);this.node.querySelectorAll('.js-zone[data-duelist-index="0"][data-location="MZONE"]')[0].appendChild(o.getNode()),this.slots.push(o);let l=Pt(0,z.MZONE,1,!1);this.node.querySelectorAll('.js-zone[data-duelist-index="0"][data-location="MZONE"]')[1].appendChild(l.getNode()),this.slots.push(l);let u=Pt(0,z.MZONE,2,!1);this.node.querySelectorAll('.js-zone[data-duelist-index="0"][data-location="MZONE"]')[2].appendChild(u.getNode()),this.slots.push(u);let d=Pt(0,z.HAND,0,!0),E=this.node.querySelectorAll('.js-zone[data-duelist-index="0"][data-location="HAND"]')[0];E.appendChild(d.getNode()),this.slots.push(d);let m=Pt(0,z.HAND,1,!0);E.appendChild(m.getNode()),this.slots.push(m);let y=Pt(0,z.HAND,2,!0);E.appendChild(y.getNode()),this.slots.push(y);let C=Pt(0,z.HAND,3,!0);E.appendChild(C.getNode()),this.slots.push(C);let w=Pt(0,z.HAND,4,!0);E.appendChild(w.getNode()),this.slots.push(w);let A=Pt(0,z.HAND,5,!0);E.appendChild(A.getNode()),this.slots.push(A);let _=Pt(0,z.FZONE,0,!1);this.node.querySelectorAll('.js-zone[data-duelist-index="0"][data-location="FZONE"]')[0].appendChild(_.getNode()),this.slots.push(_);let L=Zs(0,z.GRAVEYARD,!1);this.node.querySelectorAll('.js-zone[data-duelist-index="0"][data-location="GRAVEYARD"]')[0].appendChild(L.getNode()),this.slots.push(L);let H=Zs(0,z.DECK,!0);this.node.querySelectorAll('.js-zone[data-duelist-index="0"][data-location="DECK"]')[0].appendChild(H.getNode()),this.slots.push(H);let W=Pt(1,z.SZONE,0,!1);this.node.querySelectorAll('.js-zone[data-duelist-index="1"][data-location="SZONE"]')[0].appendChild(W.getNode()),this.slots.push(W);let b=Pt(1,z.SZONE,1,!1);this.node.querySelectorAll('.js-zone[data-duelist-index="1"][data-location="SZONE"]')[1].appendChild(b.getNode()),this.slots.push(b);let T=Pt(1,z.SZONE,2,!1);this.node.querySelectorAll('.js-zone[data-duelist-index="1"][data-location="SZONE"]')[2].appendChild(T.getNode()),this.slots.push(T);let ot=Pt(1,z.MZONE,0,!1);this.node.querySelectorAll('.js-zone[data-duelist-index="1"][data-location="MZONE"]')[0].appendChild(ot.getNode()),this.slots.push(ot);let ct=Pt(1,z.MZONE,1,!1);this.node.querySelectorAll('.js-zone[data-duelist-index="1"][data-location="MZONE"]')[1].appendChild(ct.getNode()),this.slots.push(ct);let at=Pt(1,z.MZONE,2,!1);this.node.querySelectorAll('.js-zone[data-duelist-index="1"][data-location="MZONE"]')[2].appendChild(at.getNode()),this.slots.push(at);let F=Pt(1,z.HAND,0,!1),rt=this.node.querySelectorAll('.js-zone[data-duelist-index="1"][data-location="HAND"]')[0];rt.appendChild(F.getNode()),this.slots.push(F);let tt=Pt(1,z.HAND,1,!1);rt.appendChild(tt.getNode()),this.slots.push(tt);let $=Pt(1,z.HAND,2,!1);rt.appendChild($.getNode()),this.slots.push($);let _t=Pt(1,z.HAND,3,!1);rt.appendChild(_t.getNode()),this.slots.push(_t);let Nt=Pt(1,z.HAND,4,!1);rt.appendChild(Nt.getNode()),this.slots.push(Nt);let pt=Pt(1,z.HAND,5,!1);rt.appendChild(pt.getNode()),this.slots.push(pt);let gt=Pt(1,z.FZONE,0,!1);this.node.querySelectorAll('.js-zone[data-duelist-index="1"][data-location="FZONE"]')[0].appendChild(gt.getNode()),this.slots.push(gt);let bt=Zs(1,z.GRAVEYARD,!1);this.node.querySelectorAll('.js-zone[data-duelist-index="1"][data-location="GRAVEYARD"]')[0].appendChild(bt.getNode()),this.slots.push(bt);let Qt=Zs(1,z.DECK,!1);this.node.querySelectorAll('.js-zone[data-duelist-index="1"][data-location="DECK"]')[0].appendChild(Qt.getNode()),this.slots.push(Qt),this.focusedSlot=H}update(){if(this.duel){for(let t of this.slots){let e=this.duel.getDuelist(t.getDuelistIndex());t instanceof fi?t.setCard(e.getCard(t.getLocation(),t.getIndex())):t.setCards(e.getZone(t.getLocation()))}for(let t of this.slots)t.update()}}delete(){for(let t of this.slots)t.delete();super.delete()}focus(){this.focusedSlot&&(this.focusedSlot.focus(),v.emit(this,"E_SLOT_FOCUSED",{slot:this.focusedSlot})),super.focus()}unfocus(){this.focusedSlot&&(this.focusedSlot.unfocus(),v.emit(this,"E_SLOT_UNFOCUSED")),super.unfocus()}getSlots(){return this.slots}setDuel(t){for(let e of this.slots)e instanceof fi?e.setCard(null):e instanceof Po&&e.setCards(null);this.duel=t||null}onAction(t){t=="BACK"?v.emit(this,"E_ECHAP_PRESSED"):t=="OK"?(v.emit(this,"E_SLOT_SELECTED",{slot:this.focusedSlot}),v.emit(this,"E_OK_PRESSED")):t=="UP"?this.#t(0,-1,!0):t=="DOWN"?this.#t(0,1,!0):t=="LEFT"?this.#t(-1,0,!0):t=="RIGHT"&&this.#t(1,0,!0)}#t(t,e,s=!1){let i=this.focusedSlot.getNode(),r=Oi(i),n=r.left+i.offsetWidth*.5,o=r.top+i.offsetHeight*.5,a=this.slots.slice();a.splice(a.indexOf(this.focusedSlot),1);let l=a.sort((c,u)=>{let p=c.getNode(),d=u.getNode(),E=Oi(p),m=Oi(d),y=E.left+p.offsetWidth*.5,C=E.top+p.offsetHeight*.5,w=m.left+d.offsetWidth*.5,A=m.top+d.offsetHeight*.5,_=[y-n,C-o],M=[w-n,A-o];return _[0]=Math.sign(_[0])==Math.sign(t)||t==0?Math.abs(_[0]):this.node.offsetWidth-Math.abs(_[0]),_[1]=Math.sign(_[1])==Math.sign(e)||e==0?Math.abs(_[1]):this.node.offsetHeight-Math.abs(_[1]),M[0]=Math.sign(M[0])==Math.sign(t)||t==0?Math.abs(M[0]):this.node.offsetWidth-Math.abs(M[0]),M[1]=Math.sign(M[1])==Math.sign(e)||e==0?Math.abs(M[1]):this.node.offsetHeight-Math.abs(M[1]),f.VEC2_LENGTH(_)-f.VEC2_LENGTH(M)});this.focusedSlot&&this.focusedSlot.unfocus(),l[0].focus(),this.focusedSlot=l[0],s&&v.emit(this,"E_SLOT_FOCUSED",{slot:l[0]})}}function Pt(h,t,e,s){let i=new fi;return i.setDuelistIndex(h),i.setLocation(t),i.setIndex(e),i.setHidden(s),i}function Zs(h,t,e){let s=new Po;return s.setDuelistIndex(h),s.setLocation(t),s.setHidden(e),s}function Oi(h){for(var t=0,e=0;h&&!isNaN(h.offsetLeft)&&!isNaN(h.offsetTop);)t+=h.offsetLeft-h.scrollLeft,e+=h.offsetTop-h.scrollTop,h=h.offsetParent;return{top:e,left:t}}class Pu extends yt{constructor(){super(),this.duel=new vu,this.uiBgNode=document.createElement("video"),this.uiTurn=new Su,this.uiDuelists=[],this.uiCardDetail=new bu,this.uiBoard=new Mu,this.uiActionMenu=new Yt,this.menuEnabled=!1}async onEnter(t={duelId}){await this.duel.loadFromFile("templates/tcg/data/duel_"+t.duelId+"/data.json"),this.uiBgNode.src="templates/tcg/bg.mp4",this.uiBgNode.play(),this.uiBgNode.loop=!0,P.addNode(this.uiBgNode,"position:absolute; top:0; right:0; bottom:0; left:0; height:100%"),this.uiTurn.setDuel(this.duel),P.addWidget(this.uiTurn,"position: absolute; top:0; left:0; right:0; line-height:30px; z-index:100"),this.uiDuelists.push(new Cn),this.uiDuelists[0].setDuelist(this.duel.getDuelist(0)),P.addWidget(this.uiDuelists[0],"position:absolute; top:30px; left:0; width:20%"),this.uiDuelists.push(new Cn),this.uiDuelists[1].setDuelist(this.duel.getDuelist(1)),P.addWidget(this.uiDuelists[1],"position:absolute; top:30px; right:0; width:20%"),P.addWidget(this.uiCardDetail,"position: absolute; top:30px; left:20%; width:60%"),this.uiBoard.setDuel(this.duel),P.addWidget(this.uiBoard,"position:absolute; top:50%; left:0; right:0; width:100%; height:50%"),this.uiActionMenu.setVisible(!1),P.addWidget(this.uiActionMenu,"position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); z-index:20;"),v.subscribe(this.duel,"E_NEW_TURN",this,this.handleNewTurn),v.subscribe(this.duel.getDuelist(1),"E_SELECT_LOCATION",this,this.handleSelectLocation),v.subscribe(this.uiBoard,"E_SLOT_UNFOCUSED",this,this.handleBoardSlotUnfocused),v.subscribe(this.uiBoard,"E_SLOT_FOCUSED",this,this.handleBoardSlotFocused),v.subscribe(this.uiBoard,"E_OK_PRESSED",this,this.handleBoardSelectPressed),v.subscribe(this.uiActionMenu,"E_CLOSED",this,this.handleActionMenuClosed),v.subscribe(this.uiActionMenu,"E_ITEM_SELECTED",this,this.handleActionMenuItemSelected),P.focus(this.uiBoard),this.duel.startup()}async onExit(){P.removeNode(this.uiBgNode),P.removeWidget(this.uiTurn),P.removeWidget(this.uiDuelists[0]),P.removeWidget(this.uiDuelists[1]),P.removeWidget(this.uiCardDetail),P.removeWidget(this.uiBoard),P.removeWidget(this.uiActionMenu)}handleNewTurn(){this.uiDuelists[this.duel.getOpponentDuelistIndex()].hideSelection(),this.uiDuelists[this.duel.getCurrentDuelistIndex()].showSelection(),this.duel.getCurrentDuelist()instanceof Mo?this.menuEnabled=!0:this.menuEnabled=!1}handleSelectLocation({range:t,predicateCard:e,required:s,response:i}){return new Promise(r=>{P.focus(this.uiBoard);for(let n of this.uiBoard.getSlots())for(let o=0;o<2;o++){let a=o==0?this.duel.getCurrentDuelistIndex():this.duel.getOpponentDuelistIndex();t[o]!=0&&n.getDuelistIndex()==a&&t[o].includes(n.getLocation())&&e(n.getCard())&&n.setSelectable(!0)}s||v.subscribe(this.uiBoard,"E_ECHAP_PRESSED",this,()=>{v.unsubscribe(this.uiBoard,"E_ECHAP_PRESSED",this),v.unsubscribe(this.uiBoard,"E_SLOT_SELECTED",this);for(let n of this.uiBoard.getSlots())n.setSelectable(!1);i.state=!1,r()}),v.subscribe(this.uiBoard,"E_SLOT_SELECTED",this,n=>{if(n.slot.isSelectable()){v.unsubscribe(this.uiBoard,"E_ECHAP_PRESSED",this),v.unsubscribe(this.uiBoard,"E_SLOT_SELECTED",this);for(let o of this.uiBoard.getSlots())o.setSelectable(!1);i.state=!0,i.location=n.slot.getLocation(),i.index=n.slot.getIndex(),i.card=n.slot.getCard(),r()}})})}handleBoardSlotUnfocused(){this.uiCardDetail.setCard(null)}handleBoardSlotFocused(t){t.slot instanceof fi&&t.slot.getCard()&&!t.slot.isHidden()?this.uiCardDetail.setCard(t.slot.getCard()):this.uiCardDetail.setCard(null)}handleBoardSelectPressed(){if(!this.menuEnabled)return!1;this.uiActionMenu.clear();let t=this.duel.getCurrentDuelist();t.isCapableDraw(this.duel)&&this.uiActionMenu.add("DRAW","Piocher"),t.isCapableSummon(this.duel)&&this.uiActionMenu.add("SUMMON","Invoquer"),t.isCapableSet(this.duel)&&this.uiActionMenu.add("SET","Poser"),t.isCapableBattle(this.duel)&&this.uiActionMenu.add("BATTLE","Attaquer"),t.isCapableActivate(this.duel)&&this.uiActionMenu.add("ACTIVATE","Activer"),t.isCapableChangePosition(this.duel)&&this.uiActionMenu.add("CHANGE_POSITION","Changer de position"),this.uiActionMenu.add("NEXT_PHASE","Phase suivante"),this.uiActionMenu.setVisible(!0),P.focus(this.uiActionMenu)}handleActionMenuClosed(){this.uiActionMenu.setVisible(!1),P.focus(this.uiBoard)}async handleActionMenuItemSelected(t){this.uiActionMenu.setVisible(!1),this.menuEnabled=!1,await Eu(t.id).exec(this.duel),P.focus(this.uiBoard),this.menuEnabled=!0}}let Es=class extends dt{x;y;z;speed;velocity;constructor(){super("Entity"),this.x=0,this.y=0,this.z=0,this.speed=7,this.velocity=[0,0,0]}},Zi=class extends dt{jam;constructor(){super("Graphics"),this.jam=new ke}},Ru=class extends mt{constructor(){super(),super.addRequiredComponentTypename("Graphics"),super.addRequiredComponentTypename("Entity")}onEntityUpdate(t,e){const s=x.getComponent(e,Zi),i=x.getComponent(e,Es);if(i.velocity[0]!=0||i.velocity[2]!=0){let n=f.VEC2_ANGLE([i.velocity[0],i.velocity[2]])-s.jam.getRotationY();n>Math.PI?n-=Math.PI*2:n<-Math.PI&&(n+=Math.PI*2);const o=f.LERP(0,n,t/1e3*20);s.jam.rotate(0,o,0)}s.jam.setPosition(i.x,i.y,i.z),f.VEC3_LENGTH(i.velocity)>0?s.jam.play("RUN",!0,!0):s.jam.play("IDLE",!0,!0),s.jam.update(t)}onEntityDraw(t){x.getComponent(t,Zi).jam.draw()}},Ki=class extends dt{map;lift;radius;height;gravityCoefficient;gravityMax;constructor(t){super("Physics"),this.map=t,this.lift=.8,this.radius=.5,this.height=1,this.gravityCoefficient=.8,this.gravityMax=10}getMinBound(t,e,s){return[t-this.radius,e,s-this.radius]}getMaxBound(t,e,s){return[t+this.radius,e+this.height,s+this.radius]}},Ou=class extends mt{constructor(){super(),super.addRequiredComponentTypename("Physics"),super.addRequiredComponentTypename("Entity")}onEntityUpdate(t,e){const s=x.getComponent(e,Ki),i=x.getComponent(e,Es),r=s.map.box(i.x,i.y+s.height*.5,i.z,s.radius,s.height,i.velocity[0]*(t/1e3),i.velocity[1]*(t/1e3),i.velocity[2]*(t/1e3),s.lift);i.x+=r.move[0],i.y+=r.move[1],i.z+=r.move[2],r.collideFloor?i.velocity[1]=0:i.velocity[1]-=.1*(t/1e3)}onEntityDraw(t){const e=x.getComponent(t,Ki),s=x.getComponent(t,Es),i=e.getMinBound(s.x,s.y,s.z),r=e.getMaxBound(s.x,s.y,s.z);Jt.drawBoundingBox(f.MAT4_IDENTITY(),i,r)}};class yr extends Xe{rotationSpeed;frictionCoefficient;maxPitch;minPitch;target;distance;zoomSpeed;velocityPhi;velocityTheta;phi;theta;lastDragTimestamp;constructor(t){super(t),this.rotationSpeed=2,this.frictionCoefficient=.99,this.maxPitch=Math.PI*.5-.01,this.minPitch=Math.PI*-.5+.01,this.target=[0,0,0],this.distance=10,this.zoomSpeed=.1,this.velocityPhi=0,this.velocityTheta=0,this.phi=Math.PI*.5,this.theta=0,this.lastDragTimestamp=0,v.subscribe(Q,"E_MOUSE_WHEEL",this,this.#i),v.subscribe(Q,"E_MOUSE_UP",this,this.#t),v.subscribe(Q,"E_MOUSE_DOWN",this,this.#e),v.subscribe(Q,"E_MOUSE_DRAG",this,this.#s)}delete(){v.unsubscribe(Q,"E_MOUSE_WHEEL",this),v.unsubscribe(Q,"E_MOUSE_UP",this),v.unsubscribe(Q,"E_MOUSE_DOWN",this),v.unsubscribe(Q,"E_MOUSE_DRAG",this)}update(t){const e=f.VEC3_ROTATE_AROUND(this.target,this.distance,this.phi,this.theta);this.setPosition(e[0],e[1],e[2]),this.lookAt(this.target[0],this.target[1],this.target[2]),Q.isMouseDown()||(this.velocityTheta*=Math.pow(1-this.frictionCoefficient,t/1e3),this.velocityPhi*=Math.pow(1-this.frictionCoefficient,t/1e3),this.theta-=this.velocityTheta,this.phi-=this.velocityPhi)}setRotationSpeed(t){this.rotationSpeed=t}setFrictionCoefficient(t){this.frictionCoefficient=t}setMaxPitch(t){this.maxPitch=t}setMinPitch(t){this.minPitch=t}setTarget(t){this.target=t}setDistance(t){this.distance=t}setZoomSpeed(t){this.zoomSpeed=this.zoomSpeed}getRotationSpeed(){return this.rotationSpeed}getFrictionCoefficient(){return this.frictionCoefficient}getMaxPitch(){return this.maxPitch}getMinPitch(){return this.minPitch}getTarget(){return this.target}getDistance(){return this.distance}getZoomSpeed(){return this.zoomSpeed}getTheta(){return this.theta}getPhi(){return this.phi}#t(){Date.now()-this.lastDragTimestamp>=100&&(this.velocityTheta=0,this.velocityPhi=0)}#e(){this.velocityPhi=0,this.velocityTheta=0}#s(t){this.velocityTheta=t.movementY*this.rotationSpeed/1e3,this.velocityPhi=t.movementX*this.rotationSpeed/1e3,this.theta-=this.velocityTheta,this.phi-=this.velocityPhi,this.theta=f.CLAMP(this.theta,this.minPitch,this.maxPitch),this.lastDragTimestamp=Date.now()}#i(t){this.distance*=1+t.delta*this.zoomSpeed}}class Ar extends dt{map;rec;distanceMax;constructor(t){super("Camera"),this.map=t,this.rec=new yr(0),this.distanceMax=10}}class Du extends mt{constructor(){super(),super.addRequiredComponentTypename("Camera"),super.addRequiredComponentTypename("Entity")}onEntityUpdate(t,e){const s=x.getComponent(e,Ar),i=x.getComponent(e,Es),r=[i.x,i.y+1,i.z],n=f.VEC3_SUBSTRACT(s.rec.getPosition(),r),o=s.map.raycast(r,n,s.distanceMax,s.distanceMax);o&&o.distance<s.distanceMax?s.rec.setDistance(o.distance):s.rec.setDistance(s.distanceMax),s.rec.setTarget(r),s.rec.update(t)}}let Lu=class extends dt{constructor(){super("Input")}},Nu=class extends mt{constructor(){super(),super.addRequiredComponentTypename("Input"),super.addRequiredComponentTypename("Camera"),super.addRequiredComponentTypename("Entity")}onEntityUpdate(t,e){let s=!1,i=0,r=0;const n=x.getComponent(e,Es),a=x.getComponent(e,Ar).rec.getAxies();if(Q.isActiveAction("LEFT")&&(i+=a[0][0]*-1,r+=a[0][2]*-1,s=!0),Q.isActiveAction("RIGHT")&&(i+=a[0][0],r+=a[0][2],s=!0),Q.isActiveAction("UP")&&(i+=a[2][0]*-1,r+=a[2][2]*-1,s=!0),Q.isActiveAction("DOWN")&&(i+=a[2][0],r+=a[2][2],s=!0),s){const l=f.VEC2_ANGLE([i,r]);i=Math.cos(l)*n.speed,r=Math.sin(l)*n.speed}n.velocity[0]=i,n.velocity[2]=r}};async function Fu(h){const t=x.createEntity(),e=new Es;e.x=.1,e.z=.1,x.addComponent(t,e);const s=new Lu;x.addComponent(t,s);const i=new Ki(h);x.addComponent(t,i);const r=new Zi;await r.jam.loadFromFile("./templates/third-person/barret.jam"),r.jam.play("IDLE",!0),r.jam.setMaterial(new vt({texture:await st.loadTexture("./templates/third-person/barret.png")})),x.addComponent(t,r);const n=new Ar(h);return x.addComponent(t,n),t}class Uu extends yt{mapJSM;mapJNM;constructor(){super(),this.mapJSM=new ft,this.mapJNM=new Ds}async onEnter(){x.setup([new Nu,new Ou,new Ru,new Du]);const{jsm:t,jnm:e}=await this.#t();this.mapJSM=t,this.mapJNM=e,await Fu(this.mapJNM)}update(t){this.mapJSM.update(t),this.mapJNM.update(t),x.update(t)}draw(){this.mapJSM.draw(),this.mapJNM.enableDebugMesh(!0),x.draw()}async#t(){const t=new ft;await t.loadFromFile("./templates/third-person/map.jsm"),t.setMaterial(new vt({texture:await st.loadTextureMips("./templates/third-person/map.png",{magFilter:"nearest",minFilter:"nearest",mipmapFilter:"linear"})}));const e=new Ds;return await e.loadFromFile("./templates/third-person/map.jnm"),{jsm:t,jnm:e}}}let Bu=class extends he{constructor(){super(),this.jas=new Zt,this.direction="FORWARD",this.speed=.05,this.width=0,this.height=0,this.collider1=[0,0],this.collider2=[0,0]}async loadFromFile(t){let s=await(await fetch(t)).json();await this.jas.loadFromFile(s.JASFile),this.jas.setTexture(await It.loadTexture(s.TextureFile)),this.jas.setOffset(s.OffsetX,s.OffsetY),this.width=s.Width,this.height=s.Height,this.collider1[0]=s.Collider1X,this.collider1[1]=s.Collider1Y,this.collider2[0]=s.Collider2X,this.collider2[1]=s.Collider2Y}update(t){this.jas.setPosition(this.position[0],this.position[1]),this.jas.update(t)}draw(){this.jas.draw()}play(t,e){this.jas.play(t,e,!0)}setDirection(t){this.direction=t}getDirection(){return this.direction}getSpeed(){return this.speed}getWidth(){return this.width}getHeight(){return this.height}getCollider1X(){return this.collider1[0]}getCollider1Y(){return this.collider1[1]}getCollider2X(){return this.collider2[0]}getCollider2Y(){return this.collider2[1]}};const Di={BACKGROUND:0,MIDDLE:1,FOREGROUND:2};class Vu extends yt{constructor(){super(),this.tileMap=new Se,this.backgroundLayer=new Oe,this.middleLayer=new Oe,this.foregroundLayer=new Oe,this.collisionMap=new Se,this.collisionTileLayer=new ar,this.controller=new Bu}async onEnter(){await this.tileMap.loadFromFile("./templates/tilemap/map.jtm"),this.backgroundLayer.loadFromTileMap(this.tileMap,Di.BACKGROUND),this.middleLayer.loadFromTileMap(this.tileMap,Di.MIDDLE),this.foregroundLayer.loadFromTileMap(this.tileMap,Di.FOREGROUND),await this.collisionMap.loadFromFile("./templates/tilemap/collision.jtm"),this.collisionTileLayer=this.collisionMap.getTileLayer(0),await this.controller.loadFromFile("./templates/tilemap/bernard.json"),this.controller.setPosition(this.collisionMap.getPositionX(12),this.collisionMap.getPositionY(16))}update(t){Q.isActiveAction("LEFT")?this.moveController(-1*this.controller.getSpeed()*t,0,"LEFT"):Q.isActiveAction("RIGHT")?this.moveController(1*this.controller.getSpeed()*t,0,"RIGHT"):Q.isActiveAction("UP")?this.moveController(0,-1*this.controller.getSpeed()*t,"FORWARD"):Q.isActiveAction("DOWN")?this.moveController(0,1*this.controller.getSpeed()*t,"BACKWARD"):this.controller.play("IDLE_"+this.controller.getDirection(),!0);let e=nt.getWidth()*.5,s=this.tileMap.getWidth()-nt.getWidth()*.5,i=nt.getHeight()*.5,r=this.tileMap.getHeight()-nt.getHeight()*.5;nt.setCameraPosition(f.CLAMP(this.controller.getPositionX(),e,s),f.CLAMP(this.controller.getPositionY(),i,r)),this.backgroundLayer.update(t),this.middleLayer.update(t),this.controller.update(t),this.foregroundLayer.update(t)}draw(){this.backgroundLayer.draw(),this.middleLayer.draw(),this.controller.draw(),this.foregroundLayer.draw()}moveController(t,e,s){this.controller.translate(t,e),this.controller.setDirection(s),this.controller.play("RUN_"+s,!0);let i=this.controller.getPosition(),r=this.collisionMap.getLocationCol(i[0]+this.controller.getCollider1X()),n=this.collisionMap.getLocationCol(i[1]+this.controller.getCollider1Y()),o=this.collisionMap.getLocationCol(i[0]+this.controller.getCollider2X()),a=this.collisionMap.getLocationCol(i[1]+this.controller.getCollider2Y());(this.collisionTileLayer.getTile(r,n)==1||this.collisionTileLayer.getTile(o,a)==1)&&this.controller.translate(-t,-e)}}let Hu=class extends he{constructor(){super(),this.sprite=new Zt,this.direction="FORWARD",this.depth=20,this.width=20,this.speed=8}async load(){await this.sprite.loadFromFile("./templates/tilemap-iso/kid.jas"),this.sprite.setTexture(await It.loadTexture("./templates/tilemap-iso/kid.png")),this.sprite.play("IDLE_LEFT",!0)}update(t){this.sprite.update(t)}onRender(){nt.getContext().translate(-8,-30),this.sprite.render()}play(t,e){this.sprite.play(t,e,!0)}getDirection(){return this.direction}setDirection(t){this.direction=t}getDepth(){return this.depth}getWidth(){return this.width}getSpeed(){return this.speed}getCollisionPoints(){const t=f.VEC2_ISO_CARDINAL_POINTS(this.direction,this.depth,this.width),e=f.VEC2_ADD(this.position,f.VEC2_ADD(t.f,t.l)),s=f.VEC2_ADD(this.position,f.VEC2_ADD(t.f,t.r));return[e,s]}};class ju extends yt{constructor(){super(),this.tilemap=new Se,this.collisionLayer=new _s,this.occludersLayer=new _s,this.wallsLayer=new _s,this.floorLayer=new _s,this.collisionTileLayer=new ar,this.controller=new Hu}async onEnter(){await this.tilemap.loadFromFile("./templates/tilemap-iso/tilemap.json"),this.collisionLayer.loadFromTileMap(this.tilemap,3),this.collisionLayer.setShowDebug(!0),this.collisionLayer.setElevation(3),this.occludersLayer.loadFromTileMap(this.tilemap,2),this.wallsLayer.loadFromTileMap(this.tilemap,1),this.floorLayer.loadFromTileMap(this.tilemap,0),this.collisionTileLayer=this.tilemap.getTileLayer(3),await this.controller.load(),this.controller.setElevation(2);const t=this.tilemap.getPositionIso(5,5);this.controller.setPosition(t[0],t[1])}update(t){Q.isActiveAction("LEFT")?this.move(t,this.controller,f.VEC2_ISO_FORWARD,"FORWARD"):Q.isActiveAction("RIGHT")?this.move(t,this.controller,f.VEC2_ISO_BACKWARD,"BACKWARD"):Q.isActiveAction("UP")?this.move(t,this.controller,f.VEC2_ISO_RIGHT,"RIGHT"):Q.isActiveAction("DOWN")?this.move(t,this.controller,f.VEC2_ISO_LEFT,"LEFT"):this.controller.play("IDLE_"+this.controller.getDirection(),!0),this.controller.update(t)}draw(){nt.setMode("ISOMETRIC"),nt.setCameraPosition(this.controller.getPositionX(),this.controller.getPositionY());for(const t of this.occludersLayer.getTiles())t.draw();for(const t of this.wallsLayer.getTiles())t.draw();for(const t of this.floorLayer.getTiles())t.draw();this.controller.draw(),this.collisionLayer.draw()}move(t,e,s,i){const r=f.VEC2_2D_TO_ISO(s),n=r[0]*e.getSpeed()*(t/100),o=r[1]*e.getSpeed()*(t/100);e.translate(n,o),e.setDirection(i),e.play("RUN_"+i,!0);const a=e.getCollisionPoints(),l=this.tilemap.getLocationFromIso(a[0][0],a[0][1]),c=this.tilemap.getLocationFromIso(a[1][0],a[1][1]);(this.collisionTileLayer.getTile(l[0],l[1])==1||this.collisionTileLayer.getTile(c[0],c[1])==1)&&e.translate(-n,-o)}}class ku extends he{constructor(){super(),this.jas=new Zt,this.direction="FORWARD",this.speed=50,this.width=0,this.height=0,this.motion=new Pe}async loadFromFile(t){let s=await(await fetch(t)).json();await this.jas.loadFromFile(s.JASFile),this.jas.setTexture(await It.loadTexture(s.TextureFile)),this.jas.setOffset(s.OffsetX,s.OffsetY),this.width=s.Width,this.height=s.Height}update(t){const e=this.motion.getPrevPoint(),s=this.motion.getNextPoint();this.motion.isRunning()&&(this.position[0]=this.motion.getCurrentPositionX(),this.position[1]=this.motion.getCurrentPositionZ()),e[0]>s[0]?this.direction="LEFT":e[0]<s[0]?this.direction="RIGHT":e[2]>s[2]?this.direction="FORWARD":e[2]<s[2]&&(this.direction="BACKWARD"),this.jas.setPosition(this.position[0],this.position[1]),this.jas.play(this.motion.isRunning()?"RUN_"+this.direction:"IDLE_"+this.direction,!0,!0),this.jas.update(t),this.motion.update(t)}draw(){this.jas.draw()}moveAlong(t){this.motion=new Pe,this.motion.setPoints(t),this.motion.setSpeed(this.speed),this.motion.run()}}const Li={BACKGROUND:0,MIDDLE:1,FOREGROUND:2};class Wu extends yt{constructor(){super(),this.tileMap=new Se,this.collisionMap=new Se,this.backgroundLayer=new Oe,this.middleLayer=new Oe,this.foregroundLayer=new Oe,this.controller=new ku,this.selectionRect=new Gu,this.pathfinder=new Zn}async onEnter(){await this.tileMap.loadFromFile("./templates/tilemap/map.jtm"),this.backgroundLayer.loadFromTileMap(this.tileMap,Li.BACKGROUND),this.middleLayer.loadFromTileMap(this.tileMap,Li.MIDDLE),this.foregroundLayer.loadFromTileMap(this.tileMap,Li.FOREGROUND),await this.collisionMap.loadFromFile("./templates/tilemap/collision.jtm"),await this.controller.loadFromFile("./templates/tilemap/bernard.json"),this.controller.setPosition(this.tileMap.getPositionX(6),this.tileMap.getPositionY(16)),this.movePlayer(10,16),document.addEventListener("mousemove",t=>this.handleMouseMove(t)),document.addEventListener("click",()=>this.handleMouseClick())}update(t){const e=nt.getWidth()*.5,s=this.tileMap.getWidth()-nt.getWidth()*.5,i=nt.getHeight()*.5,r=this.tileMap.getHeight()-nt.getHeight()*.5;nt.setCameraPosition(f.CLAMP(this.controller.getPositionX(),e,s),f.CLAMP(this.controller.getPositionY(),i,r)),this.backgroundLayer.update(t),this.middleLayer.update(t),this.controller.update(t),this.foregroundLayer.update(t),this.selectionRect.update(t)}draw(){this.backgroundLayer.draw(),this.middleLayer.draw(),this.controller.draw(),this.foregroundLayer.draw(),this.selectionRect.draw()}movePlayer(t,e){const s=this.collisionMap.getLocationCol(this.controller.getPositionX()),i=this.collisionMap.getLocationRow(this.controller.getPositionY()),r=this.collisionMap.getTileLayer(0),n=new nr([r.getColumns(),r.getRows()],r.getGrid()),o=this.pathfinder.solve(n,[s,i],[t,e]);o&&this.controller.moveAlong(o.map(([a,l])=>[this.collisionMap.getPositionX(a+.5),0,this.collisionMap.getPositionY(l+.5)]))}handleMouseMove(t){const e=nt.findWorldPosFromClientPos(t.clientX,t.clientY),s=this.collisionMap.getPositionX(this.collisionMap.getLocationCol(e[0])),i=this.collisionMap.getPositionY(this.collisionMap.getLocationRow(e[1]));this.selectionRect.setPosition(s,i)}handleMouseClick(){const t=this.collisionMap.getLocationCol(this.selectionRect.getPositionX()),e=this.collisionMap.getLocationRow(this.selectionRect.getPositionY());this.collisionMap.getTileLayer(0).getTile(t,e)!=1&&this.movePlayer(t,e)}}class Gu extends he{constructor(){super()}onRender(){const t=nt.getContext();t.fillStyle="rgba(225,225,225,0.5)",t.fillRect(0,0,16,16)}}var te=(h=>(h[h.W=0]="W",h[h.N=1]="N",h[h.E=2]="E",h[h.S=3]="S",h))(te||{}),Ro=(h=>(h.NONE="NONE",h.FIRE="FIRE",h.ICE="ICE",h.EARTH="EARTH",h.THUNDER="THUNDER",h.YIN="YIN",h.YANG="YANG",h))(Ro||{}),Ii=(h=>(h.PRE_BATTLE="PRE_BATTLE",h.IN_BATTLE="IN_BATTLE",h.POST_BATTLE="POST_BATTLE",h))(Ii||{}),Si=(h=>(h.PLUS="PLUS",h.IDENTIQUE="IDENTIQUE",h.NORMAL="NORMAL",h))(Si||{});class zu{points;elementalType;name;owner;modifier;constructor(){this.points=[0,0,0,0],this.elementalType=Ro.NONE,this.name="",this.owner=1,this.modifier=[0,0,0,0]}getValue(t){return this.points[t]+this.modifier[t]}getName(){return this.name}getOpposedValue(t){return this.points[(t+2)%4]+this.modifier[(t+2)%4]}getOwner(){return this.owner}getPoints(){return this.points}setName(t){this.name=t}setOwner(t){this.owner=t}setPoint(t,e){this.points[t]=e,v.emit(this,"E_POINT_CHANGED",{dir:t,value:e})}setPoints(t,e,s,i){this.points[te.W]=t,this.points[te.N]=e,this.points[te.E]=s,this.points[te.S]=i,v.emit(this,"E_POINTS_CHANGED",{values:[t,e,s,i]})}setPointsArray(t){for(let e=0;e<4;e++)this.points[e]=t[e];v.emit(this,"E_POINTS_CHANGED",{values:t})}flipPlayerOwner(){this.owner=this.owner==1?2:1,v.emit(this,"E_OWNER_CHANGED",{owner:this.owner})}modifyPoints(t){for(let e=0;e<4;e++)this.modifier[e]+=t[e];v.emit(this,"E_MODIFIER_VALUES_CHANGED",{values:t})}modifyPoint(t,e){this.modifier[e]+=t,v.emit(this,"E_MODIFIER_VALUE_CHANGED",{dir:e,value:t})}restoreToDefault(){for(let t=0;t<4;t++)this.modifier[t]=0}}class wr{priority;type;constructor(t,e){this.priority=t,this.type=e}apply(t,e){return 0}}class qu extends wr{constructor(){super(Si.NORMAL,Ii.IN_BATTLE)}apply(t,e){let s=0;const i=t.getCardFromBoard(e);if(i==null)throw new Error("NormalEffect::apply(): target pos empty !");for(let r=0;r<Object.keys(te).length;r++){const n=t.getCoordinateNeighbourCardFromBoard(e,r);if(n==null)continue;const o=t.getCardFromBoard(n);o!=null&&o.getOwner()!=i.getOwner()&&i.getValue(r)>o.getOpposedValue(r)&&(o.flipPlayerOwner(),o.getOwner()==1?s+=1:s-=1)}return s}}class Xu extends wr{constructor(){super(Si.IDENTIQUE,Ii.IN_BATTLE)}apply(t,e){let s=0;const i=new Array,r=t.getCardFromBoard(e);if(r==null)throw new Error("NormalEffect::apply(): target pos empty !");for(let n=0;n<Object.keys(te).length;n++){const o=t.getCoordinateNeighbourCardFromBoard(e,n);if(o==null)continue;const a=t.getCardFromBoard(o);a!=null&&r.getValue(n)==a.getOpposedValue(n)&&i.push(o)}for(let n=0;n<i.length;n++){const o=t.getCardFromBoard(i[n]);o!=null&&o.getOwner()!=r.getOwner()&&(o.flipPlayerOwner(),o.getOwner()==1?s+=1:s-=1)}return s}}class Yu extends wr{constructor(){super(Si.IDENTIQUE,Ii.IN_BATTLE)}apply(t,e){let s=0;const i=new Array,r=new Array,n=t.getCardFromBoard(e);if(n==null)throw new Error("NormalEffect::apply(): target pos empty !");for(let a=0;a<Object.keys(te).length;a++){const l=t.getCoordinateNeighbourCardFromBoard(e,a);if(l==null)continue;const c=t.getCardFromBoard(l);c!=null&&(i.push(n.getValue(a)+c.getOpposedValue(a)),r.push(l))}let o=!1;t:for(let a=0;a<i.length-1;a++)for(let l=a+1;l<i.length;l++)if(i[a]==i[l]){o=!0;break t}if(o)for(let a=0;a<r.length;a++){const l=t.getCardFromBoard(r[a]);l!=null&&l.getOwner()!=n.getOwner()&&(l.flipPlayerOwner(),l.getOwner()==1?s+=1:s-=1)}return s}}const Zu=[["Alice","Patchouli","Cirno","Reimu","Sakuya","Remilia","Meiling","Reisen"],["Mokou","Iku","Kisume","Kogasa","Komachi","Marisa","Konngara","Momiji"]],Ku=8,Ct=4;class $u{currentPlayerNum;hands;board;hWalls;vWalls;score;standardEffects;constructor(){this.currentPlayerNum=0,this.hands=[new Array,new Array],this.board=Ju(),this.hWalls=Qu(),this.vWalls=td(),this.score=8,this.standardEffects=[new Yu,new Xu,new qu]}startup(){for(let t=0;t<2;t++)for(let e=0;e<Ku;e++){const s=new zu;s.setPoints(Math.floor(Math.random()*10+1),Math.floor(Math.random()*10+1),Math.floor(Math.random()*10+1),Math.floor(Math.random()*10+1)),s.setName(Zu[t][e]),s.setOwner(t),this.addHandCard(t,s)}}restart(){this.score=8,this.clearBoard()}getCurrentPlayerNum(){return this.currentPlayerNum}getBoard(){return this.board}getHWalls(){return this.hWalls}getVWalls(){return this.vWalls}getCardFromBoard(t){return this.board[t[0]][t[1]]}getHand(t){return this.hands[t]}getScore(){return this.score}setHandCard(t,e,s){this.hands[t][s]=e}clearBoard(){for(let t=0;t<Ct;t++)for(let e=0;e<Ct;e++)this.board[t][e]=null}placeHandCardOnBoard(t,e,s){const i=this.hands[t][e];if(!i)throw new Error("GameState::placeHandCardOnBoard(): Card not exist !");this.board[s[0]][s[1]]=i,this.removeHandCard(t,e),v.emit(this,"E_BOARD_CARD_PLACED",{card:i,playerNum:t,pos:s})}addHandCard(t,e){this.hands[t].push(e),v.emit(this,"E_HAND_CARD_ADDED",{playerNum:t,card:e})}removeHandCard(t,e){this.hands[t].splice(e,1),v.emit(this,"E_HAND_CARD_REMOVED",{playerNum:t,cardNum:e})}getNeighbourCardFromBoard(t,e){let s=this.getCoordinateNeighbourCardFromBoard(t,e);return s==null?null:this.board[s[0]][s[1]]}getCoordinateNeighbourCardFromBoard(t,e){const s=t[0],i=t[1],r=[s,i];switch(e){case te.W:if(this.vWalls[s][i])return null;r[1]=i==0?Ct-1:i-1;break;case te.N:if(this.hWalls[s][i])return null;r[0]=s==0?Ct-1:s-1;break;case te.E:if(this.vWalls[s][i])return null;r[1]=i==Ct-1?0:i+1;break;case te.S:if(this.hWalls[s][i])return null;r[0]=s==Ct-1?0:s+1;break}return r}performBattle(t){for(let e of this.standardEffects)this.score+=e.apply(this,t);v.emit(this,"E_BATTLE_PERFORMED",{score:this.score})}changePlayer(){this.currentPlayerNum=(this.currentPlayerNum+1)%2}}function Ju(){const h=new Array(Ct);for(let t=0;t<Ct;t++){h[t]=new Array(Ct);for(let e=0;e<Ct;e++)h[t][e]=null}return h}function Qu(){const h=new Array(Ct);for(let t=0;t<Ct+1;t++){h[t]=new Array(Ct);for(let e=0;e<Ct;e++)h[t][e]=!1}return h[0][0]=!0,h[0][Ct-1]=!0,h}function td(){const h=new Array(Ct);for(let t=0;t<Ct;t++){h[t]=new Array(Ct);for(let e=0;e<Ct;e++)h[t][e]=!1}return h[0][0]=!0,h[Ct-1][0]=!0,h}const Re={PATH_CARD:"templates/triple-triad/",PATH_CARD_AVATAR:"templates/triple-triad/card_img/"};class Oo extends xt{card;constructor(){super({className:"UICard",template:`
      <img class="UICard-picture js-background"/>
      <img class="UICard-picture js-picture"/>
      <img class="UICard-picture js-border"/>
      <div class="UICard-points js-points">
        <div class="UICard-points-t js-top"></div>
        <div class="UICard-points-r js-right"></div>
        <div class="UICard-points-l js-left"></div>
        <div class="UICard-points-b js-bottom"></div>
      </div>`}),this.card=null,this.node.querySelector(".js-border").src=Re.PATH_CARD+"card.png"}setCard(t){v.unsubscribe(t,"E_POINTS_CHANGED",this),v.unsubscribe(t,"E_POINT_CHANGED",this),v.unsubscribe(t,"E_MODIFIER_VALUES_CHANGED",this),v.unsubscribe(t,"E_MODIFIER_VALUE_CHANGED",this),v.unsubscribe(t,"E_OWNER_CHANGED",this),t?(v.subscribe(t,"E_POINTS_CHANGED",this,this.handlePointsChanged),v.subscribe(t,"E_POINT_CHANGED",this,this.handlePointChanged),v.subscribe(t,"E_MODIFIER_VALUES_CHANGED",this,this.handleModifierValuesChanged),v.subscribe(t,"E_MODIFIER_VALUE_CHANGED",this,this.handleModifierValueChanged),v.subscribe(t,"E_OWNER_CHANGED",this,this.handleOwnerChanged),this.setPicture(t.getName()),this.setPlayerOwner(t.getOwner()),this.setPoints(t.getValue(0),t.getValue(1),t.getValue(2),t.getValue(3)),this.card=t):this.card=null}setVisiblePoints(t){this.node.querySelector(".js-points").style.display=t?"block":"none"}setPicture(t){this.node.querySelector(".js-picture").src=Re.PATH_CARD_AVATAR+t+".png"}setPlayerOwner(t){t==1?this.node.querySelector(".js-background").src=Re.PATH_CARD+"blue.png":this.node.querySelector(".js-background").src=Re.PATH_CARD+"red.png"}setPoints(t,e,s,i){this.node.querySelector(".js-top").textContent=e.toString(16).toUpperCase(),this.node.querySelector(".js-right").textContent=s.toString(16).toUpperCase(),this.node.querySelector(".js-bottom").textContent=i.toString(16).toUpperCase(),this.node.querySelector(".js-left").textContent=t.toString(16).toUpperCase()}setPoint(t,e){let s=e.toString(16).toUpperCase();switch(t){case te.N:this.node.querySelector(".js-top").textContent=s;break;case te.E:this.node.querySelector(".js-right").textContent=s;break;case te.S:this.node.querySelector(".js-bottom").textContent=s;break;case te.W:this.node.querySelector(".js-left").textContent=s;break}}handlePointsChanged(){this.card&&this.setPoints(this.card.getValue(0),this.card.getValue(1),this.card.getValue(2),this.card.getValue(3))}handlePointChanged(t){this.card&&this.setPoint(t.dir,this.card.getValue(t.dir))}handleModifierValuesChanged(t){this.card&&this.setPoints(this.card.getValue(0),this.card.getValue(1),this.card.getValue(2),this.card.getValue(3))}handleModifierValueChanged(t){this.card&&this.setPoint(t.dir,this.card.getValue(t.dir))}handleOwnerChanged(t){this.card&&this.setPlayerOwner(this.card.getOwner())}}class ed extends xt{gameState;uiCards;focusedCardNums;focusedPlayerNum;constructor(t){super({className:"UIHands",template:`
      <div class="UIHands-left js-hand-left"></div>
      <div class="UIHands-right js-hand-right"></div>`}),this.gameState=t,this.uiCards=[[],[]],this.focusedCardNums=[0,0],this.focusedPlayerNum=0,v.subscribe(t,"E_HAND_CARD_ADDED",this,this.handleHandCardAdded),v.subscribe(t,"E_HAND_CARD_REMOVED",this,this.handleHandCardRemoved)}delete(){for(let t=0;t<2;t++)for(let e=0;e<this.uiCards[t].length;e++)this.uiCards[t][e].delete();super.delete()}getFocusedCardNum(t){return this.focusedCardNums[t]}focusPlayer(t){const e=this.uiCards[t][this.focusedCardNums[t]];if(!e)throw new Error("UIHands::focusPlayer(): card not found !");for(let s=0;s<2;s++)for(const i of this.uiCards[s])i.unfocus();e.focus(),this.focusedPlayerNum=t}focusCard(t){const e=this.uiCards[this.focusedPlayerNum][t];if(!e)throw new Error("UIHands::focusCard(): card not found !");const s=this.uiCards[this.focusedPlayerNum][this.focusedCardNums[this.focusedPlayerNum]];s&&s.unfocus(),e.focus(),this.focusedCardNums[this.focusedPlayerNum]=t}selectCard(){if(!this.uiCards[this.focusedPlayerNum][this.focusedCardNums[this.focusedPlayerNum]])throw new Error("UIHands::selectCard(): card not found !");v.emit(this,"E_CARD_SELECTED",{playerNum:this.focusedPlayerNum,cardNum:this.focusedCardNums[this.focusedPlayerNum]})}onAction(t){const e=this.focusedCardNums[this.focusedPlayerNum],s=this.uiCards[this.focusedPlayerNum].length;t=="UP"||t=="LEFT"?this.focusCard(e==0?s-1:e-1):t=="DOWN"||t=="RIGHT"?this.focusCard(e==s-1?0:e+1):t=="OK"&&this.selectCard()}handleHandCardAdded(t){const e=new Oo;e.setCard(t.card),t.playerNum==0?(this.uiCards[0].push(e),this.node.querySelector(".js-hand-left").appendChild(e.getNode())):(this.uiCards[1].push(e),this.node.querySelector(".js-hand-right").appendChild(e.getNode()))}handleHandCardRemoved(t){this.uiCards[t.playerNum][t.cardNum].delete(),this.uiCards[t.playerNum].splice(t.cardNum,1)}}let sd=class extends xt{constructor(){super({className:"UIBackgroundTTT",template:`
      <img class="UIBackgroundTTT-picture js-background"/>`}),this.node.querySelector(".js-background").src=Re.PATH_CARD+"background.png"}};var Ms=(h=>(h.VL="VL",h.VR="VR",h.HT="HT",h.HB="HB",h))(Ms||{});class Ks extends xt{constructor(t){super({className:"UIWall",template:`
      <img class="UIWall-picture js-wall"/>`}),t=="VL"?this.node.querySelector(".js-wall").src=Re.PATH_CARD+"wall_vertical_left.png":t=="VR"?this.node.querySelector(".js-wall").src=Re.PATH_CARD+"wall_vertical_right.png":t=="HT"?this.node.querySelector(".js-wall").src=Re.PATH_CARD+"wall_horizontal_top.png":t=="HB"&&(this.node.querySelector(".js-wall").src=Re.PATH_CARD+"wall_horizontal_bottom.png")}}class rd extends xt{gameState;uiCards;uiVWalls;uiHWalls;focusedCellPos;constructor(t){super({className:"UIDamier",template:`
      <div class="UIDamier-cell js-0-0"></div>
      <div class="UIDamier-cell js-0-1"></div>
      <div class="UIDamier-cell js-0-2"></div>
      <div class="UIDamier-cell js-0-3"></div>
      <div class="UIDamier-cell js-1-0"></div>
      <div class="UIDamier-cell js-1-1"></div>
      <div class="UIDamier-cell js-1-2"></div>
      <div class="UIDamier-cell js-1-3"></div>
      <div class="UIDamier-cell js-2-0"></div>
      <div class="UIDamier-cell js-2-1"></div>
      <div class="UIDamier-cell js-2-2"></div>
      <div class="UIDamier-cell js-2-3"></div>
      <div class="UIDamier-cell js-3-0"></div>
      <div class="UIDamier-cell js-3-1"></div>
      <div class="UIDamier-cell js-3-2"></div>
      <div class="UIDamier-cell js-3-3"></div>`}),this.gameState=t,this.uiCards=this.#s(),this.uiVWalls=this.#t(this.gameState.getVWalls()),this.uiHWalls=this.#e(this.gameState.getHWalls()),this.focusedCellPos=[0,0],v.subscribe(t,"E_BOARD_CARD_PLACED",this,this.handleBoardCardPlaced)}delete(){for(let t=0;t<Ct;t++)for(let e=0;e<Ct;e++)this.uiCards[t][e]?.delete();super.delete()}focusFirstEmptyCell(){for(let t=0;t<Ct;t++)for(let e=0;e<Ct;e++)if(this.uiCards[t][e]==null){this.focusCell([t,e]);return}}focusCell(t){const e=this.node.querySelector(`.js-${t[0]}-${t[1]}`);if(!e)throw new Error("UIDamier::focusCell(): Cell not found !");this.node.querySelector(`.js-${this.focusedCellPos[0]}-${this.focusedCellPos[1]}`).classList.remove("u-focused"),e.classList.add("u-focused"),this.focusedCellPos[0]=t[0],this.focusedCellPos[1]=t[1]}onAction(t){if(t=="UP"){let e=this.focusedCellPos[0]==0?Ct-1:this.focusedCellPos[0]-1;this.focusCell([e,this.focusedCellPos[1]])}else if(t=="RIGHT"){let e=this.focusedCellPos[1]==Ct-1?0:this.focusedCellPos[1]+1;this.focusCell([this.focusedCellPos[0],e])}else if(t=="DOWN"){let e=this.focusedCellPos[0]==Ct-1?0:this.focusedCellPos[0]+1;this.focusCell([e,this.focusedCellPos[1]])}else if(t=="LEFT"){let e=this.focusedCellPos[1]==0?Ct-1:this.focusedCellPos[1]-1;this.focusCell([this.focusedCellPos[0],e])}else t=="OK"?this.uiCards[this.focusedCellPos[0]][this.focusedCellPos[1]]||v.emit(this,"E_CELL_SELECTED",{pos:this.focusedCellPos}):t=="BACK"&&v.emit(this,"E_CANCEL")}handleBoardCardPlaced(t){const e=new Oo;e.setCard(t.card),this.uiCards[t.pos[0]][t.pos[1]]=e,this.node.querySelector(`.js-${t.pos[0]}-${t.pos[1]}`).appendChild(e.getNode())}#t(t){const e=new Array;for(let s=0;s<Ct;s++){e[s]=[];for(let i=0;i<Ct;i++){if(!t[s][i])continue;const r=new Ks(Ms.VL);if(this.node.querySelector(`.js-${s}-${i}`).appendChild(r.getNode()),e[s][i]=r,i==0){const o=new Ks(Ms.VR);this.node.querySelector(`.js-${s}-${Ct-1}`).appendChild(o.getNode()),e[s][i]=o}}}return e}#e(t){const e=new Array;for(let s=0;s<Ct;s++){e[s]=[];for(let i=0;i<Ct;i++){if(!t[s][i])continue;const r=new Ks(Ms.HT);if(this.node.querySelector(`.js-${s}-${i}`).appendChild(r.getNode()),e[s][i]=r,s==0){const o=new Ks(Ms.HB);this.node.querySelector(`.js-${Ct-1}-${i}`).appendChild(o.getNode()),e[s][i]=o}}}return e}#s(){const t=new Array;for(let e=0;e<Ct;e++){t[e]=[];for(let s=0;s<Ct;s++)t[e][s]=null}return t}}class nd extends xt{gameState;constructor(t){super({className:"UIScore",template:`
      <div class="UIScore-points-p1 js-p1">8</div>
      <div class="UIScore-points-p2 js-p2">8</div>`}),this.gameState=t,v.subscribe(this.gameState,"E_BATTLE_PERFORMED",this,this.handleBattlePerformed)}handleBattlePerformed(t){this.node.querySelector(".js-p1").textContent=t.score.toString(),this.node.querySelector(".js-p2").textContent=(16-t.score).toString()}}class od extends yt{gameState;uiBackground;uiScore;uiHands;uiDamier;constructor(){super(),this.gameState=new $u,this.uiBackground=new sd,this.uiScore=new nd(this.gameState),this.uiHands=new ed(this.gameState),this.uiDamier=new rd(this.gameState)}async onEnter(){Cs.setSize(600,600,Mn.FIXED),P.addWidget(this.uiBackground),P.addWidget(this.uiScore),P.addWidget(this.uiHands),P.addWidget(this.uiDamier),this.gameState.startup(),P.focus(this.uiHands),this.uiHands.focusPlayer(this.gameState.getCurrentPlayerNum()),v.subscribe(this.uiHands,"E_CARD_SELECTED",this,this.handleHandsCardSelected),v.subscribe(this.uiDamier,"E_CELL_SELECTED",this,this.handleDamierCellSelected),v.subscribe(this.uiDamier,"E_CANCEL",this,this.handleDamierCancel)}onExit(){P.removeWidget(this.uiBackground),P.removeWidget(this.uiHands),P.removeWidget(this.uiScore),P.removeWidget(this.uiDamier)}handleHandsCardSelected(){this.uiDamier.focusFirstEmptyCell(),P.focus(this.uiDamier)}handleDamierCellSelected(t){const e=this.uiHands.getFocusedCardNum(this.gameState.getCurrentPlayerNum());this.gameState.placeHandCardOnBoard(this.gameState.getCurrentPlayerNum(),e,t.pos),this.gameState.performBattle(t.pos),this.gameState.changePlayer(),P.focus(this.uiHands),this.uiHands.focusCard(0),this.uiHands.focusPlayer(this.gameState.getCurrentPlayerNum())}handleDamierCancel(){this.uiHands.focusPlayer(this.gameState.getCurrentPlayerNum()),P.focus(this.uiHands)}}class ad{constructor(){this.variants={}}async loadFromFile(t){const s=await(await fetch(t)).json();this.variants=s.Variants}getVariant(){return this.variants}}class Do extends xt{animations;currentAnimation;currentAnimationFrameIndex;isLooped;timeElapsed;constructor(t={}){super({className:t.className??"UISprite"}),this.animations=[],this.currentAnimation=null,this.currentAnimationFrameIndex=0,this.isLooped=!1,this.timeElapsed=0}async loadTexture(t){return new Promise(e=>{const s=new Image;s.src=t,s.onload=()=>{this.node.style.backgroundImage='url("'+s.src+'")',e()}})}async loadFromFile(t){const s=await(await fetch(t)).json();this.loadFromData(s)}async loadFromAsepriteFile(t){const e=await or(t);this.loadFromData(e)}loadFromData(t){this.animations=[];for(const e of t.Animations){const s={name:e.Name,frames:[],frameDuration:Number(e.FrameDuration)};for(const i of e.Frames)s.frames.push({x:i.X,y:i.Y,width:i.Width,height:i.Height});this.animations.push(s)}this.currentAnimation=null,this.currentAnimationFrameIndex=0,this.timeElapsed=0}update(t){if(!this.currentAnimation)return;const e=this.currentAnimation.frames[this.currentAnimationFrameIndex];this.node.style.backgroundPositionX=-e.x+"px",this.node.style.backgroundPositionY=-e.y+"px",this.node.style.width=e.width+"px",this.node.style.height=e.height+"px",this.timeElapsed>=this.currentAnimation.frameDuration?this.currentAnimationFrameIndex==this.currentAnimation.frames.length-1?(v.emit(this,"E_FINISHED"),this.currentAnimationFrameIndex=this.isLooped?0:this.currentAnimation.frames.length-1,this.timeElapsed=0):(this.currentAnimationFrameIndex=this.currentAnimationFrameIndex+1,this.timeElapsed=0):this.timeElapsed+=t}play(t,e=!1,s=!1){if(s&&this.currentAnimation&&t==this.currentAnimation.name)return;const i=this.animations.find(r=>r.name==t);if(!i)throw new Error("UISprite::play: animation not found.");this.currentAnimation=i,this.currentAnimationFrameIndex=0,this.isLooped=e,this.timeElapsed=0}getAnimations(){return this.animations}setAnimations(t){this.animations=t}getCurrentAnimation(){return this.currentAnimation}getCurrentAnimationFrameIndex(){return this.currentAnimationFrameIndex}}const $s={LEFT:"LEFT",RIGHT:"RIGHT",CENTER:"CENTER",MIDDLE:"MIDDLE"};class Ni extends Do{constructor(){super({className:"UIAvatar"})}changeLocation(t){t==$s.MIDDLE?this.node.classList.add("u-middle"):t==$s.LEFT?this.node.classList.add("u-left"):t==$s.CENTER?this.node.classList.add("u-center"):t==$s.RIGHT&&this.node.classList.add("u-right")}}class Fi extends Do{constructor(){super({className:"UIBackground"})}}class hd extends yt{constructor(){super(),this.player=new ad,this.scriptMachine=new Ls}async onEnter(){this.scriptMachine.registerCommand("LOAD_SCRIPT",this.#t.bind(this)),this.scriptMachine.registerCommand("UI_CREATE_DIALOG",this.#e.bind(this)),this.scriptMachine.registerCommand("UI_CREATE_CHOICES",this.#s.bind(this)),this.scriptMachine.registerCommand("UI_CREATE_AVATAR",this.#i.bind(this)),this.scriptMachine.registerCommand("UI_CREATE_BACKGROUND",this.#r.bind(this)),this.scriptMachine.registerCommand("UI_PLAY_AVATAR",this.#a.bind(this)),this.scriptMachine.registerCommand("UI_PLAY_BACKGROUND",this.#h.bind(this)),this.scriptMachine.registerCommand("UI_DESTROY_AVATAR",this.#n.bind(this)),this.scriptMachine.registerCommand("UI_DESTROY_BACKGROUND",this.#o.bind(this)),this.scriptMachine.registerCommand("UI_FADE_IN",this.#l.bind(this)),this.scriptMachine.registerCommand("UI_FADE_OUT",this.#c.bind(this)),await this.player.loadFromFile("./templates/visual-novel/player.json"),await this.#t("./templates/visual-novel/scene00.jsc")}update(t){this.scriptMachine.update(t)}async#t(t){await this.scriptMachine.loadFromFile(t),this.scriptMachine.loadVariantFromData(this.player.getVariant()),this.scriptMachine.jump("ON_INIT"),this.scriptMachine.setEnabled(!0)}async#e(t,e){this.scriptMachine.setEnabled(!1);let s=new li;s.setAuthor(t),s.setText(e),P.addWidget(s),P.focus(s),await v.wait(s,"E_OK"),P.removeWidget(s),this.scriptMachine.setEnabled(!0)}async#s(t,e,s=[]){this.scriptMachine.setEnabled(!1);let i=new li;i.setAuthor(t),i.setText(e),P.addWidget(i),await v.wait(i,"E_PRINT_FINISHED");let r=new Yt;P.addWidget(r,"position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); z-index:12");for(let o of s)r.add(0,o.Text);P.focus(r);let n=await v.wait(r,"E_ITEM_SELECTED");P.removeWidget(i),P.removeWidget(r),this.scriptMachine.jump(s[n.index].Jumpto),this.scriptMachine.setEnabled(!0)}async#i(t,e,s,i,r,n){this.scriptMachine.setEnabled(!1);let o=new Ni;o.changeLocation(r),await o.loadTexture(t),await o.loadFromFile(e),o.animate(n),o.play(s,i),P.addWidget(o),await v.wait(o,"E_ANIMATION_FINISHED"),this.scriptMachine.setEnabled(!0)}async#r(t,e,s,i,r){this.scriptMachine.setEnabled(!1);let n=new Fi;await n.loadTexture(t),await n.loadFromFile(e),n.animate(r),n.play(s,i),P.addWidget(n),await v.wait(n,"E_ANIMATION_FINISHED"),this.scriptMachine.setEnabled(!0)}async#n(t,e){this.scriptMachine.setEnabled(!1);let i=P.getWidgets().filter(r=>r instanceof Ni).at(t);i.animate(e),await v.wait(i,"E_ANIMATION_FINISHED"),P.removeWidget(i),this.scriptMachine.setEnabled(!0)}async#o(t,e){this.scriptMachine.setEnabled(!1);let i=P.getWidgets().filter(r=>r instanceof Fi).at(t);i.animate(e),await v.wait(i,"E_ANIMATION_FINISHED"),P.removeWidget(i),this.scriptMachine.setEnabled(!0)}#a(t,e,s){P.getWidgets().filter(n=>n instanceof Ni)[t].play(e,s)}#h(t,e,s){P.getWidgets().filter(n=>n instanceof Fi)[t].play(e,s)}async#l(t,e,s){this.scriptMachine.setEnabled(!1),P.fadeIn(t,e,s,()=>this.scriptMachine.setEnabled(!0))}async#c(t,e,s){this.scriptMachine.setEnabled(!1),P.fadeOut(t,e,s,()=>this.scriptMachine.setEnabled(!0))}}/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var $i=function(h,t){return $i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,s){e.__proto__=s}||function(e,s){for(var i in s)s.hasOwnProperty(i)&&(e[i]=s[i])},$i(h,t)};function Lo(h,t){function e(){this.constructor=h}$i(h,t),h.prototype=t===null?Object.create(t):(e.prototype=t.prototype,new e)}var mi=function(){return mi=Object.assign||function(h){for(var t,e=1,s=arguments.length;e<s;e++)for(var i in t=arguments[e])Object.prototype.hasOwnProperty.call(t,i)&&(h[i]=t[i]);return h},mi.apply(this,arguments)};function yn(h,t){for(var e=new Array(h.length),s=0;s<h.length;s++)e[s]=2*h[s]-t[s];return e}function Ji(h,t,e){var s,i,r,n,o=t.length-1;if(e)s=t[h-1<0?o:h-1],i=t[h%t.length],r=t[(h+1)%t.length],n=t[(h+2)%t.length];else{if(h===o)throw Error("There is no spline segment at this index for a closed curve!");i=t[h],r=t[h+1],s=h>0?t[h-1]:yn(i,r),n=h<o-1?t[h+2]:yn(r,i)}return[s,i,r,n]}function ld(h,t,e){e===void 0&&(e=!1);var s=e?t.length:t.length-1;if(h===1)return{index:s-1,weight:1};var i=s*h,r=Math.floor(i);return{index:r,weight:i-r}}function cd(h,t){for(var e=0;e<h.length;e++)h[e]=t;return h}function ud(h,t){for(var e=0;e<h.length;e++)h[e]=t(h[e],e);return h}function dd(h,t,e){e===void 0&&(e=0);for(var s=0;s<h.length;s++)e=t(e,h[s],s);return e}function ei(h,t){t=t||new Array(h.length);for(var e=0;e<h.length;e++)t[e]=h[e];return t}function se(h,t,e){return t===void 0&&(t=0),e===void 0&&(e=1),h<t?t:h>e?e:h}function Qi(h,t){var e=t[0];if(h>=t[t.length-1])return t.length-1;if(h<=e)return 0;for(var s=0,i=t.length-1;s<=i;){var r=Math.floor((s+i)/2),n=t[r];if(n<h)s=r+1;else{if(!(n>h))return r;i=r-1}}return Math.max(0,i)}var de=Math.pow(2,-42);function An(h){var t=Math.pow(Math.abs(h),.3333333333333333);return h<0?-t:t}function No(h,t,e){if(Math.abs(h)<de)return Math.abs(t)<de?[]:[-e/t];var s=t*t-4*h*e;return Math.abs(s)<de?[-t/(2*h)]:s>0?[(-t+Math.sqrt(s))/(2*h),(-t-Math.sqrt(s))/(2*h)]:[]}function pd(h,t,e,s){if(Math.abs(h)<de)return No(t,e,s);var i,r=(3*h*e-t*t)/(3*h*h),n=(2*t*t*t-9*h*t*e+27*h*h*s)/(27*h*h*h);if(Math.abs(r)<de)i=[An(-n)];else if(Math.abs(n)<de)i=[0].concat(r<0?[Math.sqrt(-r),-Math.sqrt(-r)]:[]);else{var o=n*n/4+r*r*r/27;if(Math.abs(o)<de)i=[-1.5*n/r,3*n/r];else if(o>0)i=[(a=An(-n/2-Math.sqrt(o)))-r/(3*a)];else{var a=2*Math.sqrt(-r/3),l=Math.acos(3*n/r/a)/3,c=2*Math.PI/3;i=[a*Math.cos(l),a*Math.cos(l-c),a*Math.cos(l-2*c)]}}for(var u=0;u<i.length;u++)i[u]-=t/(3*h);return i}function Js(h,t){if(h.length!==t.length)throw Error("Vectors must be of equal length!");for(var e=0,s=0;s<h.length;s++)e+=h[s]*t[s];return e}function ge(h,t,e){if(!(h.length>3)){e=e||new Array(3);var s=h[0],i=h[1],r=h[2]||0,n=t[0],o=t[1],a=t[2]||0;return e[0]=i*a-r*o,e[1]=r*n-s*a,e[2]=s*o-i*n,e}}function Fo(h,t){for(var e=0,s=0;s<h.length;s++)e+=(h[s]-t[s])*(h[s]-t[s]);return e}function $e(h){for(var t=0,e=0;e<h.length;e++)t+=h[e]*h[e];return Math.sqrt(t)}function gi(h,t){var e=Fo(h,t);return e===0?0:Math.sqrt(e)}function Ue(h,t){var e=t?ei(h,t):h,s=dd(e,function(r,n){return r+Math.pow(n,2)}),i=Math.sqrt(s);return i===0?cd(e,0):ud(e,function(r){return r/i})}function wn(h,t,e,s){t===void 0&&(t=[0,1,0]),e===void 0&&(e=0);var i=Math.cos(e),r=Math.sin(e),n=1-i,o=h[0],a=h[1],l=h[2],c=t[0],u=t[1],p=t[2],d=n*c,E=n*u;return(s=s||h)[0]=(d*c+i)*o+(d*u-r*p)*a+(d*p+r*u)*l,s[1]=(d*u+r*p)*o+(E*u+i)*a+(E*p-r*c)*l,s[2]=(d*p-r*u)*o+(E*p+r*c)*a+(n*p*p+i)*l,s}function fd(h,t,e,s,i){if(i===void 0&&(i=0),i===0)return[0,1,2,3];var r=function(a,l){return Math.pow(Fo(a,l),.5*i)},n=r(t,h),o=r(e,t)+n;return[0,n,o,r(s,e)+o]}function md(h,t,e,s,i){for(var r=Number.isFinite(i.tension)?i.tension:.5,n=Number.isFinite(i.alpha)?i.alpha:null,o=n>0?fd(h,t,e,s,n):null,a=new Array(h.length),l=0;l<h.length;l++){var c=0,u=0,p=h[l],d=t[l],E=e[l],m=s[l];if(o){var y=o[0],C=o[1],w=o[2],A=o[3];C-w!=0&&(y-C!=0&&y-w!=0&&(c=(1-r)*(w-C)*((p-d)/(y-C)-(p-E)/(y-w)+(d-E)/(C-w))),C-A!=0&&w-A!=0&&(u=(1-r)*(w-C)*((d-E)/(C-w)-(d-m)/(C-A)+(E-m)/(w-A))))}else c=(1-r)*(E-p)*.5,u=(1-r)*(m-d)*.5;var _=2*d-2*E+c+u,M=-3*d+3*E-2*c-u,L=c,O=d;a[l]=[_,M,L,O]}return a}function as(h,t){var e=h*h,s=h*e;return t[0]*s+t[1]*e+t[2]*h+t[3]}function hs(h,t){var e=h*h;return 3*t[0]*e+2*t[1]*h+t[2]}function Ui(h,t){return 6*t[0]*h+2*t[1]}function gd(h,t){var e=t[0],s=t[1],i=t[2],r=t[3]-h;return e===0&&s===0&&i===0&&r===0?[0]:pd(e,s,i,r).filter(function(n){return n>-de&&n<=1+de}).map(function(n){return se(n,0,1)})}function tr(h,t,e,s){s===void 0&&(s=null),s=s||new Array(e.length);for(var i=0;i<e.length;i++)s[i]=h(t,e[i]);return s}var Uo=function(){function h(t){t===void 0&&(t=null),this._alpha=0,this._tension=.5,this._closed=!1,this._onInvalidateCache=null,this._onInvalidateCache=t,this._cache={arcLengths:null,coefficients:null}}return h.prototype._invalidateCache=function(){this.points&&(this._cache={arcLengths:null,coefficients:null},this._onInvalidateCache&&this._onInvalidateCache())},Object.defineProperty(h.prototype,"alpha",{get:function(){return this._alpha},set:function(t){Number.isFinite(t)&&t!==this._alpha&&(this._invalidateCache(),this._alpha=t)},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"tension",{get:function(){return this._tension},set:function(t){Number.isFinite(t)&&t!==this._tension&&(this._invalidateCache(),this._tension=t)},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"points",{get:function(){return this._points},set:function(t){if(!t||t.length<2)throw Error("At least 2 control points are required!");this._points=t,this._invalidateCache()},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"closed",{get:function(){return this._closed},set:function(t){t=!!t,this._closed!==t&&(this._invalidateCache(),this._closed=t)},enumerable:!1,configurable:!0}),h.prototype.reset=function(){this._invalidateCache()},h.prototype.evaluateForT=function(t,e,s){var i=ld(e,this.points,this.closed),r=i.index;return tr(t,i.weight,this.getCoefficients(r),s)},h.prototype.getCoefficients=function(t){if(this.points){if(this._cache.coefficients||(this._cache.coefficients=new Map),!this._cache.coefficients.has(t)){var e=Ji(t,this.points,this.closed),s=md(e[0],e[1],e[2],e[3],{tension:this.tension,alpha:this.alpha});this._cache.coefficients.set(t,s)}return this._cache.coefficients.get(t)}},h}(),Ed=function(h){function t(e,s){e===void 0&&(e=300),s===void 0&&(s=null);var i=h.call(this,s)||this;return i._subDivisions=e,i}return Lo(t,h),Object.defineProperty(t.prototype,"arcLengths",{get:function(){return this._cache.arcLengths||(this._cache.arcLengths=this.computeArcLengths()),this._cache.arcLengths},enumerable:!1,configurable:!0}),t.prototype._invalidateCache=function(){h.prototype._invalidateCache.call(this),this._cache.arcLengths=null},t.prototype.computeArcLengths=function(){var e,s=[],i=this.evaluateForT(as,0),r=0;s.push(0);for(var n=1;n<=this._subDivisions;n++)r+=gi(e=this.evaluateForT(as,n/this._subDivisions),i),s.push(r),i=e;return s},t.prototype.lengthAt=function(e){var s=this.arcLengths;return e*s[s.length-1]},t.prototype.getT=function(e){var s=this.arcLengths,i=s.length,r=e*s[i-1],n=Qi(r,s);if(s[n]===r)return n/(i-1);var o=s[n];return(n+(r-o)/(s[n+1]-o))/(i-1)},t.prototype.getU=function(e){if(e===0)return 0;if(e===1)return 1;var s=this.arcLengths,i=s.length-1,r=s[i],n=e*i,o=Math.floor(n),a=s[o];if(n===o)return a/r;var l=o/i;return(a+gi(this.evaluateForT(as,l),this.evaluateForT(as,e)))/r},t}(Uo),Bo=[[[-.906179845938664,.23692688505618908],[-.5384693101056831,.47862867049936647],[0,.5688888888888889],[.5384693101056831,.47862867049936647],[.906179845938664,.23692688505618908]],[[-.932469514203152,.17132449237917036],[-.6612093864662645,.3607615730481386],[-.2386191860831969,.46791393457269104],[.2386191860831969,.46791393457269104],[.6612093864662645,.3607615730481386],[.932469514203152,.17132449237917036]],[[-.9491079123427585,.1294849661688697],[-.7415311855993945,.27970539148927664],[-.4058451513773972,.3818300505051189],[0,.4179591836734694],[.4058451513773972,.3818300505051189],[.7415311855993945,.27970539148927664],[.9491079123427585,.1294849661688697]],[[-.9602898564975363,.10122853629037626],[-.7966664774136267,.22238103445337448],[-.525532409916329,.31370664587788727],[-.1834346424956498,.362683783378362],[.1834346424956498,.362683783378362],[.525532409916329,.31370664587788727],[.7966664774136267,.22238103445337448],[.9602898564975363,.10122853629037626]],[[-.9681602395076261,.08127438836157441],[-.8360311073266358,.1806481606948574],[-.6133714327005904,.26061069640293544],[-.3242534234038089,.31234707704000286],[0,.3302393550012598],[.3242534234038089,.31234707704000286],[.6133714327005904,.26061069640293544],[.8360311073266358,.1806481606948574],[.9681602395076261,.08127438836157441]],[[-.9739065285171717,.06667134430868814],[-.8650633666889845,.1494513491505806],[-.6794095682990244,.21908636251598204],[-.4333953941292472,.26926671930999635],[-.14887433898163122,.29552422471475287],[.14887433898163122,.29552422471475287],[.4333953941292472,.26926671930999635],[.6794095682990244,.21908636251598204],[.8650633666889845,.1494513491505806],[.9739065285171717,.06667134430868814]],[[-.978228658146056,.0556685671161736],[-.887062599768095,.125580369464904],[-.730152005574049,.186290210927734],[-.519096129206811,.23319376459199],[-.269543155952344,.262804544510246],[0,.2729250867779],[.269543155952344,.262804544510246],[.519096129206811,.23319376459199],[.730152005574049,.186290210927734],[.887062599768095,.125580369464904],[.978228658146056,.0556685671161736]],[[-.981560634246719,.0471753363865118],[-.904117256370474,.106939325995318],[-.769902674194304,.160078328543346],[-.587317954286617,.203167426723065],[-.36783149899818,.233492536538354],[-.125233408511468,.249147045813402],[.125233408511468,.249147045813402],[.36783149899818,.233492536538354],[.587317954286617,.203167426723065],[.769902674194304,.160078328543346],[.904117256370474,.106939325995318],[.981560634246719,.0471753363865118]],[[-.984183054718588,.0404840047653158],[-.917598399222977,.0921214998377284],[-.801578090733309,.138873510219787],[-.64234933944034,.178145980761945],[-.448492751036446,.207816047536888],[-.230458315955134,.226283180262897],[0,.232551553230873],[.230458315955134,.226283180262897],[.448492751036446,.207816047536888],[.64234933944034,.178145980761945],[.801578090733309,.138873510219787],[.917598399222977,.0921214998377284],[.984183054718588,.0404840047653158]],[[-.986283808696812,.0351194603317518],[-.928434883663573,.0801580871597602],[-.827201315069764,.121518570687903],[-.687292904811685,.157203167158193],[-.515248636358154,.185538397477937],[-.319112368927889,.205198463721295],[-.108054948707343,.215263853463157],[.108054948707343,.215263853463157],[.319112368927889,.205198463721295],[.515248636358154,.185538397477937],[.687292904811685,.157203167158193],[.827201315069764,.121518570687903],[.928434883663573,.0801580871597602],[.986283808696812,.0351194603317518]],[[-.987992518020485,.0307532419961172],[-.937273392400705,.0703660474881081],[-.848206583410427,.107159220467171],[-.72441773136017,.139570677926154],[-.570972172608538,.166269205816993],[-.394151347077563,.186161000015562],[-.201194093997434,.198431485327111],[0,.202578241925561],[.201194093997434,.198431485327111],[.394151347077563,.186161000015562],[.570972172608538,.166269205816993],[.72441773136017,.139570677926154],[.848206583410427,.107159220467171],[.937273392400705,.0703660474881081],[.987992518020485,.0307532419961172]],[[-.989400934991649,.027152459411754],[-.944575023073232,.0622535239386478],[-.865631202387831,.0951585116824927],[-.755404408355003,.124628971255533],[-.617876244402643,.149595988816576],[-.458016777657227,.169156519395002],[-.281603550779258,.182603415044923],[-.0950125098376374,.189450610455068],[.0950125098376374,.189450610455068],[.281603550779258,.182603415044923],[.458016777657227,.169156519395002],[.617876244402643,.149595988816576],[.755404408355003,.124628971255533],[.865631202387831,.0951585116824927],[.944575023073232,.0622535239386478],[.989400934991649,.027152459411754]],[[-.990575475314417,.0241483028685479],[-.950675521768767,.0554595293739872],[-.880239153726985,.0850361483171791],[-.781514003896801,.111883847193403],[-.65767115921669,.135136368468525],[-.512690537086476,.15404576107681],[-.351231763453876,.16800410215645],[-.178484181495847,.176562705366992],[0,.179446470356206],[.178484181495847,.176562705366992],[.351231763453876,.16800410215645],[.512690537086476,.15404576107681],[.65767115921669,.135136368468525],[.781514003896801,.111883847193403],[.880239153726985,.0850361483171791],[.950675521768767,.0554595293739872],[.990575475314417,.0241483028685479]],[[-.99156516842093,.0216160135264833],[-.955823949571397,.0497145488949698],[-.892602466497555,.076425730254889],[-.803704958972523,.100942044106287],[-.691687043060353,.122555206711478],[-.559770831073947,.14064291467065],[-.411751161462842,.154684675126265],[-.251886225691505,.164276483745832],[-.0847750130417353,.169142382963143],[.0847750130417353,.169142382963143],[.251886225691505,.164276483745832],[.411751161462842,.154684675126265],[.559770831073947,.14064291467065],[.691687043060353,.122555206711478],[.803704958972523,.100942044106287],[.892602466497555,.076425730254889],[.955823949571397,.0497145488949697],[.99156516842093,.0216160135264833]],[[-.992406843843584,.0194617882297264],[-.96020815213483,.0448142267656996],[-.903155903614817,.0690445427376412],[-.822714656537142,.0914900216224499],[-.720966177335229,.111566645547333],[-.600545304661681,.128753962539336],[-.46457074137596,.142606702173606],[-.316564099963629,.152766042065859],[-.160358645640225,.158968843393954],[0,.161054449848783],[.160358645640225,.158968843393954],[.316564099963629,.152766042065859],[.46457074137596,.142606702173606],[.600545304661681,.128753962539336],[.720966177335229,.111566645547333],[.822714656537142,.0914900216224499],[.903155903614817,.0690445427376412],[.96020815213483,.0448142267656996],[.992406843843584,.0194617882297264]],[[-.993128599185094,.0176140071391521],[-.963971927277913,.0406014298003869],[-.912234428251325,.062672048334109],[-.839116971822218,.0832767415767047],[-.74633190646015,.10193011981724],[-.636053680726515,.118194531961518],[-.510867001950827,.131688638449176],[-.373706088715419,.142096109318382],[-.227785851141645,.149172986472603],[-.0765265211334973,.152753387130725],[.0765265211334973,.152753387130725],[.227785851141645,.149172986472603],[.373706088715419,.142096109318382],[.510867001950827,.131688638449176],[.636053680726515,.118194531961518],[.74633190646015,.10193011981724],[.839116971822218,.0832767415767047],[.912234428251325,.062672048334109],[.963971927277913,.0406014298003869],[.993128599185094,.0176140071391521]],[[-.993752170620389,.0160172282577743],[-.967226838566306,.0369537897708524],[-.9200993341504,.0571344254268572],[-.853363364583317,.0761001136283793],[-.768439963475677,.0934444234560338],[-.667138804197412,.108797299167148],[-.551618835887219,.121831416053728],[-.424342120207438,.132268938633337],[-.288021316802401,.139887394791073],[-.145561854160895,.14452440398997],[0,.14608113364969],[.145561854160895,.14452440398997],[.288021316802401,.139887394791073],[.424342120207438,.132268938633337],[.551618835887219,.121831416053728],[.667138804197412,.108797299167148],[.768439963475677,.0934444234560338],[.853363364583317,.0761001136283793],[.9200993341504,.0571344254268572],[.967226838566306,.0369537897708524],[.993752170620389,.0160172282577743]],[[-.994294585482399,.0146279952982722],[-.970060497835428,.0337749015848141],[-.926956772187174,.0522933351526832],[-.8658125777203,.0697964684245204],[-.787816805979208,.0859416062170677],[-.694487263186682,.10041414444288],[-.587640403506911,.112932296080539],[-.469355837986757,.123252376810512],[-.341935820892084,.131173504787062],[-.207860426688221,.136541498346015],[-.0697392733197222,.139251872855631],[.0697392733197222,.139251872855631],[.207860426688221,.136541498346015],[.341935820892084,.131173504787062],[.469355837986757,.123252376810512],[.587640403506911,.112932296080539],[.694487263186682,.10041414444288],[.787816805979208,.0859416062170677],[.8658125777203,.0697964684245204],[.926956772187174,.0522933351526832],[.970060497835428,.0337749015848141],[.994294585482399,.0146279952982722]],[[-.994769334997552,.0134118594871417],[-.972542471218115,.0309880058569794],[-.932971086826016,.0480376717310846],[-.876752358270441,.0642324214085258],[-.804888401618839,.0792814117767189],[-.71866136313195,.0929157660600351],[-.619609875763646,.104892091464541],[-.509501477846007,.114996640222411],[-.39030103803029,.123049084306729],[-.264135680970344,.128905722188082],[-.133256824298466,.132462039404696],[0,.133654572186106],[.133256824298466,.132462039404696],[.264135680970344,.128905722188082],[.39030103803029,.123049084306729],[.509501477846007,.114996640222411],[.619609875763646,.104892091464541],[.71866136313195,.0929157660600351],[.804888401618839,.0792814117767189],[.876752358270441,.0642324214085258],[.932971086826016,.0480376717310846],[.972542471218115,.0309880058569794],[.994769334997552,.0134118594871417]],[[-.995187219997021,.0123412297999872],[-.974728555971309,.0285313886289336],[-.938274552002732,.0442774388174198],[-.886415527004401,.0592985849154367],[-.820001985973902,.0733464814110803],[-.740124191578554,.0861901615319532],[-.648093651936975,.0976186521041138],[-.545421471388839,.107444270115965],[-.433793507626045,.115505668053725],[-.315042679696163,.121670472927803],[-.191118867473616,.125837456346828],[-.0640568928626056,.127938195346752],[.0640568928626056,.127938195346752],[.191118867473616,.125837456346828],[.315042679696163,.121670472927803],[.433793507626045,.115505668053725],[.545421471388839,.107444270115965],[.648093651936975,.0976186521041138],[.740124191578554,.0861901615319532],[.820001985973902,.0733464814110803],[.886415527004401,.0592985849154367],[.938274552002732,.0442774388174198],[.974728555971309,.0285313886289336],[.995187219997021,.0123412297999872]],[[-.995556969790498,.0113937985010262],[-.976663921459517,.0263549866150321],[-.942974571228974,.0409391567013063],[-.894991997878275,.0549046959758351],[-.833442628760834,.0680383338123569],[-.759259263037357,.080140700335001],[-.673566368473468,.0910282619829636],[-.577662930241222,.10053594906705],[-.473002731445714,.108519624474263],[-.361172305809387,.114858259145711],[-.243866883720988,.119455763535784],[-.12286469261071,.12224244299031],[0,.123176053726715],[.12286469261071,.12224244299031],[.243866883720988,.119455763535784],[.361172305809387,.114858259145711],[.473002731445714,.108519624474263],[.577662930241222,.10053594906705],[.673566368473468,.0910282619829636],[.759259263037357,.080140700335001],[.833442628760834,.0680383338123569],[.894991997878275,.0549046959758351],[.942974571228974,.0409391567013063],[.976663921459517,.0263549866150321],[.995556969790498,.0113937985010262]],[[-.995885701145616,.010551372617343],[-.97838544595647,.0244178510926319],[-.947159066661714,.0379623832943627],[-.902637861984307,.0509758252971478],[-.845445942788498,.0632740463295748],[-.776385948820678,.0746841497656597],[-.696427260419957,.0850458943134852],[-.606692293017618,.0942138003559141],[-.508440714824505,.102059161094425],[-.403051755123486,.108471840528576],[-.292004839485956,.113361816546319],[-.17685882035689,.116660443485296],[-.0592300934293132,.118321415279262],[.0592300934293132,.118321415279262],[.17685882035689,.116660443485296],[.292004839485956,.113361816546319],[.403051755123486,.108471840528576],[.508440714824505,.102059161094425],[.606692293017618,.0942138003559141],[.696427260419957,.0850458943134852],[.776385948820678,.0746841497656597],[.845445942788498,.0632740463295748],[.902637861984307,.0509758252971478],[.947159066661714,.0379623832943627],[.97838544595647,.0244178510926319],[.995885701145616,.010551372617343]],[[-.996179262888988,.00979899605129436],[-.979923475961501,.0226862315961806],[-.950900557814705,.0352970537574197],[-.909482320677491,.047449412520615],[-.856207908018294,.0589835368598335],[-.791771639070508,.0697488237662455],[-.717013473739423,.0796048677730577],[-.632907971946495,.0884231585437569],[-.540551564579456,.0960887273700285],[-.441148251750026,.102501637817745],[-.335993903638508,.107578285788533],[-.226459365439536,.111252488356845],[-.113972585609529,.113476346108965],[0,.114220867378956],[.113972585609529,.113476346108965],[.226459365439536,.111252488356845],[.335993903638508,.107578285788533],[.441148251750026,.102501637817745],[.540551564579456,.0960887273700285],[.632907971946495,.0884231585437569],[.717013473739423,.0796048677730577],[.791771639070508,.0697488237662455],[.856207908018294,.0589835368598336],[.909482320677491,.047449412520615],[.950900557814705,.0352970537574197],[.979923475961501,.0226862315961806],[.996179262888988,.00979899605129436]],[[-.996442497573954,.00912428259309452],[-.981303165370872,.0211321125927712],[-.954259280628938,.0329014277823043],[-.915633026392132,.0442729347590042],[-.865892522574395,.0551073456757167],[-.805641370917179,.0652729239669995],[-.735610878013631,.0746462142345687],[-.656651094038864,.0831134172289012],[-.569720471811401,.0905717443930328],[-.475874224955118,.0969306579979299],[-.376251516089078,.10211296757806],[-.272061627635178,.106055765922846],[-.16456928213338,.108711192258294],[-.0550792898840342,.110047013016475],[.0550792898840342,.110047013016475],[.16456928213338,.108711192258294],[.272061627635178,.106055765922846],[.376251516089078,.10211296757806],[.475874224955118,.0969306579979299],[.569720471811401,.0905717443930328],[.656651094038864,.0831134172289012],[.735610878013631,.0746462142345687],[.805641370917179,.0652729239669995],[.865892522574395,.0551073456757167],[.915633026392132,.0442729347590042],[.954259280628938,.0329014277823043],[.981303165370872,.0211321125927712],[.996442497573954,.00912428259309452]],[[-.996679442260596,.00851690387874641],[-.982545505261413,.0197320850561227],[-.957285595778087,.0307404922020936],[-.921180232953058,.0414020625186828],[-.874637804920102,.0515948269024979],[-.818185487615252,.0612030906570791],[-.752462851734477,.0701179332550512],[-.678214537602686,.0782383271357637],[-.596281797138227,.0854722573661725],[-.507592955124227,.0917377571392587],[-.413152888174008,.0969638340944086],[-.314031637867639,.101091273759914],[-.211352286166001,.104073310077729],[-.106278230132679,.10587615509732],[0,.106479381718314],[.106278230132679,.10587615509732],[.211352286166001,.104073310077729],[.314031637867639,.101091273759914],[.413152888174008,.0969638340944086],[.507592955124227,.0917377571392587],[.596281797138227,.0854722573661725],[.678214537602686,.0782383271357637],[.752462851734477,.0701179332550512],[.818185487615252,.0612030906570791],[.874637804920102,.0515948269024979],[.921180232953058,.0414020625186828],[.957285595778087,.0307404922020936],[.982545505261413,.0197320850561227],[.996679442260596,.00851690387874641]],[[-.996893484074649,.0079681924961666],[-.983668123279747,.0184664683110909],[-.960021864968307,.0287847078833233],[-.926200047429274,.038799192569627],[-.882560535792052,.048402672830594],[-.829565762382768,.057493156217619],[-.767777432104826,.0659742298821805],[-.697850494793315,.0737559747377052],[-.620526182989242,.0807558952294202],[-.536624148142019,.0868997872010829],[-.447033769538089,.0921225222377861],[-.352704725530878,.0963687371746442],[-.254636926167889,.0995934205867952],[-.153869913608583,.101762389748405],[-.0514718425553176,.102852652893558],[.0514718425553176,.102852652893558],[.153869913608583,.101762389748405],[.254636926167889,.0995934205867952],[.352704725530878,.0963687371746442],[.447033769538089,.0921225222377861],[.536624148142019,.0868997872010829],[.620526182989242,.0807558952294202],[.697850494793315,.0737559747377052],[.767777432104826,.0659742298821805],[.829565762382768,.057493156217619],[.882560535792052,.048402672830594],[.926200047429274,.038799192569627],[.960021864968307,.0287847078833233],[.983668123279747,.0184664683110909],[.996893484074649,.0079681924961666]]],xn=Bo.length+5,Cd=function(h){function t(e,s,i){e===void 0&&(e=24),s===void 0&&(s=21);var r=h.call(this,i)||this;return r._nSamples=21,r._gauss=function(n){if(n<5||n>xn)throw Error("Order for Gaussian Quadrature must be in the range of ".concat(5," and ").concat(xn,"."));return Bo[n-5]}(e),r._nSamples=s,r}return Lo(t,h),t.prototype._invalidateCache=function(){h.prototype._invalidateCache.call(this),this._cache.arcLengths=null,this._cache.samples=null},Object.defineProperty(t.prototype,"arcLengths",{get:function(){return this._cache.arcLengths||(this._cache.arcLengths=this.computeArcLengths()),this._cache.arcLengths},enumerable:!1,configurable:!0}),t.prototype.getSamples=function(e){if(this.points){if(this._cache.samples||(this._cache.samples=new Map),!this._cache.samples.has(e)){for(var s=this._nSamples,i=[],r=[],n=this.getCoefficients(e),o=0;o<s;++o){var a=o/(s-1);i.push(this.computeArcLength(e,0,a));var l=$e(tr(hs,a,n)),c=l===0?0:1/l;this.tension>.95&&(c=se(c,-1,1)),r.push(c)}var u=s-1,p=[],d=[],E=i[0],m=r[0],y=1/u;for(o=0;o<u;++o){var C=E,w=(E=i[o+1])-C,A=m,_=r[o+1];m=_;var M=y/w,L=(A+_-2*M)/(w*w),O=(3*M-2*A-_)/w;p.push(L),d.push(O)}this._cache.samples.set(e,[i,r,d,p])}return this._cache.samples.get(e)}},t.prototype.computeArcLength=function(e,s,i){if(s===void 0&&(s=0),i===void 0&&(i=1),s===i)return 0;for(var r=this.getCoefficients(e),n=.5*(i-s),o=0,a=0;a<this._gauss.length;a++){var l=this._gauss[a],c=l[0];o+=l[1]*$e(tr(hs,n*c+n+s,r))}return n*o},t.prototype.computeArcLengths=function(){if(this.points){var e=[];e.push(0);for(var s=this.closed?this.points.length:this.points.length-1,i=0,r=0;r<s;r++)i+=this.computeArcLength(r),e.push(i);return e}},t.prototype.inverse=function(e,s){var i=1/(this._nSamples-1),r=this.getSamples(e),n=r[0],o=r[1],a=r[2],l=r[3];if(s>=n[n.length-1])return 1;if(s<=0)return 0;var c=Math.max(0,Qi(s,n)),u=c*i;if(n[c]===s)return u;var p=o[c],d=l[c],E=a[c],m=s-n[c];return((d*m+E)*m+p)*m+u},t.prototype.lengthAt=function(e){return e*this.arcLengths[this.arcLengths.length-1]},t.prototype.getT=function(e){var s=this.arcLengths,i=s.length,r=e*s[i-1],n=Qi(r,s),o=n/(i-1);if(s[n]===r)return o;var a=r-s[n];return(n+this.inverse(n,a))/(i-1)},t.prototype.getU=function(e){if(e===0)return 0;if(e===1)return 1;var s=this.arcLengths,i=s.length-1,r=s[i],n=e*i,o=Math.floor(n),a=s[o];if(n===o)return a/r;var l=n-o;return(a+this.computeArcLength(o,0,l))/r},t}(Uo),Td=function(){function h(t,e){e===void 0&&(e={});var s=this;this._cache=new Map;var i=(e=mi({tension:.5,alpha:0,closed:!1},e)).arcDivisions?new Ed(e.arcDivisions,function(){return s._invalidateCache()}):new Cd(e.numericalApproximationOrder,e.numericalInverseSamples,function(){return s._invalidateCache()});i.alpha=e.alpha,i.tension=e.tension,i.closed=e.closed,i.points=t,this._lmargin=e.lmargin||1-i.tension,this._curveMapper=i}return h.prototype.getTimeFromPosition=function(t,e){return e===void 0&&(e=!1),this._curveMapper.getT(e?se(t,0,1):t)},h.prototype.getPositionFromTime=function(t,e){return e===void 0&&(e=!1),this._curveMapper.getU(e?se(t,0,1):t)},h.prototype.getPositionFromLength=function(t,e){e===void 0&&(e=!1);var s=e?se(t,0,this.length):t;return this._curveMapper.getU(s/this.length)},h.prototype.getLengthAt=function(t,e){return t===void 0&&(t=1),e===void 0&&(e=!1),this._curveMapper.lengthAt(e?se(t,0,1):t)},h.prototype.getTimeAtKnot=function(t){if(t<0||t>this.points.length-1)throw Error("Invalid index!");return t===0?0:this.closed||t!==this.points.length-1?t/(this.closed?this.points.length:this.points.length-1):1},h.prototype.getPositionAtKnot=function(t){return this.getPositionFromTime(this.getTimeAtKnot(t))},h.prototype.getPointAtTime=function(t,e){return(t=se(t,0,1))===0?ei(this.points[0],e):t===1?ei(this.closed?this.points[0]:this.points[this.points.length-1],e):this._curveMapper.evaluateForT(as,t,e)},h.prototype.getPointAt=function(t,e){return this.getPointAtTime(this.getTimeFromPosition(t),e)},h.prototype.getTangentAt=function(t,e){var s=se(this.getTimeFromPosition(t),0,1);return this.getTangentAtTime(s,e)},h.prototype.getTangentAtTime=function(t,e){return Ue(this._curveMapper.evaluateForT(hs,t,e))},h.prototype.getNormalAt=function(t,e){var s=se(this.getTimeFromPosition(t),0,1);return this.getNormalAtTime(s,e)},h.prototype.getNormalAtTime=function(t,e){var s=Ue(this._curveMapper.evaluateForT(hs,t));if(!(s.length<2||s.length>3)){var i=e||new Array(s.length);if(s.length===2)return i[0]=-s[1],i[1]=s[0],i;var r=Ue(this._curveMapper.evaluateForT(Ui,t));return Ue(ge(ge(s,r),s),i)}},h.prototype.getFrenetFrames=function(t,e,s){if(e===void 0&&(e=0),s===void 0&&(s=1),!(e<0||s>1||s<e)){for(var i=new Array(t+1),r=new Array(t+1),n=0;n<=t;n++){var o=e===0&&s===1?n/t:e+n/t*(s-e);i[n]=this.getTangentAt(o)}if(this.dim===2){for(n=0;n<i.length;n++)r[n]=[-i[n][1],i[n][0]];return{tangents:i,normals:r}}if(this.dim===3){var a=new Array(t+1),l=void 0,c=Number.MAX_VALUE,u=Math.abs(i[0][0]),p=Math.abs(i[0][1]);u<=c&&(c=u,l=[1,0,0]),p<=c&&(c=p,l=[0,1,0]),Math.abs(i[0][2])<=c&&(l=[0,0,1]);var d=Ue(ge(i[0],l));for(r[0]=ge(i[0],d),a[0]=ge(i[0],r[0]),n=1;n<=t;n++){if(d=ge(i[n-1],i[n]),r[n]=ei(r[n-1]),$e(d)>de){Ue(d);var E=Math.acos(se(Js(i[n-1],i[n]),-1,1));wn(r[n-1],d,E,r[n])}a[n]=ge(i[n],r[n])}if(this.closed===!0)for(E=Math.acos(se(Js(r[0],r[t]),-1,1))/t,Js(i[0],ge(r[0],r[t]))>0&&(E=-E),n=1;n<=t;n++)wn(r[n],i[n],E*n,r[n]),a[n]=ge(i[n],r[n]);return{tangents:i,normals:r,binormals:a}}}},h.prototype.getCurvatureAt=function(t){var e=se(this.getTimeFromPosition(t),0,1);return this.getCurvatureAtTime(e)},h.prototype.getCurvatureAtTime=function(t){var e=this._curveMapper.evaluateForT(hs,t),s=this._curveMapper.evaluateForT(Ui,t),i=Ue(e,[]),r=0,n=void 0;if(e.length===2){if((u=Math.pow(e[0]*e[0]+e[1]*e[1],1.5))!==0){var o=(e[0]*s[1]-e[1]*s[0])/u;n=o<0?[i[1],-i[0]]:[-i[1],i[0]],r=Math.abs(o)}}else if(e.length===3){var a=$e(e),l=ge(e,s);n=Ue(ge(l,e)),a!==0&&(r=$e(l)/Math.pow(a,3))}else{a=$e(e);var c=$e(s),u=Math.pow(a,3),p=Js(e,s);u!==0&&(r=Math.sqrt(Math.pow(a,2)*Math.pow(c,2)-Math.pow(p,2))/u)}return{curvature:r,radius:r!==0?1/r:0,tangent:i,direction:n}},h.prototype.getDerivativeAt=function(t,e){var s=se(this.getTimeFromPosition(t),0,1);return this._curveMapper.evaluateForT(hs,s,e)},h.prototype.getSecondDerivativeAt=function(t,e){var s=se(this.getTimeFromPosition(t),0,1);return this._curveMapper.evaluateForT(Ui,s,e)},h.prototype.getBoundingBox=function(t,e){if(t===void 0&&(t=0),e===void 0&&(e=1),t===0&&e===1&&this._cache.has("bbox"))return this._cache.get("bbox");for(var s=[],i=[],r=this.getTimeFromPosition(t),n=this.getTimeFromPosition(e),o=this.getPointAtTime(r),a=this.getPointAtTime(n),l=this.closed?this.points.length:this.points.length-1,c=Math.floor(l*r),u=Math.ceil(l*n),p=0;p<o.length;p++)s[p]=Math.min(o[p],a[p]),i[p]=Math.max(o[p],a[p]);for(var d=function(C){var w=Ji(C-1,E.points,E.closed)[2];if(C<u)for(var A=0;A<w.length;A++)w[A]<s[A]&&(s[A]=w[A]),w[A]>i[A]&&(i[A]=w[A]);if(E.tension<1){var _=l*r-(C-1),M=l*n-(C-1),L=function(D){return D>-de&&D<=1+de&&(C-1!==c||D>_)&&(C!==u||D<M)},O=E._curveMapper.getCoefficients(C-1),H=function(D){var W=O[D];No(3*W[0],2*W[1],W[2]).filter(L).forEach(function(et){var b=as(et,O[D]);b<s[D]&&(s[D]=b),b>i[D]&&(i[D]=b)})};for(A=0;A<O.length;A++)H(A)}},E=this,m=c+1;m<=u;m++)d(m);var y={min:s,max:i};return t===0&&e===1&&this._cache.set("bbox",y),y},h.prototype.getPoints=function(t,e,s,i){if(t===void 0&&(t=100),s===void 0&&(s=0),i===void 0&&(i=1),!t||t<=0)throw Error("Invalid arguments passed to getPoints(). You must specify at least 1 sample/segment.");if(!(s<0||i>1||i<s)){for(var r=[],n=0;n<=t;n++){var o=s===0&&i===1?n/t:s+n/t*(i-s);r.push(this.getPointAt(o,e&&new e))}return r}},h.prototype.getNearestPosition=function(t,e,s){var i=this;if(e===void 0&&(e=1e-5),e<=0||!Number.isFinite(e))throw Error("Invalid threshold. Must be a number greater than zero!");s=s||10*this.points.length-1;var r=new Array(t.length),n=1/0,o=0,a=this.createLookupTable(function(p){return i.getPointAt(p)},s,{cacheKey:"lut_nearest_".concat(s)});Array.from(a.keys()).forEach(function(p){var d=a.get(p),E=gi(t,d);if(E<n)return n=E,o=p,!0});for(var l=this.getTimeFromPosition(o),c=function(p){if(p>=0&&p<=1){i.getPointAtTime(p,r);var d=gi(t,r);if(d<n)return n=d,l=p,!0}},u=.005;u>e;)c(l-u)||c(l+u)||(u/=2);return{u:o=this._curveMapper.getU(l),distance:n,point:r}},h.prototype.getIntersects=function(t,e,s,i){var r=this;e===void 0&&(e=0),s===void 0&&(s=0),i===void 0&&(i=this._lmargin);var n=this.getIntersectsAsTime(t,e,s,i).map(function(o){return r.getPointAtTime(o)});return Math.abs(s)===1?n.length===1?n[0]:null:n},h.prototype.getIntersectsAsPositions=function(t,e,s,i){var r=this;return e===void 0&&(e=0),s===void 0&&(s=0),i===void 0&&(i=this._lmargin),this.getIntersectsAsTime(t,e,s,i).map(function(n){return r.getPositionFromTime(n)})},h.prototype.getIntersectsAsTime=function(t,e,s,i){e===void 0&&(e=0),s===void 0&&(s=0),i===void 0&&(i=this._lmargin);for(var r=e,n=new Set,o=this.closed?this.points.length:this.points.length-1,a=0;a<o&&(s===0||n.size<Math.abs(s));a+=1){var l=s<0?o-(a+1):a,c=Ji(l,this.points,this.closed),u=c[1],p=c[2],d=this._curveMapper.getCoefficients(l),E=void 0,m=void 0;if(u[r]<p[r]?(E=u[r],m=p[r]):(E=p[r],m=u[r]),t-i<=m&&t+i>=E){var y=gd(t,d[r]);s<0?y.sort(function(A,_){return _-A}):s>=0&&y.sort(function(A,_){return A-_});for(var C=0;C<y.length;C++){var w=(y[C]+l)/o;if(n.add(w),s!==0&&n.size===Math.abs(s))break}}}return Array.from(n)},h.prototype.createLookupTable=function(t,e,s){if(!e||e<=1)throw Error("Invalid arguments passed to createLookupTable(). You must specify at least 2 samples.");var i=mi({from:0,to:1,cacheForceUpdate:!1},s),r=i.from,n=i.to,o=i.cacheKey,a=i.cacheForceUpdate;if(!(r<0||n>1||n<r)){var l=null;if(o&&!a&&this._cache.has(o))o&&this._cache.has(o)&&(l=this._cache.get(o));else{l=new Map;for(var c=0;c<e;c++){var u=r===0&&n===1?c/(e-1):r+c/(e-1)*(n-r),p=t(u);l.set(u,p)}o&&this._cache.set(o,l)}return l}},h.prototype.forEach=function(t,e,s,i){var r=this;s===void 0&&(s=0),i===void 0&&(i=1);var n=[];if(Number.isFinite(e)){var o=e;if(o<=1)throw Error("Invalid arguments passed to forEach(). You must specify at least 2 samples.");for(var a=0;a<o;a++){var l=s===0&&i===1?a/(o-1):s+a/(o-1)*(i-s);n.push(l)}}else Array.isArray(e)&&(n=e);var c=null;n.forEach(function(u,p){if(!Number.isFinite(u)||u<0||u>1)throw Error("Invalid position (u) for sample in forEach!");var d=r.getTimeFromPosition(u),E=t({u,t:d,i:p,prev:c});c={u,t:d,i:p,value:E}})},h.prototype.map=function(t,e,s,i){var r=this;s===void 0&&(s=0),i===void 0&&(i=1);var n=[];if(Number.isFinite(e)){var o=e;if(o<=1)throw Error("Invalid arguments passed to map(). You must specify at least 2 samples.");for(var a=0;a<o;a++){var l=s===0&&i===1?a/(o-1):s+a/(o-1)*(i-s);n.push(l)}}else Array.isArray(e)&&(n=e);var c=null;return n.map(function(u,p){if(!Number.isFinite(u)||u<0||u>1)throw Error("Invalid position (u) for sample in map()!");var d=r.getTimeFromPosition(u),E=t({u,t:d,i:p,prev:c});return c={u,t:d,i:p,value:E},E})},h.prototype.reduce=function(t,e,s,i,r){var n=this;i===void 0&&(i=0),r===void 0&&(r=1);var o=[];if(Number.isFinite(s)){var a=s;if(a<=1)throw Error("Invalid arguments passed to map(). You must specify at least 2 samples.");for(var l=0;l<a;l++){var c=i===0&&r===1?l/(a-1):i+l/(a-1)*(r-i);o.push(c)}}else Array.isArray(s)&&(o=s);return o.reduce(function(u,p,d){if(!Number.isFinite(p)||p<0||p>1)throw Error("Invalid position (u) for sample in map()!");var E=n.getTimeFromPosition(p);return t({acc:u,u:p,t:E,i:d})},e)},h.prototype._invalidateCache=function(){return this._cache=new Map,this},h.prototype.reset=function(){this._curveMapper.reset()},Object.defineProperty(h.prototype,"points",{get:function(){return this._curveMapper.points},set:function(t){this._curveMapper.points=t},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"tension",{get:function(){return this._curveMapper.tension},set:function(t){this._curveMapper.tension=t},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"alpha",{get:function(){return this._curveMapper.alpha},set:function(t){this._curveMapper.alpha=t},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"closed",{get:function(){return this._curveMapper.closed},set:function(t){this._curveMapper.closed=t},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"length",{get:function(){return this._curveMapper.lengthAt(1)},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"minX",{get:function(){return this.getBoundingBox().min[0]},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"maxX",{get:function(){return this.getBoundingBox().max[0]},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"minY",{get:function(){return this.getBoundingBox().min[1]},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"maxY",{get:function(){return this.getBoundingBox().max[1]},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"minZ",{get:function(){return this.getBoundingBox().min[2]},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"maxZ",{get:function(){return this.getBoundingBox().max[2]},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"dim",{get:function(){var t;return((t=this.points[0])===null||t===void 0?void 0:t.length)||void 0},enumerable:!1,configurable:!0}),h}(),Up=function(){function h(t,e,s,i){t===void 0&&(t=0),e===void 0&&(e=0),s===void 0&&(s=null),i===void 0&&(i=null),this.x=t,this.y=e,this.z=s,this.w=i}return Object.defineProperty(h.prototype,0,{get:function(){return this.x},set:function(t){this.x=t},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,1,{get:function(){return this.y},set:function(t){this.y=t},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,2,{get:function(){return this.z},set:function(t){this.z=t},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,3,{get:function(){return this.w},set:function(t){this.w=t},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"length",{get:function(){return Number.isFinite(this.w)?4:Number.isFinite(this.z)?3:2},enumerable:!1,configurable:!0}),h}();class xr{static async createFromFile(t){let s=await(await fetch(t)).json();if(!s.hasOwnProperty("Ident")||s.Ident!="JLM")throw new Error("Curve::createFromFile(): File not valid !");const i=[];for(const r of s.Points)i.push(r);return xr.createInterpolator(i,{tension:s.Tension??.5,alpha:s.Alpha??0,closed:s.Closed??!1,arcDivisions:s.ArcDivisions,numericalApproximationOrder:s.NumericalApproximationOrder,numericalInverseSamples:s.NumericalInverseSamples,lmargin:s.LMargin})}static createInterpolator(t,e){return new Td(t,{tension:e.tension,alpha:e.alpha,closed:e.closed,arcDivisions:e.arcDivisions,numericalApproximationOrder:e.numericalApproximationOrder,numericalInverseSamples:e.numericalInverseSamples,lmargin:e.lmargin})}}class yd extends yt{constructor(){super(),this.obj=null,this.skySphere=null,this.lookAtTween=null,this.camera=new Xe(0),this.curve=null,this.curveVertices=[],this.curveVertexCount=0,this.t=.1}async onEnter(){this.obj=new Hs,await this.obj.loadFromFile("./utils/curve/level.obj","./utils/curve/level.mtl"),this.skySphere=new ft,await this.skySphere.loadFromFile("./utils/curve/sky_sphere.jsm"),this.skySphere.setMaterial(new vt({texture:await st.loadTexture("./utils/curve/sky_sphere.jpg")})),this.curve=await xr.createFromFile("./utils/curve/curve.json");for(let t=0;t<=.99;t+=.01){const e=this.curve.getPointAt(t),s=this.curve.getPointAt(t+.01);this.curveVertices.push(e[0],e[1],e[2],1,1,1),this.curveVertices.push(s[0],s[1],s[2],1,1,1),this.curveVertexCount+=2}}update(t){if(this.obj.update(t),this.skySphere.update(t),this.t<.99){const e=this.curve.getPointAt(this.t),s=f.VEC3_NORMALIZE(this.curve.getTangentAt(this.t));this.camera.setPosition(e[0],e[1]+.1,e[2]),this.camera.lookAt(e[0]+s[0],e[1]+s[1],e[2]+s[2]),this.t+=t/1e4}}draw(){Jt.drawVertices(this.curveVertices,this.curveVertexCount),Ot.setAmbientColor([.5,.5,.5]),Ot.drawDirLight([0,-1,0],[1,1,1],[0,0,0]),this.obj.draw(),this.skySphere.draw()}}class Ad extends yt{models;camera;selected;selectedRotate;radius;cameraAngle;cameraDistance;cameraHeight;cameraTargetAngle;cameraInterpolationStep;constructor(){super(),this.models=[],this.camera=new Xe(0),this.selected=0,this.selectedRotate=0,this.radius=3,this.cameraAngle=0,this.cameraDistance=10,this.cameraHeight=3,this.cameraTargetAngle=0,this.cameraInterpolationStep=10}async onEnter(){k.getContext().configure({device:k.getDevice(),format:navigator.gpu.getPreferredCanvasFormat(),alphaMode:"premultiplied"}),k.getCurrentView().setBgColor(1,1,0,0);const s=document.querySelector("#CANVAS_3D");s.style.backgroundImage="url(./utils/menu-ring/bg.png)",this.models.push(await Qs("./utils/menu-ring/scar.bsm","./utils/menu-ring/scar.jpeg")),this.models.push(await Qs("./utils/menu-ring/shotgun.bsm","./utils/menu-ring/shotgun.jpeg")),this.models.push(await Qs("./utils/menu-ring/usp.bsm","./utils/menu-ring/usp.jpeg")),this.models.push(await Qs("./utils/menu-ring/m4.bsm","./utils/menu-ring/m4.jpeg")),v.subscribe(Q,"E_ACTION_ONCE",this,this.#s)}update(t){this.#t(t),this.#e(t)}draw(){for(const t of this.models)t.draw()}#t(t){for(let e=0;e<this.models.length;e++){const s=Math.cos(this.#r()*e)*this.radius,i=Math.sin(this.#r()*e)*this.radius;this.models[e].setPosition(s,0,i),this.selected==e&&this.models[e].rotate(0,.01,0)}}#e(t){this.cameraAngle=this.cameraAngle+(this.cameraTargetAngle-this.cameraAngle)/this.cameraInterpolationStep;const e=Math.cos(this.cameraAngle)*this.cameraDistance,s=Math.sin(this.cameraAngle)*this.cameraDistance;this.camera.setPosition(e,this.cameraHeight,s),this.camera.lookAt(0,0,0)}#s(t){t.actionId=="LEFT"?this.#i(1):t.actionId=="RIGHT"&&this.#i(-1)}#i(t){this.models.length!=0&&(this.selectedRotate=this.selectedRotate+t,this.selected=(this.selected+t+this.models.length)%this.models.length,this.cameraTargetAngle=this.#r()*this.selectedRotate)}#r(){return Math.PI*2/this.models.length}}async function Qs(h,t){const e=new ft;return await e.loadFromBinaryFile(h),e.setMaterial(new vt({texture:await st.loadTexture(t)})),e}const wd=[[0,0],[0,1],[1,0],[1,1]],vn=[0,1,2,2,1,3],xd=[[-1,-1,0],[-1,1,0],[1,-1,0],[1,1,0]];var pe=(h=>(h.CLASSIC="CLASSIC",h.EXPLODE="EXPLODE",h))(pe||{}),fe=(h=>(h.CUBE="CUBE",h.SPHERE="SPHERE",h))(fe||{});class vd{position;velocity;acceleration;accelerationTween;angle;angleVelocity;angleAcceleration;size;sizeTween;color;colorTween;opacity;opacityTween;age;alive;constructor(){this.position=[0,0,0],this.velocity=[0,0,0],this.acceleration=[0,0,0],this.accelerationTween=new St,this.angle=0,this.angleVelocity=0,this.angleAcceleration=0,this.size=16,this.sizeTween=new St,this.color=[0,0,0],this.colorTween=new St,this.opacity=1,this.opacityTween=new St,this.age=0,this.alive=0}update(t){this.position=f.VEC3_ADD(this.position,f.VEC3_SCALE(this.velocity,t/1e3)),this.velocity=f.VEC3_ADD(this.velocity,f.VEC3_SCALE(this.acceleration,t/1e3)),this.angle+=this.angleVelocity*f.DEG_TO_RAD_RATIO*(t/1e3),this.angleVelocity+=this.angleAcceleration*f.DEG_TO_RAD_RATIO*(t/1e3),this.age+=t/1e3,this.sizeTween.isEmpty()||(this.size=this.sizeTween.interpolate(this.age)),this.colorTween.isEmpty()||(this.color=this.colorTween.interpolate(this.age)),this.opacityTween.isEmpty()||(this.opacity=this.opacityTween.interpolate(this.age)),this.accelerationTween.isEmpty()||(this.acceleration=this.accelerationTween.interpolate(this.age))}}class Id extends qe{textureChanged;positionStyle;positionBase;positionSpread;positionSphereRadiusBase;positionRadiusSpread;velocityStyle;velocityBase;velocitySpread;velocityExplodeSpeedBase;velocityExplodeSpeedSpread;colorBase;colorSpread;colorTween;sizeBase;sizeSpread;sizeTween;opacityBase;opacitySpread;opacityTween;accelerationBase;accelerationSpread;accelerationTween;angleBase;angleSpread;angleVelocityBase;angleVelocitySpread;angleAccelerationBase;angleAccelerationSpread;particleDeathAge;particlesPerSecond;particleQuantity;particleAlivedCount;particleArray;emitterDeathAge;emitterAge;emitterAlive;grp2;texture;constructor(t){super(Hn),this.textureChanged=!1,this.positionStyle=t.positionStyle??"CUBE",this.positionBase=t.positionBase??[0,0,0],this.positionSpread=t.positionSpread??[0,0,0],this.positionSphereRadiusBase=t.positionSphereRadiusBase??0,this.positionRadiusSpread=t.positionRadiusSpread??0,this.velocityStyle=t.velocityStyle??"CLASSIC",this.velocityBase=t.velocityBase??[0,0,0],this.velocitySpread=t.velocitySpread??[0,0,0],this.velocityExplodeSpeedBase=t.velocityExplodeSpeedBase??0,this.velocityExplodeSpeedSpread=t.velocityExplodeSpeedSpread??0,this.colorBase=t.colorBase??[0,1,.5],this.colorSpread=t.colorSpread??[0,0,0],this.colorTween=t.colorTween??new St,this.sizeBase=t.sizeBase??1,this.sizeSpread=t.sizeSpread??0,this.sizeTween=t.sizeTween??new St,this.opacityBase=t.opacityBase??1,this.opacitySpread=t.opacitySpread??0,this.opacityTween=t.opacityTween??new St,this.accelerationBase=t.accelerationBase??[0,0,0],this.accelerationSpread=t.accelerationSpread??[0,0,0],this.accelerationTween=t.accelerationTween??new St,this.angleBase=t.angleBase??0,this.angleSpread=t.angleSpread??0,this.angleVelocityBase=t.angleVelocityBase??0,this.angleVelocitySpread=t.angleVelocitySpread??0,this.angleAccelerationBase=t.angleAccelerationBase??0,this.angleAccelerationSpread=t.angleAccelerationSpread??0,this.particleDeathAge=t.particleDeathAge??1,this.particlesPerSecond=t.particlesPerSecond??30,this.particleQuantity=t.particleQuantity??100,this.particleAlivedCount=0,this.particleArray=[],this.emitterDeathAge=t.emitterDeathAge??60,this.emitterAge=0,this.emitterAlive=!0,this.grp2=k.createStaticGroup("PARTICLES_PIPELINE",2),this.texture=this.grp2.setTexture(0,"TEXTURE",t.texture??k.createTextureFromBitmap()),this.texture=this.grp2.setSampler(1,"SAMPLER",this.texture);for(let e=0;e<this.particleQuantity;e++)this.particleArray[e]=this.#s();this.grp2.allocate()}delete(){this.grp2.delete(),super.delete()}update(t){this.#t(t),this.#e(t)}draw(){jn.drawParticles(this)}setTexture(t){this.texture=t,this.textureChanged=!0}getTexture(){return this.texture}getGroup02(){return this.textureChanged&&(this.grp2.setTexture(0,"TEXTURE",this.texture),this.grp2.allocate(),this.textureChanged=!1),this.grp2}#t(t){const e=[];for(let s=0;s<this.particleQuantity;s++)this.particleArray[s].alive&&(this.particleArray[s].update(t),this.particleArray[s].age>this.particleDeathAge&&(this.particleArray[s].alive=0,this.particleAlivedCount--,e.push(s)));if(this.emitterAlive){if(this.emitterAge<this.particleDeathAge){let s=Math.round(this.particlesPerSecond*(this.emitterAge+0)),i=Math.round(this.particlesPerSecond*(this.emitterAge+t/1e3));i>this.particleQuantity&&(i=this.particleQuantity);for(let r=s;r<i;r++)this.particleArray[r].alive=1,this.particleAlivedCount++}for(let s=0;s<e.length;s++){const i=e[s];this.particleArray[i]=this.#s(),this.particleArray[i].alive=1,this.particleAlivedCount++}this.emitterAge+=t/1e3,this.emitterAge>this.emitterDeathAge&&(this.emitterAlive=!1)}}#e(t){this.beginVertices(this.particleAlivedCount*6);for(let e=0;e<this.particleQuantity;e++)if(this.particleArray[e].alive){const s=this.particleArray[e].position,i=this.particleArray[e].color,r=this.particleArray[e].size,n=this.particleArray[e].opacity,o=this.particleArray[e].angle,a=this.particleArray[e].alive;for(let l=0;l<6;l++){const c=xd[vn[l]],u=wd[vn[l]];this.defineVertex(c[0],c[1],c[2],s[0],s[1],s[2],u[0],u[1],i[0],i[1],i[2],r,n,o,a)}}this.endVertices()}#s(){const t=new vd;if(this.positionStyle=="CUBE")t.position=f.VEC3_SPREAD(this.positionBase,this.positionSpread);else if(this.positionStyle=="SPHERE"){const e=f.SPREAD(this.positionSphereRadiusBase,this.positionRadiusSpread),s=Math.PI*2*Math.random(),i=Math.PI*2*Math.random(),r=e*Math.cos(s);t.position=f.VEC3_ADD(this.positionBase,[r*Math.cos(i),e*Math.sin(s),r*Math.sin(i)])}if(this.velocityStyle=="CLASSIC")t.velocity=f.VEC3_SPREAD(this.velocityBase,this.velocitySpread);else if(this.velocityStyle=="EXPLODE"){const e=f.VEC3_SUBSTRACT(t.position,this.positionBase),s=f.SPREAD(this.velocityExplodeSpeedBase,this.velocityExplodeSpeedSpread);t.velocity=f.VEC3_SCALE(f.VEC3_NORMALIZE(e),s)}return t.color=f.VEC3_SPREAD(this.colorBase,this.colorSpread),t.colorTween=this.colorTween,t.size=f.SPREAD(this.sizeBase,this.sizeSpread),t.sizeTween=this.sizeTween,t.opacity=f.SPREAD(this.opacityBase,this.opacitySpread),t.opacityTween=this.opacityTween,t.acceleration=f.VEC3_SPREAD(this.accelerationBase,this.accelerationSpread),t.accelerationTween=this.accelerationTween,t.angle=f.SPREAD(this.angleBase,this.angleSpread),t.angleVelocity=f.SPREAD(this.angleVelocityBase,this.angleVelocitySpread),t.angleAcceleration=f.SPREAD(this.angleAccelerationBase,this.angleAccelerationSpread),t.age=0,t.alive=0,t}}const Bp={texture:await st.loadTexture("./textures/particles/star.png"),positionStyle:fe.CUBE,positionBase:[0,5,0],positionSpread:[10,0,10],velocityStyle:pe.CLASSIC,velocityBase:[0,160,0],velocitySpread:[100,20,100],colorTween:new St([.5,2],[[0,1,.5],[.8,1,.5]]),sizeTween:new St([0,1],[1,20]),opacityTween:new St([2,3],[1,0]),accelerationBase:[0,-100,0],angleBase:0,angleSpread:180,angleVelocityBase:0,angleVelocitySpread:360*4,particlesPerSecond:200,particleDeathAge:3,emitterDeathAge:60},Vp={texture:await st.loadTexture("./textures/particles/smoke.png"),positionStyle:fe.SPHERE,positionBase:[0,50,0],positionSphereRadiusBase:2,velocityStyle:pe.EXPLODE,velocityExplodeSpeedBase:40,velocityExplodeSpeedSpread:8,colorBase:[.02,1,.4],sizeTween:new St([0,.1],[1,150]),opacityTween:new St([.7,1],[1,0]),particlesPerSecond:60,particleDeathAge:1.5,emitterDeathAge:60},Hp={texture:await st.loadTexture("./textures/particles/smoke.png"),positionStyle:fe.CUBE,positionBase:[0,0,0],positionSpread:[10,0,10],velocityStyle:pe.CLASSIC,velocityBase:[0,150,0],velocitySpread:[80,50,80],colorTween:new St([.4,1],[[0,0,.2],[0,0,.5]]),sizeTween:new St([0,1],[32,128]),opacityTween:new St([.8,2],[.5,0]),accelerationBase:[0,-10,0],angleBase:0,angleSpread:720,angleVelocityBase:0,angleVelocitySpread:720,particlesPerSecond:200,particleDeathAge:2,emitterDeathAge:60},jp={texture:await st.loadTexture("./textures/particles/smoke.png"),positionStyle:fe.CUBE,positionBase:[-100,100,0],positionSpread:[0,50,60],velocityStyle:pe.CLASSIC,velocityBase:[40,0,0],velocitySpread:[20,0,0],colorBase:[0,0,1],sizeBase:80,sizeSpread:100,opacityTween:new St([0,1,4,5],[0,1,1,0]),particlesPerSecond:50,particleDeathAge:10,emitterDeathAge:60},kp={texture:await st.loadTexture("./textures/particles/snowflake.png"),positionStyle:fe.CUBE,positionBase:[0,200,0],positionSpread:[500,0,500],velocityStyle:pe.CLASSIC,velocityBase:[0,-60,0],velocitySpread:[50,20,50],colorBase:[.66,1,.9],sizeTween:new St([0,.25],[1,10]),opacityTween:new St([2,3],[.8,0]),accelerationBase:[0,-10,0],angleBase:0,angleSpread:720,angleVelocityBase:0,angleVelocitySpread:60,particlesPerSecond:200,particleDeathAge:4,emitterDeathAge:60},Wp={texture:await st.loadTexture("./textures/particles/raindrop2flip.png"),positionStyle:fe.CUBE,positionBase:[0,200,0],positionSpread:[600,0,600],velocityStyle:pe.CLASSIC,velocityBase:[0,-400,0],velocitySpread:[10,50,10],colorBase:[.66,1,.7],colorSpread:[0,0,.2],sizeBase:8,sizeSpread:4,opacityBase:.6,accelerationBase:[0,-10,0],particlesPerSecond:1e3,particleDeathAge:1,emitterDeathAge:60},Gp={texture:await st.loadTexture("./textures/particles/spikey.png"),positionStyle:fe.CUBE,positionBase:[0,200,0],positionSpread:[600,400,600],velocityStyle:pe.CLASSIC,velocityBase:[0,0,0],velocitySpread:[.5,.5,.5],colorBase:[.15,1,.9],colorSpread:[0,0,.2],sizeBase:10,sizeSpread:2,opacityBase:1,angleBase:0,angleSpread:720,angleVelocityBase:0,angleVelocitySpread:4,particlesPerSecond:2e4,particleDeathAge:60,emitterDeathAge:.1},zp={texture:await st.loadTexture("./textures/particles/spark.png"),positionStyle:fe.CUBE,positionBase:[0,100,0],positionSpread:[400,200,400],velocityStyle:pe.CLASSIC,velocityBase:[0,0,0],velocitySpread:[60,20,60],colorBase:[.3,1,.6],colorSpread:[.3,0,0],sizeBase:30,sizeSpread:2,opacityTween:new St([0,1,1.1,2,2.1,3,3.1,4,4.1,5,5.1,6,6.1],[.2,.2,1,1,.2,.2,1,1,.2,.2,1,1,.2]),particlesPerSecond:20,particleDeathAge:6.1,emitterDeathAge:600},qp={texture:await st.loadTexture("./textures/particles/spikey.png"),positionStyle:fe.CUBE,positionBase:[0,0,0],positionSpread:[10,10,10],velocityStyle:pe.CLASSIC,velocityBase:[0,100,200],velocitySpread:[40,40,80],colorBase:[.15,1,.8],sizeBase:4,sizeSpread:2,opacityBase:1,angleBase:0,angleSpread:720,angleVelocityBase:10,angleVelocitySpread:0,particlesPerSecond:500,particleDeathAge:4,emitterDeathAge:60},Sd={texture:await st.loadTexture("./textures/particles/spark.png"),positionStyle:fe.SPHERE,positionBase:[0,100,0],positionSphereRadiusBase:2,velocityStyle:pe.EXPLODE,velocityExplodeSpeedBase:10,velocityExplodeSpeedSpread:10,colorTween:new St([.4,.8,1],[[0,1,1],[0,1,.6],[.8,1,.6]]),sizeTween:new St([.5,.7,1.3],[2,3,1]),opacityTween:new St([.2,.7,2.5],[.75,1,0]),accelerationBase:[0,-80,0],particlesPerSecond:3e3,particleDeathAge:2.5,emitterDeathAge:600},_d={texture:await st.loadTexture("./textures/particles/smoke.png"),positionStyle:fe.SPHERE,positionBase:[0,5,0],positionSphereRadiusBase:1,velocityStyle:pe.CLASSIC,velocityBase:[0,30,0],velocitySpread:[20,0,20],colorTween:new St([.5,1],[[1,0,0],[0,1,0]]),sizeTween:new St([0,.3,1.2],[2,6,2]),opacityTween:new St([.9,1.5],[1,0]),particleDeathAge:1.5,emitterDeathAge:600};class bd extends yt{constructor(){super(),this.camera=new Xe(0),this.skySphere=null,this.floor=null,this.particles0=null,this.particles1=null,this.colFac=0}async onEnter(){this.camera.setPosition(0,40,0),this.camera.setRotation(.15,0,0),this.skySphere=await Md(),this.floor=await Pd(0,0,-100),this.particles0=await In(_d),this.particles1=await In(Sd)}update(t){this.floor.rotate(0,t*.001,0),this.floor.update(t),this.skySphere.update(t),this.particles0.update(t),this.particles1.update(t),this.colFac+=t*.003}draw(){this.skySphere.draw(),this.floor.draw(),this.particles0.draw(),this.particles1.draw(),Ot.setAmbientColor([.5,.5,.5]),Ot.drawDirLight([0,-1,.2],[.8,.8,.8],[.8,.8,.8]),Ot.drawPointLight([Math.cos(this.colFac*.2)*45,18,Math.cos(this.colFac*.2)*45],[.8,.8,.4],[.8,.8,.4]),Ot.drawPointLight([Math.sin(this.colFac*.2)*45,18,Math.sin(this.colFac*.2)*45],[.8,.8,.4],[.8,.8,.4])}}async function Md(){const h=new ft;return await h.loadFromFile("./utils/particles/sky_sphere.jsm"),h.setMaterial(new vt({texture:await st.loadTexture("./utils/particles/sky_sphere.jpg")})),h}async function Pd(h,t,e){const s=new ft;return s.setPosition(h,t,e),await s.loadFromFile("./utils/particles/floor.jsm"),s.setMaterial(new vt({lightning:!0,texture:await st.loadTexture("./utils/particles/floor.jpg"),normalMap:await st.loadTexture("./utils/particles/floor_normal_map.jpg"),specularityMap:await st.loadTexture("./utils/particles/floor_specularity_map.jpg")})),s}async function In(h){return new Id(Object.assign(h,{positionBase:[0,10,-100],particleQuantity:100}))}class Vo extends Xe{movementSpeed;rotationSpeed;frictionCoefficient;velocity;maxPitch;minPitch;constructor(t){super(t),this.movementSpeed=10,this.rotationSpeed=2,this.frictionCoefficient=.99,this.velocity=[0,0,0],this.maxPitch=Math.PI*.5-.01,this.minPitch=Math.PI*-.5+.01,v.subscribe(Q,"E_MOUSE_DRAG",this,this.#t)}delete(){v.unsubscribe(Q,"E_MOUSE_DRAG",this)}update(t){const e=this.getAxies();let s=[0,0,0];Q.isActiveAction("LEFT")&&(s=f.VEC3_ADD_SCALED(s,e[0],-this.movementSpeed)),Q.isActiveAction("RIGHT")&&(s=f.VEC3_ADD_SCALED(s,e[0],+this.movementSpeed)),Q.isActiveAction("UP")&&(s=f.VEC3_ADD_SCALED(s,e[2],-this.movementSpeed)),Q.isActiveAction("DOWN")&&(s=f.VEC3_ADD_SCALED(s,e[2],+this.movementSpeed)),this.velocity=f.VEC3_LERP(s,this.velocity,Math.pow(1-this.frictionCoefficient,t/1e3));const i=f.VEC3_SCALE(this.velocity,t/1e3);this.translate(i[0],i[1],i[2])}setMovementSpeed(t){this.movementSpeed=t}setRotationSpeed(t){this.rotationSpeed=t}setFrictionCoefficient(t){this.frictionCoefficient=t}setMaxPitch(t){this.maxPitch=t}setMinPitch(t){this.minPitch=t}getMovementSpeed(){return this.movementSpeed}getRotationSpeed(){return this.rotationSpeed}getFrictionCoefficient(){return this.frictionCoefficient}getMaxPitch(){return this.maxPitch}getMinPitch(){return this.minPitch}#t(t){let e=this.rotation[0]+t.movementY/1e3*this.rotationSpeed,s=this.rotation[1]+t.movementX/1e3*this.rotationSpeed;s=s%(Math.PI*2),e=f.CLAMP(e,this.minPitch,this.maxPitch),this.setRotation(e,s,0)}}const Bi=100,Rd=100,Sn=5;class Od{constructor(t=[0,0,0],e=[0,0,0],s=[0,0,0]){this.p=t,this.a=e,this.s=s,this.q=new ht,this.m=f.MAT4_IDENTITY()}}class Dd extends yt{constructor(){super(),this.camera=new Vo(0),this.mode=1,this.colFac=0,this.obj=null,this.bigMesh=null,this.skySphere=null,this.transformations=[],this.handleKeyUpCb=this.handleKeyUp.bind(this)}async onEnter(){const t=k.getView(0);t.setPerspectiveFar(700),t.setPerspectiveNear(.1),this.camera.setPosition(0,10,0),this.skySphere=new ft,await this.skySphere.loadFromFile("./utils/perf/sky_sphere.jsm"),this.skySphere.setMaterial(new vt({texture:await st.loadTexture("./utils/perf/sky_sphere.jpg")})),this.obj=new ft,await this.obj.loadFromFile("./utils/perf/cube.jsm"),this.obj.setMaterial(new vt({texture:await st.loadTexture("./utils/perf/cube.png"),lightning:!0}));for(let s=0;s<Rd;s++)for(let i=0;i<Bi;i++){const r=(i-Bi/2)*Sn,n=(s-Bi/2)*Sn,o=[r,0,n,1],a=[i,0,s],l=[1,1,1];this.transformations.push(new Od(o,a,l))}const e=this.transformations.map(s=>f.MAT4_TRANSFORM(s.p,s.a,s.s,s.q));this.bigMesh=Ld(this.obj,e),document.addEventListener("keyup",this.handleKeyUpCb)}onExit(){document.removeEventListener("keyup",this.handleKeyUpCb)}update(t){const e=(Math.sin(this.colFac)+1)*.5,s=(Math.cos(this.colFac)+1)*.5;this.obj.mat.setSpecular(e,s,0),this.obj.mat.setDiffuse(0,e,s);const i=Math.PI*2*4/this.transformations.length;let r=0;for(const n of this.transformations)n.a[0]+=t/500,n.a[2]+=t/1e3,n.p[1]=Math.sin(r+this.colFac)*3,f.MAT4_TRANSFORM(n.p,n.a,n.s,n.q,n.m),r+=i;this.colFac+=t*.003,this.camera.update(t)}draw(){if(Ot.setAmbientColor([.5,.5,.5]),Ot.drawDirLight([0,-1,.2],[.8,.6,.4],[.8,.6,.4]),this.skySphere.draw(),this.mode==0)this.bigMesh.draw();else for(const t of this.transformations)Ot.drawMesh(this.obj,t.m)}handleKeyUp(t){t.code==="KeyR"&&(this.mode=this.mode==1?0:1)}}function Ld(h,t){const e=new re,s=h.getVertices();e.beginVertices(h.getVertexCount()*t.length);for(const i of t)for(let r=0;r<s.length;r+=Et){const n=f.MAT4_MULTIPLY_BY_VEC4(i,f.VEC4_CREATE(s[r+0],s[r+1],s[r+2],1));e.defineVertex(n[0],n[1],n[2],s[r+3],s[r+4],s[r+5],s[r+6],s[r+7],s[r+8],s[r+9],s[r+10],s[r+11],s[r+12],s[r+13],s[r+14],s[r+15],s[r+16])}return e.endVertices(),e.setMaterial(h.getMaterial()),e}const Nd="modulepreload",Fd=function(h){return"/"+h},_n={},Ud=function(t,e,s){if(!e||e.length===0)return t();const i=document.getElementsByTagName("link");return Promise.all(e.map(r=>{if(r=Fd(r,s),r in _n)return;_n[r]=!0;const n=r.endsWith(".css"),o=n?'[rel="stylesheet"]':"";if(!!s)for(let c=i.length-1;c>=0;c--){const u=i[c];if(u.href===r&&(!n||u.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${r}"]${o}`))return;const l=document.createElement("link");if(l.rel=n?"stylesheet":Nd,n||(l.as="script",l.crossOrigin=""),l.href=r,document.head.appendChild(l),n)return new Promise((c,u)=>{l.addEventListener("load",c),l.addEventListener("error",()=>u(new Error(`Unable to preload CSS for ${r}`)))})})).then(()=>t()).catch(r=>{const n=new Event("vite:preloadError",{cancelable:!0});if(n.payload=r,window.dispatchEvent(n),!n.defaultPrevented)throw r})},Be=await Ud(()=>import("./rapier-c8351f47.js"),[]);class Qe extends dt{x;y;z;speed;velocity;rotation;constructor(){super("Entity"),this.x=0,this.y=0,this.z=0,this.speed=25,this.velocity=[0,0,0],this.rotation=0}}var er=(h=>(h[h.TRIMESH=0]="TRIMESH",h[h.BALL=1]="BALL",h[h.CAPSULE=2]="CAPSULE",h))(er||{}),sr=(h=>(h[h.STATIC=0]="STATIC",h[h.DYNAMIC=1]="DYNAMIC",h[h.KINEMATIC=2]="KINEMATIC",h))(sr||{});class Vs extends dt{shapeType;bodyType;rayDown;currentHit;body;collider;grounded;radius;capsuleHalfHeight;trimeshJSM;kinematicElevationGap;kinematicGravityCb;constructor(){super("Physics"),this.shapeType=0,this.bodyType=0,this.rayDown=new Be.Ray({x:0,y:0,z:0},{x:0,y:-1,z:0}),this.currentHit=null,this.body={},this.collider={},this.grounded=!1,this.radius=1,this.capsuleHalfHeight=1,this.trimeshJSM=new re,this.kinematicElevationGap=.4,this.kinematicGravityCb=t=>9.807*(t/1e3)/20}}class Bd extends mt{world;constructor(t=-9.81){super(),super.addRequiredComponentTypename("Physics"),super.addRequiredComponentTypename("Entity"),this.world=new Be.World({x:0,y:t,z:0})}onEntityBind(t){const e=x.getComponent(t,Vs),s=x.getComponent(t,Qe);if(e.bodyType==0){const i=Be.RigidBodyDesc.fixed();i.setTranslation(s.x,s.y,s.z),e.body=this.world.createRigidBody(i)}else if(e.bodyType==1){const i=Be.RigidBodyDesc.dynamic();i.setTranslation(s.x,s.y,s.z),e.body=this.world.createRigidBody(i)}else if(e.bodyType==2){const i=Be.RigidBodyDesc.kinematicPositionBased();i.setTranslation(s.x,s.y,s.z),e.body=this.world.createRigidBody(i)}else throw new Error("PhysicsSystem::onEntityBind(): body type unknown !");if(e.shapeType==1){const i=Be.ColliderDesc.ball(e.radius);e.collider=this.world.createCollider(i,e.body??void 0)}else if(e.shapeType==2){const i=Be.ColliderDesc.capsule(e.capsuleHalfHeight,e.radius);e.collider=this.world.createCollider(i,e.body??void 0)}else if(e.shapeType==0){const i=e.trimeshJSM.getGeo(),r=Be.ColliderDesc.trimesh(new Float32Array(i.coords),new Uint32Array(i.indexes));e.collider=this.world.createCollider(r,e.body??void 0)}}onBeforeUpdate(t){this.world.step()}onEntityUpdate(t,e){const s=x.getComponent(e,Vs),i=x.getComponent(e,Qe),r=s.body.translation();if(i.x=r.x,i.y=r.y,i.z=r.z,s.rayDown.origin.x=r.x,s.rayDown.origin.y=r.y,s.rayDown.origin.z=r.z,s.currentHit=this.world.castRay(s.rayDown,20,!1,2),s.bodyType==1){const n=s.body.linvel().y;s.body.setLinvel({x:i.velocity[0],y:n,z:i.velocity[2]},!0)}else if(s.bodyType==2){const n=this.world.createCharacterController(.1);n.setApplyImpulsesToDynamicBodies(!0),n.enableSnapToGround(.2),n.setCharacterMass(.2),n.setSlideEnabled(!0),n.computeColliderMovement(s.collider,{x:i.velocity[0],y:i.velocity[1],z:i.velocity[2]});let o=0;if(s.shapeType==1?o=s.radius:s.shapeType==2&&(o=s.capsuleHalfHeight*3),s.currentHit){const l=s.rayDown.pointAt(s.currentHit.timeOfImpact),c=r.y-l.y,u=o+s.kinematicElevationGap;c<u?(r.y=l.y+u,i.velocity[1]=0,s.grounded=!0):c>u+.1&&(i.velocity[1]-=s.kinematicGravityCb(t),s.grounded=!1)}else i.velocity[1]-=s.kinematicGravityCb(t),s.grounded=!1;const a=n.computedMovement();s.body.setNextKinematicTranslation({x:r.x+a.x,y:r.y+a.y,z:r.z+a.z})}}onAfterDraw(){let t=0;const{vertices:e}=this.world.debugRender(),s=[];for(let i=0;i<e.length/3;i++)s.push(e[i*3+0],e[i*3+1],e[i*3+2],0,1,0),t++;Jt.drawVertices(s,t)}}class Ei extends dt{jsm;constructor(){super("Graphics"),this.jsm=new ft}}class Vd extends mt{constructor(){super(),super.addRequiredComponentTypename("Graphics"),super.addRequiredComponentTypename("Entity")}onEntityUpdate(t,e){const s=x.getComponent(e,Ei),i=x.getComponent(e,Qe),r=f.LERP(s.jsm.getRotationY(),i.rotation,t/1e3*10);s.jsm.setRotation(0,r,0),s.jsm.setPosition(i.x,i.y,i.z),s.jsm.update(t)}onEntityDraw(t){x.getComponent(t,Ei).jsm.draw()}}class Hd extends dt{constructor(){super("Input")}}class jd extends mt{constructor(){super(),super.addRequiredComponentTypename("Input"),super.addRequiredComponentTypename("Physics"),super.addRequiredComponentTypename("Entity")}onEntityUpdate(t,e){const s=x.getComponent(e,Qe);if(!x.getComponent(e,Vs).body)return;let r=t/1e3,n=0,o=0;Q.isActiveAction("LEFT")&&(n=-6),Q.isActiveAction("RIGHT")&&(n=6),Q.isActiveAction("UP")&&(o=1),Q.isActiveAction("DOWN")&&(o=-1),o!=0?(s.rotation+=n*r,s.velocity[0]=Math.cos(s.rotation)*s.speed*o*r,s.velocity[2]=Math.sin(s.rotation)*s.speed*o*r):(s.velocity[0]=0,s.velocity[2]=0)}}class kd extends yt{camera;floorEid;shipEid;wallEid;constructor(){super(),this.camera=new yr(0),this.floorEid=0,this.shipEid=0,this.wallEid=0}async onEnter(){x.setup([new jd,new Bd,new Vd]),this.floorEid=await this.#t("./utils/rapier/floor.jsm","./utils/rapier/floor.png"),this.floorEid=await this.#t("./utils/rapier/slope.jsm","./utils/rapier/floor.png"),this.shipEid=await this.#e(),this.wallEid=await this.#t("./utils/rapier/wall.jsm","./utils/rapier/wall.jpg")}update(t){const e=x.getComponent(this.shipEid,Qe);this.camera.setTarget([e.x,e.y,e.z]),this.camera.update(t),x.update(t)}draw(){x.draw()}async#t(t,e){const s=x.createEntity(),i=new Qe;x.addComponent(s,i);const r=new Ei;await r.jsm.loadFromFile(t),r.jsm.setMaterial(new vt({texture:await st.loadTexture(e)})),x.addComponent(s,r);const n=new Vs;return n.bodyType=sr.STATIC,n.shapeType=er.TRIMESH,n.trimeshJSM=r.jsm,x.addComponent(s,n),s}async#e(){const t=x.createEntity(),e=new Qe;e.y=3,e.z=10,x.addComponent(t,e);const s=new Ei;await s.jsm.loadFromFile("./utils/rapier/ship.jsm"),s.jsm.setMaterial(new vt({texture:await st.loadTexture("./utils/rapier/ship.png")})),x.addComponent(t,s);const i=new Vs;i.bodyType=sr.KINEMATIC,i.shapeType=er.CAPSULE,i.radius=2,x.addComponent(t,i);const r=new Hd;return x.addComponent(t,r),t}}class Wd extends yt{constructor(){super(),this.camera=new Xe(0),this.skySphere=new ft,this.floor=new ft,this.cube=new ft}async onEnter(){Ps.setShadowProjection([-20,20,0],[0,0,0],600,600),Ot.enableShadow(!0),this.camera.setPosition(0,40,0),this.camera.setRotation(.15,0,0),this.skySphere=await zd(),this.floor=await Gd(0,0,-100),this.cube=await qd(0,7,-100)}update(t){this.skySphere.update(t),this.floor.update(t),this.cube.update(t);const e=Date.now()/1e4;this.cube.setRotation(Math.sin(e),Math.cos(e),0)}draw(){Ot.setAmbientColor([.5,.5,.5]),Ot.drawDirLight([100,-100,0],[1,1,1],[0,0,0]),this.skySphere.draw(),this.floor.draw(),this.cube.draw()}}async function Gd(h,t,e){const s=new ft;return s.setPosition(h,t,e),await s.loadFromFile("./utils/shadow/floor.jsm"),s.setMaterial(new vt({lightning:!0,texture:await st.loadTexture("./utils/shadow/floor.jpg"),shadowEnabled:!0})),s}async function zd(){const h=new ft;return await h.loadFromFile("./utils/shadow/sky_sphere.jsm"),h.setMaterial(new vt({texture:await st.loadTexture("./utils/shadow/sky_sphere.jpg")})),h}async function qd(h,t,e){const s=new ft;return s.setPosition(h,t,e),s.setScale(10,10,10),s.setShadowCasting(!0),await s.loadFromFile("./utils/viewer/duck.jsm"),s.setMaterial(new vt({texture:await st.loadTexture("./utils/viewer/duck.png"),lightning:!0})),s}class Xd extends yt{constructor(){super(),this.uiTitle=new ae,this.uiMenu1=new Yt,this.uiMenu2=new Yt}async onEnter(){this.uiTitle.setText("Menu"),P.addWidget(this.uiTitle,"position:absolute; top:0; left:0; right:0; height:50px"),this.uiMenu1.add("1","Menu 1 Text 1"),this.uiMenu1.add("2","Menu 1 Text 2"),this.uiMenu1.add("3","Menu 1 Text 3"),P.addWidget(this.uiMenu1,"position:absolute; top:50px; left:0; bottom:0; width:40%"),this.uiMenu2.add("1","Menu 2 Text 1"),this.uiMenu2.add("2","Menu 2 Text 2"),this.uiMenu2.add("3","Menu 2 Test 3"),P.addWidget(this.uiMenu2,"position:absolute; top:50px; left:40%; bottom:0; width:60%"),v.subscribe(this.uiMenu1,"E_ITEM_SELECTED",this,this.handleMenu1ItemSelected),v.subscribe(this.uiMenu2,"E_CLOSED",this,this.handleMenu2Closed),v.subscribe(this.uiMenu2,"E_ITEM_SELECTED",this,this.handleMenu2ItemSelected),P.focus(this.uiMenu1)}onExit(){P.removeWidget(this.uiTitle),P.removeWidget(this.uiMenu1),P.removeWidget(this.uiMenu2)}handleMenu1ItemSelected(t){P.focus(this.uiMenu2)}handleMenu2Closed(){this.uiMenu1.unselectWidgets(),P.focus(this.uiMenu1)}handleMenu2ItemSelected(t){this.uiTitle.setText("You have selected menu item at index : "+t.index),this.uiMenu1.unselectWidgets(),this.uiMenu2.unselectWidgets(),P.focus(this.uiMenu1)}}class Ho extends qe{cubemapChanged;grp1;cubemap;constructor(){super(Fn),this.cubemapChanged=!1,this.grp1=k.createStaticGroup("SKYBOX_PIPELINE",1),this.cubemap=this.grp1.setTexture(0,"CUBEMAP_TEXTURE",k.createCubeMapFromBitmap(),{dimension:"cube"}),this.cubemap=this.grp1.setSampler(1,"CUBEMAP_SAMPLER",this.cubemap),this.beginVertices(6),this.defineVertex(-1,-1,-1,-1,-1,-1),this.defineVertex(1,-1,-1,-1,-1,1),this.defineVertex(-1,1,-1,1,-1,1),this.defineVertex(-1,1,-1,-1,-1,-1),this.defineVertex(1,-1,-1,1,-1,1),this.defineVertex(1,1,-1,1,-1,-1),this.endVertices(),this.grp1.allocate()}delete(){this.grp1.delete(),super.delete()}draw(){Un.draw(this)}setCubemap(t){this.cubemap=t,this.cubemapChanged=!0}getCubemap(){return this.cubemap}getGroup01(){return this.cubemapChanged&&(this.grp1.setTexture(0,"CUBEMAP_TEXTURE",this.cubemap,{dimension:"cube"}),this.grp1.allocate(),this.cubemapChanged=!1),this.grp1}}class Yd extends qe{textureChanged;size2D;position2D;scale2D;rotation2D;offset2D;color;grp2;texture;constructor(){super(Bn),this.textureChanged=!1,this.size2D=[0,0],this.position2D=[0,0],this.scale2D=[1,1],this.rotation2D=0,this.offset2D=[0,0],this.color=[1,1,1,1],this.grp2=k.createStaticGroup("FLARE_PIPELINE",2),this.texture=this.grp2.setTexture(0,"TEXTURE",k.createTextureFromBitmap()),this.texture=this.grp2.setSampler(1,"SAMPLER",this.texture),this.beginVertices(6),this.defineVertex(0,0,0,0),this.defineVertex(1,0,1,0),this.defineVertex(0,1,0,1),this.defineVertex(0,1,0,1),this.defineVertex(1,0,1,0),this.defineVertex(1,1,1,1),this.endVertices(),this.grp2.allocate()}delete(){this.grp2.delete(),super.delete()}draw(){Vn.drawFlare(this)}setPosition2D(t,e){this.position2D[0]=t,this.position2D[1]=e}getPosition2D(){return this.position2D}setScale2D(t,e){this.scale2D[0]=t,this.scale2D[1]=e}getScale2D(){return this.scale2D}setRotation2D(t){this.rotation2D=t}getRotation2D(){return this.rotation2D}setOffset2D(t,e){this.offset2D[0]=-t,this.offset2D[1]=-e}setOffset2DNormalized(t,e){this.offset2D[0]=-t*this.size2D[0],this.offset2D[1]=-e*this.size2D[1]}getOffset2D(){return this.offset2D}setColor(t,e,s,i){this.color[0]=t,this.color[1]=e,this.color[2]=s,this.color[3]=i}getColor(){return this.color}setTexture(t){this.texture=t,this.size2D[0]=t.gpuTexture.width,this.size2D[1]=t.gpuTexture.height,this.textureChanged=!0}getTexture(){return this.texture}getSize2D(){return this.size2D}setSize2D(t,e){this.size2D[0]=t,this.size2D[1]=e}getGroup02(){return this.textureChanged&&(this.grp2.setTexture(0,"TEXTURE",this.texture),this.grp2.allocate(),this.textureChanged=!1),this.grp2}}class Zd{spacing;flares;items;sunWorldPos;scaleStepFactor;maxDistanceBrightness;constructor(){this.spacing=.4,this.flares=[],this.items=[],this.sunWorldPos=[0,0,0],this.scaleStepFactor=.1,this.maxDistanceBrightness=600}async startup(t){const e=await st.loadTexture("./textures/lens_flares/tex2.png"),s=await st.loadTexture("./textures/lens_flares/tex3.png"),i=await st.loadTexture("./textures/lens_flares/tex4.png"),r=await st.loadTexture("./textures/lens_flares/tex5.png"),n=await st.loadTexture("./textures/lens_flares/tex6.png"),o=await st.loadTexture("./textures/lens_flares/tex7.png"),a=await st.loadTexture("./textures/lens_flares/tex8.png");this.items=[{texture:n,scale:.5},{texture:i,scale:.2},{texture:e,scale:.1},{texture:o,scale:.05},{texture:s,scale:.06},{texture:r,scale:.07},{texture:o,scale:.2},{texture:s,scale:.07},{texture:r,scale:.3},{texture:i,scale:.4},{texture:a,scale:.6}],this.spacing=t,this.flares=[];for(const l of this.items){const c=new Yd;c.setTexture(l.texture),c.setOffset2DNormalized(.5,.5),c.setScale2D(l.scale,l.scale),this.flares.push(c)}}draw(){const t=k.getCurrentView(),e=t.getViewportSize(),s=t.getScreenPosition(this.sunWorldPos[0],this.sunWorldPos[1],this.sunWorldPos[2]);if(s[0]<0||s[0]>e[0]||s[1]<0||s[1]>e[1])return;const i=e[0]/2,r=e[1]/2,n=f.VEC2_SUBSTRACT([i,r],s),o=1-f.VEC2_LENGTH(n)/this.maxDistanceBrightness;if(!(o<=0))for(let a=0;a<this.flares.length;a++){const l=f.VEC2_COPY(n),c=f.VEC2_SCALE(l,a*this.spacing),u=f.VEC2_ADD(s,c),p=this.items[a].scale+a*this.scaleStepFactor;this.flares[a].setScale2D(p,p),this.flares[a].setPosition2D(u[0],u[1]),this.flares[a].setColor(1,1,1,o),this.flares[a].draw()}}setSunWorldPosition(t,e,s){this.sunWorldPos=[t,e,s]}setScaleStepFactor(t){this.scaleStepFactor=t}setMaxDistanceBrightness(t){this.maxDistanceBrightness=t}}class Kd extends yt{constructor(){super(),this.camera=new yr(0),this.skybox=new Ho,this.mesh=new ft,this.shadow=new oi,this.lens=new Zd,this.handleKeyDownCb=this.handleKeyDown.bind(this)}async onEnter(){this.camera.setPosition(0,0,10),this.skybox=await $d(),this.mesh=await bn(),this.shadow=new oi,await this.shadow.loadFromFile("./utils/viewer/shadow.jsv"),this.lens.setSunWorldPosition(10,10,0),await this.lens.startup(.4),os.setParam(Ss.COLOR_ENABLED,1),os.setParam(Ss.PIXELATION_ENABLED,1),os.setParam(Ss.DITHER_ENABLED,1),os.setParam(Ss.OUTLINE_ENABLED,1),P.addNode(ip(),"position:absolute; bottom:10px; right:10px"),document.addEventListener("keydown",this.handleKeyDownCb)}onExit(){document.removeEventListener("keydown",this.handleKeyDownCb)}update(t){const e=Date.now()/1e4;this.mesh.setRotation(Math.sin(e),Math.cos(e),0),this.mesh.update(t),this.camera.update(t)}draw(){this.shadow.draw(),this.mesh.draw(),this.skybox.draw(),this.lens.draw(),Ot.setAmbientColor([.5,.5,.5]),Ot.drawPointLight([0,30,0],[1,0,0],[0,0,0]),Ot.drawPointLight([30,0,0],[0,1,0],[0,0,0]),Ot.drawPointLight([-30,0,0],[0,0,1],[0,0,0]),Jt.drawGrid(f.MAT4_ROTATE_X(Math.PI*.5),20,1)}async handleKeyDown(t){t.repeat||(t.key=="1"?this.mesh=await Jd():t.key=="2"?this.mesh=await Qd():t.key=="3"?this.mesh=await bn():t.key=="4"?this.mesh=await tp():t.key=="5"?this.mesh=await ep():t.key=="6"?this.mesh=await sp():t.key=="f"||t.key=="F"?k.hasFilter()?k.setFilter(""):k.setFilter("grayscale(100%)"):t.key=="q"||t.key=="Q"?Cs.toggleClass("scanlines"):t.key=="p"||t.key=="P"?this.mesh.setSingleId(3,7):t.key=="l"||t.key=="L"?this.mesh.setSingleId(3,8):t.key=="s"||t.key=="S"?this.mesh.setSingleId(3,16):(t.key=="n"||t.key=="N")&&this.mesh.setSingleId(3,0))}}async function $d(){const h=new Ho;return h.setCubemap(await st.loadCubemapTexture("./utils/viewer/sky_","png")),h}async function Jd(){const h=new Hs;return await h.loadFromFile("./utils/viewer/wavefront.obj","./utils/viewer/wavefront.mtl"),h.getMesh("letter-f")}async function Qd(){const h=new ft;return await h.loadFromFile("./utils/viewer/cube_brick.jsm"),h.setMaterial(new vt({texture:await st.loadTexture("./utils/viewer/cube_brick.png"),normalMap:await st.loadTexture("./utils/viewer/cube_brick_normal.png"),normalIntensity:5,lightning:!0})),h}async function bn(){const h=new ft;return await h.loadFromFile("./utils/viewer/cube.jsm"),h.setMaterial(new vt({texture:await st.loadTexture("./utils/viewer/cube.png"),lightning:!0})),h}async function tp(){const h=new ft;return await h.loadFromFile("./utils/viewer/cube_sprite.jsm"),h.setMaterial(new vt({texture:await st.loadTexture("./utils/viewer/cube_sprite.png"),lightning:!1,animations:[{name:"Default",frames:[{offsetX:0,offsetY:0},{offsetX:850,offsetY:0},{offsetX:1700,offsetY:0}],frameDuration:100}]})),h.mat.playAnimation("Default",!0),h}async function ep(){const h=new ft;return await h.loadFromFile("./utils/viewer/duck.jsm"),h.setMaterial(new vt({texture:await st.loadTexture("./utils/viewer/duck.png"),lightning:!0})),h}async function sp(){const h=new ft;return await h.loadFromFile("./utils/viewer/torus.jsm"),h.setMaterial(new vt({toonMap:await st.loadTexture("./textures/toon_default.png",{minFilter:"nearest",magFilter:"nearest"}),toonLightDir:[1,-1,-1]})),h}function ip(){const h=document.createElement("div");h.style.backgroundColor="rgba(0, 0, 0, 0.2)",h.style.padding="10px",h.style.backdropFilter="blur(3px)";const t=document.createElement("ul");t.style.listStyle="none",t.style.paddingLeft="0px",h.appendChild(t);{const e=document.createElement("li");e.textContent="[1] => Load Obj Wavefront",t.appendChild(e)}{const e=document.createElement("li");e.textContent="[2] => Load Cube Normal Map",t.appendChild(e)}{const e=document.createElement("li");e.textContent="[3] => Load Cube",t.appendChild(e)}{const e=document.createElement("li");e.textContent="[4] => Load Cube Texture Sprite",t.appendChild(e)}{const e=document.createElement("li");e.textContent="[5] => Load Duck",t.appendChild(e)}{const e=document.createElement("li");e.textContent="[6] => Load Toon Torus",t.appendChild(e)}{const e=document.createElement("li");e.textContent="----------------------------------------",t.appendChild(e)}{const e=document.createElement("li");e.textContent="[f] => Toggle Filtering (greyscale)",t.appendChild(e)}{const e=document.createElement("li");e.textContent="[q] => Toggle Scanlines",t.appendChild(e)}{const e=document.createElement("li");e.textContent="[p] => PSX mode",t.appendChild(e)}{const e=document.createElement("li");e.textContent="[l] => Outline mode",t.appendChild(e)}{const e=document.createElement("li");e.textContent="[s] => Shadow volume mode",t.appendChild(e)}{const e=document.createElement("li");e.textContent="[n] => Default mode",t.appendChild(e)}return h}class rp extends yt{camera;pack;constructor(){super(),this.camera=new Vo(0),this.pack=new Xn}async onEnter(){this.camera.setPosition(0,0,10),this.pack=await Yn.loadPack3D("./utils/pack/scene.blend.pak")}update(t){this.camera.update(t),this.pack.jam.forEach(e=>e.object.update(t)),this.pack.jsm.forEach(e=>e.object.update(t)),this.pack.jas.forEach(e=>e.object.update(t)),this.pack.jss.forEach(e=>e.object.update()),this.pack.jwm.forEach(e=>e.object.update()),this.pack.jnm.forEach(e=>e.object.update(t)),this.pack.jlm.forEach(e=>e.object.update(t)),this.pack.jsv.forEach(e=>e.object.update(t))}draw(){this.pack.jam.forEach(t=>t.object.draw()),this.pack.jsm.forEach(t=>t.object.draw()),this.pack.jas.forEach(t=>t.object.draw()),this.pack.jss.forEach(t=>t.object.draw()),this.pack.jwm.forEach(t=>t.object.draw()),this.pack.jnm.forEach(t=>t.object.draw()),this.pack.jsv.forEach(t=>t.object.draw()),Ot.setAmbientColor([.5,.5,.5]),Jt.drawGrid(f.MAT4_ROTATE_X(Math.PI*.5),20,1)}}class np extends yt{constructor(){super(),this.uiMenu=new Yt({className:"UIMenuText UIBootMenu"}),this.uiTemplates=new Yt({className:"UIMenuText UIBootMenu"}),this.uiUtils=new Yt({className:"UIMenuText UIBootMenu"})}async onEnter(){this.uiMenu.add("0","Templates"),this.uiMenu.add("1","Utils"),P.addWidget(this.uiMenu,"position:absolute; top:50%; left:50%; width:60%; transform:translate(-50%,-50%);"),this.uiTemplates.add("0","2D Background Isometric"),this.uiTemplates.add("1","2D Checker"),this.uiTemplates.add("2","2D Fight"),this.uiTemplates.add("3","3D FPS"),this.uiTemplates.add("4","3D Isometric"),this.uiTemplates.add("5","3D Pre-rendered"),this.uiTemplates.add("6","3D RPG"),this.uiTemplates.add("7","2D Shootem'up"),this.uiTemplates.add("8","2D TCG"),this.uiTemplates.add("9","3D Third Person"),this.uiTemplates.add("10","2D Tilemap"),this.uiTemplates.add("11","2D Tilemap Isometric"),this.uiTemplates.add("12","2D Tilemap Pathfinding"),this.uiTemplates.add("13","2D Triple Triad"),this.uiTemplates.add("14","2D Visual Novel"),this.uiTemplates.add("15","2D Platformer"),this.uiTemplates.setVisible(!1),P.addWidget(this.uiTemplates,"position:absolute; top:50%; left:50%; width:60%; transform:translate(-50%,-50%);"),this.uiUtils.add("0","3D Curve"),this.uiUtils.add("1","3D Particles"),this.uiUtils.add("2","3D Perf"),this.uiUtils.add("3","3D Rapier"),this.uiUtils.add("4","3D Shadow Map"),this.uiUtils.add("5","UI Menu"),this.uiUtils.add("6","3D Viewer"),this.uiUtils.add("7","3D Menu Ring"),this.uiUtils.add("8","3D Pack"),this.uiUtils.setVisible(!1),P.addWidget(this.uiUtils,"position:absolute; top:50%; left:50%; width:60%; transform:translate(-50%,-50%);"),v.subscribe(this.uiMenu,"E_ITEM_SELECTED",this,this.handleMenuItemSelected),v.subscribe(this.uiTemplates,"E_ITEM_SELECTED",this,this.handleTemplateSelected),v.subscribe(this.uiUtils,"E_ITEM_SELECTED",this,this.handleUtilSelected),P.focus(this.uiMenu)}onExit(){P.removeWidget(this.uiMenu),P.removeWidget(this.uiTemplates),P.removeWidget(this.uiUtils)}handleMenuItemSelected(t){t.id==0?(this.uiTemplates.setVisible(!0),P.focus(this.uiTemplates)):t.id==1&&(this.uiUtils.setVisible(!0),P.focus(this.uiUtils))}handleTemplateSelected(t){t.id==0?ut.requestSetScreen(new bh):t.id==1?ut.requestSetScreen(new Kh):t.id==2?ut.requestSetScreen(new oo):t.id==3?ut.requestSetScreen(new Fl):t.id==4?ut.requestSetScreen(new Gl):t.id==5?ut.requestSetScreen(new cc):t.id==6?ut.requestSetScreen(new Xc):t.id==7?ut.requestSetScreen(new iu):t.id==8?ut.requestSetScreen(new Pu,{duelId:"0000"}):t.id==9?ut.requestSetScreen(new Uu):t.id==10?ut.requestSetScreen(new Vu):t.id==11?ut.requestSetScreen(new ju):t.id==12?ut.requestSetScreen(new Wu):t.id==13?ut.requestSetScreen(new od):t.id==14?ut.requestSetScreen(new hd):t.id==15&&ut.requestSetScreen(new oc)}handleUtilSelected(t){t.id==0?ut.requestSetScreen(new yd):t.id==1?ut.requestSetScreen(new bd):t.id==2?ut.requestSetScreen(new Dd):t.id==3?ut.requestSetScreen(new kd):t.id==4?ut.requestSetScreen(new Wd):t.id==5?ut.requestSetScreen(new Xd):t.id==6?ut.requestSetScreen(new Kd):t.id==7?ut.requestSetScreen(new Ad):t.id==8&&ut.requestSetScreen(new rp)}}Yn.startup();ut.requestSetScreen(new np);
