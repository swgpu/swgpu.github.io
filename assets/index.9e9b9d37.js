(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const n of r.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function e(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerpolicy&&(r.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?r.credentials="include":i.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=e(i);fetch(i.href,r)}})();class $r{subscribers;constructor(){this.subscribers=[]}wait(t,e){return new Promise(s=>{this.subscribeOnce(t,e,this,i=>{s(i)})})}subscribe(t,e,s,i){this.subscribers.push({emitter:t,type:e,listener:s,once:!1,cb:i})}subscribeOnce(t,e,s,i){this.subscribers.push({emitter:t,type:e,listener:s,once:!0,cb:i})}unsubscribe(t,e,s){for(let i of this.subscribers)if(i.emitter==t&&i.type==e&&i.listener==s){this.subscribers.splice(this.subscribers.indexOf(i),1);return}}unsubscribeAll(){this.subscribers=[]}async emit(t,e,s={}){const i=[];for(const r of this.subscribers.slice())if(r.emitter==t&&r.type==e){const n=r.cb.call(r.listener,s);n instanceof Promise&&i.push(n),r.once&&this.subscribers.splice(this.subscribers.indexOf(r),1)}return Promise.all(i)}}const m=new $r;var qi=(o=>(o[o.FIT=0]="FIT",o[o.ADJUST=1]="ADJUST",o[o.FIXED=2]="FIXED",o[o.FULL=3]="FULL",o))(qi||{});class Kr{container;resWidth;resHeight;sizeMode;constructor(){if(this.container=document.getElementById("APP"),!this.container)throw new Error("Application::Application: APP element not found !");this.resWidth=this.container.clientWidth,this.resHeight=this.container.clientHeight,this.sizeMode=2,window.addEventListener("resize",()=>m.emit(this,"E_RESIZE"))}setSize(t,e,s=2){this.container.style.width=t+"px",this.container.style.height=e+"px",s==0?this.container.style.transform="scale("+window.innerWidth/t+","+window.innerHeight/e+")":s==1?this.container.style.transform="scale("+Math.min(window.innerWidth/t,window.innerHeight/e)+")":s==2?(this.container.style.transform="none",this.container.style.margin="0 auto"):s==3&&(this.container.style.width="100vw",this.container.style.height="100vh"),this.resWidth=t,this.resHeight=e,this.sizeMode=s,m.emit(this,"E_RESIZE")}getSize(){return[this.container.clientWidth,this.container.clientHeight]}getResolution(){return[this.resWidth,this.resHeight]}addClass(t){this.container.classList.add(t)}removeClass(t){this.container.classList.remove(t)}toggleClass(t){this.container.classList.toggle(t)}enableScanlines(t){this.container.classList.toggle("scanlines",t)}}const rs=new Kr;class c{static DEG_TO_RAD_RATIO=Math.PI/180;static EPSILON=1e-7;static BIG_EPSILON=1e-4;static VEC2_SIZE=8;static VEC2_ZERO=[0,0];static VEC2_LEFT=[-1,0];static VEC2_RIGHT=[1,0];static VEC2_UP=[0,1];static VEC2_DOWN=[0,-1];static VEC2_ISO_LEFT=[0,1];static VEC2_ISO_RIGHT=[0,-1];static VEC2_ISO_FORWARD=[-1,0];static VEC2_ISO_BACKWARD=[1,0];static VEC3_SIZE=12;static VEC3_ZERO=[0,0,0];static VEC3_BACKWARD=[0,0,1];static VEC3_FORWARD=[0,0,-1];static VEC3_LEFT=[-1,0,0];static VEC3_RIGHT=[1,0,0];static VEC3_UP=[0,1,0];static VEC3_DOWN=[0,-1,0];static FAIL(t){const e=document.querySelector("#APP_FAIL");e.classList.add("SHOW"),e.textContent=t}static WAIT(t){return new Promise(e=>{window.setTimeout(()=>e(),t)})}static SHUFFLE(t){const e=t.slice();let s,i,r=e.length;if(r)for(;--r;)i=Math.floor(Math.random()*(r+1)),s=e[i],e[i]=e[r],e[r]=s;return e}static RANGE_ARRAY(t,e,s=0){return Array.from({length:(e-t)/s+1},(i,r)=>t+r*s)}static RANDARRAY(t,e){const s=[];for(let i=t;i<=e;i++)s.push(i);return c.SHUFFLE(s)}static SPREAD(t,e){return t+e*(Math.random()-.5)}static GET_RANDOM_INT(t,e){return t=Math.ceil(t),e=Math.floor(e),Math.floor(Math.random()*(e-t))+t}static GET_RANDOM_FLOAT(t,e){return Math.random()*(e-t)+t}static CLAMP(t,e,s){return Math.max(e,Math.min(s,t))}static DEG_TO_RAD(t){return t*(Math.PI/180)}static LERP(t,e,s){return t+(e-t)*s}static TO_FIXED_NUMBER(t,e,s=10){const i=Math.pow(s,e);return Math.round(t*i)/i}static VEC1_COPY(t,e=[0]){return e[0]=t,e}static VEC2_CREATE(t=0,e=0){const s=new Float32Array(2);return s[0]=t,s[1]=e,s}static VEC2_PARSE(t,e=" ",s=[0,0]){const i=t.split(e);return s[0]=parseFloat(i[0]),s[1]=parseFloat(i[1]),s}static VEC2_COPY(t,e=[0,0]){return e[0]=t[0],e[1]=t[1],e}static VEC2_ISZERO(t){return Math.abs(t[0])<=c.EPSILON&&Math.abs(t[1])<=c.EPSILON}static VEC2_SPREAD(t,e){const s=c.VEC2_CREATE(Math.random()-.5,Math.random()-.5);return c.VEC2_ADD(t,c.VEC2_MULTIPLY(e,s))}static VEC2_ROTATE_AROUND(t,e,s){const i=Math.cos(s)*e,r=Math.sin(s)*e;return[t[0]+i,t[1]+r]}static VEC2_OPPOSITE(t,e=[0,0]){return e[0]=-t[0],e[1]=-t[1],e}static VEC2_DISTANCE(t,e){const s=e[0]-t[0],i=e[1]-t[1];return Math.sqrt(s*s+i*i)}static VEC2_LENGTH(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1])}static VEC2_NORMALIZE(t,e=[0,0]){const s=c.VEC2_LENGTH(t);return s>0&&(e[0]=t[0]/s,e[1]=t[1]/s),e}static VEC2_DOT(t,e){return t[0]*e[0]+t[1]*e[1]}static VEC2_CROSS(t,e){return t[0]*e[1]-t[1]*e[0]}static VEC2_ORIENTATION(t,e,s){const i=(e[1]-t[1])*(s[0]-e[0])-(e[0]-t[0])*(s[1]-e[1]);return i==0?0:i>0?1:2}static VEC2_ADD(t,e,s=[0,0]){return s[0]=t[0]+e[0],s[1]=t[1]+e[1],s}static VEC2_SUBSTRACT(t,e,s=[0,0]){return s[0]=t[0]-e[0],s[1]=t[1]-e[1],s}static VEC2_MULTIPLY(t,e,s=[0,0]){return s[0]=t[0]*e[0],s[1]=t[1]*e[1],s}static VEC2_SCALE(t,e,s=[0,0]){return s[0]=t[0]*e,s[1]=t[1]*e,s}static VEC2_ADD_SCALED(t,e,s,i=[0,0]){return i[0]=t[0]+e[0]*s,i[1]=t[1]+e[1]*s,i}static VEC2_ANGLE_BETWEEN(t,e){return Math.acos(c.VEC2_DOT(t,e)/(c.VEC2_LENGTH(t)*c.VEC2_LENGTH(e)))}static VEC2_ANGLE(t){const e=Math.atan2(t[1],t[0]);return e>0?e:e+Math.PI*2}static VEC2_ISEQUAL(t,e){return t[0]==e[0]&&t[1]==e[1]}static VEC2_PROJECTION_COS(t,e,s=[0,0]){const i=Math.sqrt(e[0]*e[0]+e[1]*e[1]),r=(t[0]*e[0]+t[1]*e[1])/(i*i);return s[0]=e[0]*r,s[1]=e[1]*r,s}static VEC2_QUADRATIC_BEZIER(t,e,s,i,r=[0,0]){const n=t[0]+(e[0]-t[0])*i,a=t[1]+(e[1]-t[1])*i,h=e[0]+(s[0]-e[0])*i,l=e[1]+(s[1]-e[1])*i;return r[0]=n+(h-n)*i,r[1]=a+(l-a)*i,r}static VEC2_ISO_TO_2D(t){let e=(2*t[1]+t[0])*.5,s=(2*t[1]-t[0])*.5;return[e,s]}static VEC2_2D_TO_ISO(t){let e=t[0]-t[1],s=(t[0]+t[1])*.5;return[e,s]}static VEC2_ISO_CARDINAL_POINTS(t,e,s){if(t=="FORWARD"){const i=c.VEC2_2D_TO_ISO([-e*.5,0]),r=c.VEC2_2D_TO_ISO([0,s*.5]),n=c.VEC2_2D_TO_ISO([0,-s*.5]),a=c.VEC2_2D_TO_ISO([e*.5,0]);return{f:i,l:r,r:n,b:a}}if(t=="BACKWARD"){const i=c.VEC2_2D_TO_ISO([e*.5,0]),r=c.VEC2_2D_TO_ISO([0,-s*.5]),n=c.VEC2_2D_TO_ISO([0,s*.5]),a=c.VEC2_2D_TO_ISO([-e*.5,0]);return{f:i,l:r,r:n,b:a}}if(t=="LEFT"){const i=c.VEC2_2D_TO_ISO([0,e*.5]),r=c.VEC2_2D_TO_ISO([-s*.5,0]),n=c.VEC2_2D_TO_ISO([s*.5,0]),a=c.VEC2_2D_TO_ISO([0,e*.5]);return{f:i,l:r,r:n,b:a}}if(t=="RIGHT"){const i=c.VEC2_2D_TO_ISO([0,-e*.5]),r=c.VEC2_2D_TO_ISO([s*.5,0]),n=c.VEC2_2D_TO_ISO([-s*.5,0]),a=c.VEC2_2D_TO_ISO([0,e*.5]);return{f:i,l:r,r:n,b:a}}return{f:[0,0],l:[0,0],r:[0,0],b:[0,0]}}static VEC3_CREATE(t=0,e=0,s=0){const i=new Float32Array(3);return i[0]=t,i[1]=e,i[2]=s,i}static VEC3_PARSE(t,e=" ",s=[0,0,0]){const i=t.split(e);return s[0]=parseFloat(i[0]),s[1]=parseFloat(i[1]),s[2]=parseFloat(i[2]),s}static VEC3_COPY(t,e=[0,0,0]){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}static VEC3_ISZERO(t){return Math.abs(t[0])<=c.EPSILON&&Math.abs(t[1])<=c.EPSILON&&Math.abs(t[2])<=c.EPSILON}static VEC3_SPREAD(t,e){const s=c.VEC3_CREATE(Math.random()-.5,Math.random()-.5,Math.random()-.5);return c.VEC3_ADD(t,c.VEC3_MULTIPLY(e,s))}static VEC3_ROTATE_AROUND(t,e,s,i){const r=Math.cos(i)*e,n=Math.sin(i)*e,a=Math.sin(s)*r,h=Math.cos(s)*r;return[t[0]+h,t[1]+n,t[2]+a]}static VEC3_OPPOSITE(t,e=[0,0,0]){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e}static VEC3_DISTANCE(t,e){const s=e[0]-t[0],i=e[1]-t[1],r=e[2]-t[2];return Math.sqrt(s*s+i*i+r*r)}static VEC3_LENGTH(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2])}static VEC3_NORMALIZE(t,e=[0,0,0]){const s=c.VEC3_LENGTH(t);return s>0&&(e[0]=t[0]/s,e[1]=t[1]/s,e[2]=t[2]/s),e}static VEC3_DOT(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}static VEC3_CROSS(t,e,s=[0,0,0]){return s[0]=t[1]*e[2]-t[2]*e[1],s[1]=t[2]*e[0]-t[0]*e[2],s[2]=t[0]*e[1]-t[1]*e[0],s}static VEC3_ADD(t,e,s=[0,0,0]){return s[0]=t[0]+e[0],s[1]=t[1]+e[1],s[2]=t[2]+e[2],s}static VEC3_SUBSTRACT(t,e,s=[0,0,0]){return s[0]=t[0]-e[0],s[1]=t[1]-e[1],s[2]=t[2]-e[2],s}static VEC3_MULTIPLY(t,e,s=[0,0,0]){return s[0]=t[0]*e[0],s[1]=t[1]*e[1],s[2]=t[2]*e[2],s}static VEC3_SCALE(t,e,s=[0,0,0]){return s[0]=t[0]*e,s[1]=t[1]*e,s[2]=t[2]*e,s}static VEC3_ADD_SCALED(t,e,s,i=[0,0,0]){return i[0]=t[0]+e[0]*s,i[1]=t[1]+e[1]*s,i[2]=t[2]+e[2]*s,i}static VEC3_ISEQUAL(t,e){return t[0]==e[0]&&t[1]==e[1]&&t[2]==e[2]}static VEC3_QUADRATIC_BEZIER(t,e,s,i,r=[0,0,0]){const n=t[0]+(e[0]-t[0])*i,a=t[1]+(e[1]-t[1])*i,h=t[2]+(e[2]-t[2])*i,l=e[0]+(s[0]-e[0])*i,u=e[1]+(s[1]-e[1])*i,d=e[2]+(s[2]-e[2])*i;return r[0]=n+(l-n)*i,r[1]=a+(u-a)*i,r[2]=h+(d-h)*i,r}static VEC4_CREATE(t=0,e=0,s=0,i=0){const r=new Float32Array(4);return r[0]=t,r[1]=e,r[2]=s,r[3]=i,r}static VEC4_PARSE(t,e=" ",s=[0,0,0,0]){const i=t.split(e);return s[0]=parseFloat(i[0]),s[1]=parseFloat(i[1]),s[2]=parseFloat(i[2]),s[3]=1,s}static VEC4_COPY(t,e=[0,0,0,0]){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}static VEC4_ISZERO(t){return Math.abs(t[0])<=c.EPSILON&&Math.abs(t[1])<=c.EPSILON&&Math.abs(t[2])<=c.EPSILON&&Math.abs(t[3])<=c.EPSILON}static MAT3_CREATE(){const t=new Float32Array(9);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t}static MAT3_COPY(t,e){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e}static MAT3_MULTIPLY_BY_VEC3(t,e,s=[0,0,0]){const i=t[0],r=t[1],n=t[2],a=t[3],h=t[4],l=t[5],u=t[6],d=t[7],p=t[8],E=e[0],T=e[1],A=e[2];return s[0]=E*i+T*a+A*u,s[1]=E*r+T*h+A*d,s[2]=E*n+T*l+A*p,s}static MAT3_MULTIPLY(t,e,s=[0,0,0,0,0,0,0,0,0]){const i=t[0],r=t[1],n=t[2],a=t[3],h=t[4],l=t[5],u=t[6],d=t[7],p=t[8],E=e[0],T=e[1],A=e[2],x=e[3],y=e[4],C=e[5],S=e[6],w=e[7],P=e[8],O=E*i+T*a+A*u,_=E*r+T*h+A*d,H=E*n+T*l+A*p,L=x*i+y*a+C*u,Z=x*r+y*h+C*d,X=x*n+y*l+C*p,K=S*i+w*a+P*u,ot=S*r+w*h+P*d,st=S*n+w*l+P*p;return s[0]=O,s[1]=_,s[2]=H,s[3]=L,s[4]=Z,s[5]=X,s[6]=K,s[7]=ot,s[8]=st,s}static MAT3_INVERT(t,e=[0,0,0,0,0,0,0,0,0]){const s=t[0],i=t[1],r=t[2],n=t[3],a=t[4],h=t[5],l=t[6],u=t[7],d=t[8],p=d*a-h*u,E=-d*n+h*l,T=u*n-a*l;let A=s*p+i*E+r*T;if(!A)throw new Error("UT::MAT4_INVERT(): det is invalid !");A=1/A;const x=p*A,y=(-d*i+r*u)*A,C=(h*i-r*a)*A,S=E*A,w=(d*s-r*l)*A,P=(-h*s+r*n)*A,O=T*A,_=(-u*s+i*l)*A,H=(a*s-i*n)*A;return e[0]=x,e[1]=y,e[2]=C,e[3]=S,e[4]=w,e[5]=P,e[6]=O,e[7]=_,e[8]=H,e}static MAT3_IDENTITY(t=[0,0,0,0,0,0,0,0,0]){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t}static MAT3_SCALE(t,e,s=[0,0,0,0,0,0,0,0,0]){return s[0]=t,s[1]=0,s[2]=0,s[3]=0,s[4]=e,s[5]=0,s[6]=0,s[7]=0,s[8]=1,s}static MAT3_ROTATE(t,e=[0,0,0,0,0,0,0,0,0]){const s=Math.cos(t),i=Math.sin(t);return e[0]=s,e[1]=-i,e[2]=0,e[3]=i,e[4]=s,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e}static MAT3_TRANSLATE(t,e,s=[0,0,0,0,0,0,0,0,0]){return s[0]=1,s[1]=0,s[2]=0,s[3]=0,s[4]=1,s[5]=0,s[6]=t,s[7]=e,s[8]=1,s}static MAT3_TRANSFORM(t,e,s,i,r=[0,0,0,0,0,0,0,0,0]){return c.MAT3_TRANSLATE(t[0],t[1],r),c.MAT3_MULTIPLY(r,c.MAT3_ROTATE(s),r),c.MAT3_MULTIPLY(r,c.MAT3_SCALE(i[0],i[1]),r),c.MAT3_MULTIPLY(r,c.MAT3_TRANSLATE(-e[0],-e[1]),r),r}static MAT3_PROJECTION(t,e,s=[0,0,0,0,0,0,0,0,0]){return s[0]=2/t,s[1]=0,s[2]=0,s[3]=0,s[4]=2/e,s[5]=0,s[6]=-1,s[7]=-1,s[8]=1,s}static MAT4_CREATE(){const t=new Float32Array(16);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}static MAT4_COPY(t,e){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}static MAT4_MULTIPLY_BY_VEC4(t,e,s=[0,0,0,0]){const i=t[0],r=t[1],n=t[2],a=t[3],h=t[4],l=t[5],u=t[6],d=t[7],p=t[8],E=t[9],T=t[10],A=t[11],x=t[12],y=t[13],C=t[14],S=t[15],w=e[0],P=e[1],O=e[2],_=e[3];return s[0]=w*i+P*h+O*p+_*x,s[1]=w*r+P*l+O*E+_*y,s[2]=w*n+P*u+O*T+_*C,s[3]=w*a+P*d+O*A+_*S,s}static MAT4_MULTIPLY(t,e,s=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){const i=t[0],r=t[1],n=t[2],a=t[3],h=t[4],l=t[5],u=t[6],d=t[7],p=t[8],E=t[9],T=t[10],A=t[11],x=t[12],y=t[13],C=t[14],S=t[15],w=e[0],P=e[1],O=e[2],_=e[3],H=e[4],L=e[5],Z=e[6],X=e[7],K=e[8],ot=e[9],st=e[10],q=e[11],Tt=e[12],Dt=e[13],At=e[14],Rt=e[15];return s[0]=w*i+P*h+O*p+_*x,s[1]=w*r+P*l+O*E+_*y,s[2]=w*n+P*u+O*T+_*C,s[3]=w*a+P*d+O*A+_*S,s[4]=H*i+L*h+Z*p+X*x,s[5]=H*r+L*l+Z*E+X*y,s[6]=H*n+L*u+Z*T+X*C,s[7]=H*a+L*d+Z*A+X*S,s[8]=K*i+ot*h+st*p+q*x,s[9]=K*r+ot*l+st*E+q*y,s[10]=K*n+ot*u+st*T+q*C,s[11]=K*a+ot*d+st*A+q*S,s[12]=Tt*i+Dt*h+At*p+Rt*x,s[13]=Tt*r+Dt*l+At*E+Rt*y,s[14]=Tt*n+Dt*u+At*T+Rt*C,s[15]=Tt*a+Dt*d+At*A+Rt*S,s}static MAT4_COMPUTE(...t){for(let e=0;e<t.length-1;e++)t[e+1]=c.MAT4_MULTIPLY(t[e],t[e+1]);return t[t.length-1]}static MAT4_INVERT(t,e=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){const s=t[0],i=t[1],r=t[2],n=t[3],a=t[4],h=t[5],l=t[6],u=t[7],d=t[8],p=t[9],E=t[10],T=t[11],A=t[12],x=t[13],y=t[14],C=t[15],S=s*h-i*a,w=s*l-r*a,P=s*u-n*a,O=i*l-r*h,_=i*u-n*h,H=r*u-n*l,L=d*x-p*A,Z=d*y-E*A,X=d*C-T*A,K=p*y-E*x,ot=p*C-T*x,st=E*C-T*y;let q=S*st-w*ot+P*K+O*X-_*Z+H*L;if(!q)throw new Error("UT::MAT4_INVERT(): det is invalid !");q=1/q;const Tt=(h*st-l*ot+u*K)*q,Dt=(r*ot-i*st-n*K)*q,At=(x*H-y*_+C*O)*q,Rt=(E*_-p*H-T*O)*q,ie=(l*X-a*st-u*Z)*q,Fe=(s*st-r*X+n*Z)*q,re=(y*P-A*H-C*w)*q,bt=(d*H-E*P+T*w)*q,ne=(a*ot-h*X+u*L)*q,oe=(i*X-s*ot-n*L)*q,ae=(A*_-x*P+C*S)*q,he=(p*P-d*_-T*S)*q,le=(h*Z-a*K-l*L)*q,ce=(s*K-i*Z+r*L)*q,Be=(x*w-A*O-y*S)*q,ue=(d*O-p*w+E*S)*q;return e[0]=Tt,e[1]=Dt,e[2]=At,e[3]=Rt,e[4]=ie,e[5]=Fe,e[6]=re,e[7]=bt,e[8]=ne,e[9]=oe,e[10]=ae,e[11]=he,e[12]=le,e[13]=ce,e[14]=Be,e[15]=ue,e}static MAT4_IDENTITY(t=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}static MAT4_SCALE(t,e,s,i=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){return i[0]=t,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=e,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=s,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i}static MAT4_ROTATE_X(t,e=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){const s=Math.cos(t),i=Math.sin(t);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=s,e[6]=-i,e[7]=0,e[8]=0,e[9]=i,e[10]=s,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}static MAT4_ROTATE_Y(t,e=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){const s=Math.cos(t),i=Math.sin(t);return e[0]=s,e[1]=0,e[2]=i,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=-i,e[9]=0,e[10]=s,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}static MAT4_ROTATE_Z(t,e=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){const s=Math.cos(t),i=Math.sin(t);return e[0]=s,e[1]=i,e[2]=0,e[3]=0,e[4]=-i,e[5]=s,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}static MAT4_TRANSLATE(t,e,s,i=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){return i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=t,i[13]=e,i[14]=s,i[15]=1,i}static MAT4_TRANSFORM(t,e,s,i,r=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){return c.MAT4_TRANSLATE(t[0],t[1],t[2],r),c.MAT4_MULTIPLY(r,i.toMatrix4(),r),c.MAT4_MULTIPLY(r,c.MAT4_ROTATE_Y(e[1]),r),c.MAT4_MULTIPLY(r,c.MAT4_ROTATE_X(e[0]),r),c.MAT4_MULTIPLY(r,c.MAT4_ROTATE_Z(e[2]),r),c.MAT4_MULTIPLY(r,c.MAT4_SCALE(s[0],s[1],s[2]),r),r}static MAT4_ORTHOGRAPHIC(t,e,s,i=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){return i[0]=2/t,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=2/e,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=-2/s,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i}static MAT4_ORTHO(t,e,s,i,r,n,a=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){return a[0]=2/(e-t),a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2/(i-s),a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=2/(r-n),a[11]=0,a[12]=(t+e)/(t-e),a[13]=(s+i)/(s-i),a[14]=(r+n)/(r-n),a[15]=1,a}static MAT4_PERSPECTIVE(t,e,s,i,r=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){return r[0]=1/(Math.tan(t/2)*e),r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1/Math.tan(t/2),r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=(s+i)/(s-i),r[11]=-1,r[12]=0,r[13]=0,r[14]=2*i*s/(s-i),r[15]=0,r}static MAT4_LOOKAT(t,e,s=c.VEC3_UP,i=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){const r=c.VEC3_NORMALIZE(c.VEC3_SUBSTRACT(t,e));if(s=c.VEC3_NORMALIZE(s),Math.abs(c.VEC3_DOT(r,s))>1-c.EPSILON){const h=Math.abs(r[1])<1-c.EPSILON?[0,1,0]:[1,0,0];s=c.VEC3_NORMALIZE(c.VEC3_CROSS(h,r))}const n=c.VEC3_NORMALIZE(c.VEC3_CROSS(s,r)),a=c.VEC3_NORMALIZE(c.VEC3_CROSS(r,n));return i[0]=n[0],i[1]=n[1],i[2]=n[2],i[3]=0,i[4]=a[0],i[5]=a[1],i[6]=a[2],i[7]=0,i[8]=r[0],i[9]=r[1],i[10]=r[2],i[11]=0,i[12]=t[0],i[13]=t[1],i[14]=t[2],i[15]=1,i}static MAT4_TRANSPOSE(t,e=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){const s=t[0],i=t[1],r=t[2],n=t[3],a=t[4],h=t[5],l=t[6],u=t[7],d=t[8],p=t[9],E=t[10],T=t[11],A=t[12],x=t[13],y=t[14],C=t[15];return e[0]=s,e[1]=a,e[2]=d,e[3]=A,e[4]=i,e[5]=h,e[6]=p,e[7]=x,e[8]=r,e[9]=l,e[10]=E,e[11]=y,e[12]=n,e[13]=u,e[14]=T,e[15]=C,e}static COLLIDE_CIRCLE(t,e,s,i,r=[0,0]){const n=c.VEC2_SUBSTRACT(t,s),a=c.VEC2_LENGTH(n),h=e+i;if(a>h)return!1;const l=Math.PI*2-(Math.PI*2-Math.atan2(n[1],n[0]));return r[0]=Math.cos(l)*(h-a),r[1]=Math.sin(l)*(h-a),!0}static COLLIDE_CYLINDER(t,e,s,i,r,n,a=[0,0]){if(!c.COLLIDE_CIRCLE([t[0],t[2]],e,[i[0],i[2]],r,a))return!1;let l=t[1],u=t[1]+s,d=i[1],p=i[1]+n;return l<=p&&u>=d}static COLLIDE_POINT_TO_RECT(t,e,s){return t[0]>=e[0]&&t[0]<=s[0]&&t[1]>=e[1]&&t[1]<=s[1]}static COLLIDE_RECT_TO_RECT(t,e,s,i){return t[0]<=i[0]&&e[0]>=s[0]&&t[1]<=i[1]&&e[1]>=s[1]}static COLLIDE_POINT_TO_BOX(t,e,s){return t[0]>=e[0]&&t[0]<=s[0]&&t[1]>=e[1]&&t[1]<=s[1]&&t[2]>=e[2]&&t[2]<=s[2]}static COLLIDE_BOX_TO_BOX(t,e,s,i){return t[0]<=i[0]&&e[0]>=s[0]&&t[1]<=i[1]&&e[1]>=s[1]&&t[2]<=i[2]&&e[2]>=s[2]}static COLLIDE_LINE_TO_LINE(t,e,s,i){let r=c.VEC2_ORIENTATION(t,e,s),n=c.VEC2_ORIENTATION(t,e,i),a=c.VEC2_ORIENTATION(s,i,t),h=c.VEC2_ORIENTATION(s,i,e);return r!=n&&a!=h}static TRI2_POINT_INSIDE(t,e,s,i){const r=c.VEC2_SUBSTRACT(s,e),n=c.VEC2_SUBSTRACT(i,s),a=c.VEC2_SUBSTRACT(e,i),h=c.VEC2_SUBSTRACT(t,e),l=c.VEC2_SUBSTRACT(t,s),u=c.VEC2_SUBSTRACT(t,i);return c.VEC2_CROSS(h,r)<-c.EPSILON?-1:c.VEC2_CROSS(l,n)<-c.EPSILON?-2:c.VEC2_CROSS(u,a)<-c.EPSILON?-3:1}static TRI3_NORMAL(t,e,s,i=[0,0,0]){const r=c.VEC3_SUBSTRACT(e,t),n=c.VEC3_SUBSTRACT(s,t);return c.VEC3_CROSS(r,n,i)}static TRI3_POINT_INSIDE(t,e,s,i){const r=c.VEC3_SUBSTRACT(i,e),n=c.VEC3_SUBSTRACT(s,e),a=c.VEC3_SUBSTRACT(t,e),h=c.VEC3_DOT(r,r),l=c.VEC3_DOT(r,n),u=c.VEC3_DOT(r,a),d=c.VEC3_DOT(n,n),p=c.VEC3_DOT(n,a),E=1/(h*d-l*l),T=(d*u-l*p)*E,A=(h*p-l*u)*E;return T>=0&&A>=0&&T+A<1}static TRI3_POINT_ELEVATION(t,e,s,i){const r=c.VEC3_CREATE(s[0]-e[0],0,s[2]-e[2]),n=c.VEC3_CREATE(e[0]-i[0],0,e[2]-i[2]),a=c.VEC3_CREATE(t[0]-e[0],0,t[1]-e[2]),h=c.VEC3_CREATE(t[0]-s[0],0,t[1]-s[2]),l=c.VEC3_CREATE(t[0]-i[0],0,t[1]-i[2]),u=c.VEC3_LENGTH(c.VEC3_CROSS(r,n)),d=c.VEC3_LENGTH(c.VEC3_CROSS(h,l))/u,p=c.VEC3_LENGTH(c.VEC3_CROSS(a,l))/u,E=c.VEC3_LENGTH(c.VEC3_CROSS(a,h))/u;if(d+p+E>1+c.BIG_EPSILON)return 1/0;const T=e[1]+(s[1]-e[1])*(p/(d+p));return T+(i[1]-T)*(E/(d+p+E))}static RAY_TRIANGLE(t,e,s,i,r,n=!1,a=[0,0,0]){const h=c.TRI3_NORMAL(s,i,r);return c.RAY_PLAN(t,e,s,h,n,a)?c.TRI3_POINT_INSIDE(a,s,i,r):!1}static RAY_PLAN(t,e,s,i,r,n=[0,0,0]){const a=c.VEC3_DOT(e,i);if(r&&a>=0||a>-c.EPSILON&&a<c.EPSILON)return!1;const h=c.VEC3_DOT(i,s)*-1,u=(c.VEC3_DOT(i,t)*-1-h)/a;return u<0?!1:(n[0]=t[0]+e[0]*u,n[1]=t[1]+e[1]*u,n[2]=t[2]+e[2]*u,!0)}static RAY_BOX(t,e,s,i,r=[0,0,0]){for(let n=0;n<3;n++)if(t[n]<s[n]){const a=(s[n]-t[n])/e[n],h=t[0]+e[0]*a,l=t[1]+e[1]*a,u=t[2]+e[2]*a;if(h>=s[0]&&h<=i[0]&&l>=s[1]&&l<=i[1]&&u>=s[2]&&u<=i[2])return r[0]=h,r[1]=l,r[2]=u,!0}else if(t[n]>i[n]){const a=(i[n]-t[n])/e[n],h=t[0]+e[0]*a,l=t[1]+e[1]*a,u=t[2]+e[2]*a;if(h>=s[0]&&h<=i[0]&&l>=s[1]&&l<=i[1]&&u>=s[2]&&u<=i[2])return r[0]=h,r[1]=l,r[2]=u,!0}return!1}static LINEAR(t,e,s,i=1){return e+(s-e)*t/i}static EASE_IN_QUAD(t,e,s,i=1){return(s-e)*(t/=i)*t+e}static EASE_OUT_QUAD(t,e,s,i=1){return-(s-e)*(t/=i)*(t-2)+e}static EASE_IN_OUT_QUAD(t,e,s,i=1){const r=s-e;return(t/=i/2)<1?r/2*t*t+e:-r/2*(--t*(t-2)-1)+e}static LINEAR_VEC2(t,e,s,i=1){const r=c.VEC2_SUBSTRACT(s,e),n=t/i;return[e[0]+r[0]*n,e[1]+r[1]*n]}static LINEAR_VEC3(t,e,s,i=1){const r=c.VEC3_SUBSTRACT(s,e),n=t/i;return[e[0]+r[0]*n,e[1]+r[1]*n,e[2]+r[2]*n]}}var Fs=(o=>(o.PERSPECTIVE="PERSPECTIVE",o.ORTHOGRAPHIC="ORTHOGRAPHIC",o))(Fs||{});class Js{cameraMatrix;clipOffset;viewport;projectionMode;perspectiveFovy;perspectiveNear;perspectiveFar;orthographicSize;orthographicDepth;bgColor;screenSize;constructor(){this.cameraMatrix=c.MAT4_IDENTITY(),this.clipOffset=[0,0],this.viewport={xFactor:0,yFactor:0,widthFactor:1,heightFactor:1},this.projectionMode="PERSPECTIVE",this.perspectiveFovy=Math.PI/4,this.perspectiveNear=.1,this.perspectiveFar=2e3,this.orthographicSize=1,this.orthographicDepth=700,this.bgColor=[0,0,0,0],this.screenSize=[0,0]}getCameraPosition(){return[this.cameraMatrix[12],this.cameraMatrix[13],this.cameraMatrix[14]]}getClipOffset(){return this.clipOffset}getClipOffsetX(){return this.clipOffset[0]}getClipOffsetY(){return this.clipOffset[1]}setClipOffset(t,e){this.clipOffset[0]=t,this.clipOffset[1]=e}getCameraMatrix(){return this.cameraMatrix}setCameraMatrix(t){this.cameraMatrix=t}getViewport(){return this.viewport}setViewport(t){this.viewport=t}getProjectionMode(){return this.projectionMode}setProjectionMode(t){this.projectionMode=t}getPerspectiveFovy(){return this.perspectiveFovy}setPerspectiveFovy(t){this.perspectiveFovy=t}getPerspectiveNear(){return this.perspectiveNear}setPerspectiveNear(t){this.perspectiveNear=t}getPerspectiveFar(){return this.perspectiveFar}setPerspectiveFar(t){this.perspectiveFar=t}getOrthographicSize(){return this.orthographicSize}setOrthographicSize(t){this.orthographicSize=t}getOrthographicDepth(){return this.orthographicDepth}setOrthographicDepth(t){this.orthographicDepth=t}getBgColor(){return this.bgColor}setBgColor(t,e,s,i){this.bgColor[0]=t,this.bgColor[1]=e,this.bgColor[2]=s,this.bgColor[3]=i}getScreenSize(){return this.screenSize}setScreenSize(t,e){this.screenSize[0]=t,this.screenSize[1]=e}getViewportSize(){const t=this.screenSize[0]*this.viewport.widthFactor,e=this.screenSize[1]*this.viewport.heightFactor;return[t,e]}getViewportClientSize(){const t=this.screenSize[0]*this.viewport.widthFactor/window.devicePixelRatio,e=this.screenSize[1]*this.viewport.heightFactor/window.devicePixelRatio;return[t,e]}getProjectionMatrix(){const t=c.MAT4_IDENTITY(),e=this.screenSize[0]*this.viewport.widthFactor,s=this.screenSize[1]*this.viewport.heightFactor,i=e/s;return this.projectionMode=="PERSPECTIVE"?c.MAT4_PERSPECTIVE(this.perspectiveFovy,i,this.perspectiveNear,this.perspectiveFar,t):this.projectionMode=="ORTHOGRAPHIC"&&c.MAT4_ORTHOGRAPHIC(this.orthographicSize,this.orthographicSize/i,this.orthographicDepth,t),t}getClipMatrix(){return c.MAT4_INVERT(c.MAT4_TRANSLATE(this.clipOffset[0],this.clipOffset[1],0))}getCameraViewMatrix(){return c.MAT4_INVERT(this.cameraMatrix)}getProjectionClipMatrix(){const t=c.MAT4_IDENTITY();return c.MAT4_MULTIPLY(t,this.getClipMatrix(),t),c.MAT4_MULTIPLY(t,this.getProjectionMatrix(),t),t}getViewProjectionClipMatrix(){const t=c.MAT4_IDENTITY();return c.MAT4_MULTIPLY(t,this.getClipMatrix(),t),c.MAT4_MULTIPLY(t,this.getProjectionMatrix(),t),c.MAT4_MULTIPLY(t,this.getCameraViewMatrix(),t),t}getClientScreenPosition(t,e,s){const i=c.MAT4_IDENTITY();c.MAT4_MULTIPLY(i,this.getClipMatrix(),i),c.MAT4_MULTIPLY(i,this.getProjectionMatrix(),i),c.MAT4_MULTIPLY(i,this.getCameraViewMatrix(),i);const r=c.MAT4_MULTIPLY_BY_VEC4(i,[t,e,s,1]),n=this.getViewportClientSize();return r[0]=r[0]/r[3],r[1]=r[1]/r[3],r[0]=(r[0]+1)*n[0]/2,r[1]=n[1]-(r[1]+1)*n[1]/2,[r[0],r[1]]}getScreenNormalizedPosition(t,e,s){const i=c.MAT4_IDENTITY();c.MAT4_MULTIPLY(i,this.getClipMatrix(),i),c.MAT4_MULTIPLY(i,this.getProjectionMatrix(),i),c.MAT4_MULTIPLY(i,this.getCameraViewMatrix(),i);const r=c.MAT4_MULTIPLY_BY_VEC4(i,[t,e,s,1]);return[r[0]/r[3],r[1]/r[3]]}}const ge=256;class Jr{device;pipeline;groupIndex;uniformsByteLength;uniforms;textures;buffer;currentOffset;bindGroup;constructor(t,e,s){this.device=t,this.pipeline=e,this.groupIndex=s,this.uniformsByteLength=0,this.uniforms=new Map,this.textures=new Map,this.buffer=t.createBuffer({size:16*4,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.currentOffset=0,this.bindGroup=null}delete(){this.buffer.destroy()}setFloat(t,e,s){let i=s*4,r=Math.ceil(i/256)*ge;return this.uniforms.set(t,{binding:t,name:e,size:i,alignment:r}),this.uniformsByteLength+=r,new Float32Array(s)}setInteger(t,e,s){let i=s*4,r=Math.ceil(i/256)*ge;return this.uniforms.set(t,{binding:t,name:e,size:i,alignment:r}),this.uniformsByteLength+=r,new Uint32Array(s)}setTexture(t,e,s,i={}){return this.textures.set(t,{binding:t,name:e,resource:s.gpuTexture.createView(i)}),s}setSampler(t,e,s){return this.textures.set(t,{binding:t,name:e,resource:s.gpuSampler}),s}allocate(){this.buffer.size!=this.uniformsByteLength&&(this.buffer.destroy(),this.buffer=this.device.createBuffer({size:this.uniformsByteLength,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}));let t=[],e=0;for(const s of this.uniforms.values())t[s.binding]={binding:s.binding,resource:{buffer:this.buffer,offset:e,size:s.size}},e+=s.alignment;for(const s of this.textures.values())t[s.binding]={binding:s.binding,resource:s.resource};this.bindGroup=this.device.createBindGroup({layout:this.pipeline.getBindGroupLayout(this.groupIndex),entries:t})}beginWrite(){this.currentOffset=0}write(t,e){this.device.queue.writeBuffer(this.buffer,this.currentOffset,e),this.currentOffset+=Math.ceil(e.byteLength/256)*ge}endWrite(){this.currentOffset=0}getBindGroup(){return this.bindGroup}}class Qr{device;pipeline;groupIndex;uniformsByteLength;uniforms;buffer;currentOffset;bindGroups;size;constructor(t,e,s){this.device=t,this.pipeline=e,this.groupIndex=s,this.uniformsByteLength=0,this.uniforms=new Map,this.buffer=t.createBuffer({size:16*4,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.currentOffset=0,this.bindGroups=[],this.size=0}delete(){this.buffer.destroy(),this.bindGroups=[]}setFloat(t,e,s){let i=s*4,r=Math.ceil(i/256)*ge;return this.uniforms.set(t,{binding:t,name:e,size:i,alignment:r}),this.uniformsByteLength+=r,new Float32Array(s)}setInteger(t,e,s){let i=s*4,r=Math.ceil(i/256)*ge;return this.uniforms.set(t,{binding:t,name:e,size:i,alignment:r}),this.uniformsByteLength+=r,new Uint32Array(s)}allocate(t=1){this.bindGroups=[],this.buffer.size!=t*this.uniformsByteLength&&(this.buffer.destroy(),this.buffer=this.device.createBuffer({size:t*this.uniformsByteLength,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}));for(let e=0,s=0,i=[];e<t;e++){for(const r of this.uniforms.values())i[r.binding]={binding:r.binding,resource:{buffer:this.buffer,offset:s,size:r.size}},s+=r.alignment;this.bindGroups.push(this.device.createBindGroup({layout:this.pipeline.getBindGroupLayout(this.groupIndex),entries:i}))}this.size=t}beginWrite(){this.currentOffset=0}write(t,e){this.device.queue.writeBuffer(this.buffer,this.currentOffset,e),this.currentOffset+=Math.ceil(e.byteLength/256)*ge}endWrite(){this.currentOffset=0}getBindGroup(t=0){return this.bindGroups[t]}getSize(){return this.size}}class tn{adapter;device;canvas;ctx;destinationTexture;normalsTexture;idsTexture;depthTexture;commandEncoder;passEncoder;pipelines;vertexBuffer;vertexSubBuffers;vertexSubBuffersSize;views;currentView;lastRenderStart;lastRenderTime;constructor(){this.adapter={},this.device={},this.canvas={},this.ctx={},this.destinationTexture=null,this.normalsTexture={},this.idsTexture={},this.depthTexture={},this.commandEncoder={},this.passEncoder={},this.pipelines=new Map,this.vertexBuffer={},this.vertexSubBuffers=[],this.vertexSubBuffersSize=0,this.views=[],this.currentView=new Js,this.lastRenderStart=0,this.lastRenderTime=0}async initialize(){if(!navigator.gpu)throw c.FAIL("This browser does not support webgpu"),new Error("Gfx3Manager::Gfx3Manager: WebGPU cannot be initialized - navigator.gpu not found");if(this.adapter=await navigator.gpu.requestAdapter(),!this.adapter)throw c.FAIL("This browser appears to support WebGPU but it's disabled"),new Error("Gfx3Manager::Gfx3Manager: WebGPU cannot be initialized - Adapter not found");if(this.device=await this.adapter.requestDevice(),this.device.lost.then(()=>{throw new Error("Gfx3Manager::Gfx3Manager: WebGPU cannot be initialized - Device has been lost")}),this.canvas=document.getElementById("CANVAS_3D"),!this.canvas)throw new Error("Gfx3Manager::Gfx3Manager: CANVAS_3D not found");if(this.ctx=this.canvas.getContext("webgpu"),!this.ctx)throw new Error("Gfx3Manager::Gfx3Manager: WebGPU cannot be initialized - Canvas does not support WebGPU");this.ctx.configure({device:this.device,format:navigator.gpu.getPreferredCanvasFormat(),alphaMode:"opaque"});const t=window.devicePixelRatio||1;this.canvas.width=this.canvas.clientWidth*t,this.canvas.height=this.canvas.clientHeight*t,this.currentView=this.createView(),this.normalsTexture=this.createRenderingTexture("rgba16float"),this.idsTexture=this.createRenderingTexture("rgba16float"),this.depthTexture=this.createRenderingTexture("depth24plus"),this.vertexBuffer=this.device.createBuffer({size:0,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),m.subscribe(rs,"E_RESIZE",this,this.$handleWindowResize)}beginDrawing(){}endDrawing(){if(this.vertexSubBuffersSize>0&&this.vertexSubBuffersSize!=this.vertexBuffer.size){this.vertexBuffer.destroy(),this.vertexBuffer=this.device.createBuffer({size:this.vertexSubBuffersSize,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST});for(const t of this.vertexSubBuffers)this.device.queue.writeBuffer(this.vertexBuffer,t.offset,t.vertices),t.changed=!1;return}for(const t of this.vertexSubBuffers)t.changed&&(this.device.queue.writeBuffer(this.vertexBuffer,t.offset,t.vertices),t.changed=!1)}beginRender(){this.commandEncoder=this.device.createCommandEncoder(),this.lastRenderStart=Date.now()}beginPassRender(t){const e=this.views[t],s=e.getViewport(),i=this.canvas.width*s.xFactor,r=this.canvas.height*s.yFactor,n=this.canvas.width*s.widthFactor,a=this.canvas.height*s.heightFactor,h=e.getBgColor(),l=this.destinationTexture?this.destinationTexture.createView():this.ctx.getCurrentTexture().createView();this.passEncoder=this.commandEncoder.beginRenderPass({colorAttachments:[{view:l,clearValue:{r:h[0],g:h[1],b:h[2],a:h[3]},loadOp:"clear",storeOp:"store"},{view:this.normalsTexture.gpuTexture.createView(),clearValue:{r:0,g:0,b:1,a:1},loadOp:"clear",storeOp:"store"},{view:this.idsTexture.gpuTexture.createView(),clearValue:{r:0,g:0,b:0,a:1},loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{view:this.depthTexture.gpuTexture.createView(),depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"}}),this.currentView=e,this.passEncoder.setViewport(i,r,n,a,0,1),this.passEncoder.setScissorRect(i,r,n,a)}endPassRender(){this.passEncoder.end()}endRender(){this.device.queue.submit([this.commandEncoder.finish()]),this.lastRenderTime=Date.now()-this.lastRenderStart}loadPipeline(t,e,s,i){if(this.pipelines.has(t))return this.pipelines.get(t);i.vertex&&(i.vertex.module=this.device.createShaderModule({code:e})),i.fragment&&(i.fragment.module=this.device.createShaderModule({code:s}));const r=this.device.createRenderPipeline(i);return this.pipelines.set(t,r),r}deletePipeline(t){if(!this.pipelines.has(t))throw new Error("Gfx3Manager::deletePipeline(): pipeline not found !");this.pipelines.delete(t)}getPipeline(t){if(!this.pipelines.has(t))throw new Error("Gfx3Manager::getPipeline(): pipeline not found !");return this.pipelines.get(t)}createVertexBuffer(t){const e={vertices:new Float32Array(t),offset:this.vertexSubBuffersSize,changed:!1};return this.vertexSubBuffers.push(e),this.vertexSubBuffersSize+=t,e}destroyVertexBuffer(t){const e=this.vertexSubBuffers.indexOf(t);this.vertexSubBuffers.splice(e,1);for(const s of this.vertexSubBuffers)s.offset>t.offset&&(s.offset-=t.vertices.byteLength);this.vertexSubBuffersSize-=t.vertices.byteLength}writeVertexBuffer(t,e){t.vertices=new Float32Array(e),t.changed=!0}createStaticGroup(t,e){return new Jr(this.device,this.getPipeline(t),e)}createDynamicGroup(t,e){return new Qr(this.device,this.getPipeline(t),e)}createRenderingTexture(t=navigator.gpu.getPreferredCanvasFormat()){return this.createEmptyTexture(this.getWidth(),this.getHeight(),t,{magFilter:"nearest",minFilter:"nearest"})}createEmptyTexture(t,e,s,i={}){const r=this.device.createTexture({size:[t,e],format:s,usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT}),n=this.device.createSampler({magFilter:i.magFilter??"linear",minFilter:i.minFilter??"linear",addressModeU:i.addressModeU??"repeat",addressModeV:i.addressModeV??"repeat"});return{gpuTexture:r,gpuSampler:n}}createTextureFromBitmap(t,e=!1,s={}){if(!t){const n=document.createElement("canvas");n.getContext("2d"),n.width=1,n.height=1,t=n}const i=this.device.createTexture({size:[t.width,t.height],format:e?"r8unorm":"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT});this.device.queue.copyExternalImageToTexture({source:t},{texture:i},[t.width,t.height]);const r=this.device.createSampler({magFilter:s.magFilter??"linear",minFilter:s.minFilter??"linear",addressModeU:s.addressModeU??"repeat",addressModeV:s.addressModeV??"repeat"});return{gpuTexture:i,gpuSampler:r}}createCubeMapFromBitmap(t){if(!t||t.length==0){const i=document.createElement("canvas");i.getContext("2d"),i.width=1,i.height=1,t=[];for(let r=0;r<6;r++)t.push(i)}const e=this.device.createTexture({dimension:"2d",size:[t[0].width,t[0].height,6],format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT});for(let i=0;i<t.length;i++){const r=t[i];this.device.queue.copyExternalImageToTexture({source:r},{texture:e,origin:[0,0,i]},[r.width,r.height])}const s=this.device.createSampler({magFilter:"linear",minFilter:"linear"});return{gpuTexture:e,gpuSampler:s}}setFilter(t){this.canvas.style.filter=t}hasFilter(){return this.canvas.style.filter!=""&&this.canvas.style.filter!="none"}getClientWidth(){return this.canvas.clientWidth}getClientHeight(){return this.canvas.clientHeight}getWidth(){const t=window.devicePixelRatio||1;return this.canvas.clientWidth*t}getHeight(){const t=window.devicePixelRatio||1;return this.canvas.clientHeight*t}getContext(){return this.ctx}getDevice(){return this.device}setDestinationTexture(t){this.destinationTexture=t}getNormalsTexture(){return this.normalsTexture}getIdsTexture(){return this.idsTexture}getDepthTexture(){return this.depthTexture}getCurrentRenderingTexture(){return this.ctx.getCurrentTexture()}getCommandEncoder(){return this.commandEncoder}getPassEncoder(){return this.passEncoder}getView(t){return this.views[t]}getNumViews(){return this.views.length}createView(){const t=new Js;return t.setScreenSize(this.canvas.width,this.canvas.height),this.views.push(t),t}changeView(t,e){this.views[t]=e}removeView(t){this.views.splice(this.views.indexOf(t),1)}removeViewAt(t){this.views.splice(t,1)}getCurrentView(){return this.currentView}getVertexBuffer(){return this.vertexBuffer}getLastRenderTime(){return this.lastRenderTime}$handleWindowResize(){const t=window.devicePixelRatio||1;this.canvas.width=this.canvas.clientWidth*t,this.canvas.height=this.canvas.clientHeight*t,this.normalsTexture.gpuTexture.destroy(),this.normalsTexture=this.createRenderingTexture("rgba16float"),this.idsTexture.gpuTexture.destroy(),this.idsTexture=this.createRenderingTexture("rgba16float"),this.depthTexture.gpuTexture.destroy(),this.depthTexture=this.createRenderingTexture("depth24plus");for(const e of this.views)e.setScreenSize(this.canvas.width,this.canvas.height)}}const v=new tn;await v.initialize();class Kt{pipeline;constructor(t,e,s,i){this.pipeline=v.loadPipeline(t,e,s,i)}}const Yi=6,en={label:"Debug pipeline",layout:"auto",vertex:{entryPoint:"main",buffers:[{arrayStride:Yi*4,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:3*4,format:"float32x3"}]}]},fragment:{entryPoint:"main",targets:[{format:navigator.gpu.getPreferredCanvasFormat()},{format:"rgba16float"},{format:"rgba16float"}]},primitive:{topology:"line-list",cullMode:"back",frontFace:"ccw"},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth24plus"}},sn=`
struct VertexOutput {
  @builtin(position) Position: vec4<f32>,
  @location(0) Color: vec3<f32>
};

@binding(0) @group(0) var<uniform> MVPC_MATRIX: mat4x4<f32>;

@vertex
fn main(
  @location(0) Position: vec4<f32>,
  @location(1) Color: vec3<f32>
) -> VertexOutput {
  var output: VertexOutput;
  output.Position = MVPC_MATRIX * Position;
  output.Color = Color;
  return output;
}`,rn=`
struct FragOutput {
  @location(0) Base: vec4f,
  @location(1) Normal: vec4f,
  @location(2) Id: vec4f
}

@fragment
fn main(
  @location(0) Color: vec3<f32>
) -> FragOutput {
  var output: FragOutput;
  output.Base = vec4(Color, 1);
  output.Normal = vec4(0.0, 0.0, 0.0, 0.0);
  output.Id = vec4(0.0, 0.0, 0.0, 0.0);
  return output;
}`;class nn extends Kt{device;vertexBuffer;vertexCount;commands;showDebug;grp0;mvpcMatrix;constructor(){super("DEBUG_PIPELINE",sn,rn,en),this.device=v.getDevice(),this.vertexBuffer=this.device.createBuffer({size:0,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC}),this.vertexCount=0,this.commands=[],this.showDebug=!1,this.grp0=v.createDynamicGroup("DEBUG_PIPELINE",0),this.mvpcMatrix=this.grp0.setFloat(0,"MVPC_MATRIX",16),this.grp0.allocate()}render(){if(!this.showDebug)return;const t=v.getCurrentView(),e=v.getPassEncoder(),s=t.getViewProjectionClipMatrix();e.setPipeline(this.pipeline),this.vertexBuffer.destroy(),this.vertexBuffer=this.device.createBuffer({size:this.vertexCount*Yi*4,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC}),this.grp0.allocate(this.commands.length),this.grp0.beginWrite();for(let i=0,r=0;i<this.commands.length;i++){const n=this.commands[i];this.grp0.write(0,c.MAT4_MULTIPLY(s,n.matrix,this.mvpcMatrix)),e.setBindGroup(0,this.grp0.getBindGroup(i)),this.device.queue.writeBuffer(this.vertexBuffer,r,n.vertices),e.setVertexBuffer(0,this.vertexBuffer,r,n.vertices.byteLength),e.draw(n.vertexCount),r+=n.vertices.byteLength}this.grp0.endWrite(),this.commands=[],this.vertexCount=0}drawVertices(t,e,s){this.commands.push({vertices:new Float32Array(t),vertexCount:e,matrix:s}),this.vertexCount+=e}drawCylinder(t,e,s,i,r,n=[1,1,1]){let a=0;const h=[],l=Math.PI*2/i,u=0,d=0,p=0,E=0,T=s,A=0;for(let x=0;x<Math.PI*2;x+=l){const y=e*Math.cos(x),C=0,S=e*Math.sin(x)*-1,w=e*Math.cos(x+l),P=0,O=e*Math.sin(x+l)*-1,_=e*Math.cos(x),H=s,L=e*Math.sin(x)*-1,Z=e*Math.cos(x+l),X=s,K=e*Math.sin(x+l)*-1;h.push(y,C,S,n[0],n[1],n[2]),h.push(_,H,L,n[0],n[1],n[2]),h.push(y,C,S,n[0],n[1],n[2]),h.push(w,P,O,n[0],n[1],n[2]),h.push(_,H,L,n[0],n[1],n[2]),h.push(Z,X,K,n[0],n[1],n[2]),a+=6,r&&(h.push(u,d,p,n[0],n[1],n[2]),h.push(y,C,S,n[0],n[1],n[2]),h.push(E,T,A,n[0],n[1],n[2]),h.push(_,H,L,n[0],n[1],n[2]),a+=4)}this.commands.push({vertices:new Float32Array(h),vertexCount:a,matrix:t}),this.vertexCount+=a}drawGrid(t,e=3,s=1,i=[1,1,1]){let r=0;const n=[],a=e*2,h=a*s,l=-h*.5,u=-h*.5;for(let d=0;d<=a;d++){const p=l+d*s,E=u,T=0,A=l+d*s,x=u+h,y=0,C=l,S=u+d*s,w=0,P=l+h,O=u+d*s,_=0;n.push(p,E,T,i[0],i[1],i[2]),n.push(A,x,y,i[0],i[1],i[2]),n.push(C,S,w,i[0],i[1],i[2]),n.push(P,O,_,i[0],i[1],i[2]),r+=4}this.commands.push({vertices:new Float32Array(n),vertexCount:r,matrix:t}),this.vertexCount+=r}drawGizmo(t,e=1){let s=0;const i=[],r=[[1*e,0,0],[0,1*e,0],[0,0,1*e]],n=[[1,0,0],[0,1,0],[0,0,1]];for(let a=0;a<r.length;a++)i.push(0,0,0,n[a][0],n[a][1],n[a][2]),i.push(r[a][0],r[a][1],r[a][2],n[a][0],n[a][1],n[a][2]),s+=2;this.commands.push({vertices:new Float32Array(i),vertexCount:s,matrix:t}),this.vertexCount+=s}drawCircle(t,e=1,s=4,i=[1,1,1]){let r=0;const n=[],a=Math.PI*2/s;for(let h=0;h<s;h++){const l=Math.cos(h*a)*e,u=Math.sin(h*a)*e,d=0,p=Math.cos((h+1)*a)*e,E=Math.sin((h+1)*a)*e,T=0;n.push(l,u,d,i[0],i[1],i[2]),n.push(p,E,T,i[0],i[1],i[2]),r+=2}this.commands.push({vertices:new Float32Array(n),vertexCount:r,matrix:t}),this.vertexCount+=r}drawBoundingRect(t,e,s,i=[1,1,1]){let r=0;const n=[],a=[e[0],0,e[1]],h=[e[0],0,s[1]],l=[s[0],0,e[1]],u=[s[0],0,s[1]];n.push(a[0],a[1],a[2],i[0],i[1],i[2]),n.push(h[0],h[1],h[2],i[0],i[1],i[2]),r+=2,n.push(h[0],h[1],h[2],i[0],i[1],i[2]),n.push(u[0],u[1],u[2],i[0],i[1],i[2]),r+=2,n.push(u[0],u[1],u[2],i[0],i[1],i[2]),n.push(l[0],l[1],l[2],i[0],i[1],i[2]),r+=2,n.push(l[0],l[1],l[2],i[0],i[1],i[2]),n.push(a[0],a[1],a[2],i[0],i[1],i[2]),r+=2,this.commands.push({vertices:new Float32Array(n),vertexCount:r,matrix:t}),this.vertexCount+=r}drawSphere(t,e=1,s=4,i=[1,1,1]){let r=0;const n=[],a=[],h=Math.PI*.5/s;for(let l=-s;l<=s;l++){const u=Math.cos(l*h)*e,d=Math.sin(l*h)*e;for(let p=0;p<=s*4;p++){const E=Math.sin(p*h)*u,T=Math.cos(p*h)*u;a.push([T,d,E])}}for(let l=-s;l<=s;l++)for(let u=0;u<=s*4;u++){const d=Math.cos(u*h)*e*Math.cos(l*h),p=Math.sin(u*h)*e,E=Math.cos(u*h)*e*Math.sin(l*h);a.push([d,p,E])}for(let l=0;l<a.length-1;l++)n.push(a[l][0],a[l][1],a[l][2],i[0],i[1],i[2]),n.push(a[l+1][0],a[l+1][1],a[l+1][2],i[0],i[1],i[2]),r+=2;this.commands.push({vertices:new Float32Array(n),vertexCount:r,matrix:t}),this.vertexCount+=r}drawBoundingBox(t,e,s,i=[1,1,1]){let r=0;const n=[],a=[e[0],e[1],e[2]],h=[s[0],e[1],e[2]],l=[s[0],s[1],e[2]],u=[e[0],s[1],e[2]],d=[e[0],s[1],s[2]],p=[s[0],s[1],s[2]],E=[s[0],e[1],s[2]],T=[e[0],e[1],s[2]];n.push(a[0],a[1],a[2],i[0],i[1],i[2]),n.push(h[0],h[1],h[2],i[0],i[1],i[2]),n.push(T[0],T[1],T[2],i[0],i[1],i[2]),n.push(E[0],E[1],E[2],i[0],i[1],i[2]),r+=4,n.push(u[0],u[1],u[2],i[0],i[1],i[2]),n.push(l[0],l[1],l[2],i[0],i[1],i[2]),n.push(d[0],d[1],d[2],i[0],i[1],i[2]),n.push(p[0],p[1],p[2],i[0],i[1],i[2]),r+=4,n.push(a[0],a[1],a[2],i[0],i[1],i[2]),n.push(u[0],u[1],u[2],i[0],i[1],i[2]),n.push(T[0],T[1],T[2],i[0],i[1],i[2]),n.push(d[0],d[1],d[2],i[0],i[1],i[2]),r+=4,n.push(h[0],h[1],h[2],i[0],i[1],i[2]),n.push(l[0],l[1],l[2],i[0],i[1],i[2]),n.push(E[0],E[1],E[2],i[0],i[1],i[2]),n.push(p[0],p[1],p[2],i[0],i[1],i[2]),r+=4,n.push(u[0],u[1],u[2],i[0],i[1],i[2]),n.push(d[0],d[1],d[2],i[0],i[1],i[2]),n.push(l[0],l[1],l[2],i[0],i[1],i[2]),n.push(p[0],p[1],p[2],i[0],i[1],i[2]),r+=4,n.push(a[0],a[1],a[2],i[0],i[1],i[2]),n.push(T[0],T[1],T[2],i[0],i[1],i[2]),n.push(h[0],h[1],h[2],i[0],i[1],i[2]),n.push(E[0],E[1],E[2],i[0],i[1],i[2]),r+=4,this.commands.push({vertices:new Float32Array(n),vertexCount:r,matrix:t}),this.vertexCount+=r}isShowDebug(){return this.showDebug}setShowDebug(t){this.showDebug=t}}const dt=new nn,F=17,vs=64,xs=64,on={label:"Mesh pipeline",layout:"auto",vertex:{entryPoint:"main",buffers:[{arrayStride:F*4,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:3*4,format:"float32x2"},{shaderLocation:2,offset:5*4,format:"float32x3"},{shaderLocation:3,offset:8*4,format:"float32x3"},{shaderLocation:4,offset:11*4,format:"float32x3"},{shaderLocation:5,offset:14*4,format:"float32x3"}]}]},fragment:{entryPoint:"main",targets:[{format:navigator.gpu.getPreferredCanvasFormat(),blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha",operation:"add"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"}}},{format:"rgba16float"},{format:"rgba16float"}]},primitive:{topology:"triangle-list",cullMode:"back",frontFace:"ccw"},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth24plus"}},an=`
struct MeshMatrices {
  MVPC_MATRIX: mat4x4<f32>,
  M_MATRIX: mat4x4<f32>,
  NORM_MATRIX: mat3x3<f32>
}

struct VertexOutput {
  @builtin(position) Position: vec4<f32>,
  @location(0) FragPos: vec3<f32>,
  @location(1) FragUV: vec2<f32>,
  @location(2) FragColor: vec3<f32>,
  @location(3) FragNormal: vec3<f32>,
  @location(4) FragTangent: vec3<f32>,
  @location(5) FragBinormal: vec3<f32>,
  @location(6) FragShadowPos: vec3<f32>
}

@group(0) @binding(7) var<uniform> LVP_MATRIX: mat4x4<f32>;
@group(1) @binding(0) var<uniform> MESH_MATRICES: MeshMatrices;

@vertex
fn main(
  @location(0) Position: vec4<f32>,
  @location(1) TexUV: vec2<f32>,
  @location(2) Color: vec3<f32>,
  @location(3) Normal: vec3<f32>,
  @location(4) Tangent: vec3<f32>,
  @location(5) Binormal: vec3<f32>
) -> VertexOutput {
  var posFromLight = LVP_MATRIX * MESH_MATRICES.M_MATRIX * Position; // XY is in (-1, 1) space, Z is in (0, 1) space

  var output: VertexOutput;
  output.Position = MESH_MATRICES.MVPC_MATRIX * Position;
  output.FragPos = vec4(MESH_MATRICES.M_MATRIX * Position).xyz;
  output.FragUV = TexUV;
  output.FragColor = Color;
  output.FragNormal = MESH_MATRICES.NORM_MATRIX * Normal;
  output.FragTangent = MESH_MATRICES.NORM_MATRIX * Tangent;
  output.FragBinormal = MESH_MATRICES.NORM_MATRIX * Binormal;
  output.FragShadowPos = vec3(posFromLight.xy * vec2(0.5, -0.5) + vec2(0.5), posFromLight.z); // Convert XY to (0, 1) and Y is flipped because texture coords are Y-down.
  return output;
}`,hn=`
struct FragOutput {
  @location(0) Base: vec4f,
  @location(1) Normal: vec4f,
  @location(2) Id: vec4f
}

struct MaterialColors {
  EMISSIVE: vec3<f32>,
  AMBIENT: vec3<f32>,
  DIFFUSE: vec3<f32>,
  SPECULAR: vec3<f32>
}

struct MaterialParams {
  OPACITY: f32,
  NORMAL_INTENSITY: f32,
  HAS_LIGHTNING: f32,
  HAS_TEXTURE: f32,
  HAS_DISPLACEMENT_MAP: f32,
  DISPLACEMENT_MAP_FACTOR: f32,
  HAS_DIFFUSE_MAP: f32,
  HAS_SPECULAR_MAP: f32,
  HAS_EMISSIVE_MAP: f32,
  HAS_NORMAL_MAP: f32,
  HAS_ENV_MAP: f32,
  HAS_DECAL: f32,
  HAS_SHADOW: f32,
  SHININESS: f32,
  EMISSIVE_FACTOR: f32
}

struct MaterialUvs {
  TEXTURE_SCROLL: vec2<f32>,
  TEXTURE_OFFSET: vec2<f32>,
  DISPLACEMENT_MAP_SCROLL: vec2<f32>
}

struct PointLight {
  POSITION: vec3<f32>,
  AMBIENT: vec3<f32>,
  DIFFUSE: vec3<f32>,
  SPECULAR: vec3<f32>,
  ATTEN: vec3<f32>,
  INTENSITY: f32
}

struct DirLight {
  DIR: vec3<f32>,
  ENABLED: f32,
  AMBIENT: vec3<f32>,
  DIFFUSE: vec3<f32>,
  SPECULAR: vec3<f32>,
  INTENSITY: f32
}

struct Fog {
  ENABLED: f32,
  NEAR: f32,
  FAR: f32,
  COLOR: vec3<f32>
}

struct Decal {
  VP_MATRIX: mat4x4<f32>,
  TEXTURE_LEFT: f32,
  TEXTURE_TOP: f32,
  TEXTURE_WIDTH: f32,
  TEXTURE_HEIGHT: f32,
  ASPECT_RATIO: vec2<f32>,
  OPACITY: f32,
  LAYER: f32
}

@group(0) @binding(0) var<uniform> CAMERA_POS: vec3<f32>;
@group(0) @binding(1) var<uniform> DIR_LIGHT: DirLight;
@group(0) @binding(2) var<uniform> FOG: Fog;
@group(0) @binding(3) var<uniform> POINT_LIGHT_COUNT: u32;
@group(0) @binding(4) var<uniform> POINT_LIGHTS: array<PointLight, ${vs}>;
@group(0) @binding(5) var<uniform> DECAL_COUNT: u32;
@group(0) @binding(6) var<uniform> DECALS: array<Decal, ${xs}>;
@group(0) @binding(8) var DECAL_ATLAS_TEXTURE: texture_2d<f32>;
@group(0) @binding(9) var DECAL_ATLAS_SAMPLER: sampler;
@group(0) @binding(10) var SHADOW_MAP_TEXTURE: texture_depth_2d;
@group(0) @binding(11) var SHADOW_MAP_SAMPLER: sampler_comparison;
@group(1) @binding(1) var<uniform> MESH_LAYER: f32;
@group(1) @binding(2) var<uniform> MESH_ID: vec4<f32>;
@group(2) @binding(0) var<uniform> MAT_COLORS: MaterialColors;
@group(2) @binding(1) var<uniform> MAT_PARAMS: MaterialParams;
@group(2) @binding(2) var<uniform> MAT_UVS: MaterialUvs;
@group(3) @binding(0) var MAT_TEXTURE: texture_2d<f32>;
@group(3) @binding(1) var MAT_SAMPLER: sampler;
@group(3) @binding(2) var MAT_DISPLACEMENT_TEXTURE: texture_2d<f32>;
@group(3) @binding(3) var MAT_DISPLACEMENT_SAMPLER: sampler;
@group(3) @binding(4) var MAT_DIFFUSE_TEXTURE: texture_2d<f32>;
@group(3) @binding(5) var MAT_DIFFUSE_SAMPLER: sampler;
@group(3) @binding(6) var MAT_SPECULAR_TEXTURE: texture_2d<f32>;
@group(3) @binding(7) var MAT_SPECULAR_SAMPLER: sampler;
@group(3) @binding(8) var MAT_EMISSIVE_TEXTURE: texture_2d<f32>;
@group(3) @binding(9) var MAT_EMISSIVE_SAMPLER: sampler;
@group(3) @binding(10) var MAT_NORM_TEXTURE: texture_2d<f32>;
@group(3) @binding(11) var MAT_NORM_SAMPLER: sampler;
@group(3) @binding(12) var MAT_ENV_MAP_TEXTURE: texture_cube<f32>;
@group(3) @binding(13) var MAT_ENV_MAP_SAMPLER: sampler;

@fragment
fn main(
  @builtin(position) Position: vec4<f32>,
  @location(0) FragPos: vec3<f32>,
  @location(1) FragUV: vec2<f32>,
  @location(2) FragColor: vec3<f32>,
  @location(3) FragNormal: vec3<f32>,
  @location(4) FragTangent: vec3<f32>,
  @location(5) FragBinormal: vec3<f32>,
  @location(6) FragShadowPos: vec3<f32>
) -> FragOutput {
  var normal = normalize(FragNormal);
  var outputColor = vec4(0.0, 0.0, 0.0, 1.0);
  var texel = vec4(1.0, 1.0, 1.0, 1.0);
  var textureUV = MAT_UVS.TEXTURE_SCROLL + MAT_UVS.TEXTURE_OFFSET + FragUV;

  if (MAT_PARAMS.HAS_DISPLACEMENT_MAP == 1.0)
  {
    textureUV += CalcDisplacementMap(FragUV);
  }

  if (MAT_PARAMS.HAS_TEXTURE == 1.0)
  {
    texel = textureSample(MAT_TEXTURE, MAT_SAMPLER, textureUV) * vec4<f32>(FragColor, 1.0);
  }

  if (texel.a == 0)
  {
    discard;
  }

  if (MAT_PARAMS.HAS_DECAL == 1.0)
  {
    var decalsColor = vec4(0.0, 0.0, 0.0, 0.0);
    for (var i: u32 = 0; i < DECAL_COUNT; i++)
    {
      if (MESH_LAYER == DECALS[i].LAYER)
      {
        decalsColor += CalcDecal(i, FragPos);
      }
    }

    var alpha = min(texel.a + decalsColor.a, 1.0);
    texel = mix(texel, decalsColor, decalsColor.a);
    texel.a = alpha;
  }

  if (MAT_PARAMS.HAS_NORMAL_MAP == 1.0)
  {
    normal = CalcNormalMap(normal, FragTangent, FragBinormal, textureUV);
  }

  if (MAT_PARAMS.HAS_LIGHTNING == 1.0)
  {
    var totalLight = vec4(0.0, 0.0, 0.0, 0.0);
    var shadow = 1.0;
    
    if (MAT_PARAMS.HAS_SHADOW == 1.0)
    {
      shadow = CalcShadow(FragShadowPos);
    }

    if (DIR_LIGHT.ENABLED == 1.0)
    {
      totalLight += CalcDirLight(normal, FragPos, textureUV, shadow);
    }

    for (var i: u32 = 0; i < POINT_LIGHT_COUNT; i++)
    {
      totalLight += CalcPointLight(i, normal, FragPos, textureUV, shadow);
    }

    outputColor = texel * totalLight;
  }
  else
  {
    outputColor = texel;
  }

  if (MAT_PARAMS.HAS_ENV_MAP == 1.0)
  {
    outputColor += CalcEnvMap(normal, FragPos);
  }

  if (FOG.ENABLED == 1.0)
  {
    outputColor = CalcFog(outputColor.rgb, texel.a * MAT_PARAMS.OPACITY, FragPos);
  }
  else
  {
    outputColor = vec4(outputColor.rgb, texel.a * MAT_PARAMS.OPACITY);
  }

  var output: FragOutput;
  output.Base = outputColor;
  output.Normal = vec4(normalize(FragNormal), 1.0);
  output.Id = MESH_ID;
  return output;
}

// *****************************************************************************************************************
// CALC FOG
// *****************************************************************************************************************
fn CalcFog(inputColor: vec3<f32>, inputAlpha: f32, fragPos: vec3<f32>) -> vec4<f32>
{
  var fogColor = FOG.COLOR;
  var fogStart = FOG.NEAR;
  var fogEnd = FOG.FAR;
  var fogDist = length(CAMERA_POS - fragPos);
  var fogFactor = clamp((fogEnd - fogDist) / (fogEnd - fogStart), 0.0, 1.0);
  var outputColor = (fogColor * (1.0 - fogFactor)) + (inputColor * fogFactor);
  var outputAlpha = mix(inputAlpha, 1.0, fogFactor);
  return vec4<f32>(outputColor, outputAlpha);
}

// *****************************************************************************************************************
// CALC DECAL
// *****************************************************************************************************************
fn CalcDecal(index: u32, fragPos: vec3<f32>) -> vec4<f32>
{
  var ctrlColor = vec4(1.0, 1.0, 1.0, 1.0);
  var clipPos = DECALS[index].VP_MATRIX * vec4<f32>(fragPos, 1.0);
  if (clipPos.z < -1.0 || clipPos.z > 1.0)
  {
    ctrlColor = vec4(0.0, 0.0, 0.0, 0.0);
  }

  var ndcPos = vec3<f32>(clipPos.xyz / clipPos.w).xy * DECALS[index].ASPECT_RATIO;
  if (ndcPos.x < -1.0 || ndcPos.x > 1.0 || ndcPos.y < -1.0 || ndcPos.y > 1.0)
  {
    ctrlColor = vec4(0.0, 0.0, 0.0, 0.0);
  }

  var uvx = ndcPos.x * 0.5 + 0.5;
  uvx = (uvx * DECALS[index].TEXTURE_WIDTH) + DECALS[index].TEXTURE_LEFT;

  var uvy = 1.0 - (ndcPos.y * 0.5 + 0.5);
  uvy = (uvy * DECALS[index].TEXTURE_HEIGHT) + DECALS[index].TEXTURE_TOP;

  var texColor = textureSample(DECAL_ATLAS_TEXTURE, DECAL_ATLAS_SAMPLER, vec2<f32>(uvx, uvy));
  texColor.a = max(texColor.a - (1.0 - DECALS[index].OPACITY), 0.0);
  return texColor * ctrlColor;
}

// *****************************************************************************************************************
// CALC NORMAL MAP
// *****************************************************************************************************************
fn CalcNormalMap(normal: vec3<f32>, fragTangent: vec3<f32>, fragBinormal: vec3<f32>, textureUV: vec2<f32>) -> vec3<f32>
{
  var normalIntensity = vec4<f32>(MAT_PARAMS.NORMAL_INTENSITY, MAT_PARAMS.NORMAL_INTENSITY, 1, 1);
  var normalPixel = textureSample(MAT_NORM_TEXTURE, MAT_NORM_SAMPLER, textureUV) * normalIntensity;
  return normalize(normalize(fragTangent) * normalPixel.x + normalize(fragBinormal) * normalPixel.y + normal * normalPixel.z);
}

// *****************************************************************************************************************
// CALC ENV MAP
// *****************************************************************************************************************
fn CalcEnvMap(normal: vec3<f32>, fragPos: vec3<f32>) -> vec4<f32>
{
  var viewDir = normalize(CAMERA_POS - fragPos);
  var rvec = normalize(reflect(viewDir, normal));
  return textureSample(MAT_ENV_MAP_TEXTURE, MAT_ENV_MAP_SAMPLER, vec3<f32>(rvec.x, rvec.y, rvec.z));
}

// *****************************************************************************************************************
// CALC DISPLACEMENT MAP
// *****************************************************************************************************************
fn CalcDisplacementMap(fragUV: vec2<f32>) -> vec2<f32>
{
  var textureUV = MAT_UVS.DISPLACEMENT_MAP_SCROLL + fragUV;
  var offset = vec2(0.0, 0.0);
  var greyScale = textureSample(MAT_DISPLACEMENT_TEXTURE, MAT_DISPLACEMENT_SAMPLER, textureUV).r;
  offset.x = clamp(MAT_PARAMS.DISPLACEMENT_MAP_FACTOR * ((greyScale * 2) - 1), 0.0, 1.0);
  offset.y = clamp(MAT_PARAMS.DISPLACEMENT_MAP_FACTOR * ((greyScale * 2) - 1), 0.0, 1.0);
  return offset;
}

// *****************************************************************************************************************
// CALC LIGHT INTERNAL
// *****************************************************************************************************************
fn CalcLightInternal(lightDir: vec3<f32>, lightAmbient: vec3<f32>, lightDiffuse: vec3<f32>, lightSpecular: vec3<f32>, lightIntensity: f32, normal: vec3<f32>, fragPos: vec3<f32>, textureUV: vec2<f32>, shadow: f32) -> vec4<f32>
{
  var ambientColor = lightAmbient * lightIntensity * MAT_COLORS.AMBIENT; // change for lightambiantintensity
  var diffuseColor = vec3(0.0, 0.0, 0.0);
  var specularColor = vec3(0.0, 0.0, 0.0);
  var emissiveColor = vec3(0.0, 0.0, 0.0);
  var matDiffuse = MAT_COLORS.DIFFUSE;
  var matSpecular = MAT_COLORS.SPECULAR;
  var matEmissive = MAT_COLORS.EMISSIVE * MAT_PARAMS.EMISSIVE_FACTOR;

  var diffuseFactor = max(dot(normal, -lightDir), 0.0);

  if (MAT_PARAMS.HAS_DIFFUSE_MAP == 1.0)
  {
    matDiffuse = textureSample(MAT_DIFFUSE_TEXTURE, MAT_DIFFUSE_SAMPLER, textureUV).rgb;
  }

  if (MAT_PARAMS.HAS_SPECULAR_MAP == 1.0)
  {
    matSpecular = textureSample(MAT_SPECULAR_TEXTURE, MAT_SPECULAR_SAMPLER, textureUV).rgb;
  }

  if (MAT_PARAMS.HAS_EMISSIVE_MAP == 1.0)
  {
    matEmissive = textureSample(MAT_EMISSIVE_TEXTURE, MAT_EMISSIVE_SAMPLER, textureUV).rgb * MAT_PARAMS.EMISSIVE_FACTOR;
  }

  if (diffuseFactor > 0.0)
  {
    diffuseColor = lightDiffuse * lightIntensity * matDiffuse * diffuseFactor;
    if (MAT_PARAMS.SHININESS > 0.0)
    {
      var reflectDir = reflect(lightDir, normal);
      var viewDir = normalize(CAMERA_POS - fragPos);
      var specularFactor = max(dot(viewDir, reflectDir), 0.0);
      if (specularFactor > 0.0)
      {
        specularFactor = pow(specularFactor, MAT_PARAMS.SHININESS);
        specularColor = lightSpecular * lightIntensity * matSpecular * specularFactor;
      }
    }
  }

  if (specularColor.r > 0.0)
  {
    emissiveColor = matEmissive;
  }

  return vec4(ambientColor + (diffuseColor * shadow) + (specularColor * shadow) + emissiveColor, 1.0);
}

// *****************************************************************************************************************
// CALC DIR LIGHT
// *****************************************************************************************************************
fn CalcDirLight(normal: vec3<f32>, fragPos: vec3<f32>, textureUV: vec2<f32>, shadow: f32) -> vec4<f32>
{
  return CalcLightInternal(normalize(DIR_LIGHT.DIR), DIR_LIGHT.AMBIENT, DIR_LIGHT.DIFFUSE, DIR_LIGHT.SPECULAR, DIR_LIGHT.INTENSITY, normal, fragPos, textureUV, shadow);
}

// *****************************************************************************************************************
// CALC POINT LIGHT
// *****************************************************************************************************************
fn CalcPointLight(index: u32, normal: vec3<f32>, fragPos: vec3<f32>, textureUV: vec2<f32>, shadow: f32) -> vec4<f32>
{
  var lightDir = fragPos - POINT_LIGHTS[index].POSITION;
  var distance = length(lightDir);
  lightDir = normalize(lightDir);

  var color = CalcLightInternal(lightDir, POINT_LIGHTS[index].AMBIENT, POINT_LIGHTS[index].DIFFUSE, POINT_LIGHTS[index].SPECULAR, POINT_LIGHTS[index].INTENSITY, normal, fragPos, textureUV, shadow);
  var attenuation = POINT_LIGHTS[index].ATTEN[0] + POINT_LIGHTS[index].ATTEN[1] * distance + POINT_LIGHTS[index].ATTEN[2] * distance * distance;
  return color / attenuation;
}

// *****************************************************************************************************************
// CALC SHADOW
// *****************************************************************************************************************
fn CalcShadow(fragShadowPos: vec3<f32>) -> f32
{
  var visibility = 0.0;
  var shadowDepthTextureSize = f32(textureDimensions(SHADOW_MAP_TEXTURE).x);
  var oneOverShadowDepthTextureSize = 1.0 / shadowDepthTextureSize;

  for (var y = -1; y <= 1; y++)
  {
    for (var x = -1; x <= 1; x++)
    {
      var offset = vec2<f32>(vec2(x, y)) * oneOverShadowDepthTextureSize;
      visibility += textureSampleCompare(SHADOW_MAP_TEXTURE, SHADOW_MAP_SAMPLER, fragShadowPos.xy + offset, fragShadowPos.z - 0.007);
    }
  }

  return visibility / 9.0;
}`,ln={label:"Mesh Shadow pipeline",layout:"auto",vertex:{entryPoint:"main",buffers:[{arrayStride:F*4,attributes:[{shaderLocation:0,offset:0,format:"float32x3"}]}]},primitive:{topology:"triangle-list",cullMode:"back",frontFace:"ccw"},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth32float"}},cn=`
@group(0) @binding(0) var<uniform> LVP_MATRIX: mat4x4<f32>;
@group(0) @binding(1) var<uniform> M_MATRIX: mat4x4<f32>;

@vertex
fn main(
  @location(0) position: vec3<f32>
) -> @builtin(position) vec4<f32> {
  return LVP_MATRIX * M_MATRIX * vec4(position, 1.0);
}`;class un{pipeline;depthTextureSize;depthTexture;depthTextureSampler;depthTextureView;meshCommands;grp0;lvpMatrix;mMatrix;constructor(){this.pipeline=v.loadPipeline("MESH_SHADOW_PIPELINE",cn,"",ln),this.depthTextureSize=1024,this.depthTexture=v.getDevice().createTexture({size:[this.depthTextureSize,this.depthTextureSize,1],usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING,format:"depth32float"}),this.depthTextureView=this.depthTexture.createView(),this.depthTextureSampler=v.getDevice().createSampler({compare:"less"}),this.meshCommands=[],this.grp0=v.createDynamicGroup("MESH_SHADOW_PIPELINE",0),this.lvpMatrix=this.grp0.setFloat(0,"LVP_MATRIX",16),this.mMatrix=this.grp0.setFloat(1,"M_MATRIX",16)}render(){const e=v.getCommandEncoder().beginRenderPass({colorAttachments:[],depthStencilAttachment:{view:this.depthTextureView,depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"}});e.setPipeline(this.pipeline),this.grp0.getSize()<this.meshCommands.length&&this.grp0.allocate(this.meshCommands.length),this.grp0.beginWrite();for(let s=0;s<this.meshCommands.length;s++){const i=this.meshCommands[s],r=i.matrix?i.matrix:i.mesh.getTransformMatrix();this.grp0.write(0,this.lvpMatrix),this.grp0.write(1,c.MAT4_COPY(r,this.mMatrix)),e.setBindGroup(0,this.grp0.getBindGroup(s)),e.setVertexBuffer(0,v.getVertexBuffer(),i.mesh.getVertexSubBufferOffset(),i.mesh.getVertexSubBufferSize()),e.draw(i.mesh.getVertexCount())}this.grp0.endWrite(),this.meshCommands=[],e.end()}drawMesh(t,e=null){this.meshCommands.push({mesh:t,matrix:e})}setShadowProjection(t,e,s=600,i=200){const r=c.MAT4_ORTHOGRAPHIC(s,s,i),n=c.MAT4_INVERT(c.MAT4_LOOKAT(t,e,[0,1,0]));c.MAT4_MULTIPLY(r,n,this.lvpMatrix)}setDepthTextureSize(t){this.depthTexture=v.getDevice().createTexture({size:[t,t,1],usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING,format:"depth32float"}),this.depthTextureView=this.depthTexture.createView(),this.depthTextureSampler=v.getDevice().createSampler({compare:"less"}),this.depthTextureSize=t}getDepthTexture(){return{gpuTexture:this.depthTexture,gpuSampler:this.depthTextureSampler}}getLVPMatrix(){return this.lvpMatrix}}const pe=new un;class dn extends Kt{shadowEnabled;decalAtlasChanged;meshCommands;grp0;camPos;dirLight;fog;pointLightCount;pointLights;decalCount;decals;lvpMatrix;decalAtlas;shadowMap;grp1;meshMatrices;meshLayer;meshId;constructor(){super("MESH_PIPELINE",an,hn,on),this.shadowEnabled=!1,this.decalAtlasChanged=!1,this.meshCommands=[],this.grp0=v.createStaticGroup("MESH_PIPELINE",0),this.camPos=this.grp0.setFloat(0,"CAM_POS",3),this.dirLight=this.grp0.setFloat(1,"DIR_LIGHT",16),this.fog=this.grp0.setFloat(2,"FOG",8),this.pointLightCount=this.grp0.setInteger(3,"POINT_LIGHT_COUNT",1),this.pointLights=this.grp0.setFloat(4,"POINT_LIGHTS",20*vs),this.decalCount=this.grp0.setInteger(5,"DECAL_COUNT",1),this.decals=this.grp0.setFloat(6,"DECALS",24*xs),this.lvpMatrix=this.grp0.setFloat(7,"LVP_MATRIX",16),this.decalAtlas=this.grp0.setTexture(8,"DECAL_ATLAS_TEXTURE",v.createTextureFromBitmap()),this.decalAtlas=this.grp0.setSampler(9,"DECAL_ATLAS_SAMPLER",this.decalAtlas),this.shadowMap=this.grp0.setTexture(10,"SHADOW_MAP_TEXTURE",pe.getDepthTexture()),this.shadowMap=this.grp0.setSampler(11,"SHADOW_MAP_SAMPLER",this.shadowMap),this.grp1=v.createDynamicGroup("MESH_PIPELINE",1),this.meshMatrices=this.grp1.setFloat(0,"MESH_MATRICES",16*3),this.meshLayer=this.grp1.setInteger(1,"MESH_LAYER",1),this.meshId=this.grp1.setFloat(2,"MESH_ID",4),this.grp0.allocate(),this.grp1.allocate()}render(){const t=v.getCurrentView(),e=v.getPassEncoder(),s=t.getViewProjectionClipMatrix();e.setPipeline(this.pipeline),this.decalAtlasChanged&&(this.grp0.setTexture(8,"DECAL_ATLAS_TEXTURE",this.decalAtlas),this.grp0.allocate(),this.decalAtlasChanged=!1),this.shadowEnabled&&(this.grp0.setTexture(10,"SHADOW_MAP_TEXTURE",pe.getDepthTexture()),this.grp0.allocate()),this.grp0.beginWrite(),this.grp0.write(0,c.VEC3_COPY(t.getCameraPosition(),this.camPos)),this.grp0.write(1,this.dirLight),this.grp0.write(2,this.fog),this.grp0.write(3,this.pointLightCount),this.grp0.write(4,this.pointLights),this.grp0.write(5,this.decalCount),this.grp0.write(6,this.decals),this.grp0.write(7,pe.getLVPMatrix()),this.grp0.endWrite(),e.setBindGroup(0,this.grp0.getBindGroup()),this.grp1.getSize()<this.meshCommands.length&&this.grp1.allocate(this.meshCommands.length),this.grp1.beginWrite();for(let i=0;i<this.meshCommands.length;i++){const r=this.meshCommands[i],n=r.matrix?r.matrix:r.mesh.getTransformMatrix();this.grp1.write(0,pn(s,n,this.meshMatrices)),this.grp1.write(1,c.VEC1_COPY(r.mesh.getLayer(),this.meshLayer)),this.grp1.write(2,c.VEC4_COPY(r.mesh.getId(),this.meshId)),e.setBindGroup(1,this.grp1.getBindGroup(i));const a=r.mesh.getMaterial(),h=a.getGroup02(),l=a.getGroup03();e.setBindGroup(2,h.getBindGroup()),e.setBindGroup(3,l.getBindGroup()),e.setVertexBuffer(0,v.getVertexBuffer(),r.mesh.getVertexSubBufferOffset(),r.mesh.getVertexSubBufferSize()),e.draw(r.mesh.getVertexCount())}this.grp1.endWrite(),this.dirLight.fill(0),this.pointLightCount[0]=0,this.pointLights.fill(0),this.decalCount[0]=0,this.decals.fill(0),this.meshCommands=[]}enableShadow(t){this.shadowEnabled=t}setDecalAtlas(t){this.decalAtlas=t,this.decalAtlasChanged=!0}enableFog(t,e=[.5,.5,.5],s=3,i=15){this.fog[0]=t?1:0,this.fog[1]=s,this.fog[2]=i,this.fog[3]=0,this.fog[4]=e[0],this.fog[5]=e[1],this.fog[6]=e[2],this.fog[7]=0}drawMesh(t,e=null){this.meshCommands.push({mesh:t,matrix:e}),this.shadowEnabled&&t.getShadowCasting()&&pe.drawMesh(t,e)}drawDirLight(t,e,s,i,r=1){this.dirLight[0]=t[0],this.dirLight[1]=t[1],this.dirLight[2]=t[2],this.dirLight[3]=1,this.dirLight[4]=e[0],this.dirLight[5]=e[1],this.dirLight[6]=e[2],this.dirLight[7]=0,this.dirLight[8]=s[0],this.dirLight[9]=s[1],this.dirLight[10]=s[2],this.dirLight[11]=0,this.dirLight[12]=i[0],this.dirLight[13]=i[1],this.dirLight[14]=i[2],this.dirLight[15]=r}drawPointLight(t,e,s,i,r=1,n=1,a=0,h=0){const l=this.pointLightCount[0];if(l>=vs)throw new Error("Gfx3MeshRenderer::drawPointLight(): Max point lights number exceeded !");this.pointLights[l*20+0]=t[0],this.pointLights[l*20+1]=t[1],this.pointLights[l*20+2]=t[2],this.pointLights[l*20+3]=0,this.pointLights[l*20+4]=e[0],this.pointLights[l*20+5]=e[1],this.pointLights[l*20+6]=e[2],this.pointLights[l*20+7]=0,this.pointLights[l*20+8]=s[0],this.pointLights[l*20+9]=s[1],this.pointLights[l*20+10]=s[2],this.pointLights[l*20+11]=0,this.pointLights[l*20+12]=i[0],this.pointLights[l*20+13]=i[1],this.pointLights[l*20+14]=i[2],this.pointLights[l*20+15]=0,this.pointLights[l*20+16]=n,this.pointLights[l*20+17]=a,this.pointLights[l*20+18]=h,this.pointLights[l*20+19]=r,this.pointLightCount[0]++}drawDecal(t,e,s,i,r,n,a,h,l,u,d){const p=this.decalCount[0];if(p>=xs)throw new Error("Gfx3MeshRenderer::drawDecal(): Max decals number exceeded !");const E=[a[0],a[1],a[2],0,h[0],h[1],h[2],0,l[0],l[1],l[2],0,n[0],n[1],n[2],1],T=[i>r?1:r/i,i>r?i/r:1],A=c.MAT4_INVERT(E),x=c.MAT4_ORTHOGRAPHIC(u[0],u[1],u[2]),y=c.MAT4_MULTIPLY(A,x);this.decals[p*24+0]=y[0],this.decals[p*24+1]=y[1],this.decals[p*24+2]=y[2],this.decals[p*24+3]=y[3],this.decals[p*24+4]=y[4],this.decals[p*24+5]=y[5],this.decals[p*24+6]=y[6],this.decals[p*24+7]=y[7],this.decals[p*24+8]=y[8],this.decals[p*24+9]=y[9],this.decals[p*24+10]=y[10],this.decals[p*24+11]=y[11],this.decals[p*24+12]=y[12],this.decals[p*24+13]=y[13],this.decals[p*24+14]=y[14],this.decals[p*24+15]=y[15],this.decals[p*24+16]=e/this.decalAtlas.gpuTexture.width,this.decals[p*24+17]=s/this.decalAtlas.gpuTexture.height,this.decals[p*24+18]=i/this.decalAtlas.gpuTexture.width,this.decals[p*24+19]=r/this.decalAtlas.gpuTexture.height,this.decals[p*24+20]=T[0],this.decals[p*24+21]=T[1],this.decals[p*24+22]=d,this.decals[p*24+23]=t,this.decalCount[0]++}}const ht=new dn;function pn(o,t,e){return c.MAT4_MULTIPLY(o,t,e),e.set(t,16),e[32+0]=t[0],e[32+1]=t[1],e[32+2]=t[2],e[32+3]=0,e[32+4]=t[4],e[32+5]=t[5],e[32+6]=t[6],e[32+7]=0,e[32+8]=t[8],e[32+9]=t[9],e[32+10]=t[10],e}const Xi=5,mn={label:"Sprite pipeline",layout:"auto",vertex:{entryPoint:"main",buffers:[{arrayStride:Xi*4,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:3*4,format:"float32x2"}]}]},fragment:{entryPoint:"main",targets:[{format:navigator.gpu.getPreferredCanvasFormat(),blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha",operation:"add"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"}}},{format:"rgba16float"},{format:"rgba16float"}]},primitive:{topology:"triangle-list",cullMode:"back",frontFace:"ccw"},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth24plus"}},fn=`
struct VertexOutput {
  @builtin(position) Position: vec4<f32>,
  @location(0) FragUV: vec2<f32>
};

@group(0) @binding(0) var<uniform> MVPC_MATRIX: mat4x4<f32>;

@vertex
fn main(
  @location(0) Position : vec4<f32>,
  @location(1) TexUV : vec2<f32>
) -> VertexOutput {
  var output: VertexOutput;
  output.Position = MVPC_MATRIX * Position;
  output.FragUV = TexUV;
  return output;
}`,gn=`
struct FragOutput {
  @location(0) Base: vec4f,
  @location(1) Normal: vec4f,
  @location(2) Id: vec4f
}

@group(0) @binding(1) var<uniform> ID: vec4<f32>;
@group(1) @binding(0) var TEXTURE: texture_2d<f32>;
@group(1) @binding(1) var SAMPLER: sampler;

@fragment
fn main(
  @location(0) FragUV: vec2<f32>
) -> FragOutput {
  var textureColor = textureSample(TEXTURE, SAMPLER, FragUV);
  if (textureColor.a == 0)
  {
    discard;
  }

  var output: FragOutput;
  output.Base = textureColor;
  output.Normal = vec4(0.0, 0.0, 0.0, 0.0);
  output.Id = ID;
  return output;
}`;class En extends Kt{sprites;grp0;mvpcMatrix;id;constructor(){super("SPRITE_PIPELINE",fn,gn,mn),this.sprites=[],this.grp0=v.createDynamicGroup("SPRITE_PIPELINE",0),this.mvpcMatrix=this.grp0.setFloat(0,"MVPC_MATRIX",16),this.id=this.grp0.setFloat(1,"ID",4),this.grp0.allocate()}render(){const t=v.getCurrentView(),e=v.getPassEncoder();e.setPipeline(this.pipeline),this.grp0.getSize()<this.sprites.length&&this.grp0.allocate(this.sprites.length),this.grp0.beginWrite();for(let s=0;s<this.sprites.length;s++){const i=this.sprites[s];if(i.getBillboardMode()){const n=t.getCameraMatrix(),a=t.getCameraViewMatrix(),h=t.getProjectionClipMatrix(),l=c.MAT4_MULTIPLY(a,i.getTransformMatrix());c.MAT4_MULTIPLY(l,n,l),c.MAT4_MULTIPLY(l,c.MAT4_TRANSLATE(a[12],a[13],a[14]),l),c.MAT4_MULTIPLY(h,l,this.mvpcMatrix)}else{const n=t.getViewProjectionClipMatrix();c.MAT4_MULTIPLY(n,i.getTransformMatrix(),this.mvpcMatrix)}this.grp0.write(0,this.mvpcMatrix),this.grp0.write(1,c.VEC4_COPY(i.getId(),this.id)),e.setBindGroup(0,this.grp0.getBindGroup(s));const r=i.getGroup01();e.setBindGroup(1,r.getBindGroup()),e.setVertexBuffer(0,v.getVertexBuffer(),i.getVertexSubBufferOffset(),i.getVertexSubBufferSize()),e.draw(i.getVertexCount())}this.grp0.endWrite(),this.sprites=[]}drawSprite(t){this.sprites.push(t)}}const zi=new En,Zi=6,Cn={label:"Skybox pipeline",layout:"auto",vertex:{entryPoint:"main",buffers:[{arrayStride:Zi*4,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:3*4,format:"float32x3"}]}]},fragment:{entryPoint:"main",targets:[{format:navigator.gpu.getPreferredCanvasFormat(),blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha",operation:"add"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"}}},{format:"rgba16float"},{format:"rgba16float"}]},primitive:{topology:"triangle-list",cullMode:"back",frontFace:"ccw"},depthStencil:{depthWriteEnabled:!1,depthCompare:"always",format:"depth24plus"}},Tn=`
struct VertexOutput {
  @builtin(position) Position: vec4<f32>,
  @location(0) ClipPos: vec4<f32>
};

@vertex
fn main(
  @location(0) Position: vec4<f32>,
) -> VertexOutput {
  var output : VertexOutput;
  output.Position = Position;
  output.Position.z = 1;
  output.ClipPos = Position;
  return output;
}`,An=`
struct FragOutput {
  @location(0) Base: vec4f,
  @location(1) Normal: vec4f,
  @location(2) Id: vec4f
};

@group(0) @binding(0) var<uniform> VPC_INVERSE_MATRIX: mat4x4<f32>;
@group(0) @binding(1) var<uniform> ID: vec4<f32>;
@group(1) @binding(0) var CUBEMAP_TEXTURE: texture_cube<f32>;
@group(1) @binding(1) var CUBEMAP_SAMPLER: sampler;

@fragment
fn main(
  @builtin(position) Position: vec4<f32>,
  @location(0) ClipPos: vec4<f32>
) -> FragOutput {
  var t = VPC_INVERSE_MATRIX * ClipPos;

  var output: FragOutput;
  output.Base = textureSample(CUBEMAP_TEXTURE, CUBEMAP_SAMPLER, normalize(t.xyz / t.w));
  output.Normal = vec4(0.0, 0.0, 0.0, 0.0);
  output.Id = ID;
  return output;
}`;class In extends Kt{skybox;grp0;vpcInverseMatrix;id;constructor(){super("SKYBOX_PIPELINE",Tn,An,Cn),this.skybox=null,this.grp0=v.createStaticGroup("SKYBOX_PIPELINE",0),this.vpcInverseMatrix=this.grp0.setFloat(0,"VPC_INVERSE_MATRIX",16),this.id=this.grp0.setFloat(1,"ID",4),this.grp0.allocate()}render(){if(!this.skybox)return;const t=v.getCurrentView(),e=v.getPassEncoder();e.setPipeline(this.pipeline);const s=new Float32Array(t.getCameraViewMatrix());s[12]=s[13]=s[14]=0;const i=c.MAT4_MULTIPLY(t.getProjectionClipMatrix(),s);this.grp0.beginWrite(),this.grp0.write(0,c.MAT4_INVERT(i,this.vpcInverseMatrix)),this.grp0.write(1,c.VEC4_COPY(this.skybox.getId(),this.id)),this.grp0.endWrite(),e.setBindGroup(0,this.grp0.getBindGroup());const r=this.skybox.getGroup01();e.setBindGroup(1,r.getBindGroup()),e.setVertexBuffer(0,v.getVertexBuffer(),this.skybox.getVertexSubBufferOffset(),this.skybox.getVertexSubBufferSize()),e.draw(this.skybox.getVertexCount())}draw(t){this.skybox=t}}const $i=new In,yn=4,vn={label:"Flare pipeline",layout:"auto",vertex:{entryPoint:"main",buffers:[{arrayStride:yn*4,attributes:[{shaderLocation:0,offset:0,format:"float32x2"},{shaderLocation:1,offset:2*4,format:"float32x2"}]}]},fragment:{entryPoint:"main",targets:[{format:navigator.gpu.getPreferredCanvasFormat(),blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha",operation:"add"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"}}},{format:"rgba16float"},{format:"rgba16float"}]},primitive:{topology:"triangle-list",cullMode:"none",frontFace:"ccw"},depthStencil:{depthWriteEnabled:!1,depthCompare:"less",format:"depth24plus"}},xn=`
struct VertexOutput {
  @builtin(position) Position: vec4<f32>,
  @location(0) FragUV: vec2<f32>
};

@group(0) @binding(0) var<uniform> RESOLUTION: vec2<f32>;
@group(1) @binding(1) var<uniform> TRANSLATION: vec2<f32>;
@group(1) @binding(2) var<uniform> SCALE: vec2<f32>;
@group(1) @binding(3) var<uniform> ANGLE: f32;
@group(1) @binding(4) var<uniform> SIZE: vec2<f32>;
@group(1) @binding(5) var<uniform> OFFSET: vec2<f32>;

@vertex
fn main(
  @location(0) Pos: vec2<f32>,
  @location(1) TexUV: vec2<f32>
) -> VertexOutput {
  var c = cos(ANGLE);
  var s = sin(ANGLE);
  var transformedPos = Pos + OFFSET;
  transformedPos = transformedPos * SIZE * SCALE;
  transformedPos = vec2(c * (transformedPos.x) + s * (transformedPos.y), c * (transformedPos.y) - s * (transformedPos.x));

  var screenPos = transformedPos + TRANSLATION;
  var normScreenPos = screenPos / RESOLUTION;
  var clipPos = normScreenPos * 2.0 - 1.0;
  clipPos.y = clipPos.y * -1;

  var output: VertexOutput;
  output.Position = vec4<f32>(clipPos, 0, 1);
  output.FragUV = TexUV;
  return output;
}`,Sn=`
struct FragOutput {
  @location(0) Base: vec4f,
  @location(1) Normal: vec4f,
  @location(2) Id: vec4f
}

@group(1) @binding(0) var<uniform> ID: vec4<f32>;
@group(1) @binding(6) var<uniform> COLOR: vec4<f32>;
@group(2) @binding(0) var TEXTURE: texture_2d<f32>;
@group(2) @binding(1) var SAMPLER: sampler;

@fragment
fn main(
  @builtin(position) Position: vec4<f32>,
  @location(0) FragUV: vec2<f32>
) -> FragOutput {
  var output: FragOutput;
  output.Base = textureSample(TEXTURE, SAMPLER, FragUV) * COLOR;
  output.Normal = vec4(0.0, 0.0, 0.0, 0.0);
  output.Id = ID;
  return output;
}`;class wn extends Kt{flares;grp0;resolution;grp1;id;translation;scale;angle;size;offset;color;constructor(){super("FLARE_PIPELINE",xn,Sn,vn),this.flares=[],this.grp0=v.createStaticGroup("FLARE_PIPELINE",0),this.resolution=this.grp0.setFloat(0,"RESOLUTION",2),this.grp1=v.createDynamicGroup("FLARE_PIPELINE",1),this.id=this.grp1.setFloat(0,"ID",4),this.translation=this.grp1.setFloat(1,"TRANSLATION",2),this.scale=this.grp1.setFloat(2,"SCALE",2),this.angle=this.grp1.setFloat(3,"ANGLE",1),this.size=this.grp1.setFloat(4,"SIZE",2),this.offset=this.grp1.setFloat(5,"OFFSET",2),this.color=this.grp1.setFloat(6,"COLOR",4),this.grp0.allocate(),this.grp1.allocate()}render(){const t=v.getCurrentView(),e=v.getPassEncoder();e.setPipeline(this.pipeline),this.grp0.beginWrite(),this.grp0.write(0,c.VEC2_COPY(t.getViewportSize(),this.resolution)),this.grp0.endWrite(),e.setBindGroup(0,this.grp0.getBindGroup()),this.grp1.getSize()<this.flares.length&&this.grp1.allocate(this.flares.length),this.grp1.beginWrite();for(let s=0;s<this.flares.length;s++){const i=this.flares[s];this.grp1.write(0,c.VEC4_COPY(i.getId(),this.id)),this.grp1.write(1,c.VEC2_COPY(i.getPosition2D(),this.translation)),this.grp1.write(2,c.VEC2_COPY(i.getScale2D(),this.scale)),this.grp1.write(3,c.VEC1_COPY(i.getRotation2D(),this.angle)),this.grp1.write(4,c.VEC2_COPY(i.getSize2D(),this.size)),this.grp1.write(5,c.VEC2_COPY(i.getOffset2D(),this.offset)),this.grp1.write(6,c.VEC4_COPY(i.getColor(),this.color)),e.setBindGroup(1,this.grp1.getBindGroup(s));const r=i.getGroup02();e.setBindGroup(2,r.getBindGroup()),e.setVertexBuffer(0,v.getVertexBuffer(),i.getVertexSubBufferOffset(),i.getVertexSubBufferSize()),e.draw(i.getVertexCount())}this.grp1.endWrite(),this.flares=[]}drawFlare(t){this.flares.push(t)}}const Mn=new wn,Ki=15,bn={label:"Particles pipeline",layout:"auto",vertex:{entryPoint:"main",buffers:[{arrayStride:Ki*4,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:3*4,format:"float32x3"},{shaderLocation:2,offset:6*4,format:"float32x2"},{shaderLocation:3,offset:8*4,format:"float32x3"},{shaderLocation:4,offset:11*4,format:"float32"},{shaderLocation:5,offset:12*4,format:"float32"},{shaderLocation:6,offset:13*4,format:"float32"},{shaderLocation:7,offset:14*4,format:"float32"}]}]},fragment:{entryPoint:"main",targets:[{format:navigator.gpu.getPreferredCanvasFormat(),blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha",operation:"add"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"}}},{format:"rgba16float"},{format:"rgba16float"}]},primitive:{topology:"triangle-list",cullMode:"none",frontFace:"ccw"},depthStencil:{depthWriteEnabled:!1,depthCompare:"less",format:"depth24plus"}},Pn=`
struct VertexOutput {
  @builtin(position) Position: vec4<f32>,
  @location(0) FragUV: vec2<f32>,
  @location(1) Color: vec4<f32>,
  @location(2) Angle: f32
};

@group(0) @binding(0) var<uniform> V_MATRIX: mat4x4<f32>;
@group(1) @binding(0) var<uniform> MVPC_MATRIX: mat4x4<f32>;

@vertex
fn main(
  @location(0) Pos: vec3<f32>,
  @location(1) Center: vec3<f32>,
  @location(2) TexUV: vec2<f32>,
  @location(3) Color: vec3<f32>,
  @location(4) Size: f32,
  @location(5) Opacity: f32,
  @location(6) Angle: f32,
  @location(7) Visible: f32
) -> VertexOutput {
  var output: VertexOutput;

  if(Visible == 1)
  {
    output.Color = vec4(Color, Opacity);
  }
  else
  {
    output.Color = vec4(0.0, 0.0, 0.0, 0.0);
  }

  var right = vec3<f32>(V_MATRIX[0][0], V_MATRIX[1][0], V_MATRIX[2][0]);
  var up = vec3<f32>(V_MATRIX[0][1], V_MATRIX[1][1], V_MATRIX[2][1]);

  output.Position = MVPC_MATRIX * vec4<f32>(Center + (right * Pos.x * Size) + (up * Pos.y * Size), 1.0);
  output.FragUV = TexUV;
  output.Angle = Angle;
  return output;
}`,_n=`
struct FragOutput {
  @location(0) Base: vec4f,
  @location(1) Normal: vec4f,
  @location(2) Id: vec4f
}

@group(1) @binding(1) var<uniform> ID: vec4<f32>;
@group(2) @binding(0) var TEXTURE: texture_2d<f32>;
@group(2) @binding(1) var SAMPLER: sampler;

@fragment
fn main(
  @builtin(position) Position: vec4<f32>,
  @location(0) FragUV: vec2<f32>,
  @location(1) Color: vec4<f32>,
  @location(2) Angle: f32
) -> FragOutput {
  var c = cos(Angle);
  var s = sin(Angle);

  var rotatedUV = vec2(
    c * (FragUV.x - 0.5) + s * (FragUV.y - 0.5) + 0.5,
    c * (FragUV.y - 0.5) - s * (FragUV.x - 0.5) + 0.5
  );

  var output: FragOutput;
  output.Base = textureSample(TEXTURE, SAMPLER, rotatedUV) * Color;
  output.Normal = vec4(0.0, 0.0, 0.0, 0.0);
  output.Id = ID;
  return output;
}`;class Dn extends Kt{particlesList;grp0;vMatrix;grp1;mvpcMatrix;id;constructor(){super("PARTICLES_PIPELINE",Pn,_n,bn),this.particlesList=[],this.grp0=v.createStaticGroup("PARTICLES_PIPELINE",0),this.vMatrix=this.grp0.setFloat(0,"V_MATRIX",16),this.grp1=v.createDynamicGroup("PARTICLES_PIPELINE",1),this.mvpcMatrix=this.grp1.setFloat(0,"MVPC_MATRIX",16),this.id=this.grp1.setFloat(1,"ID",4),this.grp0.allocate(),this.grp1.allocate()}render(){const t=v.getCurrentView(),e=v.getPassEncoder(),s=t.getViewProjectionClipMatrix();e.setPipeline(this.pipeline),this.grp0.beginWrite(),this.grp0.write(0,c.MAT4_COPY(t.getCameraViewMatrix(),this.vMatrix)),this.grp0.endWrite(),e.setBindGroup(0,this.grp0.getBindGroup()),this.grp1.getSize()<this.particlesList.length&&this.grp1.allocate(this.particlesList.length),this.grp1.beginWrite();for(let i=0;i<this.particlesList.length;i++){const r=this.particlesList[i];this.grp1.write(0,c.MAT4_MULTIPLY(s,r.getTransformMatrix(),this.mvpcMatrix)),this.grp1.write(1,c.VEC4_COPY(r.getId(),this.id)),e.setBindGroup(1,this.grp1.getBindGroup(i));const n=r.getGroup02();e.setBindGroup(2,n.getBindGroup()),e.setVertexBuffer(0,v.getVertexBuffer(),r.getVertexSubBufferOffset(),r.getVertexSubBufferSize()),e.draw(r.getVertexCount())}this.grp1.endWrite(),this.particlesList=[]}drawParticles(t){this.particlesList.push(t)}}const Ji=new Dn;class Rn{canvas;ctx;cameraTransform;cameraScale;cameraRotation;cameraPosition;bgColor;constructor(){if(this.canvas=document.getElementById("CANVAS_2D"),this.ctx=this.canvas.getContext("2d"),this.cameraTransform=c.MAT3_IDENTITY(),this.cameraScale=[1,1],this.cameraRotation=0,this.cameraPosition=[0,0],this.bgColor=[0,0,0,0],!this.ctx)throw c.FAIL("This browser does not support canvas"),new Error("Gfx2Manager::Gfx2Manager: Your browser not support 2D")}update(t){(this.canvas.width!=this.canvas.clientWidth||this.canvas.height!=this.canvas.clientHeight)&&(this.canvas.width=this.canvas.clientWidth,this.canvas.height=this.canvas.clientHeight)}beginDrawing(){this.ctx.save(),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle=`rgba(${this.bgColor[0]}, ${this.bgColor[1]}, ${this.bgColor[2]}, ${this.bgColor[3]})`,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.transform(this.cameraTransform[0],this.cameraTransform[1],this.cameraTransform[3],this.cameraTransform[4],this.cameraTransform[6],this.cameraTransform[7]),this.ctx.translate(this.canvas.width*.5,this.canvas.height*.5),this.ctx.scale(this.cameraScale[0],this.cameraScale[1]),this.ctx.rotate(this.cameraRotation),this.ctx.translate(-this.cameraPosition[0],-this.cameraPosition[1])}endDrawing(){this.ctx.restore()}moveCamera(t,e){this.cameraPosition[0]+=t,this.cameraPosition[1]+=e}setFilter(t){this.canvas.style.filter=t}hasFilter(){return this.canvas.style.filter!=""&&this.canvas.style.filter!="none"}findCanvasPosFromClientPos(t,e){const s=this.canvas.getBoundingClientRect(),i=t-s.x,r=e-s.y;return[i,r]}findWorldPosFromClientPos(t,e){const s=this.canvas.getBoundingClientRect(),i=t-s.x+this.cameraPosition[0]-this.canvas.width*.5,r=e-s.y+this.cameraPosition[1]-this.canvas.height*.5;return[i,r]}getWidth(){return this.canvas.clientWidth}getHeight(){return this.canvas.clientHeight}getContext(){return this.ctx}setCameraTransform(t){this.cameraTransform=t}getCameraTransform(){return this.cameraTransform}setCameraPosition(t,e){this.cameraPosition[0]=t,this.cameraPosition[1]=e}getCameraPosition(){return this.cameraPosition}getCameraPositionX(){return this.cameraPosition[0]}getCameraPositionY(){return this.cameraPosition[1]}setCameraScale(t,e){this.cameraScale[0]=t,this.cameraScale[1]=e}getCameraScale(){return this.cameraScale}getCameraScaleX(){return this.cameraScale[0]}getCameraScaleY(){return this.cameraScale[1]}setCameraRotation(t){this.cameraRotation=t}getCameraRotation(){return this.cameraRotation}setBgColor(t,e,s,i){this.bgColor[0]=t,this.bgColor[1]=e,this.bgColor[2]=s,this.bgColor[3]=i}getBgColor(){return this.bgColor}getDefaultTexture(){const t=new Image;return t.src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",t}}const N=new Rn;class On{requests;screens;constructor(){this.requests=[],this.screens=[]}update(t){for(;this.requests.length>0;)this.requests.pop()();for(let e=this.screens.length-1;e>=0;e--)this.screens[e].isBlocking()||this.screens[e].update(t)}draw(){for(let t=this.screens.length-1;t>=0;t--)this.screens[t].isBlocking()||this.screens[t].draw()}requestPushScreen(t,e={}){this.requests.push(()=>{if(this.screens.indexOf(t)!=-1)throw new Error("ScreenManager::requestPushScreen(): You try to push an existing screen to the stack !");this.screens[this.screens.length-1].onBringToBack(t),t.onEnter(e).then(()=>this.screens.push(t))})}requestSetScreen(t,e={}){this.requests.push(()=>{this.screens.forEach(i=>i.onExit()),this.screens=[],t.onEnter(e).then(()=>this.screens.push(t))})}requestPopScreen(){this.requests.push(()=>{if(this.screens.length==0)throw new Error("ScreenManager::requestPopScreen: You try to pop an empty state stack !");let t=this.screens[this.screens.length-1];t.onExit(),this.screens.pop(),this.screens.length>0&&this.screens[this.screens.length-1].onBringToFront(t)})}}const R=new On;class Ln{root;fadeLayer;overLayer;focusedWidget;widgets;constructor(){this.root=document.getElementById("UI_ROOT"),this.fadeLayer=document.getElementById("UI_FADELAYER"),this.overLayer=document.getElementById("UI_OVERLAYER"),this.focusedWidget=null,this.widgets=[]}update(t){for(let e of this.widgets)e.update(t)}getWidgets(){return this.widgets}focus(t){this.focusedWidget&&this.focusedWidget.unfocus(),t.focus(),this.focusedWidget=t,m.emit(this,"E_FOCUSED",{widget:t})}unfocus(){!this.focusedWidget||(this.focusedWidget.unfocus(),this.focusedWidget=null,m.emit(this,"E_UNFOCUSED"))}addNode(t,e=""){t.style.cssText+=e,this.root.appendChild(t)}removeNode(t){this.root.removeChild(t)}addWidget(t,e=""){return t.appendStyles(e),this.root.appendChild(t.getNode()),this.widgets.push(t),t}removeWidget(t){const e=this.widgets.indexOf(t);if(e==-1)throw new Error("UIManager::removeWidget: fail to remove widget !");return t==this.focusedWidget&&this.unfocus(),t.delete(),this.widgets.splice(e,1),!0}clear(){for(this.root.innerHTML="",this.focusedWidget=null;this.widgets.length>0;)this.widgets.pop().delete()}fadeIn(t,e,s="#000",i="linear",r=()=>{}){this.fadeLayer.style.transitionDelay=t+"ms",this.fadeLayer.style.transitionDuration=e+"ms",this.fadeLayer.style.backgroundColor=s,this.fadeLayer.style.transitionTimingFunction=i,this.fadeLayer.style.opacity="1",setTimeout(()=>{r()},t+e)}fadeOut(t,e,s="linear",i=()=>{}){this.fadeLayer.style.transitionDuration=e+"ms",this.fadeLayer.style.transitionDelay=t+"ms",this.fadeLayer.style.transitionTimingFunction=s,this.fadeLayer.style.opacity="0",setTimeout(()=>{i()},t+e)}enableOverlayer(t){this.overLayer.style.opacity=t?"1":"0"}setClassName(t){this.root.className=t}}const g=new Ln,Qi=4,Qs={label:"PPE pipeline",layout:"auto",vertex:{entryPoint:"main",buffers:[{arrayStride:Qi*4,attributes:[{shaderLocation:0,offset:0,format:"float32x2"},{shaderLocation:1,offset:2*4,format:"float32x2"}]}]},fragment:{entryPoint:"main",targets:[{format:navigator.gpu.getPreferredCanvasFormat()}]},primitive:{topology:"triangle-list"}},ti=`
struct VertexOutput {
  @builtin(position) Position: vec4<f32>,
  @location(0) FragUV: vec2<f32>
};

@vertex
fn main(
  @location(0) Position: vec2<f32>,
  @location(1) TexUV: vec2<f32>
) -> VertexOutput {
  var output: VertexOutput;
  output.Position = vec4(Position, 0.0, 1.0);
  output.FragUV = TexUV;
  return output;
}`,Nn=`
struct Params {
  ENABLED: f32,
  PIXELATION_ENABLED: f32,
  PIXELATION_WIDTH: f32,
  PIXELATION_HEIGHT: f32,
  COLOR_ENABLED: f32,
  COLOR_PRECISION: f32,
  DITHER_ENABLED: f32,
  DITHER_PATTERN_INDEX: f32,
  DITHER_THRESHOLD: f32,
  DITHER_SCALE_X: f32,
  DITHER_SCALE_Y: f32,
  OUTLINE_ENABLED: f32,
  OUTLINE_THICKNESS: f32,
  OUTLINE_R: f32,
  OUTLINE_G: f32,
  OUTLINE_B: f32
};

@group(0) @binding(0) var<uniform> PARAMS: Params;
@group(0) @binding(1) var<uniform> SIZE: vec2<f32>;
@group(0) @binding(2) var SOURCE_TEXTURE: texture_2d<f32>;
@group(0) @binding(3) var SOURCE_SAMPLER: sampler;
@group(0) @binding(4) var NORMALS_TEXTURE: texture_2d<f32>;
@group(0) @binding(5) var NORMALS_SAMPLER: sampler;
@group(0) @binding(6) var IDS_TEXTURE: texture_2d<f32>;
@group(0) @binding(7) var IDS_SAMPLER: sampler;
@group(0) @binding(8) var DEPTH_TEXTURE: texture_depth_2d;
@group(0) @binding(9) var DEPTH_SAMPLER: sampler;

@fragment
fn main(
  @location(0) FragUV: vec2<f32>
) -> @location(0) vec4<f32> {
  var outputColor = textureSample(SOURCE_TEXTURE, SOURCE_SAMPLER, FragUV);
  var normal = textureSample(NORMALS_TEXTURE, NORMALS_SAMPLER, FragUV);
  var id = textureSample(IDS_TEXTURE, IDS_SAMPLER, FragUV);
  var depth = textureSample(DEPTH_TEXTURE, DEPTH_SAMPLER, FragUV);

  if (PARAMS.ENABLED == 0.0)
  {
    return outputColor;
  }

  if (PARAMS.PIXELATION_ENABLED == 1.0)
  {
    var pixelCoord = vec2<f32>(0.0, 0.0);
    pixelCoord.x = floor(FragUV.x * PARAMS.PIXELATION_WIDTH) / PARAMS.PIXELATION_WIDTH;
    pixelCoord.y = floor(FragUV.y * PARAMS.PIXELATION_HEIGHT) / PARAMS.PIXELATION_HEIGHT;
    outputColor = textureSample(SOURCE_TEXTURE, SOURCE_SAMPLER, pixelCoord);
  }

  if (PARAMS.COLOR_ENABLED == 1.0)
  {
    outputColor = floor(outputColor * PARAMS.COLOR_PRECISION) / PARAMS.COLOR_PRECISION;
  }

  if (PARAMS.DITHER_ENABLED == 1.0)
  {
    var brightness = GetPixelBrightness(outputColor.rgb);
    var ditherPattern = GetDitherPattern(PARAMS.DITHER_PATTERN_INDEX);
    var ditherX = u32((FragUV.x * SIZE.x) / PARAMS.DITHER_SCALE_X);
    var ditherY = u32((FragUV.y * SIZE.y) / PARAMS.DITHER_SCALE_Y);
    var ditherPixel = GetDitherValue(ditherX, ditherY, brightness, ditherPattern);
    outputColor = outputColor * ditherPixel;
  }

  if (PARAMS.OUTLINE_ENABLED == 1.0)
  {
    var t = PARAMS.OUTLINE_THICKNESS * (1.0 - depth);
    var idDiff = 0.0;

    idDiff += distance(id, getIdValue(FragUV, vec2<f32>( t,  0)));
    idDiff += distance(id, getIdValue(FragUV, vec2<f32>( 0,  t)));
    idDiff += distance(id, getIdValue(FragUV, vec2<f32>( 0,  t)));
    idDiff += distance(id, getIdValue(FragUV, vec2<f32>( 0, -t)));
    idDiff += distance(id, getIdValue(FragUV, vec2<f32>( t,  t)));
    idDiff += distance(id, getIdValue(FragUV, vec2<f32>( t, -t)));
    idDiff += distance(id, getIdValue(FragUV, vec2<f32>(-t,  t)));
    idDiff += distance(id, getIdValue(FragUV, vec2<f32>(-t, -t)));

    if (idDiff != 0.0)
    {
      idDiff = 1.0;
      var outline = clamp(idDiff, 0, 1);
      outputColor = mix(outputColor, vec4<f32>(PARAMS.OUTLINE_R, PARAMS.OUTLINE_G, PARAMS.OUTLINE_B, 1.0), outline);  
    }
  }

  return outputColor;
}

// *****************************************************************************************************************
// GET TEXEL VALUE
// *****************************************************************************************************************
fn getTexelValue(textureUV: vec2<f32>, offset: vec2<f32>) -> vec4<f32>
{
  var ps = vec2<f32>(1.0 / SIZE.x, 1.0 / SIZE.y);
  return textureSample(SOURCE_TEXTURE, SOURCE_SAMPLER, textureUV + ps * offset);
}

// *****************************************************************************************************************
// GET NORMAL VALUE
// *****************************************************************************************************************
fn getNormalValue(textureUV: vec2<f32>, offset: vec2<f32>) -> vec4<f32>
{
  var ps = vec2<f32>(1.0 / SIZE.x, 1.0 / SIZE.y);
  return textureSample(NORMALS_TEXTURE, NORMALS_SAMPLER, textureUV + ps * offset);
}

// *****************************************************************************************************************
// GET ID VALUE
// *****************************************************************************************************************
fn getIdValue(textureUV: vec2<f32>, offset: vec2<f32>) -> vec4<f32>
{
  var ps = vec2<f32>(1.0 / SIZE.x, 1.0 / SIZE.y);
  return textureSample(IDS_TEXTURE, IDS_SAMPLER, textureUV + ps * offset);
}

// *****************************************************************************************************************
// GET DEPTH VALUE
// *****************************************************************************************************************
fn getDepthValue(textureUV: vec2<f32>, offset: vec2<f32>) -> f32
{
  var ps = vec2<f32>(1.0 / SIZE.x, 1.0 / SIZE.y);
  return textureSample(DEPTH_TEXTURE, DEPTH_SAMPLER, textureUV + ps * offset);
}

// *****************************************************************************************************************
// GET DITHER PATTERN
// *****************************************************************************************************************
fn GetDitherPattern(index: f32) -> mat4x4<f32>
{
  var pattern = mat4x4<f32>();

  if (index == 0)
  {
    pattern = mat4x4<f32>(
      0, 1, 0, 1,
      1, 0, 1, 0,
      0, 1, 0, 1,
      1, 0, 1, 0 
    );
  }         
  else if (index == 1)
  {
    pattern = mat4x4<f32>(
      0.23, 0.2, 0.6, 0.2,
      0.2, 0.43, 0.2, 0.77,
      0.88, 0.2, 0.87, 0.2,
      0.2, 0.46, 0.2, 0
    );
  }           
  else if (index == 2)
  {
    pattern = mat4x4<f32>(
      -4.0, 0.0, -3.0, 1.0,
      2.0, -2.0, 3.0, -1.0,
      -3.0, 1.0, -4.0, 0.0,
      3.0, -1.0, 2.0, -2.0
    );
  }       
  else if (index == 3)
  {
    pattern = mat4x4<f32>(
      1, 0, 0, 1,
      0, 1, 1, 0,
      0, 1, 1, 0,
      1, 0, 0, 1 
    );
  }
  else 
  {
    pattern = mat4x4<f32>(
      1, 1, 1, 1,
      1, 1, 1, 1,
      1, 1, 1, 1,
      1, 1, 1, 1
    );
  }
  
  return pattern;
}

// *****************************************************************************************************************
// GET DITHER VALUE
// *****************************************************************************************************************
fn GetDitherValue(x: u32, y: u32, brightness: f32, pattern: mat4x4<f32>) -> f32
{
  if ((brightness * PARAMS.DITHER_THRESHOLD) < pattern[x % 4][y % 4]) 
  {
    return 0;
  }
  else
  {
    return 1;
  }
}

// *****************************************************************************************************************
// GET PIXEL BRIGHTNESS
// *****************************************************************************************************************
fn GetPixelBrightness(color: vec3<f32>) -> f32
{
  return color.r + color.g + color.b / 3.0;
}`;var Me=(o=>(o[o.ENABLED=0]="ENABLED",o[o.PIXELATION_ENABLED=1]="PIXELATION_ENABLED",o[o.PIXELATION_WIDTH=2]="PIXELATION_WIDTH",o[o.PIXELATION_HEIGHT=3]="PIXELATION_HEIGHT",o[o.COLOR_ENABLED=4]="COLOR_ENABLED",o[o.COLOR_PRECISION=5]="COLOR_PRECISION",o[o.DITHER_ENABLED=6]="DITHER_ENABLED",o[o.DITHER_PATTERN_INDEX=7]="DITHER_PATTERN_INDEX",o[o.DITHER_THRESHOLD=8]="DITHER_THRESHOLD",o[o.DITHER_SCALE_X=9]="DITHER_SCALE_X",o[o.DITHER_SCALE_Y=10]="DITHER_SCALE_Y",o[o.OUTLINE_ENABLED=11]="OUTLINE_ENABLED",o[o.OUTLINE_THICKNESS=12]="OUTLINE_THICKNESS",o[o.OUTLINE_R=13]="OUTLINE_R",o[o.OUTLINE_G=14]="OUTLINE_G",o[o.OUTLINE_B=15]="OUTLINE_B",o))(Me||{});class Fn extends Kt{device;vertexBuffer;grp0;params;size;sourceTexture;normalsTexture;idsTexture;depthTexture;constructor(){super("PPE_PIPELINE",ti,Nn,Qs),this.device=v.getDevice(),this.vertexBuffer=this.device.createBuffer({size:6*Qi*4,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC}),this.grp0=v.createStaticGroup("PPE_PIPELINE",0),this.params=this.grp0.setFloat(0,"PARAMS",16),this.params[0]=1,this.params[1]=0,this.params[2]=400,this.params[3]=400,this.params[4]=0,this.params[5]=32,this.params[6]=0,this.params[7]=0,this.params[8]=1,this.params[9]=1,this.params[10]=1,this.params[11]=0,this.params[12]=120,this.params[13]=0,this.params[14]=0,this.params[15]=0,this.size=this.grp0.setFloat(1,"SIZE",2),this.size[0]=v.getWidth(),this.size[1]=v.getHeight(),this.sourceTexture=this.grp0.setTexture(2,"SOURCE_TEXTURE",v.createRenderingTexture()),this.sourceTexture=this.grp0.setSampler(3,"SOURCE_SAMPLER",this.sourceTexture),this.normalsTexture=this.grp0.setTexture(4,"NORMALS_TEXTURE",v.getNormalsTexture()),this.normalsTexture=this.grp0.setSampler(5,"NORMALS_SAMPLER",this.normalsTexture),this.idsTexture=this.grp0.setTexture(6,"IDS_TEXTURE",v.getIdsTexture()),this.idsTexture=this.grp0.setSampler(7,"IDS_SAMPLER",this.idsTexture),this.depthTexture=this.grp0.setTexture(8,"DEPTH_TEXTURE",v.getDepthTexture()),this.depthTexture=this.grp0.setSampler(9,"DEPTH_SAMPLER",this.depthTexture),this.grp0.allocate(),this.device.queue.writeBuffer(this.vertexBuffer,0,new Float32Array([-1,1,0,0,1,1,1,0,-1,-1,0,1,-1,-1,0,1,1,1,1,0,1,-1,1,1])),m.subscribe(rs,"E_RESIZE",this,this.$handleWindowResize)}render(t){const s=v.getCommandEncoder().beginRenderPass({colorAttachments:[{view:t.createView(),loadOp:"clear",storeOp:"store"}]});s.setPipeline(this.pipeline),this.grp0.beginWrite(),this.grp0.write(0,this.params),this.grp0.write(1,this.size),this.grp0.endWrite(),s.setBindGroup(0,this.grp0.getBindGroup()),s.setVertexBuffer(0,this.vertexBuffer),s.draw(6),s.end()}loadPipeline(t,e){v.deletePipeline("PPE_PIPELINE"),this.pipeline=v.loadPipeline("PPE_PIPELINE",ti,t,Qs),this.grp0=v.createStaticGroup("PPE_PIPELINE",0),this.params=this.grp0.setFloat(0,"PARAMS",e.length);for(let s=0;s<e.length;s++)this.params[s]=e[s];this.size=this.grp0.setFloat(1,"SIZE",2),this.size[0]=v.getWidth(),this.size[1]=v.getHeight(),this.sourceTexture=this.grp0.setTexture(2,"SOURCE_TEXTURE",v.createRenderingTexture()),this.sourceTexture=this.grp0.setSampler(3,"SOURCE_SAMPLER",this.sourceTexture),this.normalsTexture=this.grp0.setTexture(4,"NORMALS_TEXTURE",v.getNormalsTexture()),this.normalsTexture=this.grp0.setSampler(5,"NORMALS_SAMPLER",this.normalsTexture),this.idsTexture=this.grp0.setTexture(6,"IDS_TEXTURE",v.getIdsTexture()),this.idsTexture=this.grp0.setSampler(7,"IDS_SAMPLER",this.idsTexture),this.depthTexture=this.grp0.setTexture(8,"DEPTH_TEXTURE",v.getDepthTexture()),this.depthTexture=this.grp0.setSampler(9,"DEPTH_SAMPLER",this.depthTexture),this.grp0.allocate()}setParam(t,e){this.params[t]=e}getParam(t){return this.params[t]}getSourceTexture(){return this.sourceTexture.gpuTexture}$handleWindowResize(){this.size[0]=v.getWidth(),this.size[1]=v.getHeight(),this.sourceTexture.gpuTexture.destroy(),this.sourceTexture=this.grp0.setTexture(2,"SOURCE_TEXTURE",v.createRenderingTexture()),this.normalsTexture=this.grp0.setTexture(4,"NORMALS_TEXTURE",v.getNormalsTexture()),this.idsTexture=this.grp0.setTexture(6,"IDS_TEXTURE",v.getIdsTexture()),this.grp0.allocate()}}const Ht=new Fn;class U{blocking;constructor(){this.blocking=!1}setBlocking(t){this.blocking=t}isBlocking(){return this.blocking}update(t){}draw(){}async onEnter(t){}onExit(){}onBringToFront(t){}onBringToBack(t){}}const qt=new Map;qt.set("0","0");qt.set("1","1");qt.set("BtnSelect","8");qt.set("PadTop","12");qt.set("PadBottom","13");qt.set("PadLeft","14");qt.set("PadRight","15");class Bn{keymap;actionmap;actionRegister;pads;padsInterval;mouseDown;mousePosition;mouseWheel;dragStartPosition;constructor(){this.keymap=new Map,this.actionmap=new Map,this.actionRegister=[],this.pads=[],this.padsInterval,this.mouseDown=!1,this.mousePosition=[0,0],this.mouseWheel=0,this.dragStartPosition=[0,0],document.addEventListener("keydown",t=>this.$handleKeyDown(t)),document.addEventListener("keyup",t=>this.$handleKeyUp(t)),document.addEventListener("pointerdown",t=>this.$handlePointerDown(t)),document.addEventListener("pointerup",()=>this.$handlePointerUp()),document.addEventListener("pointermove",t=>this.$handlePointerMove(t)),document.addEventListener("wheel",t=>this.$handleWheel(t),{passive:!1}),window.addEventListener("gamepadconnected",t=>this.$handleGamePadConnected(t)),window.addEventListener("gamepaddisconnected",t=>this.$handleGamePadDisconnected(t)),this.registerAction("keyboard","Enter","OK"),this.registerAction("keyboard","Escape","BACK"),this.registerAction("keyboard"," ","SELECT"),this.registerAction("keyboard","ArrowLeft","LEFT"),this.registerAction("keyboard","ArrowRight","RIGHT"),this.registerAction("keyboard","ArrowUp","UP"),this.registerAction("keyboard","ArrowDown","DOWN"),this.registerAction("gamepad0","0","OK"),this.registerAction("gamepad0","1","BACK"),this.registerAction("gamepad0","BtnSelect","SELECT"),this.registerAction("gamepad0","PadLeft","LEFT"),this.registerAction("gamepad0","PadRight","RIGHT"),this.registerAction("gamepad0","PadTop","UP"),this.registerAction("gamepad0","PadBottom","DOWN")}registerAction(t,e,s){this.actionRegister.find(r=>r.inputSource==t&&r.eventKey==e&&r.id==s)||this.actionRegister.push({id:s,inputSource:t,eventKey:t.startsWith("gamepad")?qt.get(e):e})}unregisterAction(t,e,s){const i=this.actionRegister.findIndex(r=>r.inputSource==t&&r.eventKey==e&&r.id==s);if(i==-1)throw new Error("InputManager::unregisterAction(): action not found !");this.actionRegister.splice(i,1)}findActionIds(t,e){const s=[];for(const i of this.actionRegister)i.inputSource==t&&i.eventKey==e&&s.push(i.id);return s}isActiveAction(t){return this.actionmap.get(t)}isMouseDown(){return this.mouseDown}getMousePosition(){return this.mousePosition}getMouseWheel(){return this.mouseWheel}getDragDelta(){return this.mouseDown?[this.mousePosition[0]-this.dragStartPosition[0],this.mousePosition[1]-this.dragStartPosition[1]]:[0,0]}getPad(t){return this.pads.find(e=>e.index==t)}removePad(t){this.pads=this.pads.filter(e=>e.id!=t),this.pads.length<=0&&(clearInterval(this.padsInterval),this.padsInterval=void 0)}$addPad(t){this.pads.push(t),this.padsInterval===null&&(this.padsInterval=setInterval(()=>this.$updatePadsStatus(),50))}$handleKeyDown(t){if(!this.keymap.get(t.key))for(const e of this.findActionIds("keyboard",t.key))m.emit(this,"E_ACTION_ONCE",{actionId:e}),this.actionmap.set(e,!0);for(const e of this.findActionIds("keyboard",t.key))m.emit(this,"E_ACTION",{actionId:e}),this.actionmap.set(e,!0);return this.keymap.set(t.key,!0),t.preventDefault(),t.stopPropagation(),!1}$handleKeyUp(t){for(const e of this.findActionIds("keyboard",t.key))m.emit(this,"E_ACTION_RELEASED",{actionId:e}),this.actionmap.set(e,!1);this.keymap.set(t.key,!1)}$handlePointerDown(t){this.mouseDown=!0,this.dragStartPosition[0]=t.clientX,this.dragStartPosition[1]=t.clientY,m.emit(this,"E_MOUSE_DOWN",{buttons:t.buttons})}$handlePointerUp(){this.mouseDown=!1,this.dragStartPosition[0]=0,this.dragStartPosition[1]=0,m.emit(this,"E_MOUSE_UP")}$handlePointerMove(t){this.mouseDown=t.pointerType=="mouse"?(t.buttons&1)!==0:!0,this.mousePosition=[t.clientX,t.clientY],m.emit(this,"E_MOUSE_MOVE",{movementX:t.movementX,movementY:t.movementY}),this.mouseDown&&m.emit(this,"E_MOUSE_DRAG",{movementX:t.movementX,movementY:t.movementY})}$handleWheel(t){this.mouseDown=(t.buttons&1)!==0,this.mouseWheel+=Math.sign(t.deltaY),t.preventDefault(),t.stopPropagation(),m.emit(this,"E_MOUSE_WHEEL",{delta:Math.sign(t.deltaY)})}$handleGamePadDisconnected(t){this.removePad(t.gamepad.id)}$handleGamePadConnected(t){const e={index:t.gamepad.index,id:t.gamepad.id,nButtons:t.gamepad.buttons.length,nAxes:t.gamepad.axes.length,axes:t.gamepad.axes,pressed:[]};for(let s=0;s<t.gamepad.buttons.length;s++)e.pressed[s]=t.gamepad.buttons[s].pressed;this.$addPad(e)}$updatePadsStatus(){const t=window.navigator,e=t.getGamepads?t.getGamepads():t.webkitGetGamepads?t.webkitGetGamepads():[];for(const s of e){if(!s)continue;const i=this.getPad(s.index);if(i!=null){for(let r=0;r<s.buttons.length;r++)if(s.buttons[r].pressed!=i.pressed[r]){for(const n of this.findActionIds("gamepad"+s.index,r.toString()))this.actionmap.set(n,s.buttons[r].pressed),s.buttons[r].pressed&&m.emit(this,"E_ACTION",{actionId:n});this.keymap.set("gamepad"+s.index+"-"+r,s.buttons[r].pressed),i.pressed[r]=s.buttons[r].pressed}}}}}const M=new Bn;class W{id;className;template;node;constructor(t={}){this.id=t.id??"",this.className=t.className??"",this.template=t.template??"",this.node=document.createElement("div"),this.node.className=this.className,this.node.innerHTML=this.template,this.node.addEventListener("animationend",()=>m.emit(this,"E_ANIMATION_FINISHED"))}update(t){}delete(){this.node.remove(),m.unsubscribe(M,"E_ACTION",this)}getId(){return this.id}setId(t){this.id=t,this.node.id=t}getNode(){return this.node}appendChild(t){this.node.appendChild(t)}removeChild(t){this.node.removeChild(this.node.children[t])}appendStyles(t){this.node.style.cssText+=t}focus(){this.node.classList.add("u-focused"),m.emit(this,"E_FOCUSED"),m.subscribe(M,"E_ACTION",this,t=>this.onAction(t.actionId))}unfocus(){this.node.classList.remove("u-focused"),m.emit(this,"E_UNFOCUSED"),m.unsubscribe(M,"E_ACTION",this)}isFocused(){return this.node.classList.contains("u-focused")}setVisible(t){t?this.node.classList.remove("u-hidden"):this.node.classList.add("u-hidden")}isVisible(){return!this.node.classList.contains("u-hidden")}setEnabled(t){t?this.node.classList.remove("u-disabled"):this.node.classList.add("u-disabled")}isEnabled(){return!this.node.classList.contains("u-disabled")}setSelected(t){t?this.node.classList.add("u-selected"):this.node.classList.remove("u-selected")}isSelected(){return this.node.classList.contains("u-selected")}getScreenPosition(){let t=this.node.getBoundingClientRect();return[t.left,t.top]}getPosition(){const t=parseInt(this.node.style.left),e=parseInt(this.node.style.top);return[t,e]}setPosition(t,e){this.node.style.left=t+"px",this.node.style.top=e+"px"}animate(t){this.node.style.animation=t}onAction(t){}}var ve=(o=>(o[o.X=0]="X",o[o.Y=1]="Y",o[o.XY=2]="XY",o))(ve||{});class Ce extends W{axis;rows;columns;multiple;selectable;togglable;widgets;focusedWidget;selectedWidgets;constructor(t={}){super({className:t.className??"UIMenu"}),this.axis=t.axis??1,this.rows=t.rows??0,this.columns=t.columns??0,this.multiple=t.multiple??!1,this.selectable=t.selectable??!0,this.togglable=t.togglable??!0,this.widgets=[],this.selectedWidgets=[],this.axis==0?(this.rows=1,this.columns=1/0,this.node.style.display="flex",this.node.style.flexDirection="row"):this.axis==1?(this.rows=1/0,this.columns=1,this.node.style.display="flex",this.node.style.flexDirection="column"):(this.node.style.display="grid",this.node.style.grid="repeat("+this.rows+", auto) / repeat("+this.columns+", auto)")}delete(){for(const t of this.widgets)t.delete();super.delete()}update(t){for(const e of this.widgets)e.update(t)}focus(t=0){if(this.widgets.length>0&&t==0){const e=this.focusedWidget?this.widgets.indexOf(this.focusedWidget):0;this.focusWidget(e,!0)}super.focus()}addWidget(t,e=-1){const s=t.getNode();e==-1?(this.widgets.push(t),this.node.appendChild(s)):(this.widgets.splice(e+1,0,t),this.node.insertBefore(s,this.node.children[e])),s.addEventListener("click",()=>this.$handleWidgetClicked(t)),s.addEventListener("mousemove",()=>this.$handleWidgetHover(t))}removeWidget(t){const e=this.widgets[t];if(!e)throw new Error("UIMenu::removeWidget(): widget not found !");this.selectedWidgets.indexOf(e)!=-1&&this.selectedWidgets.splice(this.selectedWidgets.indexOf(e),1),this.focusedWidget==e&&(this.focusedWidget=void 0),this.widgets.splice(this.widgets.indexOf(e),1),e.delete()}focusWidget(t,e=!1,s=!0){const i=this.widgets[t];if(!i)throw new Error("UIMenu::focusWidget(): widget not found !");if(!e){const r=this.$getViewRectWidget(t);r.top<0&&(this.node.scrollTop+=r.top),r.bottom>this.node.clientHeight&&(this.node.scrollTop+=r.bottom-this.node.clientHeight)}this.widgets.forEach(r=>r.unfocus()),i.focus(),this.focusedWidget=i,s&&m.emit(this,"E_ITEM_FOCUSED",{id:i.getId(),index:t})}unfocusWidget(t=!0){this.widgets.forEach(e=>e.unfocus()),this.focusedWidget=void 0,t&&m.emit(this,"E_ITEM_UNFOCUSED")}selectWidget(t,e=!0){const s=this.widgets[t];if(!s)throw new Error("UIMenu::selectWidget(): widget not found !");if(!!s.isEnabled()){if(this.multiple&&this.togglable&&s.isSelected()){s.setSelected(!1),this.selectedWidgets.splice(this.selectedWidgets.indexOf(s),1);return}this.multiple||(this.widgets.forEach(i=>i.setSelected(!1)),this.selectedWidgets=[]),s.setSelected(!0),this.selectedWidgets.push(s),e&&m.emit(this,"E_ITEM_SELECTED",{id:s.getId(),index:t})}}unselectWidget(t,e=!0){const s=this.widgets[t];if(!s)throw new Error("UIMenu::unselectWidget(): widget not found !");!s.isSelected()||(s.setSelected(!1),this.selectedWidgets.splice(this.selectedWidgets.indexOf(s),1),e&&m.emit(this,"E_ITEM_UNSELECTED",{id:s.getId(),index:t}))}unselectWidgets(t=!0){this.widgets.forEach(e=>e.setSelected(!1)),this.selectedWidgets=[],t&&m.emit(this,"E_UNSELECTED")}setEnabledWidget(t,e){const s=this.widgets[t];if(!s)throw new Error("UIMenu::setEnabledWidget(): widget not found !");s.setEnabled(e)}setEnabledWidgets(t){this.widgets.forEach(e=>e.setEnabled(t))}clear(){this.widgets.forEach(t=>t.delete()),this.widgets=[],this.focusedWidget=void 0,this.selectedWidgets=[],this.node.innerHTML=""}getFocusedWidgetId(){return this.focusedWidget?this.focusedWidget.getId():null}getFocusedWidgetIndex(){return this.focusedWidget?this.widgets.indexOf(this.focusedWidget):-1}getSelectedWidgetId(){return this.selectedWidgets[0]?this.selectedWidgets[0].getId():null}getSelectedWidgetIndex(){return this.selectedWidgets[0]?this.widgets.indexOf(this.selectedWidgets[0]):-1}getSelectedWidgetIds(){return this.selectedWidgets.map(t=>t.getId())}getSelectedWidgetIndexes(){return this.selectedWidgets.map(t=>this.widgets.indexOf(t))}getWidgets(){return this.widgets}getWidget(t){return this.widgets[t]}onAction(t){if(t=="BACK")m.emit(this,"E_CLOSED");else if(t=="OK"){const e=this.getFocusedWidgetIndex();this.selectWidget(e)}else if(t=="LEFT"){const e=this.getFocusedWidgetIndex(),s=e-1<0?this.widgets.length-1:e-1;this.focusWidget(s)}else if(t=="RIGHT"){const e=this.getFocusedWidgetIndex(),s=e+1>this.widgets.length-1?0:e+1;this.focusWidget(s)}else if(t=="UP"){const e=this.getFocusedWidgetIndex(),s=e-this.columns<0?this.widgets.length-1:e-this.columns;this.focusWidget(s)}else if(t=="DOWN"){const e=this.getFocusedWidgetIndex(),s=e+this.columns>this.widgets.length-1?0:e+this.columns;this.focusWidget(s)}}$handleWidgetClicked(t){!this.isFocused()||this.selectWidget(this.widgets.indexOf(t),!0)}$handleWidgetHover(t){!this.isFocused()||this.focusWidget(this.widgets.indexOf(t),!1,!0)}$getViewRectWidget(t){const e=this.node.children[t],s=e.offsetTop-this.node.scrollTop,i=s+e.offsetHeight;return{top:s,bottom:i}}}class Vn extends W{constructor(){super({className:"UIMenuTextItem"})}setText(t){this.node.textContent=t}}class it extends Ce{constructor(t={}){super(Object.assign(t,{className:t.className??"UIMenuText"}))}add(t,e){const s=new Vn;s.setId(t),s.setText(e),this.addWidget(s)}set(t,e){const s=this.widgets.find(i=>i.getId()==t);if(!s)throw new Error("UIMenuText::set(): item not found !");s.setText(e)}remove(t){const e=this.widgets.findIndex(s=>s.getId()==t);if(e==-1)throw new Error("UIMenuText::remove(): item not found !");this.removeWidget(e)}getSelectedId(){return this.getSelectedWidgetId()}}class Un{textures;constructor(){this.textures=new Map}async loadTexture(t,e={}){if(this.textures.has(t))return this.textures.get(t);const i=await(await fetch(t)).blob(),r=await createImageBitmap(i),n=v.createTextureFromBitmap(r,!1,e);return this.textures.set(t,n),n}async loadTexture8bit(t,e={}){if(this.textures.has(t))return this.textures.get(t);const i=await(await fetch(t)).blob(),r=await createImageBitmap(i),n=v.createTextureFromBitmap(r,!0,e);return this.textures.set(t,n),n}async loadCubemapTexture(t,e){if(this.textures.has(t))return this.textures.get(t);const s=["right","left","top","bottom","front","back"],i=[];for(const n of s){const h=await(await fetch(t+n+"."+e)).blob(),l=await createImageBitmap(h);i.push(l)}const r=v.createCubeMapFromBitmap(i);return this.textures.set(t,r),r}deleteTexture(t){if(!this.textures.has(t))throw new Error("Gfx3TextureManager::deleteTexture(): The texture file doesn't exist, cannot delete !");this.textures.get(t).gpuTexture.destroy(),this.textures.delete(t)}getTexture(t){if(!this.textures.has(t))throw new Error("Gfx2TextureManager::getTexture(): The texture file doesn't exist, cannot get !");return this.textures.get(t)}hasTexture(t){return this.textures.has(t)}releaseTextures(){for(const t of this.textures.keys())this.textures.get(t).gpuTexture.destroy(),this.textures.delete(t)}}const D=new Un,Pt=1e-16;class b{w;x;y;z;constructor(t=1,e=0,s=0,i=0){this.w=t,this.x=e,this.y=s,this.z=i}static ZERO=new b(0,0,0,0);static ONE=new b(1,0,0,0);static createNormalized(t,e,s,i){let r=1/Math.sqrt(t*t+e*e+s*s+i*i);return new b(t*r,e*r,s*r,i*r)}static createRandom(){let t=Math.random(),e=Math.random(),s=Math.random(),i=Math.sqrt(1-t),r=Math.sqrt(t);return new b(r*Math.cos(2*Math.PI*s),i*Math.sin(2*Math.PI*e),i*Math.cos(2*Math.PI*e),r*Math.sin(2*Math.PI*s))}static createFromBetweenVectors(t,e){let s=t[0],i=t[1],r=t[2],n=e[0],a=e[1],h=e[2],l=Math.sqrt(s*s+i*i+r*r),u=Math.sqrt(n*n+a*a+h*h);l>0&&(s/=l,i/=l,r/=l),u>0&&(n/=u,a/=u,h/=u);let d=s*n+i*a+r*h;if(d>=1-Pt)return b.ONE;if(1+d<=Pt)return Math.abs(s)>Math.abs(r)?b.createNormalized(0,-i,s,0):b.createNormalized(0,0,-r,i);let p=i*h-r*a,E=r*n-s*h,T=s*a-i*n;return b.createNormalized(1+d,p,E,T)}static createFromAxisAngle(t,e){let s=t[0],i=t[1],r=t[2],n=e*.5,a=Math.sin(n),h=Math.cos(n),l=a/Math.sqrt(s*s+i*i+r*r);return new b(h,s*l,i*l,r*l)}static createFromEuler(t,e,s,i){let r=t*.5,n=e*.5,a=s*.5,h=Math.cos(r),l=Math.cos(n),u=Math.cos(a),d=Math.sin(r),p=Math.sin(n),E=Math.sin(a);return i===void 0||i==="ZXY"?new b(h*l*u-d*p*E,p*h*u-d*E*l,d*p*u+E*h*l,d*l*u+p*E*h):i==="XYZ"||i==="RPY"?new b(h*l*u-d*p*E,d*l*u+p*E*h,p*h*u-d*E*l,d*p*u+E*h*l):i==="YXZ"?new b(d*p*E+h*l*u,d*E*l+p*h*u,d*l*u-p*E*h,E*h*l-d*p*u):i==="ZYX"||i==="YPR"?new b(d*p*E+h*l*u,E*h*l-d*p*u,d*E*l+p*h*u,d*l*u-p*E*h):i==="YZX"?new b(h*l*u-d*p*E,d*p*u+E*h*l,d*l*u+p*E*h,p*h*u-d*E*l):i==="XZY"?new b(d*p*E+h*l*u,d*l*u-p*E*h,E*h*l-d*p*u,d*E*l+p*h*u):i==="ZYZ"?new b(h*l*u-d*E*l,p*E*h-d*p*u,d*p*E+p*h*u,d*l*u+E*h*l):i==="ZXZ"?new b(h*l*u-d*E*l,d*p*E+p*h*u,d*p*u-p*E*h,d*l*u+E*h*l):i==="YXY"?new b(h*l*u-d*E*l,d*p*E+p*h*u,d*l*u+E*h*l,p*E*h-d*p*u):i==="YZY"?new b(h*l*u-d*E*l,d*p*u-p*E*h,d*l*u+E*h*l,d*p*E+p*h*u):i==="XYX"?new b(h*l*u-d*E*l,d*l*u+E*h*l,d*p*E+p*h*u,d*p*u-p*E*h):i==="XZX"?new b(h*l*u-d*E*l,d*l*u+E*h*l,p*E*h-d*p*u,d*p*E+p*h*u):new b}static createFromMatrix(t){let e=t[0],s=t[1],i=t[2],r=t[3],n=t[4],a=t[5],h=t[6],l=t[7],u=t[8],d=e+n+u;return d>0?b.createNormalized(d+1,l-a,i-h,r-s):e>n&&e>u?b.createNormalized(l-a,1+e-n-u,s+r,i+h):n>u?b.createNormalized(i-h,s+r,1+n-e-u,a+l):b.createNormalized(r-s,i+h,a+l,1+u-e-n)}static createFromLookAt(t,e=c.VEC3_UP){const s=c.VEC3_NORMALIZE([-t[0],-t[1],-t[2]]),i=c.VEC3_CROSS(e,s),r=c.VEC3_CROSS(s,i);return b.createFromMatrix([i[0],i[1],i[2],r[0],r[1],r[2],s[0],s[1],s[2]])}rotateX(t){t*=.5;let e=Math.sin(t),s=Math.cos(t);return new b(this.w*s-this.x*e,this.x*s+this.w*e,this.y*s+this.z*e,this.z*s-this.y*e)}rotateY(t){t*=.5;let e=Math.sin(t),s=Math.cos(t);return new b(this.w*s-this.y*e,this.x*s-this.z*e,this.y*s+this.w*e,this.z*s+this.x*e)}rotateZ(t){t*=.5;let e=Math.sin(t),s=Math.cos(t);return new b(this.w*s-this.z*e,this.x*s+this.y*e,this.y*s-this.x*e,this.z*s+this.w*e)}add(t,e,s,i){return new b(this.w+t,this.x+e,this.y+s,this.z+i)}sub(t,e,s,i){return new b(this.w-t,this.x-e,this.y-s,this.z-i)}neg(){return new b(-this.w,-this.x,-this.y,-this.z)}norm(){return Math.sqrt(this.w*this.w+this.x*this.x+this.y*this.y+this.z*this.z)}normSq(){return this.w*this.w+this.x*this.x+this.y*this.y+this.z*this.z}normalize(){let t=Math.sqrt(this.w*this.w+this.x*this.x+this.y*this.y+this.z*this.z);return t<Pt?b.ZERO:(t=1/t,new b(this.w*t,this.x*t,this.y*t,this.z*t))}mul(t,e,s,i){return new b(this.w*t-this.x*e-this.y*s-this.z*i,this.w*e+this.x*t+this.y*i-this.z*s,this.w*s+this.y*t+this.z*e-this.x*i,this.w*i+this.z*t+this.x*s-this.y*e)}scale(t){return new b(this.w*t,this.x*t,this.y*t,this.z*t)}dot(t,e,s,i){return this.w*t+this.x*e+this.y*s+this.z*i}inverse(){let t=this.w*this.w+this.x*this.x+this.y*this.y+this.z*this.z;return t===0?b.ZERO:(t=1/t,new b(this.w*t,-this.x*t,-this.y*t,-this.z*t))}div(t,e,s,i){var r=t*t+e*e+s*s+i*i;return r===0?b.ZERO:(r=1/r,new b((this.w*t+this.x*e+this.y*s+this.z*i)*r,(this.x*t-this.w*e-this.y*i+this.z*s)*r,(this.y*t-this.w*s-this.z*e+this.x*i)*r,(this.z*t-this.w*i-this.x*s+this.y*e)*r))}conjugate(){return new b(this.w,-this.x,-this.y,-this.z)}exp(){let t=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z),e=Math.exp(this.w),s=e*Math.sin(t)/t;return t===0?new b(e,0,0,0):new b(e*Math.cos(t),this.x*s,this.y*s,this.z*s)}log(){if(this.y===0&&this.z===0)return new b(Hn(this.w,this.x),Math.atan2(this.x,this.w),0,0);let t=this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w,e=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z),s=Math.atan2(e,this.w)/e;return new b(Math.log(t)*.5,this.x*s,this.y*s,this.z*s)}equals(t,e,s,i){return Math.abs(t-this.w)<Pt&&Math.abs(e-this.x)<Pt&&Math.abs(s-this.y)<Pt&&Math.abs(i-this.z)<Pt}isFinite(){return isFinite(this.w)&&isFinite(this.x)&&isFinite(this.y)&&isFinite(this.z)}isNaN(){return isNaN(this.w)||isNaN(this.x)||isNaN(this.y)||isNaN(this.z)}real(){return this.w}imag(){return[this.x,this.y,this.z]}toVector(){return[this.w,this.x,this.y,this.z]}toMatrix(){let t=this.w*this.x,e=this.w*this.y,s=this.w*this.z,i=this.x*this.x,r=this.x*this.y,n=this.x*this.z,a=this.y*this.y,h=this.y*this.z,l=this.z*this.z;return[1-2*(a+l),2*(r-s),2*(n+e),2*(r+s),1-2*(i+l),2*(h-t),2*(n-e),2*(h+t),1-2*(i+a)]}toMatrix4(){var t=this.w*this.x,e=this.w*this.y,s=this.w*this.z,i=this.x*this.x,r=this.x*this.y,n=this.x*this.z,a=this.y*this.y,h=this.y*this.z,l=this.z*this.z;return[1-2*(a+l),2*(r-s),2*(n+e),0,2*(r+s),1-2*(i+l),2*(h-t),0,2*(n-e),2*(h+t),1-2*(i+a),0,0,0,0,1]}toCSSTransform(){let t=2*Math.acos(this.w),e=1-this.w*this.w;return e<Pt?(t=0,e=1):e=1/Math.sqrt(e),`rotate3d(${this.x*e}, ${this.y*e}, ${this.z*e}, ${t}rad)`}toAxisAngle(){let t=1-this.w*this.w;if(t<Pt)return[[this.x,this.y,this.z],0];let e=1/Math.sqrt(t),s=2*Math.acos(this.w);return[[this.x*e,this.y*e,this.z*e],s]}clone(){return new b(this.w,this.x,this.y,this.z)}rotateVector(t){var e=2*(this.y*t[2]-this.z*t[1]),s=2*(this.z*t[0]-this.x*t[2]),i=2*(this.x*t[1]-this.y*t[0]);return[t[0]+this.w*e+this.y*i-this.z*s,t[1]+this.w*s+this.z*e-this.x*i,t[2]+this.w*i+this.x*s-this.y*e]}slerp(t,e,s,i){let r=this.w,n=this.x,a=this.y,h=this.z;var l=r*t+n*e+a*s+h*i;if(l<0&&(r=-r,n=-n,a=-a,h=-h,l=-l),l>=1-Pt)return function(p){return b.createNormalized(r+p*(t-r),n+p*(e-n),a+p*(s-a),h+p*(i-h))};var u=Math.acos(l),d=Math.sin(u);return function(p){let E=u*p,T=Math.sin(E),x=Math.cos(E)-l*T/d,y=T/d;return new b(x*r+y*t,x*n+y*e,x*a+y*s,x*h+y*i)}}}function Hn(o,t){var e=Math.abs(o),s=Math.abs(t);return o===0?Math.log(s):t===0?Math.log(e):e<3e3&&s<3e3?.5*Math.log(o*o+t*t):(o=o/2,t=t/2,.5*Math.log(o*o+t*t)+Math.LN2)}class Ft{position;rotation;scale;quaternion;transformMatrix;constructor(){this.position=[0,0,0],this.rotation=[0,0,0],this.scale=[1,1,1],this.quaternion=new b,this.transformMatrix=c.MAT4_IDENTITY()}getPosition(){return this.position}getPositionX(){return this.position[0]}getPositionY(){return this.position[1]}getPositionZ(){return this.position[2]}setPosition(t,e,s){this.position[0]=t,this.position[1]=e,this.position[2]=s}translate(t,e,s){this.position[0]+=t,this.position[1]+=e,this.position[2]+=s}getRotation(){return this.rotation}getRotationX(){return this.rotation[0]}getRotationY(){return this.rotation[1]}getRotationZ(){return this.rotation[2]}setRotation(t,e,s){this.rotation[0]=t,this.rotation[1]=e,this.rotation[2]=s}rotate(t,e,s){this.rotation[0]+=t,this.rotation[1]+=e,this.rotation[2]+=s}setQuaternion(t){this.quaternion=t.clone()}getQuaternion(){return this.quaternion}getScale(){return this.scale}getScaleX(){return this.scale[0]}getScaleY(){return this.scale[1]}getScaleZ(){return this.scale[2]}setScale(t,e,s){this.scale[0]=t,this.scale[1]=e,this.scale[2]=s}zoom(t,e,s){this.scale[0]+=t,this.scale[1]+=e,this.scale[2]+=s}getTransformMatrix(){return c.MAT4_TRANSFORM(this.position,this.rotation,this.scale,this.quaternion,this.transformMatrix),this.transformMatrix}lookAt(t,e,s,i=[0,1,0]){c.MAT4_LOOKAT(this.position,[t,e,s],i,this.transformMatrix),c.MAT4_MULTIPLY(this.transformMatrix,c.MAT4_SCALE(this.scale[0],this.scale[1],this.scale[2]),this.transformMatrix),this.rotation[0]=-Math.asin(e),this.rotation[1]=Math.atan2(t,s),this.rotation[2]=0}getAxies(){const t=this.getTransformMatrix();return[[t[0],t[1],t[2]],[t[4],t[5],t[6]],[t[8],t[9],t[10]]]}}class Jt extends Ft{view;constructor(t){super(),this.view=v.getView(t)}setPosition(t,e,s){super.setPosition(t,e,s),this.view.setCameraMatrix(this.getTransformMatrix())}translate(t,e,s){super.translate(t,e,s),this.view.setCameraMatrix(this.getTransformMatrix())}setRotation(t,e,s){super.setRotation(t,e,s),this.view.setCameraMatrix(this.getTransformMatrix())}rotate(t,e,s){super.rotate(t,e,s),this.view.setCameraMatrix(this.getTransformMatrix())}setQuaternion(t){super.setQuaternion(t),this.view.setCameraMatrix(this.getTransformMatrix())}setScale(t,e,s){super.setScale(t,e,s),this.view.setCameraMatrix(this.getTransformMatrix())}zoom(t,e,s){super.zoom(t,e,s),this.view.setCameraMatrix(this.getTransformMatrix())}changeView(t){this.view=v.getView(t)}lookAt(t,e,s,i=[0,1,0]){super.lookAt(t,e,s,i),this.view.setCameraMatrix(this.transformMatrix)}getCameraMatrix(){return this.view.getCameraMatrix()}getAxies(){const t=this.view.getCameraMatrix();return[c.VEC3_CREATE(t[0],t[1],t[2]),c.VEC3_CREATE(t[4],t[5],t[6]),c.VEC3_CREATE(t[8],t[9],t[10])]}}class tr extends Jt{rotationSpeed;frictionCoefficient;maxPitch;minPitch;target;distance;zoomSpeed;velocityPhi;velocityTheta;phi;theta;lastDragTimestamp;constructor(t){super(t),this.rotationSpeed=2,this.frictionCoefficient=.99,this.maxPitch=Math.PI*.5-.01,this.minPitch=Math.PI*-.5+.01,this.target=[0,0,0],this.distance=10,this.zoomSpeed=.1,this.velocityPhi=0,this.velocityTheta=0,this.phi=Math.PI*.5,this.theta=0,this.lastDragTimestamp=0,m.subscribe(M,"E_MOUSE_WHEEL",this,this.$handleMouseWheel),m.subscribe(M,"E_MOUSE_UP",this,this.$handleMouseUp),m.subscribe(M,"E_MOUSE_DOWN",this,this.$handleMouseDown),m.subscribe(M,"E_MOUSE_DRAG",this,this.$handleMouseDrag)}delete(){m.unsubscribe(M,"E_MOUSE_WHEEL",this),m.unsubscribe(M,"E_MOUSE_UP",this),m.unsubscribe(M,"E_MOUSE_DOWN",this),m.unsubscribe(M,"E_MOUSE_DRAG",this)}update(t){const e=c.VEC3_ROTATE_AROUND(this.target,this.distance,this.phi,this.theta);this.setPosition(e[0],e[1],e[2]),this.lookAt(this.target[0],this.target[1],this.target[2]),M.isMouseDown()||(this.velocityTheta*=Math.pow(1-this.frictionCoefficient,t/1e3),this.velocityPhi*=Math.pow(1-this.frictionCoefficient,t/1e3),this.theta-=this.velocityTheta,this.phi-=this.velocityPhi)}setRotationSpeed(t){this.rotationSpeed=t}setFrictionCoefficient(t){this.frictionCoefficient=t}setMaxPitch(t){this.maxPitch=t}setMinPitch(t){this.minPitch=t}setTarget(t){this.target=t}setDistance(t){this.distance=t}setZoomSpeed(t){this.zoomSpeed=this.zoomSpeed}getRotationSpeed(){return this.rotationSpeed}getFrictionCoefficient(){return this.frictionCoefficient}getMaxPitch(){return this.maxPitch}getMinPitch(){return this.minPitch}getTarget(){return this.target}getDistance(){return this.distance}getZoomSpeed(){return this.zoomSpeed}getTheta(){return this.theta}getPhi(){return this.phi}$handleMouseUp(){Date.now()-this.lastDragTimestamp>=100&&(this.velocityTheta=0,this.velocityPhi=0)}$handleMouseDown(){this.velocityPhi=0,this.velocityTheta=0}$handleMouseDrag(t){this.velocityTheta=t.movementY*this.rotationSpeed/1e3,this.velocityPhi=t.movementX*this.rotationSpeed/1e3,this.theta-=this.velocityTheta,this.phi-=this.velocityPhi,this.theta=c.CLAMP(this.theta,this.minPitch,this.maxPitch),this.lastDragTimestamp=Date.now()}$handleMouseWheel(t){this.distance*=1+t.delta*this.zoomSpeed}}class j{min;max;constructor(t=[0,0,0],e=[0,0,0]){this.min=t,this.max=e}static createFromCoord(t,e,s,i,r,n){const a=new j;return a.min[0]=t,a.min[1]=e,a.min[2]=s,a.max[0]=t+i,a.max[1]=e+r,a.max[2]=s+n,a}static createFromCenter(t,e,s,i,r,n){const a=new j;return a.min[0]=t-i*.5,a.min[1]=e-r*.5,a.min[2]=s-n*.5,a.max[0]=t+i*.5,a.max[1]=e+r*.5,a.max[2]=s+n*.5,a}static createFromVertices(t,e){const s=new j;return s.fromVertices(t,e),s}static merge(t){const e=[t[0].min[0],t[0].min[1],t[0].min[2]],s=[t[0].max[0],t[0].max[1],t[0].max[2]];for(const i of t)for(let r=0;r<3;r++)e[r]=Math.min(i.min[r],e[r]),s[r]=Math.max(i.max[r],s[r]);return new j(e,s)}fromVertices(t,e){const s=[t[0],t[1],t[2]],i=[t[0],t[1],t[2]];for(let r=0;r<t.length;r+=e)for(let n=0;n<3;n++){const a=t[r+n];s[n]=Math.min(a,s[n]),i[n]=Math.max(a,i[n])}this.min=s,this.max=i}merge(t){const e=[this.min[0],this.min[1],this.min[2]],s=[this.max[0],this.max[1],this.max[2]];for(let i=0;i<3;i++)e[i]=Math.min(t.min[i],e[i]),s[i]=Math.max(t.max[i],s[i]);return new j(e,s)}getCenter(){const t=(this.min[0]+this.max[0])*.5,e=(this.min[1]+this.max[1])*.5,s=(this.min[2]+this.max[2])*.5;return[t,e,s]}getSize(){const t=this.max[0]-this.min[0],e=this.max[1]-this.min[1],s=this.max[2]-this.min[2];return[t,e,s]}getRadius(){return c.VEC3_DISTANCE(this.min,this.max)*.5}getPerimeter(){const t=this.max[0]-this.min[0],e=this.max[2]-this.min[2];return t+t+e+e}getVolume(){const t=this.max[0]-this.min[0],e=this.max[1]-this.min[1],s=this.max[2]-this.min[2];return t*e*s}transform(t){const e=[];e.push([this.min[0],this.min[1],this.min[2]]),e.push([this.max[0],this.min[1],this.min[2]]),e.push([this.max[0],this.max[1],this.min[2]]),e.push([this.min[0],this.max[1],this.min[2]]),e.push([this.min[0],this.max[1],this.max[2]]),e.push([this.max[0],this.max[1],this.max[2]]),e.push([this.max[0],this.min[1],this.max[2]]),e.push([this.min[0],this.min[1],this.max[2]]);const s=e.map(n=>c.MAT4_MULTIPLY_BY_VEC4(t,[n[0],n[1],n[2],1])),i=[s[0][0],s[0][1],s[0][2]],r=[s[0][0],s[0][1],s[0][2]];for(let n=0;n<s.length;n++)for(let a=0;a<3;a++){const h=s[n][a];i[a]=Math.min(h,i[a]),r[a]=Math.max(h,r[a])}return new j(i,r)}splitVertical(){const t=this.getSize(),e=this.getCenter();return[j.createFromCoord(this.min[0],this.min[1],this.min[2],t[0]*.5,t[1],t[2]),j.createFromCoord(e[0],this.min[1],this.min[2],t[0]*.5,t[1],t[2])]}splitHorizontal(){const t=this.getSize(),e=this.getCenter();return[j.createFromCoord(this.min[0],this.min[1],this.min[2],t[0],t[1]*.5,t[2]),j.createFromCoord(this.min[0],e[1],this.min[2],t[0],t[1]*.5,t[2])]}splitDepth(){const t=this.getSize(),e=this.getCenter();return[j.createFromCoord(this.min[0],this.min[1],this.min[2],t[0],t[1],t[2]*.5),j.createFromCoord(this.min[0],this.min[1],e[2],t[0],t[1],t[2]*.5)]}isPointInside(t,e,s){return c.COLLIDE_POINT_TO_BOX([t,e,s],this.min,this.max)}intersectBoundingBox(t){return c.COLLIDE_BOX_TO_BOX(this.min,this.max,t.min,t.max)}reset(){this.min=[0,0,0],this.max=[0,0,0]}setMin(t){this.min=t}setMax(t){this.max=t}}class xe extends Ft{id;vertexSubBuffer;vertices;vertexCount;vertexStride;boundingBox;constructor(t){super(),this.id=[0,0,0,1],this.vertexSubBuffer=v.createVertexBuffer(0),this.vertices=[],this.vertexCount=0,this.vertexStride=t,this.boundingBox=new j}delete(){v.destroyVertexBuffer(this.vertexSubBuffer)}update(t){}draw(){}beginVertices(t){v.destroyVertexBuffer(this.vertexSubBuffer),this.vertexSubBuffer=v.createVertexBuffer(t*this.vertexStride*4),this.vertices=[],this.vertexCount=t}defineVertex(...t){this.vertices.push(...t)}setVertices(t){this.vertices=t}endVertices(){v.writeVertexBuffer(this.vertexSubBuffer,this.vertices)}getVertexSubBufferOffset(){return this.vertexSubBuffer.offset}getVertexSubBufferSize(){return this.vertexSubBuffer.vertices.byteLength}getVertices(){return this.vertices}getVertexCount(){return this.vertexCount}setId(t){this.id=t}getId(){return this.id}getStringId(){return""+this.id[0]+this.id[1]+this.id[2]+this.id[3]}setBoundingBox(t){this.boundingBox=t}getBoundingBox(){return this.boundingBox}getWorldBoundingBox(){return this.boundingBox.transform(this.getTransformMatrix())}clone(t=new xe(this.vertexStride),e=c.MAT4_IDENTITY()){t.position=[this.position[0],this.position[1],this.position[2]],t.rotation=[this.rotation[0],this.rotation[1],this.rotation[2]],t.scale=[this.scale[0],this.scale[1],this.scale[2]],t.quaternion=new b(this.quaternion.w,this.quaternion.x,this.quaternion.y,this.quaternion.z),t.boundingBox=new j(this.boundingBox.min,this.boundingBox.max),t.beginVertices(this.vertexCount);for(let s=0;s<this.vertices.length;s+=this.vertexStride){const i=c.MAT4_MULTIPLY_BY_VEC4(e,[this.vertices[s+0],this.vertices[s+1],this.vertices[s+2],1]);t.defineVertex(i[0],i[1],i[2],...this.vertices.slice(3,this.vertexStride))}return t.endVertices(),t}}class ${animations;currentAnimation;currentAnimationFrameIndex;looped;frameProgress;dataChanged;texturesChanged;textureScrollAngle;textureScrollRate;displacementMapScrollAngle;displacementMapScrollRate;grp2;colors;params;uvs;grp3;texture;displacementMap;diffuseMap;specularMap;emissiveMap;normalMap;envMap;constructor(t){this.animations=t.animations??[],this.currentAnimation=null,this.currentAnimationFrameIndex=0,this.looped=!1,this.frameProgress=0,this.dataChanged=!0,this.texturesChanged=!1,this.textureScrollAngle=t.textureScrollAngle??0,this.textureScrollRate=t.textureScrollRate??0,this.displacementMapScrollAngle=t.displacementMapScrollAngle??0,this.displacementMapScrollRate=t.displacementMapScrollRate??0,this.grp2=v.createStaticGroup("MESH_PIPELINE",2),this.colors=this.grp2.setFloat(0,"MAT_COLORS",16),this.colors[0]=t.emissive?t.emissive[0]:0,this.colors[1]=t.emissive?t.emissive[1]:0,this.colors[2]=t.emissive?t.emissive[2]:0,this.colors[3]=0,this.colors[4]=t.ambient?t.ambient[0]:.5,this.colors[5]=t.ambient?t.ambient[1]:.5,this.colors[6]=t.ambient?t.ambient[2]:.5,this.colors[7]=0,this.colors[8]=t.diffuse?t.diffuse[0]:1,this.colors[9]=t.diffuse?t.diffuse[1]:1,this.colors[10]=t.diffuse?t.diffuse[2]:1,this.colors[11]=0,this.colors[12]=t.specular?t.specular[0]:0,this.colors[13]=t.specular?t.specular[1]:0,this.colors[14]=t.specular?t.specular[2]:0,this.colors[15]=0,this.params=this.grp2.setFloat(1,"MAT_PARAMS",15),this.params[0]=t.opacity??1,this.params[1]=t.normalIntensity??1,this.params[2]=t.lightning?1:0,this.params[3]=t.texture?1:0,this.params[4]=t.displacementMap?1:0,this.params[5]=t.displacementMapFactor??0,this.params[6]=t.diffuseMap?1:0,this.params[7]=t.specularMap?1:0,this.params[8]=t.emissiveMap?1:0,this.params[9]=t.normalMap?1:0,this.params[10]=t.envMap?1:0,this.params[11]=t.decalEnabled?1:0,this.params[12]=t.shadowEnabled?1:0,this.params[13]=t.shininess??0,this.params[14]=t.emissiveFactor??1,this.uvs=this.grp2.setFloat(2,"MAT_UVS",6),this.grp3=v.createStaticGroup("MESH_PIPELINE",3),this.texture=this.grp3.setTexture(0,"MAT_TEXTURE",t.texture??v.createTextureFromBitmap()),this.texture=this.grp3.setSampler(1,"MAT_SAMPLER",this.texture),this.displacementMap=this.grp3.setTexture(2,"MAT_DISPLACEMENT_TEXTURE",t.displacementMap??v.createTextureFromBitmap()),this.displacementMap=this.grp3.setSampler(3,"MAT_DISPLACEMENT_SAMPLER",this.displacementMap),this.diffuseMap=this.grp3.setTexture(4,"MAT_DIFFUSE_TEXTURE",t.diffuseMap??v.createTextureFromBitmap()),this.diffuseMap=this.grp3.setSampler(5,"MAT_DIFFUSE_SAMPLER",this.diffuseMap),this.specularMap=this.grp3.setTexture(6,"MAT_SPECULAR_TEXTURE",t.specularMap??v.createTextureFromBitmap()),this.specularMap=this.grp3.setSampler(7,"MAT_SPECULAR_SAMPLER",this.specularMap),this.emissiveMap=this.grp3.setTexture(8,"MAT_EMISSIVE_TEXTURE",t.emissiveMap??v.createTextureFromBitmap()),this.emissiveMap=this.grp3.setSampler(9,"MAT_EMISSIVE_SAMPLER",this.emissiveMap),this.normalMap=this.grp3.setTexture(10,"MAT_NORM_TEXTURE",t.normalMap??v.createTextureFromBitmap()),this.normalMap=this.grp3.setSampler(11,"MAT_NORM_SAMPLER",this.normalMap),this.envMap=this.grp3.setTexture(12,"MAT_ENV_MAP_TEXTURE",t.envMap??v.createCubeMapFromBitmap(),{dimension:"cube"}),this.envMap=this.grp3.setSampler(13,"MAT_ENV_MAP_SAMPLER",this.envMap),this.grp2.allocate(),this.grp3.allocate()}static async createFromFile(t){const s=await(await fetch(t)).json();if(!s.hasOwnProperty("Ident")||s.Ident!="MAT")throw new Error("Gfx3Material::loadFromFile(): File not valid !");const i=new Array;for(const r of s.Animations){const n={name:r.Name,frames:[],frameDuration:parseInt(r.FrameDuration)};for(const a of r.Frames)n.frames.push({offsetX:a.OffsetX,offsetY:a.OffsetY});i.push(n)}return new $({animations:i,opacity:s.Opacity,normalIntensity:s.NormalIntensity,lightning:s.Lightning,emissive:s.Emissive,ambient:s.Ambient,diffuse:s.Diffuse,specular:s.Specular,texture:s.Texture?await D.loadTexture(s.Texture):void 0,textureScrollAngle:s.TextureScrollAngle,textureScrollRate:s.TextureScrollRate,displacementMap:s.DisplacementMap?await D.loadTexture(s.DisplacementMap):void 0,displacementMapScrollAngle:s.DisplacementMapScrollAngle,displacementMapScrollRate:s.DisplacementMapScrollRate,displacementMapFactor:s.DisplacementMapFactor,diffuseMap:s.DiffuseMap?await D.loadTexture(s.DiffuseMap):void 0,specularMap:s.SpecularMap?await D.loadTexture(s.SpecularMap):void 0,emissiveMap:s.EmissiveMap?await D.loadTexture(s.EmissiveMap):void 0,normalMap:s.NormalMap?await D.loadTexture(s.NormalMap):void 0,envMap:s.EnvMap?await D.loadTexture(s.EnvMap):void 0,decalEnabled:s.DecalEnabled,shadowEnabled:s.ShadowEnabled,shininess:s.Shininess,emissiveFactor:s.EmissiveFactor})}delete(){this.grp2.delete(),this.grp3.delete()}update(t){if(this.textureScrollRate!=0&&(this.uvs[0]+=Math.cos(this.textureScrollAngle)*this.textureScrollRate*(t/1e3),this.uvs[1]+=Math.sin(this.textureScrollAngle)*this.textureScrollRate*(t/1e3),this.dataChanged=!0),this.displacementMapScrollRate!=0&&(this.uvs[4]+=Math.cos(this.displacementMapScrollAngle)*this.displacementMapScrollRate*(t/1e3),this.uvs[5]+=Math.sin(this.displacementMapScrollAngle)*this.displacementMapScrollRate*(t/1e3),this.dataChanged=!0),!this.currentAnimation)return;const e=this.currentAnimation.frames[this.currentAnimationFrameIndex];this.uvs[2]=e.offsetX/this.texture.gpuTexture.width,this.uvs[3]=e.offsetY/this.texture.gpuTexture.height,this.dataChanged=!0,this.frameProgress>=this.currentAnimation.frameDuration?this.currentAnimationFrameIndex==this.currentAnimation.frames.length-1?(m.emit(this,"E_FINISHED"),this.currentAnimationFrameIndex=this.looped?0:this.currentAnimation.frames.length-1,this.frameProgress=0):(this.currentAnimationFrameIndex=this.currentAnimationFrameIndex+1,this.frameProgress=0):this.frameProgress+=t}playAnimation(t,e=!1,s=!1){if(s&&this.currentAnimation&&t==this.currentAnimation.name)return;const i=this.animations.find(r=>r.name==t);if(!i)throw new Error("Gfx3Material::play: animation not found.");this.currentAnimation=i,this.currentAnimationFrameIndex=0,this.looped=e,this.frameProgress=0}resetAnimation(){this.currentAnimation=null,this.uvs[2]=0,this.uvs[3]=0,this.dataChanged=!0}setOpacity(t){this.params[0]=t,this.dataChanged=!0}setNormalIntensity(t){this.params[1]=t,this.dataChanged=!0}setLightning(t){this.params[2]=t?1:0,this.dataChanged=!0}setEmissive(t,e,s,i){this.colors[0]=t,this.colors[1]=e,this.colors[2]=s,this.colors[3]=i,this.dataChanged=!0}setAmbient(t,e,s){this.colors[4]=t,this.colors[5]=e,this.colors[6]=s,this.dataChanged=!0}setDiffuse(t,e,s){this.colors[8]=t,this.colors[9]=e,this.colors[10]=s,this.dataChanged=!0}setSpecular(t,e,s){this.colors[12]=t,this.colors[13]=e,this.colors[14]=s,this.dataChanged=!0}setSpecularity(t){this.colors[15]=t,this.dataChanged=!0}setTexture(t,e=0,s=0){this.texture=t,this.textureScrollAngle=e,this.textureScrollRate=s,this.params[3]=1,this.texturesChanged=!0,this.dataChanged=!0}setDisplacementMap(t,e=0,s=0,i=0){this.displacementMap=t,this.displacementMapScrollAngle=e,this.displacementMapScrollRate=s,this.params[4]=1,this.params[5]=i,this.texturesChanged=!0,this.dataChanged=!0}setDiffuseMap(t){this.diffuseMap=t,this.params[6]=1,this.texturesChanged=!0,this.dataChanged=!0}setSpecularMap(t){this.specularMap=t,this.params[7]=1,this.texturesChanged=!0,this.dataChanged=!0}setEmissiveMap(t){this.emissiveMap=t,this.params[8]=1,this.texturesChanged=!0,this.dataChanged=!0}setNormalMap(t){this.normalMap=t,this.params[9]=1,this.texturesChanged=!0,this.dataChanged=!0}setEnvMap(t){this.envMap=t,this.params[10]=1,this.texturesChanged=!0,this.dataChanged=!0}enableDecal(t){this.params[11]=t?1:0,this.dataChanged=!0}enableShadow(t){this.params[12]=t?1:0,this.dataChanged=!0}setShininess(t){this.params[13]=t,this.dataChanged=!0}setEmissiveFactor(t){this.params[14]=t,this.dataChanged=!0}getGroup02(){return this.dataChanged&&(this.grp2.beginWrite(),this.grp2.write(0,this.colors),this.grp2.write(1,this.params),this.grp2.write(2,this.uvs),this.grp2.endWrite(),this.dataChanged=!1),this.grp2}getGroup03(){return this.texturesChanged&&(this.grp3.setTexture(0,"MAT_TEXTURE",this.texture),this.grp3.setTexture(2,"MAT_DISPLACEMENT_TEXTURE",this.displacementMap),this.grp3.setTexture(4,"MAT_DIFFUSE_TEXTURE",this.diffuseMap),this.grp3.setTexture(6,"MAT_SPECULAR_TEXTURE",this.specularMap),this.grp3.setTexture(8,"MAT_EMISSIVE_TEXTURE",this.emissiveMap),this.grp3.setTexture(10,"MAT_NORM_TEXTURE",this.normalMap),this.grp3.setTexture(12,"MAT_ENV_MAP_TEXTURE",this.envMap,{dimension:"cube"}),this.grp3.allocate(),this.texturesChanged=!1),this.grp3}getTexture(){return this.texture}getDisplacementMap(){return this.displacementMap}getDiffuseMap(){return this.diffuseMap}getSpecularMap(){return this.specularMap}getEmissiveMap(){return this.emissiveMap}getNormalMap(){return this.normalMap}getEnvMap(){return this.envMap}}class xt extends xe{layer;shadowCasting;material;constructor(){super(F),this.layer=0,this.shadowCasting=!1,this.material=new $({})}static buildVertices(t,e,s,i,r,n){const a=new Array,h=new Array,l=new Array,u=new Array,d=new Array,p=new Array,E=new Array,T=new Array,A=new Array,x=new Array;if(!n){n=[{name:"default",faces:[],vertexCount:t}];for(let y=0;y<t;y+=3)n[0].faces.push({v:[y+0,y+1,y+2],t:[y+0,y+1,y+2],n:[y+0,y+1,y+2],smoothGroup:0})}for(const y of n)for(const C of y.faces){h.push([e[C.v[0]*3+0],e[C.v[0]*3+1],e[C.v[0]*3+2]]),h.push([e[C.v[1]*3+0],e[C.v[1]*3+1],e[C.v[1]*3+2]]),h.push([e[C.v[2]*3+0],e[C.v[2]*3+1],e[C.v[2]*3+2]]),s?(l.push([s[C.t[0]*2+0],s[C.t[0]*2+1]]),l.push([s[C.t[1]*2+0],s[C.t[1]*2+1]]),l.push([s[C.t[2]*2+0],s[C.t[2]*2+1]])):(l.push([0,0]),l.push([0,0]),l.push([0,0])),i?(u.push([i[C.v[0]*3+0],i[C.v[0]*3+1],i[C.v[0]*3+2]]),u.push([i[C.v[1]*3+0],i[C.v[1]*3+1],i[C.v[1]*3+2]]),u.push([i[C.v[2]*3+0],i[C.v[2]*3+1],i[C.v[2]*3+2]])):(u.push([1,1,1]),u.push([1,1,1]),u.push([1,1,1]));const S=c.VEC3_SUBSTRACT(h.at(-2),h.at(-3)),w=c.VEC3_SUBSTRACT(h.at(-1),h.at(-3)),P=c.VEC2_SUBSTRACT(l.at(-2),l.at(-3)),O=c.VEC2_SUBSTRACT(l.at(-1),l.at(-3));if(r)d.push([r[C.n[0]*3+0],r[C.n[0]*3+1],r[C.n[0]*3+2]]),d.push([r[C.n[1]*3+0],r[C.n[1]*3+1],r[C.n[1]*3+2]]),d.push([r[C.n[2]*3+0],r[C.n[2]*3+1],r[C.n[2]*3+2]]);else{const L=c.VEC3_NORMALIZE(c.VEC3_CROSS(S,w));d.push(L),d.push(L),d.push(L)}const _=[0,0,0],H=Wn(S,w,P,O,_);E.push(H),E.push(H),E.push(H),p.push(_),p.push(_),p.push(_),C.smoothGroup&&(A[C.smoothGroup]=A[C.smoothGroup]||[],A[C.smoothGroup][C.v[0]]=A[C.smoothGroup][C.v[0]]?c.VEC3_ADD(A[C.smoothGroup][C.v[0]],d.at(-3)):d.at(-3),A[C.smoothGroup][C.v[1]]=A[C.smoothGroup][C.v[1]]?c.VEC3_ADD(A[C.smoothGroup][C.v[1]],d.at(-2)):d.at(-2),A[C.smoothGroup][C.v[2]]=A[C.smoothGroup][C.v[2]]?c.VEC3_ADD(A[C.smoothGroup][C.v[2]],d.at(-1)):d.at(-1),x[C.smoothGroup]=x[C.smoothGroup]||[],x[C.smoothGroup][C.v[0]]=x[C.smoothGroup][C.v[0]]?c.VEC3_ADD(x[C.smoothGroup][C.v[0]],_):_,x[C.smoothGroup][C.v[1]]=x[C.smoothGroup][C.v[1]]?c.VEC3_ADD(x[C.smoothGroup][C.v[1]],_):_,x[C.smoothGroup][C.v[2]]=x[C.smoothGroup][C.v[2]]?c.VEC3_ADD(x[C.smoothGroup][C.v[2]],_):_)}for(let y=0,C=0;y<n.length;y++)for(const S of n[y].faces)for(let w=0;w<3;w++)S.smoothGroup&&(d[C]=c.VEC3_NORMALIZE(A[S.smoothGroup][S.v[w]]),p[C]=c.VEC3_NORMALIZE(x[S.smoothGroup][S.v[w]])),T[C]=c.VEC3_SCALE(c.VEC3_CROSS(d[C],p[C]),E[C]),a.push(h[C][0],h[C][1],h[C][2],l[C][0],l[C][1],u[C][0],u[C][1],u[C][2],d[C][0],d[C][1],d[C][2],p[C][0],p[C][1],p[C][2],T[C][0],T[C][1],T[C][2]),C++;return a}delete(t=!1){t||this.material.delete(),super.delete()}update(t){this.material.update(t)}draw(){ht.drawMesh(this)}setLayer(t){this.layer=t}getLayer(){return this.layer}setShadowCasting(t){this.shadowCasting=t}getShadowCasting(){return this.shadowCasting}setMaterial(t,e=!0){e||this.material.delete(),this.material=t}getMaterial(){return this.material}clone(t=new xt,e=c.MAT4_IDENTITY()){return super.clone(t,e),t.layer=this.layer,t.shadowCasting=this.shadowCasting,t.material=this.material,t}get mat(){return this.material}}function Wn(o,t,e,s,i){const r=e[0]*s[1]-e[1]*s[0];if(Math.abs(r)>c.EPSILON){const n=1/r,a=r>0?1:-1,h=(o[0]*s[1]-t[0]*e[1])*n,l=(o[1]*s[1]-t[1]*e[1])*n,u=(o[2]*s[1]-t[2]*e[1])*n,d=c.VEC3_NORMALIZE([h,l,u]);return i[0]=d[0],i[1]=d[1],i[2]=d[2],a}return-1}class G extends xt{constructor(){super()}async loadFromFile(t){const s=await(await fetch(t)).json();if(!s.hasOwnProperty("Ident")||s.Ident!="JSM")throw new Error("Gfx3MeshJSM::loadFromFile(): File not valid !");this.beginVertices(s.NumVertices),this.setVertices(xt.buildVertices(s.NumVertices,s.Vertices,s.TextureCoords,s.Colors,s.Normals)),this.endVertices(),this.boundingBox=j.createFromVertices(s.Vertices,3)}clone(t=new G,e=c.MAT4_IDENTITY()){return super.clone(t,e),t}}class ei{name;coords;colors;texcoords;normals;lines;groups;materialName;vertexCount;constructor(){this.name="",this.coords=new Array,this.colors=new Array,this.texcoords=new Array,this.normals=new Array,this.lines=new Array,this.groups=new Array,this.materialName="",this.vertexCount=0}}class ns extends xt{coords;colors;texcoords;normals;objects;materials;meshes;debugVertices;debugVertexCount;constructor(){super(),this.coords=new Array,this.colors=new Array,this.texcoords=new Array,this.normals=new Array,this.objects=new Map,this.materials=new Map,this.meshes=new Map,this.debugVertices=new Array,this.debugVertexCount=0}async loadFromFile(t,e){await this.$loadMaterials(e),await this.$loadObjects(t),this.$build()}delete(){for(const t of this.meshes.values())t.delete(!0);for(const t of this.materials.values())t.delete();super.delete()}update(t){for(const e of this.meshes.values())e.update(t)}draw(){for(const t of this.meshes.values()){const e=c.MAT4_MULTIPLY(this.getTransformMatrix(),t.getTransformMatrix());ht.drawMesh(t,e)}this.debugVertexCount>0&&dt.drawVertices(this.debugVertices,this.debugVertexCount,this.getTransformMatrix())}getVertexCount(){let t=0;for(const e of this.meshes.values())t+=e.getVertexCount();return t}getVertices(){let t=new Array;for(const e of this.meshes.values())t.concat(e.getVertices());return t}getMesh(t){if(!this.meshes.has(t))throw new Error("Gfx3MeshOBJ::getMesh(): The mesh object doesn't exist !");return this.meshes.get(t)}getMeshes(){return this.meshes.values()}getObject(t){if(!this.objects.has(t))throw new Error("Gfx3MeshOBJ::getObject(): The object doesn't exist !");return this.objects.get(t)}getBoundingBox(){const t=new Array;for(const e of this.meshes.values())t.push(e.getBoundingBox());return j.merge(t)}getWorldBoundingBox(){const t=new Array;for(const e of this.meshes.values())t.push(e.getWorldBoundingBox());return j.merge(t)}clone(t=new ns,e=c.MAT4_IDENTITY()){t.coords=this.coords,t.colors=this.colors,t.texcoords=this.texcoords,t.normals=this.normals,t.objects=this.objects,t.materials=this.materials;for(const s in this.meshes){const i=this.meshes.get(s);t.meshes.set(s,i.clone(new xt,e))}return t.debugVertices=this.debugVertices,t.debugVertexCount=this.debugVertexCount,t}async $loadMaterials(t){const i=(await(await fetch(t)).text()).split(`
`);this.materials.clear();let r=null,n=null;t=t.split("/").slice(0,-1).join("/")+"/";for(const a of i)if(a.startsWith("newmtl ")&&(n=a.substring(7),r=new $({lightning:!0}),this.materials.set(n,r)),!!r){if(a.startsWith("Kd ")){const h=a.substring(3).split(" "),l=parseFloat(h[0]),u=parseFloat(h[1]),d=parseFloat(h[2]);r.setDiffuse(l,u,d)}if(a.startsWith("Ks ")){const h=a.substring(3).split(" "),l=parseFloat(h[0]),u=parseFloat(h[1]),d=parseFloat(h[2]);r.setSpecular(l,u,d)}if(a.startsWith("Ns ")){const h=a.substring(3);r.setSpecularity(parseFloat(h))}if(a.startsWith("d")){const h=a.substring(1);r.setOpacity(parseFloat(h))}if(a.startsWith("Ke ")){const h=a.substring(3).split(" "),l=parseFloat(h[0]),u=parseFloat(h[1]),d=parseFloat(h[2]);r.setEmissive(l,u,d,1)}if(a.startsWith("map_Kd ")){const h=a.substring(7);r.setTexture(await D.loadTexture(t+h))}if(a.startsWith("map_Ns ")){const h=a.substring(7);r.setSpecularMap(await D.loadTexture8bit(t+h))}if(a.startsWith("map_Bump ")){const h=a.split(" ");let l=1;for(;h[l][0]=="-";)h[l].substring(1)=="bm"&&r.setNormalIntensity(parseFloat(h[l+1])),l++;const u=h.join(" ");r.setNormalMap(await D.loadTexture(t+u))}}}async $loadObjects(t){const i=(await(await fetch(t)).text()).split(`
`);this.coords=[],this.colors=[],this.texcoords=[],this.normals=[],this.objects.clear();let r={name:"default",faces:[],vertexCount:0},n=0,a=new ei;a.groups=[r];for(const h of i){if(h.startsWith("o ")){const l=new ei;l.name=h.substring(2),l.groups=[{name:"default",faces:[],vertexCount:0}],a=l,r=l.groups[0],this.objects.set(l.name,l)}if(h.startsWith("usemtl ")&&(a.materialName=h.substring(7)),h.startsWith("v ")){const l=h.substring(2).split(" "),u=parseFloat(l[0]),d=parseFloat(l[1]),p=parseFloat(l[2]);if(this.coords.push(u,d,p),a.coords.push(u,d,p),l.length>3){const E=parseFloat(l[3]),T=parseFloat(l[4]),A=parseFloat(l[5]);this.colors.push(E,T,A),a.colors.push(E,T,A)}}if(h.startsWith("vt ")){const l=h.substring(3).split(" "),u=parseFloat(l[0]),d=1-parseFloat(l[1]);this.texcoords.push(u,d),a.texcoords.push(u,d)}if(h.startsWith("vn ")){const l=h.substring(3).split(" "),u=parseFloat(l[0]),d=parseFloat(l[1]),p=parseFloat(l[2]);this.normals.push(u,d,p),a.normals.push(u,d,p)}if(h.startsWith("s ")){const l=h.substring(2);n=parseInt(l)}if(h.startsWith("g ")){const l=h.substring(2),u=a.groups.find(d=>d.name==l);if(u)r=u;else{const d={name:l,faces:[],vertexCount:0};a.groups.push(d),r=d}}if(h.startsWith("f ")){const l=h.substring(2).split(" ");if(l.length>3)throw new Error("Gfx3MeshOBJ::loadObjects(): No support of quad faces !");const u=l[0].split("/"),d=l[1].split("/"),p=l[2].split("/");r.faces.push({v:[parseInt(u[0])-1,parseInt(d[0])-1,parseInt(p[0])-1],t:[parseInt(u[1])-1,parseInt(d[1])-1,parseInt(p[1])-1],n:[parseInt(u[2])-1,parseInt(d[2])-1,parseInt(p[2])-1],smoothGroup:n}),r.vertexCount+=3,a.vertexCount+=3}if(h.startsWith("l ")){const l=h.substring(2).split(" "),u=this.coords[(parseInt(l[0])-1)*3+0],d=this.coords[(parseInt(l[0])-1)*3+1],p=this.coords[(parseInt(l[0])-1)*3+2],E=this.coords[(parseInt(l[1])-1)*3+0],T=this.coords[(parseInt(l[1])-1)*3+1],A=this.coords[(parseInt(l[1])-1)*3+2];a.lines.push([u,d,p]),a.lines.push([E,T,A]),a.vertexCount+=2}}}$build(){this.meshes.clear(),this.debugVertices=[],this.debugVertexCount=0;for(const t of this.objects.values())if(t.lines.length>0)for(const e of t.lines)this.debugVertices.push(e[0],e[1],e[2],1,1,1),this.debugVertexCount++;else{const e=new xt,s=this.materials.get(t.materialName);s&&e.setMaterial(s);const i=t.texcoords.length>0?this.texcoords:void 0,r=t.normals.length>0?this.normals:void 0,n=t.colors.length>0?this.colors:void 0;e.beginVertices(t.vertexCount),e.setVertices(xt.buildVertices(t.vertexCount,this.coords,i,n,r,t.groups)),e.endVertices(),e.setBoundingBox(j.createFromVertices(this.coords,3)),this.meshes.set(t.name,e)}}}class er extends xe{cubemapChanged;grp1;cubemap;constructor(){super(Zi),this.cubemapChanged=!1,this.grp1=v.createStaticGroup("SKYBOX_PIPELINE",1),this.cubemap=this.grp1.setTexture(0,"CUBEMAP_TEXTURE",v.createCubeMapFromBitmap(),{dimension:"cube"}),this.cubemap=this.grp1.setSampler(1,"CUBEMAP_SAMPLER",this.cubemap),this.beginVertices(6),this.defineVertex(-1,-1,-1,-1,-1,-1),this.defineVertex(1,-1,-1,-1,-1,1),this.defineVertex(-1,1,-1,1,-1,1),this.defineVertex(-1,1,-1,-1,-1,-1),this.defineVertex(1,-1,-1,1,-1,1),this.defineVertex(1,1,-1,1,-1,-1),this.endVertices(),this.grp1.allocate()}delete(){this.grp1.delete(),super.delete()}draw(){$i.draw(this)}setCubemap(t){this.cubemap=t,this.cubemapChanged=!0}getCubemap(){return this.cubemap}getGroup01(){return this.cubemapChanged&&(this.grp1.setTexture(0,"CUBEMAP_TEXTURE",this.cubemap,{dimension:"cube"}),this.grp1.allocate(),this.cubemapChanged=!1),this.grp1}}class jn extends U{constructor(){super(),this.camera=new tr(0),this.mesh=new G,this.skybox=new er,this.handleKeyDownCb=this.handleKeyDown.bind(this)}async onEnter(){this.camera.setPosition(0,0,10),this.mesh=await si(),this.skybox=await Gn(),g.addNode(zn(),"position:absolute; bottom:10px; right:10px"),document.addEventListener("keydown",this.handleKeyDownCb)}onExit(){document.removeEventListener("keydown",this.handleKeyDownCb)}update(t){const e=Date.now()/1e4;this.mesh.setRotation(Math.sin(e),Math.cos(e),0),this.mesh.update(t),this.camera.update(t)}draw(){this.mesh.draw(),this.skybox.draw(),ht.drawPointLight([0,30,0],[1,1,1],[1,0,0],[0,0,0]),ht.drawPointLight([30,0,0],[0,0,0],[0,1,0],[0,0,0]),ht.drawPointLight([-30,0,0],[0,0,0],[0,0,1],[0,0,0]),dt.drawGrid(c.MAT4_ROTATE_X(Math.PI*.5),20,1)}async handleKeyDown(t){t.repeat||(t.key=="o"||t.key=="O"?this.mesh=await kn():t.key=="b"||t.key=="B"?this.mesh=await qn():t.key=="c"||t.key=="C"?this.mesh=await si():t.key=="s"||t.key=="S"?this.mesh=await Yn():t.key=="d"||t.key=="D"?this.mesh=await Xn():t.key=="f"||t.key=="F"?v.hasFilter()?v.setFilter(""):v.setFilter("grayscale(100%)"):(t.key=="p"||t.key=="P")&&Ht.setParam(0,!Ht.getParam(0)))}}async function Gn(){const o=new er;return o.setCubemap(await D.loadCubemapTexture("./samples/viewer/sky_","png")),o}async function kn(){const o=new ns;return await o.loadFromFile("./samples/viewer/wavefront.obj","./samples/viewer/wavefront.mtl"),o.getMesh("letter-f")}async function qn(){const o=new G;return await o.loadFromFile("./samples/viewer/cube_brick.jsm"),o.setMaterial(new $({texture:await D.loadTexture("./samples/viewer/cube_brick.png"),normalMap:await D.loadTexture("./samples/viewer/cube_brick_normal.png"),normalIntensity:5,lightning:!0})),o}async function si(){const o=new G;return await o.loadFromFile("./samples/viewer/cube.jsm"),o.setMaterial(new $({texture:await D.loadTexture("./samples/viewer/cube.png"),lightning:!0})),o}async function Yn(){const o=new G;return await o.loadFromFile("./samples/viewer/cube_sprite.jsm"),o.setMaterial(new $({texture:await D.loadTexture("./samples/viewer/cube_sprite.png"),lightning:!1,animations:[{name:"Default",frames:[{offsetX:0,offsetY:0},{offsetX:850,offsetY:0},{offsetX:1700,offsetY:0}],frameDuration:100}]})),o.mat.playAnimation("Default",!0),o}async function Xn(){const o=new G;return await o.loadFromFile("./samples/viewer/duck.jsm"),o.setMaterial(new $({texture:await D.loadTexture("./samples/viewer/duck.png"),lightning:!0})),o}function zn(){const o=document.createElement("div");o.style.backgroundColor="rgba(0, 0, 0, 0.2)",o.style.padding="10px",o.style.backdropFilter="blur(3px)";const t=document.createElement("ul");t.style.listStyle="none",t.style.paddingLeft="0px",o.appendChild(t);{const e=document.createElement("li");e.textContent="[c] => Load Cube",t.appendChild(e)}{const e=document.createElement("li");e.textContent="[b] => Load Cube Normal Map",t.appendChild(e)}{const e=document.createElement("li");e.textContent="[s] => Load Cube Texture Sprite",t.appendChild(e)}{const e=document.createElement("li");e.textContent="[d] => Load Duck",t.appendChild(e)}{const e=document.createElement("li");e.textContent="[o] => Load Obj Wavefront",t.appendChild(e)}{const e=document.createElement("li");e.textContent="[f] => Toggle Filtering (greyscale)",t.appendChild(e)}{const e=document.createElement("li");e.textContent="[p] => Toggle PPE PSX",t.appendChild(e)}return o}class lt extends W{constructor(){super({className:"UIText",template:'<span class="UIText-text js-text"></span>'})}setText(t){this.node.querySelector(".js-text").textContent=t}}class Zn extends U{constructor(){super(),this.uiTitle=new lt,this.uiMenu1=new it,this.uiMenu2=new it}async onEnter(){this.uiTitle.setText("Menu"),g.addWidget(this.uiTitle,"position:absolute; top:0; left:0; right:0; height:50px"),this.uiMenu1.add("1","Menu 1 Text 1"),this.uiMenu1.add("2","Menu 1 Text 2"),this.uiMenu1.add("3","Menu 1 Text 3"),g.addWidget(this.uiMenu1,"position:absolute; top:50px; left:0; bottom:0; width:40%"),this.uiMenu2.add("1","Menu 2 Text 1"),this.uiMenu2.add("2","Menu 2 Text 2"),this.uiMenu2.add("3","Menu 2 Test 3"),g.addWidget(this.uiMenu2,"position:absolute; top:50px; left:40%; bottom:0; width:60%"),m.subscribe(this.uiMenu1,"E_ITEM_SELECTED",this,this.handleMenu1ItemSelected),m.subscribe(this.uiMenu2,"E_CLOSED",this,this.handleMenu2Closed),m.subscribe(this.uiMenu2,"E_ITEM_SELECTED",this,this.handleMenu2ItemSelected),g.focus(this.uiMenu1)}onExit(){g.removeWidget(this.uiTitle),g.removeWidget(this.uiMenu1),g.removeWidget(this.uiMenu2)}handleMenu1ItemSelected(t){g.focus(this.uiMenu2)}handleMenu2Closed(){this.uiMenu1.unselectWidgets(),g.focus(this.uiMenu1)}handleMenu2ItemSelected(t){this.uiTitle.setText("You have selected menu item at index : "+t.index),this.uiMenu1.unselectWidgets(),this.uiMenu2.unselectWidgets(),g.focus(this.uiMenu1)}}class Xe{sectors;sectorsData;neighborPool;sharedPool;points;walkers;debugVertices;debugVertexCount;constructor(){this.sectors=[],this.sectorsData=[],this.neighborPool=[],this.sharedPool=[],this.points=new Map,this.walkers=new Map,this.debugVertices=[],this.debugVertexCount=0}async loadFromFile(t){const s=await(await fetch(t)).json();if(!s.hasOwnProperty("Ident")||s.Ident!="JWM")throw new Error("GfxJWM::loadFromFile(): File not valid !");this.sectors=[];for(const i of s.Sectors)this.sectors.push({v1:i[0],v2:i[1],v3:i[2]});this.sectorsData=[];for(const i of s.SectorsData){const r=i.SectorIndex;this.sectorsData[r]=i}this.neighborPool=[];for(const i of s.NeighborPool)this.neighborPool.push({s1:i[0],s2:i[1],s3:i[2]});this.sharedPool=[];for(const i of s.SharedPool)this.sharedPool.push({sectorIds:i})}update(){this.debugVertices=[],this.debugVertexCount=0;for(const t of this.sectors)this.debugVertices.push(t.v1[0],t.v1[1],t.v1[2],1,1,1),this.debugVertices.push(t.v2[0],t.v2[1],t.v2[2],1,1,1),this.debugVertices.push(t.v1[0],t.v1[1],t.v1[2],1,1,1),this.debugVertices.push(t.v3[0],t.v3[1],t.v3[2],1,1,1),this.debugVertices.push(t.v2[0],t.v2[1],t.v2[2],1,1,1),this.debugVertices.push(t.v3[0],t.v3[1],t.v3[2],1,1,1),this.debugVertexCount+=6;for(const t of this.walkers.values())this.debugVertices.push(t.points[1].x,t.points[1].y,t.points[1].z,1,1,1),this.debugVertices.push(t.points[2].x,t.points[2].y,t.points[2].z,1,1,1),this.debugVertices.push(t.points[2].x,t.points[2].y,t.points[2].z,1,1,1),this.debugVertices.push(t.points[3].x,t.points[3].y,t.points[3].z,1,1,1),this.debugVertices.push(t.points[3].x,t.points[3].y,t.points[3].z,1,1,1),this.debugVertices.push(t.points[4].x,t.points[4].y,t.points[4].z,1,1,1),this.debugVertices.push(t.points[4].x,t.points[4].y,t.points[4].z,1,1,1),this.debugVertices.push(t.points[1].x,t.points[1].y,t.points[1].z,1,1,1),this.debugVertexCount+=8}draw(){dt.drawVertices(this.debugVertices,this.debugVertexCount,c.MAT4_IDENTITY());for(const t of this.points.values())dt.drawSphere(c.MAT4_TRANSLATE(t.x,t.y,t.z),.01,2)}addPoint(t,e,s){if(this.points.has(t))throw new Error("Gfx3PhysicsJWM::addPoint: point with id "+t+" already exist.");this.points.set(t,this.$utilsCreatePoint(e,s))}removePoint(t){if(!this.points.has(t))throw new Error("Gfx3PhysicsJWM::removePoint(): point not exist !");this.points.delete(t)}getPoint(t){const e=this.points.get(t);if(!e)throw new Error("Gfx3PhysicsJWM::getPoint: point with id "+t+" not exist.");return e}movePoint(t,e,s){const i=this.$utilsMove(t.sectorIndex,t.x,t.z,e,s);return t.sectorIndex=i.sectorIndex,t.x+=i.mx,t.y=i.elevation,t.z+=i.mz,{point:t,move:[i.mx,i.elevation-t.y,i.mz],collide:e!=i.mx||s!=i.mz}}addWalker(t,e,s,i){if(this.walkers.has(t))throw new Error("Gfx3PhysicsJWM::addWalkerFromRadius: walker with id "+t+" already exist.");const r={id:t,points:[this.$utilsCreatePoint(e,s),this.$utilsCreatePoint(e+i,s+i),this.$utilsCreatePoint(e+i,s-i),this.$utilsCreatePoint(e-i,s-i),this.$utilsCreatePoint(e-i,s+i)]};return this.walkers.set(t,r),r}removeWalker(t){if(!this.walkers.has(t))throw new Error("Gfx3PhysicsJWM::removeWalker(): Walker not exist !");this.walkers.delete(t)}getWalker(t){if(!this.walkers.has(t))throw new Error("Gfx3PhysicsJWM::getWalker: walker with id "+t+" not exist.");return this.walkers.get(t)}moveWalker(t,e,s){let i=e,r=s,n=0,a=0,h=[],l=[],u=0;for(;u<t.points.length;){let d=!1;if(!h[u]){const p=this.$utilsMove(t.points[u].sectorIndex,t.points[u].x,t.points[u].z,i,r);if(p.mx==0&&p.mz==0){i=0,r=0,l=[];break}(p.mx!=i||p.mz!=r)&&(a++,i=p.mx,r=p.mz,d=!0,h[u]=!0),l[u]=p,n=l[0].elevation-t.points[0].y}if(a>=2){i=0,r=0,l=[];break}u=d?0:u+1}for(let d=0;d<l.length;d++)t.points[d].sectorIndex=l[d].sectorIndex,t.points[d].x+=i,t.points[d].y=l[d].elevation,t.points[d].z+=r;return{walker:t,move:[i,n,r],collide:e!=i||s!=r}}clearWalkers(){this.walkers.clear()}getSectorData(t){return this.sectorsData[t]}$utilsMove(t,e,s,i,r,n=0){if(i>-c.BIG_EPSILON&&i<+c.BIG_EPSILON&&r>-c.BIG_EPSILON&&r<+c.BIG_EPSILON)return{sectorIndex:t,mx:0,mz:0,elevation:1/0};if(n>=this.sharedPool[t].sectorIds.length)return{sectorIndex:t,mx:0,mz:0,elevation:1/0};const a=this.sharedPool[t].sectorIds[n],h=this.sectors[a].v1,l=this.sectors[a].v2,u=this.sectors[a].v3;if(c.TRI2_POINT_INSIDE([e+i,s+r],[h[0],h[2]],[l[0],l[2]],[u[0],u[2]])==1){const A=c.TRI3_POINT_ELEVATION([e+i,s+r],h,l,u);return{sectorIndex:a,mx:i,mz:r,elevation:A}}const p=[l[0]-h[0],l[2]-h[2]],E=[u[0]-l[0],u[2]-l[2]],T=[h[0]-u[0],h[2]-u[2]];return this.neighborPool[a].s1==-1&&c.COLLIDE_LINE_TO_LINE([h[0],h[2]],[l[0],l[2]],[e,s],[e+i,s+r])?([i,r]=c.VEC2_PROJECTION_COS([i,r],p),this.$utilsMove(t,e,s,i,r,0)):this.neighborPool[a].s2==-1&&c.COLLIDE_LINE_TO_LINE([l[0],l[2]],[u[0],u[2]],[e,s],[e+i,s+r])?([i,r]=c.VEC2_PROJECTION_COS([i,r],E),this.$utilsMove(t,e,s,i,r,0)):this.neighborPool[a].s3==-1&&c.COLLIDE_LINE_TO_LINE([u[0],u[2]],[h[0],h[2]],[e,s],[e+i,s+r])?([i,r]=c.VEC2_PROJECTION_COS([i,r],T),this.$utilsMove(t,e,s,i,r,0)):this.$utilsMove(t,e,s,i,r,n+1)}$utilsCreatePoint(t,e){const s=this.$utilsFindLocationInfo(t,e);return{sectorIndex:s.sectorIndex,x:t,y:s.elev,z:e}}$utilsFindLocationInfo(t,e){for(let s=0;s<this.sectors.length;s++){const i=this.sectors[s].v1,r=this.sectors[s].v2,n=this.sectors[s].v3;if(c.TRI2_POINT_INSIDE([t,e],[i[0],i[2]],[r[0],r[2]],[n[0],n[2]])==1)return{sectorIndex:s,elev:c.TRI3_POINT_ELEVATION([t,e],i,r,n)}}return{sectorIndex:-1,elev:1/0}}}class Bs{blocks;commandRegister;enabled;currentBlockId;currentCallIndex;onBeforeBlockExec;onAfterBlockExec;onBeforeCommandExec;onAfterCommandExec;constructor(){this.blocks=[],this.commandRegister=new Map,this.enabled=!0,this.currentBlockId="",this.currentCallIndex=0,this.onBeforeBlockExec=()=>{},this.onAfterBlockExec=()=>{},this.onBeforeCommandExec=()=>{},this.onAfterCommandExec=()=>{}}update(t){if(!this.enabled)return;const e=this.blocks.find(r=>r.id==this.currentBlockId);if(!e)return;if(this.currentCallIndex==e.calls.length){this.onAfterBlockExec(e),this.currentBlockId="",this.currentCallIndex=0;return}this.currentCallIndex==0&&this.onBeforeBlockExec(e);const s=e.calls[this.currentCallIndex],i=this.runCommand(s.commandName,s.commandArgs);if(typeof i=="string"){this.currentBlockId=i,this.currentCallIndex=0;return}this.currentCallIndex<e.calls.length&&this.currentCallIndex++}async loadFromFile(t){const s=await(await fetch(t)).json();this.blocks=[];for(const i of s){const r={id:i.Id,description:i.Description,calls:[]};for(const n of i.Calls)r.calls.push({commandName:n.Name,commandArgs:n.Args});this.blocks.push(r)}}runCommand(t,e=[]){const s=this.commandRegister.get(t);if(!s)throw new Error("ScriptMachine::runCommand: try to call an not existant command "+t+" !");this.onBeforeCommandExec(s);const i=s.call(this,...e);return this.onAfterCommandExec(s),i}registerCommand(t,e){if(this.commandRegister.has(t))throw new Error("ScriptMachine::registerCommand: key already exist !");this.commandRegister.set(t,e)}clearCommandRegister(){this.commandRegister.clear()}jump(t){this.currentBlockId=t,this.currentCallIndex=0}isEnabled(){return this.enabled}setEnabled(t){this.enabled=t}}class Ss extends W{text;stepDuration;currentTextOffset;timeElapsed;finished;constructor(){super({className:"UIDialog",template:`
      <div class="UIDialog-author js-author"></div>
      <div class="UIDialog-textbox">
        <div class="UIDialog-textbox-text js-text"></div>
        <div class="UIDialog-textbox-next js-next"></div>
      </div>`}),this.text="",this.stepDuration=0,this.currentTextOffset=0,this.timeElapsed=0,this.finished=!1,this.node.addEventListener("click",()=>this.$handleClick())}update(t){if(!this.finished){if(this.currentTextOffset==this.text.length){this.finished=!0,this.node.querySelector(".js-next").style.display="block",m.emit(this,"E_PRINT_FINISHED");return}this.timeElapsed>=this.stepDuration?(this.currentTextOffset<this.text.length&&(this.node.querySelector(".js-text").textContent=this.text.substring(0,this.currentTextOffset+1),this.currentTextOffset++),this.timeElapsed=0):this.timeElapsed+=t}}setAuthor(t){this.node.querySelector(".UIDialog-author").textContent=t}setText(t){this.text=t,this.currentTextOffset=0,this.finished=!1,this.node.querySelector(".js-next").style.display="none"}setStepDuration(t){this.stepDuration=t}onAction(t){t=="OK"&&this.finished&&m.emit(this,"E_OK")}$handleClick(){this.isFocused()&&this.finished&&m.emit(this,"E_OK")}}class $n extends Ft{constructor(){super(),this.name="",this.direction=[0,0],this.radius=.2}async loadFromData(t){this.name=t.Name,this.position[0]=t.PositionX,this.position[1]=t.PositionY,this.position[2]=t.PositionZ,this.direction[0]=t.DirectionX,this.direction[1]=t.DirectionZ}draw(){dt.drawSphere(this.getTransformMatrix(),this.radius,2)}getName(){return this.name}getDirection(){return this.direction}getRadius(){return this.radius}}class Te extends xt{numVertices;frames;animations;interpolationEnabled;looped;currentAnimation;currentFrameIndex;frameProgress;boundingBoxes;constructor(){super(),this.numVertices=0,this.frames=[],this.animations=[],this.interpolationEnabled=!0,this.looped=!0,this.currentAnimation=null,this.currentFrameIndex=0,this.frameProgress=0,this.boundingBoxes=[]}async loadFromFile(t){const s=await(await fetch(t)).json();if(!s.hasOwnProperty("Ident")||s.Ident!="JAM")throw new Error("Gfx3MeshJAM::loadFromFile(): File not valid !");this.frames=[],this.boundingBoxes=[];for(const i of s.Frames){const r=i.Vertices??s.Vertices,n=i.TextureCoords??s.TextureCoords,a=i.Colors??s.Colors,h=i.Normals??s.Normals;this.frames.push({vertices:xt.buildVertices(s.NumVertices,r,n,a,h)}),this.boundingBoxes.push(j.createFromVertices(r,3))}this.animations=[];for(const i of s.Animations)this.animations.push({name:i.Name,startFrame:parseInt(i.StartFrame),endFrame:parseInt(i.EndFrame),frameDuration:parseInt(i.FrameDuration)});this.beginVertices(s.NumVertices),this.setVertices(this.frames[0].vertices),this.endVertices(),this.boundingBox=this.boundingBoxes[0],this.numVertices=s.NumVertices,this.currentAnimation=null,this.interpolationEnabled=!0,this.looped=!0,this.currentFrameIndex=0,this.frameProgress=0}update(t){if(!this.currentAnimation)return;const e=this.frameProgress/this.currentAnimation.frameDuration;let s=0;this.currentFrameIndex==this.currentAnimation.endFrame?(m.emit(this,"E_FINISHED"),s=this.looped?this.currentAnimation.startFrame:this.currentAnimation.endFrame):s=this.currentFrameIndex+1,this.beginVertices(this.numVertices);const i=this.frames[this.currentFrameIndex],r=this.frames[s];for(let n=0;n<this.numVertices;n++){const a=i.vertices[n*F+0],h=i.vertices[n*F+1],l=i.vertices[n*F+2],u=i.vertices[n*F+3],d=i.vertices[n*F+4],p=i.vertices[n*F+5],E=i.vertices[n*F+6],T=i.vertices[n*F+7],A=i.vertices[n*F+8],x=i.vertices[n*F+9],y=i.vertices[n*F+10],C=i.vertices[n*F+11],S=i.vertices[n*F+12],w=i.vertices[n*F+13],P=i.vertices[n*F+14],O=i.vertices[n*F+15],_=i.vertices[n*F+16];if(this.interpolationEnabled){const H=r.vertices[n*F+0],L=r.vertices[n*F+1],Z=r.vertices[n*F+2],X=a+(H-a)*e,K=h+(L-h)*e,ot=l+(Z-l)*e,st=r.vertices[n*F+5],q=r.vertices[n*F+6],Tt=r.vertices[n*F+7],Dt=p+(st-p)*e,At=E+(q-E)*e,Rt=T+(Tt-T)*e,ie=r.vertices[n*F+8],Fe=r.vertices[n*F+9],re=r.vertices[n*F+10],bt=A+(ie-A)*e,ne=x+(Fe-x)*e,oe=y+(re-y)*e,ae=r.vertices[n*F+11],he=r.vertices[n*F+12],le=r.vertices[n*F+13],ce=C+(ae-C)*e,Be=S+(he-S)*e,ue=w+(le-w)*e,$s=r.vertices[n*F+14],Ve=r.vertices[n*F+15],Ks=r.vertices[n*F+16],Xr=C+($s-P)*e,zr=S+(Ve-O)*e,Zr=w+(Ks-_)*e;this.defineVertex(X,K,ot,u,d,Dt,At,Rt,bt,ne,oe,ce,Be,ue,Xr,zr,Zr)}else this.defineVertex(a,h,l,u,d,p,E,T,A,x,y,C,S,w,P,O,_)}this.endVertices(),e>=1?(this.currentFrameIndex=s,this.frameProgress=0):this.frameProgress+=t,super.update(t)}play(t,e=!1,s=!1,i=!0){if(s&&this.currentAnimation&&this.currentAnimation.name==t)return;const r=this.animations.find(n=>n.name==t);if(!r)throw new Error("Gfx3MeshJAM::play: animation not found !");this.currentAnimation=r,this.interpolationEnabled=i,this.looped=e,this.currentFrameIndex=r.startFrame,this.frameProgress=0}getInterpolationEnabled(){return this.interpolationEnabled}getLooped(){return this.looped}getCurrentAnimation(){return this.currentAnimation}getCurrentFrameIndex(){return this.currentFrameIndex}getFrameProgress(){return this.frameProgress}getBoundingBox(t=!1){return t&&this.currentAnimation?this.boundingBoxes[this.currentFrameIndex]:this.boundingBox}getWorldBoundingBox(t=!1){return t&&this.currentAnimation?this.boundingBoxes[this.currentFrameIndex].transform(this.getTransformMatrix()):this.boundingBox.transform(this.getTransformMatrix())}clone(t=new Te,e=c.MAT4_IDENTITY()){super.clone(t,e),t.numVertices=this.numVertices,t.frames=this.frames,t.animations=this.animations,t.interpolationEnabled=this.interpolationEnabled,t.looped=!1,t.currentAnimation=null,t.currentFrameIndex=0,t.frameProgress=0;for(const s of this.boundingBoxes)t.boundingBoxes.push(new j(s.min,s.max));return t}}class ii extends Ft{constructor(){super(),this.jam=new Te,this.radius=0,this.height=1,this.onActionBlockId=""}async loadFromData(t){await this.jam.loadFromFile(t.JAMFile),this.jam.setMaterial(new $({texture:await D.loadTexture(t.TextureFile)})),this.jam.play("IDLE",!0),this.position[0]=t.PositionX,this.position[1]=t.PositionY,this.position[2]=t.PositionZ,this.rotation[0]=t.RotationX,this.rotation[1]=t.RotationY,this.rotation[2]=t.RotationZ,this.radius=t.Radius,this.height=t.Height,this.onActionBlockId=t.OnActionBlockId}delete(){this.jam.delete()}update(t){this.jam.setPosition(this.position[0],this.position[1],this.position[2]),this.jam.setRotation(this.rotation[0],this.rotation[1],this.rotation[2]),this.jam.update(t)}draw(){this.jam.draw()}move(t,e){const s=this.position.slice();this.position[0]+=t,this.position[2]+=e,this.rotation[1]=c.VEC2_ANGLE([t,e]),m.emit(this,"E_MOVED",{old:s,moveX:t,moveZ:e})}play(t){this.jam.play(t,!0,!0)}getRadius(){return this.radius}getHeight(){return this.height}getHandPosition(){return[this.position[0]+Math.cos(this.rotation[1])*this.radius*1.5,this.position[1],this.position[2]+Math.sin(this.rotation[1])*this.radius*1.5]}getOnActionBlockId(){return this.onActionBlockId}isCollide(t,e){return c.COLLIDE_CYLINDER(this.position,this.radius,this.height,t.getPosition(),t.getRadius(),t.getHeight(),e)}isHandCollide(t){return c.COLLIDE_CYLINDER(this.getHandPosition(),0,this.height,t.getPosition(),t.getRadius(),t.getHeight())}}class Kn extends Ft{constructor(){super(),this.radius=0,this.height=1,this.hovered=!1,this.onEnterBlockId="",this.onLeaveBlockId="",this.onActionBlockId=""}async loadFromData(t){this.position[0]=t.PositionX,this.position[1]=t.PositionY,this.position[2]=t.PositionZ,this.radius=t.Radius,this.onEnterBlockId=t.OnEnterBlockId,this.onLeaveBlockId=t.OnLeaveBlockId,this.onActionBlockId=t.OnActionBlockId}draw(){dt.drawSphere(this.getTransformMatrix(),this.radius,2)}getRadius(){return this.radius}getHeight(){return this.height}isHovered(){return this.hovered}setHovered(t){this.hovered=t}getOnEnterBlockId(){return this.onEnterBlockId}getOnLeaveBlockId(){return this.onLeaveBlockId}getOnActionBlockId(){return this.onActionBlockId}}class ri{constructor(t){this.target=null,this.minClipOffset=[0,0],this.maxClipOffset=[0,0],this.view=v.getView(t),this.view.setProjectionMode(Fs.PERSPECTIVE)}async loadFromData(t){this.minClipOffset[0]=t.MinClipOffsetX,this.minClipOffset[1]=t.MinClipOffsetY,this.maxClipOffset[0]=t.MaxClipOffsetX,this.maxClipOffset[1]=t.MaxClipOffsetY,this.view.setCameraMatrix(t.Matrix),this.view.setPerspectiveFovy(c.DEG_TO_RAD(parseInt(t.Fovy)))}update(t){if(!this.target)return;let e=this.view.getClipOffset(),s=this.target.getPosition(),i=this.view.getScreenNormalizedPosition(s[0],s[1],s[2]);this.view.setClipOffset(c.CLAMP(i[0]+e[0],this.minClipOffset[0],this.maxClipOffset[0]),c.CLAMP(i[1]+e[1],this.minClipOffset[1],this.maxClipOffset[1]))}setTarget(t){this.target=t}}const ni=3;class Jn{constructor(){this.name="",this.description="",this.map=new G,this.walkmesh=new Xe,this.controller=new ii,this.controllerWalker={},this.camera=new ri(0),this.scriptMachine=new Bs,this.spawns=[],this.models=[],this.triggers=[],this.pause=!1,this.scriptMachine.registerCommand("LOAD_ROOM",this.$loadRoom.bind(this)),this.scriptMachine.registerCommand("CONTINUE",this.$continue.bind(this)),this.scriptMachine.registerCommand("STOP",this.$stop.bind(this)),this.scriptMachine.registerCommand("UI_CREATE_DIALOG",this.$uiCreateDialog.bind(this)),this.scriptMachine.registerCommand("MODEL_PLAY_ANIMATION",this.$modelPlayAnimation.bind(this)),m.subscribe(M,"E_ACTION_ONCE",this,this.handleActionOnce),m.subscribe(this.controller,"E_MOVED",this,this.handleControllerMoved)}async loadFromFile(t,e){let i=await(await fetch(t)).json();this.name=i.Name,this.description=i.Description,this.map=new G,await this.map.loadFromFile(i.MapFile),this.map.setMaterial(new $({texture:await D.loadTexture(i.MapTextureFile,{minFilter:"nearest",magFilter:"nearest"})})),this.walkmesh=new Xe,await this.walkmesh.loadFromFile(i.WalkmeshFile),await this.controller.loadFromData(i.Controller),this.camera=new ri(0),await this.camera.loadFromData(i.Camera),this.camera.setTarget(this.controller),this.spawns=[];for(let n of i.Spawns){let a=new $n;await a.loadFromData(n),this.spawns.push(a)}this.models=[];for(let n of i.Models){let a=new ii;await a.loadFromData(n),this.models.push(a)}this.triggers=[];for(let n of i.Triggers){let a=new Kn;await a.loadFromData(n),this.triggers.push(a)}let r=this.spawns.find(n=>n.getName()==e);this.controller.setPosition(r.getPositionX(),r.getPositionY(),r.getPositionZ()),this.controller.setRotation(0,c.VEC2_ANGLE(r.getDirection()),0),this.controllerWalker=this.walkmesh.addWalker("CONTROLLER",this.controller.getPositionX(),this.controller.getPositionZ(),this.controller.getRadius()),await this.scriptMachine.loadFromFile(i.ScriptFile),this.scriptMachine.jump("ON_INIT"),this.scriptMachine.setEnabled(!0)}delete(){for(const t of this.models)t.delete();m.unsubscribe(M,"E_ACTION_ONCE",this),m.unsubscribe(this.controller,"E_MOVED",this)}update(t){let e=!1,s=c.VEC3_ZERO;if(M.isActiveAction("LEFT")&&(s=c.VEC3_ADD(s,c.VEC3_LEFT),e=!0),M.isActiveAction("RIGHT")&&(s=c.VEC3_ADD(s,c.VEC3_RIGHT),e=!0),M.isActiveAction("UP")&&(s=c.VEC3_ADD(s,c.VEC3_FORWARD),e=!0),M.isActiveAction("DOWN")&&(s=c.VEC3_ADD(s,c.VEC3_BACKWARD),e=!0),e&&!this.pause){s=c.VEC3_NORMALIZE(s);const i=s[0]*ni*(t/1e3),r=s[2]*ni*(t/1e3);this.controller.move(i,r,!0),this.controller.play("RUN")}else this.controller.play("IDLE");this.map.update(t),this.walkmesh.update(t),this.controller.update(t),this.camera.update(t),this.scriptMachine.update(t);for(let i of this.models)i.update(t)}draw(){this.map.draw(),this.walkmesh.draw(),this.controller.draw();for(let t of this.spawns)t.draw();for(let t of this.models)t.draw();for(let t of this.triggers)t.draw()}handleActionOnce(t){if(!(t.actionId!="OK"||this.pause)){for(let e of this.triggers)if(this.controller.isCollide(e)&&e.getOnActionBlockId()){this.scriptMachine.jump(e.getOnActionBlockId());return}for(let e of this.models)if(this.controller.isHandCollide(e)&&e.getOnActionBlockId()){this.scriptMachine.jump(e.getOnActionBlockId());return}}}handleControllerMoved({old:t,moveX:e,moveZ:s}){for(let n of this.models){let a=[];if(this.controller.isCollide(n,a)){e+=a[0],s+=a[1];break}}let i=this.walkmesh.moveWalker(this.controllerWalker,e,s),r=c.VEC3_ADD(t,i.move);this.controller.setPosition(r[0],r[1],r[2]);for(let n of this.triggers){let a=this.controller.isCollide(n);n.getOnEnterBlockId()&&!n.isHovered()&&a?(this.scriptMachine.jump(n.getOnEnterBlockId()),n.setHovered(!0)):n.getOnLeaveBlockId()&&n.isHovered()&&!a&&(this.scriptMachine.jump(n.getOnLeaveBlockId()),n.setHovered(!1))}}async $loadRoom(t,e){this.pause=!0,await this.loadFromFile(t,e),this.pause=!1}$continue(){this.pause=!1}$stop(){this.pause=!0}async $uiCreateDialog(t,e){this.scriptMachine.setEnabled(!1);let s=new Ss;s.setAuthor(t),s.setText(e),g.addWidget(s),g.focus(s),await m.wait(s,"E_OK"),g.removeWidget(s),this.scriptMachine.setEnabled(!0)}$modelPlayAnimation(t,e,s){this.models[t].play(e,s)}}class Qn extends U{constructor(){super(),this.room=new Jn}async onEnter(){await this.room.loadFromFile("./samples/prerendered/scene.room","Spawn0000")}update(t){this.room.update(t)}draw(){this.room.draw()}}class to extends W{uiMenu;text;actions;stepDuration;currentTextOffset;currentActionTextOffset;currentActionIndex;timeElapsed;finished;constructor(){super({className:"UIBubble",template:`
      <img class="UIBubble-picture js-picture" src=""/>
      <div class="UIBubble-content">
        <div class="UIBubble-author js-author"></div>
        <div class="UIBubble-text js-text"></div>
        <div class="UIBubble-menu js-menu"></div>
      </div>`}),this.uiMenu=new it,this.text="",this.actions=[],this.stepDuration=0,this.currentTextOffset=0,this.currentActionTextOffset=0,this.currentActionIndex=0,this.timeElapsed=0,this.finished=!1,this.node.querySelector(".js-menu").replaceWith(this.uiMenu.getNode()),m.subscribe(this.uiMenu,"E_ITEM_SELECTED",this,this.$handleMenuItemSelected)}update(t){if(this.uiMenu.update(t),this.currentTextOffset==this.text.length&&this.currentActionIndex==this.actions.length){this.finished=!0,m.emit(this,"E_PRINT_FINISHED");return}this.timeElapsed>=this.stepDuration?(this.currentTextOffset<this.text.length?(this.node.querySelector(".js-text").textContent=this.text.substring(0,this.currentTextOffset+1),this.currentTextOffset++):this.currentActionIndex<this.actions.length&&(this.currentActionTextOffset==0&&this.uiMenu.add(this.currentActionIndex.toString(),""),this.currentActionTextOffset<this.actions[this.currentActionIndex].length?(this.uiMenu.set(this.currentActionIndex.toString(),this.actions[this.currentActionIndex].substring(0,this.currentActionTextOffset+1)),this.currentActionTextOffset++):(this.currentActionIndex++,this.currentActionTextOffset=0)),this.timeElapsed=0):this.timeElapsed+=t}delete(){m.unsubscribe(this.uiMenu,"E_ITEM_SELECTED",this),this.uiMenu.delete(),super.delete()}focus(){this.actions.length>0&&this.uiMenu.focus(),super.focus()}unfocus(){this.actions.length>0&&this.uiMenu.unfocus(),super.unfocus()}setPicture(t){this.node.querySelector(".js-picture").src=t}setAuthor(t){this.node.querySelector(".js-author").textContent=t}setWidth(t){this.node.style.width=t+"px"}setText(t){this.text=t,this.currentTextOffset=0,this.finished=!1}setActions(t){this.actions=t,this.currentActionIndex=0,this.currentActionTextOffset=0,this.finished=!1,this.uiMenu.clear()}setStepDuration(t){this.stepDuration=t}onAction(t){t=="OK"&&this.finished&&m.emit(this,"E_OK")}$handleMenuItemSelected(t){m.emit(this,"E_MENU_ITEM_SELECTED",t)}}const zt={LEFT:"LEFT",RIGHT:"RIGHT",FORWARD:"FORWARD",BACKWARD:"BACKWARD"},ze={LEFT:c.VEC3_LEFT,RIGHT:c.VEC3_RIGHT,FORWARD:c.VEC3_FORWARD,BACKWARD:c.VEC3_BACKWARD},oi=48,eo=8.4,so=100,io=[.7071,0,.7071,0,.3546,.8652,-.3546,0,-.6118,.5015,.6118,0,-7.3046,4.9583,5.6356,1];class ro extends Ft{constructor(){super(),this.name="",this.direction=zt.FORWARD,this.radius=.2}async loadFromData(t){this.name=t.Name,this.position[0]=t.PositionX,this.position[1]=t.PositionY,this.position[2]=t.PositionZ,this.direction=t.Direction}draw(){dt.drawSphere(this.getTransformMatrix(),this.radius,2)}getName(){return this.name}getDirection(){return this.direction}getRadius(){return this.radius}}class Vs extends xe{textureChanged;offset;flip;pixelsPerUnit;billboardMode;grp1;texture;constructor(){super(Xi),this.textureChanged=!1,this.offset=[0,0],this.flip=[!1,!1],this.pixelsPerUnit=100,this.billboardMode=!1,this.grp1=v.createStaticGroup("SPRITE_PIPELINE",1),this.texture=this.grp1.setTexture(0,"TEXTURE",v.createTextureFromBitmap()),this.texture=this.grp1.setSampler(1,"SAMPLER",this.texture),this.grp1.allocate()}delete(){this.grp1.delete(),super.delete()}draw(){zi.drawSprite(this)}getTransformMatrix(){const t=c.MAT4_IDENTITY();return c.MAT4_MULTIPLY(t,c.MAT4_TRANSLATE(this.position[0],this.position[1],this.position[2]),t),c.MAT4_MULTIPLY(t,c.MAT4_ROTATE_Y(this.rotation[1]),t),c.MAT4_MULTIPLY(t,c.MAT4_ROTATE_X(this.rotation[0]),t),c.MAT4_MULTIPLY(t,c.MAT4_ROTATE_Z(this.rotation[2]),t),c.MAT4_MULTIPLY(t,c.MAT4_SCALE(this.scale[0],this.scale[1],this.scale[2]),t),c.MAT4_MULTIPLY(t,c.MAT4_SCALE(1/this.pixelsPerUnit,1/this.pixelsPerUnit,1/this.pixelsPerUnit),t),c.MAT4_MULTIPLY(t,c.MAT4_TRANSLATE(-this.offset[0],-this.offset[1],0),t),t}getOffset(){return this.offset}getOffsetX(){return this.offset[0]}getOffsetY(){return this.offset[1]}setOffset(t,e){this.offset=[t,e]}getFlip(){return this.flip}setFlipX(t){this.flip[0]=t}setFlipY(t){this.flip[1]=t}getPixelsPerUnit(){return this.pixelsPerUnit}setPixelsPerUnit(t){this.pixelsPerUnit=t}getBillboardMode(){return this.billboardMode}setBillboardMode(t){this.billboardMode=t}setTexture(t){this.texture=t,this.textureChanged=!0}getTexture(){return this.texture}getGroup01(){return this.textureChanged&&(this.grp1.setTexture(0,"TEXTURE",this.texture),this.grp1.allocate(),this.textureChanged=!1),this.grp1}clone(t=new Vs,e=c.MAT4_IDENTITY()){return super.clone(t,e),t.textureChanged=!0,t.offset=[this.offset[0],this.offset[1]],t.flip=[this.flip[0],this.flip[1]],t.pixelsPerUnit=this.pixelsPerUnit,t.billboardMode=this.billboardMode,t.texture=this.texture,t}}class Re extends Vs{animations;currentAnimation;currentAnimationFrameIndex;looped;frameProgress;offsetXFactor;offsetYFactor;constructor(){super(),this.animations=[],this.currentAnimation=null,this.currentAnimationFrameIndex=0,this.looped=!1,this.frameProgress=0,this.offsetXFactor=0,this.offsetYFactor=0}async loadFromFile(t){const s=await(await fetch(t)).json();if(!s.hasOwnProperty("Ident")||s.Ident!="JAS")throw new Error("Gfx3SpriteJAS::loadFromFile(): File not valid !");this.animations=[];for(const i of s.Animations){const r={name:i.Name,frames:[],frameDuration:parseInt(i.FrameDuration),boundingBoxes:[]};for(const n of i.Frames)r.frames.push({x:n.X,y:n.Y,width:n.Width,height:n.Height}),r.boundingBoxes.push(j.createFromCoord(n.X,n.Y,0,n.Width,n.Height,0));this.animations.push(r)}this.boundingBox=this.animations[0].boundingBoxes[0],this.currentAnimation=null,this.currentAnimationFrameIndex=0,this.frameProgress=0}update(t){if(!this.currentAnimation||!this.texture)return;const e=this.currentAnimation.frames[this.currentAnimationFrameIndex],s=0,i=0,r=e.width,n=e.height,a=e.x/this.texture.gpuTexture.width,h=e.y/this.texture.gpuTexture.height,l=(e.x+e.width)/this.texture.gpuTexture.width,u=(e.y+e.height)/this.texture.gpuTexture.height,d=this.flip[0]?1-a:a,p=this.flip[1]?1-h:h,E=this.flip[0]?1-l:l,T=this.flip[1]?1-u:u;(this.offsetXFactor!=0||this.offsetYFactor!=0)&&(this.offset[0]=e.width*this.offsetXFactor,this.offset[1]=e.height*this.offsetYFactor),this.beginVertices(6),this.defineVertex(s,n,0,d,p),this.defineVertex(s,i,0,d,T),this.defineVertex(r,i,0,E,T),this.defineVertex(r,i,0,E,T),this.defineVertex(r,n,0,E,p),this.defineVertex(s,n,0,d,p),this.endVertices(),this.frameProgress>=this.currentAnimation.frameDuration?this.currentAnimationFrameIndex==this.currentAnimation.frames.length-1?(m.emit(this,"E_FINISHED"),this.currentAnimationFrameIndex=this.looped?0:this.currentAnimation.frames.length-1,this.frameProgress=0):(this.currentAnimationFrameIndex=this.currentAnimationFrameIndex+1,this.frameProgress=0):this.frameProgress+=t}play(t,e=!1,s=!1){if(s&&this.currentAnimation&&t==this.currentAnimation.name)return;const i=this.animations.find(r=>r.name==t);if(!i)throw new Error("Gfx3SpriteJAS::play: animation not found.");this.currentAnimation=i,this.currentAnimationFrameIndex=0,this.looped=e,this.frameProgress=0}getAnimations(){return this.animations}setAnimations(t){this.animations=t}getCurrentAnimation(){return this.currentAnimation}getCurrentAnimationFrameIndex(){return this.currentAnimationFrameIndex}setOffsetNormalized(t,e){this.offsetXFactor=t,this.offsetYFactor=e}getBoundingRect(t=!1){return t&&this.currentAnimation&&this.currentAnimation.boundingBoxes[this.currentAnimationFrameIndex],this.boundingBox}getWorldBoundingRect(t=!1){return t&&this.currentAnimation?this.currentAnimation.boundingBoxes[this.currentAnimationFrameIndex].transform(this.getTransformMatrix()):this.boundingBox.transform(this.getTransformMatrix())}clone(t=new Re,e=c.MAT4_IDENTITY()){return super.clone(t,e),t.animations=this.animations,t.currentAnimation=null,t.currentAnimationFrameIndex=0,t.looped=!1,t.frameProgress=0,t.offsetXFactor=this.offsetXFactor,t.offsetYFactor=this.offsetYFactor,t}}class ai extends Ft{constructor(){super(),this.jas=new Re,this.radius=0,this.height=1,this.direction=zt.FORWARD,this.onActionBlockId="",this.jas.setPixelsPerUnit(oi),this.jas.setBillboardMode(!0)}async loadFromData(t){await this.jas.loadFromFile(t.JASFile),this.jas.setTexture(await D.loadTexture(t.TextureFile)),this.jas.setOffset(t.OffsetX,t.OffsetY),this.position[0]=t.PositionX,this.position[1]=t.PositionY,this.position[2]=t.PositionZ,this.radius=t.Radius,this.height=t.Height,this.direction=t.Direction,this.onActionBlockId=t.OnActionBlockId}delete(){this.jas.delete()}update(t){let e=this.jas.getOffsetY()/oi;this.jas.setPosition(this.position[0],this.position[1]+e,this.position[2]),this.jas.update(t)}draw(){this.jas.draw()}move(t,e,s=null){const i=this.position.slice();this.position[0]+=t,this.position[2]+=e,this.direction=s,m.emit(this,"E_MOVED",{old:i,moveX:t,moveZ:e})}play(t,e=!1){this.jas.play(t,e,!0)}getDirection(){return this.direction}setDirection(t){this.direction=t}getRadius(){return this.radius}getHeight(){return this.height}getOnActionBlockId(){return this.onActionBlockId}getHandPosition(){return[this.position[0]+ze[this.direction][0]*this.radius*1.2,this.position[1],this.position[2]+ze[this.direction][2]*this.radius*1.2]}isCollideLayerZone(t){const e=[this.position[0]-this.radius,this.position[2]-this.radius],s=[this.position[0]+this.radius,this.position[2]+this.radius];return c.COLLIDE_RECT_TO_RECT(e,s,t.getMin(),t.getMax())}isCollideTrigger(t){return c.COLLIDE_CYLINDER(this.position,this.radius,this.height,t.getPosition(),t.getRadius(),t.getHeight())}isCollideModel(t){return c.COLLIDE_CYLINDER(this.position,this.radius,this.height,t.getPosition(),t.getRadius(),t.getHeight())}isHandCollide(t){return c.COLLIDE_CYLINDER(this.getHandPosition(),0,this.height,t.getPosition(),t.getRadius(),t.getHeight())}}class no extends Ft{constructor(){super(),this.radius=0,this.height=1,this.hovered=!1,this.onEnterBlockId="",this.onLeaveBlockId="",this.onActionBlockId=""}async loadFromData(t){this.position[0]=t.PositionX,this.position[1]=t.PositionY,this.position[2]=t.PositionZ,this.radius=t.Radius,this.onEnterBlockId=t.OnEnterBlockId,this.onLeaveBlockId=t.OnLeaveBlockId,this.onActionBlockId=t.OnActionBlockId}draw(){dt.drawSphere(this.getTransformMatrix(),this.radius,2)}getRadius(){return this.radius}getHeight(){return this.height}isHovered(){return this.hovered}setHovered(t){this.hovered=t}getOnEnterBlockId(){return this.onEnterBlockId}getOnLeaveBlockId(){return this.onLeaveBlockId}getOnActionBlockId(){return this.onActionBlockId}}class hi{constructor(t){this.target=null,this.minClipOffset=[0,0],this.maxClipOffset=[0,0],this.view=v.getView(t),this.view.setProjectionMode(Fs.ORTHOGRAPHIC),this.view.setOrthographicSize(eo),this.view.setOrthographicDepth(so),this.view.setCameraMatrix(io)}async loadFromData(t){this.minClipOffset[0]=t.MinClipOffsetX,this.minClipOffset[1]=t.MinClipOffsetY,this.maxClipOffset[0]=t.MaxClipOffsetX,this.maxClipOffset[1]=t.MaxClipOffsetY}update(t){if(!this.target)return;let e=this.view.getClipOffset(),s=this.target.getPosition(),i=this.view.getScreenNormalizedPosition(0,s[0],s[1],s[2]);this.view.setClipOffset(c.CLAMP(i[0]+e[0],this.minClipOffset[0],this.maxClipOffset[0]),c.CLAMP(i[1]+e[1],this.minClipOffset[1],this.maxClipOffset[1]))}setTarget(t){this.target=t}}const li=1;class oo{constructor(){this.name="",this.description="",this.map=new G,this.walkmesh=new Xe,this.controller=new ai,this.controllerWalker={},this.camera=new hi(0),this.scriptMachine=new Bs,this.spawns=[],this.models=[],this.triggers=[],this.pause=!1,this.scriptMachine.registerCommand("LOAD_ROOM",this.$loadRoom.bind(this)),this.scriptMachine.registerCommand("CONTINUE",this.$continue.bind(this)),this.scriptMachine.registerCommand("STOP",this.$stop.bind(this)),this.scriptMachine.registerCommand("UI_CREATE_DIALOG",this.$uiCreateDialog.bind(this)),this.scriptMachine.registerCommand("MODEL_PLAY_ANIMATION",this.$modelPlayAnimation.bind(this)),m.subscribe(M,"E_ACTION_ONCE",this,this.handleActionOnce),m.subscribe(this.controller,"E_MOVED",this,this.handleControllerMoved)}async loadFromFile(t,e){let i=await(await fetch(t)).json();this.map=new G,await this.map.loadFromFile(i.MapFile),this.map.setMaterial(new $({texture:await D.loadTexture(i.MapTextureFile,{magFilter:"nearest"})})),this.walkmesh=new Xe,await this.walkmesh.loadFromFile(i.WalkmeshFile),await this.controller.loadFromData(i.Controller),this.camera=new hi(0),await this.camera.loadFromData(i.Camera),this.camera.setTarget(this.controller),this.spawns=[];for(let n of i.Spawns){let a=new ro;await a.loadFromData(n),this.spawns.push(a)}this.models=[];for(let n of i.Models){let a=new ai;await a.loadFromData(n),this.models.push(a)}this.triggers=[];for(let n of i.Triggers){let a=new no;await a.loadFromData(n),this.triggers.push(a)}let r=this.spawns.find(n=>n.getName()==e);this.controller.setPosition(r.getPositionX(),r.getPositionY(),r.getPositionZ()),this.controller.setDirection(r.getDirection()),this.controller.play("IDLE_"+r.getDirection(),!0,!0),this.controllerWalker=this.walkmesh.addWalker("CONTROLLER",this.controller.getPositionX(),this.controller.getPositionZ(),this.controller.getRadius()),await this.scriptMachine.loadFromFile(i.ScriptFile),this.scriptMachine.jump("ON_INIT"),this.scriptMachine.setEnabled(!0)}delete(){for(const t of this.models)t.delete();this.map.delete(),m.unsubscribe(M,"E_ACTION_ONCE",this),m.unsubscribe(this.controller,"E_MOVED",this)}update(t){let e=zt.FORWARD,s=!1;if(M.isActiveAction("LEFT")?(s=!0,e=zt.LEFT):M.isActiveAction("RIGHT")?(s=!0,e=zt.RIGHT):M.isActiveAction("UP")?(s=!0,e=zt.FORWARD):M.isActiveAction("DOWN")&&(s=!0,e=zt.BACKWARD),s&&!this.pause){const i=ze[e][0]*li*(t/1e3),r=ze[e][2]*li*(t/1e3);this.controller.move(i,r,e),this.controller.play("RUN_"+e,!0)}else this.controller.play("IDLE_"+this.controller.getDirection(),!0);this.walkmesh.update(t),this.controller.update(t),this.camera.update(t),this.scriptMachine.update(t);for(let i of this.models)i.update(t)}draw(){for(let t of this.spawns)t.draw();for(let t of this.models)t.draw();for(let t of this.triggers)t.draw();this.map.draw(),this.walkmesh.draw(),this.controller.draw()}handleActionOnce(t){if(!(t.actionId!="OK"||this.pause)){for(let e of this.triggers)if(this.controller.isCollideTrigger(e)&&e.getOnActionBlockId()){this.scriptMachine.jump(e.getOnActionBlockId());return}for(let e of this.models)if(this.controller.isHandCollide(e)&&e.getOnActionBlockId()){this.scriptMachine.jump(e.getOnActionBlockId());return}}}handleControllerMoved({old:t,moveX:e,moveZ:s}){for(let n of this.models)if(this.controller.isCollideModel(n)){this.controller.setPosition(t[0],t[1],t[2]);return}let i=this.walkmesh.moveWalker(this.controllerWalker,e,s),r=c.VEC3_ADD(t,i.move);this.controller.setPosition(r[0],r[1],r[2]);for(let n of this.triggers){let a=this.controller.isCollideTrigger(n);n.getOnEnterBlockId()&&!n.isHovered()&&a?(this.scriptMachine.jump(n.getOnEnterBlockId()),n.setHovered(!0)):n.getOnLeaveBlockId()&&n.isHovered()&&!a&&(this.scriptMachine.jump(n.getOnLeaveBlockId()),n.setHovered(!1))}}async $loadRoom(t,e){this.controller.setControllable(!1),await this.loadFromFile(t,e),this.controller.setControllable(!0)}$continue(){this.pause=!1}$stop(){this.pause=!0}async $uiCreateDialog(t,e,s,i,r,n){this.scriptMachine.setEnabled(!1);let a=new to;a.setAuthor(t),a.setPicture(e),a.setText(s),a.setWidth(i),g.addWidget(a,`position:absolute; top:${n}; left:${r}`),g.focus(a),await m.wait(a,"E_OK"),g.removeWidget(a),this.scriptMachine.setEnabled(!0)}$modelPlayAnimation(t,e,s){this.models[t].play(e,s)}}class ao extends U{constructor(){super(),this.room=new oo}async onEnter(){await this.room.loadFromFile("./samples/iso/scene.room","Spawn0000")}update(t){this.room.update(t)}draw(){this.room.draw()}}class ho{textures;constructor(){this.textures=new Map}async loadTexture(t){if(this.textures.has(t))return this.textures.get(t);const s=await(await fetch(t)).blob(),i=await createImageBitmap(s);return this.textures.set(t,i),i}deleteTexture(t){if(!this.textures.has(t))throw new Error("Gfx2TextureManager::deleteTexture(): The texture file doesn't exist, cannot delete !");this.textures.delete(t)}getTexture(t){if(!this.textures.has(t))throw new Error("Gfx2TextureManager::getTexture(): The texture file doesn't exist, cannot get !");return this.textures.get(t)}hasTexture(t){return this.textures.has(t)}releaseTextures(){for(const t of this.textures.keys())this.textures.delete(t)}}const Q=new ho;class jt{rows;columns;tileHeight;tileWidth;tileLayers;tileset;constructor(){this.rows=0,this.columns=0,this.tileHeight=0,this.tileWidth=0,this.tileLayers=[],this.tileset=new ci}async loadFromFile(t){let s=await(await fetch(t)).json();this.rows=s.Rows,this.columns=s.Columns,this.tileHeight=s.TileHeight,this.tileWidth=s.TileWidth,this.tileLayers=[];for(let i of s.Layers){let r=new Us;await r.loadFromData(i),this.tileLayers.push(r)}this.tileset=new ci,s.Tileset&&await this.tileset.loadFromData(s.Tileset)}getHeight(){return this.rows*this.tileHeight}getWidth(){return this.columns*this.tileWidth}getRows(){return this.rows}getColumns(){return this.columns}getTileHeight(){return this.tileHeight}getTileWidth(){return this.tileWidth}getTileLayer(t){return this.tileLayers[t]}getTileLayers(){return this.tileLayers}findTileLayer(t){return this.tileLayers.find(e=>e.getName()==t)}getTileset(){return this.tileset}getPositionX(t){return t*this.tileWidth}getPositionY(t){return t*this.tileHeight}getLocationCol(t){return Math.floor(t/this.tileWidth)}getLocationRow(t){return Math.floor(t/this.tileHeight)}getPositionIso(t,e){const s=Math.ceil((e-t)*(this.tileWidth*.5)),i=Math.ceil((e+t)*(this.tileHeight*.5));return[s,i]}getLocationFromIso(t,e){const s=e/this.tileHeight,i=t/this.tileWidth,r=Math.ceil(s+i),n=Math.ceil(s-i);return[r,n]}}class Us{name;rows;offsetX;offsetY;columns;visible;frameDuration;grid;constructor(){this.name="",this.rows=0,this.columns=0,this.offsetX=0,this.offsetY=0,this.visible=!0,this.frameDuration=0,this.grid=[]}async loadFromData(t){this.name=t.Name,this.rows=t.Rows,this.columns=t.Columns,this.offsetX=t.OffsetX??0,this.offsetY=t.OffsetY??0,this.visible=t.Visible??!0,this.frameDuration=t.FrameDuration??0,this.grid=t.Grid}getTile(t,e){return this.grid[t+e*this.columns]}getName(){return this.name}getRows(){return this.rows}getOffsetX(){return this.offsetX}getOffsetY(){return this.offsetY}getColumns(){return this.columns}isVisible(){return this.visible}getFrameDuration(){return this.frameDuration}getGrid(){return this.grid}}class ci{columns;tileWidth;tileHeight;texture;animations;constructor(){this.columns=0,this.tileWidth=0,this.tileHeight=0,this.texture=N.getDefaultTexture(),this.animations=new Map}async loadFromData(t){this.columns=parseInt(t.Columns),this.tileWidth=parseInt(t.TileWidth),this.tileHeight=parseInt(t.TileHeight),this.texture=await Q.loadTexture(t.TextureFile),this.animations.clear();for(const e in t.Animations)this.animations.set(parseInt(e),t.Animations[e]??[])}getTilePositionX(t){return(t-1)%this.columns*this.tileWidth}getTilePositionY(t){return Math.floor((t-1)/this.columns)*this.tileHeight}getTileHeight(){return this.tileHeight}getTileWidth(){return this.tileWidth}getColumns(){return this.columns}getTexture(){return this.texture}getAnimation(t){return this.animations.get(t)}}class rt{min;max;constructor(t=[0,0],e=[0,0]){this.min=t,this.max=e}static createFrom(t,e,s,i){const r=new rt;return r.min[0]=t,r.min[1]=e,r.max[0]=s,r.max[1]=i,r}static createFromCoord(t,e,s,i){const r=new rt;return r.min[0]=t,r.min[1]=e,r.max[0]=t+s,r.max[1]=e+i,r}static createFromCenter(t,e,s,i){const r=new rt;return r.min[0]=t-s*.5,r.min[1]=e-i*.5,r.max[0]=t+s*.5,r.max[1]=e+i*.5,r}static createFromVertices(t){const e=new rt;return e.fromVertices(t),e}fromVertices(t){const e=[t[0],t[1]],s=[t[0],t[1]];for(let i=0;i<t.length;i+=2)for(let r=0;r<2;r++){const n=t[i+r];e[r]=Math.min(n,e[r]),s[r]=Math.max(n,s[r])}this.min=e,this.max=s}merge(t){const e=[this.min[0],this.min[1]],s=[this.max[0],this.max[2]];for(let i=0;i<2;i++)e[i]=Math.min(t.min[i],e[i]),s[i]=Math.max(t.max[i],s[i]);return new rt(e,s)}getCenter(){const t=this.max[0]-this.min[0],e=this.max[1]-this.min[1],s=this.min[0]+t*.5,i=this.min[1]+e*.5;return[s,i]}getSize(){const t=this.max[0]-this.min[0],e=this.max[1]-this.min[1];return[t,e]}getWidth(){return this.max[0]-this.min[0]}getHeight(){return this.max[1]-this.min[1]}getRadius(){return c.VEC2_DISTANCE(this.min,this.max)*.5}getPerimeter(){const t=this.max[0]-this.min[0],e=this.max[1]-this.min[1];return t+t+e+e}getVolume(){return(this.max[0]-this.min[0])*(this.max[1]-this.min[1])}transform(t){const e=[];e.push([this.min[0],this.min[1]]),e.push([this.max[0],this.min[1]]),e.push([this.max[0],this.max[1]]),e.push([this.min[0],this.max[1]]);const s=e.map(n=>c.MAT3_MULTIPLY_BY_VEC3(t,[n[0],n[1],1])),i=[s[0][0],s[0][1]],r=[s[0][0],s[0][1]];for(let n=0;n<s.length;n++)for(let a=0;a<2;a++){const h=s[n][a];i[a]=Math.min(h,i[a]),r[a]=Math.max(h,r[a])}return new rt(i,r)}splitVertical(){const t=this.getSize(),e=this.getCenter();return[rt.createFromCoord(this.min[0],this.min[1],t[0]*.5,t[1]),rt.createFromCoord(e[0],this.min[1],t[0]*.5,t[1])]}splitHorizontal(){const t=this.getSize(),e=this.getCenter();return[rt.createFromCoord(this.min[0],this.min[1],t[0],t[1]*.5),rt.createFromCoord(this.min[0],e[1],t[0],t[1]*.5)]}isPointInside(t,e){return c.COLLIDE_POINT_TO_RECT([t,e],this.min,this.max)}intersectBoundingRect(t){return c.COLLIDE_RECT_TO_RECT(this.min,this.max,t.min,t.max)}}class ft{position;rotation;scale;offset;visible;opacity;z;elevation;boundingRect;constructor(){this.position=[0,0],this.rotation=0,this.scale=[1,1],this.offset=[0,0],this.visible=!0,this.opacity=1,this.z=0,this.elevation=0,this.boundingRect=new rt}draw(){if(!this.visible)return;const t=N.getContext();t.save(),t.globalAlpha=this.opacity,t.translate(-this.offset[0],-this.offset[1]),t.translate(this.position[0],this.position[1]),t.rotate(this.rotation),t.scale(this.scale[0],this.scale[1]),this.paint(),t.globalAlpha=1,t.restore()}update(t){}paint(){}getPosition(){return this.position}getPositionX(){return this.position[0]}getPositionY(){return this.position[1]}setPosition(t,e){this.position[0]=t,this.position[1]=e}translate(t,e){this.position[0]+=t,this.position[1]+=e}getRotation(){return this.rotation}setRotation(t){this.rotation=t}rotate(t){this.rotation+=t}getScale(){return this.scale}getScaleX(){return this.scale[0]}getScaleY(){return this.scale[1]}setScale(t,e){this.scale[0]=t,this.scale[1]=e}zoom(t,e){this.scale[0]+=t,this.scale[1]+=e}getOffset(){return this.offset}getOffsetX(){return this.offset[0]}getOffsetY(){return this.offset[1]}setOffset(t,e){this.offset[0]=t,this.offset[1]=e}isVisible(){return this.visible}setVisible(t){this.visible=t}getOpacity(){return this.opacity}setOpacity(t){this.opacity=t}setPositionZ(t){this.z=t}getPositionZ(){return this.z}setElevation(t){this.elevation=t}getElevation(){return this.elevation}setBoundingRect(t){this.boundingRect=t}getBoundingRect(){return this.boundingRect}getWorldBoundingRect(){return this.boundingRect.transform(c.MAT3_TRANSFORM(this.position,this.offset,this.rotation,this.scale))}clone(t=new ft){return t.position=[this.position[0],this.position[1]],t.rotation=this.rotation,t.scale=[this.scale[0],this.scale[1]],t.offset=[this.offset[0],this.offset[1]],t.visible=this.visible,t.opacity=this.opacity,t.z=this.z,t.elevation=this.elevation,t.boundingRect=new rt(this.boundingRect.min,this.boundingRect.max),t}}class Ee extends ft{tilemap;layerIndex;frameIndex;frameProgress;constructor(){super(),this.tilemap=new jt,this.layerIndex=0,this.frameIndex=0,this.frameProgress=0}loadFromTileMap(t,e){this.tilemap=t,this.layerIndex=e,this.frameIndex=0,this.frameProgress=0;const s=t.getTileLayer(e);this.offset[0]=s.getOffsetX(),this.offset[1]=s.getOffsetY()}update(t){const e=this.tilemap.getTileLayer(this.layerIndex);!e||(this.frameProgress>e.getFrameDuration()&&(this.frameIndex=this.frameIndex+1,this.frameProgress=0),this.frameProgress+=t)}paint(){const t=this.tilemap.getTileLayer(this.layerIndex);if(!t||!t.isVisible())return;const e=N.getContext(),s=this.tilemap.getTileset();for(let i=0;i<t.getRows();i++)for(let r=0;r<t.getColumns();r++){let n=t.getTile(r,i);if(n<0)continue;const a=s.getAnimation(n);a&&(n=a[this.frameIndex%a.length]),e.drawImage(s.getTexture(),s.getTilePositionX(n),s.getTilePositionY(n),s.getTileWidth(),s.getTileHeight(),r*this.tilemap.getTileWidth(),i*this.tilemap.getTileHeight(),this.tilemap.getTileWidth(),this.tilemap.getTileHeight())}}}class mt extends ft{flip;animations;texture;currentAnimation;currentAnimationFrameIndex;looped;frameProgress;constructor(){super(),this.flip=[!1,!1],this.animations=[],this.texture=N.getDefaultTexture(),this.currentAnimation=null,this.currentAnimationFrameIndex=0,this.looped=!1,this.frameProgress=0}async loadFromFile(t){const s=await(await fetch(t)).json();this.offset[0]=s.OffsetX??0,this.offset[1]=s.OffsetY??0,this.flip[0]=s.FlipX??!1,this.flip[1]=s.FlipY??!1,this.animations=[];for(const i of s.Animations){const r={name:i.Name,frames:[],frameDuration:parseInt(i.FrameDuration),boundingRects:[]};for(const n of i.Frames)r.frames.push({x:n.X,y:n.Y,width:n.Width,height:n.Height}),r.boundingRects.push(rt.createFromCoord(n.X,n.Y,n.Width,n.Height));this.animations.push(r)}this.boundingRect=this.animations[0].boundingRects[0],this.currentAnimation=null,this.currentAnimationFrameIndex=0,this.frameProgress=0}update(t){!this.currentAnimation||(this.frameProgress>=this.currentAnimation.frameDuration?this.currentAnimationFrameIndex==this.currentAnimation.frames.length-1?(m.emit(this,"E_FINISHED"),this.currentAnimationFrameIndex=this.looped?0:this.currentAnimation.frames.length-1,this.frameProgress=0):(this.currentAnimationFrameIndex=this.currentAnimationFrameIndex+1,this.frameProgress=0):this.frameProgress+=t)}paint(){if(!this.currentAnimation)return;const t=N.getContext(),e=this.currentAnimation.frames[this.currentAnimationFrameIndex];t.scale(this.flip[0]?-1:1,this.flip[1]?-1:1),t.drawImage(this.texture,e.x,e.y,e.width,e.height,this.flip[0]?e.width*-1:0,this.flip[1]?e.height*-1:0,e.width,e.height)}play(t,e=!1,s=!1){if(s&&this.currentAnimation&&t==this.currentAnimation.name)return;const i=this.animations.find(r=>r.name==t);if(!i)throw new Error("Gfx2SpriteJAS::play: animation not found.");this.currentAnimation=i,this.currentAnimationFrameIndex=0,this.looped=e,this.frameProgress=0}getFlip(){return this.flip}setFlipX(t){this.flip[0]=t}setFlipY(t){this.flip[1]=t}getAnimations(){return this.animations}setAnimations(t){this.animations=t}getCurrentAnimation(){return this.currentAnimation}getCurrentAnimationFrameIndex(){return this.currentAnimationFrameIndex}getTexture(){return this.texture}setTexture(t){this.texture=t}getBoundingRect(t=!1){return t&&this.currentAnimation&&this.currentAnimation.boundingRects[this.currentAnimationFrameIndex],this.boundingRect}getWorldBoundingRect(t=!1){return t&&this.currentAnimation?this.currentAnimation.boundingRects[this.currentAnimationFrameIndex].transform(c.MAT3_TRANSFORM(this.position,this.offset,this.rotation,this.scale)):this.boundingRect.transform(c.MAT3_TRANSFORM(this.position,this.offset,this.rotation,this.scale))}clone(t=new mt){return super.clone(t),t.flip=[this.flip[0],this.flip[1]],t.animations=this.animations,t.texture=this.texture,t.currentAnimation=null,t.currentAnimationFrameIndex=0,t.looped=!1,t.frameProgress=0,t}}class lo extends ft{constructor(){super(),this.jas=new mt,this.direction="FORWARD",this.speed=.05,this.width=0,this.height=0,this.collider1=[0,0],this.collider2=[0,0]}async loadFromFile(t){let s=await(await fetch(t)).json();await this.jas.loadFromFile(s.JASFile),this.jas.setTexture(await Q.loadTexture(s.TextureFile)),this.jas.setOffset(s.OffsetX,s.OffsetY),this.width=s.Width,this.height=s.Height,this.collider1[0]=s.Collider1X,this.collider1[1]=s.Collider1Y,this.collider2[0]=s.Collider2X,this.collider2[1]=s.Collider2Y}update(t){this.jas.setPosition(this.position[0],this.position[1]),this.jas.update(t)}draw(){this.jas.draw()}play(t,e){this.jas.play(t,e,!0)}setDirection(t){this.direction=t}getDirection(){return this.direction}getSpeed(){return this.speed}getWidth(){return this.width}getHeight(){return this.height}getCollider1X(){return this.collider1[0]}getCollider1Y(){return this.collider1[1]}getCollider2X(){return this.collider2[0]}getCollider2Y(){return this.collider2[1]}}const fs={BACKGROUND:0,MIDDLE:1,FOREGROUND:2};class co extends U{constructor(){super(),this.tileMap=new jt,this.backgroundLayer=new Ee,this.middleLayer=new Ee,this.foregroundLayer=new Ee,this.collisionMap=new jt,this.collisionTileLayer=new Us,this.controller=new lo}async onEnter(){await this.tileMap.loadFromFile("./samples/tilemap/map.json"),this.backgroundLayer.loadFromTileMap(this.tileMap,fs.BACKGROUND),this.middleLayer.loadFromTileMap(this.tileMap,fs.MIDDLE),this.foregroundLayer.loadFromTileMap(this.tileMap,fs.FOREGROUND),await this.collisionMap.loadFromFile("./samples/tilemap/collision.json"),this.collisionTileLayer=this.collisionMap.getTileLayer(0),await this.controller.loadFromFile("./samples/tilemap/bernard.json"),this.controller.setPosition(this.collisionMap.getPositionX(12),this.collisionMap.getPositionY(16))}update(t){M.isActiveAction("LEFT")?this.moveController(-1*this.controller.getSpeed()*t,0,"LEFT"):M.isActiveAction("RIGHT")?this.moveController(1*this.controller.getSpeed()*t,0,"RIGHT"):M.isActiveAction("UP")?this.moveController(0,-1*this.controller.getSpeed()*t,"FORWARD"):M.isActiveAction("DOWN")?this.moveController(0,1*this.controller.getSpeed()*t,"BACKWARD"):this.controller.play("IDLE_"+this.controller.getDirection(),!0);let e=N.getWidth()*.5,s=this.tileMap.getWidth()-N.getWidth()*.5,i=N.getHeight()*.5,r=this.tileMap.getHeight()-N.getHeight()*.5;N.setCameraPosition(c.CLAMP(this.controller.getPositionX(),e,s),c.CLAMP(this.controller.getPositionY(),i,r)),this.backgroundLayer.update(t),this.middleLayer.update(t),this.controller.update(t),this.foregroundLayer.update(t)}draw(){this.backgroundLayer.draw(),this.middleLayer.draw(),this.controller.draw(),this.foregroundLayer.draw()}moveController(t,e,s){this.controller.translate(t,e),this.controller.setDirection(s),this.controller.play("RUN_"+s,!0);let i=this.controller.getPosition(),r=this.collisionMap.getLocationCol(i[0]+this.controller.getCollider1X()),n=this.collisionMap.getLocationCol(i[1]+this.controller.getCollider1Y()),a=this.collisionMap.getLocationCol(i[0]+this.controller.getCollider2X()),h=this.collisionMap.getLocationCol(i[1]+this.controller.getCollider2Y());(this.collisionTileLayer.getTile(r,n)==1||this.collisionTileLayer.getTile(a,h)==1)&&this.controller.translate(-t,-e)}}class uo{grid;size;constructor(t,e=new Array){this.grid=e,this.size=t}async loadFromFile(t){const s=await(await fetch(t)).json();if(!s.hasOwnProperty("Ident")||s.Ident!="ASTAR_GRID")throw new Error("AStarGrid<T>::loadFromFile(): File not valid !");this.grid=s.Grid,this.size=s.Size}}class sr extends uo{constructor(t=[0,0],e=new Array){super(t,e)}getValue(t){return this.grid[this.size[0]*t[1]+t[0]]}getDirections(t,e){const s=[[0,-1],[1,0],[0,1],[-1,0]],i=e[0]-t[0],r=e[1]-t[1];return s.sort((n,a)=>{const h=Math.sqrt(Math.pow(i+n[0],2)+Math.pow(r+n[1],2)),l=Math.sqrt(Math.pow(i+a[0],2)+Math.pow(r+a[1],2));return h-l})}isInside(t){return!(t[0]<0||t[0]>=this.size[0]||t[1]<0||t[1]>=this.size[1])}isSame(t,e){return t[0]==e[0]&&t[1]==e[1]}}class ir{solve(t,e,s){const i=new Map,r=[];let n=!1;for(r.push(e),i.set(e.join(";"),{pos:e,origin:null});!n;){const l=r.shift();if(!l)return null;const u=this.heuristic(t,l,s);for(const d of u){const p=d.map((T,A)=>l[A]+T),E=p.join(";");if(!(!t.isInside(p)||t.getValue(p)==1||i.get(E))&&(r.push(p),i.set(E,{pos:p,origin:l}),t.isSame(p,s))){n=!0;break}}}const a=[];let h=i.get(s.join(";"));for(;h;)a.unshift(h.pos),h=i.get(h.origin?h.origin.join(";"):"");return a}heuristic(t,e,s){return t.getDirections(e,s)}}class Ze{points;speed;looped;running;currentPosition;currentMove;currentPointIndex;currentSegmentTime;constructor(t=[],e=1,s=!1){this.points=t,this.speed=e,this.looped=s,this.running=!1,this.currentPosition=[0,0,0],this.currentMove=[0,0,0],this.currentPointIndex=1,this.currentSegmentTime=0}async loadFromFile(t){const s=await(await fetch(t)).json();this.loadFromData(s)}loadFromData(t){this.points=[];for(const e of t.Points)this.points.push(e);this.speed=t.Speed,this.looped=c.VEC3_ISEQUAL(t.Points.at(-1),t.Points.at(0)),this.running=!1}update(t){if(!this.running)return;const e=c.VEC3_SUBSTRACT(this.points[this.currentPointIndex],this.points[this.currentPointIndex-1]),s=c.VEC3_NORMALIZE(e),i=c.VEC3_LENGTH(e),r=c.VEC3_SCALE(s,this.speed*(t/1e3)),n=c.VEC3_SUBSTRACT(this.currentPosition,this.points[this.currentPointIndex-1]),a=c.VEC3_LENGTH(n);this.currentPosition[0]=this.currentPosition[0]+r[0],this.currentPosition[1]=this.currentPosition[1]+r[1],this.currentPosition[2]=this.currentPosition[2]+r[2],this.currentMove=r,this.currentSegmentTime=a/i,a>i&&(this.currentPointIndex==this.points.length-1?(this.currentPointIndex=this.looped?1:this.points.length-1,this.running=!!this.looped,m.emit(this,"E_FINISHED")):this.currentPointIndex=this.currentPointIndex+1)}run(){if(this.points.length<2)throw new Error("Motion::play(): points is not defined.");this.running=!0,this.currentPosition[0]=this.points[0][0],this.currentPosition[1]=this.points[0][1],this.currentPosition[2]=this.points[0][2],this.currentMove=[0,0,0],this.currentPointIndex=1,this.currentSegmentTime=0}stop(){this.running=!1}isRunning(){return this.running}getCurrentPosition(){return this.currentPosition}getCurrentPositionX(){return this.currentPosition[0]}getCurrentPositionY(){return this.currentPosition[1]}getCurrentPositionZ(){return this.currentPosition[2]}getCurrentMove(){return this.currentMove}getCurrentMoveX(){return this.currentMove[0]}getCurrentMoveY(){return this.currentMove[1]}getCurrentMoveZ(){return this.currentMove[2]}getPrevPointIndex(){return this.currentPointIndex-1}getNextPointIndex(){return this.currentPointIndex}getPrevPoint(){return this.points[this.currentPointIndex-1]}getNextPoint(){return this.points[this.currentPointIndex]}getCurrentSegmentTime(){return this.currentSegmentTime}}class po extends ft{constructor(){super(),this.jas=new mt,this.direction="FORWARD",this.speed=50,this.width=0,this.height=0,this.motion=new Ze}async loadFromFile(t){let s=await(await fetch(t)).json();await this.jas.loadFromFile(s.JASFile),this.jas.setTexture(await Q.loadTexture(s.TextureFile)),this.jas.setOffset(s.OffsetX,s.OffsetY),this.width=s.Width,this.height=s.Height}update(t){const e=this.motion.getPrevPoint(),s=this.motion.getNextPoint();this.motion.isRunning()&&(this.position[0]=this.motion.getCurrentPositionX(),this.position[1]=this.motion.getCurrentPositionZ()),e[0]>s[0]?this.direction="LEFT":e[0]<s[0]?this.direction="RIGHT":e[2]>s[2]?this.direction="FORWARD":e[2]<s[2]&&(this.direction="BACKWARD"),this.jas.setPosition(this.position[0],this.position[1]),this.jas.play(this.motion.isRunning()?"RUN_"+this.direction:"IDLE_"+this.direction,!0,!0),this.jas.update(t),this.motion.update(t)}draw(){this.jas.draw()}moveAlong(t){this.motion=new Ze(t,this.speed),this.motion.run()}}const gs={BACKGROUND:0,MIDDLE:1,FOREGROUND:2};class mo extends U{constructor(){super(),this.tileMap=new jt,this.collisionMap=new jt,this.backgroundLayer=new Ee,this.middleLayer=new Ee,this.foregroundLayer=new Ee,this.controller=new po,this.selectionRect=new fo,this.pathfinder=new ir}async onEnter(){await this.tileMap.loadFromFile("./samples/tilemap/map.json"),this.backgroundLayer.loadFromTileMap(this.tileMap,gs.BACKGROUND),this.middleLayer.loadFromTileMap(this.tileMap,gs.MIDDLE),this.foregroundLayer.loadFromTileMap(this.tileMap,gs.FOREGROUND),await this.collisionMap.loadFromFile("./samples/tilemap/collision.json"),await this.controller.loadFromFile("./samples/tilemap/bernard.json"),this.controller.setPosition(this.tileMap.getPositionX(6),this.tileMap.getPositionY(16)),this.movePlayer(10,16),document.addEventListener("mousemove",t=>this.handleMouseMove(t)),document.addEventListener("click",()=>this.handleMouseClick())}update(t){const e=N.getWidth()*.5,s=this.tileMap.getWidth()-N.getWidth()*.5,i=N.getHeight()*.5,r=this.tileMap.getHeight()-N.getHeight()*.5;N.setCameraPosition(c.CLAMP(this.controller.getPositionX(),e,s),c.CLAMP(this.controller.getPositionY(),i,r)),this.backgroundLayer.update(t),this.middleLayer.update(t),this.controller.update(t),this.foregroundLayer.update(t),this.selectionRect.update(t)}draw(){this.backgroundLayer.draw(),this.middleLayer.draw(),this.controller.draw(),this.foregroundLayer.draw(),this.selectionRect.draw()}movePlayer(t,e){const s=this.collisionMap.getLocationCol(this.controller.getPositionX()),i=this.collisionMap.getLocationRow(this.controller.getPositionY()),r=this.collisionMap.getTileLayer(0),n=new sr([r.getColumns(),r.getRows()],r.getGrid()),a=this.pathfinder.solve(n,[s,i],[t,e]);a&&this.controller.moveAlong(a.map(([h,l])=>[this.collisionMap.getPositionX(h+.5),0,this.collisionMap.getPositionY(l+.5)]))}handleMouseMove(t){const e=N.findWorldPosFromClientPos(t.clientX,t.clientY),s=this.collisionMap.getPositionX(this.collisionMap.getLocationCol(e[0])),i=this.collisionMap.getPositionY(this.collisionMap.getLocationRow(e[1]));this.selectionRect.setPosition(s,i)}handleMouseClick(){const t=this.collisionMap.getLocationCol(this.selectionRect.getPositionX()),e=this.collisionMap.getLocationRow(this.selectionRect.getPositionY());this.collisionMap.getTileLayer(0).getTile(t,e)!=1&&this.movePlayer(t,e)}}class fo extends ft{constructor(){super()}draw(){const t=N.getContext();t.fillStyle="rgba(225,225,225,0.5)",t.fillRect(this.position[0],this.position[1],16,16)}}class go{constructor(){this.variants={}}async loadFromData(t){for(const e in t.Variants)this.addVariant(e,t.Variants[e])}async loadFromFile(t){const e=await fetch(t);await this.loadFromData(await e.json())}addVariant(t,e){if(this.variants.hasOwnProperty(t))throw new Error("Player::addVariant: varloc already exist in variants dictionnary");this.variants[t]=e}removeVariant(t){if(!this.variants.hasOwnProperty(t))throw new Error("Player::removeVariant: varloc not exist in variants dictionnary");delete this.variants[t]}setVariant(t,e){if(!this.variants.hasOwnProperty(t))throw new Error("Player::setVariant: varloc not exist in variants dictionnary");this.variants[t]=e}hasVariant(t){return this.variants.hasOwnProperty(t)}getVariant(t){if(!this.variants.hasOwnProperty(t))throw new Error("Player::getVariant: varloc not exist in variants dictionnary");return this.variants[t]}}class rr extends W{animations;currentAnimation;currentAnimationFrameIndex;isLooped;timeElapsed;constructor(t={}){super({className:t.className??"UISprite"}),this.animations=[],this.currentAnimation=null,this.currentAnimationFrameIndex=0,this.isLooped=!1,this.timeElapsed=0}async loadTexture(t){return new Promise(e=>{const s=new Image;s.src=t,s.onload=()=>{this.node.style.backgroundImage='url("'+s.src+'")',e()}})}async loadFromFile(t){const s=await(await fetch(t)).json();this.animations=[];for(const i of s.Animations){const r={name:i.Name,frames:[],frameDuration:parseInt(i.FrameDuration)};for(const n of i.Frames)r.frames.push({x:n.X,y:n.Y,width:n.Width,height:n.Height});this.animations.push(r)}this.currentAnimation=null,this.currentAnimationFrameIndex=0,this.timeElapsed=0}update(t){if(!this.currentAnimation)return;const e=this.currentAnimation.frames[this.currentAnimationFrameIndex];this.node.style.backgroundPositionX=-e.x+"px",this.node.style.backgroundPositionY=-e.y+"px",this.node.style.width=e.width+"px",this.node.style.height=e.height+"px",this.timeElapsed>=this.currentAnimation.frameDuration?this.currentAnimationFrameIndex==this.currentAnimation.frames.length-1?(m.emit(this,"E_FINISHED"),this.currentAnimationFrameIndex=this.isLooped?0:this.currentAnimation.frames.length-1,this.timeElapsed=0):(this.currentAnimationFrameIndex=this.currentAnimationFrameIndex+1,this.timeElapsed=0):this.timeElapsed+=t}play(t,e=!1,s=!1){if(s&&this.currentAnimation&&t==this.currentAnimation.name)return;const i=this.animations.find(r=>r.name==t);if(!i)throw new Error("UISprite::play: animation not found.");this.currentAnimation=i,this.currentAnimationFrameIndex=0,this.isLooped=e,this.timeElapsed=0}getAnimations(){return this.animations}setAnimations(t){this.animations=t}getCurrentAnimation(){return this.currentAnimation}getCurrentAnimationFrameIndex(){return this.currentAnimationFrameIndex}}const Ue={LEFT:"LEFT",RIGHT:"RIGHT",CENTER:"CENTER",MIDDLE:"MIDDLE"};class Es extends rr{constructor(){super({className:"UIAvatar"})}changeLocation(t){t==Ue.MIDDLE?this.node.classList.add("u-middle"):t==Ue.LEFT?this.node.classList.add("u-left"):t==Ue.CENTER?this.node.classList.add("u-center"):t==Ue.RIGHT&&this.node.classList.add("u-right")}}class Cs extends rr{constructor(){super({className:"UIBackground"})}}class Eo extends U{constructor(){super(),this.player=new go,this.scriptMachine=new Bs}async onEnter(){this.scriptMachine.registerCommand("LOAD_SCRIPT",this.$loadScript.bind(this)),this.scriptMachine.registerCommand("WAITPAD",this.$waitPad.bind(this)),this.scriptMachine.registerCommand("GOTO",this.$goto.bind(this)),this.scriptMachine.registerCommand("GOTO_IF",this.$gotoIf.bind(this)),this.scriptMachine.registerCommand("EXEC_IF",this.$execIf.bind(this)),this.scriptMachine.registerCommand("VAR_SET",this.$varSet.bind(this)),this.scriptMachine.registerCommand("VAR_ADD",this.$varAdd.bind(this)),this.scriptMachine.registerCommand("VAR_SUB",this.$varSub.bind(this)),this.scriptMachine.registerCommand("DELAY",this.$delay.bind(this)),this.scriptMachine.registerCommand("UI_CREATE_DIALOG",this.$uiCreateDialog.bind(this)),this.scriptMachine.registerCommand("UI_CREATE_CHOICES",this.$uiCreateChoices.bind(this)),this.scriptMachine.registerCommand("UI_CREATE_AVATAR",this.$uiCreateAvatar.bind(this)),this.scriptMachine.registerCommand("UI_CREATE_BACKGROUND",this.$uiCreateBackground.bind(this)),this.scriptMachine.registerCommand("UI_PLAY_AVATAR",this.$uiPlayAvatar.bind(this)),this.scriptMachine.registerCommand("UI_PLAY_BACKGROUND",this.$uiPlayBackground.bind(this)),this.scriptMachine.registerCommand("UI_DESTROY_AVATAR",this.$uiDestroyAvatar.bind(this)),this.scriptMachine.registerCommand("UI_DESTROY_BACKGROUND",this.$uiDestroyBackground.bind(this)),this.scriptMachine.registerCommand("UI_FADE_IN",this.$uiFadeIn.bind(this)),this.scriptMachine.registerCommand("UI_FADE_OUT",this.$uiFadeOut.bind(this)),await this.player.loadFromFile("./samples/visual-novel/player.json"),await this.$loadScript("./samples/visual-novel/scene00.jsc")}update(t){this.scriptMachine.update(t)}async $loadScript(t){await this.scriptMachine.loadFromFile(t),this.scriptMachine.jump("ON_INIT"),this.scriptMachine.setEnabled(!0)}$waitPad(){this.scriptMachine.setEnabled(!1),document.addEventListener("keydown",t=>t.key=="Enter"?this.scriptMachine.setEnabled(!0):"",{once:!0})}$goto(t){return t}$gotoIf(t,e,s,i){if(ui(this.player.getVariant(t),e,s))return i}$execIf(t,e,s,i={CommandName,CommandArgs}){ui(this.player.getVariant(t),e,s)&&this.scriptMachine.runCommand(i.CommandName,i.CommandArgs)}$varSet(t,e){this.player.setVariant(t,e)}$varAdd(t,e){let s=this.player.getVariant(t);player.setVariant(t,s+e)}$varSub(t,e){let s=this.player.getVariant(t);player.setVariant(t,s-e)}$delay(t){this.scriptMachine.setEnabled(!1),window.setTimeout(()=>this.scriptMachine.setEnabled(!0),t)}async $uiCreateDialog(t,e){this.scriptMachine.setEnabled(!1);let s=new Ss;s.setAuthor(t),s.setText(e),g.addWidget(s),g.focus(s),await m.wait(s,"E_OK"),g.removeWidget(s),this.scriptMachine.setEnabled(!0)}async $uiCreateChoices(t,e,s=[]){this.scriptMachine.setEnabled(!1);let i=new Ss;i.setAuthor(t),i.setText(e),g.addWidget(i),await m.wait(i,"E_PRINT_FINISHED");let r=new it;g.addWidget(r,"position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); z-index:12");for(let a of s)r.add(0,a.Text);g.focus(r);let n=await m.wait(r,"E_ITEM_SELECTED");g.removeWidget(i),g.removeWidget(r),this.scriptMachine.jump(s[n.index].Jumpto),this.scriptMachine.setEnabled(!0)}async $uiCreateAvatar(t,e,s,i,r,n){this.scriptMachine.setEnabled(!1);let a=new Es;a.changeLocation(r),await a.loadTexture(t),await a.loadFromFile(e),a.animate(n),a.play(s,i),g.addWidget(a),await m.wait(a,"E_ANIMATION_FINISHED"),this.scriptMachine.setEnabled(!0)}async $uiCreateBackground(t,e,s,i,r){this.scriptMachine.setEnabled(!1);let n=new Cs;await n.loadTexture(t),await n.loadFromFile(e),n.animate(r),n.play(s,i),g.addWidget(n),await m.wait(n,"E_ANIMATION_FINISHED"),this.scriptMachine.setEnabled(!0)}async $uiDestroyAvatar(t,e){this.scriptMachine.setEnabled(!1);let i=g.getWidgets().filter(r=>r instanceof Es).at(t);i.animate(e),await m.wait(i,"E_ANIMATION_FINISHED"),g.removeWidget(i),this.scriptMachine.setEnabled(!0)}async $uiDestroyBackground(t,e){this.scriptMachine.setEnabled(!1);let i=g.getWidgets().filter(r=>r instanceof Cs).at(t);i.animate(e),await m.wait(i,"E_ANIMATION_FINISHED"),g.removeWidget(i),this.scriptMachine.setEnabled(!0)}$uiPlayAvatar(t,e,s){g.getWidgets().filter(n=>n instanceof Es)[t].play(e,s)}$uiPlayBackground(t,e,s){g.getWidgets().filter(n=>n instanceof Cs)[t].play(e,s)}async $uiFadeIn(t,e,s){this.scriptMachine.setEnabled(!1),g.fadeIn(t,e,s,()=>this.scriptMachine.setEnabled(!0))}async $uiFadeOut(t,e,s){this.scriptMachine.setEnabled(!1),g.fadeOut(t,e,s,()=>this.scriptMachine.setEnabled(!0))}}function ui(o,t,e){return t=="not equal"&&o!=e||t=="equal"&&o==e||t=="is less than"&&o<e||t=="is greater than"&&o>e}let et={BLACK:"BLACK",WHITE:"WHITE"},Wt={PAWN:"PAWN",QUEEN:"QUEEN"},Hs={DARK:"DARK",LIGHT:"LIGHT",WATER:"WATER",FIRE:"FIRE"},Ae={DOUBLE_MOVE:"DOUBLE_MOVE",KILL:"KILL"};class ut{constructor(t={}){this.path=t.path??[[1,0]],this.numCapture=t.numCapture??0,this.mustCapture=t.mustCapture??!0,this.chainable=t.chainable??!0,this.collateCapturable=t.collateCapturable??!1}getPath(){return this.path}hasVector(t){return this.path.find(e=>t[0]==e[0]&&t[1]==e[1])}getVector(t){return this.path[t]}getPathLength(){return this.path.length}getNumCapture(){return this.numCapture}isForceCapture(){return this.mustCapture}isChainable(){return this.chainable}isCollateCapturable(){return this.collateCapturable}}let Co=[[1,1]],To=[[-1,1]],Ao=[[1,-1]],Io=[[-1,-1]],yo=[[1,1],[2,2]],vo=[[-1,1],[-2,2]],xo=[[1,-1],[2,-2]],So=[[-1,-1],[-2,-2]],di=[[1,1],[2,2],[3,3],[4,4],[5,5],[6,6],[7,7],[8,8],[9,9]],pi=[[-1,1],[-2,2],[-3,3],[-4,4],[-5,5],[-6,6],[-7,7],[-8,8],[-9,9]],mi=[[1,-1],[2,-2],[3,-3],[4,-4],[5,-5],[6,-6],[7,-7],[8,-8],[9,-9]],fi=[[-1,-1],[-2,-2],[-3,-3],[-4,-4],[-5,-5],[-6,-6],[-7,-7],[-8,-8],[-9,-9]];class os{constructor(t={}){this.color=t.color??et.BLACK,this.type=t.type??Wt.PAWN,this.element=t.element??Hs.WATER,this.powerupId=t.powerupId??"",this.moves=t.moves??[]}clone(){return new os({color:this.color,type:this.type,element:this.element,powerupId:this.powerupId,moves:this.moves})}getColor(){return this.color}setColor(t){this.color=t}getType(){return this.type}setType(t){this.type=t}getElement(){return this.element}setElement(t){this.element=t}getPowerupId(){return this.powerupId}setPowerupId(t){this.powerupId=t}getMoves(){return this.moves}}class gi extends os{constructor(t){super({color:t,type:Wt.PAWN,element:Hs.DARK,powerupId:Ae.KILL,moves:[new ut({path:t==et.BLACK?Co:Ao,numCapture:0,mustCapture:!1,chainable:!1}),new ut({path:t==et.BLACK?To:Io,numCapture:0,mustCapture:!1,chainable:!1}),new ut({path:yo,numCapture:1,mustCapture:!0,chainable:!0}),new ut({path:vo,numCapture:1,mustCapture:!0,chainable:!0}),new ut({path:xo,numCapture:1,mustCapture:!0,chainable:!0}),new ut({path:So,numCapture:1,mustCapture:!0,chainable:!0})]})}}class wo extends os{constructor(t){super({color:t,type:Wt.QUEEN,element:Hs.DARK,powerupId:Ae.DOUBLE_MOVE,moves:[new ut({path:di,numCapture:0,mustCapture:!1,chainable:!1}),new ut({path:pi,numCapture:0,mustCapture:!1,chainable:!1}),new ut({path:mi,numCapture:0,mustCapture:!1,chainable:!1}),new ut({path:fi,numCapture:0,mustCapture:!1,chainable:!1}),new ut({path:di,numCapture:1,mustCapture:!0,chainable:!0}),new ut({path:pi,numCapture:1,mustCapture:!0,chainable:!0}),new ut({path:mi,numCapture:1,mustCapture:!0,chainable:!0}),new ut({path:fi,numCapture:1,mustCapture:!0,chainable:!0})]})}}class De{constructor(t=null,e=null){this.piece=t,this.element=e}clone(){let t=this.piece?this.piece.clone():null;return new De(t,this.element)}getPiece(){return this.piece}setPiece(t){this.piece=t}getElement(){return this.element}setElement(t){this.element=t}}class nr{constructor(){this.coord=[],this.parent=null,this.children=[]}}class Ws{constructor(){this.rows=10,this.cols=10,this.tiles=[],this.mustCapture=!0;for(let t=0;t<this.rows;t++){this.tiles[t]=[];for(let e=0;e<this.cols;e++)t<4&&(e+t)%2?this.tiles[t][e]=new De(new gi(et.BLACK)):t>5&&(e+t)%2?this.tiles[t][e]=new De(new gi(et.WHITE)):this.tiles[t][e]=new De}}clone(){let t=new Ws;t.rows=this.rows,t.cols=this.cols;for(let e=0;e<this.rows;e++){t.tiles[e]=[];for(let s=0;s<this.cols;s++)t.tiles[e][s]=this.tiles[e][s].clone()}return t.mustCapture=this.mustCapture,t}getRows(){return this.rows}getCols(){return this.cols}getTile(t){return this.tiles[t[1]][t[0]]}getPiece(t){return this.tiles[t[1]][t[0]].getPiece()}isValidCoord(t){return t[0]<this.cols&&t[0]>=0&&t[1]<this.rows&&t[1]>=0}getNumPieces(t=null,e=null){let s=0;for(let i=0;i<this.rows;i++)for(let r=0;r<this.cols;r++){let n=this.tiles[i][r].getPiece();!n||(t==null||t==n.getColor())&&(e==null||e==n.getType())&&s++}return s}getWinner(){let t=this.getNumPieces(et.BLACK),e=this.getNumPieces(et.WHITE);return t!=0&&e!=0?null:t==0?et.WHITE:et.BLACK}getPaths(t){let e=[],s=[],i=new nr;i.coord=[t[0],t[1]],or(this,i,t,e);for(let r of e){let n=[],a=r;for(;a;)n.unshift(a.coord),a=a.parent;s.push(n)}return s}findPossiblePoints(t,e=!1){let s=[],i=this.tiles[t[1]][t[0]].getPiece();if(!i)return[];for(let n of i.getMoves()){if(e&&!n.isChainable())continue;let a=0,h=null;for(let l of n.getPath()){let u=t[0]+l[0],d=t[1]+l[1];if(!this.isValidCoord([u,d]))break;let p=this.tiles[d][u].getPiece(),E=this.tiles[d][u].getElement(),T=E&&E!=i.getElement(),A=p&&p.getColor()!=i.getColor()&&h&&h.getColor()!=i.getColor()&&!n.isCollateCapturable(),x=p&&p.getColor()==i.getColor();if(T||A||x)break;p&&p.getColor()!=i.getColor()&&a++,!p&&n.getNumCapture()==a&&s.push({x:u,y:d,mustCapture:n.isForceCapture()}),h=p}}let r=!!s.find(n=>n.mustCapture);return s.filter(n=>r==n.mustCapture)}findMovables(t){let e=[],s=[];for(let i=0;i<this.rows;i++)for(let r=0;r<this.cols;r++){let n=this.tiles[i][r].getPiece();if(!n||n.getColor()!=t)continue;let a=this.findPossiblePoints([r,i]);a.length!=0&&(a.find(h=>h.mustCapture)?e.push([r,i]):s.push([r,i]))}return this.mustCapture&&e.length>0?e:[...s,...e]}move(t,e){let s=0,i=this.getTile(t),r=this.getTile(e),n=i.getPiece(),a=n.getMoves();i.setPiece(null),r.setPiece(n);let h=a.find(l=>l.hasVector(c.VEC2_SUBSTRACT(e,t)));for(let l of h.getPath()){let u=c.VEC2_ADD(t,l);if(c.VEC2_ISEQUAL(u,e))break;let d=this.getTile(u),p=d.getPiece();p&&p.getColor()!=n.getColor()&&(s++,d.setPiece(null))}return s}}function or(o,t,e,s,i=!1){let r=o.findPossiblePoints(e,i);if(r.length==0)return s.push(t);for(let n of r){let a=o.clone(),h=a.move(e,[n.x,n.y]),l=new nr;l.coord=[n.x,n.y],l.parent=t,t.children.push(l),h==0?s.push(l):or(a,l,[n.x,n.y],s,!0)}return t}class ar{constructor(t,e=""){this.game=t,this.id=e}getId(){return this.id}async onActive(){}}class Mo extends ar{constructor(t){super(t,Ae.DOUBLE_MOVE),this.board=this.game.getBoard()}async onActive(){let t=await this.game.operationRequestTileLocation(!0,(i,r)=>{let n=this.board.getPiece([i,r]);return n&&n.getColor()==this.game.getCurrentPlayer()}),e=this.board.findPossiblePoints([t.x,t.y]),s=await this.game.operationRequestTileLocation(!1,(i,r)=>e.find(n=>n.x==i&&n.y==r));await this.game.operationMove([t.x,t.y],[s.x,s.y]),this.game.operationRequestTileAction()}}class bo extends ar{constructor(t){super(t,Ae.KILL),this.board=this.game.getBoard()}async onActive(){let t=await this.game.operationRequestTileLocation(!0,(e,s)=>{let i=this.board.getPiece([e,s]);return i&&i.getColor()!=this.game.getCurrentPlayer()});await this.game.operationKill([t.x,t.y]),this.game.operationNewTurn()}}class Po{static create(t,e){if(e==Ae.DOUBLE_MOVE)return new Mo(t);if(e==Ae.KILL)return new bo(t)}}class hr{visited;data;value;constructor(){this.visited=!1,this.data={},this.value=-1/0}setVisited(t){this.visited=t}isVisited(){return this.visited}setData(t){this.data=t}getData(){return this.data}setValue(t){this.value=t}getValue(){return this.value}}class ws extends hr{constructor(t){super(),this.value=t}}class Ei extends hr{children;constructor(t=[]){super(),this.children=t}addChild(t){this.children.push(t)}getChildren(){return this.children}}class _o{solve(t){this.$generateValues(t,!0);let s=t.getChildren()[0];for(let i of t.getChildren())i.getValue()>s.getValue()&&(s=i);return s}$generateValues(t,e,s=-1/0,i=1/0){if(t instanceof ws)return t;t.setValue(e?-1/0:1/0);for(let r of t.children){const a=this.$generateValues(r,!e,s,i).getValue();if(e){if(a>t.getValue()&&t.setValue(a),a>=i)break;a>s&&(s=a)}else{if(a<t.getValue()&&t.setValue(a),a<=s)break;a<i&&(i=a)}}return t}}class lr{constructor(){this.color=et.WHITE}setColor(t){this.color=t}getColor(){return this.color}}class cr extends lr{constructor(){super()}async play(t){return t.operationRequestTileAction()}}class ur extends lr{constructor(){super(),this.solver=new _o,this.maxDepth=3}play(t){let e=t.getBoard(),s=new Ei;this.generateMinMaxTree(s,e,this.maxDepth,this.color);let r=this.solver.solve(s).data.path;for(let n=0;n<r.length-1;n++)e.move(r[n],r[n+1]);t.operationNewTurn()}evaluate(t){let e=t.getWinner();if(!e){let s=t.getNumPieces(this.color,Wt.PAWN),i=t.getNumPieces(this.color,Wt.QUEEN),r=this.color==et.BLACK?et.WHITE:et.BLACK,n=t.getNumPieces(r,Wt.PAWN),a=t.getNumPieces(r,Wt.QUEEN);return s+i*3-(n+a*3)}return e==this.color?1e3-t.getNumPieces():-1e3+t.getNumPieces()}generateMinMaxTree(t,e,s,i){if(s==0){let r=new ws(this.evaluate(e));return t.addChild(r)}if(e.getWinner()){let r=new ws(this.evaluate(e));return t.addChild(r)}for(let r of e.findMovables(i))for(let n of e.getPaths(r)){let a=e.clone();for(let u=0;u<n.length-1;u++)a.move(n[u],n[u+1]);let h=new Ei;h.setData({path:n}),t.addChild(h);let l=i==et.WHITE?et.BLACK:et.WHITE;this.generateMinMaxTree(h,a,s-1,l)}return t}}class Do{constructor(t,e){this.board=new Ws,this.players=[t,e],this.currentPlayer=t,t.setColor(et.WHITE),e.setColor(et.BLACK)}getBoard(){return this.board}getCurrentPlayer(){return this.currentPlayer}startup(){this.operationNewTurn(this.currentPlayer)}async operationNewTurn(t){if(this.board.getWinner()){m.emit(this,"E_END");return}let e=this.currentPlayer.getColor()==et.BLACK?this.board.getRows()-1:0;for(let s=0;s<this.board.getCols();s++){let i=this.board.getTile([s,e]),r=i.getPiece();r&&r.getColor()==this.currentPlayer.getColor()&&r.getType()==Wt.PAWN&&i.setPiece(new wo(r.getColor()))}t?this.currentPlayer=t:this.currentPlayer=this.currentPlayer==this.players[0]?this.players[1]:this.players[0],this.currentPlayer instanceof cr?await this.currentPlayer.play(this):this.currentPlayer instanceof ur&&this.currentPlayer.play(this)}async operationRequestTileAction(){let t={};return t.x=0,t.y=0,t.action="",await m.emit(this,"E_REQUEST_TILE_ACTION",{response:t}),t}async operationRequestTileLocation(t=!1,e=()=>!0){let s={};return s.x=0,s.y=0,s.canceled=!1,await m.emit(this,"E_REQUEST_TILE_LOCATION",{required:t,predicateTile:e,response:s}),s}operationKill(t){this.board.getTile(t).setPiece(null)}async operationPowerup(t){let e=this.board.getPiece(t);await Po.create(this,e.getPowerupId()).onActive(),e.setPowerupId("")}async operationMove(t,e){if(this.board.move(t,e)==0)return;let i=this.board.findPossiblePoints(e,!0);if(i.length>0){let r=await this.operationRequestTileLocation(!0,(n,a)=>i.find(h=>h.x==n&&h.y==a));await this.operationMove(e,[r.x,r.y]);return}}}class dr{constructor(t,e){this.game=t,this.coordFrom=e}async exec(){return!0}isConditionCheck(){return!0}}class Ro extends dr{constructor(t,e){super(t,e),this.board=this.game.getBoard()}async exec(){let t=this.board.findPossiblePoints(this.coordFrom),e=await this.game.operationRequestTileLocation(!1,(s,i)=>t.find(r=>r.x==s&&r.y==i));if(e.canceled)return await this.game.operationRequestTileAction(),!1;await this.game.operationMove(this.coordFrom,[e.x,e.y]),this.game.operationNewTurn()}isConditionCheck(){let t=this.game.getCurrentPlayer();return this.board.findMovables(t.getColor()).find(s=>s[0]==this.coordFrom[0]&&s[1]==this.coordFrom[1])}}class Oo extends dr{constructor(t,e){super(t,e),this.board=this.game.getBoard()}async exec(){await this.game.operationPowerup(this.coordFrom)}isConditionCheck(){let t=this.board.getPiece(this.coordFrom),e=this.game.getCurrentPlayer();return!(!t||t.getColor()!=e.getColor()||!t.getPowerupId())}}class Ts{static create(t,e,s){if(t=="MOVE")return new Ro(e,s);if(t=="POWERUP")return new Oo(e,s)}}let Lo={BLACK_PAWN:"./samples/checker/black_pawn.png",BLACK_QUEEN:"./samples/checker/black_queen.png",WHITE_PAWN:"./samples/checker/white_pawn.png",WHITE_QUEEN:"./samples/checker/white_queen.png"};class No extends W{constructor(){super({className:"UIPiece",template:`
      <div class="UIPiece-bg js-bg"></div>`}),this.piece=null}update(){this.piece?this.node.querySelector(".js-bg").style.backgroundImage=`url(${Lo[this.piece.getColor()+"_"+this.piece.getType()]})`:this.node.querySelector(".js-bg").style.backgroundImage=""}setPiece(t){this.piece=t||null}}let Fo={DARK:"./assets/textures/tile_dark.png",LIGHT:"./assets/textures/tile_light.png",FIRE:"./assets/textures/tile_fire.png",WATER:"./assets/textures/tile_water.png"};class Bo extends W{constructor(t={}){super({className:"UITile",template:`
      <div class="UITile-bg js-bg"></div>
      <div class="UITile-piece js-piece"></div>
      <div class="UITile-actions js-actions"></div>`}),this.tile=null,this.selectable=!1,this.uiPiece=new No,this.node.classList.add(t.color=="white"?"UITile--white":"UITile--black"),this.node.querySelector(".js-piece").replaceWith(this.uiPiece.node),this.node.addEventListener("click",e=>{e.stopPropagation(),this.handleClicked()})}update(t){this.tile?(this.node.querySelector(".js-bg").style.backgroundImage=`url(${Fo[this.tile.getElement()]??""})`,this.uiPiece.setPiece(this.tile.getPiece())):this.node.querySelector(".js-bg").style.backgroundImage="",this.uiPiece.update(t)}delete(){this.uiPiece.delete(),super.delete()}setTile(t){this.tile=t||null}isSelectable(){return this.selectable}setSelectable(t){this.node.classList.toggle("u-selectable",t),this.selectable=t}addAction(t){let e=document.createElement("div");e.className="UITile-actions-item",e.textContent=t,e.id=t,this.node.querySelector(".js-actions").appendChild(e),e.addEventListener("click",s=>{s.stopPropagation(),this.handleActionClicked(t)})}clearActions(){let t=this.node.querySelector(".js-actions");for(;t.firstChild;)t.removeChild(t.firstChild)}handleClicked(){m.emit(this,"E_CLICKED")}handleActionClicked(t){m.emit(this,"E_ACTION",{action:t})}}class Vo extends W{constructor(){super({className:"UICheckerBoard"}),this.board=null,this.uiTiles=[]}update(t){for(let e of this.uiTiles)e.update(t)}delete(){for(let t of this.uiTiles)m.unsubscribe(t,"E_CLICKED",this),m.unsubscribe(t,"E_ACTION",this),t.delete();super.delete()}setBoard(t){for(let e of this.uiTiles)m.unsubscribe(e,"E_CLICKED",this),m.unsubscribe(e,"E_ACTION",this),e.delete();if(this.uiTiles=[],t){for(let e=0;e<t.getRows();e++)for(let s=0;s<t.getCols();s++){let i=new Bo({color:(s+e)%2==0?"white":"black"});m.subscribe(i,"E_CLICKED",this,r=>this.handleTileClicked(s,e)),m.subscribe(i,"E_ACTION",this,r=>this.handleTileAction(s,e,r.action)),i.setTile(t.getTile([s,e])),this.node.appendChild(i.node),this.uiTiles.push(i)}this.board=t}else this.board=null}getUITiles(){return this.uiTiles}getUITile(t){return this.uiTiles[t[0]+t[1]*this.board.getCols()]}clearActions(){for(let t of this.uiTiles)t.setSelectable(!1),t.clearActions()}clearSelectable(){for(let t of this.uiTiles)t.setSelectable(!1)}handleTileClicked(t,e){m.emit(this,"E_TILE_CLICKED",{coord:[t,e]})}handleTileAction(t,e,s){m.emit(this,"E_TILE_ACTION",{coord:[t,e],action:s})}onKeyDownOnce(t){t.key==GWE.InputKeyEnum.CANCEL&&m.emit(this,"E_ECHAP_PRESSED")}}class Uo extends U{constructor(){super(),this.human=null,this.ia=null,this.game=null,this.board=null,this.uiTitle=null,this.uiBoard=null}update(){let t=this.game.getCurrentPlayer();this.uiTitle.textContent=`AU TOUR DES ${t.getColor()==et.BLACK?"NOIRS":"BLANCS"} DE JOUER`}async onEnter(){this.human=new cr,this.ai=new ur,this.game=new Do(this.human,this.ai),this.board=this.game.getBoard(),this.uiTitle=document.createElement("div"),g.addNode(this.uiTitle,"position:absolute; top:10%; left:50%; transform:translateX(-50%)"),this.uiBoard=new Vo,this.uiBoard.setBoard(this.board),g.addWidget(this.uiBoard,"position:absolute; inset:0px; top:50%; left:50%; width:400px; height:400px; transform:translate(-50%, -50%)"),g.focus(this.uiBoard),m.subscribe(this.game,"E_REQUEST_TILE_ACTION",this,this.handleGameRequestTileAction),m.subscribe(this.game,"E_REQUEST_TILE_LOCATION",this,this.handleGameRequestTileLocation),this.game.startup()}handleGameRequestTileAction(t){return new Promise(e=>{m.subscribe(this.uiBoard,"E_TILE_CLICKED",this,s=>{this.uiBoard.clearActions();let i=this.uiBoard.getUITile(s.coord);Ts.create("MOVE",this.game,s.coord).isConditionCheck()&&i.addAction("MOVE"),Ts.create("POWERUP",this.game,s.coord).isConditionCheck()&&i.addAction("POWERUP")}),m.subscribe(this.uiBoard,"E_TILE_ACTION",this,async s=>{m.unsubscribe(this.uiBoard,"E_TILE_CLICKED",this),m.unsubscribe(this.uiBoard,"E_TILE_ACTION",this),this.uiBoard.getUITile(s.coord).clearActions(),Ts.create(s.action,this.game,s.coord).exec().then(()=>e())})})}handleGameRequestTileLocation({required:t,predicateTile:e,response:s}){return new Promise(i=>{for(let r=0;r<this.board.getRows();r++)for(let n=0;n<this.board.getCols();n++)e(n,r)&&this.uiBoard.getUITile([n,r]).setSelectable(!0);t||m.subscribe(this.uiBoard,"E_ECHAP_PRESSED",this,()=>{m.unsubscribe(this.uiBoard,"E_ECHAP_PRESSED",this),m.unsubscribe(this.uiBoard,"E_TILE_CLICKED",this),this.uiBoard.clearSelectable(),s.canceled=!0,i()}),m.subscribe(this.uiBoard,"E_TILE_CLICKED",this,r=>{this.uiBoard.getUITile(r.coord).isSelectable()&&(m.unsubscribe(this.uiBoard,"E_ECHAP_PRESSED",this),m.unsubscribe(this.uiBoard,"E_TILE_CLICKED",this),this.uiBoard.clearSelectable(),s.canceled=!1,s.x=r.coord[0],s.y=r.coord[1],i())})})}}const Ci=6;let vt={DRAW:"DRAW",MAIN:"MAIN",BATTLE:"BATTLE",END:"END"},I={ONFIELD:"ONFIELD",FZONE:"FZONE",MZONE:"MZONE",SZONE:"SZONE",GRAVEYARD:"GRAVEYARD",BANNISHED:"BANNISHED",DECK:"DECK",HAND:"HAND"},V={MONSTER:"MONSTER",SPELL:"SPELL"},at={ATTACK:"ATTACK",DEFENSE:"DEFENSE",FACEUP:"FACEUP",FACEDOWN:"FACEDOWN"},Yt={DARK:"DARK",LIGHT:"LIGHT",EARTH:"EARTH",WIND:"WIND",FIRE:"FIRE",WATER:"WATER",DIVINE:"DIVINE"},J={AQUA:"AQUA",BEAST:"BEAST",BEAST_WARRIOR:"BEAST_WARRIOR",DINOSAUR:"DINOSAUR",FAIRY:"FAIRY",FIEND:"FIEND",FISH:"FISH",INSECT:"INSECT",MACHINE:"MACHINE",PLANT:"PLANT",PSYCHIC:"PSYCHIC",PYRO:"PYRO",REPTILE:"REPTILE",SEASERPENT:"SEASERPENT",SPELLCASTER:"SPELLCASTER",THUNDER:"THUNDER",WARRIOR:"WARRIOR",WINGEDBEAST:"WINGEDBEAST",ZOMBIE:"ZOMBIE",WYRM:"WYRM",DRAGON:"DRAGON",DIVINEBEAST:"DIVINEBEAST",CREATORGOD:"CREATORGOD",CYBERSE:"CYBERSE"},$e={ACTIVATE:"ACTIVATE",TRIGGER:"TRIGGER"},Oe={NORMAL:"NORMAL",CONTINUOUS:"CONTINUOUS"},we={SINGLE:"SINGLE",FIELD:"FIELD",NONE:"NONE"};class pr{constructor(t){this.map=t,this.modifiers=[]}get(t){if(!this.map.hasOwnProperty(t))return;let e=this.map[t];for(let s of this.modifiers)s.getAttributeKey()==t&&s.getType()=="MUL"&&(e*=s.getValue());for(let s of this.modifiers)s.getAttributeKey()==t&&s.getType()=="ADD"&&(e+=s.getValue());for(let s of this.modifiers)s.getAttributeKey()==t&&s.getType()=="SUB"&&(e-=s.getValue());for(let s of this.modifiers)s.getAttributeKey()==t&&s.getType()=="SET"&&(e=s.getValue());for(let s of this.modifiers)s.getAttributeKey()==t&&s.getType()=="FIN"&&(e=s.getValue());return e<0&&(e=0),this.map.hasOwnProperty(t+"_MIN")&&(e=Math.max(e,this.map[t+"_MIN"])),this.map.hasOwnProperty(t+"_MAX")&&(e=Math.min(e,this.map[t+"_MAX"])),e}getBase(t){if(!!this.map.hasOwnProperty(t))return this.map[t]}set(t,e){!this.map.hasOwnProperty(t)||(e<0&&(e=0),this.map.hasOwnProperty(t+"_MIN")&&(e=Math.max(e,this.map[t+"_MIN"])),this.map.hasOwnProperty(t+"_MAX")&&(e=Math.min(e,this.map[t+"_MAX"])),this.map[t]=e)}add(t,e){this.set(t,this.getBase(t)+e)}has(t){return this.map.hasOwnProperty(t)}addModifier(t){if(!t.isStackable()&&this.modifiers.find(e=>e.getId()==t.getId()))return!1;this.modifiers.push(t)}removeModifier(t){this.modifiers.splice(this.modifiers.indexOf(t),1)}removeModifierIf(t){for(let e of this.modifiers)t(e)&&this.modifiers.splice(this.modifiers.indexOf(e),1)}clearModifiers(){for(;this.modifiers.length;)this.modifiers.pop()}}class mr{constructor(){this.id="",this.type="",this.name="",this.text="",this.coverFile="",this.attributes,this.owner=0,this.controler=0,this.position="",this.location=I.DECK,this.turnCounter=0}async loadFromData(t){this.id=t.Id,this.type=t.Type,this.name=t.Name,this.text=t.Text,this.coverFile=t.CoverFile,this.attributes=new pr(t.Attributes)}getId(){return this.id}getType(){return this.type}getName(){return this.name}getText(){return this.text}getCoverFile(){return this.coverFile}getAttributes(){return this.attributes}getAttribute(t){return this.attributes.get(t)}getOwner(){return this.owner}setOwner(t){this.owner=t}getControler(){return this.controler}setControler(t){this.controler=t}getPosition(){return this.position}setPosition(t){this.position=t}getLocation(){return this.location}setLocation(t){this.location=t}getTurnCounter(){return this.turnCounter}incTurnCounter(){this.turnCounter++}setAttribute(t,e){this.attributes.set(t,e)}incAttribute(t){this.attributes.set(t,this.attributes.get(t)+1)}isSummonable(t){return!1}isSetable(t){return!1}isCapableAttack(t){return!1}isCapableChangePosition(t){return!1}isActiveatable(t){return!1}isTriggerable(t,e){return!1}}class Ho extends mr{constructor(){super()}async loadFromFile(t){let e=await fetch(t);await this.loadFromData(await e.json())}isSummonable(){return this.location==I.HAND}isCapableAttack(){return!(this.location!=I.MZONE||this.position!=at.ATTACK||this.attributes.get("ATK_COUNT")>=this.attributes.get("ATK_COUNT_LIMIT"))}isCapableChangePosition(){return this.attributes.get("STATE_FREEZE")!=1}}let as={};as.IS_ENDLESS=function(o,t={}){return!1};as.HAS_CARD_ID=function(o,t={targetRange,cardId}){let e=o.utilsQuery(o.getCurrentDuelistIndex(),t.targetRange,s=>s);for(let s of e)if(s.getId()==t.cardId)return!0;return!1};as.HAS_CARD_TYPE=function(o,t={targetRange,cardType}){let e=o.utilsQuery(o.getCurrentDuelistIndex(),t.targetRange,s=>s);for(let s of e)if(s.getType()==t.cardType)return!0;return!1};function Ms(o,t,e={}){return o==""?!0:as[o](t,e)}let fr={};fr.IS_EFFECT_CARD_MODIFIER_SET_STATE_FREEZE=function(o,t,e,s={}){return e instanceof ActivateEffectInternalAction&&e.effect.mechanicId=="ADD_CARD_MODIFIER"&&e.effect.mechanicOpts.modifierData.Type=="SET"&&e.effect.mechanicOpts.modifierData.AttributeKey=="STATE_FREEZE"&&e.effect.mechanicOpts.modifierData.Value==1};function Wo(o,t,e,s,i={}){return o==""?!0:fr[o](t,e,s,i)}class gr{constructor(){this.id="",this.type="",this.attributeKey="",this.value=0,this.stackable=!1,this.linked=!1,this.linkedEffect=null}async loadFromData(t){this.id=t.Type+"_"+t.AttributeKey,this.type=t.Type,this.attributeKey=t.AttributeKey,this.value=t.Value,this.stackable=t.Stackable,this.linked=t.Linked}getId(){return this.id}getType(){return this.type}getAttributeKey(){return this.attributeKey}getValue(){return this.value}isStackable(){return this.stackable}isLinked(){return this.linked}getLinkedEffect(){return this.linkedEffect}setLinkedEffect(t){this.linkedEffect=t}}let Mt={};Mt.NEW_TURN=async function(o,t,e,s,i={}){await o.operationNewTurn()};Mt.DRAW=async function(o,t,e,s,i={numCards}){await o.operationDraw(t.getControler(),i.numCards)};Mt.CHANGE_PHASE=async function(o,t,e,s,i={phaseId}){await o.operationChangePhase(i.phaseId)};Mt.DAMAGE_SELF=async function(o,t,e,s,i={amount}){await o.operationDamage(t.getControler(),i.amount)};Mt.DAMAGE_OPPONENT=async function(o,t,e,s,i={amount}){await o.operationDamage(Er(t.getControler()),i.amount)};Mt.RESTORE_SELF=async function(o,t,e,s,i={amount}){await o.operationRestore(t.getControler(),i.amount)};Mt.RESTORE_OPPONENT=async function(o,t,e,s,i={amount}){await o.operationRestore(Er(t.getControler()),i.amount)};Mt.DESTROY=async function(o,t,e,s,i={}){await o.operationDestroy(s)};Mt.ADD_MODIFIER_TO_SELF=async function(o,t,e,s,i={modifierData}){let r=new gr;await r.loadFromData(i.modifierData),r.setLinkedEffect(r.isLinked()?e:null),await o.operationAddDuelistModifier(t.getControler(),r)};Mt.ADD_CARD_MODIFIER=async function(o,t,e,s,i={modifierData}){let r=new gr;await r.loadFromData(i.modifierData),r.setLinkedEffect(r.isLinked()?e:null),await o.operationAddCardModifier(s,r)};const Er=o=>o==0?1:0;let hs={};hs.IS_RACE=function(o,t={race}){return o.getAttribute("RACE")==t.race};hs.IS_TYPE=function(o,t={type}){return o.getType()==t.type};hs.IS_ID=function(o,t={id}){return o.getId()==t.id};function Gt(o,t,e={}){return o==""?!0:hs[o](t,e)}class jo{constructor(t){this.card=t,this.targetType="",this.targetRange="",this.targetCardConditionId="",this.targetCardConditionOpts={},this.mechanicId="",this.mechanicOpts={},this.targetCards=[]}async loadFromData(t){this.targetType=t.TargetType,this.targetRange=t.TargetRange,this.targetCardConditionId=t.TargetCardConditionId,this.targetCardConditionOpts=t.TargetCardConditionOpts,this.mechanicId=t.MechanicId,this.mechanicOpts=t.MechanicOpts}getTargetType(){return this.targetType}getTargetRange(){return this.targetRange}getTargetCards(){return this.targetCards}isPresentTarget(t){return t.utilsQuery(this.card.getControler(),this.targetRange,s=>s&&Gt(this.targetCardConditionId,s,this.targetCardConditionOpts)).length!=0}isTarget(t,e){let s=t.utilsQuery(this.card.getControler(),this.targetRange,i=>i&&Gt(this.targetCardConditionId,i,this.targetCardConditionOpts));return s.length==0?!1:s.includes(e)}hasTargetCard(t){return this.targetCards.indexOf(t)!=-1}addTargetCard(t){this.targetCards.push(t)}removeTargetCard(t){this.targetCards.splice(this.targetCards.indexOf(t),1)}apply(t,e,s){let i=Mt[this.mechanicId];i(t,e,this,s,this.mechanicOpts)}}class Go extends mr{constructor(){super(),this.mode="",this.nature="",this.activateConditionId="",this.activateConditionOpts={},this.triggerConditionId="",this.triggerConditionOpts={},this.releaseConditionId="",this.releaseConditionOpts={},this.effects=[]}async loadFromData(t){this.mode=t.Mode,this.nature=t.Nature,t.hasOwnProperty("ActivateConditionId")&&(this.activateConditionId=t.ActivateConditionId,this.activateConditionOpts=t.ActivateConditionOpts),t.hasOwnProperty("TriggerConditionId")&&(this.triggerConditionId=t.TriggerConditionId,this.triggerConditionOpts=t.TriggerConditionOpts),t.hasOwnProperty("ReleaseConditionId")&&(this.releaseConditionId=t.ReleaseConditionId,this.releaseConditionOpts=t.ReleaseConditionOpts);for(let e of t.Effects){let s=new jo(this);await s.loadFromData(e),this.effects.push(s)}super.loadFromData(t)}async loadFromFile(t){let e=await fetch(t);await this.loadFromData(await e.json())}getMode(){return this.mode}getNature(){return this.nature}getEffects(){return this.effects}isSetable(){return this.location==I.HAND}isActiveatable(t){if(this.mode!=$e.ACTIVATE||this.location!=I.SZONE||this.position!=at.FACEDOWN)return!1;for(let e of this.effects)if(!e.isPresentTarget(t))return!1;return Ms(this.activateConditionId,t,this.activateConditionOpts)}isTriggerable(t,e){if(this.mode!=$e.TRIGGER||this.location!=I.SZONE||this.position!=at.FACEDOWN)return!1;for(let s of this.effects)if(!s.isPresentTarget(t))return!1;return Wo(this.triggerConditionId,t,this,e,this.triggerConditionOpts)}isReleasable(t){return this.nature!=Oe.CONTINUOUS||this.location!=I.SZONE||this.position!=at.FACEUP?!1:Ms(this.releaseConditionId,t,this.releaseConditionOpts)}}class ko{constructor(){this.cards=[]}async loadFromData(t){for(let e of t)if(e.startsWith("monster")){let s=new Ho;await s.loadFromFile("samples/ccg/data/cards/"+e+"/data.json"),this.cards.push(s)}else if(e.startsWith("spell")){let s=new Go;await s.loadFromFile("samples/ccg/data/cards/"+e+"/data.json"),this.cards.push(s)}}getCards(){return this.cards}}class Xt extends Array{constructor(t){super(),this.location=t}getLocation(){return this.location}}class Cr{constructor(){this.name="",this.pictureFile="",this.deck,this.attributes,this.zones=[];let t=new Xt(I.MZONE);t.push(null,null,null),this.zones.push(t);let e=new Xt(I.SZONE);e.push(null,null,null),this.zones.push(e);let s=new Xt(I.FZONE);s.push(null),this.zones.push(s),this.zones.push(new Xt(I.DECK)),this.zones.push(new Xt(I.GRAVEYARD)),this.zones.push(new Xt(I.BANNISHED)),this.zones.push(new Xt(I.HAND))}async loadFromData(t){this.name=t.Name,this.pictureFile=t.PictureFile,this.deck=new ko,await this.deck.loadFromData(t.Deck),this.attributes=new pr(t.Attributes)}getName(){return this.name}getPictureFile(){return this.pictureFile}getDeck(){return this.deck}getAttributes(){return this.attributes}getAttribute(t){return this.attributes.get(t)}setAttribute(t,e){this.attributes.set(t,e)}incAttribute(t){this.attributes.set(t,this.attributes.get(t)+1)}getZone(t){return this.zones.find(e=>e.getLocation()==t)}getCard(t,e){return this.zones.find(i=>i.getLocation()==t)[e]}insertCard(t,e,s){let i=this.zones.find(r=>r.getLocation()==t);i[e]=s}removeCard(t,e){let s=this.zones.find(i=>i.getLocation()==t);s.splice(s.indexOf(e),1)}pushCard(t,e){this.zones.find(i=>i.getLocation()==t).push(e)}popCard(t){return this.zones.find(s=>s.getLocation()==t).pop()}isCapableDraw(t){return!(t.getCurrentTurn().getCurrentPhase().getId()!=vt.DRAW||this.attributes.get("DRAW_COUNT")>=this.attributes.get("DRAW_COUNT_LIMIT"))}isCapableSummon(t){let s=t.getCurrentTurn().getCurrentPhase(),r=t.getDuelists().indexOf(this);return!(s.getId()!=vt.MAIN||this.attributes.get("STATE_CANNOT_SUMMON")==1||this.attributes.get("SUMMON_COUNT")>=this.attributes.get("SUMMON_COUNT_LIMIT")||t.utilsQuery(r,[[I.HAND],0],h=>h&&h.isSummonable()).length==0||t.utilsQuery(r,[[I.MZONE],0],h=>h==null).length==0)}isCapableSet(t){let s=t.getCurrentTurn().getCurrentPhase(),r=t.getDuelists().indexOf(this);return!(s.getId()!=vt.MAIN||this.attributes.get("STATE_CANNOT_SET")==1||t.utilsQuery(r,[[I.HAND],0],h=>h&&h.isSetable()).length==0||t.utilsQuery(r,[[I.SZONE],0],h=>h==null).length==0)}isCapableChangePosition(t){let s=t.getCurrentTurn().getCurrentPhase(),r=t.getDuelists().indexOf(this);return!(s.getId()!=vt.MAIN||t.utilsQuery(r,[[I.MZONE],[I.MZONE]],a=>a&&a.getControler()==r&&a.isCapableChangePosition()).length==0)}isCapableBattle(t){let s=t.getCurrentTurn().getCurrentPhase(),r=t.getDuelists().indexOf(this);return!(s.getId()!=vt.BATTLE||t.utilsQuery(r,[[I.MZONE],[I.MZONE]],a=>a&&a.getControler()==r&&a.isCapableAttack()).length==0)}isCapableActivate(t){let s=t.getCurrentTurn().getCurrentPhase(),r=t.getDuelists().indexOf(this);return!(s.getId()!=vt.MAIN||t.utilsQuery(r,[[I.SZONE],[I.SZONE]],a=>a&&a.getControler()==r&&a.isActiveatable(t)).length==0)}async selectLocation(t,e=()=>!0){}async selectRequiredLocation(t,e=()=>!0){}}class Bt{constructor(t){this.duel=t,this.negate=!1}isNegate(){return this.negate}setNegate(t){this.negate=t}async exec(){return!0}}class js extends Bt{constructor(t,e){super(t),this.attackerCard=e}async exec(){await this.duel.operationDamage(this.duel.getOpponentDuelistIndex(),this.attackerCard.getAttribute("ATK")),await this.duel.operationIncCardAttribute(this.attackerCard,"ATK_COUNT")}}class Tr extends Bt{constructor(t){super(t)}async exec(){await this.duel.operationDraw(this.duel.getCurrentDuelistIndex(),1),await this.duel.operationIncDuelistAttribute(this.duel.getCurrentDuelistIndex(),"DRAW_COUNT")}}class Ar extends Bt{constructor(t,e,s){super(t),this.monsterCard=e,this.index=s}async exec(){await this.duel.operationSummon(this.monsterCard,this.index),await this.duel.operationIncDuelistAttribute(this.duel.getCurrentDuelistIndex(),"SUMMON_COUNT")}}class Ir extends Bt{constructor(t,e,s){super(t),this.spellCard=e,this.index=s}async exec(){await this.duel.operationSet(this.spellCard,this.index)}}class yr extends Bt{constructor(t,e){super(t),this.monsterCard=e}async exec(){let t=this.monsterCard.getPosition()==at.ATTACK?at.DEFENSE:at.ATTACK;this.duel.operationChangePosition(this.monsterCard,t)}}class vr extends Bt{constructor(t,e,s){super(t),this.attackerCard=e,this.targetCard=s}async exec(){this.targetCard?(await this.duel.operationBattle(this.attackerCard,this.targetCard),await this.duel.operationIncCardAttribute(this.attackerCard,"ATK_COUNT")):await this.duel.runAction(new js(this.duel,this.attackerCard))}}class xr extends Bt{constructor(t){super(t)}async exec(){await this.duel.operationNextPhase()}}class Gs extends Bt{constructor(t,e){super(t),this.spellCard=e}async exec(){await this.duel.operationChangePosition(this.spellCard,at.FACEUP);for(let t=0;t<this.spellCard.getEffects().length;t++)await this.duel.runAction(new qo(this.duel,this.spellCard,t));this.spellCard.getNature()==Oe.NORMAL&&await this.duel.operationDestroy(this.spellCard)}}class qo extends Bt{constructor(t,e,s){super(t),this.spellCard=e,this.effectIndex=s}async exec(){await this.duel.operationActivateCardEffect(this.spellCard,this.effectIndex)}}class Sr extends Cr{constructor(){super()}async loadFromFile(t){let e=await fetch(t);await this.loadFromData(await e.json())}async selectLocation(t,e=()=>!0){let s={};return s.state=!1,s.location="",s.index=0,s.card=null,await m.emit(this,"E_SELECT_LOCATION",{range:t,predicateCard:e,response:s,required:!1}),s.state?s:null}async selectRequiredLocation(t,e=()=>!0){let s={};return s.state=!1,s.location="",s.index=0,s.card=null,await m.emit(this,"E_SELECT_LOCATION",{range:t,predicateCard:e,response:s,required:!0}),s.state?s:null}}class Qt{async exec(t){}}class Yo extends Qt{constructor(){super()}async exec(t){await t.runAction(new Tr(t))}}class Xo extends Qt{constructor(){super()}async exec(t){let e=t.getCurrentDuelist(),s=await e.selectLocation([[I.HAND],0],r=>r&&r.isSummonable());if(s==null)return!1;let i=await e.selectLocation([[I.MZONE],0],r=>r==null);if(i==null)return!1;await t.runAction(new Ar(t,s.card,i.index))}}class zo extends Qt{constructor(){super()}async exec(t){let e=t.getCurrentDuelist(),s=await e.selectLocation([[I.HAND],0],r=>r&&r.isSetable());if(s==null)return!1;let i=await e.selectLocation([[I.SZONE],0],r=>r==null);if(i==null)return!1;await t.runAction(new Ir(t,s.card,i.index))}}class Zo extends Qt{constructor(){super()}async exec(t){let s=await t.getCurrentDuelist().selectLocation([[I.MZONE],[I.MZONE]],i=>i&&i.getControler()==t.getCurrentDuelistIndex()&&i.isCapableChangePosition());if(s==null)return!1;await t.runAction(new yr(t,s.card))}}class $o extends Qt{constructor(){super()}async exec(t){let e=t.getCurrentDuelist(),s=await e.selectLocation([[I.MZONE],[I.MZONE]],n=>n&&n.getControler()==t.getCurrentDuelistIndex()&&n.isCapableAttack());if(s==null)return!1;if(t.utilsQuery(t.getCurrentDuelistIndex(),[[I.MZONE],[I.MZONE]],n=>n&&n.getControler()==t.getOpponentDuelistIndex()).length==0)return await t.runAction(new js(t,s.card)),!0;let r=await e.selectLocation([[I.MZONE],[I.MZONE]],n=>n&&n.getControler()==t.getOpponentDuelistIndex());if(r==null)return!1;await t.runAction(new vr(t,s.card,r.card))}}class Ko extends Qt{constructor(){super()}async exec(t){await t.runAction(new xr(t))}}class Jo extends Qt{constructor(){super()}async exec(t){let s=await t.getCurrentDuelist().selectLocation([[I.SZONE],[I.SZONE]],i=>i&&i.getControler()==t.getCurrentDuelistIndex()&&i.isActiveatable(t));if(s==null)return!1;await t.runAction(new Gs(t,s.card))}}function Qo(o){if(o=="DRAW")return new Yo;if(o=="SUMMON")return new Xo;if(o=="SET")return new zo;if(o=="BATTLE")return new $o;if(o=="ACTIVATE")return new Jo;if(o=="CHANGE_POSITION")return new Zo;if(o=="NEXT_PHASE")return new Ko;throw new Error("CREATE_COMMAND: Command name unknown !")}let ks={};ks.LOWEST_ATK=function(o,t){return o.getAttribute("ATK")-t.getAttribute("ATK")};ks.HIGHEST_ATK=function(o,t){return t.getAttribute("ATK")-o.getAttribute("ATK")};function $t(o,t){return o==""?t.sort((e,s)=>e.getId()-s.getId()):t.sort((e,s)=>ks[o](e,s))}class Ti extends Cr{constructor(){super(),this.behaviors=[]}async loadFromData(t){for(let e of t.OverBehaviors){let s=Ai(e.Id);await s.loadFromData(e),this.behaviors.push(s)}for(let e of t.Behaviors){let s=Ai(e.Id);await s.loadFromData(e),this.behaviors.push(s)}await super.loadFromData(t)}async loadFromFile(t){let e=await fetch(t);await this.loadFromData(await e.json())}async selectLocation(t,e,s=()=>!0){let r=t.getDuelists().indexOf(this),n=t.utilsQuery(r,e,h=>s(h));if(n.length==0)return!1;let a={};return a.state=!0,a.location="",a.index=-1,a.card=n[0],a}async selectRequiredLocation(t,e,s=()=>!0){let r=t.getDuelists().indexOf(this),n=t.utilsQuery(r,e,h=>s(h));if(n.length==0)return!1;let a={};return a.state=!0,a.location="",a.index=-1,a.card=n[0],a}async handleNewTurn(t){for(;t.getCurrentDuelist()==this;){for(let e of this.behaviors)await e.process(t);await t.runAction(new xr(t)),await c.WAIT(2e3)}}}class Se{constructor(){this.id="",this.opts={},this.repeat=1,this.probability=1,this.conditionId="",this.conditionOpts={},this.cardConditionId="",this.cardConditionOpts={},this.cardSortId="",this.targetCardConditionId="",this.targetCardConditionOpts={},this.targetCardSortId=""}async loadFromData(t){this.id=t.Id,t.hasOwnProperty("Opts")&&(this.opts=t.Opts),t.hasOwnProperty("Repeat")&&(this.repeat=t.Repeat=="X"?99:t.Repeat),t.hasOwnProperty("Probability")&&(this.probability=t.Probability),t.hasOwnProperty("ConditionId")&&(this.conditionId=t.ConditionId,this.conditionOpts=t.ConditionOpts),t.hasOwnProperty("CardConditionId")&&(this.cardConditionId=t.CardConditionId,this.cardConditionOpts=t.CardConditionOpts),t.hasOwnProperty("CardSortId")&&(this.cardSortId=t.CardSortId),t.hasOwnProperty("TargetCardConditionId")&&(this.targetCardConditionId=t.TargetCardConditionId,this.targetCardConditionOpts=t.TargetCardConditionOpts),t.hasOwnProperty("TargetCardSortId")&&(this.targetCardSortId=t.TargetCardSortId)}async process(t){if(!!Ms(this.conditionId,t,this.conditionOpts)&&!(Math.random()>this.probability))for(let e=0;e<this.repeat;e++)await this.onProcess(t)}async onProcess(t){}}class ta extends Se{constructor(){super()}async onProcess(t){let e=t.getCurrentDuelist();for(;e.isCapableDraw(t);)await t.runAction(new Tr(t))}}class ea extends Se{constructor(){super()}async onProcess(t){let e=t.getCurrentDuelist(),s=t.getCurrentDuelistIndex();if(!e.isCapableSummon(t))return;let i=t.utilsQuery(s,[[I.HAND],0],n=>n&&n.isSummonable()&&Gt(this.cardConditionId,n,this.cardConditionOpts));if(i.length==0)return;i=$t(this.cardSortId,i);let r=e.getZone(I.MZONE).findIndex(n=>n==null);await t.runAction(new Ar(t,i[0],r))}}class sa extends Se{constructor(){super()}async onProcess(t){let e=t.getCurrentDuelist(),s=t.getCurrentDuelistIndex();if(!e.isCapableSet(t))return;let i=t.utilsQuery(s,[[I.HAND],0],n=>n&&n.isSetable()&&Gt(this.cardConditionId,n,this.cardConditionOpts));if(i.length==0)return;i=$t(this.cardSortId,i);let r=e.getZone(I.SZONE).findIndex(n=>n==null);await t.runAction(new Ir(t,i[0],r))}}class ia extends Se{constructor(){super()}async onProcess(t){let e=t.getCurrentDuelist(),s=t.getCurrentDuelistIndex();if(!e.isCapableChangePosition(t))return;let i=t.utilsQuery(s,[[I.MZONE],[I.MZONE]],r=>r&&r.getControler()==s&&r.isCapableChangePosition()&&Gt(this.cardConditionId,r,this.cardConditionOpts));i.length!=0&&(i=$t(this.cardSortId,i),await t.runAction(new yr(t,i[0])))}}class ra extends Se{constructor(){super()}async onProcess(t){let e=t.getCurrentDuelist(),s=t.getCurrentDuelistIndex();if(!e.isCapableBattle(t))return;let i=t.utilsQuery(s,[[I.MZONE],[I.MZONE]],n=>n&&n.getControler()==s&&n.isCapableAttack()&&Gt(this.cardConditionId,n,this.cardConditionOpts));if(i.length==0)return;let r=t.utilsQuery(s,[[I.MZONE],[I.MZONE]],n=>n&&n.getControler()!=s&&Gt(this.targetCardConditionId,n,this.targetCardConditionOpts));r.length==0?(i=$t(this.cardSortId,i),await t.runAction(new js(t,i[0]))):(i=$t(this.cardSortId,i),r=$t(this.targetCardSortId,r),await t.runAction(new vr(t,i[0],r[0])))}}class na extends Se{constructor(){super()}async onProcess(t){let e=t.getCurrentDuelist(),s=t.getCurrentDuelistIndex();if(!e.isCapableActivate(t))return;let i=t.utilsQuery(s,[[I.MZONE],[I.MZONE]],r=>r&&r.getControler()==s&&r.isActiveatable(t)&&Gt(this.cardConditionId,r,this.cardConditionOpts));i.length!=0&&(i=$t(this.cardSortId,i),await t.runAction(new Gs(t,i[0])))}}function Ai(o){if(o=="DRAW")return new ta;if(o=="SUMMON")return new ea;if(o=="SET")return new sa;if(o=="CHANGE_POSITION")return new ia;if(o=="BATTLE")return new ra;if(o=="ACTIVATE_CARD")return new na;throw new Error("AIDuelist::CREATE_BEHAVIOR(): Behavior name unknown !")}class Ii{constructor(){this.phases=[],this.currentPhase=null}getPhases(){return this.phases}getPhase(t){return this.phases.find(e=>e.id==t)}addPhase(t){this.phases.push(t)}getCurrentPhase(){return this.currentPhase}setCurrentPhase(t){this.currentPhase=t}}class ls{constructor(t,e,s=!1){this.id=t,this.name=e,this.disabled=s}getId(){return this.id}getName(){return this.name}isDisabled(){return this.disabled}setDisabled(t){this.disabled=t}}class oa{constructor(){this.duelists=[],this.turns=[],this.currentTurn=null,this.currentDuelistIndex=-1,this.opponentDuelistIndex=-1}async loadFromData(t){for(let e=0;e<2;e++){let s=t.DuelistIds[e],i=s.TypeName=="AIDuelist"?new Ti:new Sr;await i.loadFromFile("samples/ccg/data/duelist_"+s.Id+"/data.json");let r=i.getDeck();for(let n of r.getCards())n.setOwner(e),n.setControler(e),i.pushCard(I.DECK,n);this.duelists.push(i)}}async loadFromFile(t){let e=await fetch(t);await this.loadFromData(await e.json())}startup(){this.operationDraw(0,4),this.operationDraw(1,4),this.operationNewTurn()}async runAction(t){let e=this.utilsQuery(this.currentDuelistIndex,[[I.SZONE],[I.SZONE]],r=>r),s=this.utilsQuery(this.currentDuelistIndex,[[I.MZONE,I.SZONE,I.FZONE],[I.MZONE,I.SZONE,I.FZONE]],r=>r);for(let r of e)r.isTriggerable(this,t)&&await this.runAction(new Gs(this,r));if(!t.isNegate())await t.exec();else return;for(let r of e)r.isReleasable(this)&&await this.operationDestroy(r);for(let r of e)if(r.getPosition()==at.FACEUP&&r.getNature()==Oe.CONTINUOUS){for(let n of s)for(let a of r.getEffects())a.getTargetType()==we.FIELD&&(a.hasTargetCard(n)&&!a.isTarget(this,n)?(a.removeTargetCard(n),n.getAttributes().removeModifierIf(l=>l.isLinked()&&l.getLinkedEffect()==a)):!a.hasTargetCard(n)&&a.isTarget(this,n)&&(a.addTargetCard(n),a.apply(this,r,n)));for(let n of r.getEffects())if(n.getTargetType()==we.SINGLE)for(let a of n.getTargetCards())(a==null||!n.isTargetConditionCheck(a))&&await this.operationDestroy(r)}if(this.duelists[0].getAttribute("LIFEPOINTS")==0)return"WIN";if(this.duelists[1].getAttribute("LIFEPOINTS")==0)return"LOST";if(this.currentTurn.getCurrentPhase().getId()==vt.END)return this.operationNewTurn()}getDuelists(){return this.duelists}getDuelist(t){return this.duelists[t]}getCurrentDuelist(){return this.duelists[this.currentDuelistIndex]}getOpponentDuelist(){return this.duelists[this.opponentDuelistIndex]}getCurrentTurn(){return this.currentTurn}getCurrentDuelistIndex(){return this.currentDuelistIndex}getOpponentDuelistIndex(){return this.opponentDuelistIndex}async operationNewTurn(){if(this.currentDuelistIndex==-1?(this.currentDuelistIndex=1,this.opponentDuelistIndex=0):this.currentDuelistIndex==0?(this.currentDuelistIndex=1,this.opponentDuelistIndex=0):(this.currentDuelistIndex=0,this.opponentDuelistIndex=1),this.turns.length<2){let t=new Ii,e=t.getPhases();t.addPhase(yi()),t.addPhase(vi()),t.addPhase(xi()),t.setCurrentPhase(e[0]),this.turns.push(t),this.currentTurn=t}else{let t=new Ii,e=t.getPhases();t.addPhase(yi()),t.addPhase(vi()),t.addPhase(aa()),t.addPhase(xi()),t.setCurrentPhase(e[0]),this.turns.push(t),this.currentTurn=t}for(let t of this.duelists)t.setAttribute("DRAW_COUNT",0),t.setAttribute("SUMMON_COUNT",0);for(let t of this.utilsQuery(this.currentDuelistIndex,[[I.SZONE,I.MZONE,I.FZONE],[I.SZONE,I.MZONE,I.FZONE]],e=>e))t.getType()==V.MONSTER?(t.setAttribute("ATK_COUNT",0),t.incTurnCounter()):t.getType()==V.SPELL&&t.getPosition()==at.FACEUP&&t.incTurnCounter();this.duelists[this.currentDuelistIndex]instanceof Ti&&this.duelists[this.currentDuelistIndex].handleNewTurn(this),m.emit(this,"E_NEW_TURN")}async operationDraw(t,e){let s=this.duelists[t].getZone(I.HAND);if(s.length+e>Ci)for(let i=0;i<s.length+e-Ci;i++){let r=await this.operationSelectLocation([[I.HAND],0],n=>n);this.duelists[t].removeCard(I.HAND,r.card)}for(;e-- >0;){let i=this.duelists[t].popCard(I.DECK);this.duelists[t].pushCard(I.HAND,i),i.setLocation(I.HAND)}}async operationRestore(t,e){this.duelists[t].getAttributes().add("LIFEPOINTS",+e),m.emit(this.duelists[t],"E_RESTORE",{amount:e})}async operationDamage(t,e){this.duelists[t].getAttributes().add("LIFEPOINTS",-e),m.emit(this.duelists[t],"E_DAMAGE",{amount:e})}async operationSummon(t,e){this.duelists[t.getControler()].removeCard(I.HAND,t),this.duelists[t.getControler()].insertCard(I.MZONE,e,t),t.setPosition(at.ATTACK),t.setLocation(I.MZONE)}async operationSet(t,e){this.duelists[t.getControler()].removeCard(I.HAND,t),this.duelists[t.getControler()].insertCard(I.SZONE,e,t),t.setPosition(at.FACEDOWN),t.setLocation(I.SZONE)}async operationChangePosition(t,e){t.setPosition(e)}async operationBattle(t,e){let s=e.getPosition()==at.ATTACK?e.getAttribute("ATK"):e.getAttribute("DEF"),i=t.getAttribute("ATK")-s;i>0?(this.operationDestroy(e),this.operationDamage(e.getControler(),Math.abs(i))):i<0?(this.operationDestroy(t),this.operationDamage(t.getControler(),Math.abs(i))):(this.operationDestroy(e),this.operationDestroy(t))}async operationNextPhase(){let t=this.currentTurn.getPhases(),e=t.indexOf(this.currentTurn.getCurrentPhase())+1;for(;t[e].isDisabled()&&e<t.length;)e++;this.currentTurn.setCurrentPhase(t[e])}async operationChangePhase(t){let e=this.currentTurn.getPhase(t);if(!e)throw new Error("Duel::operationChangePhase : phase not found !");if(e.isDisabled())throw new Error("Duel::operationChangePhase : phase is disabled !");this.currentTurn.setCurrentPhase(e)}async operationIncDuelistAttribute(t,e){this.duelists[t].incAttribute(e)}async operationAddDuelistModifier(t,e){this.duelists[t].getAttributes().addModifier(e)}async operationIncCardAttribute(t,e){t.incAttribute(e)}async operationAddCardModifier(t,e){t.getAttributes().addModifier(e)}async operationDestroy(t){if(t.getType()==V.SPELL)for(let e of t.getEffects()){for(let s of e.getTargetCards())s.getAttributes().removeModifierIf(r=>r.isLinked()&&r.getLinkedEffect()==e);for(let s of this.duelists)s.getAttributes().removeModifierIf(r=>r.isLinked()&&r.getLinkedEffect()==e)}this.utilsRemoveCard(t),this.duelists[t.getControler()].pushCard(I.GRAVEYARD,t),t.setPosition(at.FACEDOWN),t.setLocation(I.GRAVEYARD)}async operationActivateCardEffect(t,e){let s=[],r=t.getEffects()[e],n=t.getControler();if(r.getTargetType()==we.SINGLE){let a=await this.duelists[n].selectRequiredLocation(r.getTargetRange(),h=>h&&r.isTarget(this,h));s.push(a.card)}else r.getTargetType()==we.FIELD?s=this.utilsQuery(n,r.getTargetRange(),a=>a&&r.isTarget(this,a)):r.getTargetType()==we.NONE&&(s=[null]);for(let a of s)r.apply(this,t,a),r.addTargetCard(a)}utilsRemoveCard(t){let e=this.duelists[t.getOwner()];if(t.getLocation()==I.MZONE||t.getLocation()==I.SZONE||t.getLocation()==I.FZONE){let i=e.getZone(t.getLocation()).indexOf(t);e.insertCard(t.getLocation(),i,null)}else e.removeCard(t.getLocation(),t)}utilsQuery(t,e,s=i=>!0){let i=[],r=t,n=t==0?1:0;for(let a=0;a<2;a++){if(e[a]==0)continue;let h=a==0?r:n;for(let l=0;l<e[a].length;l++){let u=this.duelists[h].getZone(e[a][l]);i=i.concat(u.filter(s))}}return i}}function yi(){return new ls(vt.DRAW,"Draw Phase",!1)}function vi(){return new ls(vt.MAIN,"Main Phase",!1)}function aa(){return new ls(vt.BATTLE,"Battle Phase",!1)}function xi(){return new ls(vt.END,"End Phase",!1)}class ha extends W{constructor(){super({className:"UITurn"}),this.duel=null}update(){if(this.node.innerHTML="",this.duel&&this.duel.getCurrentTurn()){let t=this.duel.getCurrentTurn();for(let e of t.getPhases())this.node.innerHTML+=`<div class="UITurn-phase ${t.getCurrentPhase()==e?"u-active":""}">${e.getName()}</div>`}}setDuel(t){this.duel=t||null}}class Si extends W{constructor(){super({className:"UIDuelist",template:`
      <div class="UIDuelist-picture js-picture"></div>
      <div class="UIDuelist-infos">
        <div class="UIDuelist-infos-name js-name"></div>
        <div class="UIDuelist-infos-lifepoints js-lifepoints"></div>
      </div>`}),this.duelist=null}update(){this.duelist?(this.node.querySelector(".js-picture").style.backgroundImage=`url(${this.duelist.getPictureFile()})`,this.node.querySelector(".js-name").textContent=this.duelist.getName(),this.node.querySelector(".js-lifepoints").textContent=this.duelist.getAttribute("LIFEPOINTS")):(this.node.querySelector(".js-picture").style.backgroundImage="url()",this.node.querySelector(".js-name").textContent="--",this.node.querySelector(".js-lifepoints").textContent="0")}setDuelist(t){m.unsubscribe(this.duelist,"E_DAMAGE",this),m.unsubscribe(this.duelist,"E_RESTORE",this),t?(m.subscribe(t,"E_DAMAGE",this,this.handleDuelistDamage),m.subscribe(t,"E_RESTORE",this,this.handleDuelistRestore),this.duelist=t):this.duelist=null}showSelection(){this.node.classList.add("u-showSelection")}hideSelection(){this.node.classList.remove("u-showSelection")}handleDuelistDamage(t){wi(this.node,"-"+t.amount,"#fff",1e3),la(this.node,300)}handleDuelistRestore(t){wi(this.node,"+"+t.amount,"#fff",1e3)}}function la(o,t){return new Promise(e=>{setTimeout(()=>{o.classList.add("u-shake")},0),setTimeout(()=>{o.classList.remove("u-shake"),e()},t)})}function wi(o,t,e,s){return new Promise(i=>{let r=document.createElement("div");r.className="UIDuelist-toast",r.textContent=t,r.style.color=e,o.appendChild(r),setTimeout(()=>{r.remove(),i()},s)})}class ca extends W{constructor(){super({className:"UICardDetail",template:`
      <div class="UICardDetail-title js-title"></div>
      <div class="UICardDetail-body">
        <img class="UICardDetail-body-coverImg js-cover-img">
        <div class="UICardDetail-body-infos js-infos"></div>
      </div>`}),this.card=null}update(){this.card?(this.node.querySelector(".js-title").textContent=this.card.getName(),this.node.querySelector(".js-cover-img").src=this.card.getCoverFile(),this.node.querySelector(".js-infos").textContent="",this.card.getType()==V.MONSTER?this.node.querySelector(".js-infos").textContent+=`Type: MONSTRE
`:this.card.getType()==V.SPELL&&(this.node.querySelector(".js-infos").textContent+=`Type: MAGIE
`),this.card.getAttribute("ELEMENT")==Yt.DARK?this.node.querySelector(".js-infos").textContent+=`Element: TENEBRE
`:this.card.getAttribute("ELEMENT")==Yt.LIGHT?this.node.querySelector(".js-infos").textContent+=`Element: LUMIERE
`:this.card.getAttribute("ELEMENT")==Yt.EARTH?this.node.querySelector(".js-infos").textContent+=`Element: TERRE
`:this.card.getAttribute("ELEMENT")==Yt.WIND?this.node.querySelector(".js-infos").textContent+=`Element: VENT
`:this.card.getAttribute("ELEMENT")==Yt.FIRE?this.node.querySelector(".js-infos").textContent+=`Element: FEU
`:this.card.getAttribute("ELEMENT")==Yt.WATER?this.node.querySelector(".js-infos").textContent+=`Element: EAU
`:this.card.getAttribute("ELEMENT")==Yt.DIVINE&&(this.node.querySelector(".js-infos").textContent+=`Element: DIVIN
`),this.card.getType()==V.SPELL&&this.card.getNature()==Oe.NORMAL?this.node.querySelector(".js-infos").textContent+=`Nature: NORMAL
`:this.card.getType()==V.SPELL&&this.card.getNature()==Oe.CONTINUOUS&&(this.node.querySelector(".js-infos").textContent+=`Nature: CONTINUE
`),this.card.getType()==V.SPELL&&this.card.getMode()==$e.ACTIVATE?this.node.querySelector(".js-infos").textContent+=`Mode: ACTIVATION
`:this.card.getType()==V.SPELL&&this.card.getMode()==$e.TRIGGER&&(this.node.querySelector(".js-infos").textContent+=`Mode: PIEGE
`),this.card.getType()==V.MONSTER&&this.card.getAttribute("RACE")==J.AQUA?this.node.querySelector(".js-infos").textContent+=`Race: AQUA
`:this.card.getType()==V.MONSTER&&this.card.getAttribute("RACE")==J.BEAST?this.node.querySelector(".js-infos").textContent+=`Race: BETE
`:this.card.getType()==V.MONSTER&&this.card.getAttribute("RACE")==J.BEAST_WARRIOR?this.node.querySelector(".js-infos").textContent+=`Race: BETE GUERRIERE
`:this.card.getType()==V.MONSTER&&this.card.getAttribute("RACE")==J.DINOSAUR?this.node.querySelector(".js-infos").textContent+=`Race: DINOSAURE
`:this.card.getType()==V.MONSTER&&this.card.getAttribute("RACE")==J.FAIRY?this.node.querySelector(".js-infos").textContent+=`Race: FEE
`:this.card.getType()==V.MONSTER&&this.card.getAttribute("RACE")==J.FIEND?this.node.querySelector(".js-infos").textContent+=`Race: DEMON
`:this.card.getType()==V.MONSTER&&this.card.getAttribute("RACE")==J.FISH?this.node.querySelector(".js-infos").textContent+=`Race: POISSON
`:this.card.getType()==V.MONSTER&&this.card.getAttribute("RACE")==J.INSECT?this.node.querySelector(".js-infos").textContent+=`Race: INSECTE
`:this.card.getType()==V.MONSTER&&this.card.getAttribute("RACE")==J.MACHINE?this.node.querySelector(".js-infos").textContent+=`Race: MACHINE
`:this.card.getType()==V.MONSTER&&this.card.getAttribute("RACE")==J.PLANT?this.node.querySelector(".js-infos").textContent+=`Race: PLANTE
`:this.card.getType()==V.MONSTER&&this.card.getAttribute("RACE")==J.PSYCHIC?this.node.querySelector(".js-infos").textContent+=`Race: PSYCHIQUE
`:this.card.getType()==V.MONSTER&&this.card.getAttribute("RACE")==J.PYRO?this.node.querySelector(".js-infos").textContent+=`Race: PYRO
`:this.card.getType()==V.MONSTER&&this.card.getAttribute("RACE")==J.REPTILE?this.node.querySelector(".js-infos").textContent+=`Race: REPTILE
`:this.card.getType()==V.MONSTER&&this.card.getAttribute("RACE")==J.SEASERPENT?this.node.querySelector(".js-infos").textContent+=`Race: SERPENT DE MER
`:this.card.getType()==V.MONSTER&&this.card.getAttribute("RACE")==J.SPELLCASTER?this.node.querySelector(".js-infos").textContent+=`Race: MAGICIEN
`:this.card.getType()==V.MONSTER&&this.card.getAttribute("RACE")==J.THUNDER?this.node.querySelector(".js-infos").textContent+=`Race: ECLAIR
`:this.card.getType()==V.MONSTER&&this.card.getAttribute("RACE")==J.WARRIOR?this.node.querySelector(".js-infos").textContent+=`Race: GUERRIER
`:this.card.getType()==V.MONSTER&&this.card.getAttribute("RACE")==J.WINGEDBEAST?this.node.querySelector(".js-infos").textContent+=`Race: BETE AILEE
`:this.card.getType()==V.MONSTER&&this.card.getAttribute("RACE")==J.ZOMBIE?this.node.querySelector(".js-infos").textContent+=`Race: ZOMBIE
`:this.card.getType()==V.MONSTER&&this.card.getAttribute("RACE")==J.WYRM?this.node.querySelector(".js-infos").textContent+=`Race: WYRM
`:this.card.getType()==V.MONSTER&&this.card.getAttribute("RACE")==J.DRAGON?this.node.querySelector(".js-infos").textContent+=`Race: DRAGON
`:this.card.getType()==V.MONSTER&&this.card.getAttribute("RACE")==J.DIVINEBEAST?this.node.querySelector(".js-infos").textContent+=`Race: DIVINITE
`:this.card.getType()==V.MONSTER&&this.card.getAttribute("RACE")==J.CREATORGOD?this.node.querySelector(".js-infos").textContent+=`Race: DIEU CREATEUR
`:this.card.getType()==V.MONSTER&&this.card.getAttribute("RACE")==J.CYBERSE&&(this.node.querySelector(".js-infos").textContent+=`Race: CYBORG
`),this.node.querySelector(".js-infos").textContent+="Description: "+this.card.getText()+`
`,this.card.getType()==V.MONSTER&&(this.node.querySelector(".js-infos").innerHTML+=`
        <div class="UICardDetail-body-infos-stats">
          <div class="UICardDetail-body-infos-stats-item">ATK ${this.card.getAttribute("ATK")}</div>
          <div class="UICardDetail-body-infos-stats-item">DEF ${this.card.getAttribute("DEF")}</div>
        </div>`)):(this.node.querySelector(".js-title").textContent="--",this.node.querySelector(".js-cover-img").src="",this.node.querySelector(".js-infos").textContent="")}setCard(t){this.card=t||null}}class Ke extends W{constructor(){super({className:"UICardSlot",template:`
      <div class="UICardSlot-bg js-bg"></div>`}),this.card=null,this.duelistIndex=0,this.location="",this.index=0,this.hidden=!1,this.selectable=!1}update(){this.card?(this.node.style.transform=`rotate(${this.card.getPosition()==at.DEFENSE?"90deg":"0deg"})`,this.node.querySelector(".js-bg").style.backgroundImage=this.hidden?"url(samples/ccg/card_back.png)":"url("+this.card.getCoverFile()+")"):(this.node.style.transform="rotate(0deg)",this.node.querySelector(".js-bg").style.backgroundImage="url()")}getCard(){return this.card}setCard(t){this.card=t||null}getDuelistIndex(){return this.duelistIndex}setDuelistIndex(t){this.duelistIndex=t}getLocation(){return this.location}setLocation(t){this.location=t}getIndex(){return this.index}setIndex(t){this.index=t}isHidden(){return this.hidden}setHidden(t){this.hidden=t}isSelectable(){return this.node.classList.contains("u-selectable")}setSelectable(t){this.node.classList.toggle("u-selectable",t)}}class wr extends W{constructor(){super({className:"UIStackSlot",template:`
        <div class="UIStackSlot-bg js-bg"></div>
        <div class="UIStackSlot-numCards js-num-cards"></div>`}),this.cards=[],this.duelistIndex=0,this.location="",this.hidden=!1,this.selectable=!1}update(){if(this.cards.length>0){let t=this.cards[this.cards.length-1];this.node.querySelector(".js-bg").style.backgroundImage=this.hidden?"url(samples/ccg/card_back.png)":"url("+t.getCoverFile()+")",this.node.querySelector(".js-num-cards").textContent=this.cards.length}else this.node.querySelector(".js-bg").style.backgroundImage="url()",this.node.querySelector(".js-num-cards").textContent=0}setCards(t){this.cards=t||[]}getDuelistIndex(){return this.duelistIndex}setDuelistIndex(t){this.duelistIndex=t}getLocation(){return this.location}setLocation(t){this.location=t}isHidden(){return this.hidden}setHidden(t){this.hidden=t}isSelectable(){return this.node.classList.contains("u-selectable")}setSelectable(t){this.node.classList.toggle("u-selectable",t)}}class ua extends W{constructor(){super({className:"UIBoard",template:`
      <div class="UIBoard-fields">
        <div class="UIBoard-field" data-duelist-index="0">
          <div class="UIBoard-field-zone js-zone" data-duelist-index="0" data-location="MZONE" style="top:80px; left:127px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="0" data-location="MZONE" style="top:80px; left:177px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="0" data-location="MZONE" style="top:80px; left:227px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="0" data-location="SZONE" style="top:10px; left:127px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="0" data-location="SZONE" style="top:10px; left:177px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="0" data-location="SZONE" style="top:10px; left:227px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="0" data-location="FZONE" style="top:150px; left:10px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="0" data-location="GRAVEYARD" style="top:80px; left:10px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="0" data-location="DECK" style="top:10px; left:10px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="0" data-location="HAND" style="top:10px; right:10px;"></div>
        </div>
        <div class="UIBoard-field" data-duelist-index="1">
          <div class="UIBoard-field-zone js-zone" data-duelist-index="1" data-location="MZONE" style="bottom:80px; right:127px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="1" data-location="MZONE" style="bottom:80px; right:177px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="1" data-location="MZONE" style="bottom:80px; right:227px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="1" data-location="SZONE" style="bottom:10px; right:127px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="1" data-location="SZONE" style="bottom:10px; right:177px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="1" data-location="SZONE" style="bottom:10px; right:227px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="1" data-location="FZONE" style="bottom:150px; right:10px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="1" data-location="GRAVEYARD" style="bottom:80px; right:10px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="1" data-location="DECK" style="bottom:10px; right:10px;"></div>
          <div class="UIBoard-field-zone js-zone" data-duelist-index="1" data-location="HAND" style="bottom:10px; left:10px;"></div>
        </div>
      </div>`}),this.duel=null,this.slots=[],this.focusedSlot=null;let t=z(0,I.SZONE,0,!1);this.node.querySelectorAll('.js-zone[data-duelist-index="0"][data-location="SZONE"]')[0].appendChild(t.getNode()),this.slots.push(t);let s=z(0,I.SZONE,1,!1);this.node.querySelectorAll('.js-zone[data-duelist-index="0"][data-location="SZONE"]')[1].appendChild(s.getNode()),this.slots.push(s);let r=z(0,I.SZONE,2,!1);this.node.querySelectorAll('.js-zone[data-duelist-index="0"][data-location="SZONE"]')[2].appendChild(r.getNode()),this.slots.push(r);let a=z(0,I.MZONE,0,!1);this.node.querySelectorAll('.js-zone[data-duelist-index="0"][data-location="MZONE"]')[0].appendChild(a.getNode()),this.slots.push(a);let l=z(0,I.MZONE,1,!1);this.node.querySelectorAll('.js-zone[data-duelist-index="0"][data-location="MZONE"]')[1].appendChild(l.getNode()),this.slots.push(l);let d=z(0,I.MZONE,2,!1);this.node.querySelectorAll('.js-zone[data-duelist-index="0"][data-location="MZONE"]')[2].appendChild(d.getNode()),this.slots.push(d);let E=z(0,I.HAND,0,!0),T=this.node.querySelectorAll('.js-zone[data-duelist-index="0"][data-location="HAND"]')[0];T.appendChild(E.getNode()),this.slots.push(E);let A=z(0,I.HAND,1,!0);T.appendChild(A.getNode()),this.slots.push(A);let x=z(0,I.HAND,2,!0);T.appendChild(x.getNode()),this.slots.push(x);let y=z(0,I.HAND,3,!0);T.appendChild(y.getNode()),this.slots.push(y);let C=z(0,I.HAND,4,!0);T.appendChild(C.getNode()),this.slots.push(C);let S=z(0,I.HAND,5,!0);T.appendChild(S.getNode()),this.slots.push(S);let w=z(0,I.FZONE,0,!1);this.node.querySelectorAll('.js-zone[data-duelist-index="0"][data-location="FZONE"]')[0].appendChild(w.getNode()),this.slots.push(w);let O=He(0,I.GRAVEYARD,!1);this.node.querySelectorAll('.js-zone[data-duelist-index="0"][data-location="GRAVEYARD"]')[0].appendChild(O.getNode()),this.slots.push(O);let H=He(0,I.DECK,!0);this.node.querySelectorAll('.js-zone[data-duelist-index="0"][data-location="DECK"]')[0].appendChild(H.getNode()),this.slots.push(H);let Z=z(1,I.SZONE,0,!1);this.node.querySelectorAll('.js-zone[data-duelist-index="1"][data-location="SZONE"]')[0].appendChild(Z.getNode()),this.slots.push(Z);let K=z(1,I.SZONE,1,!1);this.node.querySelectorAll('.js-zone[data-duelist-index="1"][data-location="SZONE"]')[1].appendChild(K.getNode()),this.slots.push(K);let st=z(1,I.SZONE,2,!1);this.node.querySelectorAll('.js-zone[data-duelist-index="1"][data-location="SZONE"]')[2].appendChild(st.getNode()),this.slots.push(st);let Tt=z(1,I.MZONE,0,!1);this.node.querySelectorAll('.js-zone[data-duelist-index="1"][data-location="MZONE"]')[0].appendChild(Tt.getNode()),this.slots.push(Tt);let At=z(1,I.MZONE,1,!1);this.node.querySelectorAll('.js-zone[data-duelist-index="1"][data-location="MZONE"]')[1].appendChild(At.getNode()),this.slots.push(At);let ie=z(1,I.MZONE,2,!1);this.node.querySelectorAll('.js-zone[data-duelist-index="1"][data-location="MZONE"]')[2].appendChild(ie.getNode()),this.slots.push(ie);let re=z(1,I.HAND,0,!1),bt=this.node.querySelectorAll('.js-zone[data-duelist-index="1"][data-location="HAND"]')[0];bt.appendChild(re.getNode()),this.slots.push(re);let ne=z(1,I.HAND,1,!1);bt.appendChild(ne.getNode()),this.slots.push(ne);let oe=z(1,I.HAND,2,!1);bt.appendChild(oe.getNode()),this.slots.push(oe);let ae=z(1,I.HAND,3,!1);bt.appendChild(ae.getNode()),this.slots.push(ae);let he=z(1,I.HAND,4,!1);bt.appendChild(he.getNode()),this.slots.push(he);let le=z(1,I.HAND,5,!1);bt.appendChild(le.getNode()),this.slots.push(le);let ce=z(1,I.FZONE,0,!1);this.node.querySelectorAll('.js-zone[data-duelist-index="1"][data-location="FZONE"]')[0].appendChild(ce.getNode()),this.slots.push(ce);let ue=He(1,I.GRAVEYARD,!1);this.node.querySelectorAll('.js-zone[data-duelist-index="1"][data-location="GRAVEYARD"]')[0].appendChild(ue.getNode()),this.slots.push(ue);let Ve=He(1,I.DECK,!1);this.node.querySelectorAll('.js-zone[data-duelist-index="1"][data-location="DECK"]')[0].appendChild(Ve.getNode()),this.slots.push(Ve),this.focusedSlot=H}update(){if(this.duel){for(let t of this.slots){let e=this.duel.getDuelist(t.getDuelistIndex());t instanceof Ke?t.setCard(e.getCard(t.getLocation(),t.getIndex())):t.setCards(e.getZone(t.getLocation()))}for(let t of this.slots)t.update()}}delete(){for(let t of this.slots)t.delete();super.delete()}focus(){this.focusedSlot&&(this.focusedSlot.focus(),m.emit(this,"E_SLOT_FOCUSED",{slot:this.focusedSlot})),super.focus()}unfocus(){this.focusedSlot&&(this.focusedSlot.unfocus(),m.emit(this,"E_SLOT_UNFOCUSED")),super.unfocus()}getSlots(){return this.slots}setDuel(t){for(let e of this.slots)e instanceof Ke?e.setCard(null):e instanceof wr&&e.setCards(null);this.duel=t||null}onAction(t){t=="BACK"?m.emit(this,"E_ECHAP_PRESSED"):t=="OK"?(m.emit(this,"E_SLOT_SELECTED",{slot:this.focusedSlot}),m.emit(this,"E_OK_PRESSED")):t=="UP"?this.$moveFocus(0,-1,!0):t=="DOWN"?this.$moveFocus(0,1,!0):t=="LEFT"?this.$moveFocus(-1,0,!0):t=="RIGHT"&&this.$moveFocus(1,0,!0)}$moveFocus(t,e,s=!1){let i=this.focusedSlot.getNode(),r=As(i),n=r.left+i.offsetWidth*.5,a=r.top+i.offsetHeight*.5,h=this.slots.slice();h.splice(h.indexOf(this.focusedSlot),1);let l=h.sort((u,d)=>{let p=u.getNode(),E=d.getNode(),T=As(p),A=As(E),x=T.left+p.offsetWidth*.5,y=T.top+p.offsetHeight*.5,C=A.left+E.offsetWidth*.5,S=A.top+E.offsetHeight*.5,w=[x-n,y-a],P=[C-n,S-a];return w[0]=Math.sign(w[0])==Math.sign(t)||t==0?Math.abs(w[0]):this.node.offsetWidth-Math.abs(w[0]),w[1]=Math.sign(w[1])==Math.sign(e)||e==0?Math.abs(w[1]):this.node.offsetHeight-Math.abs(w[1]),P[0]=Math.sign(P[0])==Math.sign(t)||t==0?Math.abs(P[0]):this.node.offsetWidth-Math.abs(P[0]),P[1]=Math.sign(P[1])==Math.sign(e)||e==0?Math.abs(P[1]):this.node.offsetHeight-Math.abs(P[1]),c.VEC2_LENGTH(w)-c.VEC2_LENGTH(P)});this.focusedSlot&&this.focusedSlot.unfocus(),l[0].focus(),this.focusedSlot=l[0],s&&m.emit(this,"E_SLOT_FOCUSED",{slot:l[0]})}}function z(o,t,e,s){let i=new Ke;return i.setDuelistIndex(o),i.setLocation(t),i.setIndex(e),i.setHidden(s),i}function He(o,t,e){let s=new wr;return s.setDuelistIndex(o),s.setLocation(t),s.setHidden(e),s}function As(o){for(var t=0,e=0;o&&!isNaN(o.offsetLeft)&&!isNaN(o.offsetTop);)t+=o.offsetLeft-o.scrollLeft,e+=o.offsetTop-o.scrollTop,o=o.offsetParent;return{top:e,left:t}}class da extends U{constructor(){super(),this.duel=new oa,this.uiBgNode=document.createElement("video"),this.uiTurn=new ha,this.uiDuelists=[],this.uiCardDetail=new ca,this.uiBoard=new ua,this.uiActionMenu=new it,this.menuEnabled=!1}async onEnter(t={duelId}){await this.duel.loadFromFile("samples/ccg/data/duel_"+t.duelId+"/data.json"),this.uiBgNode.src="samples/ccg/bg.mp4",this.uiBgNode.play(),this.uiBgNode.loop=!0,g.addNode(this.uiBgNode,"position:absolute; top:0; right:0; bottom:0; left:0; height:100%"),this.uiTurn.setDuel(this.duel),g.addWidget(this.uiTurn,"position: absolute; top:0; left:0; right:0; line-height:30px; z-index:100"),this.uiDuelists.push(new Si),this.uiDuelists[0].setDuelist(this.duel.getDuelist(0)),g.addWidget(this.uiDuelists[0],"position:absolute; top:30px; left:0; width:20%"),this.uiDuelists.push(new Si),this.uiDuelists[1].setDuelist(this.duel.getDuelist(1)),g.addWidget(this.uiDuelists[1],"position:absolute; top:30px; right:0; width:20%"),g.addWidget(this.uiCardDetail,"position: absolute; top:30px; left:20%; width:60%"),this.uiBoard.setDuel(this.duel),g.addWidget(this.uiBoard,"position:absolute; top:50%; left:0; right:0; width:100%; height:50%"),this.uiActionMenu.setVisible(!1),g.addWidget(this.uiActionMenu,"position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); z-index:20;"),m.subscribe(this.duel,"E_NEW_TURN",this,this.handleNewTurn),m.subscribe(this.duel.getDuelist(1),"E_SELECT_LOCATION",this,this.handleSelectLocation),m.subscribe(this.uiBoard,"E_SLOT_UNFOCUSED",this,this.handleBoardSlotUnfocused),m.subscribe(this.uiBoard,"E_SLOT_FOCUSED",this,this.handleBoardSlotFocused),m.subscribe(this.uiBoard,"E_OK_PRESSED",this,this.handleBoardSelectPressed),m.subscribe(this.uiActionMenu,"E_CLOSED",this,this.handleActionMenuClosed),m.subscribe(this.uiActionMenu,"E_ITEM_SELECTED",this,this.handleActionMenuItemSelected),g.focus(this.uiBoard),this.duel.startup()}async onExit(){g.removeNode(this.uiBgNode),g.removeWidget(this.uiTurn),g.removeWidget(this.uiDuelists[0]),g.removeWidget(this.uiDuelists[1]),g.removeWidget(this.uiCardDetail),g.removeWidget(this.uiBoard),g.removeWidget(this.uiActionMenu)}handleNewTurn(){this.uiDuelists[this.duel.getOpponentDuelistIndex()].hideSelection(),this.uiDuelists[this.duel.getCurrentDuelistIndex()].showSelection(),this.duel.getCurrentDuelist()instanceof Sr?this.menuEnabled=!0:this.menuEnabled=!1}handleSelectLocation({range:t,predicateCard:e,required:s,response:i}){return new Promise(r=>{g.focus(this.uiBoard);for(let n of this.uiBoard.getSlots())for(let a=0;a<2;a++){let h=a==0?this.duel.getCurrentDuelistIndex():this.duel.getOpponentDuelistIndex();t[a]!=0&&n.getDuelistIndex()==h&&t[a].includes(n.getLocation())&&e(n.getCard())&&n.setSelectable(!0)}s||m.subscribe(this.uiBoard,"E_ECHAP_PRESSED",this,()=>{m.unsubscribe(this.uiBoard,"E_ECHAP_PRESSED",this),m.unsubscribe(this.uiBoard,"E_SLOT_SELECTED",this);for(let n of this.uiBoard.getSlots())n.setSelectable(!1);i.state=!1,r()}),m.subscribe(this.uiBoard,"E_SLOT_SELECTED",this,n=>{if(n.slot.isSelectable()){m.unsubscribe(this.uiBoard,"E_ECHAP_PRESSED",this),m.unsubscribe(this.uiBoard,"E_SLOT_SELECTED",this);for(let a of this.uiBoard.getSlots())a.setSelectable(!1);i.state=!0,i.location=n.slot.getLocation(),i.index=n.slot.getIndex(),i.card=n.slot.getCard(),r()}})})}handleBoardSlotUnfocused(){this.uiCardDetail.setCard(null)}handleBoardSlotFocused(t){t.slot instanceof Ke&&t.slot.getCard()&&!t.slot.isHidden()?this.uiCardDetail.setCard(t.slot.getCard()):this.uiCardDetail.setCard(null)}handleBoardSelectPressed(){if(!this.menuEnabled)return!1;this.uiActionMenu.clear();let t=this.duel.getCurrentDuelist();t.isCapableDraw(this.duel)&&this.uiActionMenu.add("DRAW","Piocher"),t.isCapableSummon(this.duel)&&this.uiActionMenu.add("SUMMON","Invoquer"),t.isCapableSet(this.duel)&&this.uiActionMenu.add("SET","Poser"),t.isCapableBattle(this.duel)&&this.uiActionMenu.add("BATTLE","Attaquer"),t.isCapableActivate(this.duel)&&this.uiActionMenu.add("ACTIVATE","Activer"),t.isCapableChangePosition(this.duel)&&this.uiActionMenu.add("CHANGE_POSITION","Changer de position"),this.uiActionMenu.add("NEXT_PHASE","Phase suivante"),this.uiActionMenu.setVisible(!0),g.focus(this.uiActionMenu)}handleActionMenuClosed(){this.uiActionMenu.setVisible(!1),g.focus(this.uiBoard)}async handleActionMenuItemSelected(t){this.uiActionMenu.setVisible(!1),this.menuEnabled=!1,await Qo(t.id).exec(this.duel),g.focus(this.uiBoard),this.menuEnabled=!0}}class pa{maxChildren;maxDepth;root;constructor(t,e,s){this.maxChildren=t,this.maxDepth=e,this.root=new Je(this,0,s)}draw(){this.root.draw()}search(t,e=[]){return this.root.search(t,e)}addChild(t){this.root.addChild(t)}getMaxChildren(){return this.maxChildren}getMaxDepth(){return this.maxDepth}}class Je{tree;depth;method;parent=null;left=null;right=null;children=[];constructor(t,e,s){this.reset(),this.tree=t,this.depth=e,this.method=s}draw(){this.method.draw(),this.left&&this.left.draw(),this.right&&this.right.draw()}search(t,e=[]){return this.method.search(this,t,e)}reset(){this.children=[],this.left=null,this.right=null}addChild(t){if(this.children.length>=this.tree.getMaxChildren()&&this.depth<this.tree.getMaxDepth()&&this.$createSubNodes(),this.left===null&&this.right===null)this.children.push(t);else{const e=this.method.split([t]);this.left&&e.left.length>0&&this.left.addChild(e.left[0]),this.right&&e.right.length>0&&this.right.addChild(e.right[0])}}getChildren(){return this.children}getMethod(){return this.method}getLeft(){return this.left}getRight(){return this.right}getDepth(){return this.depth}setDepth(t){this.depth=t}$createSubNodes(){const t=this.method.split(this.children);this.left=new Je(this.tree,this.depth+1,t.leftMethod),this.right=new Je(this.tree,this.depth+1,t.rightMethod),t.left.forEach(this.left.addChild.bind(this.left)),t.right.forEach(this.right.addChild.bind(this.right)),this.left.parent=this,this.right.parent=this,this.children=[]}}class Mi extends pa{constructor(t,e,s=new j([0,0,0],[0,0,0])){super(t,e,new Qe(s,"x"))}}class Qe{box;axis;constructor(t,e){this.box=t,this.axis=e}draw(){dt.drawBoundingBox(c.MAT4_IDENTITY(),this.box.min,this.box.max)}search(t,e,s=[]){if(!this.box.intersectBoundingBox(e))return[];const i=t.getLeft(),r=t.getRight();if(i&&r)i.search(e,s),r.search(e,s);else{const n=t.getChildren();for(let a=0;a<n.length;a++)n[a].intersectBoundingBox(e)&&s.push(n[a])}return s}split(t){const e=[],s=[],i=this.box.getCenter();for(const l of t)this.axis==="x"?l.min[0]<=i[0]&&l.max[0]>=i[0]?(e.push(l),s.push(l)):l.max[0]<=i[0]?e.push(l):s.push(l):this.axis==="y"?l.min[1]<=i[1]&&l.max[1]>=i[1]?(e.push(l),s.push(l)):l.max[1]<=i[1]?e.push(l):s.push(l):l.min[2]<=i[2]&&l.max[2]>=i[2]?(e.push(l),s.push(l)):l.max[2]<=i[2]?e.push(l):s.push(l);let r=[],n="x";this.axis==="x"?(r=this.box.splitVertical(),n="y"):this.axis==="y"?(r=this.box.splitHorizontal(),n="z"):(r=this.box.splitDepth(),n="x");const a=new Qe(r[0],n),h=new Qe(r[1],n);return{left:e,right:s,leftMethod:a,rightMethod:h}}}class ma extends j{index;v1;v2;v3;n;t;constructor(t,e,s,i){super(),this.index=t,this.v1=e,this.v2=s,this.v3=i,this.n=c.VEC3_NORMALIZE(c.TRI3_NORMAL(this.v1,this.v2,this.v3)),this.t=c.VEC3_NORMALIZE(c.VEC3_CROSS([0,1,0],this.n)),super.fromVertices([...this.v1,...this.v2,...this.v3],3)}}class bs{boundingBox;frags;fragsData;btree;debugMeshEnabled;debugBspEnabled;debugVertices;debugVertexCount;constructor(){this.boundingBox=new j,this.frags=[],this.fragsData=[],this.btree=new Mi(20,3),this.debugBspEnabled=!0,this.debugMeshEnabled=!0,this.debugVertices=[],this.debugVertexCount=0}async loadFromFile(t,e=20,s=10){const r=await(await fetch(t)).json();if(!r.hasOwnProperty("Ident")||r.Ident!="JNM")throw new Error("GfxJNM::loadFromFile(): File not valid !");this.boundingBox=new j(r.Min,r.Max),this.btree=new Mi(e,s,this.boundingBox),this.frags=[];for(let n=0;n<r.Frags.length;n++){const a=r.Frags[n],h=new ma(n,a[0],a[1],a[2]);this.btree.addChild(h),this.frags.push(h)}this.fragsData=[];for(const n of r.FragsData){const a=n.FragIndex;this.fragsData[a]=n}}update(t){this.debugVertices=[],this.debugVertexCount=0;for(const e of this.frags)this.debugVertices.push(e.v1[0],e.v1[1],e.v1[2],1,1,1),this.debugVertices.push(e.v2[0],e.v2[1],e.v2[2],1,1,1),this.debugVertices.push(e.v1[0],e.v1[1],e.v1[2],1,1,1),this.debugVertices.push(e.v3[0],e.v3[1],e.v3[2],1,1,1),this.debugVertices.push(e.v2[0],e.v2[1],e.v2[2],1,1,1),this.debugVertices.push(e.v3[0],e.v3[1],e.v3[2],1,1,1),this.debugVertexCount+=6}draw(){this.debugBspEnabled&&this.btree.draw(),this.debugMeshEnabled&&dt.drawVertices(this.debugVertices,this.debugVertexCount,c.MAT4_IDENTITY())}box(t,e,s,i,r,n,a,h,l=.2,u=!0,d=1,p=.1){const E=[t-i,e-r*.5,s-i],T=[t+i,e+r*.5,s+i];E[1]+=l;const A=this.btree.search(new j([E[0]+n-p,E[1]+a,E[2]+h-p],[T[0]+n+p,T[1]+a,T[2]+h+p]));let x=n,y=a,C=h,S=[],w=!1,P=!1,O=0;const _=[[E[0],E[1]+l,T[2]],[E[0],E[1]+l,E[2]],[T[0],E[1]+l,E[2]],[T[0],E[1]+l,T[2]]];for(;O<_.length;){if(S[O]){O++;continue}const X=this.$moveXZ([t,e,s],A,_[O],[x,C]);if(X.move[0]==0&&X.move[1]==0){x=0,C=0,P=!0;break}else if(X.move[0]!=x||X.move[1]!=C){x=X.move[0],C=X.move[1],P=!0,S[O]=!0,O=0;continue}O++}E[1]-=l,d=d==0?Math.abs(a):d;const H=this.btree.search(new j([t+x,E[1]-d,s+C],[t+x,T[1]+l,s+C])),L=this.$getElevation(H,[t+x,T[1],s+C]),Z=L?E[1]-L.value:1/0;return u&&Z<d&&L&&(w=!0,y=L.value-E[1]),{move:[x,y,C],collideWall:P,collideFloor:w,fragIndex:L?L.fragIndex:-1}}raycast(t,e,s,i){const r=this.btree.search(new j([t[0]-s,t[1]-i*.5,t[2]-s],[t[0]+s,t[1]+i*.5,t[2]+s]));let n=null,a=1/0,h=[0,0,0];for(const l of r){const u=[0,0,0];if(c.RAY_TRIANGLE(t,e,l.v1,l.v2,l.v3,!0,u)){const d=c.VEC3_SUBSTRACT(u,t),p=c.VEC3_LENGTH(d);p<a&&(a=p,n=l,h=u)}}return n?{hit:h,distance:a,fragIndex:n.index}:null}getElevation(t,e,s,i,r,n,a){const h=this.btree.search(new j([t-i,e-r*.5,s-i],[t+i,e+r*.5,s+i])),l=this.$getElevation(h,[t+n,e+r,s+a]);return{yMove:l?l.value-e:0,fragIndex:l?l.fragIndex:-1}}enableDebugBsp(t){this.debugBspEnabled=t}enableDebugMesh(t){this.debugMeshEnabled=t}isDebugBspEnabled(){return this.debugBspEnabled}isDebugMeshEnabled(){return this.debugMeshEnabled}getBinaryTree(){return this.btree}getSectorData(t){return this.fragsData[t]}$moveXZ(t,e,s,i,r=0){let n=null,a=1/0;for(const h of e){const l=[0,0,0];c.RAY_PLAN(s,[i[0],0,i[1]],h.v1,h.n,!0,l);const u=[l[0]-h.t[0]*100,l[2]-h.t[2]*100],d=[l[0]+h.t[0]*100,l[2]+h.t[2]*100],p=[s[0],s[2]],E=[s[0]+i[0],s[2]+i[1]];if(c.COLLIDE_LINE_TO_LINE(u,d,p,E)){const T=c.VEC2_SUBSTRACT([l[0],l[2]],[s[0]+i[0],s[2]+i[1]]),A=c.VEC2_SUBSTRACT([l[0],l[2]],[t[0],t[2]]),x=c.VEC2_LENGTH(T);c.VEC2_DOT(T,A)<0&&x<a&&(a=x,n=h)}}if(n){const h=c.VEC2_PROJECTION_COS([i[0],i[1]],[n.t[0],n.t[2]]);return this.$moveXZ(t,e,s,h,r+1)}return{move:i}}$getElevation(t,e){let s=null,i=1/0,r=[0,0,0];for(const n of t){const a=[0,0,0];if(c.RAY_TRIANGLE(e,[0,-1,0],n.v1,n.v2,n.v3,!0,a)){const h=c.VEC3_SUBSTRACT(a,e),l=c.VEC3_LENGTH(h);l<i&&(i=l,s=n,r=a)}}return s!=null?{value:r[1],fragIndex:s.index}:null}}class fa{constructor(t,e){this.player=t,this.camera=e,this.handleClickedCb=this.handleClicked.bind(this),this.handlePointerLockChangeCb=this.handlePointerLockChange.bind(this),this.handleMouseMoveCb=this.handleMouseMove.bind(this),document.addEventListener("click",this.handleClickedCb),document.addEventListener("pointerlockchange",this.handlePointerLockChangeCb,!1)}delete(){document.removeEventListener("click",this.handleClickedCb),document.removeEventListener("pointerlockchange",this.handlePointerLockChangeCb,!1),document.removeEventListener("mousemove",this.handleMouseMoveCb)}update(t){const e=this.camera.getAxies();let s=!1;this.player.dir=[0,0,0],M.isActiveAction("LEFT")&&(this.player.dir[0]+=e[0][0]*-1,this.player.dir[2]+=e[0][2]*-1,s=!0),M.isActiveAction("RIGHT")&&(this.player.dir[0]+=e[0][0],this.player.dir[2]+=e[0][2],s=!0),M.isActiveAction("UP")&&(this.player.dir[0]+=e[2][0]*-1,this.player.dir[2]+=e[2][2]*-1,s=!0),M.isActiveAction("DOWN")&&(this.player.dir[0]+=e[2][0],this.player.dir[2]+=e[2][2],s=!0),s&&(this.player.dir=c.VEC3_NORMALIZE(this.player.dir))}async handleClicked(t){document.pointerLockElement||await document.body.requestPointerLock({unadjustedMovement:!0})}handlePointerLockChange(t){document.pointerLockElement==document.body?document.addEventListener("mousemove",this.handleMouseMoveCb,!1):document.removeEventListener("mousemove",this.handleMouseMoveCb,!1)}handleMouseMove(t){this.player.rotation[0]+=t.movementY*this.player.rotationSpeed/1e3,this.player.rotation[1]+=t.movementX*this.player.rotationSpeed/1e3}}class ga{constructor(t,e){this.player=t,this.jnm=e,this.lift=.3,this.radius=.5,this.frictionCoefficient=.99999999,this.gravityCoefficient=.8,this.gravityMax=10}update(t){const e=c.VEC3_SCALE(this.player.dir,this.player.movementSpeed);if(this.player.velocity[0]=c.LINEAR(Math.pow(1-this.frictionCoefficient,t/1e3),e[0],this.player.velocity[0]),this.player.velocity[2]=c.LINEAR(Math.pow(1-this.frictionCoefficient,t/1e3),e[2],this.player.velocity[2]),c.VEC3_LENGTH(this.player.velocity)>.1){const s=c.VEC3_SCALE(this.player.velocity,t/1e3),i=this.jnm.box(this.player.x,this.player.y,this.player.z,this.radius,this.player.height,s[0],s[1],s[2],this.lift,!0,.1);this.player.x+=i.move[0],this.player.y+=i.move[1],this.player.z+=i.move[2],i.collideFloor?this.player.velocity[1]=0:this.player.velocity[1]=c.LINEAR(Math.pow(1-this.gravityCoefficient,t/1e3),-this.gravityMax,this.player.velocity[1]),this.player.collideWall=i.collideWall}else this.player.velocity=[0,0,0]}}class Ea{constructor(t,e){this.player=t,this.camera=e,this.crosshair=document.createElement("img"),this.crosshair.src="samples/fps/crosshair.png",g.addNode(this.crosshair,"position:absolute; left:50%; top:50%; transform: translate(-50%,-50%);")}delete(){g.removeNode(this.crosshair)}update(t){this.camera.setPosition(this.player.x,this.player.y+this.player.height/2,this.player.z),this.camera.setRotation(this.player.rotation[0],this.player.rotation[1],this.player.rotation[2])}}class Ca{constructor(t,e){this.input=new fa(this,e),this.camera=new Ea(this,e),this.physics=new ga(this,t),this.x=0,this.y=1,this.z=0,this.height=1.3,this.dir=[0,0,0],this.velocity=[0,0,0],this.rotation=[0,0,0],this.movementSpeed=7,this.rotationSpeed=1,this.collideWall=!1}async load(){}update(t){this.input.update(t),this.physics.update(t),this.camera.update(t)}}class Ta extends U{constructor(){super(),this.map={},this.player=null,this.camera=new Jt(0)}async onEnter(){this.map=await this.createMap(),this.player=new Ca(this.map.jnm,this.camera)}update(t){this.map.mesh.update(t),this.player.update(t)}draw(){ht.drawDirLight([0,-1,0],[1,1,1],[1,1,1],[0,0,0]),this.map.mesh.draw()}async createMap(){const t=new G;await t.loadFromFile("./samples/fps/Level.jsm"),t.setMaterial(new $({lightning:!0,texture:await D.loadTexture("./samples/fps/map.png")}));const e=new bs;return await e.loadFromFile("./samples/fps/Level.jnm"),{mesh:t,jnm:e}}}class Aa{constructor(t){this.map=t,this.modifiers=[]}get(t){if(!this.map.hasOwnProperty(t))return;let e=this.map[t];for(let s of this.modifiers)s.getAttributeKey()==t&&s.getType()=="MUL"&&(e*=s.getValue());for(let s of this.modifiers)s.getAttributeKey()==t&&s.getType()=="ADD"&&(e+=s.getValue());for(let s of this.modifiers)s.getAttributeKey()==t&&s.getType()=="SUB"&&(e-=s.getValue());for(let s of this.modifiers)s.getAttributeKey()==t&&s.getType()=="SET"&&(e=s.getValue());for(let s of this.modifiers)s.getAttributeKey()==t&&s.getType()=="FIN"&&(e=s.getValue());return e<0&&(e=0),this.map.hasOwnProperty(t+"_MIN")&&(e=Math.max(e,this.map[t+"_MIN"])),this.map.hasOwnProperty(t+"_MAX")&&(e=Math.min(e,this.map[t+"_MAX"])),e}getBase(t){if(!!this.map.hasOwnProperty(t))return this.map[t]}set(t,e){!this.map.hasOwnProperty(t)||(e<0&&(e=0),this.map.hasOwnProperty(t+"_MIN")&&(e=Math.max(e,this.map[t+"_MIN"])),this.map.hasOwnProperty(t+"_MAX")&&(e=Math.min(e,this.map[t+"_MAX"])),this.map[t]=e)}add(t,e){this.set(t,this.getBase(t)+e)}has(t){return this.map.hasOwnProperty(t)}addModifier(t){this.modifiers.push(t)}removeModifier(t){this.modifiers.splice(this.modifiers.indexOf(t),1)}addModifiers(t){for(let e of t)this.modifiers.push(e)}removeModifiers(t){for(let e of t)this.modifiers.splice(this.modifiers.indexOf(e),1)}clearModifiers(){for(;this.modifiers.length;)this.modifiers.pop()}}let te={};te.IS_ALL=function(o,t,e){return!0};te.IS_SELF=function(o,t,e){return o==t};te.IS_ALLY=function(o,t,e){return o.constructor.name==t.constructor.name};te.IS_ALIVE_ALLY=function(o,t,e){return t.getAttribute("HP")>0&&o.constructor.name==t.constructor.name};te.IS_OPPONENT=function(o,t,e){return o.constructor.name!=t.constructor.name};te.IS_ALIVE_OPPONENT=function(o,t,e){return t.getAttribute("HP")>0&&o.constructor.name!=t.constructor.name};function Ia(o,t,e,s={}){return o==""?!0:te[o](t,e,s)}class Mr{constructor(t){this.type="",this.attributeKey="",this.value=0,!!t.hasOwnProperty("Type")&&(t.Type=="MUL"||t.Type=="ADD"||t.Type=="SUB"||t.Type=="SET"||t.Type=="FIN")&&(!t.hasOwnProperty("AttributeKey")||!t.hasOwnProperty("Value")||(this.type=t.Type,this.attributeKey=t.AttributeKey,this.value=t.Value))}getType(){return this.type}getAttributeKey(){return this.attributeKey}getValue(){return this.value}}class ya{constructor(){this.id="",this.name="",this.description="",this.iconFile="",this.stackable=!1,this.numTurns=0,this.onTurnEffect=null,this.modifiers=[],this.turnCount=0,this.fromChar=null}async loadFromData(t){this.id=t.Id,this.name=t.Name,this.description=t.Description,this.iconFile=t.IconFile,this.stackable=t.Stackable,this.numTurns=t.NumTurns,t.OnTurnEffect&&(this.onTurnEffect=new Le,this.onTurnEffect.loadFromData(t.OnTurnEffect));for(let e of t.Modifiers)this.modifiers.push(new Mr(e))}async loadFromFile(t){let e=await fetch(t);await this.loadFromData(await e.json())}getId(){return this.id}getName(){return this.name}getDescription(){return this.description}getIconFile(){return this.iconFile}getStackable(){return this.stackable}getNumTurns(){return this.numTurns}getOnTurnEffect(){return this.onTurnEffect}getModifiers(){return this.modifiers}getTurnCount(){return this.turnCount}incTurnCount(){this.turnCount++}getFromChar(){return this.fromChar}}let ee={};ee.RESTORE=async function(o,t,e={amount,element}){await t.increaseHP(e.amount,e.element)};ee.DAMAGE=async function(o,t,e={amount,element}){await t.decreaseHP(e.amount,e.element)};ee.INCREASE_MANA=async function(o,t,e={amount}){await t.increaseHP(e.amount)};ee.DECREASE_MANA=async function(o,t,e={amount}){await t.decreaseHP(e.amount)};ee.ADD_SEAL=async function(o,t,e={sealId}){let s=ya.createFromFile("samples/rpg/data/"+e.sealId+"/data.json");s.fromChar=o,await t.addSeal(s)};ee.REMOVE_SEAL=async function(o,t,e={sealId}){for(let s of t.getActiveSeals())s.getId()==sealId&&await t.removeSeal(s)};function va(o,t,e,s={}){return o==""?!0:ee[o](t,e,s)}let We={ALL:"ALL",MENU:"MENU",BATTLE:"BATTLE"},St={POTION:"POTION",FOOD:"FOOD",WEAPON:"WEAPON",HELMET:"HELMET",ARMOR:"ARMOR",RELIC:"RELIC",OTHER:"OTHER"},Vt={RED:"RED",BLUE:"BLUE",BLACK:"BLACK",WHITE:"WHITE"};class Le{constructor(){this.id="",this.name="",this.description="",this.cost=0,this.spriteAnimationName="",this.availabilityType="",this.mechanicId="",this.mechanicOpts={},this.targetCharConditionId="",this.targetCharConditionOpts={}}async loadFromData(t){this.id=t.Id,this.name=t.Name,this.description=t.Description,this.cost=t.Cost,this.spriteAnimationName=t.SpriteAnimationName,this.availabilityType=t.AvailabilityType,this.mechanicId=t.MechanicId,this.mechanicOpts=t.MechanicOpts,this.targetCharConditionId=t.TargetCharConditionId,this.targetCharConditionOpts=t.TargetCharConditionOpts}async loadFromFile(t){let e=await fetch(t);await this.loadFromData(await e.json())}isMenuAvailable(){return this.availabilityType==We.ALL||this.availabilityType==We.MENU}isBattleAvailable(){return this.availabilityType==We.ALL||this.availabilityType==We.BATTLE}isUsable(t){return this.cost<=t.getAttribute("MP")}isTargetCharConditionCheck(t,e){return Ia(this.targetCharConditionId,t,e,this.targetCharConditionOpts)}async apply(t,e){await m.emit(e,"E_EFFECT_INFLICT",{effect:this}),await va(this.mechanicId,t,e,this.mechanicOpts)}getId(){return this.id}getName(){return this.name}getDescription(){return this.description}getCost(){return this.cost}getSpriteAnimationName(){return this.spriteAnimationName}getAvailabilityType(){return this.availabilityType}getMechanicId(){return this.mechanicId}getMechanicOpts(){return this.mechanicOpts}getTargetCharConditionId(){return this.targetCharConditionId}getTargetCharConditionOpts(){return this.targetCharConditionOpts}}class br{constructor(){this.id="",this.type="",this.name="",this.description="",this.pictureFile="",this.jasFile="",this.jasImageFile="",this.attributes,this.attackEffects=[],this.magicEffects=[],this.activeSeals=[],this.ready=!1}async loadFromData(t){this.id=t.Id,this.type=t.Type,this.name=t.Name,this.description=t.Description,this.pictureFile=t.PictureFile,this.jamFile=t.JAMFile,this.jamTextureFile=t.JAMTextureFile,this.attributes=new Aa(t.Attributes);for(let e of t.AttackEffectIds){let s=new Le;await s.loadFromFile("samples/rpg/data/effect_"+e+"/data.json"),this.attackEffects.push(s)}for(let e of t.MagicEffectIds){let s=new Le;await s.loadFromFile("samples/rpg/data/effect_"+e+"/data.json"),this.magicEffects.push(s)}}async addSeal(t){if(!t.stackable&&this.activeSeals.find(e=>e.id==t.id))return m.emit(this,"E_SEAL_ADD_FAILED");this.attributes.addModifiers(t.modifiers),this.activeSeals.push(t),await m.emit(this,"E_SEAL_ADDED")}async removeSeal(t){if(!this.activeSeals.find(e=>e==t))return m.emit(this,"E_SEAL_REMOVE_FAILED");this.attributes.removeModifiers(t.modifiers),this.activeSeals.splice(this.activeSeals.indexOf(t),1),await m.emit(this,"E_SEAL_REMOVED")}async increaseHP(t,e=null){let s=bi(e,this.attributes.get("ELEMENT"));t=e?t*s:t,this.attributes.add("HP",+t),await m.emit(this,"E_INCREASE_HP",{amount:t})}async decreaseHP(t,e=null){let s=bi(e,this.attributes.get("ELEMENT"));t=e?t*s:t,this.attributes.add("HP",-t),await m.emit(this,"E_DECREASE_HP",{amount:t})}async increaseMP(t){this.attributes.add("MP",+t),await m.emit(this,"E_INCREASE_MP",{amount:t})}async decreaseMP(t){this.attributes.add("MP",-t),await m.emit(this,"E_DECREASE_MP",{amount:t})}getId(){return this.id}getType(){return this.type}getName(){return this.name}getDescription(){return this.description}getPictureFile(){return this.pictureFile}getJAMFile(){return this.jamFile}getJAMTextureFile(){return this.jamTextureFile}getAttributes(){return this.attributes}getAttribute(t){return this.attributes.get(t)}getAttackEffects(){return this.attackEffects}getMagicEffects(){return this.magicEffects}getActiveSeals(){return this.activeSeals}setReady(t){this.ready=t}isReady(){return this.ready}}function bi(o,t){return o==Vt.RED&&t==Vt.BLUE||o==Vt.BLUE&&t==Vt.RED||o==Vt.BLACK&&t==Vt.WHITE||o==Vt.WHITE&&t==Vt.BLACK?2:1}class xa{constructor(){this.level=1,this.attributeMap={}}}class Sa{constructor(){this.id="",this.name="",this.promotions=[]}async loadFromData(t){t.hasOwnProperty("Effect")&&(this.effect=new Effect,await this.effect.loadFromData(t.Effect)),this.id=t.Id,this.name=t.Name,this.promotions=[];for(let e of t.Promotions){let s=new xa;s.level=e.Level,s.attributeMap=e.AttributeMap,this.promotions.push(s)}}async loadFromFile(t){let e=await fetch(t);await this.loadFromData(await e.json())}applyPromotion(t,e){let s=this.promotions.find(r=>r.level==e);if(!s)throw new Error("Cast::applyPromotion(): Level not exist !");let i=t.getAttributes();for(let r in s.attributeMap)i.add(r,s.attributeMap[r])}}class Pr{constructor(){this.id="",this.type="",this.name="",this.description="",this.pictureFile="",this.soldable=!0,this.price=0,this.quantity=1}async loadFromData(t){this.id=t.Id,this.type=t.Type,this.name=t.Name,this.description=t.Description,this.pictureFile=t.PictureFile,this.soldable=t.Soldable,this.price=t.Price}getId(){return this.id}getType(){return this.type}getName(){return this.name}getDescription(){return this.description}getPictureFile(){return this.pictureFile}getSoldable(){return this.soldable}getPrice(){return this.price}getQuantity(){return this.quantity}setQuantity(t){this.quantity=t}}class pt extends Pr{constructor(){super(),this.subType="",this.modifiers=[]}async loadFromData(t){this.subType=t.SubType;for(let e of t.Modifiers)this.modifiers.push(new Mr(e));super.loadFromData(t)}async loadFromFile(t){let e=await fetch(t);await this.loadFromData(await e.json())}getSubType(){return this.subType}getModifiers(){return this.modifiers}}class Ps extends br{constructor(){super(),this.weapon=null,this.helmet=null,this.armor=null,this.relic=null,this.allowedEquipmentItemSubTypes=[],this.cast=new Sa}async loadFromData(t){if(t.WeaponId){let e=new pt;await e.loadFromFile("samples/rpg/data/"+t.WeaponId+"/data.json"),this.setEquipment(e)}if(t.HelmetId){let e=new pt;await e.loadFromFile("samples/rpg/data/"+t.HelmetId+"/data.json"),this.setEquipment(e)}if(t.ArmorId){let e=new pt;await e.loadFromFile("samples/rpg/data/"+t.ArmorId+"/data.json"),this.setEquipment(e)}if(t.RelicId){let e=new pt;await e.loadFromFile("samples/rpg/data/"+t.RelicId+"/data.json"),this.setEquipment(e)}for(let e of t.AllowedEquipmentItemSubTypes)this.allowedEquipmentItemSubTypes.push(e);this.cast.loadFromFile("samples/rpg/data/cast_"+t.CastId+"/data.json"),super.loadFromData(t)}async loadFromFile(t){let e=await fetch(t);await this.loadFromData(await e.json())}getWeapon(){return this.weapon}getHelmet(){return this.helmet}getArmor(){return this.armor}getRelic(){return this.relic}getAllowedEquipmentItemSubTypes(){return this.allowedEquipmentItemSubTypes}getCast(){return this.cast}isEquipableItem(t){return t instanceof pt&&this.allowedEquipmentItemSubTypes.includes(t.getSubType())}getAttributesWith(t){let e={},s=this.setEquipment(t);for(let i in this.attributes.map)e[i]=this.attributes.get(i);return s?this.setEquipment(s):this.removeEquipment(t),e}setEquipment(t){let e=null;return t.type==St.WEAPON?(e=this.weapon,this.weapon=t):t.type==St.HELMET?(e=this.helmet,this.helmet=t):t.type==St.ARMOR?(e=this.armor,this.armor=t):t.type==St.RELIC&&(e=this.relic,this.relic=t),e&&this.attributes.removeModifiers(e.getModifiers()),this.attributes.addModifiers(t.getModifiers()),e}removeEquipment(t){return t==this.weapon?(this.attributes.removeModifiers(this.weapon.getModifiers()),this.weapon=null,!0):t==this.helmet?(this.attributes.removeModifiers(this.helmet.getModifiers()),this.helmet=null,!0):t==this.armor?(this.attributes.removeModifiers(this.armor.getModifiers()),this.armor=null,!0):t==this.relic?(this.attributes.removeModifiers(this.relic.getModifiers()),this.relic=null,!0):!1}}class _t{items;constructor(t=[]){this.items=t}getItems(){return this.items}push(t,e=!1){const s=this.items.push(t);return e&&m.emit(this,"E_ITEM_ADDED",{item:t,index:this.items.indexOf(t)}),s}pop(t=!1){const e=this.items.pop();return t&&m.emit(this,"E_ITEM_REMOVED",{item:e,index:this.items.length}),e}remove(t,e=!1){const s=this.items.indexOf(t);return this.items.splice(s,1),e&&m.emit(this,"E_ITEM_REMOVED",{item:t,index:s}),s}removeAt(t,e=!1){const s=this.items.splice(t,1);return e&&m.emit(this,"E_ITEM_REMOVED",{item:s,index:t}),s}has(t){return this.items.indexOf(t)!=-1}clear(){for(;this.items.length;)this.items.pop()}}class Ot extends Pr{constructor(){super(),this.effect=null}async loadFromData(t){t.hasOwnProperty("Effect")&&(this.effect=new Le,await this.effect.loadFromData(t.Effect)),super.loadFromData(t)}async loadFromFile(t){let e=await fetch(t);await this.loadFromData(await e.json())}apply(t,e){this.effect.apply(t,e)}isMenuAvailable(){return this.effect&&this.effect.isMenuAvailable()}isTarget(t,e){return this.effect&&this.effect.isTargetCharConditionCheck(t,e)}hasEffect(){return!!this.effect}getEffect(){return this.effect}}const wa=99;class _r extends _t{constructor(){super()}async loadFromData(t){for(let e of t)if(e.ItemTypeName=="CommonItem"){let s=new Ot;await s.loadFromFile("samples/rpg/data/"+e.ItemId+"/data.json"),s.setQuantity(e.Quantity),this.items.push(s)}else if(e.ItemTypeName=="EquipmentItem"){let s=new pt;await s.loadFromFile("samples/rpg/data/"+e.ItemId+"/data.json"),s.setQuantity(e.Quantity),this.items.push(s)}}async loadFromFile(t){let e=await fetch(t);await this.loadFromData(await e.json())}getItemById(t){return this.items.find(e=>e.getId()==t)}findItemById(t){return this.items.findIndex(e=>e.getId()==t)}addItem(t){let e=this.items.findIndex(s=>s.getId()==t.getId());if(e!=-1){let s=this.items[e];if(s.getQuantity()+t.getQuantity()>wa)return;s.setQuantity(s.getQuantity()+t.getQuantity())}else this.items.push(t),m.emit(this,"E_ITEM_ADDED",{item:t,index:this.items.indexOf(t)})}removeItemById(t,e=1){let s=this.items.findIndex(n=>n.getId()==t);if(s==-1)return;let i=this.items[s],r=i.getQuantity()-e;if(r==0)this.items.splice(this.items.indexOf(i),1),m.emit(this,"E_ITEM_REMOVED",{item:i,index:s});else if(r>0)i.setQuantity(r);else return;return r}hasMenuAvailableItems(){return this.items.filter(e=>e instanceof Ot&&e.isMenuAvailable()).length>0}hasCommonItems(){return this.items.filter(e=>e instanceof Ot).length>0}hasEquipmentItems(){return this.items.filter(e=>e instanceof pt).length>0}isEmpty(){return this.items.length==0}}class Ma{constructor(){this.gils=0,this.inventory=null,this.heroes=[],this.variants={}}async loadFromData(t){this.gils=t.Gils,this.inventory=new _r,this.inventory.loadFromData(t.Inventory);for(let e of t.Heroes){let s=new Ps;s.loadFromData(e),this.heroes.push(s)}for(let e in t.Variants)this.addVariant(e,t.Variants[e])}async loadFromFile(t){let e=await fetch(t);await this.loadFromData(await e.json())}increaseGils(t){this.gils+=t,m.emit(this,"E_GILS_CHANGED",{gils:this.gils})}decreaseGils(t){if(this.gils-t<0)throw new Error("Player::decreaseGils(): gils cannot be negative !");this.gils-=t,m.emit(this,"E_GILS_CHANGED",{gils:this.gils})}addVariant(t,e){if(this.variants.hasOwnProperty(t))throw new Error("Player::addVariant: varloc already exist in variants dictionnary");this.variants[t]=e}removeVariant(t){if(!this.variants.hasOwnProperty(t))throw new Error("Player::removeVariant: varloc not exist in variants dictionnary");delete this.variants[t]}setVariant(t,e){if(!this.variants.hasOwnProperty(t))throw new Error("Player::setVariant: varloc not exist in variants dictionnary");this.variants[t]=e}hasVariant(t){return this.variants.hasOwnProperty(t)}getVariant(t){if(!this.variants.hasOwnProperty(t))throw new Error("Player::getVariant: varloc not exist in variants dictionnary");return this.variants[t]}getGils(){return this.gils}getInventory(){return this.inventory}getHeroes(){return this.heroes}}class ba{constructor(){this.then=0,this.player=new Ma}async init(){await this.player.loadFromFile("samples/rpg/data/player.json")}getPlayer(){return this.player}}const se=new ba;let qs={};qs.SELF_HAS_LOWER_HP=function(o,t,e){return t.getAttribute("HP")/t.getAttribute("HP_MAX")*100<e.number};qs.ALLY_HAS_LOWER_HP=function(o,t,e){for(let s of o.getEnemies()){let i=s.getAttribute("HP")/s.getAttribute("HP_MAX")*100;if(s!=t&&i!=0&&i<e.number)return!0}return!1};function Pa(o,t,e,s={}){return o==""?!0:qs[o](t,e,s)}let Ys={};Ys.LOWEST_HP=function(o,t){return o.getAttribute("HP")-t.getAttribute("HP")};Ys.HIGHEST_HP=function(o,t){return t.getAttribute("HP")-o.getAttribute("HP")};function _a(o,t){return o==""?t.sort((e,s)=>e.getId()-s.getId()):t.sort((e,s)=>Ys[o](e,s))}class Pi extends br{constructor(){super(),this.gils=0,this.patterns=[],this.position=[0,0,0]}async loadFromData(t){this.gils=t.Gils;for(let e of t.Patterns){let s=new Da;await s.loadFromData(e),this.patterns.push(s)}await super.loadFromData(t)}async loadFromFile(t){let e=await fetch(t);await this.loadFromData(await e.json())}getGils(){return this.gils}getPatterns(){return this.patterns}getPosition(){return this.position}setPosition(t){this.position=t}}class Da{constructor(){this.name="",this.effect=null,this.priority=0,this.conditionId="",this.conditionOpts={},this.targetCharSortId=""}async loadFromData(t){this.name=t.Name,this.effect=new Le,await this.effect.loadFromFile("samples/rpg/data/effect_"+t.EffectId+"/data.json"),this.priority=t.Priority,this.conditionId=t.ConditionId,this.conditionOpts=t.ConditionOpts,this.targetCharSortId=t.TargetCharSortId}isConditionCheck(t,e){return Pa(this.conditionId,t,e,this.conditionOpts)}targetCharSort(t){return _a(this.targetCharSortId,t)}}class cs{constructor(t){this.battle=t}async exec(){}}class qe extends cs{constructor(t,e){super(t),this.fromChar=e}async exec(){await this.battle.operationLet(this.fromChar)}}class Dr extends cs{constructor(t,e,s,i){super(t),this.effect=e,this.fromChar=s,this.toChar=i}async exec(){await this.battle.operationApplyEffect(this.effect,this.fromChar,this.toChar)}}class Ra extends cs{constructor(t,e,s,i){super(t),this.item=e,this.fromChar=s,this.toChar=i}async exec(){await this.battle.operationApplyItem(this.item,this.fromChar,this.toChar)}}class ts extends cs{constructor(t){super(t)}async exec(){await this.battle.operationNewTurn()}}let Oa={NORMAL:"N",A_FIRST:"A",E_FIRST:"E",E_TRAP:"T"};class La{constructor(){this.backgroundImage="",this.jsmFile="",this.jsmTextureFile="",this.cameraPosition=[0,0,0],this.cameraLookAt=[0,0,0],this.enemies=[],this.player=se.getPlayer(),this.heroes=this.player.getHeroes(),this.formationType=Oa.NORMAL,this.numTurns=0,this.characterQueue=[]}async loadFromData(t){this.backgroundImage=t.BackgroundImage,this.jsmFile=t.JSMFile,this.jsmTextureFile=t.JSMTextureFile,this.cameraPosition=t.CameraPosition,this.cameraLookAt=t.CameraLookAt;for(let e of t.Enemies){let s=new Pi;await s.loadFromFile("samples/rpg/data/enemy_"+e.EnemyId+"/data.json"),s.setPosition(e.Position),this.enemies.push(s)}}async loadFromFile(t){let e=await fetch(t);await this.loadFromData(await e.json())}startup(){this.runAction(new ts(this))}async runAction(t){await m.emit(this,"E_ACTION_BEFORE",{action:t}),await t.exec(),await m.emit(this,"E_ACTION_AFTER",{action:t});for(let r of this.characterQueue)r.getAttribute("HP")==0&&this.characterQueue.splice(this.characterQueue.indexOf(r),1);if(this.heroes.reduce((r,n)=>r+n.getAttribute("HP"),0)==0)return m.emit(this,"E_LOST");if(this.enemies.reduce((r,n)=>r+n.getAttribute("HP"),0)==0)return m.emit(this,"E_WIN");if(this.characterQueue.length==0)return this.runAction(new ts(this));let i=this.characterQueue.filter(r=>r.isReady());if(i.length==0){let r=0;for(;r<this.characterQueue.length&&this.characterQueue[0].getType()==this.characterQueue[r].getType();)i.push(this.characterQueue[r]),this.characterQueue[r].setReady(!0),r++}await m.emit(this,"E_CHAR_READY",{char:i[0]}),i[0]instanceof Pi&&this.handleAI()}async operationNewTurn(){let t=[...this.heroes,...this.enemies];t=t.sort((e,s)=>s.getAttribute("AGILITY")-e.getAttribute("AGILITY")),t=t.filter(e=>e.getAttribute("HP")>0);for(let e of t){for(let s of e.getActiveSeals())s.incTurnCount(),s.getOnTurnEffect()&&await s.getOnTurnEffect().apply(s.getFromChar(),e),s.getTurnCount()==s.getNumTurns()&&e.removeSeal(s);e.setReady(!1)}this.numTurns++,this.characterQueue=t,m.emit(this,"E_NEW_TURN")}async operationLet(t){t.setReady(!1),this.characterQueue.splice(this.characterQueue.indexOf(t),1)}async operationApplyEffect(t,e,s){await t.apply(e,s),e.getAttributes().add("MP",-t.getCost()),e.setReady(!1),this.characterQueue.splice(this.characterQueue.indexOf(e),1)}async operationApplyItem(t,e,s){let i=this.player.getInventory();await t.getEffect().apply(e,s),i.removeItemById(t.getId()),e.setReady(!1),this.characterQueue.splice(this.characterQueue.indexOf(e),1)}handleAI(){let t=this.characterQueue[0],e=[...this.heroes,...this.enemies],i=t.patterns.sort((a,h)=>a.priority-h.priority).filter(a=>a.isConditionCheck(this,t)),r=null,n=null;i.length==0&&(i=t.patterns);for(let a of i){let h=e.filter(l=>a.effect.isTargetCharConditionCheck(t,l));if(h.length>0){r=a.effect,n=a.targetCharSort(h)[0];break}}r&&n?this.runAction(new Dr(this,r,t,n)):this.runAction(new qe(this,t))}getBackgroundImage(){return this.backgroundImage}getJSMFile(){return this.jsmFile}getJSMTextureFile(){return this.jsmTextureFile}getCameraPosition(){return this.cameraPosition}getCameraLookAt(){return this.cameraLookAt}getEnemies(){return this.enemies}getHeroes(){return this.heroes}getFormationType(){return this.formationType}getNumTurns(){return this.numTurns}getCharacterQueue(){return this.characterQueue}}class Ne extends Ce{collection;views;sortPredicate;filterPredicate;enablePredicate;constructor(t={}){super(t),this.collection=new _t,this.views=[],this.sortPredicate=()=>1,this.filterPredicate=()=>!0,this.enablePredicate=()=>!0}delete(){m.unsubscribe(this.collection,"E_ITEM_ADDED",this),m.unsubscribe(this.collection,"E_ITEM_REMOVED",this),super.delete()}setCollection(t){if(m.unsubscribe(this.collection,"E_ITEM_ADDED",this),m.unsubscribe(this.collection,"E_ITEM_REMOVED",this),this.clear(),t){const s=t.getItems().sort(this.sortPredicate).filter(this.filterPredicate);s.forEach(i=>this.addItem(i,this.enablePredicate(i))),m.subscribe(t,"E_ITEM_ADDED",this,this.$handleItemAdded),m.subscribe(t,"E_ITEM_REMOVED",this,this.$handleItemRemoved),this.collection=t,this.views=s}else this.collection=new _t,this.views=[]}addItem(t,e=!0,s=-1){}getFocusedItem(){return this.views[this.getFocusedWidgetIndex()]}getSelectedItem(){return this.views[this.getSelectedWidgetIndex()]}setSortPredicate(t){if(this.collection){const e=this.collection.getItems();this.views=e.sort(t).filter(this.filterPredicate),this.clear(),this.views.forEach(s=>this.addItem(s,this.enablePredicate(s)))}this.sortPredicate=t}setFilterPredicate(t){if(this.collection){const e=this.collection.getItems();this.views=e.sort(this.sortPredicate).filter(t),this.clear(),this.views.forEach(s=>this.addItem(s,this.enablePredicate(s)))}this.filterPredicate=t}setEnablePredicate(t){if(this.collection){const e=this.collection.getItems();this.views=e.sort(this.sortPredicate).filter(this.filterPredicate),this.clear(),this.views.forEach(s=>this.addItem(s,t(s)))}this.enablePredicate=t}getViews(){return this.views}$handleItemAdded(t){const e=this.collection.getItems();this.views=e.sort(this.sortPredicate).filter(this.filterPredicate);const s=this.views.indexOf(t.item);this.addItem(t.item,this.enablePredicate(t.item),s)}$handleItemRemoved(t){const e=this.views.indexOf(t.item);this.removeWidget(e);const s=this.collection.getItems();this.views=s.sort(this.sortPredicate).filter(this.filterPredicate)}}class us extends Ne{constructor(t={}){super(),this.showPrice=t.showPrice??!0,this.showQuantity=t.showQuantity??!0}addItem(t,e=!0,s=-1){let i=new Na;i.setShowPrice(this.showPrice),i.setShowQuantity(this.showQuantity),i.setItem(t),this.addWidget(i,e,s)}}class Na extends W{constructor(){super({className:"UIInventoryItem",template:`
      <span class="UIInventoryItem-name js-name"></span>
      <span class="UIInventoryItem-quantity js-quantity"></span>
      <span class="UIInventoryItem-price js-price"></span>`}),this.item=null,this.showPrice=!0,this.showQuantity=!0}update(t){this.item?(this.node.querySelector(".js-name").textContent=this.item.getName(),this.node.querySelector(".js-price").style.display=this.showPrice?"block":"none",this.node.querySelector(".js-price").textContent=this.item.price,this.node.querySelector(".js-quantity").style.display=this.showQuantity?"block":"none",this.node.querySelector(".js-quantity").textContent=this.item.quantity):(this.node.querySelector(".js-name").textContent="--",this.node.querySelector(".js-price").textContent="--",this.node.querySelector(".js-quantity").textContent="--")}getItem(){return this.item}setItem(t){this.item=t||null}setShowPrice(t){this.showPrice=t}setShowQuantity(t){this.showQuantity=t}}class Fa extends Ne{constructor(){super()}addItem(t,e=!0,s=-1){let i=new Ba;i.setEffect(t),this.addWidget(i,e,s)}}class Ba extends W{constructor(){super({className:"UIEffectsItem",template:`
      <span class="UIEffectsItem-name js-name"></span>`}),this.effect=null}update(t){this.effect?this.node.querySelector(".js-name").textContent=this.effect.getName():this.node.querySelector(".js-name").textContent="--"}getEffect(){return this.effect}setEffect(t){this.effect=t||null}}class Va extends Ne{constructor(){super({axis:ve.X})}addItem(t,e=!0,s=-1){let i=new Ua;i.setHero(t),this.addWidget(i,e,s)}}class Ua extends W{constructor(){super({className:"UIBattleHeroesItem",template:`
      <div class="UIBattleHeroesItem-body">
        <div class="UIBattleHeroesItem-body-name js-name"></div>
        <div class="UIBattleHeroesItem-body-stats">
          <div class="UIBattleHeroesItem-body-stats-item">
            <span class="UIBattleHeroesItem-body-stats-item-name">HP</span>
            <span class="UIBattleHeroesItem-body-stats-item-bar">
              <span class="UIBattleHeroesItem-body-stats-item-bar-value js-hp-value"></span>
              <span class="UIBattleHeroesItem-body-stats-item-bar-progress js-hp-bar"></span>
            </span>
          </div>
          <div class="UIBattleHeroesItem-body-stats-item">
            <span class="UIBattleHeroesItem-body-stats-item-name">MP</span>
            <span class="UIBattleHeroesItem-body-stats-item-bar">
              <span class="UIBattleHeroesItem-body-stats-item-bar-value js-mp-value"></span>
              <span class="UIBattleHeroesItem-body-stats-item-bar-progress js-mp-bar"></span>
            </span>
          </div>
        </div>
      </div>`}),this.hero=null}update(t){this.hero?(this.setEnabled(this.hero.isReady()),this.node.querySelector(".js-name").textContent=this.hero.getName(),this.node.querySelector(".js-hp-value").textContent=this.hero.getAttribute("HP")+"/"+this.hero.getAttribute("HP_MAX"),this.node.querySelector(".js-hp-bar").style.width=parseInt(this.hero.getAttribute("HP")/this.hero.getAttribute("HP_MAX")*100)+"%",this.node.querySelector(".js-mp-value").textContent=this.hero.getAttribute("MP")+"/"+this.hero.getAttribute("MP_MAX"),this.node.querySelector(".js-mp-bar").style.width=parseInt(this.hero.getAttribute("MP")/this.hero.getAttribute("MP_MAX")*100)+"%"):(this.disable(),this.node.querySelector(".js-name").textContent="--",this.node.querySelector(".js-hp-value").textContent="--/--",this.node.querySelector(".js-hp-bar").style.width="0%",this.node.querySelector(".js-mp-value").textContent="--/--",this.node.querySelector(".js-mp-bar").style.width="0%")}getHero(){return this.hero}setHero(t){this.hero=t||null}}class Ha extends W{constructor(){super({className:"UIBattleStatus",template:`
      <div class="UIBattleStatus-numTurns">
        <div class="UIBattleStatus-numTurns-label">Turn: </div>
        <div class="UIBattleStatus-numTurns-value js-num-turns-value"></div>
      </div>
      <div class="UIBattleStatus-pictures js-pictures"></div>`}),this.battle=null}update(t){if(this.battle){this.node.querySelector(".js-num-turns-value").textContent=this.battle.getNumTurns(),this.node.querySelector(".js-pictures").innerHTML="";for(let e of this.battle.getCharacterQueue())this.node.querySelector(".js-pictures").innerHTML+=`<img class="UIBattleStatus-pictures-item" src="${e.getPictureFile()}"></img>`}else this.node.querySelector(".js-num-turns-value").textContent="0",this.node.querySelector(".js-pictures").innerHTML=""}setBattle(t){this.battle=t||null}}class _i extends Ft{constructor(){super(),this.character=null,this.effectSprite=new Re,this.effectVisible=!1,this.mesh=new Te}delete(){this.effectSprite.delete(),this.mesh.delete()}update(t){const s=this.mesh.getBoundingBox().getSize();this.effectSprite.setPosition(this.position[0],this.position[1]+s[1]*.5,this.position[2]),this.effectSprite.update(t),this.mesh.setPosition(this.position[0],this.position[1],this.position[2]),this.mesh.setRotation(this.rotation[0],this.rotation[1],this.rotation[2]),this.mesh.update(t)}draw(){this.effectVisible&&this.effectSprite.draw(),this.mesh.draw()}async loadFromCharacter(t){m.unsubscribe(this.character,"E_EFFECT_INFLICT",this),m.unsubscribe(this.character,"E_INCREASE_HP",this),m.unsubscribe(this.character,"E_DECREASE_HP",this),m.unsubscribe(this.character,"E_INCREASE_MP",this),m.unsubscribe(this.character,"E_DECREASE_MP",this),m.unsubscribe(this.character,"E_SEAL_ADD_FAILED",this),m.unsubscribe(this.character,"E_SEAL_ADDED",this),m.unsubscribe(this.character,"E_SEAL_REMOVE_FAILED",this),m.unsubscribe(this.character,"E_SEAL_REMOVED",this),t?(m.subscribe(t,"E_EFFECT_INFLICT",this,this.handleEffectInflict),m.subscribe(t,"E_INCREASE_HP",this,this.handleCharacterIncreaseHP),m.subscribe(t,"E_DECREASE_HP",this,this.handleCharacterDecreaseHP),m.subscribe(t,"E_INCREASE_MP",this,this.handleCharacterIncreaseMP),m.subscribe(t,"E_DECREASE_MP",this,this.handleCharacterDecreaseMP),m.subscribe(t,"E_SEAL_ADD_FAILED",this,this.handleCharacterSealAddFailed),m.subscribe(t,"E_SEAL_ADDED",this,this.handleCharacterSealAdded),m.subscribe(t,"E_SEAL_REMOVE_FAILED",this,this.handleCharacterSealRemoveFailed),m.subscribe(t,"E_SEAL_REMOVED",this,this.handleCharacterSealRemoved),this.effectSprite=new Re,this.effectSprite.loadFromFile("samples/rpg/sprites/effects.jas"),this.effectSprite.setTexture(await D.loadTexture("samples/rpg/sprites/effects.png")),this.mesh=new Te,await this.mesh.loadFromFile(t.getJAMFile()),this.mesh.setMaterial(new $({texture:await D.loadTexture(t.getJAMTextureFile())})),this.mesh.play("IDLE",!0,!0),this.character=t):this.character=null}getCharacter(){return this.character}getSize(){return this.mesh.getBoundingBox().getSize()}async handleEffectInflict(t){this.effectVisible=!0,this.effectSprite.play(t.effect.getSpriteAnimationName()),this.effectSprite.setOffsetNormalized(.5,.5),await m.wait(this.effectSprite,"E_FINISHED"),this.effectVisible=!1}async handleCharacterIncreaseHP(t){await this.DRAW_TOAST(t.amount,"#5ef500",300)}async handleCharacterDecreaseHP(t){await this.DRAW_TOAST(t.amount,"#f50000",1e3)}async handleCharacterIncreaseMP(t){await this.DRAW_TOAST("MP + "+t.amount,"#fff",300)}async handleCharacterDecreaseMP(t){await this.DRAW_TOAST("MP - "+t.amount,"#fff",300)}async handleCharacterSealAddFailed(t){await this.DRAW_TOAST("Seal add failed !","#fff",300)}async handleCharacterSealAdded(t){await this.DRAW_TOAST("Seal added !","#fff",300)}async handleCharacterSealRemoveFailed(t){await this.DRAW_TOAST("Seal remove failed !","#fff",300)}async handleCharacterSealRemoved(t){await this.DRAW_TOAST("Seal removed !","#fff",300)}DRAW_TOAST(t,e,s){return new Promise(i=>{const r=document.createElement("div");r.className="BattleAreaFighter-toast",r.textContent=t,r.style.color=e;const n=this.mesh.getPosition(),h=v.getCurrentView().getClientScreenPosition(n[0],n[1]+.8,n[2]);r.style.top=h[1]+"px",r.style.left=h[0]+"px",g.addNode(r),setTimeout(()=>{r.remove(),i()},s)})}}class Wa extends Jt{constructor(){super(0),this.timeElapsed=0,this.originPos=[0,0,0],this.originLookAt=[0,0,0],this.animationFromPos=[0,0,0],this.animationFromLookAt=[0,0,0],this.animationDestPos=[0,0,0],this.animationDestLookAt=[0,0,0],this.animationDuration=1,this.playing=!1}update(t){if(!!this.playing&&!c.VEC3_ISEQUAL(this.animationDestPos,this.animationFromPos))if(this.timeElapsed<this.animationDuration){const e=this.timeElapsed/this.animationDuration,s=c.VEC3_SUBSTRACT(this.animationDestPos,this.animationFromPos),i=c.VEC3_SCALE(s,.5),r=c.VEC3_ADD(this.animationFromPos,i),n=c.VEC3_CREATE(-i[2],i[1],i[0]),a=c.VEC3_ADD(r,n),h=c.VEC3_QUADRATIC_BEZIER(this.animationFromPos,a,this.animationDestPos,e),l=c.VEC3_SUBSTRACT(this.animationDestLookAt,this.animationFromLookAt),u=c.VEC3_ADD(this.animationFromLookAt,c.VEC3_SCALE(l,e));super.setPosition(h[0],h[1],h[2]),super.lookAt(u[0],u[1],u[2]),this.timeElapsed+=t}else m.emit(this,"E_FINISHED"),this.playing=!1,this.timeElapsed=0}play(t,e,s){c.VEC3_ISEQUAL(t,this.originPos)||(this.animationFromPos=this.originPos,this.animationFromLookAt=this.originLookAt,this.animationDestPos=t,this.animationDestLookAt=e,this.animationDuration=s,this.playing=!0)}playBack(t=this.animationDuration){if(c.VEC3_ISEQUAL(this.animationFromPos,this.animationDestPos))return;const e=this.animationFromPos,s=this.animationFromLookAt;this.animationFromPos=this.animationDestPos,this.animationFromLookAt=this.animationDestLookAt,this.animationDestPos=e,this.animationDestLookAt=s,this.animationDuration=t,this.playing=!0}setPosition(t,e,s){this.originPos=[t,e,s],super.setPosition(t,e,s)}setLookAt(t,e,s){this.originLookAt=[t,e,s],super.lookAt(t,e,s)}}const ja={"1N":[[-3,0,0,0]],"2N":[[-3,0,1,0],[-3,0,-1,0]],"3N":[[-3,0,2,0],[-3,0,0,0],[-3,0,-2,0]],"4N":[[-3,0,3,0],[-3,0,1,0],[-3,0,-1,0],[-3,0,-3,0]]},Ga={"1N":[[3,0,0,Math.PI]],"2N":[[3,0,1,Math.PI],[-3,0,-1,Math.PI]],"3N":[[3,0,2,Math.PI],[-3,0,0,Math.PI],[-3,0,-2,Math.PI]],"4N":[[3,0,3,Math.PI],[-3,0,1,Math.PI],[-3,0,-1,Math.PI],[-3,0,-3,Math.PI]]},ka=[-5,5,9],qa=[-3,0,0],Ya=[5,5,9],Xa=[3,0,0];class za{constructor(){this.battle=null,this.fighters=[],this.focusableFighterPredicate=()=>!0,this.focusedFighter=null,this.camera=new Wa,this.map=new G,this.focusIcon=new G,this.handleKeyDownCb=t=>this.handleKeyDown(t)}async loadFromBattle(t){for(let e of this.fighters)e.delete();if(this.focusIcon=new G,await this.focusIcon.loadFromFile("samples/rpg/jsms/focus.jsm"),this.focusIcon.setMaterial(new $({texture:await D.loadTexture("samples/rpg/jsms/focus.png")})),t){const e=t.getCameraPosition();this.camera.setPosition(e[0],e[1],e[2]);const s=t.getCameraLookAt();this.camera.setLookAt(s[0],s[1],s[2]),this.map=new G,await this.map.loadFromFile(t.getJSMFile()),this.map.setMaterial(new $({texture:await D.loadTexture(t.getJSMTextureFile())}));let i=t.getHeroes();for(let n=0;n<i.length;n++){let a=new _i,h=ja[i.length+t.getFormationType()][n];await a.loadFromCharacter(i[n]),a.setPosition(h[0],h[1],h[2]),a.setRotation(0,h[3],0),this.fighters.push(a)}let r=t.getEnemies();for(let n=0;n<r.length;n++){let a=new _i,h=Ga[r.length+t.getFormationType()][n];await a.loadFromCharacter(r[n]),a.setPosition(h[0],h[1],h[2]),a.setRotation(0,h[3],0),this.fighters.push(a)}this.battle=t}else this.battle=null}delete(){for(let t of this.fighters)t.delete();this.map.delete(),this.focusIcon.delete()}update(t){for(let e of this.fighters)e.update(t);if(this.focusedFighter){let e=this.focusedFighter.getPosition(),s=this.focusedFighter.getSize();this.focusIcon.setPosition(e[0],e[1]+s[1]+.5,e[2]),this.focusIcon.rotate(0,.05,0),this.focusIcon.update(t)}this.camera.update(t),this.map.update(t)}draw(){for(let t of this.getFighters())t.draw();this.focusedFighter&&this.focusIcon.draw(),this.map.draw()}setFocusableFighterPredicate(t){for(let e=0;e<this.fighters.length;e++){let s=this.fighters[e];if(t(s)){this.focusFighter(e,!0);break}}this.focusableFighterPredicate=t}focusFighter(t,e=!1){let s=this.fighters[t];if(!s)throw new Error("UIBattleArea::focusFighter(): fighter not found !");this.focusedFighter=s,e&&m.emit(this,"E_FIGHTER_FOCUSED",{fighter:s,index:t})}unfocusFighter(t=!1){!this.focusedFighter||(this.focusedFighter=null,t&&m.emit(this,"E_FIGHTER_UNFOCUSED"))}prevFocus(){let t=this.fighters.indexOf(this.focusedFighter),e=0;for(;e<this.fighters.length;){if(t=t-1<0?this.fighters.length-1:t-1,this.focusableFighterPredicate(this.fighters[t])){this.focusFighter(t,!0);break}e++}}nextFocus(){let t=this.fighters.indexOf(this.focusedFighter),e=0;for(;e<this.fighters.length;){if(t=t+1>this.fighters.length-1?0:t+1,this.focusableFighterPredicate(this.fighters[t])){this.focusFighter(t,!0);break}e++}}async cameraOnAlly(){this.camera.play(ka,qa,1500),await m.wait(this.camera,"E_FINISHED")}async cameraOnEnemy(){this.camera.play(Ya,Xa,1500),await m.wait(this.camera,"E_FINISHED")}async cameraOnDefault(){this.camera.playBack(1500),await m.wait(this.camera,"E_FINISHED")}requestSelection(){document.addEventListener("keydown",this.handleKeyDownCb)}getFighters(){return this.fighters}getFocusedFighter(){return this.focusedFighter}handleKeyDown(t){t.key=="Escape"?(document.removeEventListener("keydown",this.handleKeyDownCb),m.emit(this,"E_CLOSED")):t.key=="Enter"?(document.removeEventListener("keydown",this.handleKeyDownCb),m.emit(this,"E_ENTER_PRESSED")):t.key=="ArrowLeft"?this.prevFocus():t.key=="ArrowRight"&&this.nextFocus()}}class Za extends U{constructor(){super(),this.player=se.getPlayer(),this.inventory=this.player.getInventory(),this.battle=new La,this.uiTitle=new lt,this.uiActionMenu=new it,this.uiEffects=new Fa,this.uiInventory=new us({showPrice:!1,showQuantity:!0}),this.uiHeroes=new Va,this.uiStatus=new Ha,this.area=new za}async onEnter(t={battleId}){await this.battle.loadFromFile("samples/rpg/data/battle_"+t.battleId+"/data.json"),this.uiTitle.setVisible(!1),g.addWidget(this.uiTitle,"position:absolute; top:0; left:0; right:0; height:50px; z-index:2;"),this.uiActionMenu.add("ATTACK","Attaques"),this.uiActionMenu.add("MAGIC","Magies"),this.uiActionMenu.add("ITEMS","Objets"),this.uiActionMenu.add("LET","Passer"),g.addWidget(this.uiActionMenu,"position:absolute; bottom:0; left:0; width:20%; height:150px; z-index:1;"),this.uiEffects.setVisible(!1),g.addWidget(this.uiEffects,"position:absolute; top:50px; bottom:150px; left:0; right:0; z-index:2;"),this.uiInventory.setVisible(!1),this.uiInventory.setFilterPredicate(e=>e instanceof Ot),g.addWidget(this.uiInventory,"position:absolute; top:50px; bottom:150px; left:0; right:0; z-index:2;"),this.uiHeroes.setCollection(new _t(this.player.getHeroes())),g.addWidget(this.uiHeroes,"position:absolute; bottom:0; left:20%; right:0; height:150px; z-index:1;"),this.uiStatus.setBattle(this.battle),g.addWidget(this.uiStatus,"position:absolute; top:0; left:0; right:0; height:50px; z-index:1;"),await this.area.loadFromBattle(this.battle),m.subscribe(this.battle,"E_CHAR_READY",this,this.handleBattleCharReady),m.subscribe(this.battle,"E_ACTION_BEFORE",this,this.handleBattleActionBefore),m.subscribe(this.battle,"E_ACTION_AFTER",this,this.handleBattleActionAfter),m.subscribe(this.battle,"E_WIN",this,this.handleBattleWin),m.subscribe(this.battle,"E_LOST",this,this.handleBattleLost),m.subscribe(this.uiHeroes,"E_ITEM_FOCUSED",this,this.handleHeroesItemFocused),m.subscribe(this.uiHeroes,"E_ITEM_SELECTED",this,this.handleHeroesItemSelected),m.subscribe(this.uiActionMenu,"E_CLOSED",this,this.handleActionMenuClosed),m.subscribe(this.uiActionMenu,"E_ITEM_SELECTED",this,this.handleActionMenuItemSelected),m.subscribe(this.uiEffects,"E_CLOSED",this,this.handleEffectsClosed),m.subscribe(this.uiEffects,"E_ITEM_SELECTED",this,this.handleEffectsItemSelected),m.subscribe(this.uiInventory,"E_CLOSED",this,this.handleItemsMenuClosed),m.subscribe(this.uiInventory,"E_ITEM_SELECTED",this,this.handleItemsMenuItemSelected),m.subscribe(this.area,"E_CLOSED",this,this.handleAreaClosed),m.subscribe(this.area,"E_ENTER_PRESSED",this,this.handleAreaEnterPressed),this.battle.startup()}async onExit(){g.removeWidget(this.uiTitle),g.removeWidget(this.uiActionMenu),g.removeWidget(this.uiEffects),g.removeWidget(this.uiInventory),g.removeWidget(this.uiHeroes),g.removeWidget(this.uiStatus),this.area.delete()}update(t){this.area.update(t)}draw(){this.area.draw()}handleBattleCharReady(t){t.char instanceof Ps&&g.focus(this.uiHeroes)}async handleBattleActionBefore(t){t.action instanceof ts||t.action instanceof qe||(t.action.toChar instanceof Ps?await this.area.cameraOnAlly():await this.area.cameraOnEnemy())}async handleBattleActionAfter(t){t.action instanceof ts||t.action instanceof qe||await this.area.cameraOnDefault()}handleBattleWin(){R.requestPopScreen()}handleBattleLost(){R.requestPopScreen()}handleHeroesItemFocused(t){let s=this.area.getFighters().findIndex(i=>i.getCharacter()==this.uiHeroes.getFocusedItem());this.area.focusFighter(s)}handleHeroesItemSelected(){g.focus(this.uiActionMenu)}handleActionMenuClosed(){this.uiHeroes.unselectWidgets(),g.focus(this.uiHeroes)}handleActionMenuItemSelected(t){let e=this.uiHeroes.getSelectedItem();t.id=="ATTACK"?(this.uiTitle.setText("Attaques"),this.uiEffects.setCollection(new _t(e.getAttackEffects())),this.uiEffects.setEnablePredicate(s=>s.isUsable(e)),this.uiTitle.setVisible(!0),this.uiEffects.setVisible(!0),g.focus(this.uiEffects)):t.id=="MAGIC"?(this.uiTitle.setText("Magies"),this.uiEffects.setCollection(new _t(e.getMagicEffects())),this.uiEffects.setEnablePredicate(s=>s.isUsable(e)),this.uiTitle.setVisible(!0),this.uiEffects.setVisible(!0),g.focus(this.uiEffects)):t.id=="ITEMS"?(this.uiTitle.setText("Objets"),this.uiInventory.setCollection(this.inventory),this.uiTitle.setVisible(!0),this.uiInventory.setVisible(!0),g.focus(this.uiInventory)):t.id=="LET"&&(this.battle.runAction(new qe(this.battle,e)),this.uiActionMenu.unselectWidgets(),this.uiHeroes.unselectWidgets())}handleEffectsClosed(){this.uiTitle.setVisible(!1),this.uiEffects.setVisible(!1),this.uiActionMenu.unselectWidgets(),g.focus(this.uiActionMenu)}handleEffectsItemSelected(){let t=this.uiHeroes.getSelectedItem(),e=this.uiEffects.getSelectedItem();this.uiTitle.setVisible(!1),this.uiEffects.setVisible(!1),this.area.setFocusableFighterPredicate(s=>e.isTargetCharConditionCheck(t,s.getCharacter())),this.area.requestSelection(),g.unfocus()}handleItemsMenuClosed(){this.uiTitle.setVisible(!1),this.uiInventory.setVisible(!1),this.uiActionMenu.unselectWidgets(),g.focus(this.uiActionMenu)}handleItemsMenuItemSelected(){let t=this.uiHeroes.getSelectedItem(),e=this.uiInventory.getSelectedItem();this.uiTitle.setVisible(!1),this.uiInventory.setVisible(!1),this.area.setFocusableFighterPredicate(s=>e.isTarget(t,s.getCharacter())),this.area.requestSelection(),g.unfocus()}handleAreaClosed(){let t=this.uiActionMenu.getSelectedId();t=="ATTACK"||t=="MAGIC"?(this.uiTitle.setVisible(!0),this.uiEffects.setVisible(!0),this.uiEffects.unselectWidgets(),g.focus(this.uiEffects)):t=="ITEMS"&&(this.uiTitle.setVisible(!0),this.uiInventory.setVisible(!0),this.uiInventory.unselectWidgets(),g.focus(this.uiInventory))}async handleAreaEnterPressed(){let t=this.uiActionMenu.getSelectedId(),e=this.uiHeroes.getSelectedItem(),s=this.area.getFocusedFighter().getCharacter();if(t=="ATTACK"||t=="MAGIC"){let i=this.uiEffects.getSelectedItem();await this.battle.runAction(new Dr(this.battle,i,e,s))}else if(t=="ITEMS"){let i=this.uiInventory.getSelectedItem();await this.battle.runAction(new Ra(this.battle,i,e,s))}this.uiActionMenu.unselectWidgets(),this.uiHeroes.unselectWidgets()}}class Xs extends Ne{constructor(){super()}addItem(t,e=!0,s=-1){let i=new $a;i.setHero(t),this.addWidget(i,e,s)}}class $a extends W{constructor(){super({className:"UIHeroesItem",template:`
      <img class="UIHeroesItem-picture js-picture" src="#">
      <div class="UIHeroesItem-body">
        <div class="UIHeroesItem-body-name js-name"></div>
        <div class="UIHeroesItem-body-stats">
          <div class="UIHeroesItem-body-stats-item">
            <span class="UIHeroesItem-body-stats-item-name">HP</span>
            <span class="UIHeroesItem-body-stats-item-separator"></span>
            <span class="UIHeroesItem-body-stats-item-value js-hp-value"></span>
          </div>
          <div class="UIHeroesItem-body-stats-item">
            <span class="UIHeroesItem-body-stats-item-name">MP</span>
            <span class="UIHeroesItem-body-stats-item-separator"></span>
            <span class="UIHeroesItem-body-stats-item-value js-mp-value"></span>
          </div>
        </div>
      </div>`}),this.hero=null}update(t){this.hero?(this.node.querySelector(".js-picture").src=this.hero.getPictureFile(),this.node.querySelector(".js-name").textContent=this.hero.getName(),this.node.querySelector(".js-hp-value").textContent=this.hero.getAttribute("HP")+"/"+this.hero.getAttribute("HP_MAX"),this.node.querySelector(".js-mp-value").textContent=this.hero.getAttribute("MP")+"/"+this.hero.getAttribute("HP_MAX")):(this.node.querySelector(".js-picture").src="#",this.node.querySelector(".js-name").textContent="--",this.node.querySelector(".js-hp-value").textContent="--/--",this.node.querySelector(".js-mp-value").textContent="--/--")}getHero(){return this.hero}setHero(t){this.hero=t||null}}class Rr extends Ne{constructor(){super()}addItem(t,e=!0,s=-1){let i=new Ka;i.setHero(t),this.addWidget(i,e,s)}}class Ka extends W{constructor(){super({className:"UIHeroesEquipmentItem",template:`
      <img class="UIHeroesEquipmentItem-picture js-picture" src="#">
      <div class="UIHeroesEquipmentItem-body">
        <div class="UIHeroesEquipmentItem-body-name js-name"></div>
        <div class="UIHeroesEquipmentItem-body-stats">
          <div class="UIHeroesEquipmentItem-body-stats-item">
            <span class="UIHeroesEquipmentItem-body-stats-item-name">HP MAX</span>
            <span class="UIHeroesEquipmentItem-body-stats-item-separator"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-value1 js-hp-max-value1"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-arrow"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-value2 js-hp-max-value2"></span>
          </div>
          <div class="UIHeroesEquipmentItem-body-stats-item">
            <span class="UIHeroesEquipmentItem-body-stats-item-name">MP MAX</span>
            <span class="UIHeroesEquipmentItem-body-stats-item-separator"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-value1 js-mp-max-value1"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-arrow"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-value2 js-mp-max-value2"></span>
          </div>
          <div class="UIHeroesEquipmentItem-body-stats-item">
            <span class="UIHeroesEquipmentItem-body-stats-item-name">ATK</span>
            <span class="UIHeroesEquipmentItem-body-stats-item-separator"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-value1 js-atk-value1"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-arrow"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-value2 js-atk-value2"></span>
          </div>
          <div class="UIHeroesEquipmentItem-body-stats-item">
            <span class="UIHeroesEquipmentItem-body-stats-item-name">DEF</span>
            <span class="UIHeroesEquipmentItem-body-stats-item-separator"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-value1 js-def-value1"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-arrow"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-value2 js-def-value2"></span>
          </div>
          <div class="UIHeroesEquipmentItem-body-stats-item">
            <span class="UIHeroesEquipmentItem-body-stats-item-name">M-ATK</span>
            <span class="UIHeroesEquipmentItem-body-stats-item-separator"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-value1 js-magic-atk-value1"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-arrow"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-value2 js-magic-atk-value2"></span>
          </div>
          <div class="UIHeroesEquipmentItem-body-stats-item">
            <span class="UIHeroesEquipmentItem-body-stats-item-name">M-DEF</span>
            <span class="UIHeroesEquipmentItem-body-stats-item-separator"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-value1 js-magic-def-value1"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-arrow"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-value2 js-magic-def-value2"></span>
          </div>
          <div class="UIHeroesEquipmentItem-body-stats-item">
            <span class="UIHeroesEquipmentItem-body-stats-item-name">AGI</span>
            <span class="UIHeroesEquipmentItem-body-stats-item-separator"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-value1 js-agility-value1"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-arrow"></span>
            <span class="UIHeroesEquipmentItem-body-stats-item-value2 js-agility-value2"></span>
          </div>
        </div>
      </div>`}),this.hero=null,this.equipmentItem=null}update(t){if(this.hero){let e=this.hero.getAttributes(),s=this.hero.isEquipableItem(this.equipmentItem)?this.hero.getAttributesWith(this.equipmentItem):{};this.node.querySelector(".js-picture").src=this.hero.getPictureFile(),this.node.querySelector(".js-name").textContent=this.hero.getName(),this.displayStat("hp-max",e.get("HP_MAX"),s.HP_MAX),this.displayStat("mp-max",e.get("MP_MAX"),s.MP_MAX),this.displayStat("atk",e.get("ATK"),s.ATK),this.displayStat("def",e.get("DEF"),s.DEF),this.displayStat("magic-atk",e.get("MAGIC_ATK"),s.MAGIC_ATK),this.displayStat("magic-def",e.get("MAGIC_DEF"),s.MAGIC_DEF),this.displayStat("agility",e.get("AGILITY"),s.AGILITY)}else this.node.querySelector(".js-picture").src="#",this.node.querySelector(".js-name").textContent="--",this.displayStat("hp-max","--"),this.displayStat("mp-max","--"),this.displayStat("atk","--"),this.displayStat("def","--"),this.displayStat("magic-atk","--"),this.displayStat("magic-def","--"),this.displayStat("agility","--")}getHero(){return this.hero}setHero(t){this.hero=t||null}setEquipmentItem(t){this.equipmentItem=t||null}displayStat(t,e,s){this.node.querySelector(".js-"+t+"-value1").textContent=e||"",this.node.querySelector(".js-"+t+"-value2").textContent=s||"",this.node.querySelector(".js-"+t+"-value2").style.display=s?"block":"none",this.node.querySelector(".js-"+t+"-value2").style.color=s>e?"#00d600":s<e?"#ff2929":"#fff"}}class Ja extends U{constructor(){super(),this.player=se.getPlayer(),this.inventory=this.player.getInventory(),this.uiTopMenu=new it({axis:ve.X}),this.uiTitle=new lt,this.uiDescription=new lt,this.uiInventory=new us({showPrice:!1,showQuantity:!0}),this.uiHeroes=new Rr,this.uiSortMenu=new it,this.uiFilterMenu=new it}async onEnter(){this.uiTopMenu.add("APPLY","Equiper"),this.uiTopMenu.add("DELETE","Supprimer"),this.uiTopMenu.add("SORT","Trier"),this.uiTopMenu.add("FILTER","Filtrer"),g.addWidget(this.uiTopMenu,"position:absolute; top:0; left:0; width:70%; height:50px;"),this.uiTitle.setText("Objets"),g.addWidget(this.uiTitle,"position:absolute; top:0; left:70%; width:30%; height:50px;"),this.uiDescription.setText("Description..."),g.addWidget(this.uiDescription,"position:absolute; top:50px; left:0; width:100%; height:50px;"),this.uiInventory.setFilterPredicate(t=>t instanceof pt),this.uiInventory.setCollection(this.player.getInventory()),g.addWidget(this.uiInventory,"position:absolute; top:100px; left:0; bottom:0; width:40%;"),this.uiHeroes.setCollection(new _t(this.player.getHeroes())),g.addWidget(this.uiHeroes,"position:absolute; top:100px; left:40%; bottom:0; width:60%;"),this.uiSortMenu.setVisible(!1),this.uiSortMenu.add("NONE","Aucun"),this.uiSortMenu.add("ALPHA","Alphab\xE9tique"),this.uiSortMenu.add("QUANTITY","Quantit\xE9"),g.addWidget(this.uiSortMenu,"position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);"),this.uiFilterMenu.setVisible(!1),this.uiFilterMenu.add("NONE","Aucun"),this.uiFilterMenu.add("WEAPON","Arme"),this.uiFilterMenu.add("HELMET","Haume"),this.uiFilterMenu.add("ARMOR","Armure"),this.uiFilterMenu.add("RELIC","Relique"),g.addWidget(this.uiFilterMenu,"position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);"),m.subscribe(this.uiTopMenu,"E_CLOSED",this,this.handleTopMenuClosed),m.subscribe(this.uiTopMenu,"E_FOCUSED",this,this.handleTopMenuFocused),m.subscribe(this.uiTopMenu,"E_ITEM_SELECTED",this,this.handleTopMenuItemSelected),m.subscribe(this.uiInventory,"E_CLOSED",this,this.handleInventoryClosed),m.subscribe(this.uiInventory,"E_ITEM_FOCUSED",this,this.handleInventoryItemFocused),m.subscribe(this.uiInventory,"E_ITEM_SELECTED",this,this.handleInventoryItemSelected),m.subscribe(this.uiHeroes,"E_CLOSED",this,this.handleHeroesClosed),m.subscribe(this.uiHeroes,"E_ITEM_SELECTED",this,this.handleHeroesItemSelected),m.subscribe(this.uiSortMenu,"E_ITEM_SELECTED",this,this.handleSortMenuItemSelected),m.subscribe(this.uiFilterMenu,"E_ITEM_SELECTED",this,this.handleFilterMenuItemSelected),g.focus(this.uiTopMenu)}async onExit(){g.removeWidget(this.uiTopMenu),g.removeWidget(this.uiTitle),g.removeWidget(this.uiDescription),g.removeWidget(this.uiInventory),g.removeWidget(this.uiHeroes),g.removeWidget(this.uiSortMenu),g.removeWidget(this.uiFilterMenu)}handleTopMenuClosed(){R.requestPopScreen()}handleTopMenuFocused(){this.uiTopMenu.setEnabledWidget(0,this.inventory.hasEquipmentItems()),this.uiTopMenu.setEnabledWidget(1,this.inventory.hasEquipmentItems()),this.uiDescription.setText("Description...");for(let t of this.uiHeroes.getWidgets())t.setEquipmentItem(null),t.setEnabled(!0)}handleTopMenuItemSelected(t){t.id=="APPLY"?g.focus(this.uiInventory):t.id=="DELETE"?g.focus(this.uiInventory):t.id=="SORT"?(this.uiSortMenu.setVisible(!0),g.focus(this.uiSortMenu)):t.id=="FILTER"&&(this.uiFilterMenu.setVisible(!0),g.focus(this.uiFilterMenu))}handleInventoryClosed(){this.uiInventory.unselectWidgets(),this.uiTopMenu.unselectWidgets(),g.focus(this.uiTopMenu)}handleInventoryItemFocused(t){let e=this.uiInventory.getFocusedItem();this.uiDescription.setText(e.getDescription());for(let s of this.uiHeroes.getWidgets()){let i=s.getHero();s.setEquipmentItem(e),s.setEnabled(i.isEquipableItem(e))}}handleInventoryItemSelected(t){let e=this.uiTopMenu.getSelectedId();if(e=="APPLY")g.focus(this.uiHeroes);else if(e=="DELETE"){let s=this.uiInventory.getSelectedItem();this.inventory.removeItemById(s.getId()),this.uiInventory.unselectWidgets(),this.uiTopMenu.unselectWidgets(),g.focus(this.uiTopMenu)}}handleHeroesClosed(){this.uiHeroes.unselectWidgets(),this.uiInventory.unselectWidgets(),g.focus(this.uiInventory)}handleHeroesItemSelected(){let t=this.uiInventory.getSelectedItem(),s=this.uiHeroes.getSelectedItem().setEquipment(t);s&&this.inventory.addItem(s),this.inventory.removeItemById(t.getId()),this.uiHeroes.unselectWidgets(),this.uiInventory.unselectWidgets(),this.uiTopMenu.unselectWidgets(),g.focus(this.uiTopMenu)}handleSortMenuItemSelected(t){t.id=="NONE"?this.uiInventory.setSortPredicate(()=>!0):t.id=="ALPHA"?this.uiInventory.setSortPredicate((e,s)=>e.getName().localeCompare(s.getName())):t.id=="QUANTITY"&&this.uiInventory.setSortPredicate((e,s)=>e.getQuantity()-s.getQuantity()),this.uiSortMenu.setVisible(!1),this.uiTopMenu.unselectWidgets(),g.focus(this.uiTopMenu)}handleFilterMenuItemSelected(t){t.id=="NONE"?this.uiInventory.setFilterPredicate(e=>e instanceof pt):t.id=="WEAPON"?this.uiInventory.setFilterPredicate(e=>e instanceof pt&&e.getType()==St.WEAPON):t.id=="HELMET"?this.uiInventory.setFilterPredicate(e=>e instanceof pt&&e.getType()==St.HELMET):t.id=="ARMOR"?this.uiInventory.setFilterPredicate(e=>e instanceof pt&&e.getType()==St.ARMOR):t.id=="RELIC"&&this.uiInventory.setFilterPredicate(e=>e instanceof pt&&e.getType()==St.RELIC),this.uiFilterMenu.setVisible(!1),this.uiTopMenu.unselectWidgets(),g.focus(this.uiTopMenu)}}class Qa extends U{constructor(){super(),this.player=se.getPlayer(),this.inventory=this.player.getInventory(),this.uiTopMenu=new it({axis:ve.X}),this.uiTitle=new lt,this.uiDescription=new lt,this.uiInventory=new us({showPrice:!1,showQuantity:!0}),this.uiHeroes=new Xs,this.uiSortMenu=new it,this.uiFilterMenu=new it}async onEnter(){this.uiTopMenu.add("APPLY","Utiliser"),this.uiTopMenu.add("DELETE","Supprimer"),this.uiTopMenu.add("SORT","Trier"),this.uiTopMenu.add("FILTER","Filtrer"),g.addWidget(this.uiTopMenu,"position:absolute; top:0; left:0; width:70%; height:50px;"),this.uiTitle.setText("Objets"),g.addWidget(this.uiTitle,"position:absolute; top:0; left:70%; width:30%; height:50px;"),this.uiDescription.setText("Description..."),g.addWidget(this.uiDescription,"position:absolute; top:50px; left:0; width:100%; height:50px;"),this.uiInventory.setFilterPredicate(t=>t instanceof Ot),this.uiInventory.setCollection(this.inventory),g.addWidget(this.uiInventory,"position:absolute; top:100px; left:0; bottom:0; width:40%;"),this.uiHeroes.setCollection(new _t(this.player.getHeroes())),g.addWidget(this.uiHeroes,"position:absolute; top:100px; left:40%; bottom:0; width:60%;"),this.uiSortMenu.setVisible(!1),this.uiSortMenu.add("NONE","Aucun"),this.uiSortMenu.add("ALPHA","Alphab\xE9tique"),this.uiSortMenu.add("QUANTITY","Quantit\xE9"),g.addWidget(this.uiSortMenu,"position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);"),this.uiFilterMenu.setVisible(!1),this.uiFilterMenu.add("NONE","Aucun"),this.uiFilterMenu.add("POTION","Potion"),this.uiFilterMenu.add("FOOD","Nourriture"),this.uiFilterMenu.add("OTHER","Autre"),g.addWidget(this.uiFilterMenu,"position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);"),m.subscribe(this.uiTopMenu,"E_CLOSED",this,this.handleTopMenuClosed),m.subscribe(this.uiTopMenu,"E_FOCUSED",this,this.handleTopMenuFocused),m.subscribe(this.uiTopMenu,"E_ITEM_SELECTED",this,this.handleTopMenuItemSelected),m.subscribe(this.uiInventory,"E_CLOSED",this,this.handleInventoryClosed),m.subscribe(this.uiInventory,"E_ITEM_FOCUSED",this,this.handleInventoryItemFocused),m.subscribe(this.uiInventory,"E_ITEM_SELECTED",this,this.handleInventoryItemSelected),m.subscribe(this.uiHeroes,"E_CLOSED",this,this.handleHeroesClosed),m.subscribe(this.uiHeroes,"E_ITEM_SELECTED",this,this.handleHeroesItemSelected),m.subscribe(this.uiSortMenu,"E_ITEM_SELECTED",this,this.handleSortMenuItemSelected),m.subscribe(this.uiFilterMenu,"E_ITEM_SELECTED",this,this.handleFilterMenuItemSelected),g.focus(this.uiTopMenu)}async onExit(){g.removeWidget(this.uiTopMenu),g.removeWidget(this.uiTitle),g.removeWidget(this.uiDescription),g.removeWidget(this.uiInventory),g.removeWidget(this.uiHeroes),g.removeWidget(this.uiSortMenu),g.removeWidget(this.uiFilterMenu)}handleTopMenuClosed(){R.requestPopScreen()}handleTopMenuFocused(){this.uiTopMenu.setEnabledWidget(0,this.inventory.hasMenuAvailableItems()),this.uiTopMenu.setEnabledWidget(1,this.inventory.hasCommonItems()),this.uiDescription.setText("Description...");for(let t of this.uiHeroes.getWidgets())t.setEnabled(!0)}handleTopMenuItemSelected(t){t.id=="APPLY"?(this.uiInventory.setEnablePredicate(e=>e.isMenuAvailable()),g.focus(this.uiInventory)):t.id=="DELETE"?(this.uiInventory.setEnablePredicate(e=>!0),g.focus(this.uiInventory)):t.id=="SORT"?(this.uiSortMenu.setVisible(!0),g.focus(this.uiSortMenu)):t.id=="FILTER"&&(this.uiFilterMenu.setVisible(!0),g.focus(this.uiFilterMenu))}handleInventoryClosed(){this.uiInventory.unselectWidgets(),this.uiTopMenu.unselectWidgets(),g.focus(this.uiTopMenu)}handleInventoryItemFocused(t){let e=this.uiInventory.getFocusedItem();this.uiDescription.setText(e.description);for(let s of this.uiHeroes.getWidgets()){let i=s.getHero();s.setEnabled(e.isTarget(i,i))}}handleInventoryItemSelected(t){let e=this.uiTopMenu.getSelectedId();if(e=="APPLY")g.focus(this.uiHeroes);else if(e=="DELETE"){let s=this.uiInventory.getSelectedItem();this.inventory.removeItemById(s.getId()),this.uiInventory.unselectWidgets(),this.uiTopMenu.unselectWidgets(),g.focus(this.uiTopMenu)}}handleHeroesClosed(){this.uiHeroes.unselectWidgets(),this.uiInventory.unselectWidgets(),g.focus(this.uiInventory)}handleHeroesItemSelected(){let t=this.uiInventory.getSelectedItem(),e=this.uiHeroes.getSelectedItem();t.getEffect().apply(e,e),this.inventory.removeItemById(t.getId()),this.uiHeroes.unselectWidgets(),this.uiInventory.unselectWidgets(),this.uiTopMenu.unselectWidgets(),g.focus(this.uiTopMenu)}handleSortMenuItemSelected(t){t.id=="NONE"?this.uiInventory.setSortPredicate(()=>!0):t.id=="ALPHA"?this.uiInventory.setSortPredicate((e,s)=>e.getName().localeCompare(s.getName())):t.id=="QUANTITY"&&this.uiInventory.setSortPredicate((e,s)=>e.getQuantity()-s.getQuantity()),this.uiSortMenu.setVisible(!1),this.uiTopMenu.unselectWidgets(),g.focus(this.uiTopMenu)}handleFilterMenuItemSelected(t){t.id=="NONE"?this.uiInventory.setFilterPredicate(e=>e instanceof Ot):t.id=="POTION"?this.uiInventory.setFilterPredicate(e=>e instanceof Ot&&e.getType()==St.POTION):t.id=="FOOD"?this.uiInventory.setFilterPredicate(e=>e instanceof Ot&&e.getType()==St.FOOD):t.id=="OTHER"&&this.uiInventory.setFilterPredicate(e=>e instanceof Ot&&e.getType()==St.OTHER),this.uiFilterMenu.setVisible(!1),this.uiTopMenu.unselectWidgets(),g.focus(this.uiTopMenu)}}class th extends W{constructor(){super({className:"UIStatus",template:`
      <div class="UIStatus-avatar">
        <img class="UIStatus-avatar-picture js-picture" src="#">
        <div class="UIStatus-avatar-name js-name"></div>
      </div>
      <div class="UIStatus-title">STATS</div>
      <div class="UIStatus-section">
        <div class="UIStatus-stats">
          <div class="UIStatus-stats-item">
            <span class="UIStatus-stats-item-name">LV</span>
            <span class="UIStatus-stats-item-separator"></span>
            <span class="UIStatus-stats-item-value js-lv-value"></span>
          </div>
          <div class="UIStatus-stats-item">
            <span class="UIStatus-stats-item-name">XP</span>
            <span class="UIStatus-stats-item-separator"></span>
            <span class="UIStatus-stats-item-value js-xp-value"></span>
          </div>
          <div class="UIStatus-stats-item">
            <span class="UIStatus-stats-item-name">HP</span>
            <span class="UIStatus-stats-item-separator"></span>
            <span class="UIStatus-stats-item-value js-hp-value"></span>
          </div>
          <div class="UIStatus-stats-item">
            <span class="UIStatus-stats-item-name">MP</span>
            <span class="UIStatus-stats-item-separator"></span>
            <span class="UIStatus-stats-item-value js-mp-value"></span>
          </div>
          <div class="UIStatus-stats-item">
            <span class="UIStatus-stats-item-name">ATK</span>
            <span class="UIStatus-stats-item-separator"></span>
            <span class="UIStatus-stats-item-value js-atk-value"></span>
          </div>
          <div class="UIStatus-stats-item">
            <span class="UIStatus-stats-item-name">DEF</span>
            <span class="UIStatus-stats-item-separator"></span>
            <span class="UIStatus-stats-item-value js-def-value"></span>
          </div>
          <div class="UIStatus-stats-item">
            <span class="UIStatus-stats-item-name">M-ATK</span>
            <span class="UIStatus-stats-item-separator"></span>
            <span class="UIStatus-stats-item-value js-matk-value"></span>
          </div>
          <div class="UIStatus-stats-item">
            <span class="UIStatus-stats-item-name">M-DEF</span>
            <span class="UIStatus-stats-item-separator"></span>
            <span class="UIStatus-stats-item-value js-mdef-value"></span>
          </div>
          <div class="UIStatus-stats-item">
            <span class="UIStatus-stats-item-name">AGILITE</span>
            <span class="UIStatus-stats-item-separator"></span>
            <span class="UIStatus-stats-item-value js-agility-value"></span>
          </div>
          <div class="UIStatus-stats-item">
            <span class="UIStatus-stats-item-name">ELEMENT</span>
            <span class="UIStatus-stats-item-separator"></span>
            <span class="UIStatus-stats-item-value js-element-value"></span>
          </div>
        </div>
      </div>
      <div class="UIStatus-title">EQUIPEMENTS</div>
      <div class="UIStatus-section">
        <div class="UIStatus-stuffs">
          <div class="UIStatus-stuffs-item">
            <span class="UIStatus-stuffs-item-name">ARME</span>
            <span class="UIStatus-stuffs-item-separator"></span>
            <span class="UIStatus-stuffs-item-value js-weapon-value"></span>
          </div>
          <div class="UIStatus-stuffs-item">
            <span class="UIStatus-stuffs-item-name">CASQUE</span>
            <span class="UIStatus-stuffs-item-separator"></span>
            <span class="UIStatus-stuffs-item-value js-helmet-value"></span>
          </div>
          <div class="UIStatus-stuffs-item">
            <span class="UIStatus-stuffs-item-name">ARMURE</span>
            <span class="UIStatus-stuffs-item-separator"></span>
            <span class="UIStatus-stuffs-item-value js-armor-value"></span>
          </div>
          <div class="UIStatus-stuffs-item">
            <span class="UIStatus-stuffs-item-name">RELIQUE</span>
            <span class="UIStatus-stuffs-item-separator"></span>
            <span class="UIStatus-stuffs-item-value js-relic-value"></span>
          </div>
        </div>
      </div>
      <div class="UIStatus-title">DESCRIPTION</div>
      <div class="UIStatus-section">
        <div class="UIStatus-description js-description"></div>
      </div>`}),this.hero=null}update(){if(this.hero){let t=this.hero.getWeapon(),e=this.hero.getHelmet(),s=this.hero.getArmor(),i=this.hero.getRelic();this.node.querySelector(".js-picture").src=this.hero.getPictureFile(),this.node.querySelector(".js-name").textContent=this.hero.getName(),this.node.querySelector(".js-lv-value").textContent=this.hero.getAttribute("LV")+"/"+this.hero.getAttribute("LV_MAX"),this.node.querySelector(".js-xp-value").textContent=this.hero.getAttribute("XP")+"/"+this.hero.getAttribute("XP_MAX"),this.node.querySelector(".js-hp-value").textContent=this.hero.getAttribute("HP")+"/"+this.hero.getAttribute("HP_MAX"),this.node.querySelector(".js-mp-value").textContent=this.hero.getAttribute("MP")+"/"+this.hero.getAttribute("MP_MAX"),this.node.querySelector(".js-atk-value").textContent=this.hero.getAttribute("ATK"),this.node.querySelector(".js-def-value").textContent=this.hero.getAttribute("DEF"),this.node.querySelector(".js-matk-value").textContent=this.hero.getAttribute("MAGIC_ATK"),this.node.querySelector(".js-mdef-value").textContent=this.hero.getAttribute("MAGIC_DEF"),this.node.querySelector(".js-agility-value").textContent=this.hero.getAttribute("AGILITY"),this.node.querySelector(".js-element-value").textContent=this.hero.getAttribute("ELEMENT"),this.node.querySelector(".js-weapon-value").textContent=t?t.getName():"Vide",this.node.querySelector(".js-helmet-value").textContent=e?e.getName():"Vide",this.node.querySelector(".js-armor-value").textContent=s?s.getName():"Vide",this.node.querySelector(".js-relic-value").textContent=i?i.getName():"Vide"}else this.node.querySelector(".js-picture").src="#",this.node.querySelector(".js-name").textContent="",this.node.querySelector(".js-lv-value").textContent="--/--",this.node.querySelector(".js-xp-value").textContent="--/--",this.node.querySelector(".js-hp-value").textContent="--/--",this.node.querySelector(".js-mp-value").textContent="--/--",this.node.querySelector(".js-atk-value").textContent="--",this.node.querySelector(".js-def-value").textContent="--",this.node.querySelector(".js-matk-value").textContent="--",this.node.querySelector(".js-mdef-value").textContent="--",this.node.querySelector(".js-agility-value").textContent="--",this.node.querySelector(".js-element-value").textContent="--",this.node.querySelector(".js-weapon-value").textContent="Vide",this.node.querySelector(".js-helmet-value").textContent="Vide",this.node.querySelector(".js-armor-value").textContent="Vide",this.node.querySelector(".js-relic-value").textContent="Vide"}setHero(t){this.hero=t||null}}class Di extends U{constructor(t){super(),this.hero=t,this.uiTitle=new lt,this.uiStatus=new th,this.handleKeyDownCb=e=>this.handleKeyDown(e)}async onEnter(){this.uiTitle.setText("Status"),g.addWidget(this.uiTitle,"position:absolute; top:0; left:0; width:100%; height:50px"),this.uiStatus.setHero(this.hero),g.addWidget(this.uiStatus,"position:absolute; top:50px; left:0; bottom:0; width:100%"),document.addEventListener("keydown",this.handleKeyDownCb)}onExit(){document.removeEventListener("keydown",this.handleKeyDownCb),g.removeWidget(this.uiTitle),g.removeWidget(this.uiStatus)}handleKeyDown(t){t.key=="Escape"&&R.requestPopScreen()}}class eh extends U{constructor(){super(),this.player=se.getPlayer(),this.uiTitle=new lt,this.uiMainMenu=new it,this.uiHeroes=new Xs}async onEnter(){this.uiTitle.setText("Menu"),g.addWidget(this.uiTitle,"position:absolute; top:0; left:0; right:0; height:50px"),this.uiMainMenu.add("ITEMS","Objets"),this.uiMainMenu.add("STUFFS","Equipements"),this.uiMainMenu.add("STATUS","Status"),g.addWidget(this.uiMainMenu,"position:absolute; top:50px; left:0; bottom:0; width:40%"),this.uiHeroes.setCollection(new _t(this.player.getHeroes())),g.addWidget(this.uiHeroes,"position:absolute; top:50px; left:40%; bottom:0; width:60%"),m.subscribe(this.uiMainMenu,"E_CLOSED",this,this.handleMainMenuClosed),m.subscribe(this.uiMainMenu,"E_ITEM_SELECTED",this,this.handleMainMenuItemSelected),m.subscribe(this.uiHeroes,"E_CLOSED",this,this.handleHeroesClosed),m.subscribe(this.uiHeroes,"E_ITEM_SELECTED",this,this.handleHeroesItemSelected),g.focus(this.uiMainMenu)}async onExit(){g.removeWidget(this.uiTitle),g.removeWidget(this.uiMainMenu),g.removeWidget(this.uiHeroes)}onBringToFront(t){g.focus(t instanceof Di?this.uiHeroes:this.uiMainMenu)}onBringToBack(){g.unfocus(),this.uiMainMenu.unselectWidgets(),this.uiHeroes.unselectWidgets()}handleMainMenuClosed(){R.requestPopScreen()}handleMainMenuItemSelected(t){t.id=="ITEMS"?R.requestPushScreen(new Qa):t.id=="STUFFS"?R.requestPushScreen(new Ja):t.id=="STATUS"&&g.focus(this.uiHeroes)}handleHeroesClosed(){this.uiMainMenu.unselectWidgets(),g.focus(this.uiMainMenu)}handleHeroesItemSelected(t){let e=this.uiHeroes.getSelectedItem();R.requestPushScreen(new Di(e))}}class Ri extends W{constructor(){super({className:"UIDescriptionList"})}addItem(t,e,s){const i=document.createElement("template");i.innerHTML=`
    <span class="UIDescriptionList-item js-${t}">
      <span class="UIDescriptionList-item-label js-label">${e}</span>
      <span class="UIDescriptionList-item-value js-value">${s}</span>
    </span>`,this.node.appendChild(i.content)}removeItem(t){const e=this.node.querySelector(".js-"+t);if(!e)throw new Error("UIDescriptionList::removeItem(): item not found !");this.node.removeChild(e)}setItem(t,e){const s=this.node.querySelector(".js-"+t);if(!s)throw new Error("UIDescriptionList::setItem(): item not found !");s.querySelector(".js-value").textContent=e}getItemValue(t){const e=this.node.querySelector(".js-"+t);if(!e)throw new Error("UIDescriptionList::getItemValue(): item not found !");const s=e.querySelector(".js-value").textContent;return s||""}isItemVisible(t){const e=this.node.querySelector(".js-"+t);if(!e)throw new Error("UIDescriptionList::getItemVisible(): item not found !");return!e.classList.contains("u-hidden")}setItemVisible(t,e){const s=this.node.querySelector(".js-"+t);if(!s)throw new Error("UIDescriptionList::setItemVisible(): item not found !");e?s.classList.remove("u-hidden"):s.classList.add("u-hidden")}clear(){this.node.innerHTML=""}}let es={COMMON_STORE:"COMMON_STORE",EQUIPMENT_STORE:"EQUIPMENT_STORE"},It={QUANTITY:0,TOTAL:1},je={GILS:0,INVENTORY:1};class Oi extends U{constructor(t){super(),this.mode=t,this.player=se.getPlayer(),this.inventory=this.player.getInventory(),this.shopInventory=new _r,this.uiText=new lt,this.uiTitle=new lt,this.uiDescription=new lt,this.uiInventory=new us({showPrice:!0,showQuantity:!1}),this.uiPlayerDesc=new Ri,this.uiCheckoutDesc=new Ri,this.uiHeroes=t==es.COMMON_STORE?new Xs:new Rr,this.handleKeyDownCb=e=>this.handleKeyDown(e)}async onEnter(t={inventoryId}){await this.shopInventory.loadFromFile("samples/rpg/data/inventory_"+t.inventoryId+"/data.json"),this.uiText.setText("Que voulez-vous acheter ?"),g.addWidget(this.uiText,"position:absolute; top:0px; left:0; width:70%; height:50px;"),this.uiTitle.setText("Magasin"),g.addWidget(this.uiTitle,"position:absolute; top:0; left:70%; width:30%; height:50px;"),this.uiDescription.setText("Description..."),g.addWidget(this.uiDescription,"position:absolute; top:50px; left:0; width:100%; height:50px;"),this.uiInventory.setCollection(this.shopInventory),g.addWidget(this.uiInventory,"position:absolute; top:100px; left:0; bottom:0; width:50%;"),this.uiPlayerDesc.addItem(je.GILS,"Gils",this.player.getGils()),this.uiPlayerDesc.addItem(je.INVENTORY,"Inventaire",0),g.addWidget(this.uiPlayerDesc,"position:absolute; top:100px; left:50%; width:50%; height:84px"),this.uiCheckoutDesc.setVisible(!1),this.uiCheckoutDesc.addItem(It.QUANTITY,"Quantite",0),this.uiCheckoutDesc.addItem(It.TOTAL,"Total",0),g.addWidget(this.uiCheckoutDesc,"position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); z-index:10;"),this.uiHeroes.setCollection(new _t(this.player.getHeroes())),g.addWidget(this.uiHeroes,"position:absolute; top:184px; left:50%; bottom:0; width:50%;"),m.subscribe(this.uiInventory,"E_CLOSED",this,this.handleInventoryClosed),m.subscribe(this.uiInventory,"E_ITEM_FOCUSED",this,this.handleInventoryItemFocused),m.subscribe(this.uiInventory,"E_ITEM_SELECTED",this,this.handleInventoryItemSelected),g.focus(this.uiInventory)}async onExit(){document.removeEventListener("keydown",this.handleKeyDownCb),g.removeWidget(this.uiText),g.removeWidget(this.uiTitle),g.removeWidget(this.uiDescription),g.removeWidget(this.uiInventory),g.removeWidget(this.uiPlayerDesc),g.removeWidget(this.uiCheckoutDesc),g.removeWidget(this.uiHeroes)}handleInventoryClosed(){R.requestPopScreen()}handleInventoryItemFocused(t){let e=this.uiInventory.getFocusedItem(),i=this.inventory.getItems().find(r=>r.getId()==e.getId());if(this.uiDescription.setText(e.description),this.uiPlayerDesc.setItem(je.INVENTORY,i?i.quantity:"0"),this.mode==es.COMMON_STORE)for(let r of this.uiHeroes.getWidgets()){let n=r.getHero();r.setEnabled(e.isTarget(n,n))}else for(let r of this.uiHeroes.getWidgets()){let n=r.getHero();r.setEquipmentItem(e),r.setEnabled(n.isEquipableItem(e))}}handleInventoryItemSelected(){this.uiCheckoutDesc.setVisible(!0),g.focus(this.uiCheckoutDesc),document.addEventListener("keydown",this.handleKeyDownCb)}handleKeyDown(t){let e=this.uiInventory.getSelectedItem(),s=parseInt(this.uiCheckoutDesc.getItemValue(It.QUANTITY));if(t.key=="ArrowUp"){let i=s+1;this.uiCheckoutDesc.setItem(It.QUANTITY,i),this.uiCheckoutDesc.setItem(It.TOTAL,i*e.getPrice())}else if(t.key=="ArrowDown"&&s>0){let i=s-1;this.uiCheckoutDesc.setItem(It.QUANTITY,i),this.uiCheckoutDesc.setItem(It.TOTAL,i*e.getPrice())}else if(t.key=="Enter"){let i=s*e.getPrice();if(this.player.getGils()-i<0)return;e.setQuantity(s),this.player.decreaseGils(i),this.inventory.addItem(e),this.uiPlayerDesc.setItem(je.GILS,this.player.getGils()),this.uiCheckoutDesc.setItem(It.QUANTITY,0),this.uiCheckoutDesc.setItem(It.TOTAL,0),this.uiCheckoutDesc.setVisible(!1),this.uiInventory.unselectWidgets(),g.focus(this.uiInventory),document.removeEventListener("keydown",this.handleKeyDownCb)}else t.key=="Escape"&&(this.uiCheckoutDesc.setItem(It.QUANTITY,0),this.uiCheckoutDesc.setItem(It.TOTAL,0),this.uiCheckoutDesc.setVisible(!1),this.uiInventory.unselectWidgets(),g.focus(this.uiInventory),document.removeEventListener("keydown",this.handleKeyDownCb))}}class sh extends U{constructor(){super(),this.uiMenu=new it}async onEnter(){await se.init(),this.uiMenu.add("0","Battle"),this.uiMenu.add("1","Menu"),this.uiMenu.add("2","Shop items"),this.uiMenu.add("3","Shop stuff"),g.addWidget(this.uiMenu,"position:absolute; top:50%; left:50%; width:60%; transform:translate(-50%,-50%);"),m.subscribe(this.uiMenu,"E_ITEM_SELECTED",this,this.handleMenuItemSelected),g.focus(this.uiMenu)}onExit(){g.removeWidget(this.uiMenu)}onBringToFront(){this.uiMenu.setVisible(!0),g.focus(this.uiMenu)}onBringToBack(){this.uiMenu.setVisible(!1),this.uiMenu.unselectWidgets()}handleMenuItemSelected(t){t.id==0?R.requestPushScreen(new Za,{battleId:"0000"}):t.id==1?R.requestPushScreen(new eh):t.id==2?R.requestPushScreen(new Oi(es.COMMON_STORE),{inventoryId:"0000"}):t.id==3&&R.requestPushScreen(new Oi(es.EQUIPMENT_STORE),{inventoryId:"0001"})}}class ih extends Jt{movementSpeed;rotationSpeed;frictionCoefficient;velocity;maxPitch;minPitch;constructor(t){super(t),this.movementSpeed=10,this.rotationSpeed=2,this.frictionCoefficient=.99,this.velocity=[0,0,0],this.maxPitch=Math.PI*.5-.01,this.minPitch=Math.PI*-.5+.01,m.subscribe(M,"E_MOUSE_DRAG",this,this.$handleMouseDrag)}delete(){m.unsubscribe(M,"E_MOUSE_DRAG",this)}update(t){const e=this.getAxies();let s=[0,0,0];M.isActiveAction("LEFT")&&(s=c.VEC3_ADD_SCALED(s,e[0],-this.movementSpeed)),M.isActiveAction("RIGHT")&&(s=c.VEC3_ADD_SCALED(s,e[0],+this.movementSpeed)),M.isActiveAction("UP")&&(s=c.VEC3_ADD_SCALED(s,e[2],-this.movementSpeed)),M.isActiveAction("DOWN")&&(s=c.VEC3_ADD_SCALED(s,e[2],+this.movementSpeed)),this.velocity=c.LINEAR_VEC3(Math.pow(1-this.frictionCoefficient,t/1e3),s,this.velocity);const i=c.VEC3_SCALE(this.velocity,t/1e3);this.translate(i[0],i[1],i[2])}setMovementSpeed(t){this.movementSpeed=t}setRotationSpeed(t){this.rotationSpeed=t}setFrictionCoefficient(t){this.frictionCoefficient=t}setMaxPitch(t){this.maxPitch=t}setMinPitch(t){this.minPitch=t}getMovementSpeed(){return this.movementSpeed}getRotationSpeed(){return this.rotationSpeed}getFrictionCoefficient(){return this.frictionCoefficient}getMaxPitch(){return this.maxPitch}getMinPitch(){return this.minPitch}$handleMouseDrag(t){let e=this.rotation[0]+t.movementY/1e3*this.rotationSpeed,s=this.rotation[1]+t.movementX/1e3*this.rotationSpeed;s=s%(Math.PI*2),e=c.CLAMP(e,this.minPitch,this.maxPitch),this.setRotation(e,s,0)}}const Is=100,rh=100,Li=5;class nh{constructor(t=[0,0,0],e=[0,0,0],s=[0,0,0]){this.p=t,this.a=e,this.s=s,this.q=new b,this.m=c.MAT4_IDENTITY()}}class oh extends U{constructor(){super(),this.camera=new ih(0),this.mode=1,this.colFac=0,this.obj=null,this.bigMesh=null,this.skySphere=null,this.transformations=[],this.handleKeyUpCb=this.handleKeyUp.bind(this)}async onEnter(){const t=v.getView(0);t.setPerspectiveFar(700),t.setPerspectiveNear(.1),this.camera.setPosition(0,10,0),this.skySphere=new G,await this.skySphere.loadFromFile("./samples/perf/sky_sphere.jsm"),this.skySphere.setMaterial(new $({texture:await D.loadTexture("./samples/perf/sky_sphere.jpg")})),this.obj=new G,await this.obj.loadFromFile("./samples/perf/cube.jsm"),this.obj.setMaterial(new $({texture:await D.loadTexture("./samples/perf/cube.png"),lightning:!0}));for(let s=0;s<rh;s++)for(let i=0;i<Is;i++){const r=(i-Is/2)*Li,n=(s-Is/2)*Li,a=[r,0,n,1],h=[i,0,s],l=[1,1,1];this.transformations.push(new nh(a,h,l))}const e=this.transformations.map(s=>c.MAT4_TRANSFORM(s.p,s.a,s.s,s.q));this.bigMesh=ah(this.obj,e),document.addEventListener("keyup",this.handleKeyUpCb)}onExit(){document.removeEventListener("keyup",this.handleKeyUpCb)}update(t){const e=(Math.sin(this.colFac)+1)*.5,s=(Math.cos(this.colFac)+1)*.5;this.obj.mat.setSpecular(e,s,0),this.obj.mat.setDiffuse(0,e,s);const i=Math.PI*2*4/this.transformations.length;let r=0;for(const n of this.transformations)n.a[0]+=t/500,n.a[2]+=t/1e3,n.p[1]=Math.sin(r+this.colFac)*3,c.MAT4_TRANSFORM(n.p,n.a,n.s,n.q,n.m),r+=i;this.colFac+=t*.003,this.camera.update(t)}draw(){if(ht.drawDirLight([0,-1,.2],[1,1,1],[.8,.6,.4],[.8,.6,.4]),this.skySphere.draw(),this.mode==0)this.bigMesh.draw();else for(const t of this.transformations)ht.drawMesh(this.obj,t.m)}handleKeyUp(t){t.code==="KeyR"&&(this.mode=this.mode==1?0:1)}}function ah(o,t){const e=new xt,s=o.getVertices();e.beginVertices(o.getVertexCount()*t.length);for(const i of t)for(let r=0;r<s.length;r+=F){const n=c.MAT4_MULTIPLY_BY_VEC4(i,c.VEC4_CREATE(s[r+0],s[r+1],s[r+2],1));e.defineVertex(n[0],n[1],n[2],s[r+3],s[r+4],s[r+5],s[r+6],s[r+7],s[r+8],s[r+9],s[r+10],s[r+11],s[r+12],s[r+13],s[r+14],s[r+15],s[r+16])}return e.endVertices(),e.setMaterial(o.getMaterial()),e}class Or{times;values;fns;defaultFn;constructor(t,e,s,i=[]){this.times=t,this.values=e,this.fns=i,this.defaultFn=s}interpolate(t){let e=0,s=this.times.length;for(;e<s&&t>this.times[e];)e++;if(e==0)return this.values[0];if(e==s)return this.values[s-1];const i=this.values[e-1],r=this.values[e],n=t-this.times[e-1],a=this.times[e]-this.times[e-1];return this.fns[e]?this.fns[e](n,i,r,a):this.defaultFn(n,i,r,a)}isEmpty(){return this.times.length==0||this.values.length==0}}class tt extends Or{constructor(t=[],e=[],s=[]){super(t,e,c.LINEAR,s)}}class kt extends Or{constructor(t=[],e=[],s=[]){super(t,e,c.LINEAR_VEC3,s)}}const hh=[[0,0],[0,1],[1,0],[1,1]],Ni=[0,1,2,2,1,3],lh=[[-1,-1,0],[-1,1,0],[1,-1,0],[1,1,0]];var Et=(o=>(o.CLASSIC="CLASSIC",o.EXPLODE="EXPLODE",o))(Et||{}),Ct=(o=>(o.CUBE="CUBE",o.SPHERE="SPHERE",o))(Ct||{});class ch{position;velocity;acceleration;accelerationTween;angle;angleVelocity;angleAcceleration;size;sizeTween;color;colorTween;opacity;opacityTween;age;alive;constructor(){this.position=[0,0,0],this.velocity=[0,0,0],this.acceleration=[0,0,0],this.accelerationTween=new kt,this.angle=0,this.angleVelocity=0,this.angleAcceleration=0,this.size=16,this.sizeTween=new tt,this.color=[0,0,0],this.colorTween=new kt,this.opacity=1,this.opacityTween=new tt,this.age=0,this.alive=0}update(t){this.position=c.VEC3_ADD(this.position,c.VEC3_SCALE(this.velocity,t/1e3)),this.velocity=c.VEC3_ADD(this.velocity,c.VEC3_SCALE(this.acceleration,t/1e3)),this.angle+=this.angleVelocity*c.DEG_TO_RAD_RATIO*(t/1e3),this.angleVelocity+=this.angleAcceleration*c.DEG_TO_RAD_RATIO*(t/1e3),this.age+=t/1e3,this.sizeTween.isEmpty()||(this.size=this.sizeTween.interpolate(this.age)),this.colorTween.isEmpty()||(this.color=this.colorTween.interpolate(this.age)),this.opacityTween.isEmpty()||(this.opacity=this.opacityTween.interpolate(this.age)),this.accelerationTween.isEmpty()||(this.acceleration=this.accelerationTween.interpolate(this.age))}}class uh extends xe{textureChanged;positionStyle;positionBase;positionSpread;positionSphereRadiusBase;positionRadiusSpread;velocityStyle;velocityBase;velocitySpread;velocityExplodeSpeedBase;velocityExplodeSpeedSpread;colorBase;colorSpread;colorTween;sizeBase;sizeSpread;sizeTween;opacityBase;opacitySpread;opacityTween;accelerationBase;accelerationSpread;accelerationTween;angleBase;angleSpread;angleVelocityBase;angleVelocitySpread;angleAccelerationBase;angleAccelerationSpread;particleDeathAge;particlesPerSecond;particleQuantity;particleAlivedCount;particleArray;emitterDeathAge;emitterAge;emitterAlive;grp2;texture;constructor(t){super(Ki),this.textureChanged=!1,this.positionStyle=t.positionStyle??"CUBE",this.positionBase=t.positionBase??[0,0,0],this.positionSpread=t.positionSpread??[0,0,0],this.positionSphereRadiusBase=t.positionSphereRadiusBase??0,this.positionRadiusSpread=t.positionRadiusSpread??0,this.velocityStyle=t.velocityStyle??"CLASSIC",this.velocityBase=t.velocityBase??[0,0,0],this.velocitySpread=t.velocitySpread??[0,0,0],this.velocityExplodeSpeedBase=t.velocityExplodeSpeedBase??0,this.velocityExplodeSpeedSpread=t.velocityExplodeSpeedSpread??0,this.colorBase=t.colorBase??[0,1,.5],this.colorSpread=t.colorSpread??[0,0,0],this.colorTween=t.colorTween??new kt,this.sizeBase=t.sizeBase??1,this.sizeSpread=t.sizeSpread??0,this.sizeTween=t.sizeTween??new tt,this.opacityBase=t.opacityBase??1,this.opacitySpread=t.opacitySpread??0,this.opacityTween=t.opacityTween??new tt,this.accelerationBase=t.accelerationBase??[0,0,0],this.accelerationSpread=t.accelerationSpread??[0,0,0],this.accelerationTween=t.accelerationTween??new kt,this.angleBase=t.angleBase??0,this.angleSpread=t.angleSpread??0,this.angleVelocityBase=t.angleVelocityBase??0,this.angleVelocitySpread=t.angleVelocitySpread??0,this.angleAccelerationBase=t.angleAccelerationBase??0,this.angleAccelerationSpread=t.angleAccelerationSpread??0,this.particleDeathAge=t.particleDeathAge??1,this.particlesPerSecond=t.particlesPerSecond??30,this.particleQuantity=t.particleQuantity??100,this.particleAlivedCount=0,this.particleArray=[],this.emitterDeathAge=t.emitterDeathAge??60,this.emitterAge=0,this.emitterAlive=!0,this.grp2=v.createStaticGroup("PARTICLES_PIPELINE",2),this.texture=this.grp2.setTexture(0,"TEXTURE",t.texture??v.createTextureFromBitmap()),this.texture=this.grp2.setSampler(1,"SAMPLER",this.texture);for(let e=0;e<this.particleQuantity;e++)this.particleArray[e]=this.$createParticle();this.grp2.allocate()}delete(){this.grp2.delete(),super.delete()}update(t){this.$updateLifeCycle(t),this.$updateGeometry(t)}draw(){Ji.drawParticles(this)}setTexture(t){this.texture=t,this.textureChanged=!0}getTexture(){return this.texture}getGroup02(){return this.textureChanged&&(this.grp2.setTexture(0,"TEXTURE",this.texture),this.grp2.allocate(),this.textureChanged=!1),this.grp2}$updateLifeCycle(t){const e=[];for(let s=0;s<this.particleQuantity;s++)this.particleArray[s].alive&&(this.particleArray[s].update(t),this.particleArray[s].age>this.particleDeathAge&&(this.particleArray[s].alive=0,this.particleAlivedCount--,e.push(s)));if(!!this.emitterAlive){if(this.emitterAge<this.particleDeathAge){let s=Math.round(this.particlesPerSecond*(this.emitterAge+0)),i=Math.round(this.particlesPerSecond*(this.emitterAge+t/1e3));i>this.particleQuantity&&(i=this.particleQuantity);for(let r=s;r<i;r++)this.particleArray[r].alive=1,this.particleAlivedCount++}for(let s=0;s<e.length;s++){const i=e[s];this.particleArray[i]=this.$createParticle(),this.particleArray[i].alive=1,this.particleAlivedCount++}this.emitterAge+=t/1e3,this.emitterAge>this.emitterDeathAge&&(this.emitterAlive=!1)}}$updateGeometry(t){this.beginVertices(this.particleAlivedCount*6);for(let e=0;e<this.particleQuantity;e++)if(this.particleArray[e].alive){const s=this.particleArray[e].position,i=this.particleArray[e].color,r=this.particleArray[e].size,n=this.particleArray[e].opacity,a=this.particleArray[e].angle,h=this.particleArray[e].alive;for(let l=0;l<6;l++){const u=lh[Ni[l]],d=hh[Ni[l]];this.defineVertex(u[0],u[1],u[2],s[0],s[1],s[2],d[0],d[1],i[0],i[1],i[2],r,n,a,h)}}this.endVertices()}$createParticle(){const t=new ch;if(this.positionStyle=="CUBE")t.position=c.VEC3_SPREAD(this.positionBase,this.positionSpread);else if(this.positionStyle=="SPHERE"){const e=c.SPREAD(this.positionSphereRadiusBase,this.positionRadiusSpread),s=Math.PI*2*Math.random(),i=Math.PI*2*Math.random(),r=e*Math.cos(s);t.position=c.VEC3_ADD(this.positionBase,[r*Math.cos(i),e*Math.sin(s),r*Math.sin(i)])}if(this.velocityStyle=="CLASSIC")t.velocity=c.VEC3_SPREAD(this.velocityBase,this.velocitySpread);else if(this.velocityStyle=="EXPLODE"){const e=c.VEC3_SUBSTRACT(t.position,this.positionBase),s=c.SPREAD(this.velocityExplodeSpeedBase,this.velocityExplodeSpeedSpread);t.velocity=c.VEC3_SCALE(c.VEC3_NORMALIZE(e),s)}return t.color=c.VEC3_SPREAD(this.colorBase,this.colorSpread),t.colorTween=this.colorTween,t.size=c.SPREAD(this.sizeBase,this.sizeSpread),t.sizeTween=this.sizeTween,t.opacity=c.SPREAD(this.opacityBase,this.opacitySpread),t.opacityTween=this.opacityTween,t.acceleration=c.VEC3_SPREAD(this.accelerationBase,this.accelerationSpread),t.accelerationTween=this.accelerationTween,t.angle=c.SPREAD(this.angleBase,this.angleSpread),t.angleVelocity=c.SPREAD(this.angleVelocityBase,this.angleVelocitySpread),t.angleAcceleration=c.SPREAD(this.angleAccelerationBase,this.angleAccelerationSpread),t.age=0,t.alive=0,t}}await D.loadTexture("./textures/star.png"),Ct.CUBE,Et.CLASSIC,new kt([.5,2],[[0,1,.5],[.8,1,.5]]),new tt([0,1],[1,20]),new tt([2,3],[1,0]),360*4;await D.loadTexture("./textures/smokeparticle.png"),Ct.SPHERE,Et.EXPLODE,new tt([0,.1],[1,150]),new tt([.7,1],[1,0]);await D.loadTexture("./textures/smokeparticle.png"),Ct.CUBE,Et.CLASSIC,new kt([.4,1],[[0,0,.2],[0,0,.5]]),new tt([0,1],[32,128]),new tt([.8,2],[.5,0]);await D.loadTexture("./textures/smokeparticle.png"),Ct.CUBE,Et.CLASSIC,new tt([0,1,4,5],[0,1,1,0]);await D.loadTexture("./textures/snowflake.png"),Ct.CUBE,Et.CLASSIC,new tt([0,.25],[1,10]),new tt([2,3],[.8,0]);await D.loadTexture("./textures/raindrop2flip.png"),Ct.CUBE,Et.CLASSIC;await D.loadTexture("./textures/spikey.png"),Ct.CUBE,Et.CLASSIC;await D.loadTexture("./textures/spark.png"),Ct.CUBE,Et.CLASSIC,new tt([0,1,1.1,2,2.1,3,3.1,4,4.1,5,5.1,6,6.1],[.2,.2,1,1,.2,.2,1,1,.2,.2,1,1,.2]);await D.loadTexture("./textures/spikey.png"),Ct.CUBE,Et.CLASSIC;const dh={texture:await D.loadTexture("./textures/spark.png"),positionStyle:Ct.SPHERE,positionBase:[0,100,0],positionSphereRadiusBase:2,velocityStyle:Et.EXPLODE,velocityExplodeSpeedBase:10,velocityExplodeSpeedSpread:10,colorTween:new kt([.4,.8,1],[[0,1,1],[0,1,.6],[.8,1,.6]]),sizeTween:new tt([.5,.7,1.3],[2,3,1]),opacityTween:new tt([.2,.7,2.5],[.75,1,0]),accelerationBase:[0,-80,0],particlesPerSecond:3e3,particleDeathAge:2.5,emitterDeathAge:600},ph={texture:await D.loadTexture("./textures/smokeparticle.png"),positionStyle:Ct.SPHERE,positionBase:[0,5,0],positionSphereRadiusBase:1,velocityStyle:Et.CLASSIC,velocityBase:[0,30,0],velocitySpread:[20,0,20],colorTween:new kt([.5,1],[[1,0,0],[0,1,0]]),sizeTween:new tt([0,.3,1.2],[2,6,2]),opacityTween:new tt([.9,1.5],[1,0]),particleDeathAge:1.5,emitterDeathAge:600};class mh extends U{constructor(){super(),this.camera=new Jt(0),this.skySphere=null,this.floor=null,this.particles0=null,this.particles1=null,this.colFac=0}async onEnter(){this.camera.setPosition(0,40,0),this.camera.setRotation(.15,0,0),this.skySphere=await fh(),this.floor=await gh(0,0,-100),this.particles0=await Fi(ph),this.particles1=await Fi(dh)}update(t){this.floor.rotate(0,t*.001,0),this.floor.update(t),this.skySphere.update(t),this.particles0.update(t),this.particles1.update(t),this.colFac+=t*.003}draw(){this.skySphere.draw(),this.floor.draw(),this.particles0.draw(),this.particles1.draw(),ht.drawDirLight([0,-1,.2],[1,1,1],[.8,.8,.8],[.8,.8,.8]),ht.drawPointLight([Math.cos(this.colFac*.2)*45,18,Math.cos(this.colFac*.2)*45],[0,0,0],[.8,.8,.4],[.8,.8,.4]),ht.drawPointLight([Math.sin(this.colFac*.2)*45,18,Math.sin(this.colFac*.2)*45],[0,0,0],[.8,.8,.4],[.8,.8,.4])}}async function fh(){const o=new G;return await o.loadFromFile("./samples/particles/sky_sphere.jsm"),o.setMaterial(new $({texture:await D.loadTexture("./samples/particles/sky_sphere.jpg")})),o}async function gh(o,t,e){const s=new G;return s.setPosition(o,t,e),await s.loadFromFile("./samples/particles/floor.jsm"),s.setMaterial(new $({lightning:!0,texture:await D.loadTexture("./samples/particles/floor.jpg"),normalMap:await D.loadTexture("./samples/particles/floor_normal_map.jpg"),specularityMap:await D.loadTexture("./samples/particles/floor_specularity_map.jpg")})),s}async function Fi(o){return new uh(Object.assign(o,{positionBase:[0,10,-100],particleQuantity:100}))}const be="default",Eh={id:be,muted:!1,volume:1};class Ch{sounds;soundGroups;constructor(){this.sounds=new Map,this.soundGroups=[Eh]}async loadSound(t,e=be){return new Promise(s=>{const i={audio:new Audio(t),groupId:e};i.audio.addEventListener("canplaythrough",()=>{this.sounds.set(t,i),s(i)})})}deleteSound(t){if(!this.sounds.has(t))throw new Error("SoundManager::deleteSound(): The sound file doesn't exist, cannot delete !");const e=this.sounds.get(t);e.audio.src="",this.sounds.delete(t)}playSound(t,e=!1){if(!this.sounds.has(t))throw new Error("SoundManager::play(): The sound file doesn't exist, cannot play !");const s=this.sounds.get(t);return s.audio.loop=e,s.audio.play()}pauseSound(t){if(!this.sounds.has(t))throw new Error("SoundManager::pause(): The sound file doesn't exist, cannot pause !");this.sounds.get(t).audio.pause()}releaseSounds(){for(const t of this.sounds.keys()){const e=this.sounds.get(t);e.audio.src="",this.sounds.delete(t)}}mute(t,e=be){const s=this.soundGroups.find(i=>i.id==e);if(!s)throw new Error("SoundManager::mute(): Group not found !");for(const i of this.sounds.values())i.groupId==e&&(i.audio.muted=t);s.muted=t}setVolume(t,e=be){const s=this.soundGroups.find(i=>i.id==e);if(!s)throw new Error("SoundManager::setVolume(): Group not found !");for(const i of this.sounds.values())i.groupId==e&&(i.audio.volume=t);s.volume=t}isMuted(t=be){const e=this.soundGroups.find(s=>s.id==t);if(!e)throw new Error("SoundManager::isMuted(): Group not found !");return e.muted}}const Th=new Ch;class Ah{entityIndex;entities;systems;constructor(){this.entityIndex=0,this.entities=new Map,this.systems=[],m.subscribe(M,"E_ACTION",this,t=>{for(let e of this.systems)e.action(t.actionId)}),m.subscribe(M,"E_ACTION_ONCE",this,t=>{for(let e of this.systems)e.actionOnce(t.actionId)})}update(t){for(const e of this.systems)e.update(t)}draw(){for(const t of this.systems)t.draw()}setup(t){this.entityIndex=0,this.entities.clear(),this.systems=t}reset(){this.entityIndex=0,this.entities.clear(),this.systems=[]}createEntity(){return this.entities.set(this.entityIndex,new Map),this.entityIndex++}removeEntity(t){if(!this.entities.get(t))throw new Error("DNAManager::removeEntity(): Entity not found");this.entities.delete(t);for(const s of this.systems)s.hasEntity(t)&&s.unbindEntity(t)}hasEntity(t){return this.entities.has(t)}findEntities(t){const e=Array();for(let[s,i]of this.entities)i.has(t)&&e.push(s);return e}findEntity(t){for(let[e,s]of this.entities)if(s.has(t))return e;return-1}addComponent(t,e){const s=this.entities.get(t);if(!s)throw new Error("DNAManager::addComponent(): Entity not found");if(s.has(e.getTypename()))throw new Error("ECSEntity::addComponent(): Entity already has "+e.getTypename());s.set(e.getTypename(),e);for(const r of this.systems)r.isMatchingComponentRequirements(s.values())&&!r.hasEntity(t)&&r.bindEntity(t)}removeComponent(t,e){const s=this.entities.get(t);if(!s)throw new Error("DNAManager::removeComponent(): Entity not found");if(!s.has(e))throw new Error("DNAManager::removeComponent(): Entity has not "+e);s.delete(e);for(const r of this.systems)!r.isMatchingComponentRequirements(s.values())&&r.hasEntity(t)&&r.unbindEntity(t)}removeComponentIfExist(t,e){return this.hasComponent(t,e)?(this.removeComponent(t,e),!0):!1}getComponent(t,e){const s=this.entities.get(t);if(!s)throw new Error("DNAManager::getComponent(): Entity not found");const i=s.get(e);if(!i)throw new Error("DNAManager::getComponent(): Entity has not "+e);return i}getComponents(t){const e=this.entities.get(t);if(!e)throw new Error("DNAManager::getEntity(): Entity not found");return e}hasComponent(t,e){const s=this.entities.get(t);if(!s)throw new Error("DNAManager::hasComponent(): Entity not found");return s.has(e)}getSystems(){return this.systems}findSystems(t){return this.systems.filter(e=>e.hasTag(t))}}const f=new Ah;class wt extends ft{texture;textureRect;flip;constructor(){super(),this.texture=N.getDefaultTexture(),this.textureRect=[0,0,0,0],this.flip=[!1,!1]}async loadFromFile(t){const s=await(await fetch(t)).json();this.textureRect[0]=s.X,this.textureRect[1]=s.Y,this.textureRect[2]=s.Width,this.textureRect[3]=s.Height,this.offset[0]=s.OffsetX??0,this.offset[1]=s.OffsetY??0,this.flip[0]=s.FlipX??!1,this.flip[1]=s.FlipY??!1,this.boundingRect=rt.createFromCoord(s.X,s.Y,s.Width,s.Height)}paint(){const t=N.getContext();t.scale(this.flip[0]?-1:1,this.flip[1]?-1:1),t.drawImage(this.texture,this.textureRect[0],this.textureRect[1],this.textureRect[2],this.textureRect[3],this.flip[0]?this.textureRect[2]*-1:0,this.flip[1]?this.textureRect[3]*-1:0,this.textureRect[2],this.textureRect[3])}getTextureRect(){return this.textureRect}getTextureRectWidth(){return this.textureRect[2]}getTextureRectHeight(){return this.textureRect[3]}setTextureRect(t,e,s,i){this.textureRect=[t,e,s,i]}setOffsetNormalized(t,e){this.offset[0]=this.textureRect[2]*t,this.offset[1]=this.textureRect[3]*e}getFlip(){return this.flip}setFlipX(t){this.flip[0]=t}setFlipY(t){this.flip[1]=t}setTexture(t){this.textureRect[2]==0&&this.textureRect[3]==0&&(this.textureRect[2]=t.width,this.textureRect[3]=t.height,this.boundingRect=rt.createFromCoord(this.textureRect[0],this.textureRect[1],this.textureRect[2],this.textureRect[3])),this.texture=t}getTexture(){return this.texture}clone(t=new wt){return super.clone(t),t.texture=this.texture,t.textureRect=[this.textureRect[0],this.textureRect[1],this.textureRect[2],this.textureRect[3]],t.flip=[this.flip[0],this.flip[1]],t}}class Y{eids;requiredComponentTypenames;paused;tags;constructor(t=[]){this.eids=new Array,this.requiredComponentTypenames=new Set,this.paused=!1,this.tags=t}update(t){if(!this.paused){this.onBeforeUpdate(t);for(const e of this.eids)this.onEntityUpdate(t,e);this.onAfterUpdate(t)}}draw(){for(const t of this.eids)this.onEntityDraw(t)}action(t){for(const e of this.eids)this.onAction(t,e)}actionOnce(t){for(const e of this.eids)this.onActionOnce(t,e)}bindEntity(t){if(this.eids.indexOf(t)!=-1)throw new Error("DNASystem::bindEntity(): Entity already exist in this system");this.eids.push(t),this.onEntityBind(t)}unbindEntity(t){if(this.eids.indexOf(t)==-1)throw new Error("DNASystem::unbindEntity(): Entity not exist in this system");this.eids.splice(this.eids.indexOf(t),1),this.onEntityUnbind(t)}hasEntity(t){return this.eids.indexOf(t)!=-1}addRequiredComponentTypename(t){if(this.requiredComponentTypenames.has(t))throw new Error("DNASystem::addRequiredComponentTypename(): Required typename already set in this system");this.requiredComponentTypenames.add(t)}isMatchingComponentRequirements(t){let e=this.requiredComponentTypenames.size,s=0;for(const i of t)this.requiredComponentTypenames.has(i.getTypename())&&s++;return s==e}pause(){this.paused=!0}resume(){this.paused=!1}getTags(){return this.tags}hasTag(t){return this.tags.indexOf(t)!=-1}onAction(t,e){}onActionOnce(t,e){}onBeforeUpdate(t){}onEntityUpdate(t,e){}onAfterUpdate(t){}onEntityDraw(t){}onEntityBind(t){}onEntityUnbind(t){}}const _s=100,de=["naruto","kakashi","sasuke","sakura","deidara","pain","jugo","suigetsu","karin","sai"];class Bi extends W{constructor(){super({className:"UIHealthBar",template:`
      <img class="UIHealthBar-picture js-picture"/>
      <div class="UIHealthBar-content">
        <div class="UIHealthBar-bar js-bar">
          <div class="UIHealthBar-bar-progress js-progress">
            <div class="UIHealthBar-bar-progress-life js-progress-life"></div>
          </div>
        </div>
        <div class="UIHealthBar-name js-name"></div>
      </div>`})}setHealth(t){const e=this.node.querySelector(".js-progress"),s=this.node.querySelector(".js-progress-life"),i=t/_s;s.style.width=e.clientWidth*i+"px"}setPicture(t){const e=this.node.querySelector(".js-picture");e.src=t}setName(t){this.node.querySelector(".js-name").textContent=t}}class Ih extends Y{constructor(t){super(),super.addRequiredComponentTypename("Damage"),super.addRequiredComponentTypename("Fighter"),this.healthBar1=new Bi,g.addWidget(this.healthBar1,"position: absolute; left: 0;"),this.healthBar1.setName("Player 1"),this.healthBar1.setPicture("samples/fight/chars/"+t[0]+"/avatar.jpg"),this.healthBar1.setHealth(_s),this.healthBar2=new Bi,g.addWidget(this.healthBar2,"position: absolute; right: 0; flex-direction: row-reverse;"),this.healthBar2.setName("Player 2"),this.healthBar2.setPicture("samples/fight/chars/"+t[1]+"/avatar.jpg"),this.healthBar2.setHealth(_s)}onEntityBind(t){const e=f.getComponent(t,"Damage"),s=f.getComponent(t,"Fighter");s.id==1?this.healthBar1.setHealth(s.health-e.damageHP):s.id==2&&this.healthBar2.setHealth(s.health-e.damageHP)}}class k{typename;constructor(t){this.typename=t}getTypename(){return this.typename}}class yh extends k{constructor(){super("Camera")}}class vh extends Y{constructor(t,e){super(),this.bgWidth=t,this.bgHeight=e,super.addRequiredComponentTypename("Camera")}onEntityUpdate(t,e){const s=f.findEntities("Fighter");let i=1/0,r=1/0,n=0,a=0;for(let y of s){const C=f.getComponent(y,"Position");i>C.x&&(i=C.x),n<C.x&&(n=C.x),r>C.y&&(r=C.y),a<C.y&&(a=C.y)}const h=n-i+88*2,l=a-r+88*2,u=N.getWidth()*.5,d=N.getHeight()*.5,p=c.CLAMP(N.getWidth()/h,1,1.3),E=c.CLAMP(N.getHeight()/l,1,1.3),T=Math.min(p,E);let A=i+(n-i)/2,x=r+(a-r)/2;A<u/T?A=u/T:A>this.bgWidth-u/T&&(A=this.bgWidth-u/T),x<d/T?x=d/T:x>this.bgHeight-d/T&&(x=this.bgHeight-d/T),N.setCameraScale(T,T),N.setCameraPosition(A,x)}}class xh extends k{constructor(){super("JumpControls")}}class ds extends k{constructor(t,e=5,s=1){super("Jump"),this.doubleJumpGapTime=e,this.numJump=s,this.accelerationY=t,this.createdAt=Date.now()}}class Sh extends Y{constructor(){super(),super.addRequiredComponentTypename("JumpControls"),super.addRequiredComponentTypename("Jump")}onEntityUpdate(t,e){const s=f.getComponent(e,"Move");M.isActiveAction("LEFT")?s.direction=-1:M.isActiveAction("RIGHT")&&(s.direction=1)}onActionOnce(t,e){const s=f.getComponent(e,"Jump"),i=f.getComponent(e,"Move"),r=Date.now()-s.createdAt;t=="UP"&&r>s.doubleJumpGapTime&&i.velocityY<0&&s.numJump<=1&&(i.velocityY=0,f.removeComponent(e,"Jump"),f.addComponent(e,new ds(-15,3,2)))}}class wh extends Y{constructor(){super(),super.addRequiredComponentTypename("Jump"),super.addRequiredComponentTypename("Move"),super.addRequiredComponentTypename("Drawable"),super.addRequiredComponentTypename("Gravity")}onEntityBind(t){const e=f.getComponent(t,"Jump"),s=f.getComponent(t,"Move"),i=f.getComponent(t,"Drawable");s.velocityY+=e.accelerationY,i.jas.play("JUMP",!1,!0)}onEntityUpdate(t,e){const s=f.getComponent(e,"Move"),i=f.getComponent(e,"Drawable"),r=f.getComponent(e,"Gravity");s.velocityY>0&&i.jas.play("FALLOF",!1,!0),s.velocityY==0&&r.onFloor&&(f.removeComponent(e,"Jump"),f.addComponent(e,new Nt))}}class Mh extends k{constructor(){super("RunControls")}}class Lr extends k{constructor(t){super("Run"),this.speed=t}}class bh extends Y{constructor(){super(),super.addRequiredComponentTypename("RunControls"),super.addRequiredComponentTypename("Run"),super.addRequiredComponentTypename("Move")}onEntityUpdate(t,e){const s=f.getComponent(e,"Move");let i=!1;M.isActiveAction("LEFT")?(i=!0,s.direction=-1):M.isActiveAction("RIGHT")&&(i=!0,s.direction=1),M.isActiveAction("UP")&&(i=!0,f.removeComponent(e,"Run"),f.addComponent(e,new ds(-25,10))),i||(f.removeComponent(e,"Run"),f.addComponent(e,new Nt))}}class Ph extends Y{constructor(){super(),super.addRequiredComponentTypename("Run"),super.addRequiredComponentTypename("Drawable"),super.addRequiredComponentTypename("Move")}onEntityBind(t){f.getComponent(t,"Drawable").jas.play("RUN",!0,!0)}onEntityUpdate(t,e){const s=f.getComponent(e,"Run"),i=f.getComponent(e,"Move"),r=f.getComponent(e,"Drawable");let n=0;i.velocityY>0?r.jas.play("FALLOF",!1,!0):r.jas.play("RUN",!0,!0),(i.direction==-1||i.direction==1)&&(n+=s.speed*i.direction,i.velocityX=n)}}class _h extends k{constructor(){super("IdleControls")}}class Nt extends k{constructor(){super("Idle")}}class Dh extends Y{constructor(){super(),super.addRequiredComponentTypename("IdleControls"),super.addRequiredComponentTypename("Idle")}onEntityUpdate(t,e){(M.isActiveAction("LEFT")||M.isActiveAction("RIGHT"))&&(f.removeComponent(e,"Idle"),f.addComponent(e,new Lr(6,0)))}onActionOnce(t,e){t=="UP"&&(f.removeComponent(e,"Idle"),f.addComponent(e,new ds(-25,10)))}}class Rh extends Y{constructor(){super(),super.addRequiredComponentTypename("Idle")}onEntityUpdate(t,e){const s=f.getComponent(e,"Move"),i=f.getComponent(e,"Drawable");s.velocityX=0,i.jas.play("IDLE",!0,!0)}}class Ie extends k{constructor(t,e){super("Position"),this.x=t,this.y=e}}class Oh extends k{constructor(){super("DownControls")}}class Lh extends k{constructor(){super("Down")}}class Nh extends Y{constructor(){super(),super.addRequiredComponentTypename("DownControls"),super.addRequiredComponentTypename("Down")}onActionOnce(t,e){t=="UP"&&(f.removeComponent(e,"Down"),f.addComponent(e,new Nt))}}class Fh extends Y{constructor(){super(),super.addRequiredComponentTypename("Down"),super.addRequiredComponentTypename("Move"),super.addRequiredComponentTypename("Drawable")}onEntityBind(t){const e=f.getComponent(t,"Move"),s=f.getComponent(t,"Drawable");f.removeComponentIfExist(t,"Idle"),f.removeComponentIfExist(t,"Run"),f.removeComponentIfExist(t,"Jump"),s.jas.play("PAIN_GROUND",!1,!0),e.velocityX=0,e.velocityY=0}}class Bh extends k{constructor(t=null,e=1,s=1,i=null,r=[0,0]){super("Damage"),this.velocityImpact=t,this.damageHP=e,this.maxAge=s,this.spriteAnimation=i,this.spriteOffset=r,this.airDropped=!1,this.age=0}}class Vh extends Y{constructor(){super(),super.addRequiredComponentTypename("Damage"),super.addRequiredComponentTypename("Position"),super.addRequiredComponentTypename("Move"),super.addRequiredComponentTypename("Drawable"),this.paused=!1,this.frictionX=.5}onEntityBind(t){const e=f.getComponent(t,"Damage"),s=f.getComponent(t,"Fighter"),i=f.getComponent(t,"Move");e.velocityImpact&&(i.velocityX=e.velocityImpact[0],i.velocityY=e.velocityImpact[1]),s.health-=e.damageHP,e.spriteAnimation&&(s.dmgSprite.setOffset(e.spriteOffset[0],e.spriteOffset[1]),s.dmgSprite.play(e.spriteAnimation,!0,!0))}async onEntityUpdate(t,e){if(this.paused)return;const s=f.getComponent(e,"Damage"),i=f.getComponent(e,"Move"),r=f.getComponent(e,"Drawable");if(s.age>s.maxAge){f.removeComponent(e,"Damage"),s.airDropped?f.addComponent(e,new Lh):f.addComponent(e,new Nt);return}i.velocityY<0?(s.airDropped=!0,r.jas.play("PAIN_UP",!1,!0)):i.velocityY>0&&(s.airDropped=!0,r.jas.play("PAIN_DOWN",!1,!0)),i.velocityY==0&&s.airDropped?r.jas.play("PAIN_GROUND",!1,!0):i.velocityY==0&&r.jas.play("PAIN",!1,!1),i.velocityX>0&&(i.velocityX=Math.max(i.velocityX-this.frictionX,0)),i.velocityX<0&&(i.velocityX=Math.min(i.velocityX+this.frictionX,0)),s.age+=t/1e3}onEntityDraw(t){const e=f.getComponent(t,"Damage"),s=f.getComponent(t,"Fighter"),i=f.getComponent(t,"Position");e.spriteAnimation&&(s.dmgSprite.setPosition(i.x,i.y),s.dmgSprite.draw())}}class Uh extends k{constructor(t={}){super("Hit"),this.w=t.w,this.h=t.h,this.frameIndex=t.frameIndex,this.maxAge=t.maxAge,this.relativeX=t.relativeX,this.relativeY=t.relativeY,this.velocityTween=t.velocityTween??null,this.isCollide=t.isCollide??!0,this.damageHP=t.damageHP??1,this.damageMaxAge=t.damageMaxAge??1,this.damageSpriteAnimation=t.damageSpriteAnimation??null,this.damageSpriteOffset=t.damageSpriteOffset??[0,0],this.spriteAnimationOnLaunch=t.spriteAnimationOnLaunch??null,this.spriteAnimationOnImpact=t.spriteAnimationOnImpact??null,this.spriteOffsetX=t.spriteOffsetX??0,this.spriteOffsetY=t.spriteOffsetY??0,this.owner=t.owner??-1,this.direction=t.direction??0,this.velocityImpact=t.velocityImpact??null,this.marked=!1,this.age=0}}class Hh extends Y{constructor(){super(),super.addRequiredComponentTypename("Hit"),super.addRequiredComponentTypename("Position"),super.addRequiredComponentTypename("Drawable")}onEntityBind(t){const e=f.getComponent(t,"Hit"),s=f.getComponent(t,"Position");if(s.x+=e.relativeX*e.direction,s.y+=e.relativeY,e.spriteAnimationOnLaunch){const i=f.getComponent(t,"Drawable");i.jas.setVisible(!0),i.jas.setOffset(e.spriteOffsetX,e.spriteOffsetY),i.jas.play(e.spriteAnimationOnLaunch,!1,!1)}}async onEntityUpdate(t,e){const s=f.getComponent(e,"Hit");if(s.marked)return;const i=f.getComponent(e,"Position"),r=f.getComponent(e,"Drawable");if(s.isCollide){const a=f.findEntities("Fighter").filter(h=>h!=s.owner);for(let h of a){const l=f.getComponent(h,"Fighter"),u=f.getComponent(h,"Position"),d=[i.x-s.w/2,i.y-s.h/2],p=[i.x+s.w/2,i.y+s.h/2],E=[u.x-l.w/2,u.y-l.h/2],T=[u.x+l.w/2,u.y+l.h/2];if(c.COLLIDE_RECT_TO_RECT(d,p,E,T)){s.marked=!0,f.removeComponentIfExist(h,"Damage"),f.removeComponentIfExist(h,"Run"),f.removeComponentIfExist(h,"Idle"),f.removeComponentIfExist(h,"Jump"),f.addComponent(h,new Bh([s.velocityImpact[0]*s.direction,s.velocityImpact[1]],s.damageHP,s.damageMaxAge,s.damageSpriteAnimation,s.damageSpriteOffset)),s.spriteAnimationOnImpact&&(r.jas.setVisible(!0),r.jas.setOffset(s.spriteOffsetX,s.spriteOffsetY),r.jas.play(s.spriteAnimationOnImpact,!1,!1),await m.wait(r.jas,"E_FINISHED"),r.jas.setVisible(!1)),f.removeEntity(e);return}}}if(s.age>s.maxAge){f.removeEntity(e);return}if(s.velocityTween){const n=s.velocityTween.interpolate(s.age);i.x+=n[0]*s.direction,i.y+=n[1]}s.age+=t/1e3}onEntityDraw(t){const e=f.getComponent(t,"Hit"),s=f.getComponent(t,"Position"),i=N.getContext();i.fillStyle="red",i.fillRect(s.x-e.w/2,s.y-e.h/2,e.w,e.h)}}class ye extends k{constructor(t={jas:null,jss:null,zIndex:0}){super("Drawable"),this.jas=t.jas,this.jss=t.jss,this.zIndex=t.zIndex,this.lastAnimationFrameIndex=-1,this.updated=!0}}class Wh extends Y{constructor(){super(),super.addRequiredComponentTypename("Position"),super.addRequiredComponentTypename("Drawable"),this.onlySpecialAttack=!1}onBeforeUpdate(t){this.eids.sort((e,s)=>{const i=f.getComponent(e,"Drawable"),r=f.getComponent(s,"Drawable");return i.zIndex-r.zIndex})}onEntityUpdate(t,e){const s=f.getComponent(e,"Position"),i=f.getComponent(e,"Drawable");!i.updated||(i.jss&&(i.jss.setPosition(s.x,s.y),i.jss.update(t)),i.jas&&(i.jas.setPosition(s.x,s.y),i.jas.update(t)))}onEntityDraw(t){const e=f.getComponent(t,"Drawable");e.jss&&e.jss.draw(),e.jas&&e.jas.draw()}}class Nr extends k{constructor(t,e,s=[]){super("CAS"),this.animations=t,this.texture=e,this.comboComponents=s,this.currentAction="",this.currentActionAge=0}}class Vi extends k{constructor(t="",e="",s="",i="",r=null,n=[]){super("Combo"),this.name=t,this.requiredComponent=e,this.actions=s,this.animationName=i,this.specialAttack=r,this.hits=n,this.currentAttack=null}}class jh extends Y{constructor(){super(),super.addRequiredComponentTypename("CAS")}onEntityUpdate(t,e){const s=f.getComponent(e,"CAS");if(!f.hasComponent(e,"Combo")){s.currentActionAge>1e3&&(s.currentActionAge=0,s.currentAction="");for(let i of s.comboComponents){if(s.currentAction.indexOf(i.actions)==-1)continue;if(s.currentAction.endsWith(i.actions)&&f.hasComponent(e,i.requiredComponent)){f.removeComponentIfExist(e,"Idle"),f.removeComponentIfExist(e,"Run");const a=f.getComponent(e,"Move");a.velocityX=0,s.currentActionAge=0,s.currentAction="",f.addComponent(e,i)}}s.currentActionAge+=t}}onActionOnce(t,e){const s=f.getComponent(e,"CAS");s.currentAction+=t,s.currentActionAge=0}}class Gh extends Y{constructor(){super(),super.addRequiredComponentTypename("CAS"),super.addRequiredComponentTypename("Combo"),super.addRequiredComponentTypename("Drawable"),super.addRequiredComponentTypename("Position"),super.addRequiredComponentTypename("Move")}async onEntityBind(t){const e=f.getComponent(t,"Combo"),s=f.getComponent(t,"Drawable");e.specialAttack&&f.addComponent(t,e.specialAttack),s.jas.play(e.animationName,!1,!0),await m.wait(s.jas,"E_FINISHED"),e.specialAttack&&f.removeComponent(t,"SpecialAttack"),f.removeComponent(t,"Combo"),f.addComponent(t,new Nt)}onEntityUpdate(t,e){const s=f.getComponent(e,"CAS"),i=f.getComponent(e,"Combo"),r=f.getComponent(e,"Drawable"),n=f.getComponent(e,"Position"),a=f.getComponent(e,"Move");if(r.jas.getCurrentAnimationFrameIndex()==r.lastAnimationFrameIndex)return;r.lastAnimationFrameIndex=r.jas.getCurrentAnimationFrameIndex();const h=i.hits.filter(l=>l.frameIndex==r.jas.getCurrentAnimationFrameIndex());if(h.length!=0)for(const l of h){const u=new mt;u.setAnimations(s.animations),u.setTexture(s.texture);const d=f.createEntity();f.addComponent(d,new Ie(n.x,n.y)),f.addComponent(d,new ye({jas:u})),f.addComponent(d,new Uh(Object.assign(l,{owner:e,direction:a.direction})))}}}class Fr extends k{constructor(t){super("Move"),this.velocityX=0,this.velocityY=0,this.direction=t}}class kh extends Y{constructor(){super(),super.addRequiredComponentTypename("Move"),super.addRequiredComponentTypename("Drawable"),super.addRequiredComponentTypename("Position")}onEntityUpdate(t,e){const s=f.getComponent(e,"Move"),i=f.getComponent(e,"Drawable"),r=f.getComponent(e,"Position");r.x+=s.velocityX,r.y+=s.velocityY,s.direction==-1?i.jas.setFlipX(!0):s.direction==1&&i.jas.setFlipX(!1)}}const qh=20;class Br extends k{constructor(t=1){super("Gravity"),this.gravityFactor=t,this.onFloor=!0}}class Yh extends Y{constructor(t=540){super(),this.floorElevation=t,super.addRequiredComponentTypename("Gravity"),super.addRequiredComponentTypename("Move"),super.addRequiredComponentTypename("Position"),super.addRequiredComponentTypename("Fighter"),super.addRequiredComponentTypename("Drawable")}onEntityUpdate(t,e){const s=f.getComponent(e,"Gravity"),i=f.getComponent(e,"Move"),r=f.getComponent(e,"Position"),a=f.getComponent(e,"Fighter").h*.5,h=r.y+i.velocityY+a;let l=Math.abs(h-this.floorElevation),u=this.floorElevation;for(const d of f.findEntities("Platform")){const p=f.getComponent(d,"Platform"),E=f.getComponent(d,"Position"),T=Math.abs(h-p.elevation),A=E.x-p.w/2,x=E.x+p.w/2;r.x>=A&&r.x<=x&&l>T&&(l=T,u=p.elevation)}h>=u&&l<=i.velocityY*2?(r.y=u-a,i.velocityY=0,s.onFloor=!0):(i.velocityY=Math.min(i.velocityY+s.gravityFactor,qh),s.onFloor=!1)}}class Vr extends k{constructor(t,e,s,i,r){super("Fighter"),this.id=t,this.health=e,this.dmgSprite=s,this.w=i,this.h=r}}class Xh extends Y{constructor(t,e){super(),this.bgWidth=t,this.bgHeight=e,super.addRequiredComponentTypename("Fighter"),super.addRequiredComponentTypename("Position"),super.addRequiredComponentTypename("Move")}onEntityUpdate(t,e){const s=f.getComponent(e,"Fighter"),i=f.getComponent(e,"Position"),r=f.getComponent(e,"Move"),n=i.x+r.velocityX,a=s.w*.5;(n-a<0||n+a>this.bgWidth)&&(r.velocityX=0)}onEntityDraw(t){const e=f.getComponent(t,"Fighter"),s=f.getComponent(t,"Position"),i=N.getContext();i.globalAlpha=.2,i.fillStyle="#000",i.fillRect(s.x-e.w/2,s.y-e.h/2,e.w,e.h),i.globalAlpha=1}}class zh extends k{constructor(t,e,s){super("SpecialAttack"),this.name=t,this.bgJSS=e,this.avatarJSS=s}}class Zh extends Y{constructor(t){super(),this.gameScreen=t,this.duration=3,super.addRequiredComponentTypename("SpecialAttack")}async onEntityBind(t){const e=f.getComponent(t,"SpecialAttack"),s=new $h(this.duration);s.setBackgroundJSS(e.bgJSS),s.setAvatarJSS(e.avatarJSS),s.setText(e.name);const i=f.createEntity();f.addComponent(i,new Ie(0,0)),f.addComponent(i,new ye({jss:s,zIndex:1}));const r=document.querySelector("#UI_ROOT");r.style.display="none";for(const[n,a]of f.entities.entries()){const h=a.get("Drawable");h&&n!=i&&(h.updated=!1)}this.gameScreen.pause(),setTimeout(()=>this.handleTimeout(i),this.duration*1e3)}handleTimeout(t){const e=document.querySelector("#UI_ROOT");e.style.display="block";for(const[s,i]of f.entities.entries()){const r=i.get("Drawable");r&&(r.updated=!0)}this.gameScreen.resume(),f.removeEntity(t)}}class $h extends ft{constructor(t){super(),this.duration=t,this.text="",this.textX=0,this.opacity=0,this.bgJSS=null,this.avatarJSS=null,this.age=0,this.tweenOpacity=new tt([0,.5,this.duration-.5,this.duration],[0,1,1,0]),this.textTweenX=new tt([0,.5],[-300,300]),this.avatarTweenX=new tt([0,.5],[600,0],c.EASE_OUT_QUAD)}setBackgroundJSS(t){this.bgJSS=t}setAvatarJSS(t){this.avatarJSS=t}setText(t){this.text=t}update(t){this.opacity=this.tweenOpacity.interpolate(this.age),this.bgJSS.setOpacity(this.opacity);const e=this.avatarTweenX.interpolate(this.age);this.avatarJSS.setPosition(e,0),this.avatarJSS.setOpacity(this.opacity),this.textX=this.textTweenX.interpolate(this.age),this.age+=t/1e3}paint(){const t=N.getContext();t.save(),t.setTransform(1,0,0,1,0,0),this.bgJSS.draw(),this.avatarJSS.draw(),t.globalAlpha=this.opacity,t.font="48px Ninja Naruto",t.textAlign="center",t.fillStyle="orange",t.fillText(this.text,this.textX,60,600),t.globalAlpha=1,t.restore()}}class Kh extends k{constructor(t,e,s){super("Platform"),this.elevation=t,this.w=e,this.h=s}}class Jh extends k{constructor(t=100,e=[]){super("AI"),this.patterns=e.sort((s,i)=>i.tick-s.tick),this.tick=t,this.then=0}}class Qh extends Y{constructor(){super(),super.addRequiredComponentTypename("AI"),this.commandRegister={},this.conditionRegister={},this.commandRegister.CMD_WAKEUP=function(t){return f.hasComponent(t,"Down")?(f.removeComponentIfExist(t,"Down"),f.removeComponentIfExist(t,"Idle"),f.addComponent(t,new Nt),!0):!1},this.commandRegister.CMD_JUMP=function(t){return f.hasComponent(t,"Idle")||f.hasComponent(t,"Run")?(f.removeComponentIfExist(t,"Idle"),f.removeComponentIfExist(t,"Run"),f.addComponent(t,new ds(-25,10)),!0):!1},this.commandRegister.CMD_RUN=function(t,e){if(f.hasComponent(t,"Idle")||f.hasComponent(t,"Run")){const s=f.getComponent(t,"Position"),i=f.getComponent(t,"Move"),n=f.getComponent(e,"Position").x-s.x;return n>0?i.direction=1:n<0&&(i.direction=-1),f.removeComponentIfExist(t,"Idle"),f.removeComponentIfExist(t,"Run"),f.addComponent(t,new Lr(6,0)),!0}return!1},this.commandRegister.CMD_IDLE=function(t){return f.hasComponent(t,"Run")?(f.removeComponentIfExist(t,"Run"),f.removeComponentIfExist(t,"Idle"),f.addComponent(t,new Nt),!0):!1},this.commandRegister.CMD_COMBO=function(t,e,s){if(f.hasComponent(e,"Down")||f.hasComponent(e,"Damage"))return!1;if(f.hasComponent(t,"Idle")||f.hasComponent(t,"Run")){const i=f.getComponent(t,"Move"),r=f.getComponent(t,"CAS"),n=r.comboComponents.find(a=>a.name==s);if(n)return i.velocityX=0,r.currentActionAge=0,r.currentAction="",f.removeComponentIfExist(t,"Idle"),f.removeComponentIfExist(t,"Run"),f.addComponent(t,n),!0}return!1},this.conditionRegister.COND_HEALTH_LESS_THAN=function(t,e,s){return f.getComponent(t,"Fighter").health<s}}onEntityUpdate(t,e){const s=f.getComponent(e,"AI"),i=f.getComponent(e,"Position");let r=null,n=1/0;for(const a of f.findEntities("Fighter"))if(e!=a){const h=f.getComponent(a,"Position"),l=c.VEC2_DISTANCE([h.x,h.y],[i.x,i.y]);l<n&&(n=l,r=a)}for(const a of s.patterns){if(a.then<a.tick||a.agentHasComponent&&!f.hasComponent(e,a.agentHasComponent)||a.enemyMinDistance&&a.enemyMinDistance>n||a.enemyMaxDistance&&a.enemyMaxDistance<n)continue;const h=this.conditionRegister[a.conditionName];if(h&&!h.apply(this,[e,r,...a.conditionArgs]))continue;const l=f.getComponent(r,"CAS");if(a.enemyAction&&l.currentAction.search(new RegExp(a.enemyAction+"$"))==-1||Math.random()>a.percentSuccess/100)continue;const d=this.commandRegister[a.commandName];if(d&&d.apply(this,[e,r,...a.commandArgs])){a.then=0;break}}for(const a of s.patterns)a.then>=a.tick?a.then=0:a.then+=t}}const Ds={PUNCH:async o=>new Vi("PUNCH","Run","OKOK","PUNCH1",null,[{spriteAnimationOnImpact:"HIT",frameIndex:0,w:10,h:10,damageHP:10,damageMaxAge:1,damageSpriteAnimation:"HIT",damageSpriteOffset:[21,29],maxAge:.2,relativeX:44,relativeY:0,velocityImpact:[10,-10]}]),SPECIAL:async o=>{const t=new wt;t.setTexture(await Q.loadTexture("samples/fight/chars/"+o+"/bg-special-attack.png"));const e=new wt;return e.setTexture(await Q.loadTexture("samples/fight/chars/"+o+"/avatar-special-attack.png")),new Vi("SPECIAL","Run","OKOK","PUNCH1",new zh("Special Attack 1",t,e),[{spriteAnimationOnImpact:"HIT",frameIndex:0,w:10,h:10,damageHP:10,damageMaxAge:1,damageSpriteAnimation:"HIT",damageSpriteOffset:[21,29],maxAge:.2,relativeX:44,relativeY:0,velocityImpact:[10,-10]}])}},tl={BASE:()=>[{name:"WAKE_UP",agentHasComponent:"Down",enemyAction:null,enemyMinDistance:0,enemyMaxDistance:1/0,tick:100,then:0,percentSuccess:100,commandName:"CMD_WAKEUP",commandArgs:[],conditionName:null,conditionArgs:[]},{name:"PUNCH",agentHasComponent:null,enemyAction:null,enemyMinDistance:0,enemyMaxDistance:90,tick:500,then:0,percentSuccess:50,commandName:"CMD_COMBO",commandArgs:["PUNCH"],conditionName:null,conditionArgs:[]},{name:"SPECIAL",agentHasComponent:null,enemyAction:null,enemyMinDistance:10,enemyMaxDistance:90,tick:1e3,then:0,percentSuccess:50,commandName:"CMD_COMBO",commandArgs:["SPECIAL"],conditionName:null,conditionArgs:[]},{name:"IDLE",agentHasComponent:null,enemyAction:null,enemyMinDistance:0,enemyMaxDistance:90,tick:50,then:0,percentSuccess:100,commandName:"CMD_IDLE",commandArgs:[],conditionName:null,conditionArgs:[]},{name:"RUN",agentHasComponent:null,enemyAction:null,enemyMinDistance:80,enemyMaxDistance:1/0,tick:1500,then:0,percentSuccess:100,commandName:"CMD_RUN",commandArgs:[],conditionName:null,conditionArgs:[]}]},el=60,sl=1e3/el;class il extends U{constructor(){super(),this.elapsedTime=0,this.systems={}}async onEnter(t={map,characters}){this.systems.ui=new Ih(t.characters),this.systems.camera=new vh(800,600),this.systems.idleCtrl=new Dh,this.systems.idle=new Rh,this.systems.runCtrl=new bh,this.systems.run=new Ph,this.systems.jumpCtrl=new Sh,this.systems.jump=new wh,this.systems.downCtrl=new Nh,this.systems.down=new Fh,this.systems.cas=new jh,this.systems.combo=new Gh,this.systems.fighter=new Xh(800,600),this.systems.gravity=new Yh,this.systems.move=new kh,this.systems.hit=new Hh,this.systems.damage=new Vh,this.systems.specialAttack=new Zh(this),this.systems.drawable=new Wh,this.systems.ai=new Qh,f.setup(Object.values(this.systems)),await rl(t.map),await nl(t.characters[0]),await ol(t.characters[1])}update(t){this.elapsedTime>sl&&(f.update(this.elapsedTime),this.elapsedTime=0),this.elapsedTime+=t}draw(){f.draw()}pause(){this.systems.ui.pause(),this.systems.camera.pause(),this.systems.idleCtrl.pause(),this.systems.idle.pause(),this.systems.runCtrl.pause(),this.systems.run.pause(),this.systems.jumpCtrl.pause(),this.systems.jump.pause(),this.systems.downCtrl.pause(),this.systems.down.pause(),this.systems.cas.pause(),this.systems.combo.pause(),this.systems.fighter.pause(),this.systems.gravity.pause(),this.systems.move.pause(),this.systems.hit.pause(),this.systems.damage.pause(),this.systems.ai.pause()}resume(){this.systems.ui.resume(),this.systems.camera.resume(),this.systems.idleCtrl.resume(),this.systems.idle.resume(),this.systems.runCtrl.resume(),this.systems.run.resume(),this.systems.jumpCtrl.resume(),this.systems.jump.resume(),this.systems.downCtrl.pause(),this.systems.down.pause(),this.systems.cas.resume(),this.systems.combo.resume(),this.systems.fighter.resume(),this.systems.gravity.resume(),this.systems.move.resume(),this.systems.hit.resume(),this.systems.damage.resume(),this.systems.ai.resume()}}async function rl(o){const t=f.createEntity(),e=new wt;e.setTexture(await Q.loadTexture("samples/fight/backgrounds/"+o+"/layer.png")),e.setTextureRect(0,0,800,600),f.addComponent(t,new ye({jss:e,zIndex:0})),f.addComponent(t,new Ie(0,0));const s=f.createEntity();f.addComponent(s,new yh);const i=new mt;await i.loadFromFile("samples/fight/backgrounds/"+o+"/floating-rock.jas"),i.setTexture(await Q.loadTexture("samples/fight/backgrounds/"+o+"/floating-rock.png")),i.setOffset(52,18),i.play("DEFAULT",!1,!0);const r=f.createEntity();f.addComponent(r,new Ie(220,400)),f.addComponent(r,new Kh(395,104,37)),f.addComponent(r,new ye({jas:i,zIndex:1}))}async function nl(o){const t=new mt;await t.loadFromFile("samples/fight/chars/"+o+"/sprite.jas"),t.setTexture(await Q.loadTexture("samples/fight/chars/"+o+"/sprite.png")),t.setOffset(44,44);const e=new mt;await e.loadFromFile("samples/fight/chars/"+o+"/sprite.jas"),e.setTexture(await Q.loadTexture("samples/fight/chars/"+o+"/sprite.png")),e.setOffset(44,44);const s=f.createEntity();return f.addComponent(s,new Vr(1,100,e,88,88)),f.addComponent(s,new Ie(190,490)),f.addComponent(s,new ye({jas:t,zIndex:2})),f.addComponent(s,new Fr),f.addComponent(s,new _h),f.addComponent(s,new Mh),f.addComponent(s,new xh),f.addComponent(s,new Oh),f.addComponent(s,new Nt),f.addComponent(s,new Br(2)),f.addComponent(s,new Nr(t.animations,t.texture,[await Ds.PUNCH(o)])),s}async function ol(o){const t=new mt;await t.loadFromFile("samples/fight/chars/"+o+"/sprite.jas"),t.setTexture(await Q.loadTexture("samples/fight/chars/"+o+"/sprite.png")),t.setOffset(44,44);const e=new mt;await e.loadFromFile("samples/fight/chars/"+o+"/sprite.jas"),e.setTexture(await Q.loadTexture("samples/fight/chars/"+o+"/sprite.png")),e.setOffset(44,44);const s=f.createEntity();return f.addComponent(s,new Vr(2,100,e,88,88)),f.addComponent(s,new Ie(490,490)),f.addComponent(s,new ye({jas:t,zIndex:2})),f.addComponent(s,new Nt),f.addComponent(s,new Fr),f.addComponent(s,new Br(2)),f.addComponent(s,new Jh(60,tl.BASE())),f.addComponent(s,new Nr(t.animations,t.texture,[await Ds.PUNCH(o),await Ds.SPECIAL(o)])),s}class al extends U{constructor(){super(),this.map=0,this.numPlayers=2,this.selectionPlayerOrder=[0,1],this.selectionPlayerIndex=0,this.selectedCharacters=["",""],this.uiBackground=document.createElement("img"),this.uiTitle=document.createElement("div"),this.uiMenu=new Ce,this.uiAvatars=[],this.uiLabels=[]}async onEnter(t={map}){this.map=t.map,this.uiBackground=document.createElement("img"),this.uiBackground.className="CharacterScreen-background",this.uiBackground.src="./samples/fight/ui/bg-map-screen.jpg",g.addNode(this.uiBackground,"position:absolute; left:0; right:0; top:0; right:0;"),this.uiTitle=document.createElement("div"),this.uiTitle.className="CharacterScreen-title",this.uiTitle.textContent="SELECT PLAYERS",g.addNode(this.uiTitle,"position: absolute; left:0; right:0; top:100px;"),this.uiMenu=new Ce({className:"UICharacter-menu",axis:ve.XY,rows:3,columns:4,multiple:!0,togglable:!1}),g.addWidget(this.uiMenu,"position:absolute; left:100px; top:170px");for(let e=0;e<this.numPlayers;e++){const s=e==0||e==1?"top:10px":"bottom:10px",i=e==0||e==2?"left:10px":"right:10px";this.uiAvatars[e]=document.createElement("img"),this.uiAvatars[e].className="CharacterScreen-avatar",this.uiAvatars[e].src="samples/fight/chars/default-avatar.png",g.addNode(this.uiAvatars[e],"position:absolute; "+s+";"+i);const r=e==0||e==1?"top:75px":"bottom:75px",n=e==0||e==2?"left:10px":"right:10px";this.uiLabels[e]=document.createElement("div"),this.uiLabels[e].className="CharacterScreen-label",this.uiLabels[e].textContent="Player "+e,g.addNode(this.uiLabels[e],"position:absolute; "+r+";"+n)}for(let e=0;e<de.length;e++)this.uiMenu.addWidget(new W({className:"UICharacter",template:`
        <div class="UICharacter-container">
          <img class="UICharacter-container-char-icon js-icon" alt="icon" src="${"samples/fight/chars/"+de[e]}/avatar.jpg"/>
        </div>`}));m.subscribe(this.uiMenu,"E_ITEM_SELECTED",this,this.handleMenuItemSelected),m.subscribe(this.uiMenu,"E_ITEM_FOCUSED",this,this.handleMenuItemFocused),m.subscribe(this.uiMenu,"E_CLOSED",this,this.handleMenuBack),g.focus(this.uiMenu)}onExit(){g.clear()}async handleMenuBack(){this.selectionPlayerIndex==0&&R.requestSetScreen(new Ur);const t=this.selectionPlayerOrder[this.selectionPlayerIndex-1],e=this.selectedCharacters[t];this.selectedCharacters.filter(i=>i==e).length==1&&this.uiMenu.unselectWidget(de.indexOf(e)),this.selectionPlayerIndex--}async handleMenuItemFocused(t){this.uiAvatars[this.selectionPlayerIndex].src="samples/fight/chars/"+de[t.index]+"/avatar.jpg"}async handleMenuItemSelected(t){const e=this.selectionPlayerOrder[this.selectionPlayerIndex];if(this.selectedCharacters[e]=de[t.index],this.selectionPlayerIndex++,this.selectionPlayerIndex==this.numPlayers)R.requestSetScreen(new il,{map:this.map,characters:this.selectedCharacters});else{const s=this.uiMenu.getFocusedWidgetIndex();this.uiAvatars[this.selectionPlayerIndex].src="samples/fight/chars/"+de[s]+"/avatar.jpg"}}}class Ur extends U{constructor(){super(),this.uiBackground=document.createElement("img"),this.uiTitle=document.createElement("div"),this.uiMenu=new Ce}async onEnter(){await Th.loadSound("./samples/fight/musics/intro.mp3"),this.uiBackground=document.createElement("img"),this.uiBackground.className="MapScreen-background",this.uiBackground.src="./samples/fight/ui/bg-map-screen.jpg",g.addNode(this.uiBackground,"position:absolute; left:0; right:0; top:0; right:0;"),this.uiTitle=document.createElement("div"),this.uiTitle.className="MapScreen-title",this.uiTitle.textContent="SELECT ARENA",g.addNode(this.uiTitle,"position: absolute; left:0; right:0; top:100px;"),this.uiMenu=new Ce({className:"UIMap-menu",axis:ve.XY,rows:2,columns:2}),g.addWidget(this.uiMenu,"position:absolute; left:100px; top:170px");for(let t=0;t<4;t++)this.uiMenu.addWidget(new W({className:"UIMap",template:`
        <div class="UIMap-container">
          <img class="UIMap-container-char-icon js-icon" alt="icon" src="${"samples/fight/backgrounds/"+t}/icon.png"/>
        </div>`}));m.subscribe(this.uiMenu,"E_ITEM_SELECTED",this,this.handleMenuItemSelected),m.subscribe(this.uiMenu,"E_CLOSED",this,this.handleMenuBack),g.focus(this.uiMenu)}async handleMenuBack(){g.focus(this.uiMenu)}async handleMenuItemSelected(t){g.unfocus(),g.clear(),R.requestSetScreen(new al,{map:t.index})}}class hl extends U{constructor(){super(),this.uiBackground=document.createElement("img"),this.uiLogo=document.createElement("img"),this.uiTitle=document.createElement("div")}async onEnter(){this.uiBackground=document.createElement("img"),this.uiBackground.className="FightScreen-background",this.uiBackground.src="./samples/fight/ui/bg-boot-screen.jpg",g.addNode(this.uiBackground,"position:absolute; top:0; left:0; right:0; bottom:0; "),this.uiLogo=document.createElement("img"),this.uiLogo.className="FightScreen-logo",this.uiLogo.src="./samples/fight/ui/logo-boot-screen.png",g.addNode(this.uiLogo,"position:absolute; top:20px; left:50%; transform:translate(-50%, 0);"),this.uiTitle=document.createElement("div"),this.uiTitle.textContent="PUSH ENTER TO START",this.uiTitle.className="FightScreen-title",g.addNode(this.uiTitle,"position:absolute; bottom:50px; left:50%; transform:translate(-50%, -50%);")}onExit(){g.clear()}update(){M.isActiveAction("OK")&&R.requestSetScreen(new Ur)}}/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var Rs=function(o,t){return Rs=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,s){e.__proto__=s}||function(e,s){for(var i in s)s.hasOwnProperty(i)&&(e[i]=s[i])},Rs(o,t)};function Hr(o,t){function e(){this.constructor=o}Rs(o,t),o.prototype=t===null?Object.create(t):(e.prototype=t.prototype,new e)}var ss=function(){return ss=Object.assign||function(o){for(var t,e=1,s=arguments.length;e<s;e++)for(var i in t=arguments[e])Object.prototype.hasOwnProperty.call(t,i)&&(o[i]=t[i]);return o},ss.apply(this,arguments)};function Ui(o,t){for(var e=new Array(o.length),s=0;s<o.length;s++)e[s]=2*o[s]-t[s];return e}function Os(o,t,e){var s,i,r,n,a=t.length-1;if(e)s=t[o-1<0?a:o-1],i=t[o%t.length],r=t[(o+1)%t.length],n=t[(o+2)%t.length];else{if(o===a)throw Error("There is no spline segment at this index for a closed curve!");i=t[o],r=t[o+1],s=o>0?t[o-1]:Ui(i,r),n=o<a-1?t[o+2]:Ui(r,i)}return[s,i,r,n]}function ll(o,t,e){e===void 0&&(e=!1);var s=e?t.length:t.length-1;if(o===1)return{index:s-1,weight:1};var i=s*o,r=Math.floor(i);return{index:r,weight:i-r}}function cl(o,t){for(var e=0;e<o.length;e++)o[e]=t;return o}function ul(o,t){for(var e=0;e<o.length;e++)o[e]=t(o[e],e);return o}function dl(o,t,e){e===void 0&&(e=0);for(var s=0;s<o.length;s++)e=t(e,o[s],s);return e}function Ye(o,t){t=t||new Array(o.length);for(var e=0;e<o.length;e++)t[e]=o[e];return t}function ct(o,t,e){return t===void 0&&(t=0),e===void 0&&(e=1),o<t?t:o>e?e:o}function Ls(o,t){var e=t[0];if(o>=t[t.length-1])return t.length-1;if(o<=e)return 0;for(var s=0,i=t.length-1;s<=i;){var r=Math.floor((s+i)/2),n=t[r];if(n<o)s=r+1;else{if(!(n>o))return r;i=r-1}}return Math.max(0,i)}var gt=Math.pow(2,-42);function Hi(o){var t=Math.pow(Math.abs(o),.3333333333333333);return o<0?-t:t}function Wr(o,t,e){if(Math.abs(o)<gt)return Math.abs(t)<gt?[]:[-e/t];var s=t*t-4*o*e;return Math.abs(s)<gt?[-t/(2*o)]:s>0?[(-t+Math.sqrt(s))/(2*o),(-t-Math.sqrt(s))/(2*o)]:[]}function pl(o,t,e,s){if(Math.abs(o)<gt)return Wr(t,e,s);var i,r=(3*o*e-t*t)/(3*o*o),n=(2*t*t*t-9*o*t*e+27*o*o*s)/(27*o*o*o);if(Math.abs(r)<gt)i=[Hi(-n)];else if(Math.abs(n)<gt)i=[0].concat(r<0?[Math.sqrt(-r),-Math.sqrt(-r)]:[]);else{var a=n*n/4+r*r*r/27;if(Math.abs(a)<gt)i=[-1.5*n/r,3*n/r];else if(a>0)i=[(h=Hi(-n/2-Math.sqrt(a)))-r/(3*h)];else{var h=2*Math.sqrt(-r/3),l=Math.acos(3*n/r/h)/3,u=2*Math.PI/3;i=[h*Math.cos(l),h*Math.cos(l-u),h*Math.cos(l-2*u)]}}for(var d=0;d<i.length;d++)i[d]-=t/(3*o);return i}function Ge(o,t){if(o.length!==t.length)throw Error("Vectors must be of equal length!");for(var e=0,s=0;s<o.length;s++)e+=o[s]*t[s];return e}function yt(o,t,e){if(!(o.length>3)){e=e||new Array(3);var s=o[0],i=o[1],r=o[2]||0,n=t[0],a=t[1],h=t[2]||0;return e[0]=i*h-r*a,e[1]=r*n-s*h,e[2]=s*a-i*n,e}}function jr(o,t){for(var e=0,s=0;s<o.length;s++)e+=(o[s]-t[s])*(o[s]-t[s]);return e}function Zt(o){for(var t=0,e=0;e<o.length;e++)t+=o[e]*o[e];return Math.sqrt(t)}function is(o,t){var e=jr(o,t);return e===0?0:Math.sqrt(e)}function Ut(o,t){var e=t?Ye(o,t):o,s=dl(e,function(r,n){return r+Math.pow(n,2)}),i=Math.sqrt(s);return i===0?cl(e,0):ul(e,function(r){return r/i})}function Wi(o,t,e,s){t===void 0&&(t=[0,1,0]),e===void 0&&(e=0);var i=Math.cos(e),r=Math.sin(e),n=1-i,a=o[0],h=o[1],l=o[2],u=t[0],d=t[1],p=t[2],E=n*u,T=n*d;return(s=s||o)[0]=(E*u+i)*a+(E*d-r*p)*h+(E*p+r*d)*l,s[1]=(E*d+r*p)*a+(T*d+i)*h+(T*p-r*u)*l,s[2]=(E*p-r*d)*a+(T*p+r*u)*h+(n*p*p+i)*l,s}function ml(o,t,e,s,i){if(i===void 0&&(i=0),i===0)return[0,1,2,3];var r=function(h,l){return Math.pow(jr(h,l),.5*i)},n=r(t,o),a=r(e,t)+n;return[0,n,a,r(s,e)+a]}function fl(o,t,e,s,i){for(var r=Number.isFinite(i.tension)?i.tension:.5,n=Number.isFinite(i.alpha)?i.alpha:null,a=n>0?ml(o,t,e,s,n):null,h=new Array(o.length),l=0;l<o.length;l++){var u=0,d=0,p=o[l],E=t[l],T=e[l],A=s[l];if(a){var x=a[0],y=a[1],C=a[2],S=a[3];y-C!=0&&(x-y!=0&&x-C!=0&&(u=(1-r)*(C-y)*((p-E)/(x-y)-(p-T)/(x-C)+(E-T)/(y-C))),y-S!=0&&C-S!=0&&(d=(1-r)*(C-y)*((E-T)/(y-C)-(E-A)/(y-S)+(T-A)/(C-S))))}else u=(1-r)*(T-p)*.5,d=(1-r)*(A-E)*.5;var w=2*E-2*T+u+d,P=-3*E+3*T-2*u-d,O=u,_=E;h[l]=[w,P,O,_]}return h}function me(o,t){var e=o*o,s=o*e;return t[0]*s+t[1]*e+t[2]*o+t[3]}function fe(o,t){var e=o*o;return 3*t[0]*e+2*t[1]*o+t[2]}function ys(o,t){return 6*t[0]*o+2*t[1]}function gl(o,t){var e=t[0],s=t[1],i=t[2],r=t[3]-o;return e===0&&s===0&&i===0&&r===0?[0]:pl(e,s,i,r).filter(function(n){return n>-gt&&n<=1+gt}).map(function(n){return ct(n,0,1)})}function Ns(o,t,e,s){s===void 0&&(s=null),s=s||new Array(e.length);for(var i=0;i<e.length;i++)s[i]=o(t,e[i]);return s}var Gr=function(){function o(t){t===void 0&&(t=null),this._alpha=0,this._tension=.5,this._closed=!1,this._onInvalidateCache=null,this._onInvalidateCache=t,this._cache={arcLengths:null,coefficients:null}}return o.prototype._invalidateCache=function(){this.points&&(this._cache={arcLengths:null,coefficients:null},this._onInvalidateCache&&this._onInvalidateCache())},Object.defineProperty(o.prototype,"alpha",{get:function(){return this._alpha},set:function(t){Number.isFinite(t)&&t!==this._alpha&&(this._invalidateCache(),this._alpha=t)},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"tension",{get:function(){return this._tension},set:function(t){Number.isFinite(t)&&t!==this._tension&&(this._invalidateCache(),this._tension=t)},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"points",{get:function(){return this._points},set:function(t){if(!t||t.length<2)throw Error("At least 2 control points are required!");this._points=t,this._invalidateCache()},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"closed",{get:function(){return this._closed},set:function(t){t=!!t,this._closed!==t&&(this._invalidateCache(),this._closed=t)},enumerable:!1,configurable:!0}),o.prototype.reset=function(){this._invalidateCache()},o.prototype.evaluateForT=function(t,e,s){var i=ll(e,this.points,this.closed),r=i.index;return Ns(t,i.weight,this.getCoefficients(r),s)},o.prototype.getCoefficients=function(t){if(this.points){if(this._cache.coefficients||(this._cache.coefficients=new Map),!this._cache.coefficients.has(t)){var e=Os(t,this.points,this.closed),s=fl(e[0],e[1],e[2],e[3],{tension:this.tension,alpha:this.alpha});this._cache.coefficients.set(t,s)}return this._cache.coefficients.get(t)}},o}(),El=function(o){function t(e,s){e===void 0&&(e=300),s===void 0&&(s=null);var i=o.call(this,s)||this;return i._subDivisions=e,i}return Hr(t,o),Object.defineProperty(t.prototype,"arcLengths",{get:function(){return this._cache.arcLengths||(this._cache.arcLengths=this.computeArcLengths()),this._cache.arcLengths},enumerable:!1,configurable:!0}),t.prototype._invalidateCache=function(){o.prototype._invalidateCache.call(this),this._cache.arcLengths=null},t.prototype.computeArcLengths=function(){var e,s=[],i=this.evaluateForT(me,0),r=0;s.push(0);for(var n=1;n<=this._subDivisions;n++)r+=is(e=this.evaluateForT(me,n/this._subDivisions),i),s.push(r),i=e;return s},t.prototype.lengthAt=function(e){var s=this.arcLengths;return e*s[s.length-1]},t.prototype.getT=function(e){var s=this.arcLengths,i=s.length,r=e*s[i-1],n=Ls(r,s);if(s[n]===r)return n/(i-1);var a=s[n];return(n+(r-a)/(s[n+1]-a))/(i-1)},t.prototype.getU=function(e){if(e===0)return 0;if(e===1)return 1;var s=this.arcLengths,i=s.length-1,r=s[i],n=e*i,a=Math.floor(n),h=s[a];if(n===a)return h/r;var l=a/i;return(h+is(this.evaluateForT(me,l),this.evaluateForT(me,e)))/r},t}(Gr),kr=[[[-.906179845938664,.23692688505618908],[-.5384693101056831,.47862867049936647],[0,.5688888888888889],[.5384693101056831,.47862867049936647],[.906179845938664,.23692688505618908]],[[-.932469514203152,.17132449237917036],[-.6612093864662645,.3607615730481386],[-.2386191860831969,.46791393457269104],[.2386191860831969,.46791393457269104],[.6612093864662645,.3607615730481386],[.932469514203152,.17132449237917036]],[[-.9491079123427585,.1294849661688697],[-.7415311855993945,.27970539148927664],[-.4058451513773972,.3818300505051189],[0,.4179591836734694],[.4058451513773972,.3818300505051189],[.7415311855993945,.27970539148927664],[.9491079123427585,.1294849661688697]],[[-.9602898564975363,.10122853629037626],[-.7966664774136267,.22238103445337448],[-.525532409916329,.31370664587788727],[-.1834346424956498,.362683783378362],[.1834346424956498,.362683783378362],[.525532409916329,.31370664587788727],[.7966664774136267,.22238103445337448],[.9602898564975363,.10122853629037626]],[[-.9681602395076261,.08127438836157441],[-.8360311073266358,.1806481606948574],[-.6133714327005904,.26061069640293544],[-.3242534234038089,.31234707704000286],[0,.3302393550012598],[.3242534234038089,.31234707704000286],[.6133714327005904,.26061069640293544],[.8360311073266358,.1806481606948574],[.9681602395076261,.08127438836157441]],[[-.9739065285171717,.06667134430868814],[-.8650633666889845,.1494513491505806],[-.6794095682990244,.21908636251598204],[-.4333953941292472,.26926671930999635],[-.14887433898163122,.29552422471475287],[.14887433898163122,.29552422471475287],[.4333953941292472,.26926671930999635],[.6794095682990244,.21908636251598204],[.8650633666889845,.1494513491505806],[.9739065285171717,.06667134430868814]],[[-.978228658146056,.0556685671161736],[-.887062599768095,.125580369464904],[-.730152005574049,.186290210927734],[-.519096129206811,.23319376459199],[-.269543155952344,.262804544510246],[0,.2729250867779],[.269543155952344,.262804544510246],[.519096129206811,.23319376459199],[.730152005574049,.186290210927734],[.887062599768095,.125580369464904],[.978228658146056,.0556685671161736]],[[-.981560634246719,.0471753363865118],[-.904117256370474,.106939325995318],[-.769902674194304,.160078328543346],[-.587317954286617,.203167426723065],[-.36783149899818,.233492536538354],[-.125233408511468,.249147045813402],[.125233408511468,.249147045813402],[.36783149899818,.233492536538354],[.587317954286617,.203167426723065],[.769902674194304,.160078328543346],[.904117256370474,.106939325995318],[.981560634246719,.0471753363865118]],[[-.984183054718588,.0404840047653158],[-.917598399222977,.0921214998377284],[-.801578090733309,.138873510219787],[-.64234933944034,.178145980761945],[-.448492751036446,.207816047536888],[-.230458315955134,.226283180262897],[0,.232551553230873],[.230458315955134,.226283180262897],[.448492751036446,.207816047536888],[.64234933944034,.178145980761945],[.801578090733309,.138873510219787],[.917598399222977,.0921214998377284],[.984183054718588,.0404840047653158]],[[-.986283808696812,.0351194603317518],[-.928434883663573,.0801580871597602],[-.827201315069764,.121518570687903],[-.687292904811685,.157203167158193],[-.515248636358154,.185538397477937],[-.319112368927889,.205198463721295],[-.108054948707343,.215263853463157],[.108054948707343,.215263853463157],[.319112368927889,.205198463721295],[.515248636358154,.185538397477937],[.687292904811685,.157203167158193],[.827201315069764,.121518570687903],[.928434883663573,.0801580871597602],[.986283808696812,.0351194603317518]],[[-.987992518020485,.0307532419961172],[-.937273392400705,.0703660474881081],[-.848206583410427,.107159220467171],[-.72441773136017,.139570677926154],[-.570972172608538,.166269205816993],[-.394151347077563,.186161000015562],[-.201194093997434,.198431485327111],[0,.202578241925561],[.201194093997434,.198431485327111],[.394151347077563,.186161000015562],[.570972172608538,.166269205816993],[.72441773136017,.139570677926154],[.848206583410427,.107159220467171],[.937273392400705,.0703660474881081],[.987992518020485,.0307532419961172]],[[-.989400934991649,.027152459411754],[-.944575023073232,.0622535239386478],[-.865631202387831,.0951585116824927],[-.755404408355003,.124628971255533],[-.617876244402643,.149595988816576],[-.458016777657227,.169156519395002],[-.281603550779258,.182603415044923],[-.0950125098376374,.189450610455068],[.0950125098376374,.189450610455068],[.281603550779258,.182603415044923],[.458016777657227,.169156519395002],[.617876244402643,.149595988816576],[.755404408355003,.124628971255533],[.865631202387831,.0951585116824927],[.944575023073232,.0622535239386478],[.989400934991649,.027152459411754]],[[-.990575475314417,.0241483028685479],[-.950675521768767,.0554595293739872],[-.880239153726985,.0850361483171791],[-.781514003896801,.111883847193403],[-.65767115921669,.135136368468525],[-.512690537086476,.15404576107681],[-.351231763453876,.16800410215645],[-.178484181495847,.176562705366992],[0,.179446470356206],[.178484181495847,.176562705366992],[.351231763453876,.16800410215645],[.512690537086476,.15404576107681],[.65767115921669,.135136368468525],[.781514003896801,.111883847193403],[.880239153726985,.0850361483171791],[.950675521768767,.0554595293739872],[.990575475314417,.0241483028685479]],[[-.99156516842093,.0216160135264833],[-.955823949571397,.0497145488949698],[-.892602466497555,.076425730254889],[-.803704958972523,.100942044106287],[-.691687043060353,.122555206711478],[-.559770831073947,.14064291467065],[-.411751161462842,.154684675126265],[-.251886225691505,.164276483745832],[-.0847750130417353,.169142382963143],[.0847750130417353,.169142382963143],[.251886225691505,.164276483745832],[.411751161462842,.154684675126265],[.559770831073947,.14064291467065],[.691687043060353,.122555206711478],[.803704958972523,.100942044106287],[.892602466497555,.076425730254889],[.955823949571397,.0497145488949697],[.99156516842093,.0216160135264833]],[[-.992406843843584,.0194617882297264],[-.96020815213483,.0448142267656996],[-.903155903614817,.0690445427376412],[-.822714656537142,.0914900216224499],[-.720966177335229,.111566645547333],[-.600545304661681,.128753962539336],[-.46457074137596,.142606702173606],[-.316564099963629,.152766042065859],[-.160358645640225,.158968843393954],[0,.161054449848783],[.160358645640225,.158968843393954],[.316564099963629,.152766042065859],[.46457074137596,.142606702173606],[.600545304661681,.128753962539336],[.720966177335229,.111566645547333],[.822714656537142,.0914900216224499],[.903155903614817,.0690445427376412],[.96020815213483,.0448142267656996],[.992406843843584,.0194617882297264]],[[-.993128599185094,.0176140071391521],[-.963971927277913,.0406014298003869],[-.912234428251325,.062672048334109],[-.839116971822218,.0832767415767047],[-.74633190646015,.10193011981724],[-.636053680726515,.118194531961518],[-.510867001950827,.131688638449176],[-.373706088715419,.142096109318382],[-.227785851141645,.149172986472603],[-.0765265211334973,.152753387130725],[.0765265211334973,.152753387130725],[.227785851141645,.149172986472603],[.373706088715419,.142096109318382],[.510867001950827,.131688638449176],[.636053680726515,.118194531961518],[.74633190646015,.10193011981724],[.839116971822218,.0832767415767047],[.912234428251325,.062672048334109],[.963971927277913,.0406014298003869],[.993128599185094,.0176140071391521]],[[-.993752170620389,.0160172282577743],[-.967226838566306,.0369537897708524],[-.9200993341504,.0571344254268572],[-.853363364583317,.0761001136283793],[-.768439963475677,.0934444234560338],[-.667138804197412,.108797299167148],[-.551618835887219,.121831416053728],[-.424342120207438,.132268938633337],[-.288021316802401,.139887394791073],[-.145561854160895,.14452440398997],[0,.14608113364969],[.145561854160895,.14452440398997],[.288021316802401,.139887394791073],[.424342120207438,.132268938633337],[.551618835887219,.121831416053728],[.667138804197412,.108797299167148],[.768439963475677,.0934444234560338],[.853363364583317,.0761001136283793],[.9200993341504,.0571344254268572],[.967226838566306,.0369537897708524],[.993752170620389,.0160172282577743]],[[-.994294585482399,.0146279952982722],[-.970060497835428,.0337749015848141],[-.926956772187174,.0522933351526832],[-.8658125777203,.0697964684245204],[-.787816805979208,.0859416062170677],[-.694487263186682,.10041414444288],[-.587640403506911,.112932296080539],[-.469355837986757,.123252376810512],[-.341935820892084,.131173504787062],[-.207860426688221,.136541498346015],[-.0697392733197222,.139251872855631],[.0697392733197222,.139251872855631],[.207860426688221,.136541498346015],[.341935820892084,.131173504787062],[.469355837986757,.123252376810512],[.587640403506911,.112932296080539],[.694487263186682,.10041414444288],[.787816805979208,.0859416062170677],[.8658125777203,.0697964684245204],[.926956772187174,.0522933351526832],[.970060497835428,.0337749015848141],[.994294585482399,.0146279952982722]],[[-.994769334997552,.0134118594871417],[-.972542471218115,.0309880058569794],[-.932971086826016,.0480376717310846],[-.876752358270441,.0642324214085258],[-.804888401618839,.0792814117767189],[-.71866136313195,.0929157660600351],[-.619609875763646,.104892091464541],[-.509501477846007,.114996640222411],[-.39030103803029,.123049084306729],[-.264135680970344,.128905722188082],[-.133256824298466,.132462039404696],[0,.133654572186106],[.133256824298466,.132462039404696],[.264135680970344,.128905722188082],[.39030103803029,.123049084306729],[.509501477846007,.114996640222411],[.619609875763646,.104892091464541],[.71866136313195,.0929157660600351],[.804888401618839,.0792814117767189],[.876752358270441,.0642324214085258],[.932971086826016,.0480376717310846],[.972542471218115,.0309880058569794],[.994769334997552,.0134118594871417]],[[-.995187219997021,.0123412297999872],[-.974728555971309,.0285313886289336],[-.938274552002732,.0442774388174198],[-.886415527004401,.0592985849154367],[-.820001985973902,.0733464814110803],[-.740124191578554,.0861901615319532],[-.648093651936975,.0976186521041138],[-.545421471388839,.107444270115965],[-.433793507626045,.115505668053725],[-.315042679696163,.121670472927803],[-.191118867473616,.125837456346828],[-.0640568928626056,.127938195346752],[.0640568928626056,.127938195346752],[.191118867473616,.125837456346828],[.315042679696163,.121670472927803],[.433793507626045,.115505668053725],[.545421471388839,.107444270115965],[.648093651936975,.0976186521041138],[.740124191578554,.0861901615319532],[.820001985973902,.0733464814110803],[.886415527004401,.0592985849154367],[.938274552002732,.0442774388174198],[.974728555971309,.0285313886289336],[.995187219997021,.0123412297999872]],[[-.995556969790498,.0113937985010262],[-.976663921459517,.0263549866150321],[-.942974571228974,.0409391567013063],[-.894991997878275,.0549046959758351],[-.833442628760834,.0680383338123569],[-.759259263037357,.080140700335001],[-.673566368473468,.0910282619829636],[-.577662930241222,.10053594906705],[-.473002731445714,.108519624474263],[-.361172305809387,.114858259145711],[-.243866883720988,.119455763535784],[-.12286469261071,.12224244299031],[0,.123176053726715],[.12286469261071,.12224244299031],[.243866883720988,.119455763535784],[.361172305809387,.114858259145711],[.473002731445714,.108519624474263],[.577662930241222,.10053594906705],[.673566368473468,.0910282619829636],[.759259263037357,.080140700335001],[.833442628760834,.0680383338123569],[.894991997878275,.0549046959758351],[.942974571228974,.0409391567013063],[.976663921459517,.0263549866150321],[.995556969790498,.0113937985010262]],[[-.995885701145616,.010551372617343],[-.97838544595647,.0244178510926319],[-.947159066661714,.0379623832943627],[-.902637861984307,.0509758252971478],[-.845445942788498,.0632740463295748],[-.776385948820678,.0746841497656597],[-.696427260419957,.0850458943134852],[-.606692293017618,.0942138003559141],[-.508440714824505,.102059161094425],[-.403051755123486,.108471840528576],[-.292004839485956,.113361816546319],[-.17685882035689,.116660443485296],[-.0592300934293132,.118321415279262],[.0592300934293132,.118321415279262],[.17685882035689,.116660443485296],[.292004839485956,.113361816546319],[.403051755123486,.108471840528576],[.508440714824505,.102059161094425],[.606692293017618,.0942138003559141],[.696427260419957,.0850458943134852],[.776385948820678,.0746841497656597],[.845445942788498,.0632740463295748],[.902637861984307,.0509758252971478],[.947159066661714,.0379623832943627],[.97838544595647,.0244178510926319],[.995885701145616,.010551372617343]],[[-.996179262888988,.00979899605129436],[-.979923475961501,.0226862315961806],[-.950900557814705,.0352970537574197],[-.909482320677491,.047449412520615],[-.856207908018294,.0589835368598335],[-.791771639070508,.0697488237662455],[-.717013473739423,.0796048677730577],[-.632907971946495,.0884231585437569],[-.540551564579456,.0960887273700285],[-.441148251750026,.102501637817745],[-.335993903638508,.107578285788533],[-.226459365439536,.111252488356845],[-.113972585609529,.113476346108965],[0,.114220867378956],[.113972585609529,.113476346108965],[.226459365439536,.111252488356845],[.335993903638508,.107578285788533],[.441148251750026,.102501637817745],[.540551564579456,.0960887273700285],[.632907971946495,.0884231585437569],[.717013473739423,.0796048677730577],[.791771639070508,.0697488237662455],[.856207908018294,.0589835368598336],[.909482320677491,.047449412520615],[.950900557814705,.0352970537574197],[.979923475961501,.0226862315961806],[.996179262888988,.00979899605129436]],[[-.996442497573954,.00912428259309452],[-.981303165370872,.0211321125927712],[-.954259280628938,.0329014277823043],[-.915633026392132,.0442729347590042],[-.865892522574395,.0551073456757167],[-.805641370917179,.0652729239669995],[-.735610878013631,.0746462142345687],[-.656651094038864,.0831134172289012],[-.569720471811401,.0905717443930328],[-.475874224955118,.0969306579979299],[-.376251516089078,.10211296757806],[-.272061627635178,.106055765922846],[-.16456928213338,.108711192258294],[-.0550792898840342,.110047013016475],[.0550792898840342,.110047013016475],[.16456928213338,.108711192258294],[.272061627635178,.106055765922846],[.376251516089078,.10211296757806],[.475874224955118,.0969306579979299],[.569720471811401,.0905717443930328],[.656651094038864,.0831134172289012],[.735610878013631,.0746462142345687],[.805641370917179,.0652729239669995],[.865892522574395,.0551073456757167],[.915633026392132,.0442729347590042],[.954259280628938,.0329014277823043],[.981303165370872,.0211321125927712],[.996442497573954,.00912428259309452]],[[-.996679442260596,.00851690387874641],[-.982545505261413,.0197320850561227],[-.957285595778087,.0307404922020936],[-.921180232953058,.0414020625186828],[-.874637804920102,.0515948269024979],[-.818185487615252,.0612030906570791],[-.752462851734477,.0701179332550512],[-.678214537602686,.0782383271357637],[-.596281797138227,.0854722573661725],[-.507592955124227,.0917377571392587],[-.413152888174008,.0969638340944086],[-.314031637867639,.101091273759914],[-.211352286166001,.104073310077729],[-.106278230132679,.10587615509732],[0,.106479381718314],[.106278230132679,.10587615509732],[.211352286166001,.104073310077729],[.314031637867639,.101091273759914],[.413152888174008,.0969638340944086],[.507592955124227,.0917377571392587],[.596281797138227,.0854722573661725],[.678214537602686,.0782383271357637],[.752462851734477,.0701179332550512],[.818185487615252,.0612030906570791],[.874637804920102,.0515948269024979],[.921180232953058,.0414020625186828],[.957285595778087,.0307404922020936],[.982545505261413,.0197320850561227],[.996679442260596,.00851690387874641]],[[-.996893484074649,.0079681924961666],[-.983668123279747,.0184664683110909],[-.960021864968307,.0287847078833233],[-.926200047429274,.038799192569627],[-.882560535792052,.048402672830594],[-.829565762382768,.057493156217619],[-.767777432104826,.0659742298821805],[-.697850494793315,.0737559747377052],[-.620526182989242,.0807558952294202],[-.536624148142019,.0868997872010829],[-.447033769538089,.0921225222377861],[-.352704725530878,.0963687371746442],[-.254636926167889,.0995934205867952],[-.153869913608583,.101762389748405],[-.0514718425553176,.102852652893558],[.0514718425553176,.102852652893558],[.153869913608583,.101762389748405],[.254636926167889,.0995934205867952],[.352704725530878,.0963687371746442],[.447033769538089,.0921225222377861],[.536624148142019,.0868997872010829],[.620526182989242,.0807558952294202],[.697850494793315,.0737559747377052],[.767777432104826,.0659742298821805],[.829565762382768,.057493156217619],[.882560535792052,.048402672830594],[.926200047429274,.038799192569627],[.960021864968307,.0287847078833233],[.983668123279747,.0184664683110909],[.996893484074649,.0079681924961666]]],ji=kr.length+5,Cl=function(o){function t(e,s,i){e===void 0&&(e=24),s===void 0&&(s=21);var r=o.call(this,i)||this;return r._nSamples=21,r._gauss=function(n){if(n<5||n>ji)throw Error("Order for Gaussian Quadrature must be in the range of ".concat(5," and ").concat(ji,"."));return kr[n-5]}(e),r._nSamples=s,r}return Hr(t,o),t.prototype._invalidateCache=function(){o.prototype._invalidateCache.call(this),this._cache.arcLengths=null,this._cache.samples=null},Object.defineProperty(t.prototype,"arcLengths",{get:function(){return this._cache.arcLengths||(this._cache.arcLengths=this.computeArcLengths()),this._cache.arcLengths},enumerable:!1,configurable:!0}),t.prototype.getSamples=function(e){if(this.points){if(this._cache.samples||(this._cache.samples=new Map),!this._cache.samples.has(e)){for(var s=this._nSamples,i=[],r=[],n=this.getCoefficients(e),a=0;a<s;++a){var h=a/(s-1);i.push(this.computeArcLength(e,0,h));var l=Zt(Ns(fe,h,n)),u=l===0?0:1/l;this.tension>.95&&(u=ct(u,-1,1)),r.push(u)}var d=s-1,p=[],E=[],T=i[0],A=r[0],x=1/d;for(a=0;a<d;++a){var y=T,C=(T=i[a+1])-y,S=A,w=r[a+1];A=w;var P=x/C,O=(S+w-2*P)/(C*C),_=(3*P-2*S-w)/C;p.push(O),E.push(_)}this._cache.samples.set(e,[i,r,E,p])}return this._cache.samples.get(e)}},t.prototype.computeArcLength=function(e,s,i){if(s===void 0&&(s=0),i===void 0&&(i=1),s===i)return 0;for(var r=this.getCoefficients(e),n=.5*(i-s),a=0,h=0;h<this._gauss.length;h++){var l=this._gauss[h],u=l[0];a+=l[1]*Zt(Ns(fe,n*u+n+s,r))}return n*a},t.prototype.computeArcLengths=function(){if(this.points){var e=[];e.push(0);for(var s=this.closed?this.points.length:this.points.length-1,i=0,r=0;r<s;r++)i+=this.computeArcLength(r),e.push(i);return e}},t.prototype.inverse=function(e,s){var i=1/(this._nSamples-1),r=this.getSamples(e),n=r[0],a=r[1],h=r[2],l=r[3];if(s>=n[n.length-1])return 1;if(s<=0)return 0;var u=Math.max(0,Ls(s,n)),d=u*i;if(n[u]===s)return d;var p=a[u],E=l[u],T=h[u],A=s-n[u];return((E*A+T)*A+p)*A+d},t.prototype.lengthAt=function(e){return e*this.arcLengths[this.arcLengths.length-1]},t.prototype.getT=function(e){var s=this.arcLengths,i=s.length,r=e*s[i-1],n=Ls(r,s),a=n/(i-1);if(s[n]===r)return a;var h=r-s[n];return(n+this.inverse(n,h))/(i-1)},t.prototype.getU=function(e){if(e===0)return 0;if(e===1)return 1;var s=this.arcLengths,i=s.length-1,r=s[i],n=e*i,a=Math.floor(n),h=s[a];if(n===a)return h/r;var l=n-a;return(h+this.computeArcLength(a,0,l))/r},t}(Gr),Tl=function(){function o(t,e){e===void 0&&(e={});var s=this;this._cache=new Map;var i=(e=ss({tension:.5,alpha:0,closed:!1},e)).arcDivisions?new El(e.arcDivisions,function(){return s._invalidateCache()}):new Cl(e.numericalApproximationOrder,e.numericalInverseSamples,function(){return s._invalidateCache()});i.alpha=e.alpha,i.tension=e.tension,i.closed=e.closed,i.points=t,this._lmargin=e.lmargin||1-i.tension,this._curveMapper=i}return o.prototype.getTimeFromPosition=function(t,e){return e===void 0&&(e=!1),this._curveMapper.getT(e?ct(t,0,1):t)},o.prototype.getPositionFromTime=function(t,e){return e===void 0&&(e=!1),this._curveMapper.getU(e?ct(t,0,1):t)},o.prototype.getPositionFromLength=function(t,e){e===void 0&&(e=!1);var s=e?ct(t,0,this.length):t;return this._curveMapper.getU(s/this.length)},o.prototype.getLengthAt=function(t,e){return t===void 0&&(t=1),e===void 0&&(e=!1),this._curveMapper.lengthAt(e?ct(t,0,1):t)},o.prototype.getTimeAtKnot=function(t){if(t<0||t>this.points.length-1)throw Error("Invalid index!");return t===0?0:this.closed||t!==this.points.length-1?t/(this.closed?this.points.length:this.points.length-1):1},o.prototype.getPositionAtKnot=function(t){return this.getPositionFromTime(this.getTimeAtKnot(t))},o.prototype.getPointAtTime=function(t,e){return(t=ct(t,0,1))===0?Ye(this.points[0],e):t===1?Ye(this.closed?this.points[0]:this.points[this.points.length-1],e):this._curveMapper.evaluateForT(me,t,e)},o.prototype.getPointAt=function(t,e){return this.getPointAtTime(this.getTimeFromPosition(t),e)},o.prototype.getTangentAt=function(t,e){var s=ct(this.getTimeFromPosition(t),0,1);return this.getTangentAtTime(s,e)},o.prototype.getTangentAtTime=function(t,e){return Ut(this._curveMapper.evaluateForT(fe,t,e))},o.prototype.getNormalAt=function(t,e){var s=ct(this.getTimeFromPosition(t),0,1);return this.getNormalAtTime(s,e)},o.prototype.getNormalAtTime=function(t,e){var s=Ut(this._curveMapper.evaluateForT(fe,t));if(!(s.length<2||s.length>3)){var i=e||new Array(s.length);if(s.length===2)return i[0]=-s[1],i[1]=s[0],i;var r=Ut(this._curveMapper.evaluateForT(ys,t));return Ut(yt(yt(s,r),s),i)}},o.prototype.getFrenetFrames=function(t,e,s){if(e===void 0&&(e=0),s===void 0&&(s=1),!(e<0||s>1||s<e)){for(var i=new Array(t+1),r=new Array(t+1),n=0;n<=t;n++){var a=e===0&&s===1?n/t:e+n/t*(s-e);i[n]=this.getTangentAt(a)}if(this.dim===2){for(n=0;n<i.length;n++)r[n]=[-i[n][1],i[n][0]];return{tangents:i,normals:r}}if(this.dim===3){var h=new Array(t+1),l=void 0,u=Number.MAX_VALUE,d=Math.abs(i[0][0]),p=Math.abs(i[0][1]);d<=u&&(u=d,l=[1,0,0]),p<=u&&(u=p,l=[0,1,0]),Math.abs(i[0][2])<=u&&(l=[0,0,1]);var E=Ut(yt(i[0],l));for(r[0]=yt(i[0],E),h[0]=yt(i[0],r[0]),n=1;n<=t;n++){if(E=yt(i[n-1],i[n]),r[n]=Ye(r[n-1]),Zt(E)>gt){Ut(E);var T=Math.acos(ct(Ge(i[n-1],i[n]),-1,1));Wi(r[n-1],E,T,r[n])}h[n]=yt(i[n],r[n])}if(this.closed===!0)for(T=Math.acos(ct(Ge(r[0],r[t]),-1,1))/t,Ge(i[0],yt(r[0],r[t]))>0&&(T=-T),n=1;n<=t;n++)Wi(r[n],i[n],T*n,r[n]),h[n]=yt(i[n],r[n]);return{tangents:i,normals:r,binormals:h}}}},o.prototype.getCurvatureAt=function(t){var e=ct(this.getTimeFromPosition(t),0,1);return this.getCurvatureAtTime(e)},o.prototype.getCurvatureAtTime=function(t){var e=this._curveMapper.evaluateForT(fe,t),s=this._curveMapper.evaluateForT(ys,t),i=Ut(e,[]),r=0,n=void 0;if(e.length===2){if((d=Math.pow(e[0]*e[0]+e[1]*e[1],1.5))!==0){var a=(e[0]*s[1]-e[1]*s[0])/d;n=a<0?[i[1],-i[0]]:[-i[1],i[0]],r=Math.abs(a)}}else if(e.length===3){var h=Zt(e),l=yt(e,s);n=Ut(yt(l,e)),h!==0&&(r=Zt(l)/Math.pow(h,3))}else{h=Zt(e);var u=Zt(s),d=Math.pow(h,3),p=Ge(e,s);d!==0&&(r=Math.sqrt(Math.pow(h,2)*Math.pow(u,2)-Math.pow(p,2))/d)}return{curvature:r,radius:r!==0?1/r:0,tangent:i,direction:n}},o.prototype.getDerivativeAt=function(t,e){var s=ct(this.getTimeFromPosition(t),0,1);return this._curveMapper.evaluateForT(fe,s,e)},o.prototype.getSecondDerivativeAt=function(t,e){var s=ct(this.getTimeFromPosition(t),0,1);return this._curveMapper.evaluateForT(ys,s,e)},o.prototype.getBoundingBox=function(t,e){if(t===void 0&&(t=0),e===void 0&&(e=1),t===0&&e===1&&this._cache.has("bbox"))return this._cache.get("bbox");for(var s=[],i=[],r=this.getTimeFromPosition(t),n=this.getTimeFromPosition(e),a=this.getPointAtTime(r),h=this.getPointAtTime(n),l=this.closed?this.points.length:this.points.length-1,u=Math.floor(l*r),d=Math.ceil(l*n),p=0;p<a.length;p++)s[p]=Math.min(a[p],h[p]),i[p]=Math.max(a[p],h[p]);for(var E=function(y){var C=Os(y-1,T.points,T.closed)[2];if(y<d)for(var S=0;S<C.length;S++)C[S]<s[S]&&(s[S]=C[S]),C[S]>i[S]&&(i[S]=C[S]);if(T.tension<1){var w=l*r-(y-1),P=l*n-(y-1),O=function(L){return L>-gt&&L<=1+gt&&(y-1!==u||L>w)&&(y!==d||L<P)},_=T._curveMapper.getCoefficients(y-1),H=function(L){var Z=_[L];Wr(3*Z[0],2*Z[1],Z[2]).filter(O).forEach(function(X){var K=me(X,_[L]);K<s[L]&&(s[L]=K),K>i[L]&&(i[L]=K)})};for(S=0;S<_.length;S++)H(S)}},T=this,A=u+1;A<=d;A++)E(A);var x={min:s,max:i};return t===0&&e===1&&this._cache.set("bbox",x),x},o.prototype.getPoints=function(t,e,s,i){if(t===void 0&&(t=100),s===void 0&&(s=0),i===void 0&&(i=1),!t||t<=0)throw Error("Invalid arguments passed to getPoints(). You must specify at least 1 sample/segment.");if(!(s<0||i>1||i<s)){for(var r=[],n=0;n<=t;n++){var a=s===0&&i===1?n/t:s+n/t*(i-s);r.push(this.getPointAt(a,e&&new e))}return r}},o.prototype.getNearestPosition=function(t,e,s){var i=this;if(e===void 0&&(e=1e-5),e<=0||!Number.isFinite(e))throw Error("Invalid threshold. Must be a number greater than zero!");s=s||10*this.points.length-1;var r=new Array(t.length),n=1/0,a=0,h=this.createLookupTable(function(p){return i.getPointAt(p)},s,{cacheKey:"lut_nearest_".concat(s)});Array.from(h.keys()).forEach(function(p){var E=h.get(p),T=is(t,E);if(T<n)return n=T,a=p,!0});for(var l=this.getTimeFromPosition(a),u=function(p){if(p>=0&&p<=1){i.getPointAtTime(p,r);var E=is(t,r);if(E<n)return n=E,l=p,!0}},d=.005;d>e;)u(l-d)||u(l+d)||(d/=2);return{u:a=this._curveMapper.getU(l),distance:n,point:r}},o.prototype.getIntersects=function(t,e,s,i){var r=this;e===void 0&&(e=0),s===void 0&&(s=0),i===void 0&&(i=this._lmargin);var n=this.getIntersectsAsTime(t,e,s,i).map(function(a){return r.getPointAtTime(a)});return Math.abs(s)===1?n.length===1?n[0]:null:n},o.prototype.getIntersectsAsPositions=function(t,e,s,i){var r=this;return e===void 0&&(e=0),s===void 0&&(s=0),i===void 0&&(i=this._lmargin),this.getIntersectsAsTime(t,e,s,i).map(function(n){return r.getPositionFromTime(n)})},o.prototype.getIntersectsAsTime=function(t,e,s,i){e===void 0&&(e=0),s===void 0&&(s=0),i===void 0&&(i=this._lmargin);for(var r=e,n=new Set,a=this.closed?this.points.length:this.points.length-1,h=0;h<a&&(s===0||n.size<Math.abs(s));h+=1){var l=s<0?a-(h+1):h,u=Os(l,this.points,this.closed),d=u[1],p=u[2],E=this._curveMapper.getCoefficients(l),T=void 0,A=void 0;if(d[r]<p[r]?(T=d[r],A=p[r]):(T=p[r],A=d[r]),t-i<=A&&t+i>=T){var x=gl(t,E[r]);s<0?x.sort(function(S,w){return w-S}):s>=0&&x.sort(function(S,w){return S-w});for(var y=0;y<x.length;y++){var C=(x[y]+l)/a;if(n.add(C),s!==0&&n.size===Math.abs(s))break}}}return Array.from(n)},o.prototype.createLookupTable=function(t,e,s){if(!e||e<=1)throw Error("Invalid arguments passed to createLookupTable(). You must specify at least 2 samples.");var i=ss({from:0,to:1,cacheForceUpdate:!1},s),r=i.from,n=i.to,a=i.cacheKey,h=i.cacheForceUpdate;if(!(r<0||n>1||n<r)){var l=null;if(a&&!h&&this._cache.has(a))a&&this._cache.has(a)&&(l=this._cache.get(a));else{l=new Map;for(var u=0;u<e;u++){var d=r===0&&n===1?u/(e-1):r+u/(e-1)*(n-r),p=t(d);l.set(d,p)}a&&this._cache.set(a,l)}return l}},o.prototype.forEach=function(t,e,s,i){var r=this;s===void 0&&(s=0),i===void 0&&(i=1);var n=[];if(Number.isFinite(e)){var a=e;if(a<=1)throw Error("Invalid arguments passed to forEach(). You must specify at least 2 samples.");for(var h=0;h<a;h++){var l=s===0&&i===1?h/(a-1):s+h/(a-1)*(i-s);n.push(l)}}else Array.isArray(e)&&(n=e);var u=null;n.forEach(function(d,p){if(!Number.isFinite(d)||d<0||d>1)throw Error("Invalid position (u) for sample in forEach!");var E=r.getTimeFromPosition(d),T=t({u:d,t:E,i:p,prev:u});u={u:d,t:E,i:p,value:T}})},o.prototype.map=function(t,e,s,i){var r=this;s===void 0&&(s=0),i===void 0&&(i=1);var n=[];if(Number.isFinite(e)){var a=e;if(a<=1)throw Error("Invalid arguments passed to map(). You must specify at least 2 samples.");for(var h=0;h<a;h++){var l=s===0&&i===1?h/(a-1):s+h/(a-1)*(i-s);n.push(l)}}else Array.isArray(e)&&(n=e);var u=null;return n.map(function(d,p){if(!Number.isFinite(d)||d<0||d>1)throw Error("Invalid position (u) for sample in map()!");var E=r.getTimeFromPosition(d),T=t({u:d,t:E,i:p,prev:u});return u={u:d,t:E,i:p,value:T},T})},o.prototype.reduce=function(t,e,s,i,r){var n=this;i===void 0&&(i=0),r===void 0&&(r=1);var a=[];if(Number.isFinite(s)){var h=s;if(h<=1)throw Error("Invalid arguments passed to map(). You must specify at least 2 samples.");for(var l=0;l<h;l++){var u=i===0&&r===1?l/(h-1):i+l/(h-1)*(r-i);a.push(u)}}else Array.isArray(s)&&(a=s);return a.reduce(function(d,p,E){if(!Number.isFinite(p)||p<0||p>1)throw Error("Invalid position (u) for sample in map()!");var T=n.getTimeFromPosition(p);return t({acc:d,u:p,t:T,i:E})},e)},o.prototype._invalidateCache=function(){return this._cache=new Map,this},o.prototype.reset=function(){this._curveMapper.reset()},Object.defineProperty(o.prototype,"points",{get:function(){return this._curveMapper.points},set:function(t){this._curveMapper.points=t},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"tension",{get:function(){return this._curveMapper.tension},set:function(t){this._curveMapper.tension=t},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"alpha",{get:function(){return this._curveMapper.alpha},set:function(t){this._curveMapper.alpha=t},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"closed",{get:function(){return this._curveMapper.closed},set:function(t){this._curveMapper.closed=t},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"length",{get:function(){return this._curveMapper.lengthAt(1)},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"minX",{get:function(){return this.getBoundingBox().min[0]},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"maxX",{get:function(){return this.getBoundingBox().max[0]},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"minY",{get:function(){return this.getBoundingBox().min[1]},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"maxY",{get:function(){return this.getBoundingBox().max[1]},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"minZ",{get:function(){return this.getBoundingBox().min[2]},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"maxZ",{get:function(){return this.getBoundingBox().max[2]},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"dim",{get:function(){var t;return((t=this.points[0])===null||t===void 0?void 0:t.length)||void 0},enumerable:!1,configurable:!0}),o}();class zs{static async createInterpolatorFromFile(t){let s=await(await fetch(t)).json();const i=[];for(const r of s.Points)i.push(r);return zs.createInterpolator(i,{tension:s.Tension??.5,alpha:s.Alpha??0,closed:s.Closed??!1,arcDivisions:s.ArcDivisions,numericalApproximationOrder:s.NumericalApproximationOrder,numericalInverseSamples:s.NumericalInverseSamples,lmargin:s.LMargin})}static createInterpolator(t,e){return new Tl(t,{tension:e.tension,alpha:e.alpha,closed:e.closed,arcDivisions:e.arcDivisions,numericalApproximationOrder:e.numericalApproximationOrder,numericalInverseSamples:e.numericalInverseSamples,lmargin:e.lmargin})}}class Al extends U{constructor(){super(),this.obj=null,this.skySphere=null,this.lookAtTween=null,this.camera=new Jt(0),this.curveInterpolator=null,this.curveVertices=[],this.curveVertexCount=0,this.t=.1}async onEnter(){this.obj=new ns,await this.obj.loadFromFile("./samples/curve/level.obj","./samples/curve/level.mtl"),this.skySphere=new G,await this.skySphere.loadFromFile("./samples/curve/sky_sphere.jsm"),this.skySphere.setMaterial(new $({texture:await D.loadTexture("./samples/curve/sky_sphere.jpg")})),this.curveInterpolator=await zs.createInterpolatorFromFile("./samples/curve/curve.json");for(let t=0;t<=.99;t+=.01){const e=this.curveInterpolator.getPointAt(t),s=this.curveInterpolator.getPointAt(t+.01);this.curveVertices.push(e[0],e[1],e[2],1,1,1),this.curveVertices.push(s[0],s[1],s[2],1,1,1),this.curveVertexCount+=2}}update(t){if(this.obj.update(t),this.skySphere.update(t),this.t<.99){const e=this.curveInterpolator.getPointAt(this.t),s=c.VEC3_NORMALIZE(this.curveInterpolator.getTangentAt(this.t));this.camera.setPosition(e[0],e[1]+.1,e[2]),this.camera.lookAt(e[0]+s[0],e[1]+s[1],e[2]+s[2]),this.t+=t/1e4}}draw(){dt.drawVertices(this.curveVertices,this.curveVertexCount,c.MAT4_IDENTITY()),ht.drawDirLight([0,-1,0],[1,1,1],[1,1,1],[0,0,0]),this.obj.draw(),this.skySphere.draw()}}var nt=(o=>(o[o.W=0]="W",o[o.N=1]="N",o[o.E=2]="E",o[o.S=3]="S",o))(nt||{}),qr=(o=>(o.NONE="NONE",o.FIRE="FIRE",o.ICE="ICE",o.EARTH="EARTH",o.THUNDER="THUNDER",o.YIN="YIN",o.YANG="YANG",o))(qr||{}),ps=(o=>(o.PRE_BATTLE="PRE_BATTLE",o.IN_BATTLE="IN_BATTLE",o.POST_BATTLE="POST_BATTLE",o))(ps||{}),ms=(o=>(o.PLUS="PLUS",o.IDENTIQUE="IDENTIQUE",o.NORMAL="NORMAL",o))(ms||{});class Il{points;elementalType;name;owner;modifier;constructor(){this.points=[0,0,0,0],this.elementalType=qr.NONE,this.name="",this.owner=1,this.modifier=[0,0,0,0]}getValue(t){return this.points[t]+this.modifier[t]}getName(){return this.name}getOpposedValue(t){return this.points[(t+2)%4]+this.modifier[(t+2)%4]}getOwner(){return this.owner}getPoints(){return this.points}setName(t){this.name=t}setOwner(t){this.owner=t}setPoint(t,e){this.points[t]=e,m.emit(this,"E_POINT_CHANGED",{dir:t,value:e})}setPoints(t,e,s,i){this.points[nt.W]=t,this.points[nt.N]=e,this.points[nt.E]=s,this.points[nt.S]=i,m.emit(this,"E_POINTS_CHANGED",{values:[t,e,s,i]})}setPointsArray(t){for(let e=0;e<4;e++)this.points[e]=t[e];m.emit(this,"E_POINTS_CHANGED",{values:t})}flipPlayerOwner(){this.owner=this.owner==1?2:1,m.emit(this,"E_OWNER_CHANGED",{owner:this.owner})}modifyPoints(t){for(let e=0;e<4;e++)this.modifier[e]+=t[e];m.emit(this,"E_MODIFIER_VALUES_CHANGED",{values:t})}modifyPoint(t,e){this.modifier[e]+=t,m.emit(this,"E_MODIFIER_VALUE_CHANGED",{dir:e,value:t})}restoreToDefault(){for(let t=0;t<4;t++)this.modifier[t]=0}}class Zs{priority;type;constructor(t,e){this.priority=t,this.type=e}apply(t,e){return 0}}class yl extends Zs{constructor(){super(ms.NORMAL,ps.IN_BATTLE)}apply(t,e){let s=0;const i=t.getCardFromBoard(e);if(i==null)throw new Error("NormalEffect::apply(): target pos empty !");for(let r=0;r<Object.keys(nt).length;r++){const n=t.getCoordinateNeighbourCardFromBoard(e,r);if(n==null)continue;const a=t.getCardFromBoard(n);a!=null&&a.getOwner()!=i.getOwner()&&i.getValue(r)>a.getOpposedValue(r)&&(a.flipPlayerOwner(),a.getOwner()==1?s+=1:s-=1)}return s}}class vl extends Zs{constructor(){super(ms.IDENTIQUE,ps.IN_BATTLE)}apply(t,e){let s=0;const i=new Array,r=t.getCardFromBoard(e);if(r==null)throw new Error("NormalEffect::apply(): target pos empty !");for(let n=0;n<Object.keys(nt).length;n++){const a=t.getCoordinateNeighbourCardFromBoard(e,n);if(a==null)continue;const h=t.getCardFromBoard(a);h!=null&&r.getValue(n)==h.getOpposedValue(n)&&i.push(a)}for(let n=0;n<i.length;n++){const a=t.getCardFromBoard(i[n]);a!=null&&a.getOwner()!=r.getOwner()&&(a.flipPlayerOwner(),a.getOwner()==1?s+=1:s-=1)}return s}}class xl extends Zs{constructor(){super(ms.IDENTIQUE,ps.IN_BATTLE)}apply(t,e){let s=0;const i=new Array,r=new Array,n=t.getCardFromBoard(e);if(n==null)throw new Error("NormalEffect::apply(): target pos empty !");for(let h=0;h<Object.keys(nt).length;h++){const l=t.getCoordinateNeighbourCardFromBoard(e,h);if(l==null)continue;const u=t.getCardFromBoard(l);u!=null&&(i.push(n.getValue(h)+u.getOpposedValue(h)),r.push(l))}let a=!1;t:for(let h=0;h<i.length-1;h++)for(let l=h+1;l<i.length;l++)if(i[h]==i[l]){a=!0;break t}if(a)for(let h=0;h<r.length;h++){const l=t.getCardFromBoard(r[h]);l!=null&&l.getOwner()!=n.getOwner()&&(l.flipPlayerOwner(),l.getOwner()==1?s+=1:s-=1)}return s}}const Sl=[["Alice","Patchouli","Cirno","Reimu","Sakuya","Remilia","Meiling","Reisen"],["Mokou","Iku","Kisume","Kogasa","Komachi","Marisa","Konngara","Momiji"]],wl=8,B=4;class Ml{currentPlayerNum;hands;board;hWalls;vWalls;score;standardEffects;constructor(){this.currentPlayerNum=0,this.hands=[new Array,new Array],this.board=bl(),this.hWalls=Pl(),this.vWalls=_l(),this.score=8,this.standardEffects=[new xl,new vl,new yl]}startup(){for(let t=0;t<2;t++)for(let e=0;e<wl;e++){const s=new Il;s.setPoints(Math.floor(Math.random()*10+1),Math.floor(Math.random()*10+1),Math.floor(Math.random()*10+1),Math.floor(Math.random()*10+1)),s.setName(Sl[t][e]),s.setOwner(t),this.addHandCard(t,s)}}restart(){this.score=8,this.clearBoard()}getCurrentPlayerNum(){return this.currentPlayerNum}getBoard(){return this.board}getHWalls(){return this.hWalls}getVWalls(){return this.vWalls}getCardFromBoard(t){return this.board[t[0]][t[1]]}getHand(t){return this.hands[t]}getScore(){return this.score}setHandCard(t,e,s){this.hands[t][s]=e}clearBoard(){for(let t=0;t<B;t++)for(let e=0;e<B;e++)this.board[t][e]=null}placeHandCardOnBoard(t,e,s){const i=this.hands[t][e];if(!i)throw new Error("GameState::placeHandCardOnBoard(): Card not exist !");this.board[s[0]][s[1]]=i,this.removeHandCard(t,e),m.emit(this,"E_BOARD_CARD_PLACED",{card:i,playerNum:t,pos:s})}addHandCard(t,e){this.hands[t].push(e),m.emit(this,"E_HAND_CARD_ADDED",{playerNum:t,card:e})}removeHandCard(t,e){this.hands[t].splice(e,1),m.emit(this,"E_HAND_CARD_REMOVED",{playerNum:t,cardNum:e})}getNeighbourCardFromBoard(t,e){let s=this.getCoordinateNeighbourCardFromBoard(t,e);return s==null?null:this.board[s[0]][s[1]]}getCoordinateNeighbourCardFromBoard(t,e){const s=t[0],i=t[1],r=[s,i];switch(e){case nt.W:if(this.vWalls[s][i])return null;r[1]=i==0?B-1:i-1;break;case nt.N:if(this.hWalls[s][i])return null;r[0]=s==0?B-1:s-1;break;case nt.E:if(this.vWalls[s][i])return null;r[1]=i==B-1?0:i+1;break;case nt.S:if(this.hWalls[s][i])return null;r[0]=s==B-1?0:s+1;break}return r}performBattle(t){for(let e of this.standardEffects)this.score+=e.apply(this,t);m.emit(this,"E_BATTLE_PERFORMED",{score:this.score})}changePlayer(){this.currentPlayerNum=(this.currentPlayerNum+1)%2}}function bl(){const o=new Array(B);for(let t=0;t<B;t++){o[t]=new Array(B);for(let e=0;e<B;e++)o[t][e]=null}return o}function Pl(){const o=new Array(B);for(let t=0;t<B+1;t++){o[t]=new Array(B);for(let e=0;e<B;e++)o[t][e]=!1}return o[0][0]=!0,o[0][B-1]=!0,o}function _l(){const o=new Array(B);for(let t=0;t<B;t++){o[t]=new Array(B);for(let e=0;e<B;e++)o[t][e]=!1}return o[0][0]=!0,o[B-1][0]=!0,o}const Lt={PATH_CARD:"samples/triple-triad/",PATH_CARD_AVATAR:"samples/triple-triad/card_img/"};class Yr extends W{card;constructor(){super({className:"UICard",template:`
      <img class="UICard-picture js-background"/>
      <img class="UICard-picture js-picture"/>
      <img class="UICard-picture js-border"/>
      <div class="UICard-points js-points">
        <div class="UICard-points-t js-top"></div>
        <div class="UICard-points-r js-right"></div>
        <div class="UICard-points-l js-left"></div>
        <div class="UICard-points-b js-bottom"></div>
      </div>`}),this.card=null,this.node.querySelector(".js-border").src=Lt.PATH_CARD+"card.png"}setCard(t){m.unsubscribe(t,"E_POINTS_CHANGED",this),m.unsubscribe(t,"E_POINT_CHANGED",this),m.unsubscribe(t,"E_MODIFIER_VALUES_CHANGED",this),m.unsubscribe(t,"E_MODIFIER_VALUE_CHANGED",this),m.unsubscribe(t,"E_OWNER_CHANGED",this),t?(m.subscribe(t,"E_POINTS_CHANGED",this,this.handlePointsChanged),m.subscribe(t,"E_POINT_CHANGED",this,this.handlePointChanged),m.subscribe(t,"E_MODIFIER_VALUES_CHANGED",this,this.handleModifierValuesChanged),m.subscribe(t,"E_MODIFIER_VALUE_CHANGED",this,this.handleModifierValueChanged),m.subscribe(t,"E_OWNER_CHANGED",this,this.handleOwnerChanged),this.setPicture(t.getName()),this.setPlayerOwner(t.getOwner()),this.setPoints(t.getValue(0),t.getValue(1),t.getValue(2),t.getValue(3)),this.card=t):this.card=null}setVisiblePoints(t){this.node.querySelector(".js-points").style.display=t?"block":"none"}setPicture(t){this.node.querySelector(".js-picture").src=Lt.PATH_CARD_AVATAR+t+".png"}setPlayerOwner(t){t==1?this.node.querySelector(".js-background").src=Lt.PATH_CARD+"blue.png":this.node.querySelector(".js-background").src=Lt.PATH_CARD+"red.png"}setPoints(t,e,s,i){this.node.querySelector(".js-top").textContent=e.toString(16).toUpperCase(),this.node.querySelector(".js-right").textContent=s.toString(16).toUpperCase(),this.node.querySelector(".js-bottom").textContent=i.toString(16).toUpperCase(),this.node.querySelector(".js-left").textContent=t.toString(16).toUpperCase()}setPoint(t,e){let s=e.toString(16).toUpperCase();switch(t){case nt.N:this.node.querySelector(".js-top").textContent=s;break;case nt.E:this.node.querySelector(".js-right").textContent=s;break;case nt.S:this.node.querySelector(".js-bottom").textContent=s;break;case nt.W:this.node.querySelector(".js-left").textContent=s;break}}handlePointsChanged(){this.card&&this.setPoints(this.card.getValue(0),this.card.getValue(1),this.card.getValue(2),this.card.getValue(3))}handlePointChanged(t){this.card&&this.setPoint(t.dir,this.card.getValue(t.dir))}handleModifierValuesChanged(t){this.card&&this.setPoints(this.card.getValue(0),this.card.getValue(1),this.card.getValue(2),this.card.getValue(3))}handleModifierValueChanged(t){this.card&&this.setPoint(t.dir,this.card.getValue(t.dir))}handleOwnerChanged(t){this.card&&this.setPlayerOwner(this.card.getOwner())}}class Dl extends W{gameState;uiCards;focusedCardNums;focusedPlayerNum;constructor(t){super({className:"UIHands",template:`
      <div class="UIHands-left js-hand-left"></div>
      <div class="UIHands-right js-hand-right"></div>`}),this.gameState=t,this.uiCards=[[],[]],this.focusedCardNums=[0,0],this.focusedPlayerNum=0,m.subscribe(t,"E_HAND_CARD_ADDED",this,this.handleHandCardAdded),m.subscribe(t,"E_HAND_CARD_REMOVED",this,this.handleHandCardRemoved)}delete(){for(let t=0;t<2;t++)for(let e=0;e<this.uiCards[t].length;e++)this.uiCards[t][e].delete();super.delete()}getFocusedCardNum(t){return this.focusedCardNums[t]}focusPlayer(t){const e=this.uiCards[t][this.focusedCardNums[t]];if(!e)throw new Error("UIHands::focusPlayer(): card not found !");for(let s=0;s<2;s++)for(const i of this.uiCards[s])i.unfocus();e.focus(),this.focusedPlayerNum=t}focusCard(t){const e=this.uiCards[this.focusedPlayerNum][t];if(!e)throw new Error("UIHands::focusCard(): card not found !");const s=this.uiCards[this.focusedPlayerNum][this.focusedCardNums[this.focusedPlayerNum]];s&&s.unfocus(),e.focus(),this.focusedCardNums[this.focusedPlayerNum]=t}selectCard(){if(!this.uiCards[this.focusedPlayerNum][this.focusedCardNums[this.focusedPlayerNum]])throw new Error("UIHands::selectCard(): card not found !");m.emit(this,"E_CARD_SELECTED",{playerNum:this.focusedPlayerNum,cardNum:this.focusedCardNums[this.focusedPlayerNum]})}onAction(t){const e=this.focusedCardNums[this.focusedPlayerNum],s=this.uiCards[this.focusedPlayerNum].length;t=="UP"||t=="LEFT"?this.focusCard(e==0?s-1:e-1):t=="DOWN"||t=="RIGHT"?this.focusCard(e==s-1?0:e+1):t=="OK"&&this.selectCard()}handleHandCardAdded(t){const e=new Yr;e.setCard(t.card),t.playerNum==0?(this.uiCards[0].push(e),this.node.querySelector(".js-hand-left").appendChild(e.getNode())):(this.uiCards[1].push(e),this.node.querySelector(".js-hand-right").appendChild(e.getNode()))}handleHandCardRemoved(t){this.uiCards[t.playerNum][t.cardNum].delete(),this.uiCards[t.playerNum].splice(t.cardNum,1)}}class Rl extends W{constructor(){super({className:"UIBackgroundTTT",template:`
      <img class="UIBackgroundTTT-picture js-background"/>`}),this.node.querySelector(".js-background").src=Lt.PATH_CARD+"background.png"}}var Pe=(o=>(o.VL="VL",o.VR="VR",o.HT="HT",o.HB="HB",o))(Pe||{});class ke extends W{constructor(t){super({className:"UIWall",template:`
      <img class="UIWall-picture js-wall"/>`}),t=="VL"?this.node.querySelector(".js-wall").src=Lt.PATH_CARD+"wall_vertical_left.png":t=="VR"?this.node.querySelector(".js-wall").src=Lt.PATH_CARD+"wall_vertical_right.png":t=="HT"?this.node.querySelector(".js-wall").src=Lt.PATH_CARD+"wall_horizontal_top.png":t=="HB"&&(this.node.querySelector(".js-wall").src=Lt.PATH_CARD+"wall_horizontal_bottom.png")}}class Ol extends W{gameState;uiCards;uiVWalls;uiHWalls;focusedCellPos;constructor(t){super({className:"UIDamier",template:`
      <div class="UIDamier-cell js-0-0"></div>
      <div class="UIDamier-cell js-0-1"></div>
      <div class="UIDamier-cell js-0-2"></div>
      <div class="UIDamier-cell js-0-3"></div>
      <div class="UIDamier-cell js-1-0"></div>
      <div class="UIDamier-cell js-1-1"></div>
      <div class="UIDamier-cell js-1-2"></div>
      <div class="UIDamier-cell js-1-3"></div>
      <div class="UIDamier-cell js-2-0"></div>
      <div class="UIDamier-cell js-2-1"></div>
      <div class="UIDamier-cell js-2-2"></div>
      <div class="UIDamier-cell js-2-3"></div>
      <div class="UIDamier-cell js-3-0"></div>
      <div class="UIDamier-cell js-3-1"></div>
      <div class="UIDamier-cell js-3-2"></div>
      <div class="UIDamier-cell js-3-3"></div>`}),this.gameState=t,this.uiCards=this.$createCards(),this.uiVWalls=this.$createVWalls(this.gameState.getVWalls()),this.uiHWalls=this.$createHWalls(this.gameState.getHWalls()),this.focusedCellPos=[0,0],m.subscribe(t,"E_BOARD_CARD_PLACED",this,this.handleBoardCardPlaced)}delete(){for(let t=0;t<B;t++)for(let e=0;e<B;e++)this.uiCards[t][e]?.delete();super.delete()}focusFirstEmptyCell(){for(let t=0;t<B;t++)for(let e=0;e<B;e++)if(this.uiCards[t][e]==null){this.focusCell([t,e]);return}}focusCell(t){const e=this.node.querySelector(`.js-${t[0]}-${t[1]}`);if(!e)throw new Error("UIDamier::focusCell(): Cell not found !");this.node.querySelector(`.js-${this.focusedCellPos[0]}-${this.focusedCellPos[1]}`).classList.remove("u-focused"),e.classList.add("u-focused"),this.focusedCellPos[0]=t[0],this.focusedCellPos[1]=t[1]}onAction(t){if(t=="UP"){let e=this.focusedCellPos[0]==0?B-1:this.focusedCellPos[0]-1;this.focusCell([e,this.focusedCellPos[1]])}else if(t=="RIGHT"){let e=this.focusedCellPos[1]==B-1?0:this.focusedCellPos[1]+1;this.focusCell([this.focusedCellPos[0],e])}else if(t=="DOWN"){let e=this.focusedCellPos[0]==B-1?0:this.focusedCellPos[0]+1;this.focusCell([e,this.focusedCellPos[1]])}else if(t=="LEFT"){let e=this.focusedCellPos[1]==0?B-1:this.focusedCellPos[1]-1;this.focusCell([this.focusedCellPos[0],e])}else t=="OK"?this.uiCards[this.focusedCellPos[0]][this.focusedCellPos[1]]||m.emit(this,"E_CELL_SELECTED",{pos:this.focusedCellPos}):t=="BACK"&&m.emit(this,"E_CANCEL")}handleBoardCardPlaced(t){const e=new Yr;e.setCard(t.card),this.uiCards[t.pos[0]][t.pos[1]]=e,this.node.querySelector(`.js-${t.pos[0]}-${t.pos[1]}`).appendChild(e.getNode())}$createVWalls(t){const e=new Array;for(let s=0;s<B;s++){e[s]=[];for(let i=0;i<B;i++){if(!t[s][i])continue;const r=new ke(Pe.VL);if(this.node.querySelector(`.js-${s}-${i}`).appendChild(r.getNode()),e[s][i]=r,i==0){const a=new ke(Pe.VR);this.node.querySelector(`.js-${s}-${B-1}`).appendChild(a.getNode()),e[s][i]=a}}}return e}$createHWalls(t){const e=new Array;for(let s=0;s<B;s++){e[s]=[];for(let i=0;i<B;i++){if(!t[s][i])continue;const r=new ke(Pe.HT);if(this.node.querySelector(`.js-${s}-${i}`).appendChild(r.getNode()),e[s][i]=r,s==0){const a=new ke(Pe.HB);this.node.querySelector(`.js-${B-1}-${i}`).appendChild(a.getNode()),e[s][i]=a}}}return e}$createCards(){const t=new Array;for(let e=0;e<B;e++){t[e]=[];for(let s=0;s<B;s++)t[e][s]=null}return t}}class Ll extends W{gameState;constructor(t){super({className:"UIScore",template:`
      <div class="UIScore-points-p1 js-p1">8</div>
      <div class="UIScore-points-p2 js-p2">8</div>`}),this.gameState=t,m.subscribe(this.gameState,"E_BATTLE_PERFORMED",this,this.handleBattlePerformed)}handleBattlePerformed(t){this.node.querySelector(".js-p1").textContent=t.score.toString(),this.node.querySelector(".js-p2").textContent=(16-t.score).toString()}}class Nl extends U{gameState;uiBackground;uiScore;uiHands;uiDamier;constructor(){super(),this.gameState=new Ml,this.uiBackground=new Rl,this.uiScore=new Ll(this.gameState),this.uiHands=new Dl(this.gameState),this.uiDamier=new Ol(this.gameState)}async onEnter(){rs.setSize(600,600,qi.FIXED),g.addWidget(this.uiBackground),g.addWidget(this.uiScore),g.addWidget(this.uiHands),g.addWidget(this.uiDamier),this.gameState.startup(),g.focus(this.uiHands),this.uiHands.focusPlayer(this.gameState.getCurrentPlayerNum()),m.subscribe(this.uiHands,"E_CARD_SELECTED",this,this.handleHandsCardSelected),m.subscribe(this.uiDamier,"E_CELL_SELECTED",this,this.handleDamierCellSelected),m.subscribe(this.uiDamier,"E_CANCEL",this,this.handleDamierCancel)}onExit(){g.removeWidget(this.uiBackground),g.removeWidget(this.uiHands),g.removeWidget(this.uiScore),g.removeWidget(this.uiDamier)}handleHandsCardSelected(){this.uiDamier.focusFirstEmptyCell(),g.focus(this.uiDamier)}handleDamierCellSelected(t){const e=this.uiHands.getFocusedCardNum(this.gameState.getCurrentPlayerNum());this.gameState.placeHandCardOnBoard(this.gameState.getCurrentPlayerNum(),e,t.pos),this.gameState.performBattle(t.pos),this.gameState.changePlayer(),g.focus(this.uiHands),this.uiHands.focusCard(0),this.uiHands.focusPlayer(this.gameState.getCurrentPlayerNum())}handleDamierCancel(){this.uiHands.focusPlayer(this.gameState.getCurrentPlayerNum()),g.focus(this.uiHands)}}class Fl extends ft{texture;animation;col;row;sx;sy;sw;sh;dw;dh;constructor(t){super(),this.texture=t.texture,this.animation=t.animation,this.elevation=t.elevation,this.position[0]=t.dx,this.position[1]=t.dy,this.offset[0]=t.ox,this.offset[1]=t.oy,this.col=t.col,this.row=t.row,this.sx=t.sx,this.sy=t.sy,this.sw=t.sw,this.sh=t.sh,this.dw=t.dw,this.dh=t.dh}paint(){if(!this.texture)return;const t=N.getContext();t.save(),t.translate(-this.dw*.5,-this.dh),t.drawImage(this.texture,this.sx,this.sy,this.sw,this.sh,0,0,this.dw,this.dh),t.restore()}}class _e extends ft{tilemap;layerIndex;tiles;frameIndex;frameProgress;showDebug;colorDebug;lineWidthDebug;constructor(){super(),this.tilemap=new jt,this.layerIndex=0,this.tiles=[],this.frameIndex=0,this.frameProgress=0,this.showDebug=!1,this.colorDebug="blue",this.lineWidthDebug=.5}loadFromTileMap(t,e){this.tilemap=t,this.layerIndex=e,this.tiles=[],this.frameIndex=0,this.frameProgress=0;const s=t.getTileLayer(e);this.offset[0]=s.getOffsetX(),this.offset[1]=s.getOffsetY();for(let i=0;i<s.getRows();i++)for(let r=0;r<s.getColumns();r++){const n=s.getTile(r,i);n<0||this.placeTile(n,i,r)}}update(t){const e=this.tilemap.getTileset(),s=this.tilemap.getTileLayer(this.layerIndex);if(!(!e||!s)){this.frameProgress>s.getFrameDuration()&&(this.frameIndex=this.frameIndex+1,this.frameProgress=0);for(const i of this.tiles)if(i.animation.length>0){const r=i.animation[this.frameIndex%i.animation.length];i.sx=e.getTilePositionX(r),i.sy=e.getTilePositionY(r)}this.frameProgress+=t}}paint(){const t=this.tilemap.getTileLayer(this.layerIndex);if(!t)return;const e=N.getContext();if(t.isVisible()){const s=this.tilemap.getTileset(),i=this.tilemap.getTileWidth()/s.getTileWidth();for(let r=0;r<t.getRows();r++)for(let n=0;n<t.getColumns();n++){let a=t.getTile(n,r);if(a<0)continue;const h=this.tilemap.getPositionIso(r,n),l=s.getAnimation(a);l&&(a=l[this.frameIndex%l.length]),e.drawImage(s.getTexture(),s.getTilePositionX(a),s.getTilePositionY(a),s.getTileWidth(),s.getTileHeight(),h[0]-this.tilemap.getTileWidth()/2,h[1]-this.tilemap.getTileHeight(),this.tilemap.getTileWidth(),s.getTileHeight()*i)}}if(this.showDebug)for(let s=0;s<t.getRows();s++)for(let i=0;i<t.getColumns();i++){const r=this.tilemap.getPositionIso(s,i);e.save(),e.translate(r[0],r[1]),e.strokeStyle=this.colorDebug,e.lineWidth=this.lineWidthDebug,e.beginPath(),e.moveTo(0,0),e.lineTo(this.tilemap.getTileWidth()/2,-this.tilemap.getTileHeight()/2),e.lineTo(0,-this.tilemap.getTileHeight()),e.lineTo(-this.tilemap.getTileWidth()/2,-this.tilemap.getTileHeight()/2),e.lineTo(0,0),e.stroke(),e.closePath(),e.restore()}}placeTile(t,e,s){const i=this.tilemap.getTileLayer(this.layerIndex),r=this.tilemap.getTileset(),n=this.tilemap.getTileWidth()/r.getTileWidth(),a=r.getAnimation(t),h=this.tilemap.getPositionIso(e,s);this.tiles.push(new Fl({texture:r.getTexture(),animation:a??[],elevation:this.layerIndex,col:s,row:e,sx:r.getTilePositionX(t),sy:r.getTilePositionY(t),sw:r.getTileWidth(),sh:r.getTileHeight(),dx:h[0],dy:h[1],ox:i.getOffsetX(),oy:i.getOffsetY(),dw:this.tilemap.getTileWidth(),dh:r.getTileHeight()*n}))}removeTileAt(t,e){const s=this.tiles.findIndex(i=>i.col==e&&i.row==t);s!=-1&&this.tiles.splice(s,1)}getTiles(){return this.tiles}isShowDebug(){return this.showDebug}setShowDebug(t){this.showDebug=t}getColorDebug(){return this.colorDebug}setColorDebug(t){this.colorDebug=t}getLineWidthDebug(){return this.lineWidthDebug}setLineWidthDebug(t){this.lineWidthDebug=t}}class Bl{static draw(t){t.sort((e,s)=>e.getElevation()<s.getElevation()?-1:e.getElevation()>s.getElevation()?1:e.getPositionY()-s.getPositionY());for(const e of t)e.draw()}}class Vl extends ft{constructor(){super(),this.sprite=new mt,this.direction="FORWARD",this.depth=20,this.width=20}async load(){await this.sprite.loadFromFile("./samples/tilemap-iso/kid.jas"),this.sprite.setTexture(await Q.loadTexture("./samples/tilemap-iso/kid.png")),this.sprite.play("IDLE_LEFT",!0)}update(t){this.sprite.update(t)}draw(){const t=N.getContext();t.save(),t.translate(this.position[0],this.position[1]),t.translate(-8,-30),this.sprite.draw(),t.restore()}play(t,e){this.sprite.play(t,e,!0)}getDirection(){return this.direction}setDirection(t){this.direction=t}getDepth(){return this.depth}getWidth(){return this.width}getCollisionPoints(){const t=c.VEC2_ISO_CARDINAL_POINTS(this.direction,this.depth,this.width),e=c.VEC2_ADD(this.position,c.VEC2_ADD(t.f,t.l)),s=c.VEC2_ADD(this.position,c.VEC2_ADD(t.f,t.r));return[e,s]}}class Ul extends U{constructor(){super(),this.tilemap=new jt,this.collisionLayer=new _e,this.occludersLayer=new _e,this.wallsLayer=new _e,this.floorLayer=new _e,this.collisionTileLayer=new Us,this.controller=new Vl}async onEnter(){await this.tilemap.loadFromFile("./samples/tilemap-iso/tilemap.json"),this.collisionLayer.loadFromTileMap(this.tilemap,3),this.collisionLayer.setShowDebug(!0),this.occludersLayer.loadFromTileMap(this.tilemap,2),this.wallsLayer.loadFromTileMap(this.tilemap,1),this.floorLayer.loadFromTileMap(this.tilemap,0),this.collisionTileLayer=this.tilemap.getTileLayer(3),await this.controller.load(),this.controller.setElevation(2);const t=this.tilemap.getPositionIso(5,5);this.controller.setPosition(t[0],t[1])}update(t){M.isActiveAction("LEFT")?this.movePlayer(c.VEC2_ISO_FORWARD,"FORWARD"):M.isActiveAction("RIGHT")?this.movePlayer(c.VEC2_ISO_BACKWARD,"BACKWARD"):M.isActiveAction("UP")?this.movePlayer(c.VEC2_ISO_RIGHT,"RIGHT"):M.isActiveAction("DOWN")?this.movePlayer(c.VEC2_ISO_LEFT,"LEFT"):this.controller.play("IDLE_"+this.controller.getDirection(),!0),this.controller.update(t)}draw(){N.setCameraPosition(this.controller.getPositionX(),this.controller.getPositionY()),Bl.draw([...this.occludersLayer.getTiles(),...this.wallsLayer.getTiles(),...this.floorLayer.getTiles(),this.controller]),this.collisionLayer.draw()}movePlayer(t,e){const s=c.VEC2_2D_TO_ISO(t);this.controller.translate(s[0],s[1]),this.controller.setDirection(e),this.controller.play("RUN_"+e,!0);const i=this.controller.getCollisionPoints(),r=this.tilemap.getLocationFromIso(i[0][0],i[0][1]),n=this.tilemap.getLocationFromIso(i[1][0],i[1][1]);(this.collisionTileLayer.getTile(r[0],r[1])==1||this.collisionTileLayer.getTile(n[0],n[1])==1)&&this.controller.translate(-s[0],-s[1])}}class Hl extends U{constructor(){super(),this.camera=new Jt(0),this.skySphere=new G,this.floor=new G,this.cube=new G}async onEnter(){pe.setShadowProjection([-100,100,0],[0,0,0],600,600),ht.enableShadow(!0),this.camera.setPosition(0,40,0),this.camera.setRotation(.15,0,0),this.skySphere=await jl(),this.floor=await Wl(0,0,-100),this.cube=await Gl(0,7,-100)}update(t){this.skySphere.update(t),this.floor.update(t),this.cube.update(t);const e=Date.now()/1e4;this.cube.setRotation(Math.sin(e),Math.cos(e),0)}draw(){ht.drawDirLight([100,-100,0],[.8,.8,.8],[1,1,1],[0,0,0]),this.skySphere.draw(),this.floor.draw(),this.cube.draw()}}async function Wl(o,t,e){const s=new G;return s.setPosition(o,t,e),await s.loadFromFile("./samples/shadow/floor.jsm"),s.setMaterial(new $({lightning:!0,texture:await D.loadTexture("./samples/shadow/floor.jpg"),shadowEnabled:!0})),s}async function jl(){const o=new G;return await o.loadFromFile("./samples/shadow/sky_sphere.jsm"),o.setMaterial(new $({texture:await D.loadTexture("./samples/shadow/sky_sphere.jpg")})),o}async function Gl(o,t,e){const s=new G;return s.setPosition(o,t,e),s.setScale(10,10,10),s.setShadowCasting(!0),await s.loadFromFile("./samples/viewer/duck.jsm"),s.setMaterial(new $({texture:await D.loadTexture("./samples/viewer/duck.png"),lightning:!0})),s}class kl{static draw(t){t.sort((e,s)=>e.getPositionZ()-s.getPositionZ());for(const e of t)e.draw()}}const ql=16;class Yl extends ft{constructor(){super(),this.sprite=new mt,this.direction="FORWARD",this.speed=40,this.motion=new Ze,this.pathElevation=[],this.onRunning=(t,e)=>{}}update(t){if(this.motion.isRunning()){const e=this.pathElevation[this.motion.getPrevPointIndex()],s=this.pathElevation[this.motion.getNextPointIndex()],i=this.motion.getCurrentSegmentTime(),r=e!=s,n=e+(s-e)*i;this.position[0]=this.motion.getCurrentPositionX(),this.position[1]=this.motion.getCurrentPositionZ()-n;const a=this.motion.getPrevPoint(),h=this.motion.getNextPoint();a[0]>h[0]&&a[2]<h[2]?this.direction="LEFT":a[0]<h[0]&&a[2]>h[2]?this.direction="RIGHT":a[0]>h[0]&&a[2]>h[2]?this.direction="FORWARD":a[0]<h[0]&&a[2]<h[2]&&(this.direction="BACKWARD"),r?(this.position[1]-=Xl(i)*ql,this.sprite.play("JUMP_"+this.direction,!1,!0)):this.sprite.play("RUN_"+this.direction,!0,!0),this.onRunning(this.motion.getPrevPointIndex(),i)}else this.sprite.play("IDLE_"+this.direction,!0,!0);this.sprite.update(t),this.motion.update(t)}draw(){const t=N.getContext();t.save(),t.translate(this.position[0],this.position[1]),t.translate(-8,-32-4),this.sprite.draw(),t.restore()}play(t,e){this.sprite.play(t,e,!0)}getDirection(){return this.direction}setDirection(t){this.direction=t}setSprite(t){this.sprite=t}moveAlong(t,e,s){this.pathElevation=e,this.motion=new Ze(t,this.speed),this.motion.run(),this.onRunning=s}isJumping(){const t=this.motion.getPrevPointIndex(),e=this.motion.getNextPointIndex(),s=this.pathElevation[t],i=this.pathElevation[e];return s!=i}}function Xl(o){return-4*o*o+4*o+0}const Gi=150,ki=20;class zl extends U{constructor(){super(),this.bg0=new wt,this.bg1=new wt,this.cursor=new wt,this.cursorRow=0,this.cursorCol=0,this.tilemap=new jt,this.layer1=new _e,this.gridIds=[],this.gridCollisions=[],this.gridLayers=[],this.gridSubSprites=[],this.controller=new Yl,this.controllerRow=0,this.controllerCol=0,m.subscribe(M,"E_ACTION_ONCE",this,this.handleActionOnce)}async onEnter(){await this.tilemap.loadFromFile("./samples/bg-iso/tilemap.json"),this.layer1.loadFromTileMap(this.tilemap,0),this.layer1.setShowDebug(!0),this.bg0.setTexture(await Q.loadTexture("./samples/bg-iso/background.png")),this.bg0.setOffset(this.tilemap.getWidth()/2,0),this.bg0.setPositionZ(0),this.bg1.setTexture(await Q.loadTexture("./samples/bg-iso/foreground.png")),this.bg1.setOffset(this.tilemap.getWidth()/2,0),this.bg1.setPositionZ(2),this.cursor.setTexture(await Q.loadTexture("./samples/bg-iso/control.png")),this.cursor.setOffset(16,16),this.cursor.setPositionZ(1),this.buildMap(),this.locateCursor(19,1);const t=new mt;await t.loadFromFile("./samples/bg-iso/controller.jas"),t.setTexture(await Q.loadTexture("./samples/bg-iso/controller.png")),this.controller.setSprite(t),this.locatePlayer(19,1)}update(t){this.controller.update(t),this.moveCamera(this.controller.getPosition())}draw(){kl.draw([this.bg0,this.bg1,this.cursor,this.controller]),this.layer1.draw()}locateCursor(t,e){const s=this.gridCollisions[t*this.tilemap.getColumns()+e],i=this.gridLayers[t][e];if(s==1)return;const r=this.tilemap.getTileLayer(i),n=this.tilemap.getPositionIso(t,e);this.cursor.setPosition(n[0],n[1]-r.getOffsetY()),this.cursorRow=t,this.cursorCol=e}locatePlayer(t,e){const s=this.gridLayers[t][e],i=this.tilemap.getTileLayer(s),r=this.tilemap.getPositionIso(t,e);this.controller.setPosition(r[0],r[1]-i.getOffsetY()),this.controllerRow=t,this.controllerCol=e}moveCamera(t){const e=N.getCameraPosition();t[0]-e[0]>Gi?N.moveCamera(1,0):t[0]-e[0]<-Gi&&N.moveCamera(-1,0),t[1]-e[1]>ki?N.moveCamera(0,1):t[1]-e[1]<-ki&&N.moveCamera(0,-1)}movePlayer(t,e){const s=this.controllerRow,i=this.controllerCol,r=new sr([this.tilemap.getColumns(),this.tilemap.getRows()],this.gridCollisions),a=new ir().solve(r,[i,s],[e,t]);if(!a)return;const h=a.map(([u,d])=>{const p=this.tilemap.getPositionIso(d,u);return[p[0],0,p[1]]}),l=a.map(([u,d])=>{const p=this.gridLayers[d][u];return this.tilemap.getTileLayer(p).getOffsetY()});this.controller.moveAlong(h,l,(u,d)=>{const p=d>.5?Math.min(u+1,a.length-1):u,E=this.gridIds[a[p][1]][a[p][0]];this.controller.setPositionZ(E==2?1:3),this.controllerRow=a[p][1],this.controllerCol=a[p][0]})}buildMap(){for(let t=0;t<this.tilemap.getRows();t++){this.gridIds[t]=[],this.gridLayers[t]=[];for(let e=0;e<this.tilemap.getColumns();e++)this.gridIds[t][e]=0,this.gridLayers[t][e]=0,this.gridCollisions[t*this.tilemap.getColumns()+e]=1}for(let t=0;t<this.tilemap.getRows();t++)for(let e=0;e<this.tilemap.getColumns();e++)for(let s=0;s<this.tilemap.getTileLayers().length;s++){const r=this.tilemap.getTileLayer(s).getTile(e,t);r>0&&(this.gridIds[t][e]=r,this.gridLayers[t][e]=s,this.gridCollisions[t*this.tilemap.getColumns()+e]=0)}}handleActionOnce({actionId:t}){if(t=="RIGHT"){const e=c.CLAMP(this.cursorCol+1,0,this.tilemap.getColumns()-1);this.locateCursor(this.cursorRow,e)}else if(t=="LEFT"){const e=c.CLAMP(this.cursorCol-1,0,this.tilemap.getColumns()-1);this.locateCursor(this.cursorRow,e)}else if(t=="UP"){const e=c.CLAMP(this.cursorRow-1,0,this.tilemap.getRows()-1);this.locateCursor(e,this.cursorCol)}else if(t=="DOWN"){const e=c.CLAMP(this.cursorRow+1,0,this.tilemap.getRows()-1);this.locateCursor(e,this.cursorCol)}else t=="OK"&&this.movePlayer(this.cursorRow,this.cursorCol)}}class Zl extends U{constructor(){super(),this.uiMenu=new it({className:"UIMenuText UIBootMenu"})}async onEnter(){this.uiMenu.add("0","3D Viewer"),this.uiMenu.add("1","UI Menu"),this.uiMenu.add("2","3D Pre-rendered"),this.uiMenu.add("3","3D Isometric"),this.uiMenu.add("4","2D Visual Novel"),this.uiMenu.add("5","2D Tilemap"),this.uiMenu.add("6","2D Tilemap Pathfinding"),this.uiMenu.add("7","2D Checker"),this.uiMenu.add("8","2D Trading Card Collection"),this.uiMenu.add("9","3D FPS"),this.uiMenu.add("10","3D RPG"),this.uiMenu.add("11","3D Perf"),this.uiMenu.add("12","3D Particles"),this.uiMenu.add("13","2D Fighting Platform"),this.uiMenu.add("14","3D Curve"),this.uiMenu.add("15","2D Triple Triad"),this.uiMenu.add("16","2D Tilemap Isometric"),this.uiMenu.add("17","3D Shadow Map"),this.uiMenu.add("18","2D Background Isometric"),g.addWidget(this.uiMenu,"position:absolute; top:50%; left:50%; width:60%; transform:translate(-50%,-50%);"),m.subscribe(this.uiMenu,"E_ITEM_SELECTED",this,this.handleMenuItemSelected),g.focus(this.uiMenu)}onExit(){g.removeWidget(this.uiMenu)}handleMenuItemSelected(t){t.id==0?R.requestSetScreen(new jn):t.id==1?R.requestSetScreen(new Zn):t.id==2?R.requestSetScreen(new Qn):t.id==3?R.requestSetScreen(new ao):t.id==4?R.requestSetScreen(new Eo):t.id==5?R.requestSetScreen(new co):t.id==6?R.requestSetScreen(new mo):t.id==7?R.requestSetScreen(new Uo):t.id==8?R.requestSetScreen(new da,{duelId:"0000"}):t.id==9?R.requestSetScreen(new Ta):t.id==10?R.requestSetScreen(new sh):t.id==11?R.requestSetScreen(new oh):t.id==12?R.requestSetScreen(new mh):t.id==13?R.requestSetScreen(new hl):t.id==14?R.requestSetScreen(new Al):t.id==15?R.requestSetScreen(new Nl):t.id==16?R.requestSetScreen(new Ul):t.id==17?R.requestSetScreen(new Hl):t.id==18&&R.requestSetScreen(new zl)}}class $l extends U{uiTitle;uiText;constructor(){super(),this.uiTitle=new lt,this.uiText=new lt}async onEnter(t){this.uiTitle.setText("You loose biatch !"),this.uiText.setText(`Score: ${t.score}`),g.addWidget(this.uiTitle,"display:flex; justify-content:center; align-items:center; margin-top:80px; margin-left:50px; margin-right:50px;"),g.addWidget(this.uiText,"display:flex; justify-content:center; align-items:center; margin-top:80px; margin-left:50px; margin-right:50px;")}onExit(){g.removeWidget(this.uiTitle),g.removeWidget(this.uiText)}}class Kl extends k{jss;constructor(){super("Bullet"),this.jss=new wt,this.jss.setTexture(Q.getTexture("./tutorials/isolation/bullet.png"))}}class Jl extends Y{constructor(){super(),super.addRequiredComponentTypename("Bullet")}onEntityUpdate(t,e){const s=f.getComponent(e,"Bullet");if(s.jss.translate(0,-.6),s.jss.getPositionY()<-300){f.removeEntity(e);return}for(const i of f.findEntities("Asteroid")){const r=f.getComponent(i,"Asteroid"),n=s.jss.getWorldBoundingRect(),a=r.jss.getWorldBoundingRect();n.intersectBoundingRect(a)&&(f.hasEntity(e)&&f.removeEntity(e),f.removeEntity(i),m.emit(this,"E_ASTEROID_DESTROYED"))}s.jss.update(t)}onEntityDraw(t){f.getComponent(t,"Bullet").jss.draw()}}const Ql=5;class tc extends k{speed;jss;constructor(){super("Ship"),this.speed=.5,this.jss=new wt,this.jss.setPosition(0,280-32),this.jss.setTexture(Q.getTexture("./tutorials/isolation/ship.png"))}}class ec extends Y{constructor(){super(),super.addRequiredComponentTypename("Ship")}onEntityUpdate(t,e){const s=f.getComponent(e,"Ship");let i=0;M.isActiveAction("LEFT")?i=-s.speed*t:M.isActiveAction("RIGHT")&&(i=+s.speed*t),i!=0&&s.jss.getPositionX()+i>=-300&&s.jss.getPositionX()+i<=300-32&&s.jss.translate(i,0),s.jss.update(t)}onEntityDraw(t){f.getComponent(t,"Ship").jss.draw()}onActionOnce(t,e){if(t!="UP")return;const s=f.getComponent(e,"Ship");if(f.findEntities("Bullet").length>=Ql)return;const r=f.createEntity(),n=new Kl;n.jss.setOffsetNormalized(.5,0),n.jss.setPosition(s.jss.getPositionX()+s.jss.getTextureRectWidth()/2,s.jss.getPositionY()-64),f.addComponent(r,n)}}class sc extends k{jss;constructor(t,e){super("Asteroid"),this.jss=new wt,this.jss.setPosition(t,e),this.jss.setTexture(Q.getTexture("./tutorials/isolation/asteroid.png"))}}class ic extends Y{constructor(){super(),super.addRequiredComponentTypename("Asteroid")}onEntityUpdate(t,e){const s=f.getComponent(e,"Asteroid");if(s.jss.translate(0,.2),s.jss.getPositionY()>300){f.removeEntity(e);return}const i=f.findEntity("Ship"),n=f.getComponent(i,"Ship").jss.getWorldBoundingRect(),a=s.jss.getWorldBoundingRect();if(n.intersectBoundingRect(a)){m.emit(this,"E_PLAYER_DESTROYED");return}s.jss.update(t)}onEntityDraw(t){f.getComponent(t,"Asteroid").jss.draw()}}const rc=100,nc=75,oc=5,ac=8,hc=[1,2,3,4,3],lc=2e4;class cc extends U{shipSystem;asteroidSystem;bulletSystem;uiScore;score;waveAge;constructor(){super(),this.shipSystem=new ec,this.asteroidSystem=new ic,this.bulletSystem=new Jl,this.uiScore=new lt,this.score=0,this.waveAge=0}async onEnter(){await Q.loadTexture("./tutorials/isolation/asteroid.png"),await Q.loadTexture("./tutorials/isolation/bullet.png"),await Q.loadTexture("./tutorials/isolation/ship.png"),f.setup([this.shipSystem,this.asteroidSystem,this.bulletSystem]),this.uiScore.setText("Score: "+this.score),g.addWidget(this.uiScore);const t=f.createEntity();f.addComponent(t,new tc),this.generateWave(),m.subscribe(this.bulletSystem,"E_ASTEROID_DESTROYED",this,this.handleAsteroidDestroyed),m.subscribe(this.asteroidSystem,"E_PLAYER_DESTROYED",this,this.handlePlayerDestroyed)}onExit(){g.removeWidget(this.uiScore)}update(t){this.waveAge>lc?(this.generateWave(),this.waveAge=0):this.waveAge+=t,f.update(t)}draw(){f.draw()}generateWave(){for(let t=0;t<oc;t++)for(let e=0;e<ac;e++)if(hc[t]!=e){const s=e*60-300+nc,i=t*60-300+rc,r=f.createEntity();f.addComponent(r,new sc(s,i-300))}}handleAsteroidDestroyed(){this.score+=10,this.uiScore.setText("Score: "+this.score)}handlePlayerDestroyed(){R.requestSetScreen(new $l,{score:this.score})}}class uc extends U{uiTitle;uiMenu;constructor(){super(),this.uiTitle=new lt,this.uiMenu=new it}async onEnter(){this.uiTitle.setText("First tutorial (2D)"),g.addWidget(this.uiTitle,"display:flex; justify-content:center; align-items:center; margin-top:80px; margin-left:50px; margin-right:50px;"),this.uiMenu.add("NEW","New Game"),g.addWidget(this.uiMenu,"position:absolute; top:50%; left:50%; width:60%; transform:translate(-50%,-50%);"),g.focus(this.uiMenu),m.subscribe(this.uiMenu,"E_CLOSED",this,this.handleMainMenuClosed),m.subscribe(this.uiMenu,"E_ITEM_SELECTED",this,this.handleMainMenuItemSelected)}onExit(){g.removeWidget(this.uiTitle),g.removeWidget(this.uiMenu)}handleMainMenuClosed(){R.requestPopScreen()}handleMainMenuItemSelected(t){t.id=="NEW"&&R.requestSetScreen(new cc)}}class dc extends k{x;y;z;moveDir;velocity;rotation;constructor(){super("Character"),this.x=0,this.y=0,this.z=0,this.moveDir=[0,0,0],this.velocity=[0,0,0],this.rotation=0}}class pc extends k{jam;constructor(){super("CharacterGraphics"),this.jam=new Te}}class mc extends Y{constructor(){super(),super.addRequiredComponentTypename("CharacterGraphics"),super.addRequiredComponentTypename("Character")}onEntityUpdate(t,e){const s=f.getComponent(e,"CharacterGraphics"),i=f.getComponent(e,"Character");s.jam.setRotation(0,i.rotation,0),s.jam.setPosition(i.x,i.y,i.z),c.VEC3_LENGTH(i.velocity)>.1?s.jam.play("RUN",!0,!0):s.jam.play("IDLE",!0,!0),s.jam.update(t)}onEntityDraw(t){f.getComponent(t,"CharacterGraphics").jam.draw()}}class fc extends k{map;speed;lift;radius;height;frictionCoefficient;gravityCoefficient;gravityMax;constructor(t){super("CharacterPhysics"),this.map=t,this.speed=7,this.lift=.8,this.radius=.5,this.height=1,this.frictionCoefficient=.99999999,this.gravityCoefficient=.8,this.gravityMax=10}}class gc extends Y{constructor(){super(),super.addRequiredComponentTypename("CharacterPhysics"),super.addRequiredComponentTypename("Character")}onEntityUpdate(t,e){const s=f.getComponent(e,"CharacterPhysics"),i=f.getComponent(e,"Character"),r=c.VEC3_NORMALIZE(i.moveDir),n=c.VEC3_SCALE(r,s.speed);if(i.velocity[0]=c.LINEAR(Math.pow(1-s.frictionCoefficient,t/1e3),n[0],i.velocity[0]),i.velocity[2]=c.LINEAR(Math.pow(1-s.frictionCoefficient,t/1e3),n[2],i.velocity[2]),c.VEC3_LENGTH(i.velocity)<.1){i.velocity=[0,0,0];return}const a=c.VEC3_SCALE(i.velocity,t/1e3),h=s.map.box(i.x,i.y+s.height*.5,i.z,s.radius,s.height,a[0],a[1],a[2],s.lift);i.x+=h.move[0],i.y+=h.move[1],i.z+=h.move[2],h.collideFloor?i.velocity[1]=0:i.velocity[1]=c.LINEAR(Math.pow(1-s.gravityCoefficient,t/1e3),-s.gravityMax,i.velocity[1])}onEntityDraw(t){const e=f.getComponent(t,"CharacterPhysics"),s=f.getComponent(t,"Character"),i=[s.x-e.radius,s.y,s.z-e.radius],r=[s.x+e.radius,s.y+e.height,s.z+e.radius];dt.drawBoundingBox(c.MAT4_IDENTITY(),i,r)}}class Ec extends k{constructor(){super("CharacterInput")}}class Cc extends Y{constructor(){super(),super.addRequiredComponentTypename("CharacterInput"),super.addRequiredComponentTypename("CharacterCamera"),super.addRequiredComponentTypename("Character")}onEntityUpdate(t,e){let s=!1,i=0;M.isActiveAction("LEFT")&&(i=-Math.PI/2,s=!0),M.isActiveAction("RIGHT")&&(i=Math.PI/2,s=!0),M.isActiveAction("UP")&&(i=0,s=!0),M.isActiveAction("DOWN")&&(i=-Math.PI,s=!0);const r=f.getComponent(e,"Character");if(s){const a=f.getComponent(e,"CharacterCamera").rec.getPhi(),h=Math.cos(a+i),l=Math.sin(a+i);r.moveDir=[-h,0,-l],r.rotation=c.VEC2_ANGLE([-h,-l])}else r.moveDir=[0,0,0]}}class Tc extends k{rec;distanceMax;map;constructor(t){super("CharacterCamera"),this.rec=new tr(0),this.distanceMax=10,this.map=t}}class Ac extends Y{constructor(){super(),super.addRequiredComponentTypename("CharacterCamera"),super.addRequiredComponentTypename("Character")}onEntityUpdate(t,e){const s=f.getComponent(e,"CharacterCamera"),i=f.getComponent(e,"Character"),r=[i.x,i.y+1,i.z],n=c.VEC3_SUBSTRACT(s.rec.getPosition(),r),a=s.map.raycast(r,n,s.distanceMax,s.distanceMax);a&&a.distance<s.distanceMax?s.rec.setDistance(a.distance):s.rec.setDistance(s.distanceMax),s.rec.setTarget(r),s.rec.update(t)}}class Ic extends U{mapJSM;mapJNM;constructor(){super(),this.mapJSM=new G,this.mapJNM=new bs}async onEnter(){f.setup([new Cc,new gc,new mc,new Ac]),this.mapJSM=new G,await this.mapJSM.loadFromFile("./tutorials/asgard/map.jsm"),this.mapJSM.setMaterial(new $({texture:await D.loadTexture("./tutorials/asgard/map.png")})),this.mapJNM=new bs,await this.mapJNM.loadFromFile("./tutorials/asgard/map.jnm"),await this.createPlayer(this.mapJNM)}update(t){this.mapJSM.update(t),this.mapJNM.update(t),f.update(t)}draw(){this.mapJSM.draw(),f.draw()}async createPlayer(t){const e=f.createEntity(),s=new dc;f.addComponent(e,s);const i=new Ec;f.addComponent(e,i);const r=new fc(t);f.addComponent(e,r);const n=new pc;await n.jam.loadFromFile("./tutorials/asgard/barret.jam"),n.jam.play("IDLE",!0),n.jam.setMaterial(new $({texture:await D.loadTexture("./tutorials/asgard/barret.png")})),f.addComponent(e,n);const a=new Tc(t);return f.addComponent(e,a),e}}class yc extends U{constructor(){super(),this.uiMenu=new it({className:"UIMenuText UIBootMenu"})}async onEnter(){this.uiMenu.add("0","First tutorial - Isolation"),this.uiMenu.add("1","Second tutorial - Asgard"),this.uiMenu.add("2","Samples"),g.addWidget(this.uiMenu,"position:absolute; top:50%; left:50%; width:60%; transform:translate(-50%,-50%);"),m.subscribe(this.uiMenu,"E_ITEM_SELECTED",this,this.handleMenuItemSelected),g.focus(this.uiMenu)}onExit(){g.removeWidget(this.uiMenu)}handleMenuItemSelected(t){t.id==0?R.requestSetScreen(new uc):t.id==1?R.requestSetScreen(new Ic):t.id==2&&R.requestSetScreen(new Zl)}}class vc{constructor(){this.then=0}startup(){rs.enableScanlines(!0),dt.setShowDebug(!0),Ht.setParam(Me.ENABLED,0),Ht.setParam(Me.COLOR_ENABLED,1),Ht.setParam(Me.PIXELATION_ENABLED,1),Ht.setParam(Me.DITHER_ENABLED,1),this.run(0)}run(t){const e=t-this.then;this.then=t,N.update(e),g.update(e),R.update(e),v.beginDrawing(),N.beginDrawing(),R.draw(),N.endDrawing(),v.endDrawing(),v.beginRender(),pe.render(),v.setDestinationTexture(Ht.getSourceTexture()),v.beginPassRender(0),$i.render(),dt.render(),ht.render(),zi.render(),Ji.render(),Mn.render(),v.endPassRender(),Ht.render(v.getCurrentRenderingTexture()),v.endRender(),document.getElementById("fps").innerHTML=(1e3/e).toFixed(2),document.getElementById("rt").innerHTML=(1e3/v.getLastRenderTime()).toFixed(2),requestAnimationFrame(s=>this.run(s))}}const xc=new vc;xc.startup();R.requestSetScreen(new yc);
